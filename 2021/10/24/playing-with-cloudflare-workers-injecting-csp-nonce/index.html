<!DOCTYPE html><!--

                                      |
                                     /|
                                   ,' |
                                  .   |
                                    | |
                                 ' '| |
                                / / | |
       _,.-\"\"--._              / /  | |
     ,'          `.           j '   ' '
   ,'              `.         ||   / ,                         ___..--,
  /                  \\        ' `.'`.-.,-\".  .       _..---\"\"'' __, ,'
 /                    \\        \\` .\"`      `\"'\\   ,'\"_..--''\"\"\"'.'.'
.                      .      .'-'             \\,' ,'         ,','
|                      |      ,`               ' .`         .' /
|                      |     /          ,\"`.  ' `-. _____.-' .'
'                      |..---.|,\".      | | .  .-'\"\"   __.,-'
 .                   ,'       ||,|      |.' |    |\"\"`'\"
  `-._   `._.._____  |        || |      `._,'    |
      `.   .       `\".     ,'\"| \"  `'           ,+.
        \\  '         |    '   |   .....        .'  `.
         .'          '     7  \".              ,'     \\
                   ,'      |    `..        _,'      F
                  .        |,      `'----''         |
                  |      ,\"j  /                   | '
                  `     |  | .                 | `,'
                   .    |  `.|                 |/
                    `-..'   ,'                .'
                            | \\             ,''
                            |  `,'.      _,' /
                            |    | ^.  .'   /
                             `-'.' j` V    /
                                   |      /
                                   |     /
                                   |   ,'
                                    `\"\"

//--><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=1.0"><link rel=alternate href=https://kura.gg hreflang=en><link rel=dns-prefetch href=https://kura.gg><link rel=stylesheet href=https://kura.gg/theme/css/eevee.min.css?1c9d8344><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml type=application/rss+xml rel=alternate title=kura.gg><link href=https://kura.gg/feeds/atom.xml type=application/atom+xml rel=alternate title=kura.gg><meta property=og:site_name content=kura.gg><meta property=og:type content=article><meta property=og:title content="Playing with Cloudflare Workers: Injecting CSP nonces in to responses"><meta content=https://kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/ property=og:url><meta property=og:description content="Content-Security-Policy (CSP) is an HTTP header returned by servers that gives the client some information on where resources can be loaded. For example setting script-src 'self' in the CSP tells the client that it should only load script resources from the current origin. 'self' for this blog post would mean https://kura.gg. To make loading those resources more secure you can use hashes or nonces within the CSP that the client can verify. Below I will show how I inject CSP nonces using Cloudflare Workers in to responses from my origin. Security considerations Think of this as an academic exercise rather than something you should do. This article will only explain how I inject the nonces in to responses from the origin. This isn’t really secure given the method I use to do this is pretty dumb — it just adds a generated nonce to <script> and <link rel …"><meta property=og:image content=https://kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/index.png><meta property=og:image:width content=1920><meta property=og:image:height content=1080><meta property=twitter:title content="Playing with Cloudflare Workers: Injecting CSP nonces in to responses"><meta content=https://kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/ property=twitter:url><meta property=twitter:description content="Content-Security-Policy (CSP) is an HTTP header returned by servers that gives the client some information on where resources can be loaded. For example setting script-src 'self' in the CSP tells the client that it should only load script resources from the current origin. 'self' for this blog post would mean https://kura.gg. To make loading those resources more secure you can use hashes or nonces within the CSP that the client can verify. Below I will show how I inject CSP nonces using Cloudflare Workers in to responses from my origin. Security considerations Think of this as an academic exercise rather than something you should do. This article will only explain how I inject the nonces in to responses from the origin. This isn’t really secure given the method I use to do this is pretty dumb — it just adds a generated nonce to <script> and <link rel …"><meta property=twitter:image content=https://kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/index.png><meta property=twitter:card content=summary_large_image><meta property=twitter:label1 content="Written by"><meta property=twitter:data1 content=Kura><meta property=twitter:label2 content="Estimated reading time"><meta property=twitter:data2 content="3 min read"><meta property=twitter:image:width content=1920><meta property=twitter:image:height content=1080><link rel=icon href=/favicon.png type=image/png sizes="16x16 32x32 48x48 64x64 128x128 256x256"><link rel=icon href=/favicon.ico type=image/vnd.microsoft.icon sizes="16x16 32x32 48x48 64x64 128x128 256x256"><title>Playing with Cloudflare Workers: Injecting CSP nonces in to responses</title></head> <body> <div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"> <header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader> <div class=mdl-layout__header-row> <div aria-expanded=false role=button tabindex=0 class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only"> <i class=material-icons>&#xE5D2;</i> </div> <span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top> <a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a> </h2> </span> <div class=mdl-layout-spacer role=presentation></div> <nav class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </nav> </div> </header> <div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true> <span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent"> kura.gg </h2> </span> <div class="mdl-navigation mdl-color--white"> <nav class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i class=material-icons aria-hidden=true> &#xE88A; </i> Home </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </nav> </div> </div> <div class="eevee-ribbon mdl-color--primary-dark" role=presentation> </div> <main class="eevee-main mdl-layout__content"> <div class="eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col" aria-label="Main content"> <article itemscope itemtype=http://schema.org/BlogPosting> <meta itemprop=accessibilityControl content=fullKeyboardControl> <meta itemprop=accessibilityControl content=fullMouseControl> <meta itemprop=accessibilityControl content=bookmarks> <meta itemprop=accessibilityControl content=captions> <meta itemprop=accessibilityControl content=alternativeText> <meta itemprop=accessibilityControl content=index> <meta itemprop=accessibilityControl content=readingOrder> <meta itemprop=accessibilityControl content=structuralNavigation> <meta itemprop=accessibilityControl content=tableOfContents> <meta itemprop=accessibilityHazard content=noFlashingHazard> <meta itemprop=accessibilityHazard content=noMotionSimulationHazard> <meta itemprop=accessibilityHazard content=noSoundHazard> <meta itemprop=accessibilityAPI content=ARIA> <div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation /> <a href=https://kura.gg/authors/kura/ class=hidden itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a> </div> <meta itemprop=keywords content="cloudflare http content-security-policy csp"> <meta itemprop=keywords content=misc> <div class=eevee-share> <ul class="social-share mdl-navigation"> <li class="social-share__link social-share__link--twitter"> <a href="https://twitter.com/intent/tweet?text=Playing%20with%20Cloudflare%20Workers%3A%20Injecting%20CSP%20nonces%20in%20to%20responses&url=https%3A//kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/" title="Share 'Playing with Cloudflare Workers: Injecting CSP nonces in to responses' on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;"> <i class=fa aria-hidden=true>&#xF099;</i> </a> </li> <li class="social-share__link social-share__link--facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/" title="Share 'Playing with Cloudflare Workers: Injecting CSP nonces in to responses' on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;"> <i class=fa aria-hidden=true>&#xF09A;</i> </a> </li> <li class="social-share__link social-share__link--email"> <a href="mailto:?subject=Playing%20with%20Cloudflare%20Workers%3A%20Injecting%20CSP%20nonces%20in%20to%20responses&body=I%20thought%20you%20might%20like%20'Playing%20with%20Cloudflare%20Workers%3A%20Injecting%20CSP%20nonces%20in%20to%20responses'%20--%20https%3A//kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/" title="Share 'Playing with Cloudflare Workers: Injecting CSP nonces in to responses' via email"> <i class=material-icons aria-hidden=true> &#xE0E1; </i> </a> </li> </ul> </div> <div class=eevee-article> <div class="eevee-meta mdl-color-text--grey-500"> <time datetime=2021-10-24T12:00:00+01:00 itemprop=datePublished> 24 Oct 2021 </time>&nbsp;-- 3 min read </div> <h1 itemprop=name> <a href=https://kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/ rel=bookmark title="Permalink to 'Playing with Cloudflare Workers: Injecting CSP nonces in to responses'" itemprop=url> Playing with Cloudflare Workers: Injecting <span class=caps>CSP</span> nonces in to&nbsp;responses </a> </h1> <section class=eevee-toc> <h2 id=toc> Contents </h2> <nav class=eevee-toc-ribbon> <div class=toc id> <p class=topic-title>Contents</p> <ul class=simple> <li><a class="reference internal" href=#security-considerations id=toc-entry-1>Security considerations</a></li> <li><a class="reference internal" href=#how-it-works id=toc-entry-2>How it works</a></li> <li><a class="reference internal" href=#the-code id=toc-entry-3>The code</a></li> </ul> </div> </nav> </section> <section itemprop=articleBody class=article-content> <img alt="Mew, the Pokémon" class=align-center src=/images/151_mew.png> <p><tt class="docutils literal"><span class=pre>Content-Security-Policy</span></tt> (<span class=caps>CSP</span>) is an <span class=caps>HTTP</span> header returned by servers that gives the client some information on where resources can be loaded. For example setting <tt class="docutils literal"><span class=pre>script-src</span> 'self'</tt> in the <span class=caps>CSP</span> tells the client that it should only load script resources from the current origin. <tt class="docutils literal">'self'</tt> for this blog post would mean <tt class="docutils literal"><span class=pre>https://kura.gg</span></tt>.</p> <p>To make loading those resources more secure you can use hashes or nonces within the <span class=caps>CSP</span> that the client can verify. Below I will show how I inject <span class=caps>CSP</span> nonces using Cloudflare Workers in to responses from my origin.</p> <div class=section id=security-considerations> <h2>Security considerations</h2> <p><strong>Think of this as an academic exercise rather than something you should do.</strong></p> <p>This article will only explain how I inject the nonces in to responses from the origin. This isn’t really secure given the method I use to do this is pretty dumb — it just adds a generated nonce to <tt class="docutils literal">&lt;script&gt;</tt> and <tt class="docutils literal">&lt;link <span class=pre>rel="stylesheet&gt;"</span></tt> <span class=caps>HTML</span> tags, so an attacker could just modify the origin and add a resource to the <span class=caps>HTML</span> and this worker configuration would blindly add a nonce to it.</p> </div> <div class=section id=how-it-works> <h2>How it works</h2> <p>When a new request comes in, the worker will generate a nonce. The content is then requested from the origin and the worker modifies the origin response; injecting the nonce in to <tt class="docutils literal">&lt;script&gt;</tt> and <tt class="docutils literal">&lt;link <span class=pre>rel="stylesheet&gt;"</span></tt> <span class=caps>HTML</span> tags and addingbash</p> <pre class="code html literal-block">
❯ curl -v https://kura.gg/eevee | grep nonce
<span class=p>&lt;</span> <span class=nt>content-security-policy:</span> <span class=na>default-src</span> <span class=err>'</span><span class=na>self</span><span class=err>';</span>
  <span class=na>script-src</span> <span class=err>'</span><span class=na>self</span><span class=err>'</span> <span class=na>gist</span><span class=err>.</span><span class=na>github</span><span class=err>.</span><span class=na>com</span> <span class=err>'</span><span class=na>nonce-MTQ1MjM5MDU0MCwzODc3MjkwMzY0</span><span class=err>';</span>
  <span class=na>style-src</span> <span class=err>'</span><span class=na>self</span><span class=err>'</span> <span class=na>assets-cdn</span><span class=err>.</span><span class=na>github</span><span class=err>.</span><span class=na>com</span> <span class=err>'</span><span class=na>nonce-MTQ1MjM5MDU0MCwzODc3MjkwMzY0</span><span class=err>';</span>
  <span class=na>img-src</span> <span class=err>'</span><span class=na>self</span><span class=err>'</span> <span class=na>img</span><span class=err>.</span><span class=na>shields</span><span class=err>.</span><span class=na>io</span><span class=err>;</span>
  <span class=na>font-src</span> <span class=err>'</span><span class=na>self</span><span class=err>';</span> <span class=na>connect-src</span> <span class=err>'</span><span class=na>none</span><span class=err>';</span> <span class=na>media-src</span> <span class=err>'</span><span class=na>self</span><span class=err>';</span>
  <span class=na>object-src</span> <span class=err>'</span><span class=na>self</span><span class=err>'</span> <span class=na>player</span><span class=err>.</span><span class=na>vimeo</span><span class=err>.</span><span class=na>com</span><span class=err>;</span> <span class=na>child-src</span> <span class=na>www</span><span class=err>.</span><span class=na>youtube</span><span class=err>.</span><span class=na>com</span> <span class=na>player</span><span class=err>.</span><span class=na>vimeo</span><span class=err>.</span><span class=na>com</span><span class=err>;</span>
  <span class=na>frame-ancestors</span> <span class=err>'</span><span class=na>none</span><span class=err>';</span> <span class=na>form-action</span> <span class=err>'</span><span class=na>none</span><span class=err>';</span>
  <span class=na>upgrade-insecure-requests</span><span class=err>;</span> <span class=na>base-uri</span> <span class=na>https:</span><span class=err>//</span><span class=na>kura</span><span class=err>.</span><span class=na>gg</span><span class=err>;</span> <span class=na>manifest-src</span> <span class=err>'</span><span class=na>none</span><span class=err>';</span>
  <span class=na>require-trusted-types-for</span> <span class=err>'</span><span class=na>script</span><span class=err>';</span>
<span class=err>&lt;</span><span class=na>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>stylesheet</span> <span class=na>href</span><span class=o>=</span><span class=s>https://kura.gg/theme/css/eevee.min.css?e96887dc</span> <span class=na>nonce</span><span class=o>=</span><span class=s>"MTQ1MjM5MDU0MCwzODc3MjkwMzY0"</span><span class=p>&gt;</span>
<span class=p>&lt;</span><span class=nt>script</span> <span class=na>async</span> <span class=na>src</span><span class=o>=</span><span class=s>https://kura.gg/theme/js/eevee.min.js?1841d254</span> <span class=na>nonce</span><span class=o>=</span><span class=s>"MTQ1MjM5MDU0MCwzODc3MjkwMzY0"</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</pre> </div> <div class=section id=the-code> <h2>The code</h2> <p>This is the full set of worker could to add nonces to responses, there are a few comments within the code that give an idea of what each part does.</p> <pre class="code javascript literal-block">
<span class=kd>class</span><span class=w> </span><span class=nx>AttributeRewriter</span><span class=w> </span><span class=p>{</span><span class=w>
  </span><span class=kr>constructor</span><span class=p>(</span><span class=nx>nonce</span><span class=p>,</span><span class=w> </span><span class=nx>tag_name</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=k>this</span><span class=p>.</span><span class=nx>nonce</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>nonce</span><span class=w>
    </span><span class=k>this</span><span class=p>.</span><span class=nx>tag_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>tag_name</span><span class=w>
  </span><span class=p>}</span><span class=w>

  </span><span class=c1>// There is definitely a cleaner way to do this but JS isn't my</span><span class=w>
  </span><span class=c1>// strong suit and I didn't want the nonce applied to every &lt;link&gt;</span><span class=w>
  </span><span class=c1>// tag.</span><span class=w>
  </span><span class=nx>element</span><span class=p>(</span><span class=nx>element</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=k>this</span><span class=p>.</span><span class=nx>tag_name</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s2>"link"</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
      </span><span class=kd>const</span><span class=w> </span><span class=nx>attribute</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>element</span><span class=p>.</span><span class=nx>getAttribute</span><span class=p>(</span><span class=s2>"rel"</span><span class=p>)</span><span class=w>
      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>attribute</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=nx>attribute</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=s2>"stylesheet"</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
        </span><span class=nx>element</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>"nonce"</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>nonce</span><span class=p>)</span><span class=w>
      </span><span class=p>}</span><span class=w>
    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
      </span><span class=nx>element</span><span class=p>.</span><span class=nx>setAttribute</span><span class=p>(</span><span class=s2>"nonce"</span><span class=p>,</span><span class=w> </span><span class=k>this</span><span class=p>.</span><span class=nx>nonce</span><span class=p>)</span><span class=w>
    </span><span class=p>}</span><span class=w>
  </span><span class=p>}</span><span class=w>
</span><span class=p>}</span><span class=w>

</span><span class=k>async</span><span class=w> </span><span class=kd>function</span><span class=w> </span><span class=nx>handle_req</span><span class=p>(</span><span class=nx>req</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
  </span><span class=c1>// Generate the nonce and create a CSP to be added to headers</span><span class=w>
  </span><span class=c1>// later.</span><span class=w>
  </span><span class=kd>const</span><span class=w> </span><span class=nx>nonce</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>btoa</span><span class=p>(</span><span class=nx>crypto</span><span class=p>.</span><span class=nx>getRandomValues</span><span class=p>(</span><span class=ow>new</span><span class=w> </span><span class=nb>Uint32Array</span><span class=p>(</span><span class=mf>2</span><span class=p>)))</span><span class=w>
  </span><span class=c1>// This policy only allows using scripts, styles, images and fonts</span><span class=w>
  </span><span class=c1>// resources from the current origin.</span><span class=w>
  </span><span class=kd>const</span><span class=w> </span><span class=nx>content_security_policy</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=w>
    </span><span class=s2>"default-src 'self';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"script-src 'self' 'nonce-"</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>nonce</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s2>";"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"style-src 'self' 'nonce-"</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=nx>nonce</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s2>";"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"img-src 'self';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"font-src 'self';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"connect-src 'none';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"media-src 'none';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"object-src 'none';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"child-src 'none';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"frame-ancestors 'none';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"form-action 'none';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"upgrade-insecure-requests;"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"manifest-src 'none';"</span><span class=p>,</span><span class=w>
    </span><span class=s2>"require-trusted-types-for 'script';"</span><span class=w>
  </span><span class=p>].</span><span class=nx>join</span><span class=p>(</span><span class=s2>" "</span><span class=p>)</span><span class=w>

  </span><span class=c1>// Make the request upstream and create a mutable copy of the</span><span class=w>
  </span><span class=c1>// response headers.</span><span class=w>
  </span><span class=kd>const</span><span class=w> </span><span class=nx>res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>await</span><span class=w> </span><span class=nx>fetch</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>url</span><span class=p>)</span><span class=w>
  </span><span class=kd>let</span><span class=w> </span><span class=nx>res_headers</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Headers</span><span class=p>(</span><span class=nx>res</span><span class=p>.</span><span class=nx>headers</span><span class=p>)</span><span class=w>

  </span><span class=c1>// Set up the rewriter, passing the nonce to it for adding to</span><span class=w>
  </span><span class=c1>// the configured elements.</span><span class=w>
  </span><span class=kd>const</span><span class=w> </span><span class=nx>rewriter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>HTMLRewriter</span><span class=p>()</span><span class=w>
    </span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>"script"</span><span class=p>,</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>AttributeRewriter</span><span class=p>(</span><span class=nx>nonce</span><span class=p>,</span><span class=w> </span><span class=s2>"script"</span><span class=p>))</span><span class=w>
    </span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s2>"link"</span><span class=p>,</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>AttributeRewriter</span><span class=p>(</span><span class=nx>nonce</span><span class=p>,</span><span class=w> </span><span class=s2>"link"</span><span class=p>))</span><span class=w>

  </span><span class=c1>// Only run the rewriter on HTML content.</span><span class=w>
  </span><span class=kd>const</span><span class=w> </span><span class=nx>content_type</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>headers</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=s2>"Content-Type"</span><span class=p>)</span><span class=w>
  </span><span class=kd>let</span><span class=w> </span><span class=nx>new_res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>res</span><span class=w>
  </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nx>content_type</span><span class=p>.</span><span class=nx>startsWith</span><span class=p>(</span><span class=s2>"text/html"</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=nx>new_res</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nx>rewriter</span><span class=p>.</span><span class=nx>transform</span><span class=p>(</span><span class=nx>res</span><span class=p>)</span><span class=w>
  </span><span class=p>}</span><span class=w>

  </span><span class=c1>// Set the CSP header.</span><span class=w>
  </span><span class=nx>res_headers</span><span class=p>.</span><span class=nx>set</span><span class=p>(</span><span class=s2>"Content-Security-Policy"</span><span class=p>,</span><span class=w> </span><span class=nx>content_security_policy</span><span class=p>)</span><span class=w>

  </span><span class=c1>// Return the (possibly modified) body and modified headers.</span><span class=w>
  </span><span class=k>return</span><span class=w> </span><span class=ow>new</span><span class=w> </span><span class=nx>Response</span><span class=p>(</span><span class=nx>new_res</span><span class=p>.</span><span class=nx>body</span><span class=p>,</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=nx>status</span><span class=o>:</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=p>,</span><span class=w>
    </span><span class=nx>statusText</span><span class=o>:</span><span class=w> </span><span class=nx>res</span><span class=p>.</span><span class=nx>statusText</span><span class=p>,</span><span class=w>
    </span><span class=nx>headers</span><span class=o>:</span><span class=w> </span><span class=nx>res_headers</span><span class=w>
  </span><span class=p>})</span><span class=w>
</span><span class=p>}</span><span class=w>

</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s1>'fetch'</span><span class=p>,</span><span class=w> </span><span class=nx>event</span><span class=w> </span><span class=p>=&gt;</span><span class=w> </span><span class=p>{</span><span class=w>
  </span><span class=nx>event</span><span class=p>.</span><span class=nx>respondWith</span><span class=p>(</span><span class=nx>handle_req</span><span class=p>(</span><span class=nx>event</span><span class=p>.</span><span class=nx>request</span><span class=p>))</span><span class=w>
</span><span class=p>})</span>
</pre> </div> </section> </div> <div class=eevee-related> <section> <h2>Related articles</h2> <ul> <li> <a href=https://kura.gg/2021/10/15/playing-with-cloudflare-workers-adding-random-pokemon-header/ rel=bookmark title="Permalink to 'Playing with Cloudflare Workers: Adding a random Pokémon to response headers'" itemprop=url> Playing with Cloudflare Workers: Adding a random Pokémon to response&nbsp;headers </a> </li> </ul> </section> </div> <div class=eevee-ac> <header class=eevee-ac__header> <div class=eevee-ac-author__text> <h2>Kura</h2> <p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.</p> <p> <a href=https://kura.gg/authors/kura/ itemprop=url title="Read more articles by Kura"> Read more articles by Kura </a> </p> <nav> <ul class=eevee-ac-author__social> <li class=eevee-ac-author-social__link> <a class="mdl-color-text--accent mdl-navigation__link" href=https://github.com/kura itemprop=url rel=bookmark title="kura on GitHub"> <i class=fa aria-hidden=true>&#xF09B;</i> </a> </li> </ul> </nav> </div> <img src=/images/avatar.png class=eevee-ac-author__avatar alt=Kura> </header> </div> </article> <a href=https://github.com/kura/kura.gg/blob/main/content/playing-with-cloudflare-workers-injecting-csp-nonce.rst id=view-source title="View 'Playing with Cloudflare Workers: Injecting CSP nonces in to responses' on GitHub" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white"> <i class=material-icons>&#xE86F;</i> View Source </a> </div> </div> </main> <div class="eevee-pagination__container eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"> <nav class="eevee-pagination mdl-cell mdl-cell--12-col" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label=Pagination> <div class=eevee-spacer></div> <a href=https://kura.gg/2021/10/15/playing-with-cloudflare-workers-adding-random-pokemon-header/ class=eevee-nav__button itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C8;</i> </button> </a> </nav> </div> </div> <footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement> <div class=mdl-mega-footer--top-section> <div class=mdl-mega-footer--drop-down-section> <ul class=mdl-mega-footer--link-list> <li> <a href=#top itemprop=url title="Back to the top of the page"> Back to the top of the page </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Footer navigation"> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Menu</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> </li> <li> <a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> </li> <li> <a href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </li> <li> <a href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Social</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i class=fa aria-hidden=true>&#xF09B;</i> Github </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Links</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> </li> <li> <a href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> </li> <li> <a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> </li> <li> <a href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--bottom-section> <div class=mdl-logo> <a href=https://kura.gg rel=bookmark itemprop=url title=kura.gg> kura.gg </a> </div> <ul class="eevee-footer mdl-mega-footer--link-list"> <li>Powered by love &amp; rainbow sparkles.</li> <li>Source code and content released under the <a href=/license/ title="MIT license">MIT license</a>.</li> </ul> </div> </footer> </div> </body> </html>