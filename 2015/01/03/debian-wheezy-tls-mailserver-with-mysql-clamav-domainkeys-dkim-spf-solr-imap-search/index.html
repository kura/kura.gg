<!DOCTYPE html><!--

                                      |
                                     /|
                                   ,' |
                                  .   |
                                    | |
                                 ' '| |
                                / / | |
       _,.-\"\"--._              / /  | |
     ,'          `.           j '   ' '
   ,'              `.         ||   / ,                         ___..--,
  /                  \\        ' `.'`.-.,-\".  .       _..---\"\"'' __, ,'
 /                    \\        \\` .\"`      `\"'\\   ,'\"_..--''\"\"\"'.'.'
.                      .      .'-'             \\,' ,'         ,','
|                      |      ,`               ' .`         .' /
|                      |     /          ,\"`.  ' `-. _____.-' .'
'                      |..---.|,\".      | | .  .-'\"\"   __.,-'
 .                   ,'       ||,|      |.' |    |\"\"`'\"
  `-._   `._.._____  |        || |      `._,'    |
      `.   .       `\".     ,'\"| \"  `'           ,+.
        \\  '         |    '   |   .....        .'  `.
         .'          '     7  \".              ,'     \\
                   ,'      |    `..        _,'      F
                  .        |,      `'----''         |
                  |      ,\"j  /                   | '
                  `     |  | .                 | `,'
                   .    |  `.|                 |/
                    `-..'   ,'                .'
                            | \\             ,''
                            |  `,'.      _,' /
                            |    | ^.  .'   /
                             `-'.' j` V    /
                                   |      /
                                   |     /
                                   |   ,'
                                    `\"\"

//--><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=1.0"><link rel=alternate href=https://kura.gg hreflang=en><link rel=dns-prefetch href=https://kura.gg><link rel=stylesheet href=https://kura.gg/theme/css/eevee.min.css?1c9d8344><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml type=application/rss+xml rel=alternate title=kura.gg><link href=https://kura.gg/feeds/atom.xml type=application/atom+xml rel=alternate title=kura.gg><meta property=og:site_name content=kura.gg><meta property=og:type content=article><meta property=og:title content="Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH"><meta content=https://kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/ property=og:url><meta property=og:description content="This mail platform does use a fair amount of memory, the memory usage is ClamAV and Solr, the latter being used for IMAP SEARCH. I personally use 2 GB. I’ll warn you all now, this is a long article. SSL sudo openssl genrsa -out /etc/ssl/private/mail.key 4096 sudo openssl req -new -key /etc/ssl/private/mail.key -out /tmp/mail.csr sudo openssl x509 -req -days 365 -in /tmp/mail.csr -signkey /etc/ssl/private/mail.key -out /etc/ssl/certs/mail.crt MySQL sudo apt-get install mysql-server You’ll be prompted several times for a password for MySQL during the installation, just come up with something nice and secure. The first thing to set-up will be the MySQL database and schema. mysql -u root -p Next up, create the database. CREATE DATABASE mailserver CHARACTER SET utf8 COLLATE utf8_general_ci; And grant some privileges, you’ll need …"><meta property=og:image content=https://kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/index.png><meta property=og:image:width content=1920><meta property=og:image:height content=1080><meta property=twitter:title content="Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH"><meta content=https://kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/ property=twitter:url><meta property=twitter:description content="This mail platform does use a fair amount of memory, the memory usage is ClamAV and Solr, the latter being used for IMAP SEARCH. I personally use 2 GB. I’ll warn you all now, this is a long article. SSL sudo openssl genrsa -out /etc/ssl/private/mail.key 4096 sudo openssl req -new -key /etc/ssl/private/mail.key -out /tmp/mail.csr sudo openssl x509 -req -days 365 -in /tmp/mail.csr -signkey /etc/ssl/private/mail.key -out /etc/ssl/certs/mail.crt MySQL sudo apt-get install mysql-server You’ll be prompted several times for a password for MySQL during the installation, just come up with something nice and secure. The first thing to set-up will be the MySQL database and schema. mysql -u root -p Next up, create the database. CREATE DATABASE mailserver CHARACTER SET utf8 COLLATE utf8_general_ci; And grant some privileges, you’ll need …"><meta property=twitter:image content=https://kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/index.png><meta property=twitter:card content=summary_large_image><meta property=twitter:label1 content="Written by"><meta property=twitter:data1 content=Kura><meta property=twitter:label2 content="Estimated reading time"><meta property=twitter:data2 content="9 min read"><meta property=twitter:image:width content=1920><meta property=twitter:image:height content=1080><link rel=icon href=/favicon.png type=image/png sizes="16x16 32x32 48x48 64x64 128x128 256x256"><link rel=icon href=/favicon.ico type=image/vnd.microsoft.icon sizes="16x16 32x32 48x48 64x64 128x128 256x256"><title>Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH</title></head> <body> <div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"> <header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader> <div class=mdl-layout__header-row> <div aria-expanded=false role=button tabindex=0 class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only"> <i class=material-icons>&#xE5D2;</i> </div> <span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top> <a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a> </h2> </span> <div class=mdl-layout-spacer role=presentation></div> <nav class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </nav> </div> </header> <div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true> <span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent"> kura.gg </h2> </span> <div class="mdl-navigation mdl-color--white"> <nav class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i class=material-icons aria-hidden=true> &#xE88A; </i> Home </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </nav> </div> </div> <div class="eevee-ribbon mdl-color--primary-dark" role=presentation> </div> <main class="eevee-main mdl-layout__content"> <div class="eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col" aria-label="Main content"> <article itemscope itemtype=http://schema.org/BlogPosting> <meta itemprop=accessibilityControl content=fullKeyboardControl> <meta itemprop=accessibilityControl content=fullMouseControl> <meta itemprop=accessibilityControl content=bookmarks> <meta itemprop=accessibilityControl content=captions> <meta itemprop=accessibilityControl content=alternativeText> <meta itemprop=accessibilityControl content=index> <meta itemprop=accessibilityControl content=readingOrder> <meta itemprop=accessibilityControl content=structuralNavigation> <meta itemprop=accessibilityControl content=tableOfContents> <meta itemprop=accessibilityHazard content=noFlashingHazard> <meta itemprop=accessibilityHazard content=noMotionSimulationHazard> <meta itemprop=accessibilityHazard content=noSoundHazard> <meta itemprop=accessibilityAPI content=ARIA> <div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation /> <a href=https://kura.gg/authors/kura/ class=hidden itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a> </div> <meta itemprop=keywords content=debian,wheezy,postfix,dovecot,clamav,domainkeys,dkim,spf,imap> <meta itemprop=keywords content=tutorials> <div class=eevee-share> <ul class="social-share mdl-navigation"> <li class="social-share__link social-share__link--twitter"> <a href="https://twitter.com/intent/tweet?text=Debian%20Wheezy%20TLS%20mailserver%20with%20MySQL%2C%20ClamAV%2C%20DomainKeys%2C%20DKIM%2C%20SPF%20and%20Solr-powered%20IMAP%20SEARCH&url=https%3A//kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/" title="Share 'Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH' on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;"> <i class=fa aria-hidden=true>&#xF099;</i> </a> </li> <li class="social-share__link social-share__link--facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/" title="Share 'Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH' on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;"> <i class=fa aria-hidden=true>&#xF09A;</i> </a> </li> <li class="social-share__link social-share__link--email"> <a href="mailto:?subject=Debian%20Wheezy%20TLS%20mailserver%20with%20MySQL%2C%20ClamAV%2C%20DomainKeys%2C%20DKIM%2C%20SPF%20and%20Solr-powered%20IMAP%20SEARCH&body=I%20thought%20you%20might%20like%20'Debian%20Wheezy%20TLS%20mailserver%20with%20MySQL%2C%20ClamAV%2C%20DomainKeys%2C%20DKIM%2C%20SPF%20and%20Solr-powered%20IMAP%20SEARCH'%20--%20https%3A//kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/" title="Share 'Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH' via email"> <i class=material-icons aria-hidden=true> &#xE0E1; </i> </a> </li> </ul> </div> <div class=eevee-article> <div class="eevee-meta mdl-color-text--grey-500"> <time datetime=2015-01-03T19:48:00+00:00 itemprop=datePublished> 03 Jan 2015 </time>&nbsp;&mdash; 9 min read </div> <h1 itemprop=name> <a href=https://kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/ rel=bookmark title="Permalink to 'Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH'" itemprop=url> Debian Wheezy <span class=caps>TLS</span> mailserver with MySQL, ClamAV, DomainKeys, <span class=caps>DKIM</span>, <span class=caps>SPF</span> and Solr-powered <span class=caps>IMAP</span> <span class=caps>SEARCH</span> </a> </h1> <section class=eevee-toc> <h2 id=toc> Contents </h2> <nav class=eevee-toc-ribbon> <div class=toc id> <p class=topic-title>Contents</p> <ul class=simple> <li><a class="reference internal" href=#ssl id=toc-entry-1><span class=caps>SSL</span></a></li> <li><a class="reference internal" href=#mysql id=toc-entry-2>MySQL</a></li> <li><a class="reference internal" href=#postfix id=toc-entry-3>Postfix</a></li> <li><a class="reference internal" href=#dovecot id=toc-entry-4>Dovecot</a></li> <li><a class="reference internal" href=#clamav-and-spamassassin-milters id=toc-entry-5>ClamAV and SpamAssassin milters</a></li> <li><a class="reference internal" href=#dkimproxy id=toc-entry-6>DKIMProxy</a></li> <li><a class="reference internal" href=#dns id=toc-entry-7><span class=caps>DNS</span></a></li> </ul> </div> </nav> </section> <section itemprop=articleBody class=article-content> <p>This mail platform does use a fair amount of memory, the memory usage is ClamAV and Solr, the latter being used for <span class=caps>IMAP</span> <span class=caps>SEARCH</span>. I personally use 2 <span class=caps>GB</span>.</p> <p>I’ll warn you all now, this is a long article.</p> <div class=section id=ssl> <h2><a class=toc-backref href=#toc-entry-1><span class=caps>SSL</span></a></h2> <div class=highlight><pre><span></span>sudo openssl genrsa -out /etc/ssl/private/mail.key 4096
sudo openssl req -new -key /etc/ssl/private/mail.key -out /tmp/mail.csr
sudo openssl x509 -req -days 365 -in /tmp/mail.csr -signkey /etc/ssl/private/mail.key -out /etc/ssl/certs/mail.crt
</pre></div> </div> <div class=section id=mysql> <h2><a class=toc-backref href=#toc-entry-2>MySQL</a></h2> <div class=highlight><pre><span></span>sudo apt-get install mysql-server
</pre></div> <p>You’ll be prompted several times for a password for MySQL during the installation, just come up with something nice and secure.</p> <p>The first thing to set-up will be the MySQL database and schema.</p> <div class=highlight><pre><span></span>mysql -u root -p
</pre></div> <p>Next up, create the database.</p> <div class=highlight><pre><span></span>CREATE DATABASE mailserver CHARACTER SET utf8 COLLATE utf8_general_ci;
</pre></div> <p>And grant some privileges, you’ll need to set a password yourself.</p> <div class=highlight><pre><span></span>GRANT ALL PRIVILEGES ON mailserver.* TO 'mailuser'@'localhost' IDENTIFIED BY '&lt;PASSWORD_HERE&gt;';
FLUSH PRIVILEGES;
</pre></div> <p>Next, set up the schema.</p> <div class=highlight><pre><span></span>CREATE TABLE `virtual_domains` (
    `id` int(11) NOT NULL auto_increment,
    `name` varchar(50) NOT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `virtual_users` (
    `id` int(11) NOT NULL auto_increment,
    `domain_id` int(11) NOT NULL,
    `password` varchar(106) NOT NULL,
    `email` varchar(100) NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `email` (`email`),
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `virtual_aliases` (
    `id` int(11) NOT NULL auto_increment,
    `domain_id` int(11) NOT NULL,
    `source` varchar(100) NOT NULL,
    `destination` varchar(100) NOT NULL,
    PRIMARY KEY (`id`),
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
</pre></div> <p>Finally, add a domain name, user and alias.</p> <div class=highlight><pre><span></span>INSERT INTO virtual_domains (name) VALUES ('example.com');
INSERT INTO virtual_users (domain_id, password, email) VALUES (1, ENCRYPT('&lt;PASSWORD_HERE&gt;', CONCAT('$6$', SUBSTRING(SHA(RAND()), -16))), 'user@example.com');
INSERT INTO virtual_aliases (domain_id, source, destination) VALUES (1, 'alias@exampe.com', 'user@example.com');
</pre></div> <p>Drop back to the Bash prompt using <cite><span class=caps>CTRL</span>-D</cite> or with</p> <div class=highlight><pre><span></span>EXIT
</pre></div> </div> <div class=section id=postfix> <h2><a class=toc-backref href=#toc-entry-3>Postfix</a></h2> <div class=highlight><pre><span></span>sudo apt-get install postfix postfix-mysql postfix-policyd-spf-python
</pre></div> <p>When prompted for a Postfix configuration, just select <cite>Internet Site</cite>. You’ll also be prompted for a mail name, I’ll be using <cite>mail.example.com</cite>.</p> <p>Back up the original <cite>main.cf</cite> and <cite>master.cf</cite> for Postfix.</p> <div class=highlight><pre><span></span>sudo mv /etc/postfix/main.cf{,.orig}
sudo mv /etc/postfix/master.cf{,.org}
</pre></div> <p>Create a new <cite>/etc/postfix/main.cf</cite> with the content below.</p> <div class=highlight><pre><span></span>smtpd_banner = $myhostname ESMTP
biff = no
append_dot_mydomain = no
readme_directory = no

smtpd_use_tls = yes
smtpd_tls_cert_file = /etc/ssl/certs/mail.crt
smtpd_tls_key_file = /etc/ssl/private/mail.key
smtpd_tls_auth_only = yes
smtpd_tls_security_level = encrypt
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtpd_tls_session_cache_timeout = 3600s
smtpd_helo_required = yes
smtpd_tls_received_header = yes
smtpd_tls_security_level = may
smtpd_tls_mandatory_ciphers = high
smtpd_tls_mandatory_exclude_ciphers = aNULL, MD5, RC4
smtpd_tls_mandatory_protocols = TLSv1
smtpd_tls_loglevel = 1
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname

smtp_use_tls = yes
smtp_tls_cert_file = /etc/ssl/certs/mail.crt
smtp_tls_key_file = /etc/ssl/private/mail.key

tls_random_source = dev:/dev/urandom
broken_sasl_auth_clients = yes

smtpd_recipient_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_unknown_sender_domain,
    check_policy_service unix:private/policy-spf

smtpd_sender_restrictions =
    permit_sasl_authenticated,
    permit_mynetworks

policy-spf_time_limit = 3600s
myhostname = mail.example.com
myorigin = /etc/mailname
mydestination = localhost
relayhost =
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all

virtual_transport = lmtp:unix:private/dovecot-lmtp
virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf
virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf
virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf

smtpd_recipient_limit = 2000
smtpd_milters =
    unix:clamav/clamav-milter.ctl,
    unix:spamass/spamass.sock
milter_connect_macros = j {daemon_name} v {if_name} _
milter_default_action = tempfail
</pre></div> <p>Create a new <cite>/etc/postfix/master.cf</cite> and make it look like below.</p> <div class=highlight><pre><span></span>smtp      inet  n       -       -       -       -       smtpd
    -o strict_rfc821_envelopes=yes
submission inet n       -       -       -       -       smtpd
    -o syslog_name=postfix/submission
    -o smtpd_tls_security_level=encrypt
    -o smtpd_sasl_auth_enable=yes
    -o content_filter=dksign:[127.0.0.1]:10027
    -o smtpd_client_restrictions=permit_sasl_authenticated,reject
    -o milter_macro_daemon_name=ORIGINATING
smtps     inet  n       -       -       -       -       smtpd
    -o syslog_name=postfix/smtps
    -o smtpd_tls_wrappermode=yes
    -o smtpd_sasl_auth_enable=yes
    -o content_filter=dksign:[127.0.0.1]:10027
    -o smtpd_client_restrictions=permit_sasl_authenticated,reject
    -o milter_macro_daemon_name=ORIGINATING
pickup    fifo  n       -       -       60      1       pickup
cleanup   unix  n       -       -       -       0       cleanup
qmgr      fifo  n       -       n       300     1       qmgr
tlsmgr    unix  -       -       -       1000?   1       tlsmgr
rewrite   unix  -       -       -       -       -       trivial-rewrite
bounce    unix  -       -       -       -       0       bounce
defer     unix  -       -       -       -       0       bounce
trace     unix  -       -       -       -       0       bounce
verify    unix  -       -       -       -       1       verify
flush     unix  n       -       -       1000?   0       flush
proxymap  unix  -       -       n       -       -       proxymap
proxywrite unix -       -       n       -       1       proxymap
smtp      unix  -       -       -       -       -       smtp
relay     unix  -       -       -       -       -       smtp
showq     unix  n       -       -       -       -       showq
error     unix  -       -       -       -       -       error
retry     unix  -       -       -       -       -       error
discard   unix  -       -       -       -       -       discard
local     unix  -       n       n       -       -       local
virtual   unix  -       n       n       -       -       virtual
lmtp      unix  -       -       -       -       -       lmtp
anvil     unix  -       -       -       -       1       anvil
scache    unix  -       -       -       -       1       scache
maildrop  unix  -       n       n       -       -       pipe
    flags=DRhu user=vmail argv=/usr/bin/maildrop -d ${recipient}
uucp      unix  -       n       n       -       -       pipe
    flags=Fqhu user=uucp argv=uux -r -n -z -a$sender - $nexthop!rmail ($recipient)
ifmail    unix  -       n       n       -       -       pipe
    flags=F user=ftn argv=/usr/lib/ifmail/ifmail -r $nexthop ($recipient)
bsmtp     unix  -       n       n       -       -       pipe
    flags=Fq. user=bsmtp argv=/usr/lib/bsmtp/bsmtp -t$nexthop -f$sender $recipient
scalemail-backend unix      -       n       n       -       2       pipe
    flags=R user=scalemail argv=/usr/lib/scalemail/bin/scalemail-store ${nexthop} ${user} ${extension}
mailman   unix  -       n       n       -       -       pipe
    flags=FR user=list argv=/usr/lib/mailman/bin/postfix-to-mailman.py
    ${nexthop} ${user}
policy-spf unix -       n       n       -       -       spawn
    user=nobody argv=/usr/bin/policyd-spf
dksign    unix  -       -       n       -       4       smtp
    -o smtp_send_xforward_command=yes
    -o smtp_discard_ehlo_keywords=8bitmime,starttls
127.0.0.1:10028 inet n  -        n      -       10      smtpd
    -o content_filter=
    -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks
    -o smtpd_helo_restrictions=
    -o smtpd_client_restrictions=
    -o smtpd_sender_restrictions=
    -o smtpd_recipient_restrictions=permit_mynetworks,reject
    -o mynetworks=127.0.0.0/8
    -o smtpd_authorized_xforward_hosts=127.0.0.0/8
</pre></div> <p>Next you’ll create the config files to query MySQL.</p> <p>Create <cite>/etc/postfix/mysql-virtual-mailbox-domains.cf</cite> with the content below.</p> <div class=highlight><pre><span></span>user = mailuser
password = &lt;MYSQL_PASSWORD&gt;
hosts = 127.0.0.1
dbname = mailserver
query = SELECT 1 FROM virtual_domains WHERE name='%s'
</pre></div> <p>Create <cite>/etc/postfix/mysql-virtual-mailbox-maps.cf</cite> with the content below.</p> <div class=highlight><pre><span></span>user = mailuser
password = &lt;MYSQL_PASSWORD&gt;
hosts = 127.0.0.1
dbname = mailserver
query = SELECT 1 FROM virtual_users WHERE email='%s'
</pre></div> <p>Create <cite>/etc/postfix/mysql-virtual-alias-maps.cf</cite> with the content below.</p> <div class=highlight><pre><span></span>user = mailuser
password = &lt;MYSQL_PASSWORD&gt;
hosts = 127.0.0.1
dbname = mailserver
query = SELECT destination FROM virtual_aliases WHERE source='%s'
</pre></div> <p>Reload Postfix and test that the domain and users work.</p> <div class=highlight><pre><span></span>sudo /etc/init.d/postfix reload
postmap -q example.com mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf
postmap -q user@example.com mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf
postmap -q alias@example.com mysql:/etc/postfix/mysql-virtual-alias-maps.cf
</pre></div> <p>You should see output similar to below</p> <div class=highlight><pre><span></span>1
1
user@example.com
</pre></div> </div> <div class=section id=dovecot> <h2><a class=toc-backref href=#toc-entry-4>Dovecot</a></h2> <div class=highlight><pre><span></span>sudo apt-get install dovecot-core dovecot-imapd dovecot-lmtpd dovecot-mysql
</pre></div> <p>Backup the default Dovecot config files.</p> <div class=highlight><pre><span></span>sudo cp /etc/dovecot/dovecot.conf{,.orig}
sudo cp /etc/dovecot/conf.d/10-mail.conf{,.orig}
sudo cp /etc/dovecot/conf.d/10-auth.conf{,.orig}
sudo cp /etc/dovecot/dovecot-sql.conf.ext{,.orig}
sudo cp /etc/dovecot/conf.d/10-master.conf{,.orig}
sudo cp /etc/dovecot/conf.d/10-ssl.conf {,.orig}
</pre></div> <p>For each domain you want to serve mail for, you will need to create a directory for it to be stored in.</p> <div class=highlight><pre><span></span>sudo mkdir -p /var/mail/vhosts/example.com
</pre></div> <p>Add a user and group for the mail and give permissions on the mail directory.</p> <div class=highlight><pre><span></span>sudo groupadd -g 5000 vmail
sudo useradd -g vmail -u 5000 vmail -d /var/mail
sudo chown -R vmail:vmail /var/mail
</pre></div> <p>Modify the line in <cite>/etc/dovecot/dovecot.conf</cite> so it looks like below.</p> <div class=highlight><pre><span></span>!include_try /usr/share/dovecot/protocols.d/*.protocol
protocols = imap lmtp
</pre></div> <p>Modify <cite>/etc/dovecot/dovecot.conf</cite> so it has the following lines.</p> <div class=highlight><pre><span></span>mail_location = maildir:/var/mail/vhosts/%d/%n
mail_privileged_group = mail
</pre></div> <p>Edit <cite>/etc/dovecot/conf.d/10-auth.conf</cite>.</p> <p>You’ll need to uncomment the following line.</p> <div class=highlight><pre><span></span>disable_plaintext_auth = yes
</pre></div> <p>Set <cite>auth_mechanisms</cite> to look like below</p> <div class=highlight><pre><span></span>auth_mechanisms = plain login
</pre></div> <p>Next up, make sure the include lines look like below.</p> <div class=highlight><pre><span></span>#!include auth-system.conf.ext
!include auth-sql.conf.ext
#!include auth-ldap.conf.ext
#!include auth-passwdfile.conf.ext
#!include auth-checkpassword.conf.ext
#!include auth-vpopmail.conf.ext
#!include auth-static.conf.ext
</pre></div> <p>Create <cite>/etc/dovecot/conf.d/auth-sql.conf.ext</cite> and add the content below.</p> <div class=highlight><pre><span></span>passdb {
    driver = sql
    args = /etc/dovecot/dovecot-sql.conf.ext
}

userdb {
    driver = static
    args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n
}
</pre></div> <p>Edit <cite>/etc/dovecot/dovecot-sql.conf.ext</cite> and set the following values.</p> <div class=highlight><pre><span></span>driver = mysql
connect = host=127.0.0.1 dbname=mailserver user=mailuser password=&lt;PASSWORD&gt;
default_pass_scheme = SHA512-CRYPT
password_query = SELECT email as user, password FROM virtual_users WHERE email='%u'
</pre></div> <p>Add the following content to <cite>/etc/dovecot/conf.d/10-master.conf</cite></p> <div class=highlight><pre><span></span>service imap-login {
    inet_listener imaps {
        port = 993
        ssl = yes
    }
}

service lmtp {
    unix_listener /var/spool/postfix/private/dovecot-lmtp {
        mode = 0600
        user = postfix
        group = postfix
    }
}

service auth {
    unix_listener /var/spool/postfix/private/auth {
        mode = 0666
        user = postfix
        group = postfix
    }
    unix_listener auth-userdb {
        mode = 0600
        user = vmail
    }
    user = dovecot
}

service auth-worker {
    user = vmail
}
</pre></div> <p>Modify <cite>/etc/dovecot/conf.d/10-ssl.conf</cite> to have the following lines.</p> <div class=highlight><pre><span></span>ssl_cert = &lt;/etc/ssl/certs/mail.crt
ssl_key = &lt;/etc/ssl/private/mail.key
ssl = required
</pre></div> <p>For fulltext searching, you’ll want to enable wheezy-backports and install <cite>dovecot-solr</cite> from there.</p> <div class=highlight><pre><span></span>sudo echo "deb https://ftp.debian.org/debian wheezy-backports main contrib non-free" &gt;&gt; /etc/apt/sources.list
sudo apt-get update
sudo apt-get install dovecot-solr solr-tomcat
</pre></div> <p>There is a bug in <cite>dovecot-solr</cite> where it doesn’t set up the Solr schema for, you’ll have to do it by downloading <cite>orig.tar.gz</cite> from <a class="reference external" href=https://packages.debian.org/wheezy/dovecot-solr>the Debian website</a>.</p> <p>Extract the archive and copy the included schema in to Solr.</p> <div class=highlight><pre><span></span>sudo cp docs/solr-schema.xml /etc/solr/conf/schema.xml
</pre></div> <p>For security reasons, modify <cite>/etc/tomcat6/server.xml</cite> to have the local address in the Connectory.</p> <div class=highlight><pre><span></span>&lt;Connector address="127.0.0.1" port="8080" protocol="HTTP/1.1"
           connectionTimeout="20000"
           URIEncoding="UTF-8"
           redirectPort="8443" /&gt;
</pre></div> <p>Modify <cite>/etc/dovecot/conf.d/20-imap.conf</cite> to have the following line.</p> <div class=highlight><pre><span></span>mail_plugins = $mail_plugins fts fts_solr
</pre></div> <p>Next up, add the following lines to <cite>/etc/dovecot/conf.d/90-plugin.conf</cite></p> <div class=highlight><pre><span></span>plugin {
    fts = solr
    fts_solr = break-imap-search url=https://localhost:8080/solr/
}
</pre></div> <p>Create <cite>/etc/cron.daily/solr</cite> with the following contents.</p> <div class=highlight><pre><span></span>#!/bin/sh
curl https://localhost:8080/solr/update?optimize=true
</pre></div> <p>Create <cite>/etc/cron.hourly/solr</cite> with the following contents.</p> <div class=highlight><pre><span></span>#!/bin/sh
curl https://localhost:8080/solr/update?commit=true
</pre></div> <p>Make both files executable.</p> <div class=highlight><pre><span></span>sudo chmod +x /etc/cron.daily/solr /etc/cron.hourly/solr
</pre></div> <p>Solr uses soft commits when it indexes new mail, this only commits to memory so a cron task is good for committing every hour and a daily optimize for keeping things fast.</p> <p>That’s all for Dovecot and Solr, so restart them.</p> <div class=highlight><pre><span></span>sudo /etc/init.d/dovecot restart
sudo /etc/init.d/tomcat6 restart
</pre></div> </div> <div class=section id=clamav-and-spamassassin-milters> <h2><a class=toc-backref href=#toc-entry-5>ClamAV and SpamAssassin milters</a></h2> <div class=highlight><pre><span></span>sudo apt-get install clamav-milter clamav-unofficial-sigs spamass-milter
</pre></div> <p>You’ll likely get an error when installing these, don’t worry.</p> <div class=highlight><pre><span></span>sudo freshclam
sudo /etc/init.d/clamav-daemon start
</pre></div> <p>Uncomment the last line in <cite>/etc/default/clamav-milter</cite>.</p> <div class=highlight><pre><span></span>SOCKET_RWGROUP=postfix
</pre></div> <p>Now create somewhere for the clamav-milter socket to reside.</p> <div class=highlight><pre><span></span>sudo mkdir /var/spool/postfix/clamav
sudo chown clamav /var/spool/postfix/clamav
</pre></div> <p>Edit <cite>/etc/clamav/clamav-milter.conf</cite> to look like below.</p> <div class=highlight><pre><span></span>MilterSocket /var/spool/postfix/clamav/clamav-milter.ctl
FixStaleSocket true
User clamav
AllowSupplementaryGroups true
ReadTimeout 120
Foreground false
PidFile /var/run/clamav/clamav-milter.pid
ClamdSocket unix:/var/run/clamav/clamd.ctl
OnClean Accept
OnInfected Reject
OnFail Defer
AddHeader Replace
LogSyslog false
LogFacility LOG_LOCAL6
LogVerbose false
LogInfected Off
LogClean Off
LogRotate true
MaxFileSize 100M
SupportMultipleRecipients true
RejectMsg Rejecting harmful e-mail: %v found.
TemporaryDirectory /tmp
LogFile /var/log/clamav/clamav-milter.log
LogTime true
LogFileUnlock false
LogFileMaxSize 0
MilterSocketGroup clamav
MilterSocketMode 666
</pre></div> <p>Edit <cite>/etc/default/spamass-milter</cite> and add the following line.</p> <div class=highlight><pre><span></span>OPTIONS="-u spamass-milter -i 127.0.0.1 -m -r -1 -I"
</pre></div> <p>Edit <cite>/etc/default/spamassassin</cite> to have the following values.</p> <div class=highlight><pre><span></span>ENABLED=1
CRON=1
</pre></div> <p>Update SpamAssassin and start the service.</p> <div class=highlight><pre><span></span>sudo sa-update
sudo /etc/init.d/spamassassin start
</pre></div> </div> <div class=section id=dkimproxy> <h2><a class=toc-backref href=#toc-entry-6>DKIMProxy</a></h2> <div class=highlight><pre><span></span>sudo apt-get install dkimproxy
</pre></div> <p>Create a private and public keypair.</p> <div class=highlight><pre><span></span>sudo openssl genrsa -out /etc/dkimproxy/private.key 1024
sudo openssl rsa -in /etc/dkimproxy/private.key -out /etc/dkimproxy/public.key -pubout -outform PEM
</pre></div> <p>Modify <cite>/etc/dkimproxy/dkimproxy_in.conf</cite> to look like below.</p> <div class=highlight><pre><span></span>listen 127.0.0.1:10025
relay 27.0.0.1:10026
</pre></div> <p>Modify <cite>/etc/dkimproxy/dkimproxy_out.conf</cite> to look like below.</p> <div class=highlight><pre><span></span>listen 127.0.0.1:10027
relay 127.0.0.1:10028
domain example.com
keyfile /etc/dkimproxy/private.key
selector mail
</pre></div> <p>There seems to be a rather annoying bug where signatures are not modified based on the config, I found the easiest way to cheat this is to just modify the init.d file for dkimproxy.</p> <div class=highlight><pre><span></span>DKIMPROXY_OUT_ARGS="${COMMON_ARGS} --pidfile=${PIDDKIMPROXY_OUT} --min_servers=${DKIMPROXY_OUT_MIN_SERVERS} --domain=example.com --method=simple --conf_file=${DKOUT_CONF} --keyfile=/etc/dkimproxy/private.key --selector=mail --signature=dkim(a=rsa-sha256) --signature=domainkeys(a=rsa-sha1)"
</pre></div> <p>Finally, restart dkimproxy.</p> <div class=highlight><pre><span></span>/etc/init.d/dkimproxy restart
</pre></div> </div> <div class=section id=dns> <h2><a class=toc-backref href=#toc-entry-7><span class=caps>DNS</span></a></h2> <p>All that needs to be done now is to create two three records.</p> <div class=highlight><pre><span></span>example.com. IN TXT "v=spf1 a mx -all"
</pre></div> <div class=highlight><pre><span></span>_domainkey.example.com. IN TXT "o=-;"
</pre></div> <div class=highlight><pre><span></span>mail._domainkey.example.com. IN TXT "k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDGTLLBUsIH..."
</pre></div> <p>The contents of the latter record are the public key from <cite>/etc/dkimproxy/public.key</cite>.</p> </div> </section> </div> <div class=eevee-related> <section> <h2>Related articles</h2> <ul> <li> <a href=https://kura.gg/2011/09/17/postfix-dk-dkim-spf/ rel=bookmark title="Permalink to 'Postfix + DK (DomainKeys) + DKIM + SPF on Debian 6/Ubuntu'" itemprop=url> Postfix + <span class=caps>DK</span> (DomainKeys) + <span class=caps>DKIM</span> + <span class=caps>SPF</span> on Debian&nbsp;6/Ubuntu </a> </li> <li> <a href=https://kura.gg/2015/01/26/debian-wheezy-encrypted-maildir-using-encfs/ rel=bookmark title="Permalink to 'Debian Wheezy encrypted Maildir using encfs'" itemprop=url> Debian Wheezy encrypted Maildir using&nbsp;encfs </a> </li> <li> <a href=https://kura.gg/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/ rel=bookmark title="Permalink to 'Postfix + Dovecot (IMAP/IMAPS) + SASL + Maildir on Debian 6/Ubuntu'" itemprop=url> Postfix + Dovecot (<span class=caps>IMAP</span>/<span class=caps>IMAPS</span>) + <span class=caps>SASL</span> + Maildir on Debian&nbsp;6/Ubuntu </a> </li> <li> <a href=https://kura.gg/2010/02/12/howto-domainkeys-with-postfix-on-debian-ubuntu/ rel=bookmark title="Permalink to 'HOWTO: DomainKeys with Postfix on Debian/Ubuntu'" itemprop=url> <span class=caps>HOWTO</span>: DomainKeys with Postfix on&nbsp;Debian/Ubuntu </a> </li> <li> <a href=https://kura.gg/2011/09/16/postfix-spamassassin-clamav-procmail/ rel=bookmark title="Permalink to 'Postfix + SpamAssassin + ClamAV + Procmail on Debian 6/Ubuntu'" itemprop=url> Postfix + SpamAssassin + ClamAV + Procmail on Debian&nbsp;6/Ubuntu </a> </li> </ul> </section> </div> <div class=eevee-ac> <header class=eevee-ac__header> <div class=eevee-ac-author__text> <h2>Kura</h2> <p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.</p> <p> <a href=https://kura.gg/authors/kura/ itemprop=url title="Read more articles by Kura"> Read more articles by Kura </a> </p> <nav> <ul class=eevee-ac-author__social> <li class=eevee-ac-author-social__link> <a class="mdl-color-text--accent mdl-navigation__link" href=https://github.com/kura itemprop=url rel=bookmark title="kura on GitHub"> <i class=fa aria-hidden=true>&#xF09B;</i> </a> </li> </ul> </nav> </div> <img src=/images/avatar.png class=eevee-ac-author__avatar alt=Kura> </header> </div> </article> <a href=https://github.com/kura/kura.gg/blob/main/content/debian-wheezy-mailserver-with-mysql-clamav-domainkeys-dkim-spf-imap-search.rst id=view-source title="View 'Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH' on GitHub" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white"> <i class=material-icons>&#xE86F;</i> View Source </a> </div> </div> </main> <div class="eevee-pagination__container eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"> <nav class="eevee-pagination mdl-cell mdl-cell--12-col" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label=Pagination> <a href=https://kura.gg/2015/01/20/block-yourself-from-emailing-someone-using-postfix/ class=eevee-nav__button itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C4;</i> </button> Newer </a> <div class=eevee-spacer></div> <a href=https://kura.gg/2015/01/02/torproject.org-mirror/ class=eevee-nav__button itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C8;</i> </button> </a> </nav> </div> </div> <footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement> <div class=mdl-mega-footer--top-section> <div class=mdl-mega-footer--drop-down-section> <ul class=mdl-mega-footer--link-list> <li> <a href=#top itemprop=url title="Back to the top of the page"> Back to the top of the page </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Footer navigation"> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Menu</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> </li> <li> <a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> </li> <li> <a href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </li> <li> <a href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Social</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i class=fa aria-hidden=true>&#xF09B;</i> Github </a> </li> <li> <a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i class=fa aria-hidden=true>&#xF079;</i> @kura@noc.social </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Links</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> </li> <li> <a href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> </li> <li> <a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> </li> <li> <a href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--bottom-section> <div class=mdl-logo> <a href=https://kura.gg rel=bookmark itemprop=url title=kura.gg> kura.gg </a> </div> <ul class="eevee-footer mdl-mega-footer--link-list"> <li>Powered by love &amp; rainbow sparkles.</li> <li>Source code and content released under the <a href=/license/ title="MIT license">MIT license</a>.</li> </ul> </div> </footer> </div> </body> </html>