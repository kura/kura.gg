<!DOCTYPE html><!--

                                      |
                                     /|
                                   ,' |
                                  .   |
                                    | |
                                 ' '| |
                                / / | |
       _,.-\"\"--._              / /  | |
     ,'          `.           j '   ' '
   ,'              `.         ||   / ,                         ___..--,
  /                  \\        ' `.'`.-.,-\".  .       _..---\"\"'' __, ,'
 /                    \\        \\` .\"`      `\"'\\   ,'\"_..--''\"\"\"'.'.'
.                      .      .'-'             \\,' ,'         ,','
|                      |      ,`               ' .`         .' /
|                      |     /          ,\"`.  ' `-. _____.-' .'
'                      |..---.|,\".      | | .  .-'\"\"   __.,-'
 .                   ,'       ||,|      |.' |    |\"\"`'\"
  `-._   `._.._____  |        || |      `._,'    |
      `.   .       `\".     ,'\"| \"  `'           ,+.
        \\  '         |    '   |   .....        .'  `.
         .'          '     7  \".              ,'     \\
                   ,'      |    `..        _,'      F
                  .        |,      `'----''         |
                  |      ,\"j  /                   | '
                  `     |  | .                 | `,'
                   .    |  `.|                 |/
                    `-..'   ,'                .'
                            | \\             ,''
                            |  `,'.      _,' /
                            |    | ^.  .'   /
                             `-'.' j` V    /
                                   |      /
                                   |     /
                                   |   ,'
                                    `\"\"

//--><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=1.0"><link rel=alternate href=https://kura.gg hreflang=en><link rel=dns-prefetch href=https://kura.gg><link rel=dns-prefetch href=//disqus.com><link rel=dns-prefetch href=//a.disquscdn.com><link rel=dns-prefetch href=//syslogtv.disqus.com><link rel=dns-prefetch href=//glitter-services.disqus.com><link href=https://kura.gg/feeds/rss.xml type=application/rss+xml rel=alternate title=kura.gg><link href=https://kura.gg/feeds/atom.xml type=application/atom+xml rel=alternate title=kura.gg><meta property=og:site_name content=kura.gg><meta property=og:type content=article><meta property=og:title content="Blackhole 1.8.0 development, Mock and Python entry_points"><meta content=https://kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/ property=og:url><meta property=og:description content="Over the last week I’ve been doing a huge amount of refactoring of Blackhole as well as writing dozens of additional tests. To make Blackhole more testable I needed to make a big change to how the program is launched and controlled. setup.py scripts vs. entry_points Whenever I’ve written Python programs that require some kind of command line script I’ve always used distutils’ scripts, this can be seen in blackhole’s setup.py on GitHub or in the three line example below. scripts=[ 'blackhole/bin/blackhole', ], In doing so, it allowed me to be lazy and write a lot of prodecural code in the main “binary” which made it pretty much impossible to test. You can also see that on GitHub in the main “binary”. I’ve noticed that most people who write Python packages that have some kind of command line entry point use …"><meta property=og:image content=https://kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/index.png><meta property=og:image:width content=1920><meta property=og:image:height content=1080><meta property=twitter:site content=@kuramanga><meta property=twitter:title content="Blackhole 1.8.0 development, Mock and Python entry_points"><meta content=https://kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/ property=twitter:url><meta property=twitter:description content="Over the last week I’ve been doing a huge amount of refactoring of Blackhole as well as writing dozens of additional tests. To make Blackhole more testable I needed to make a big change to how the program is launched and controlled. setup.py scripts vs. entry_points Whenever I’ve written Python programs that require some kind of command line script I’ve always used distutils’ scripts, this can be seen in blackhole’s setup.py on GitHub or in the three line example below. scripts=[ 'blackhole/bin/blackhole', ], In doing so, it allowed me to be lazy and write a lot of prodecural code in the main “binary” which made it pretty much impossible to test. You can also see that on GitHub in the main “binary”. I’ve noticed that most people who write Python packages that have some kind of command line entry point use …"><meta property=twitter:image content=https://kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/index.png><meta property=twitter:card content=summary_large_image><meta property=twitter:image:width content=1920><meta property=twitter:image:height content=1080><link rel=icon href=/favicon.png type=image/png sizes="16x16 32x32 48x48 64x64 128x128 256x256"><link rel=icon href=/favicon.ico type=image/vnd.microsoft.icon sizes="16x16 32x32 48x48 64x64 128x128 256x256"><title>Blackhole 1.8.0 development, Mock and Python entry_points</title></head> <body> <div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"> <header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader> <div class=mdl-layout__header-row> <div aria-expanded=false role=button tabindex=0 class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only"> <i class=material-icons>&#xE5D2;</i> </div> <span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top> <a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a> </h2> </span> <div class=mdl-layout-spacer role=presentation></div> <nav class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee/ itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/software/ itemprop=url rel=bookmark title=Software> <i class=material-icons aria-hidden=true>&#xE86F;</i> Software </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </nav> </div> </header> <div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true> <span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent"> kura.gg </h2> </span> <div class="mdl-navigation mdl-color--white"> <nav class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i class=material-icons aria-hidden=true> &#xE88A; </i> Home </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee/ itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/software/ itemprop=url rel=bookmark title=Software> <i class=material-icons aria-hidden=true>&#xE86F;</i> Software </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </nav> </div> </div> <div class="eevee-ribbon mdl-color--primary-dark" role=presentation> </div> <main class="eevee-main mdl-layout__content"> <div class="eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col" aria-label="Main content"> <article itemscope itemtype=http://schema.org/BlogPosting> <meta itemprop=accessibilityControl content=fullKeyboardControl> <meta itemprop=accessibilityControl content=fullMouseControl> <meta itemprop=accessibilityControl content=bookmarks> <meta itemprop=accessibilityControl content=captions> <meta itemprop=accessibilityControl content=alternativeText> <meta itemprop=accessibilityControl content=index> <meta itemprop=accessibilityControl content=readingOrder> <meta itemprop=accessibilityControl content=structuralNavigation> <meta itemprop=accessibilityControl content=tableOfContents> <meta itemprop=accessibilityHazard content=noFlashingHazard> <meta itemprop=accessibilityHazard content=noMotionSimulationHazard> <meta itemprop=accessibilityHazard content=noSoundHazard> <meta itemprop=accessibilityAPI content=ARIA> <div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation /> <a href=https://kura.gg/authors/kura/ class=hidden itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a> </div> <meta itemprop=keywords content=python,blackhole,setup.py,entry_points,mock,tests,testing> <meta itemprop=keywords content=coding> <div class=eevee-share> <ul class="social-share mdl-navigation"> <li class="social-share__link social-share__link--twitter"> <a href="https://twitter.com/intent/tweet?text=Blackhole%201.8.0%20development%2C%20Mock%20and%20Python%20entry_points&url=https%3A//kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/&related=kuramanga" title="Share 'Blackhole 1.8.0 development, Mock and Python entry_points' on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;"> <i class=fa aria-hidden=true>&#xF099;</i> </a> </li> <li class="social-share__link social-share__link--facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/" title="Share 'Blackhole 1.8.0 development, Mock and Python entry_points' on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;"> <i class=fa aria-hidden=true>&#xF09A;</i> </a> </li> <li class="social-share__link social-share__link--email"> <a href="mailto:?subject=Blackhole%201.8.0%20development%2C%20Mock%20and%20Python%20entry_points&body=I%20thought%20you%20might%20like%20'Blackhole%201.8.0%20development%2C%20Mock%20and%20Python%20entry_points'%20--%20https%3A//kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/" title="Share 'Blackhole 1.8.0 development, Mock and Python entry_points' via email"> <i class=material-icons aria-hidden=true> &#xE0E1; </i> </a> </li> <li class="social-share__link social-share__link--comment"> <a href=#article-comments title="Discuss 'Blackhole 1.8.0 development, Mock and Python entry_points'"> <i class=material-icons aria-hidden=true> &#xE0B9; </i> </a> </li> </ul> </div> <div class=eevee-article> <div class="eevee-meta mdl-color-text--grey-500"> <time datetime=2013-08-18T12:00:00+01:00 itemprop=datePublished> 18 Aug 2013 </time>&nbsp;-- 6 min read </div> <h1 itemprop=name> <a href=https://kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/ rel=bookmark title="Permalink to 'Blackhole 1.8.0 development, Mock and Python entry_points'" itemprop=url> Blackhole 1.8.0 development, Mock and Python&nbsp;entry_points </a> </h1> <section class=eevee-toc> <h2 id=toc> Contents </h2> <nav class=eevee-toc-ribbon> <div class=toc id> <p class=topic-title>Contents</p> <ul class=simple> <li><a class="reference internal" href=#setup-py-scripts-vs-entry-points id=id1>setup.py scripts vs. entry_points</a><ul> <li><a class="reference internal" href=#setup-py-entry-point-change id=id2>setup.py entry_point change</a></li> <li><a class="reference internal" href=#blackhole-application-run id=id3>blackhole.application:run</a></li> </ul> </li> <li><a class="reference internal" href=#fun-with-mock id=id4>Fun with Mock</a><ul> <li><a class="reference internal" href=#mocking-fqdn id=id5>Mocking <span class=caps>FQDN</span></a></li> <li><a class="reference internal" href=#mocking-delay-and-debug-options id=id6>Mocking —delay and —debug options</a></li> <li><a class="reference internal" href=#mocking-daemon-actions id=id7>Mocking daemon actions</a></li> </ul> </li> </ul> </div> </nav> </section> <section itemprop=articleBody class=article-content> <p>Over the last week I’ve been doing a huge amount of refactoring of <a class="reference external" href=https://blackhole.io>Blackhole</a> as well as writing dozens of additional tests. To make Blackhole more testable I needed to make a big change to how the program is launched and controlled.</p> <div class=section id=setup-py-scripts-vs-entry-points> <h2>setup.py scripts vs. entry_points</h2> <p>Whenever I’ve written Python programs that require some kind of command line script I’ve always used distutils’ scripts, this can be seen <a class="reference external" href=https://github.com/kura/blackhole/blob/05c6647aeb25ecfcc17d9df535db330a68016a24/setup.py#L37-L39>in blackhole’s setup.py on GitHub</a> or in the three line example below.</p> <div class=highlight><pre><span></span><span class=n>scripts</span><span class=o>=</span><span class=p>[</span>
    <span class=s1>'blackhole/bin/blackhole'</span><span class=p>,</span>
<span class=p>],</span>
</pre></div> <p>In doing so, it allowed me to be lazy and write a lot of prodecural code in the main “binary” which made it pretty much impossible to test. You can also see that <a class="reference external" href=https://github.com/kura/blackhole/blob/bb6cccca3a75def324ed5cb64a32fd2e5773a038/blackhole/bin/blackhole>on GitHub in the main “binary”</a>.</p> <p>I’ve noticed that most people who write Python packages that have some kind of command line entry point use distutils’ <cite>entry_points</cite> option instead of <cite>scripts</cite>. I decided to rewrite Blackhole to make it use the same entry_points option and also make it’s new entry point as testable as possible.</p> <div class=section id=setup-py-entry-point-change> <h3>setup.py entry_point change</h3> <div class=highlight><pre><span></span><span class=n>entry_points</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s1>'console_scripts'</span><span class=p>:</span> <span class=p>[</span>
        <span class=s1>'blackhole = blackhole.application:run'</span><span class=p>,</span>
    <span class=p>]</span>
<span class=p>}</span>

<span class=n>setup</span><span class=p>(</span><span class=n>name</span><span class=o>=</span><span class=s1>'blackhole'</span><span class=p>,</span>
      <span class=c1># ...</span>
      <span class=n>entry_points</span><span class=o>=</span><span class=n>entry_points</span><span class=p>,</span>
      <span class=c1># ...</span>
      <span class=p>)</span>
</pre></div> <p>I’m not going to go in to any real detal on how <cite>entry_points</cite> works, there are plenty of articles elsewhere on the internet that detail this.</p> <p>That being said, <cite>entry_points</cite> is a dictionary, in it I set a <cite>console_scripts</cite> key that has a list of scripts that should be usable from the command line.</p> <p>Each list item is made up of two parts; the command name (what will be typed on the command line to trigger the command) and the module(s) and method to run.</p> </div> <div class=section id=blackhole-application-run> <h3>blackhole.application:run</h3> <p>With the <cite>entry_points</cite> changes outlined above, this allowed me to write an entirely new and testable application.</p> <p>Now the method that launches Blackhole is much smaller and split in to testable parts.</p> <p>For example the <cite>run</cite> method is below.</p> <div class=highlight><pre><span></span><span class=k>def</span> <span class=nf>run</span><span class=p>():</span>
    <span class=sd>"""</span>
<span class=sd>    The run method is what actually spawns and manages blackhole.</span>
<span class=sd>    """</span>
    <span class=n>signal</span><span class=o>.</span><span class=n>signal</span><span class=p>(</span><span class=n>signal</span><span class=o>.</span><span class=n>SIGTERM</span><span class=p>,</span> <span class=n>terminate</span><span class=p>)</span>
    <span class=n>action</span> <span class=o>=</span> <span class=n>set_action</span><span class=p>()</span>
    <span class=n>set_options</span><span class=p>()</span>
    <span class=c1># Grab the sockets early for multiprocessing</span>
    <span class=k>if</span> <span class=n>action</span> <span class=ow>in</span> <span class=p>(</span><span class=s1>'start'</span><span class=p>,):</span>
        <span class=n>socks</span> <span class=o>=</span> <span class=n>sockets</span><span class=p>()</span>
        <span class=n>setgid</span><span class=p>()</span>
        <span class=n>setuid</span><span class=p>()</span>
    <span class=n>d</span> <span class=o>=</span> <span class=n>daemon</span><span class=p>(</span><span class=n>action</span><span class=p>)</span>
    <span class=c1># Change group and user</span>
    <span class=n>io_loop</span> <span class=o>=</span> <span class=n>fork</span><span class=p>()</span>
    <span class=c1># Iterate over the dictionary of socket connections</span>
    <span class=c1># and add them to the IOLoop</span>
    <span class=k>for</span> <span class=n>_</span><span class=p>,</span> <span class=n>sock</span> <span class=ow>in</span> <span class=n>socks</span><span class=o>.</span><span class=n>iteritems</span><span class=p>():</span>
        <span class=n>callback</span> <span class=o>=</span> <span class=n>functools</span><span class=o>.</span><span class=n>partial</span><span class=p>(</span><span class=n>connection_ready</span><span class=p>,</span> <span class=n>sock</span><span class=p>)</span>
        <span class=n>io_loop</span><span class=o>.</span><span class=n>add_handler</span><span class=p>(</span><span class=n>sock</span><span class=o>.</span><span class=n>fileno</span><span class=p>(),</span> <span class=n>callback</span><span class=p>,</span> <span class=n>io_loop</span><span class=o>.</span><span class=n>READ</span><span class=p>)</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>io_loop</span><span class=o>.</span><span class=n>start</span><span class=p>()</span>
    <span class=k>except</span> <span class=p>(</span><span class=ne>KeyboardInterrupt</span><span class=p>,</span> <span class=ne>SystemExit</span><span class=p>):</span>
        <span class=n>io_loop</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
        <span class=n>d</span><span class=o>.</span><span class=n>stop</span><span class=p>()</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
</pre></div> <p>For the full set of changes, take a look <a class="reference external" href=https://github.com/kura/blackhole/blob/05c6647aeb25ecfcc17d9df535db330a68016a24/blackhole/application.py>on GitHub at blackhole.application</a>.</p> </div> </div> <div class=section id=fun-with-mock> <h2>Fun with Mock</h2> <p><a href=https://www.voidspace.org.uk/python/mock/ class="reference external">Mock</a> is an amazing library that allows you to mock (fake) method calls and much more.</p> <p>I’ve known about Mock for a while, it’s used quite heavily at work but I’ve never really felt like I needed to use it. Then I started writing more and more tests for Blackhole, started using Mock and instantly fell in love.</p> <div class=section id=mocking-fqdn> <h3>Mocking <span class=caps>FQDN</span></h3> <p>As an example, with Blackhole 1.6.4 I added functionality to return an <span class=caps>FQDN</span> when <span class=caps>HELO</span> or <span class=caps>EHLO</span> commands are received. I didn’t write any tests for this because it uses a file on the filesystem or falls back to getting the <span class=caps>FQDN</span> from the socket library.</p> <p>After playing with Mock, I decided I would actually write tests for this piece of functionality and thankfully Mock made it insanely simple.</p> <div class=highlight><pre><span></span><span class=k>class</span> <span class=nc>TestMailNameFile</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
    <span class=n>check_value</span> <span class=o>=</span> <span class=s2>"file.blackhole.io"</span>

    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'os.path.exists'</span><span class=p>,</span> <span class=n>return_value</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>test_mail_name_file</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exists_mock</span><span class=p>):</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'__builtin__.open'</span><span class=p>,</span>
                       <span class=n>return_value</span><span class=o>=</span><span class=n>StringIO</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check_value</span><span class=p>)):</span>
                <span class=n>mn</span> <span class=o>=</span> <span class=n>get_mailname</span><span class=p>()</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>mn</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_value</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>ImportError</span><span class=p>:</span>
            <span class=k>with</span> <span class=n>patch</span><span class=p>(</span><span class=s1>'builtins.open'</span><span class=p>,</span>
                       <span class=n>return_value</span><span class=o>=</span><span class=n>StringIO</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>check_value</span><span class=p>)):</span>
                <span class=n>mn</span> <span class=o>=</span> <span class=n>get_mailname</span><span class=p>()</span>
                <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>mn</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_value</span><span class=p>)</span>
</pre></div> <p>The above test mocks the filesystem calls, returning a known value. This allows the tests to be run no matter how the machine running the tests is configured.</p> <p>The one slightly less standard part of this test is the fact it has a try: except: block inside it, this is because I need to mock Python’s builtin <cite>open</cite> method. Blackhole works on both Python 2.6/7 and on Python 3.X and with Python 3 the <cite>open</cite> method was moved from <cite>__builtin__.open</cite> to <cite>builtins.open</cite>. As such I have to attempt to run the Python 2.X version of the code and fallback to Python 3.X version if the import fails.</p> <div class=highlight><pre><span></span><span class=k>class</span> <span class=nc>TestMailNameSocket</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
    <span class=n>check_value</span> <span class=o>=</span> <span class=s2>"socket.blackhole.io"</span>

    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'os.path.exists'</span><span class=p>,</span> <span class=n>return_value</span><span class=o>=</span><span class=kc>False</span><span class=p>)</span>
    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'socket.getfqdn'</span><span class=p>,</span> <span class=n>return_value</span><span class=o>=</span><span class=n>check_value</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>test_mail_name_socket</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exists_mock</span><span class=p>,</span> <span class=n>socket_mock</span><span class=p>):</span>
        <span class=n>mn</span> <span class=o>=</span> <span class=n>get_mailname</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEqual</span><span class=p>(</span><span class=n>mn</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>check_value</span><span class=p>)</span>
</pre></div> <p>And the test above is for forcing the <span class=caps>FQDN</span> to be returned by Python’s socket library, again the return value is a known value so that it can be tested on any machine.</p> </div> <div class=section id=mocking-delay-and-debug-options> <h3>Mocking —delay and —debug options</h3> <p>Very little changes when the <cite>—delay</cite> and <cite>—debug</cite> arguments are passed in to Blackhole and sadly it’s quite hard to test both of those calls.</p> <p>One thing that I would like to test is that a relevant warning message is printed out to the console when either of these arguments is passed. Because both options can be quite dangerous to use.</p> <p>It’s kind of a pointless thing to test for but it’s also nice to know that the user is being warned correctly.</p> <p>With Mock I am able to to mock <cite>sys.stdout</cite> and have it write the output to <cite>StringIO</cite> instead, so I can test the contents of <cite>StringIO</cite> and confirm they match what I expect them to be.</p> <div class=highlight><pre><span></span><span class=k>class</span> <span class=nc>TestSetOptionsDebug</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>options</span><span class=o>.</span><span class=n>delay</span> <span class=o>=</span> <span class=mi>0</span>
        <span class=n>options</span><span class=o>.</span><span class=n>debug</span> <span class=o>=</span> <span class=kc>True</span>
        <span class=n>options</span><span class=o>.</span><span class=n>ssl</span> <span class=o>=</span> <span class=kc>False</span>

    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'sys.stdout'</span><span class=p>,</span> <span class=n>new_callable</span><span class=o>=</span><span class=n>StringIO</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>test_set_options_debug</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>stdout_mock</span><span class=p>):</span>
        <span class=n>val</span> <span class=o>=</span> <span class=s2>"""WARNING: Using the debug flag!</span><span class=se>\n</span><span class=s2>This will generate a lots"""</span>\
              <span class=sd>""" of disk I/O and large log files\n\n"""</span>
        <span class=n>set_options</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEquals</span><span class=p>(</span><span class=n>stdout_mock</span><span class=o>.</span><span class=n>getvalue</span><span class=p>(),</span> <span class=n>val</span><span class=p>)</span>


<span class=k>class</span> <span class=nc>TestSetOptionsDelay</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>options</span><span class=o>.</span><span class=n>debug</span> <span class=o>=</span> <span class=kc>False</span>
        <span class=n>options</span><span class=o>.</span><span class=n>delay</span> <span class=o>=</span> <span class=mi>1</span>
        <span class=n>options</span><span class=o>.</span><span class=n>ssl</span> <span class=o>=</span> <span class=kc>False</span>

    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'sys.stdout'</span><span class=p>,</span> <span class=n>new_callable</span><span class=o>=</span><span class=n>StringIO</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>test_set_options_delay</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>stdout_mock</span><span class=p>):</span>
        <span class=n>val</span> <span class=o>=</span> <span class=s2>"""WARNING: Using the delay flag!</span><span class=se>\n</span><span class=s2>"""</span>\
              <span class=sd>"""The delay flag is a blocking action """</span>\
              <span class=sd>"""and will cause connections to block.\n\n"""</span>
        <span class=n>set_options</span><span class=p>()</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>assertEquals</span><span class=p>(</span><span class=n>stdout_mock</span><span class=o>.</span><span class=n>getvalue</span><span class=p>(),</span> <span class=n>val</span><span class=p>)</span>
</pre></div> </div> <div class=section id=mocking-daemon-actions> <h3>Mocking daemon actions</h3> <p>Another thing that is nice to test is that the daemon is working correctly. I decided it would be a good idea to mock start, stop and status commands as well as mocking unknown commands too, to be sure how Blackhole would respond to a user’s actions.</p> <p>Thankfully Mock allows you to mock calls and confirm that they have indeed been called, for example the stop method calls <cite>sys.exit</cite>, so I can confirm that this call has actually been made.</p> <div class=highlight><pre><span></span><span class=k>class</span> <span class=nc>TestDaemonStop</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>argv</span> <span class=o>=</span> <span class=p>(</span><span class=s1>'blackhole'</span><span class=p>,</span> <span class=s1>'stop'</span><span class=p>)</span>

    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'sys.exit'</span><span class=p>)</span>
    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'deiman.Deiman.stop'</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>test_daemon_stop</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exit_mock</span><span class=p>,</span> <span class=n>daemon_mock</span><span class=p>):</span>
            <span class=n>daemon</span><span class=p>(</span><span class=s1>'stop'</span><span class=p>)</span>
            <span class=k>assert</span> <span class=n>daemon_mock</span><span class=o>.</span><span class=n>called</span>
            <span class=k>assert</span> <span class=n>exit_mock</span><span class=o>.</span><span class=n>called</span>


<span class=k>class</span> <span class=nc>TestDaemonStatus</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>argv</span> <span class=o>=</span> <span class=p>(</span><span class=s1>'blackhole'</span><span class=p>,</span> <span class=s1>'status'</span><span class=p>)</span>

    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'sys.exit'</span><span class=p>)</span>
    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'deiman.Deiman.status'</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>test_daemon_status</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exit_mock</span><span class=p>,</span> <span class=n>daemon_mock</span><span class=p>):</span>
            <span class=n>daemon</span><span class=p>(</span><span class=s1>'status'</span><span class=p>)</span>
            <span class=k>assert</span> <span class=n>daemon_mock</span><span class=o>.</span><span class=n>called</span>
            <span class=k>assert</span> <span class=n>exit_mock</span><span class=o>.</span><span class=n>called</span>


<span class=k>class</span> <span class=nc>TestDaemonStart</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>

    <span class=k>def</span> <span class=nf>setUp</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
        <span class=n>sys</span><span class=o>.</span><span class=n>argv</span> <span class=o>=</span> <span class=p>(</span><span class=s1>'blackhole'</span><span class=p>,</span> <span class=s1>'start'</span><span class=p>)</span>

    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'deiman.Deiman.start'</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>test_daemon_start</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>daemon_mock</span><span class=p>):</span>
            <span class=n>d</span> <span class=o>=</span> <span class=n>daemon</span><span class=p>(</span><span class=s1>'start'</span><span class=p>)</span>
            <span class=k>assert</span> <span class=n>daemon_mock</span><span class=o>.</span><span class=n>called</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>assertTrue</span><span class=p>(</span><span class=nb>isinstance</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=n>Deiman</span><span class=p>))</span>


<span class=k>class</span> <span class=nc>TestDaemonInvalidAction</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>

    <span class=nd>@patch</span><span class=p>(</span><span class=s1>'sys.exit'</span><span class=p>)</span>
    <span class=k>def</span> <span class=nf>test_daemon_invalid_action</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>exit_mock</span><span class=p>):</span>
            <span class=n>daemon</span><span class=p>(</span><span class=s1>'kurakurakura'</span><span class=p>)</span>
            <span class=k>assert</span> <span class=n>exit_mock</span><span class=o>.</span><span class=n>called</span>
</pre></div> </div> </div> </section> </div> <div class=eevee-related> <section> <h2>Related articles</h2> <ul> <li> <a href=https://kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/ rel=bookmark title="Permalink to 'Writing the STARTTLS command in to Blackhole'" itemprop=url> Writing the <span class=caps>STARTTLS</span> command in to&nbsp;Blackhole </a> </li> <li> <a href=https://kura.gg/2013/07/29/wrapping-a-tornado-iostream-with-ssl/ rel=bookmark title="Permalink to 'Wrapping a Tornado IOStream with SSL'" itemprop=url> Wrapping a Tornado IOStream with <span class=caps>SSL</span> </a> </li> <li> <a href=https://kura.gg/2013/07/17/djugl-june-2013-talk-on-blackhole-and-blackhole-io/ rel=bookmark title="Permalink to 'DJUGL June 2013 talk on blackhole and blackhole.io'" itemprop=url> <span class=caps>DJUGL</span> June 2013 talk on blackhole and&nbsp;blackhole.io </a> </li> <li> <a href=https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/ rel=bookmark title="Permalink to 'Blackhole 2.0: or, How I Learned to Love Asyncio'" itemprop=url> Blackhole 2.0: or, How I Learned to Love&nbsp;Asyncio </a> </li> <li> <a href=https://kura.gg/2014/09/15/batfish-writing-a-digital-ocean-v2-api-wrapper/ rel=bookmark title="Permalink to 'batfish(1) - writing a Digital Ocean V2 API wrapper'" itemprop=url> batfish(1) - writing a Digital Ocean V2 <span class=caps>API</span>&nbsp;wrapper </a> </li> </ul> </section> </div> <div class=eevee-ac> <header class=eevee-ac__header> <div class=eevee-ac-author__text> <h2>Kura</h2> <p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.</p> <p> <a href=https://kura.gg/authors/kura/ itemprop=url title="Read more articles by Kura"> Read more articles by Kura </a> </p> <nav> <ul class=eevee-ac-author__social> <li class=eevee-ac-author-social__link> <a class="mdl-color-text--accent mdl-navigation__link" href=https://github.com/kura itemprop=url rel=bookmark title="kura on GitHub"> <i class=fa aria-hidden=true>&#xF09B;</i> </a> </li> </ul> </nav> </div> <img src=/images/avatar.png class=eevee-ac-author__avatar alt=Kura> </header> </div> <div class=eevee-comment id=article-comments> <section itemscope itemtype=http://schema.org/UserComments> <h2>Join the discussion</h2> <div id=disqus_thread></div> <noscript> Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a> </noscript> </section> </div> </article> <a href=https://github.com/kura/kura.gg/blob/main/content/blackhole-1.8.0-development-mock-and-python-entry-points.rst id=view-source title="View 'Blackhole 1.8.0 development, Mock and Python entry_points' on GitHub" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white"> <i class=material-icons>&#xE86F;</i> View Source </a> </div> </div> </main> <div class="eevee-pagination__container eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"> <nav class="eevee-pagination mdl-cell mdl-cell--12-col" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label=Pagination> <a href=https://kura.gg/2013/08/18/my-ps1-with-git-branch-new-files-staged-files-and-commit-status/ class=eevee-nav__button itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C4;</i> </button> Newer </a> <div class=eevee-spacer></div> <a href=https://kura.gg/2013/08/09/writing-a-vimeo-and-youtube-plugin-for-pelican/ class=eevee-nav__button itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C8;</i> </button> </a> </nav> </div> </div> <footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement> <div class=mdl-mega-footer--top-section> <div class=mdl-mega-footer--drop-down-section> <ul class=mdl-mega-footer--link-list> <li> <a href=#top itemprop=url title="Back to the top of the page"> Back to the top of the page </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Footer navigation"> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Menu</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/eevee/ itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> </li> <li> <a href=/software/ itemprop=url rel=bookmark title=Software> <i class=material-icons aria-hidden=true>&#xE86F;</i> Software </a> </li> <li> <a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> </li> <li> <a href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Social</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i class=fa aria-hidden=true>&#xF09B;</i> Github </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Links</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://kura.gg/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> </li> <li> <a href=https://kura.gg/yarg itemprop=url rel=bookmark title=Yarg> <i class=material-icons aria-hidden=true>&#xE86F;</i> Yarg </a> </li> <li> <a href=https://kura.gg/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=https://kura.gg/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> </li> <li> <a href=https://kura.gg/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--bottom-section> <div class=mdl-logo> <a href=https://kura.gg rel=bookmark itemprop=url title=kura.gg> kura.gg </a> </div> <ul class="eevee-footer mdl-mega-footer--link-list"> <li>Powered by love &amp; rainbow sparkles.</li> <li>Source code and content released under the <a href=/license/ title="MIT license">MIT license</a>.</li> </ul> </div> </footer> </div> <link rel=stylesheet href=https://kura.gg/theme/css/eevee.min.css?6271b9c9> <script async src=https://kura.gg/theme/js/eevee.min.js?9eda6833></script> </body> </html>