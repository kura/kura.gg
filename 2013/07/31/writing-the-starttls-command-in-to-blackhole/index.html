<!DOCTYPE html><!--

                                      |
                                     /|
                                   ,' |
                                  .   |
                                    | |
                                 ' '| |
                                / / | |
       _,.-\"\"--._              / /  | |
     ,'          `.           j '   ' '
   ,'              `.         ||   / ,                         ___..--,
  /                  \\        ' `.'`.-.,-\".  .       _..---\"\"'' __, ,'
 /                    \\        \\` .\"`      `\"'\\   ,'\"_..--''\"\"\"'.'.'
.                      .      .'-'             \\,' ,'         ,','
|                      |      ,`               ' .`         .' /
|                      |     /          ,\"`.  ' `-. _____.-' .'
'                      |..---.|,\".      | | .  .-'\"\"   __.,-'
 .                   ,'       ||,|      |.' |    |\"\"`'\"
  `-._   `._.._____  |        || |      `._,'    |
      `.   .       `\".     ,'\"| \"  `'           ,+.
        \\  '         |    '   |   .....        .'  `.
         .'          '     7  \".              ,'     \\
                   ,'      |    `..        _,'      F
                  .        |,      `'----''         |
                  |      ,\"j  /                   | '
                  `     |  | .                 | `,'
                   .    |  `.|                 |/
                    `-..'   ,'                .'
                            | \\             ,''
                            |  `,'.      _,' /
                            |    | ^.  .'   /
                             `-'.' j` V    /
                                   |      /
                                   |     /
                                   |   ,'
                                    `\"\"

//--><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=1.0"><link rel=alternate href=https://kura.gg hreflang=en><link rel=dns-prefetch href=https://kura.gg><link rel=stylesheet href=https://kura.gg/theme/css/eevee.min.css?1c9d8344><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml type=application/rss+xml rel=alternate title=kura.gg><link href=https://kura.gg/feeds/atom.xml type=application/atom+xml rel=alternate title=kura.gg><meta property=og:site_name content=kura.gg><meta property=og:type content=article><meta property=og:title content="Writing the STARTTLS command in to Blackhole"><meta content=https://kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/ property=og:url><meta property=og:description content='Blackhole has always been able to handle unencrypted SMTP and for a long time it’s been able to handle encrypted SMTP via TLSv1. One thing Blackhole hasn’t been able to do until the 1.7.0 release is handle STARTTLS. In the past the STARTTLS command would cause Blackhole to return the standard 250 OK response but would continue to operate on unencrypted SMTP. I wanted to fix this and do it properly, but this meant learning how to do so with Tornado, which itself proved to be tricky. I ended up deciding to go to my local coding spot - the pub and hash it out. connection_stream The first thing I had to do was refactor the code that created the instance of tornado.iostream.IOStream and tornado.iostream.SSLIOStream so that it didn’t actually do the ssl wrapping. def connection_stream(connection): """ Detect which socket the connection …'><meta property=og:image content=https://kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/index.png><meta property=og:image:width content=1920><meta property=og:image:height content=1080><meta property=twitter:title content="Writing the STARTTLS command in to Blackhole"><meta content=https://kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/ property=twitter:url><meta property=twitter:description content='Blackhole has always been able to handle unencrypted SMTP and for a long time it’s been able to handle encrypted SMTP via TLSv1. One thing Blackhole hasn’t been able to do until the 1.7.0 release is handle STARTTLS. In the past the STARTTLS command would cause Blackhole to return the standard 250 OK response but would continue to operate on unencrypted SMTP. I wanted to fix this and do it properly, but this meant learning how to do so with Tornado, which itself proved to be tricky. I ended up deciding to go to my local coding spot - the pub and hash it out. connection_stream The first thing I had to do was refactor the code that created the instance of tornado.iostream.IOStream and tornado.iostream.SSLIOStream so that it didn’t actually do the ssl wrapping. def connection_stream(connection): """ Detect which socket the connection …'><meta property=twitter:image content=https://kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/index.png><meta property=twitter:card content=summary_large_image><meta property=twitter:label1 content="Written by"><meta property=twitter:data1 content=Kura><meta property=twitter:label2 content="Estimated reading time"><meta property=twitter:data2 content="4 min read"><meta property=twitter:image:width content=1920><meta property=twitter:image:height content=1080><link rel=icon href=/favicon.png type=image/png sizes="16x16 32x32 48x48 64x64 128x128 256x256"><link rel=icon href=/favicon.ico type=image/vnd.microsoft.icon sizes="16x16 32x32 48x48 64x64 128x128 256x256"><title>Writing the STARTTLS command in to Blackhole</title></head> <body> <div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"> <header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader> <div class=mdl-layout__header-row> <div aria-expanded=false role=button tabindex=0 class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only"> <i class=material-icons>&#xE5D2;</i> </div> <span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top> <a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a> </h2> </span> <div class=mdl-layout-spacer role=presentation></div> <nav class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </nav> </div> </header> <div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true> <span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent"> kura.gg </h2> </span> <div class="mdl-navigation mdl-color--white"> <nav class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i class=material-icons aria-hidden=true> &#xE88A; </i> Home </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </nav> </div> </div> <div class="eevee-ribbon mdl-color--primary-dark" role=presentation> </div> <main class="eevee-main mdl-layout__content"> <div class="eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col" aria-label="Main content"> <article itemscope itemtype=http://schema.org/BlogPosting> <meta itemprop=accessibilityControl content=fullKeyboardControl> <meta itemprop=accessibilityControl content=fullMouseControl> <meta itemprop=accessibilityControl content=bookmarks> <meta itemprop=accessibilityControl content=captions> <meta itemprop=accessibilityControl content=alternativeText> <meta itemprop=accessibilityControl content=index> <meta itemprop=accessibilityControl content=readingOrder> <meta itemprop=accessibilityControl content=structuralNavigation> <meta itemprop=accessibilityControl content=tableOfContents> <meta itemprop=accessibilityHazard content=noFlashingHazard> <meta itemprop=accessibilityHazard content=noMotionSimulationHazard> <meta itemprop=accessibilityHazard content=noSoundHazard> <meta itemprop=accessibilityAPI content=ARIA> <div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation /> <a href=https://kura.gg/authors/kura/ class=hidden itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a> </div> <meta itemprop=keywords content=python,tornado,iostream,ssl,starttls,blackhole> <meta itemprop=keywords content=coding> <div class=eevee-share> <ul class="social-share mdl-navigation"> <li class="social-share__link social-share__link--twitter"> <a href="https://twitter.com/intent/tweet?text=Writing%20the%20STARTTLS%20command%20in%20to%20Blackhole&url=https%3A//kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/" title="Share 'Writing the STARTTLS command in to Blackhole' on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;"> <i class=fa aria-hidden=true>&#xF099;</i> </a> </li> <li class="social-share__link social-share__link--facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/" title="Share 'Writing the STARTTLS command in to Blackhole' on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;"> <i class=fa aria-hidden=true>&#xF09A;</i> </a> </li> <li class="social-share__link social-share__link--email"> <a href="mailto:?subject=Writing%20the%20STARTTLS%20command%20in%20to%20Blackhole&body=I%20thought%20you%20might%20like%20'Writing%20the%20STARTTLS%20command%20in%20to%20Blackhole'%20--%20https%3A//kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/" title="Share 'Writing the STARTTLS command in to Blackhole' via email"> <i class=material-icons aria-hidden=true> &#xE0E1; </i> </a> </li> </ul> </div> <div class=eevee-article> <div class="eevee-meta mdl-color-text--grey-500"> <time datetime=2013-07-31T13:36:00+01:00 itemprop=datePublished> 31 Jul 2013 </time>&nbsp;&mdash; 4 min read </div> <h1 itemprop=name> <a href=https://kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/ rel=bookmark title="Permalink to 'Writing the STARTTLS command in to Blackhole'" itemprop=url> Writing the <span class=caps>STARTTLS</span> command in to&nbsp;Blackhole </a> </h1> <section class=eevee-toc> <h2 id=toc> Contents </h2> <nav class=eevee-toc-ribbon> <div class=toc id> <p class=topic-title>Contents</p> <ul class=simple> <li><a class="reference internal" href=#connection-stream id=toc-entry-1>connection_stream</a></li> <li><a class="reference internal" href=#ssl-connection id=toc-entry-2>ssl_connection</a></li> <li><a class="reference internal" href=#broken-file-descriptors id=toc-entry-3>Broken file descriptors</a></li> <li><a class="reference internal" href=#the-fix id=toc-entry-4>The fix</a></li> <li><a class="reference internal" href=#connection-ready id=toc-entry-5>connection_ready</a></li> </ul> </div> </nav> </section> <section itemprop=articleBody class=article-content> <p>Blackhole has always been able to handle unencrypted <span class=caps>SMTP</span> and for a long time it’s been able to handle encrypted <span class=caps>SMTP</span> via TLSv1.</p> <p>One thing Blackhole hasn’t been able to do until the 1.7.0 release is handle <cite><span class=caps>STARTTLS</span></cite>.</p> <p>In the past the <cite><span class=caps>STARTTLS</span></cite> command would cause Blackhole to return the standard <cite>250 <span class=caps>OK</span></cite> response but would continue to operate on unencrypted <span class=caps>SMTP</span>.</p> <p>I wanted to fix this and do it properly, but this meant learning how to do so with Tornado, which itself proved to be tricky. I ended up deciding to go to my local coding spot - the pub and hash it out.</p> <div class=section id=connection-stream> <h2>connection_stream</h2> <p>The first thing I had to do was refactor the code that created the instance of <cite>tornado.iostream.IOStream</cite> and <cite>tornado.iostream.SSLIOStream</cite> so that it didn’t actually do the ssl wrapping.</p> <div class=highlight><pre><span></span><span class=k>def</span> <span class=nf>connection_stream</span><span class=p>(</span><span class=n>connection</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Detect which socket the connection is being made on,</span>
<span class=sd>    create and iostream for the connection, wrapping it</span>
<span class=sd>    in SSL if connected over the SSL socket.</span>

<span class=sd>    The parameter 'connection' is an instance of 'socket'</span>
<span class=sd>    from stdlib.</span>
<span class=sd>    """</span>
    <span class=k>if</span> <span class=n>connection</span><span class=o>.</span><span class=n>getsockname</span><span class=p>()[</span><span class=mi>1</span><span class=p>]</span> <span class=o>==</span> <span class=n>options</span><span class=o>.</span><span class=n>ssl_port</span> <span class=ow>and</span> <span class=n>options</span><span class=o>.</span><span class=n>ssl</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>ssl_connection</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
    <span class=k>else</span><span class=p>:</span>
        <span class=k>return</span> <span class=n>iostream</span><span class=o>.</span><span class=n>IOStream</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
</pre></div> </div> <div class=section id=ssl-connection> <h2>ssl_connection</h2> <p>In doing so I added another method that actually created an instance of <cite>tornado.iostream.SSLIOStream</cite>.</p> <div class=highlight><pre><span></span><span class=k>def</span> <span class=nf>ssl_connection</span><span class=p>(</span><span class=n>connection</span><span class=p>):</span>
    <span class=k>try</span><span class=p>:</span>
        <span class=n>ssl_connection</span> <span class=o>=</span> <span class=n>ssl</span><span class=o>.</span><span class=n>wrap_socket</span><span class=p>(</span><span class=n>connection</span><span class=p>,</span> <span class=o>**</span><span class=n>sslkwargs</span><span class=p>)</span>
        <span class=k>return</span> <span class=n>iostream</span><span class=o>.</span><span class=n>SSLIOStream</span><span class=p>(</span><span class=n>ssl_connection</span><span class=p>)</span>
    <span class=k>except</span> <span class=p>(</span><span class=n>ssl</span><span class=o>.</span><span class=n>SSLError</span><span class=p>,</span> <span class=n>socket</span><span class=o>.</span><span class=n>error</span><span class=p>)</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
        <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>errno</span> <span class=o>==</span> <span class=n>ssl</span><span class=o>.</span><span class=n>SSL_ERROR_EOF</span> <span class=ow>or</span> <span class=n>e</span><span class=o>.</span><span class=n>errno</span> <span class=o>==</span> <span class=n>errno</span><span class=o>.</span><span class=n>ECONNABORTED</span><span class=p>:</span>
            <span class=n>ssl_connection</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
            <span class=k>return</span>
</pre></div> <p>This now gave me the ability to create an instance of <cite>SSLIOStream</cite> without doing all of the port checks that are required to create it when a connection is made through the <span class=caps>SSL</span> enabled port.</p> <p>Next I had to find a way of modifying the stream on-the-fly, which was really just a case of adding the current stream as an attribute of the <cite>MailState</cite> object which is unique for each connection to the server.</p> <p>The next and final step was to identify if <cite><span class=caps>STARTTLS</span></cite> had been called and overwrite the stream attribute of <cite>IOStream</cite> with <cite>SSLIOStream</cite>… This is where everything got tricky.</p> </div> <div class=section id=broken-file-descriptors> <h2>Broken file descriptors</h2> <p>Tornado would error out when <cite><span class=caps>STARTTLS</span></cite> was called with the following error</p> <div class=highlight><pre><span></span><span class=ne>Exception</span> <span class=ow>in</span> <span class=n>callback</span> <span class=o>&lt;</span><span class=n>functools</span><span class=o>.</span><span class=n>partial</span> <span class=nb>object</span> <span class=n>at</span> <span class=mh>0x26d8260</span><span class=o>&gt;</span>
    <span class=n>Traceback</span> <span class=p>(</span><span class=n>most</span> <span class=n>recent</span> <span class=n>call</span> <span class=n>last</span><span class=p>):</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/ioloop.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>453</span><span class=p>,</span> <span class=ow>in</span> <span class=n>_run_callback</span>
        <span class=n>callback</span><span class=p>()</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/stack_context.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>241</span><span class=p>,</span> <span class=ow>in</span> <span class=n>wrapped</span>
        <span class=n>callback</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>316</span><span class=p>,</span> <span class=ow>in</span> <span class=n>wrapper</span>
        <span class=n>callback</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>)</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/stack_context.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>241</span><span class=p>,</span> <span class=ow>in</span> <span class=n>wrapped</span>
        <span class=n>callback</span><span class=p>(</span><span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>)</span>
      <span class=n>File</span> <span class=s2>"/home/kura/workspace/blackhole.io/blackhole/connection.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>212</span><span class=p>,</span> <span class=ow>in</span> <span class=n>handle</span>
        <span class=n>loop</span><span class=p>()</span>
      <span class=n>File</span> <span class=s2>"/home/kura/workspace/blackhole.io/blackhole/connection.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>219</span><span class=p>,</span> <span class=ow>in</span> <span class=n>loop</span>
        <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>read_until</span><span class=p>(</span><span class=s2>"</span><span class=se>\n</span><span class=s2>"</span><span class=p>,</span> <span class=n>handle</span><span class=p>)</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>148</span><span class=p>,</span> <span class=ow>in</span> <span class=n>read_until</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_try_inline_read</span><span class=p>()</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>404</span><span class=p>,</span> <span class=ow>in</span> <span class=n>_try_inline_read</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_maybe_add_error_listener</span><span class=p>()</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>550</span><span class=p>,</span> <span class=ow>in</span> <span class=n>_maybe_add_error_listener</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_add_io_state</span><span class=p>(</span><span class=n>ioloop</span><span class=o>.</span><span class=n>IOLoop</span><span class=o>.</span><span class=n>READ</span><span class=p>)</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>580</span><span class=p>,</span> <span class=ow>in</span> <span class=n>_add_io_state</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>fileno</span><span class=p>(),</span> <span class=bp>self</span><span class=o>.</span><span class=n>_handle_events</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_state</span><span class=p>)</span>
      <span class=n>File</span> <span class=s2>"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/ioloop.py"</span><span class=p>,</span> <span class=n>line</span> <span class=mi>516</span><span class=p>,</span> <span class=ow>in</span> <span class=n>add_handler</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_impl</span><span class=o>.</span><span class=n>register</span><span class=p>(</span><span class=n>fd</span><span class=p>,</span> <span class=n>events</span> <span class=o>|</span> <span class=bp>self</span><span class=o>.</span><span class=n>ERROR</span><span class=p>)</span>
    <span class=ne>IOError</span><span class=p>:</span> <span class=p>[</span><span class=n>Errno</span> <span class=mi>17</span><span class=p>]</span> <span class=n>File</span> <span class=n>exists</span>
</pre></div> <p>I had no choice at this point but to do what I always do when I’m stumped, <a href=https://groups.google.com/forum/#!topic/python-tornado/ class="reference external">head over to the mailing list!</a></p> <p>I didn’t get a response for a while so while waiting I decided to ask some intelligent people.</p> <p>I pointed a tweet at <a class="reference external" href=https://twitter.com/alex_gaynor>@alex_gaynor</a> which was responded to by <a class="reference external" href=https://twitter.com/fijall>@fijall</a> but neither could help. Alex mentioned Twisted which triggered a response from <a class="reference external" href=https://twitter.com/hynek>@hynek</a> but sadly still no solution.</p> </div> <div class=section id=the-fix> <h2>The fix</h2> <p>Then I received an email response from Ben Darnell on the Tornado mailing list which pointed me in the right direction.</p> <p>In the end the simple fix was to modify the instance of <cite>tornado.ioloop.IOLoop</cite> during run time and removed the original instance of <cite>IOStream</cite> from it.</p> <div class=highlight><pre><span></span><span class=k>if</span> <span class=n>line</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>"starttls"</span><span class=p>):</span>
    <span class=n>fileno</span> <span class=o>=</span> <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>socket</span><span class=o>.</span><span class=n>fileno</span><span class=p>()</span>
    <span class=n>IOLoop</span><span class=o>.</span><span class=n>current</span><span class=p>()</span><span class=o>.</span><span class=n>remove_handler</span><span class=p>(</span><span class=n>fileno</span><span class=p>)</span>
    <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span> <span class=o>=</span> <span class=n>ssl_connection</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
</pre></div> </div> <div class=section id=connection-ready> <h2>connection_ready</h2> <p>You can see this at work in the final version of the connect_ready method.</p> <div class=highlight><pre><span></span><span class=k>def</span> <span class=nf>connection_ready</span><span class=p>(</span><span class=n>sock</span><span class=p>,</span> <span class=n>fd</span><span class=p>,</span> <span class=n>events</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Accepts the socket connections and passes them off</span>
<span class=sd>    to be handled.</span>

<span class=sd>    'sock' is an instance of 'socket'.</span>
<span class=sd>    'fd' is an open file descriptor for the current connection.</span>
<span class=sd>    'events' is an integer of the number of events on the socket.</span>
<span class=sd>    """</span>
    <span class=k>while</span> <span class=kc>True</span><span class=p>:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>connection</span><span class=p>,</span> <span class=n>address</span> <span class=o>=</span> <span class=n>sock</span><span class=o>.</span><span class=n>accept</span><span class=p>()</span>
        <span class=k>except</span> <span class=n>socket</span><span class=o>.</span><span class=n>error</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>e</span><span class=o>.</span><span class=n>errno</span> <span class=ow>not</span> <span class=ow>in</span> <span class=p>(</span><span class=n>errno</span><span class=o>.</span><span class=n>EWOULDBLOCK</span><span class=p>,</span> <span class=n>errno</span><span class=o>.</span><span class=n>EAGAIN</span><span class=p>):</span>
                <span class=k>raise</span>
            <span class=k>return</span>

        <span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>"Connection from '</span><span class=si>%s</span><span class=s2>'"</span> <span class=o>%</span> <span class=n>address</span><span class=p>[</span><span class=mi>0</span><span class=p>])</span>

        <span class=n>connection</span><span class=o>.</span><span class=n>setblocking</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
        <span class=n>stream</span> <span class=o>=</span> <span class=n>connection_stream</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
        <span class=k>if</span> <span class=ow>not</span> <span class=n>stream</span><span class=p>:</span>
            <span class=k>return</span>
        <span class=n>mail_state</span> <span class=o>=</span> <span class=n>MailState</span><span class=p>()</span>
        <span class=n>mail_state</span><span class=o>.</span><span class=n>email_id</span> <span class=o>=</span> <span class=n>email_id</span><span class=p>()</span>
        <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span> <span class=o>=</span> <span class=n>stream</span>

        <span class=c1># Sadly there is nothing I can do about the handle and loop</span>
        <span class=c1># fuctions. They have to exist within connection_ready</span>
        <span class=k>def</span> <span class=nf>handle</span><span class=p>(</span><span class=n>line</span><span class=p>):</span>
<span class=w>            </span><span class=sd>"""</span>
<span class=sd>            Handle a line of socket data, figure out if</span>
<span class=sd>            it's a valid SMTP keyword and handle it</span>
<span class=sd>            accordingly.</span>
<span class=sd>            """</span>
            <span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>"[</span><span class=si>%s</span><span class=s2>] RECV: </span><span class=si>%s</span><span class=s2>"</span> <span class=o>%</span> <span class=p>(</span><span class=n>mail_state</span><span class=o>.</span><span class=n>email_id</span><span class=p>,</span> <span class=n>line</span><span class=o>.</span><span class=n>rstrip</span><span class=p>()))</span>
            <span class=n>resp</span><span class=p>,</span> <span class=n>close</span> <span class=o>=</span> <span class=n>handle_command</span><span class=p>(</span><span class=n>line</span><span class=p>,</span> <span class=n>mail_state</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>resp</span><span class=p>:</span>
                <span class=k>if</span> <span class=nb>isinstance</span><span class=p>(</span><span class=n>resp</span><span class=p>,</span> <span class=nb>list</span><span class=p>):</span>
                    <span class=k>for</span> <span class=n>r</span> <span class=ow>in</span> <span class=n>resp</span><span class=p>:</span>
                        <span class=n>write_response</span><span class=p>(</span><span class=n>mail_state</span><span class=p>,</span> <span class=n>r</span><span class=p>)</span>
                <span class=k>else</span><span class=p>:</span>
                    <span class=c1># Otherwise it's a single response</span>
                    <span class=n>write_response</span><span class=p>(</span><span class=n>mail_state</span><span class=p>,</span> <span class=n>resp</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>line</span><span class=o>.</span><span class=n>lower</span><span class=p>()</span><span class=o>.</span><span class=n>startswith</span><span class=p>(</span><span class=s2>"starttls"</span><span class=p>):</span>
                <span class=n>fileno</span> <span class=o>=</span> <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>socket</span><span class=o>.</span><span class=n>fileno</span><span class=p>()</span>
                <span class=n>IOLoop</span><span class=o>.</span><span class=n>current</span><span class=p>()</span><span class=o>.</span><span class=n>remove_handler</span><span class=p>(</span><span class=n>fileno</span><span class=p>)</span>
                <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span> <span class=o>=</span> <span class=n>ssl_connection</span><span class=p>(</span><span class=n>connection</span><span class=p>)</span>
            <span class=k>if</span> <span class=n>close</span> <span class=ow>is</span> <span class=kc>True</span><span class=p>:</span>
                <span class=n>log</span><span class=o>.</span><span class=n>debug</span><span class=p>(</span><span class=s2>"Closing"</span><span class=p>)</span>
                <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
                <span class=k>del</span> <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span>
                <span class=k>return</span>
            <span class=k>else</span><span class=p>:</span>
                <span class=n>loop</span><span class=p>()</span>

        <span class=k>def</span> <span class=nf>loop</span><span class=p>():</span>
<span class=w>            </span><span class=sd>"""</span>
<span class=sd>            Loop over the socket data until we receive</span>
<span class=sd>            a newline character (\n)</span>
<span class=sd>            """</span>
            <span class=c1># Protection against stream already reading exceptions</span>
            <span class=k>if</span> <span class=ow>not</span> <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>reading</span><span class=p>():</span>
                <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>read_until</span><span class=p>(</span><span class=s2>"</span><span class=se>\n</span><span class=s2>"</span><span class=p>,</span> <span class=n>handle</span><span class=p>)</span>

        <span class=n>hm</span> <span class=o>=</span> <span class=s2>"220 </span><span class=si>%s</span><span class=s2> [</span><span class=si>%s</span><span class=s2>]</span><span class=se>\r\n</span><span class=s2>"</span> <span class=o>%</span> <span class=p>(</span><span class=n>get_mailname</span><span class=p>(),</span> <span class=n>__fullname__</span><span class=p>)</span>
        <span class=n>mail_state</span><span class=o>.</span><span class=n>stream</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>hm</span><span class=p>)</span>
        <span class=n>loop</span><span class=p>()</span>
</pre></div> </div> </section> </div> <div class=eevee-related> <section> <h2>Related articles</h2> <ul> <li> <a href=https://kura.gg/2013/07/29/wrapping-a-tornado-iostream-with-ssl/ rel=bookmark title="Permalink to 'Wrapping a Tornado IOStream with SSL'" itemprop=url> Wrapping a Tornado IOStream with <span class=caps>SSL</span> </a> </li> <li> <a href=https://kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/ rel=bookmark title="Permalink to 'Blackhole 1.8.0 development, Mock and Python entry_points'" itemprop=url> Blackhole 1.8.0 development, Mock and Python&nbsp;entry_points </a> </li> <li> <a href=https://kura.gg/2013/07/17/djugl-june-2013-talk-on-blackhole-and-blackhole-io/ rel=bookmark title="Permalink to 'DJUGL June 2013 talk on blackhole and blackhole.io'" itemprop=url> <span class=caps>DJUGL</span> June 2013 talk on blackhole and&nbsp;blackhole.io </a> </li> <li> <a href=https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/ rel=bookmark title="Permalink to 'Blackhole 2.0: or, How I Learned to Love Asyncio'" itemprop=url> Blackhole 2.0: or, How I Learned to Love&nbsp;Asyncio </a> </li> <li> <a href=https://kura.gg/2014/09/15/batfish-writing-a-digital-ocean-v2-api-wrapper/ rel=bookmark title="Permalink to 'batfish(1) - writing a Digital Ocean V2 API wrapper'" itemprop=url> batfish(1) - writing a Digital Ocean V2 <span class=caps>API</span>&nbsp;wrapper </a> </li> </ul> </section> </div> <div class=eevee-ac> <header class=eevee-ac__header> <div class=eevee-ac-author__text> <h2>Kura</h2> <p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.</p> <p> <a href=https://kura.gg/authors/kura/ itemprop=url title="Read more articles by Kura"> Read more articles by Kura </a> </p> <nav> <ul class=eevee-ac-author__social> <li class=eevee-ac-author-social__link> <a class="mdl-color-text--accent mdl-navigation__link" href=https://github.com/kura itemprop=url rel=bookmark title="kura on GitHub"> <i class=fa aria-hidden=true>&#xF09B;</i> </a> </li> </ul> </nav> </div> <img src=/images/avatar.png class=eevee-ac-author__avatar alt=Kura> </header> </div> </article> <a href=https://github.com/kura/kura.gg/blob/main/content/writing-the-starttls-command-in-to-blackhole.rst id=view-source title="View 'Writing the STARTTLS command in to Blackhole' on GitHub" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white"> <i class=material-icons>&#xE86F;</i> View Source </a> </div> </div> </main> <div class="eevee-pagination__container eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"> <nav class="eevee-pagination mdl-cell mdl-cell--12-col" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label=Pagination> <a href=https://kura.gg/2013/08/09/writing-a-vimeo-and-youtube-plugin-for-pelican/ class=eevee-nav__button itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C4;</i> </button> Newer </a> <div class=eevee-spacer></div> <a href=https://kura.gg/2013/07/29/wrapping-a-tornado-iostream-with-ssl/ class=eevee-nav__button itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C8;</i> </button> </a> </nav> </div> </div> <footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement> <div class=mdl-mega-footer--top-section> <div class=mdl-mega-footer--drop-down-section> <ul class=mdl-mega-footer--link-list> <li> <a href=#top itemprop=url title="Back to the top of the page"> Back to the top of the page </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Footer navigation"> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Menu</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> </li> <li> <a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> </li> <li> <a href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </li> <li> <a href=https://kura.gg/feeds/atom.xml title=Atom itemprop=url> <i class=material-icons>&#xE0E5;</i> Atom </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Social</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i class=fa aria-hidden=true>&#xF09B;</i> Github </a> </li> <li> <a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i class=fa aria-hidden=true>&#xF079;</i> @kura@noc.social </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Links</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> </li> <li> <a href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> </li> <li> <a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> </li> <li> <a href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--bottom-section> <div class=mdl-logo> <a href=https://kura.gg rel=bookmark itemprop=url title=kura.gg> kura.gg </a> </div> <ul class="eevee-footer mdl-mega-footer--link-list"> <li>Powered by love &amp; rainbow sparkles.</li> <li>Source code and content released under the <a href=/license/ title="MIT license">MIT license</a>.</li> </ul> </div> </footer> </div> </body> </html>