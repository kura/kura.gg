<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="haproxy, nginx and SPDY with SSL termination (Debian 7)" property=og:title><meta content=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/ property=og:url><meta content="I wrote an article last week explaining that I had changed my blog and built my own nginx packages with SPDY built in. I decided I would take things a little further and poke around with haproxy some more. The initial plan was to compile the latest dev source of haproxy with SSL termination enabled. In doing so I realised I would lose SPDY support, which upset me a little. After some digging I found that the 1.5-dev branch of haproxy supports npn and thus can handle SPDY. I tweaked my builds a little more and managed to get haproxy running as an SSL terminating load balancer, with SPDY connections being sent off to my nginx servers with SPDY enabled and all other non-SPDY connections were passed on to an nginx virtual host with SPDY disabled. Requirements I have released my haproxy build as a debian file below …" property=og:description><meta content=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="haproxy, nginx and SPDY with SSL termination (Debian 7)" property=twitter:title><meta content=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/ property=twitter:url><meta content="I wrote an article last week explaining that I had changed my blog and built my own nginx packages with SPDY built in. I decided I would take things a little further and poke around with haproxy some more. The initial plan was to compile the latest dev source of haproxy with SSL termination enabled. In doing so I realised I would lose SPDY support, which upset me a little. After some digging I found that the 1.5-dev branch of haproxy supports npn and thus can handle SPDY. I tweaked my builds a little more and managed to get haproxy running as an SSL terminating load balancer, with SPDY connections being sent off to my nginx servers with SPDY enabled and all other non-SPDY connections were passed on to an nginx virtual host with SPDY disabled. Requirements I have released my haproxy build as a debian file below …" property=twitter:description><meta content=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="5 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><script type=application/ld+json>
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "haproxy, nginx and SPDY with SSL termination (Debian 7)",
    "url": "https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/",
    "description": "I wrote an article last week explaining that I had changed my blog and built my own nginx packages with SPDY built in. I decided I would take things a little further and poke around with haproxy some more. The initial plan was to compile the latest dev source of haproxy with SSL termination enabled. In doing so I realised I would lose SPDY support, which upset me a little. After some digging I found that the 1.5-dev branch of haproxy supports npn and thus can handle SPDY. I tweaked my builds a little more and managed to get haproxy running as an SSL terminating load balancer, with SPDY connections being sent off to my nginx servers with SPDY enabled and all other non-SPDY connections were passed on to an nginx virtual host with SPDY disabled. Requirements I have released my haproxy build as a debian file below …",
    "author": {
        "@type": "Person",
        "name": "Kura",
        "url": "https://kura.gg/authors/kura/"
    },
    "publisher": {
        "@type": "Organization",
        "name": "kura.gg",
        "url": "https://kura.gg/authors/kura/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kura.gg/favicon.png"
        }
    },
    "mainEntityOfPage": "https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/",
    "image": "https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/index.png",
    "datePublished": "2013-07-15T22:30:00+01:00"
}
</script><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>haproxy, nginx and SPDY with SSL termination (Debian 7)</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons></i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>  </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content="debian,ubuntu,haproxy,nginx,spdy,ssl,ssl termination" itemprop=keywords><meta content=tutorials itemprop=keywords><div class=eevee-share><ul class="social-share mdl-navigation"><li class="social-share__link social-share__link--twitter"><a onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Share 'haproxy, nginx and SPDY with SSL termination (Debian 7)' on Twitter" href=https://twitter.com/intent/tweet?text=haproxy%2C%20nginx%20and%20SPDY%20with%20SSL%20termination%20%28Debian%207%29&url=https%3A//kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--facebook"><a onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Share 'haproxy, nginx and SPDY with SSL termination (Debian 7)' on Facebook" href=https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--email"><a title="Share 'haproxy, nginx and SPDY with SSL termination (Debian 7)' via email" href=mailto:?subject=haproxy%2C%20nginx%20and%20SPDY%20with%20SSL%20termination%20%28Debian%207%29&body=I%20thought%20you%20might%20like%20'haproxy%2C%20nginx%20and%20SPDY%20with%20SSL%20termination%20%28Debian%207%29'%20--%20https%3A//kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/> <i aria-hidden=true class=material-icons>  </i> </a></ul></div><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2013-07-15T22:30:00+01:00 itemprop=datePublished> 15 Jul 2013 </time> — 5 min read</div><h1 itemprop=name><a title="Permalink to 'haproxy, nginx and SPDY with SSL termination (Debian 7)'" href=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/ itemprop=url rel=bookmark> haproxy, nginx and <span class=caps>SPDY</span> with <span class=caps>SSL</span> termination (Debian 7) </a></h1><section class=eevee-toc><h2 id=toc>Contents</h2><nav class=eevee-toc-ribbon><div class=toc><p class=topic-title><a class="reference internal" href=#top>Contents</a><ul class=simple><li><a class="reference internal" href=#requirements id=toc-entry-1>Requirements</a><li><a class="reference internal" href=#installing-haproxy id=toc-entry-2>Installing haproxy</a><li><a class="reference internal" href=#configuring-haproxy id=toc-entry-3>Configuring haproxy</a><ul><li><a class="reference internal" href=#frontend-http id=toc-entry-4>frontend http</a><li><a class="reference internal" href=#frontend-kura-gg id=toc-entry-5>frontend kura-gg</a><li><a class="reference internal" href=#backend-kura-app-spdy id=toc-entry-6>backend kura-app-spdy</a><li><a class="reference internal" href=#backend-kura-app-http id=toc-entry-7>backend kura-app-http</a></ul><li><a class="reference internal" href=#nginx id=toc-entry-8>nginx</a><li><a class="reference internal" href=#configuring-nginx id=toc-entry-9>Configuring nginx</a></ul></div></nav></section><section class=article-content itemprop=articleBody><p><a class="reference external" href=/2013/07/10/nginx-spdy-and-ngx-pagespeed/>I wrote an article last week</a> explaining that I had changed my blog and built my own nginx packages with <a class="reference external" href=https://www.chromium.org/spdy><span class=caps>SPDY</span></a> built in.<p>I decided I would take things a little further and poke around with haproxy some more. The initial plan was to compile the latest dev source of haproxy with <span class=caps>SSL</span> termination enabled.<p>In doing so I realised I would lose <span class=caps>SPDY</span> support, which upset me a little. After some digging I found that the 1.5-dev branch of haproxy supports npn and thus can handle <span class=caps>SPDY</span>.<p>I tweaked my builds a little more and managed to get haproxy running as an <span class=caps>SSL</span> terminating load balancer, with <span class=caps>SPDY</span> connections being sent off to my nginx servers with <span class=caps>SPDY</span> enabled and all other non-<span class=caps>SPDY</span> connections were passed on to an nginx virtual host with <span class=caps>SPDY</span> disabled.<div class=section id=requirements><h2>Requirements</h2><p>I have released my haproxy build as a debian file below, it is built off of haproxy_1.5~dev19 and is compiled for amd64. It should work on any installation of Debian 7 and requires openssl-1.0.1d or higher.<p>On a standard Debian 7 install you should have openssl-1.0.1e-2, you can find which version you have by running<div class=highlight><pre><span></span>dpkg<span class=w> </span>-l<span class=w> </span>openssl
</pre></div><p>This should return something similar to<pre class=literal-block>
ii  openssl        1.0.1e-2        amd64        Secure Socket Layer (SSL) binary and related cryptographic tools
</pre></div><div class=section id=installing-haproxy><h2>Installing haproxy</h2><p>Download the deb file below, use either the <span class=caps>GPG</span> key or <span class=caps>MD5</span>/<span class=caps>SHA1</span> sums to verify it.<table class=docutils><thead><tr><th class=head><span class=caps>FILE</span><th class=head><span class=caps>GPG</span><th class=head><span class=caps>MD5</span><th class=head><span class=caps>SHA1</span><tbody><tr><td><a class="reference external" href=/files/haproxy_1.5~dev19_amd64.deb>haproxy_1.5~dev19_amd64.deb</a><td><a class="reference external" href=/files/haproxy_1.5~dev19_amd64.deb.asc>owGMeXVU1G…</a><td><a class="reference external" href=/files/haproxy_1.5~dev19_amd64.deb.md5>715317e082…</a><td><a class="reference external" href=/files/haproxy_1.5~dev19_amd64.deb.sha1>e116e1c597…</a></table><p>If you already have haproxy installed, make sure to remove it first.<p>You can install them by simply running:<div class=highlight><pre><span></span>sudo<span class=w> </span>dpkg<span class=w> </span>-i<span class=w> </span>haproxy_1.5~dev19_amd64.deb
</pre></div><p>You may receive an error due to missing dependencies, to fix this run:<div class=highlight><pre><span></span>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>-f
</pre></div></div><div class=section id=configuring-haproxy><h2>Configuring haproxy</h2><p>First we need to enabled haproxy by running the following command<div class=highlight><pre><span></span>sudo<span class=w> </span>sed<span class=w> </span>-i<span class=w> </span><span class=s1>'s/ENABLED=0/ENABLED=1/'</span><span class=w> </span>/etc/default/haproxy
</pre></div><p>We then need to empty the contents of the haproxy configuration and replace it with a nice blank file. The following command will copy the original file to a new location and create a blank file<div class=highlight><pre><span></span>sudo<span class=w> </span>mv<span class=w> </span>/etc/haproxy/haproxy.cfg<span class=o>{</span>,.orig<span class=o>}</span><span class=w> </span><span class=o>&&</span><span class=w> </span>sudo<span class=w> </span>>/etc/haproxy/haproxy.cfg
</pre></div><p><span class=caps>SPDY</span> only works over <span class=caps>HTTPS</span>, so bare that in mind. All you need to do is enable <span class=caps>SPDY</span> in your server configuration as below.<pre class=literal-block>
global
    maxconn 4096
    user haproxy
    group haproxy

defaults
    option dontlognull
    retries 3
    option redispatch
    maxconn 2000
    contimeout 5000
    clitimeout 50000
    srvtimeout 50000

frontend http
    mode http
    bind 0.0.0.0:80
    redirect sheme https if !{ ssl_fc }

frontend kura-gg
    mode tcp
    bind 0.0.0.0:443 ssl crt /etc/ssl/certs/kura.gg.pem npn spdy/2 # pem is certificate, intermediate and finally private key
    use_backend kura-app-spdy if { ssl_fc_npn -i spdy/2 }
    default_backend kura-app-http

backend kura-app-spdy
    mode tcp
    server kura-gg-app1 127.0.0.1:80 check

backend kura-app-http
    mode http
    server kura-gg-app1 127.0.0.1:81 check
</pre><p>You don’t need to worry about the <em>global</em> and <em>defaults</em> sections, I will now explain what the final four sections do.<div class=section id=frontend-http><h3>frontend http</h3><pre class=literal-block>
frontend http
    mode http
    bind 0.0.0.0:80
    redirect sheme https if !{ ssl_fc }
</pre><p>This tells haproxy to listen on port 80 and redirect all traffic to the <span class=caps>HTTPS</span> version of the site.</div><div class=section id=frontend-kura-gg><h3>frontend kura-gg</h3><pre class=literal-block>
frontend kura-gg
    mode tcp
    bind 0.0.0.0:443 ssl crt /etc/ssl/certs/kura.gg.pem npn spdy/2 # pem is certificate, intermediate and finally private key
    use_backend kura-app-spdy if { ssl_fc_npn -i spdy/2 }
    default_backend kura-app-http
</pre><p>This section sets the proxy mode to tcp, which sends tcp data over to the backend servers rather than http requests.<p>We then bind to all interfaces on port 443, enabling <span class=caps>SSL</span> and passing in a <span class=caps>PEM</span> version of the certificate in the following format<pre class=literal-block>
-----BEGIN CERTIFICATE-----
MAIN CERTIFICATE FOR KURA.IO
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
INTERMEDIATE CERTIFICATE
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
PRIVATE KEY
-----END RSA PRIVATE KEY-----
</pre><p>Finally we do some magic. We tell haproxy to use the <span class=caps>SPDY</span> backend if a <span class=caps>SPDY</span> header is present:<pre class=literal-block>
use_backend kura-app-spdy if { ssl_fc_npn -i spdy/2 }
</pre><p>If not then we fall back to the default <span class=caps>HTTP</span> backend:<pre class=literal-block>
default_backend kura-app-http
</pre></div><div class=section id=backend-kura-app-spdy><h3>backend kura-app-spdy</h3><pre class=literal-block>
backend kura-app-spdy
    mode tcp
    server kura-gg-app1 127.0.0.1:80 check
</pre><p>This section simply defines the server we should talk to if the client is using an <span class=caps>SPDY</span> enabled connection.<p>Simply define multiple servers for additional servers.<p>You can see I am point it at 127.0.0.1 on port 80.</div><div class=section id=backend-kura-app-http><h3>backend kura-app-http</h3><pre class=literal-block>
backend kura-app-http
    mode http
    server kura-gg-app1 127.0.0.1:81 check
</pre><p>And finally, here I am defining the http backends to fall back on for non-<span class=caps>SPDY</span> connections.<p>You can see this is almost identical to the <span class=caps>SPDY</span> backend except it is running in <span class=caps>HTTP</span> mode.<p>As with the <span class=caps>SPDY</span> backends, simply define multiple servers as required. Here I am using 127.0.0.1 and port 81.</div></div><div class=section id=nginx><h2>nginx</h2><p>To make this all tie together we simply need to install an <span class=caps>SPDY</span>-enabled nginx.<p>You can <a class="reference external" href=/2013/07/10/nginx-spdy-and-ngx-pagespeed/>follow my guide on how to install my packaged version of nginx with <span class=caps>SPDY</span> enabled</a>.<p>Follow this guide up until the configuration of nginx.</div><div class=section id=configuring-nginx><h2>Configuring nginx</h2><p>Within nginx we need to enable two virtual hosts<div class=highlight><pre><span></span><span class=k>server</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>listen</span><span class=w> </span><span class=mi>80</span><span class=w> </span><span class=s>spdy</span><span class=p>;</span>
<span class=w>    </span><span class=kn>server_name</span><span class=w> </span><span class=s>kura.gg</span><span class=p>;</span>

<span class=w>    </span><span class=c1># make nginx 301 redirects work</span>
<span class=w>    </span><span class=kn>port_in_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span>
<span class=w>    </span><span class=kn>server_name_in_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span>

<span class=w>    </span><span class=kn>location</span><span class=w> </span><span class=s>/</span><span class=w> </span><span class=p>{</span>
<span class=w>            </span><span class=kn>root</span><span class=w>   </span><span class=s>/var/www/kura.gg/</span><span class=p>;</span>
<span class=w>            </span><span class=kn>index</span><span class=w>  </span><span class=s>index.html</span><span class=w> </span><span class=s>index.htm</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>

<span class=k>server</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>listen</span><span class=w> </span><span class=mi>81</span><span class=p>;</span>
<span class=w>    </span><span class=kn>server_name</span><span class=w> </span><span class=s>kura.gg</span><span class=p>;</span>

<span class=w>    </span><span class=c1># make nginx 301 redirects work</span>
<span class=w>    </span><span class=kn>port_in_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span>
<span class=w>    </span><span class=kn>server_name_in_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span>

<span class=w>    </span><span class=kn>location</span><span class=w> </span><span class=s>/</span><span class=w> </span><span class=p>{</span>
<span class=w>            </span><span class=kn>root</span><span class=w>   </span><span class=s>/var/www/kura.gg/</span><span class=p>;</span>
<span class=w>            </span><span class=kn>index</span><span class=w>  </span><span class=s>index.html</span><span class=w> </span><span class=s>index.htm</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>
</pre></div><p>The first virtual host is our <span class=caps>SPDY</span> enabled host which is configured to run on port 80.<p>The second is our standard <span class=caps>HTTP</span> host which is running on port 81.<p>We have two lines <em>port_in_redirect</em> and <em>server_name_in_redirect</em> set to <em>off</em> because otherwise nginx would try to redirect to <a class="reference external" href=https://kura.gg:81/>https://kura.gg:81/</a> and cause issues with haproxy.<p>It’s a simple as that, you can test this using the <a class="reference external" href=https://addons.mozilla.org/en-us/firefox/addon/spdy-indicator/>Firefox</a> and <a class="reference external" href=https://chrome.google.com/webstore/detail/spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin>Chrome</a> extensions that show you websites with <span class=caps>SPDY</span> enabled.</div></section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'haproxy1.5-dev22kura1'" href=https://kura.gg/2014/03/06/haproxy1.5-dev22kura1/ itemprop=url rel=bookmark> haproxy1.5-dev22kura1 </a><li><a title="Permalink to 'haproxy1.5-dev22'" href=https://kura.gg/2014/02/22/haproxy1.5-dev22/ itemprop=url rel=bookmark> haproxy1.5-dev22 </a><li><a title="Permalink to 'nginx 1.5.9 and ngx_pagespeed 1.7.30.3-beta'" href=https://kura.gg/2014/02/02/nginx-1.5.9-and-ngx_pagespeed-1.7.30.3-beta/ itemprop=url rel=bookmark> nginx 1.5.9 and ngx_pagespeed 1.7.30.3-beta </a><li><a title="Permalink to 'haproxy1.5-dev21, nginx 1.5.8, SPDY & pagespeed 1.7.30.2'" href=https://kura.gg/2014/01/08/haproxy1.5-dev21-nginx-1.5.8-spdy-pagespeed-1.7.30.2/ itemprop=url rel=bookmark> haproxy1.5-dev21, nginx 1.5.8, <span class=caps>SPDY</span> <span class=amp>&</span> pagespeed 1.7.30.2 </a><li><a title="Permalink to 'nginx 1.5.10 with SPDY 3.1'" href=https://kura.gg/2014/02/06/nnginx-1.5.10-with-spdy3.1/ itemprop=url rel=bookmark> nginx 1.5.10 with <span class=caps>SPDY</span> 3.1 </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa></i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>🦣</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'haproxy, nginx and SPDY with SSL termination (Debian 7)' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/haproxy-nginx-and-spdy-with-ssl-termination-debian-7.rst id=view-source> <i class=material-icons></i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2013/07/17/djugl-june-2013-talk-on-blackhole-and-blackhole-io/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> Newer </a><div class=eevee-spacer></div><a class=eevee-nav__button href=https://kura.gg/2013/07/10/nginx-spdy-and-ngx-pagespeed/ itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> </a></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa></i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>🦣</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>