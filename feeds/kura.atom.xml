<?xml version="1.0" encoding="utf-8"?>
<?xml-stylesheet href="/theme/xsl/atom.xsl" type="text/xsl"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>kura.gg - kura</title><link href="https://kura.gg/" rel="alternate"></link><link href="https://kura.gg/feeds/kura.atom.xml" rel="self"></link><id>https://kura.gg/</id><updated>2021-10-24T12:00:00+01:00</updated><entry><title>Playing with Cloudflare Workers: Injecting CSP nonces in to responses</title><link href="https://kura.gg/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/" rel="alternate"></link><published>2021-10-24T12:00:00+01:00</published><updated>2021-10-24T12:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2021-10-24:/2021/10/24/playing-with-cloudflare-workers-injecting-csp-nonce/</id><summary type="html">&lt;img alt="Mew, the Pokémon" class="align-center" src="/images/151_mew.png"/&gt;

&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Content-Security-Policy&lt;/span&gt;&lt;/tt&gt; (&lt;span class="caps"&gt;CSP&lt;/span&gt;) is an &lt;span class="caps"&gt;HTTP&lt;/span&gt; header returned by servers that
gives the client some information on where resources can be loaded. For
example setting &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;script-src&lt;/span&gt; 'self'&lt;/tt&gt; in the &lt;span class="caps"&gt;CSP&lt;/span&gt; tells the client that it should
only load script resources from the current origin. &lt;tt class="docutils literal"&gt;'self'&lt;/tt&gt; for this blog post
would mean &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;https://kura.gg&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;To make loading those resources more secure you can use hashes or nonces within
the &lt;span class="caps"&gt;CSP&lt;/span&gt; that the client can verify. Below I will show how I inject &lt;span class="caps"&gt;CSP&lt;/span&gt; nonces
using Cloudflare Workers in to responses from my origin.&lt;/p&gt;
&lt;div class="section" id="security-considerations"&gt;
&lt;h2&gt;Security considerations&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Think of this as an academic exercise rather than something you should do.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This article will only explain how I inject the nonces in to responses from the
origin. This isn’t really secure given the method I use to do this is pretty dumb
— it just adds a generated nonce to &lt;tt class="docutils literal"&gt;&amp;lt;script&amp;gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;&amp;lt;link &lt;span class="pre"&gt;rel …&lt;/span&gt;&lt;/tt&gt;&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;img alt="Mew, the Pokémon" class="align-center" src="/images/151_mew.png"/&gt;

&lt;p&gt;&lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;Content-Security-Policy&lt;/span&gt;&lt;/tt&gt; (&lt;span class="caps"&gt;CSP&lt;/span&gt;) is an &lt;span class="caps"&gt;HTTP&lt;/span&gt; header returned by servers that
gives the client some information on where resources can be loaded. For
example setting &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;script-src&lt;/span&gt; 'self'&lt;/tt&gt; in the &lt;span class="caps"&gt;CSP&lt;/span&gt; tells the client that it should
only load script resources from the current origin. &lt;tt class="docutils literal"&gt;'self'&lt;/tt&gt; for this blog post
would mean &lt;tt class="docutils literal"&gt;&lt;span class="pre"&gt;https://kura.gg&lt;/span&gt;&lt;/tt&gt;.&lt;/p&gt;
&lt;p&gt;To make loading those resources more secure you can use hashes or nonces within
the &lt;span class="caps"&gt;CSP&lt;/span&gt; that the client can verify. Below I will show how I inject &lt;span class="caps"&gt;CSP&lt;/span&gt; nonces
using Cloudflare Workers in to responses from my origin.&lt;/p&gt;
&lt;div class="section" id="security-considerations"&gt;
&lt;h2&gt;Security considerations&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;Think of this as an academic exercise rather than something you should do.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This article will only explain how I inject the nonces in to responses from the
origin. This isn’t really secure given the method I use to do this is pretty dumb
— it just adds a generated nonce to &lt;tt class="docutils literal"&gt;&amp;lt;script&amp;gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;&amp;lt;link &lt;span class="pre"&gt;rel="stylesheet&amp;gt;"&lt;/span&gt;&lt;/tt&gt;
&lt;span class="caps"&gt;HTML&lt;/span&gt; tags, so an attacker could just modify the origin and add a resource to the
&lt;span class="caps"&gt;HTML&lt;/span&gt; and this worker configuration would blindly add a nonce to it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="how-it-works"&gt;
&lt;h2&gt;How it works&lt;/h2&gt;
&lt;p&gt;When a new request comes in, the worker will generate a nonce. The content
is then requested from the origin and the worker modifies the origin response;
injecting the nonce in to &lt;tt class="docutils literal"&gt;&amp;lt;script&amp;gt;&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;&amp;lt;link &lt;span class="pre"&gt;rel="stylesheet&amp;gt;"&lt;/span&gt;&lt;/tt&gt; &lt;span class="caps"&gt;HTML&lt;/span&gt; tags
and addingbash&lt;/p&gt;
&lt;pre class="code html literal-block"&gt;
❯ curl -v https://kura.gg/eevee | grep nonce
&lt;span class="p"&gt;&amp;lt;&lt;/span&gt; &lt;span class="nt"&gt;content-security-policy:&lt;/span&gt; &lt;span class="na"&gt;default-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;self&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt;
  &lt;span class="na"&gt;script-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;self&lt;/span&gt;&lt;span class="err"&gt;'&lt;/span&gt; &lt;span class="na"&gt;gist&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;github&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;nonce-MTQ1MjM5MDU0MCwzODc3MjkwMzY0&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt;
  &lt;span class="na"&gt;style-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;self&lt;/span&gt;&lt;span class="err"&gt;'&lt;/span&gt; &lt;span class="na"&gt;assets-cdn&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;github&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;nonce-MTQ1MjM5MDU0MCwzODc3MjkwMzY0&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt;
  &lt;span class="na"&gt;img-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;self&lt;/span&gt;&lt;span class="err"&gt;'&lt;/span&gt; &lt;span class="na"&gt;img&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;shields&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;io&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt;
  &lt;span class="na"&gt;font-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;self&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt; &lt;span class="na"&gt;connect-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;none&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt; &lt;span class="na"&gt;media-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;self&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt;
  &lt;span class="na"&gt;object-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;self&lt;/span&gt;&lt;span class="err"&gt;'&lt;/span&gt; &lt;span class="na"&gt;player&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;vimeo&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt; &lt;span class="na"&gt;child-src&lt;/span&gt; &lt;span class="na"&gt;www&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;youtube&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt; &lt;span class="na"&gt;player&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;vimeo&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;com&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt;
  &lt;span class="na"&gt;frame-ancestors&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;none&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt; &lt;span class="na"&gt;form-action&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;none&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt;
  &lt;span class="na"&gt;upgrade-insecure-requests&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt; &lt;span class="na"&gt;base-uri&lt;/span&gt; &lt;span class="na"&gt;https:&lt;/span&gt;&lt;span class="err"&gt;//&lt;/span&gt;&lt;span class="na"&gt;kura&lt;/span&gt;&lt;span class="err"&gt;.&lt;/span&gt;&lt;span class="na"&gt;gg&lt;/span&gt;&lt;span class="err"&gt;;&lt;/span&gt; &lt;span class="na"&gt;manifest-src&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;none&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt;
  &lt;span class="na"&gt;require-trusted-types-for&lt;/span&gt; &lt;span class="err"&gt;'&lt;/span&gt;&lt;span class="na"&gt;script&lt;/span&gt;&lt;span class="err"&gt;';&lt;/span&gt;
&lt;span class="err"&gt;&amp;lt;&lt;/span&gt;&lt;span class="na"&gt;link&lt;/span&gt; &lt;span class="na"&gt;rel&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;stylesheet&lt;/span&gt; &lt;span class="na"&gt;href&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;https://kura.gg/theme/css/eevee.min.css?e96887dc&lt;/span&gt; &lt;span class="na"&gt;nonce&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"MTQ1MjM5MDU0MCwzODc3MjkwMzY0"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;script&lt;/span&gt; &lt;span class="na"&gt;async&lt;/span&gt; &lt;span class="na"&gt;src&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;https://kura.gg/theme/js/eevee.min.js?1841d254&lt;/span&gt; &lt;span class="na"&gt;nonce&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"MTQ1MjM5MDU0MCwzODc3MjkwMzY0"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;script&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="the-code"&gt;
&lt;h2&gt;The code&lt;/h2&gt;
&lt;p&gt;This is the full set of worker could to add nonces to responses, there are a few
comments within the code that give an idea of what each part does.&lt;/p&gt;
&lt;pre class="code javascript literal-block"&gt;
&lt;span class="kd"&gt;class&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;AttributeRewriter&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="kr"&gt;constructor&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;tag_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;tag_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;tag_name&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

  &lt;/span&gt;&lt;span class="c1"&gt;// There is definitely a cleaner way to do this but JS isn't my&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="c1"&gt;// strong suit and I didn't want the nonce applied to every &amp;lt;link&amp;gt;&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="c1"&gt;// tag.&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;tag_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"link"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
      &lt;/span&gt;&lt;span class="kd"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;attribute&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getAttribute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"rel"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
      &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;attribute&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;attribute&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;==&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"stylesheet"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;setAttribute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"nonce"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
      &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
      &lt;/span&gt;&lt;span class="nx"&gt;element&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;setAttribute&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"nonce"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;this&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;handle_req&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;req&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="c1"&gt;// Generate the nonce and create a CSP to be added to headers&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="c1"&gt;// later.&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="kd"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;btoa&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;crypto&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;getRandomValues&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ow"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;Uint32Array&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mf"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)))&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="c1"&gt;// This policy only allows using scripts, styles, images and fonts&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="c1"&gt;// resources from the current origin.&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="kd"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;content_security_policy&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"default-src 'self';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"script-src 'self' 'nonce-"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;";"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"style-src 'self' 'nonce-"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;+&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;";"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"img-src 'self';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"font-src 'self';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"connect-src 'none';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"media-src 'none';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"object-src 'none';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"child-src 'none';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"frame-ancestors 'none';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"form-action 'none';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"upgrade-insecure-requests;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"manifest-src 'none';"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"require-trusted-types-for 'script';"&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p"&gt;].&lt;/span&gt;&lt;span class="nx"&gt;join&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;" "&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;

  &lt;/span&gt;&lt;span class="c1"&gt;// Make the request upstream and create a mutable copy of the&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="c1"&gt;// response headers.&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="kd"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;res&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;await&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;req&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;res_headers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ow"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;Headers&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;res&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;

  &lt;/span&gt;&lt;span class="c1"&gt;// Set up the rewriter, passing the nonce to it for adding to&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="c1"&gt;// the configured elements.&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="kd"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;rewriter&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ow"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;HTMLRewriter&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"script"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ow"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;AttributeRewriter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"script"&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;on&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"link"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ow"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;AttributeRewriter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;nonce&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"link"&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="w"&gt;

  &lt;/span&gt;&lt;span class="c1"&gt;// Only run the rewriter on HTML content.&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="kd"&gt;const&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;content_type&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;res&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Content-Type"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;new_res&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;res&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;content_type&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;startsWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"text/html"&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="nx"&gt;new_res&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;rewriter&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;transform&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;res&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

  &lt;/span&gt;&lt;span class="c1"&gt;// Set the CSP header.&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nx"&gt;res_headers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Content-Security-Policy"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;content_security_policy&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;

  &lt;/span&gt;&lt;span class="c1"&gt;// Return the (possibly modified) body and modified headers.&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ow"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;new_res&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;body&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="nx"&gt;status&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;res&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;status&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="nx"&gt;statusText&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;res&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;statusText&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="nx"&gt;headers&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;res_headers&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="nx"&gt;addEventListener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'fetch'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
  &lt;/span&gt;&lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;respondWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;handle_req&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="cloudflare http content-security-policy csp"></category></entry><entry><title>Playing with Cloudflare Workers: Adding a random Pokémon to response headers</title><link href="https://kura.gg/2021/10/15/playing-with-cloudflare-workers-adding-random-pokemon-header/" rel="alternate"></link><published>2021-10-15T20:50:00+01:00</published><updated>2021-10-15T20:50:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2021-10-15:/2021/10/15/playing-with-cloudflare-workers-adding-random-pokemon-header/</id><summary type="html">&lt;img alt="Eevee, the Pokémon" class="align-center" src="/images/133_eevee.png"/&gt;

&lt;p&gt;I was a little bored tonight and had a thought; “can I find a way to add a random
Pokédex and it’s National Pokédex number as a header to requests on my website?”&lt;/p&gt;
&lt;p&gt;The answer is - quite simply - “yes”.&lt;/p&gt;
&lt;div class="section" id="cloudflare-workers"&gt;
&lt;h2&gt;Cloudflare Workers&lt;/h2&gt;
&lt;p&gt;This website runs on Cloudflare’s content delivery network and as such I have
access to &lt;a class="reference external" href="https://workers.cloudflare.com/"&gt;Cloudflare Workers&lt;/a&gt;, allowing me to
run arbitrary code at the edge for incoming requests.&lt;/p&gt;
&lt;p&gt;Setting up a worker that picks a random Pokemon and injects it as a header
is very simple, add a worker, write the code and add some routing to it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="try-it-yourself"&gt;
&lt;h2&gt;Try it yourself&lt;/h2&gt;
&lt;pre class="code bash literal-block"&gt;
curl&lt;span class="w"&gt; &lt;/span&gt;-sI&lt;span class="w"&gt; &lt;/span&gt;https://kura.gg/&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"x-pokemon"&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;x-pokemon:&lt;span class="w"&gt; &lt;/span&gt;Eevee&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="c1"&gt;#133)&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="the-code"&gt;
&lt;h2&gt;The code&lt;/h2&gt;
&lt;pre class="code javascript literal-block"&gt;
&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;pokemon&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Bulbasaur (#1)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ivysaur (#2)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Venusaur (#3)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Charmander (#4)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Charmeleon (#5)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Charizard (#6)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Squirtle (#7)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wartortle (#8)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Blastoise (#9)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Caterpie (#10)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Metapod (#11)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Butterfree (#12)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Weedle (#13)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kakuna (#14)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Beedrill (#15)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Pidgey …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;img alt="Eevee, the Pokémon" class="align-center" src="/images/133_eevee.png"/&gt;

&lt;p&gt;I was a little bored tonight and had a thought; “can I find a way to add a random
Pokédex and it’s National Pokédex number as a header to requests on my website?”&lt;/p&gt;
&lt;p&gt;The answer is - quite simply - “yes”.&lt;/p&gt;
&lt;div class="section" id="cloudflare-workers"&gt;
&lt;h2&gt;Cloudflare Workers&lt;/h2&gt;
&lt;p&gt;This website runs on Cloudflare’s content delivery network and as such I have
access to &lt;a class="reference external" href="https://workers.cloudflare.com/"&gt;Cloudflare Workers&lt;/a&gt;, allowing me to
run arbitrary code at the edge for incoming requests.&lt;/p&gt;
&lt;p&gt;Setting up a worker that picks a random Pokemon and injects it as a header
is very simple, add a worker, write the code and add some routing to it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="try-it-yourself"&gt;
&lt;h2&gt;Try it yourself&lt;/h2&gt;
&lt;pre class="code bash literal-block"&gt;
curl&lt;span class="w"&gt; &lt;/span&gt;-sI&lt;span class="w"&gt; &lt;/span&gt;https://kura.gg/&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"x-pokemon"&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;x-pokemon:&lt;span class="w"&gt; &lt;/span&gt;Eevee&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;&lt;span class="c1"&gt;#133)&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="the-code"&gt;
&lt;h2&gt;The code&lt;/h2&gt;
&lt;pre class="code javascript literal-block"&gt;
&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;pokemon&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Bulbasaur (#1)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ivysaur (#2)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Venusaur (#3)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Charmander (#4)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Charmeleon (#5)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Charizard (#6)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Squirtle (#7)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wartortle (#8)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Blastoise (#9)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Caterpie (#10)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Metapod (#11)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Butterfree (#12)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Weedle (#13)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kakuna (#14)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Beedrill (#15)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Pidgey (#16)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pidgeotto (#17)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pidgeot (#18)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rattata (#19)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Raticate (#20)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Spearow (#21)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Fearow (#22)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ekans (#23)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Arbok (#24)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pikachu (#25)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Raichu (#26)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sandshrew (#27)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sandslash (#28)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nidoran♀ (#29)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nidorina (#30)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Nidoqueen (#31)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nidoran♂ (#32)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nidorino (#33)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nidoking (#34)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Clefairy (#35)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Clefable (#36)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vulpix (#37)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ninetales (#38)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Jigglypuff (#39)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wigglytuff (#40)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Zubat (#41)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Golbat (#42)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Oddish (#43)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gloom (#44)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vileplume (#45)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Paras (#46)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Parasect (#47)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Venonat (#48)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Venomoth (#49)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Diglett (#50)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Dugtrio (#51)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Meowth (#52)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Persian (#53)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Psyduck (#54)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Golduck (#55)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Mankey (#56)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Primeape (#57)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Growlithe (#58)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Arcanine (#59)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Poliwag (#60)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Poliwhirl (#61)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Poliwrath (#62)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Abra (#63)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kadabra (#64)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Alakazam (#65)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Machop (#66)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Machoke (#67)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Machamp (#68)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bellsprout (#69)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Weepinbell (#70)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Victreebel (#71)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tentacool (#72)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tentacruel (#73)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Geodude (#74)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Graveler (#75)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Golem (#76)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ponyta (#77)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rapidash (#78)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Slowpoke (#79)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Slowbro (#80)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Magnemite (#81)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Magneton (#82)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Farfetch'd (#83)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Doduo (#84)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dodrio (#85)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Seel (#86)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dewgong (#87)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Grimer (#88)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Muk (#89)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shellder (#90)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Cloyster (#91)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gastly (#92)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Haunter (#93)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gengar (#94)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Onix (#95)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Drowzee (#96)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hypno (#97)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Krabby (#98)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kingler (#99)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Voltorb (#100)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Electrode (#101)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Exeggcute (#102)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Exeggutor (#103)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cubone (#104)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Marowak (#105)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Hitmonlee (#106)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hitmonchan (#107)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lickitung (#108)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Koffing (#109)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Weezing (#110)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Rhyhorn (#111)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rhydon (#112)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chansey (#113)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tangela (#114)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kangaskhan (#115)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Horsea (#116)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Seadra (#117)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Goldeen (#118)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Seaking (#119)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Staryu (#120)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Starmie (#121)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mr. Mime (#122)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Scyther (#123)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Jynx (#124)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Electabuzz (#125)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Magmar (#126)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pinsir (#127)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tauros (#128)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Magikarp (#129)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gyarados (#130)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Lapras (#131)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ditto (#132)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Eevee (#133)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vaporeon (#134)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Jolteon (#135)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Flareon (#136)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Porygon (#137)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Omanyte (#138)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Omastar (#139)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kabuto (#140)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Kabutops (#141)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Aerodactyl (#142)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Snorlax (#143)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Articuno (#144)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zapdos (#145)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Moltres (#146)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dratini (#147)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dragonair (#148)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dragonite (#149)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mewtwo (#150)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Mew (#151)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chikorita (#152)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bayleef (#153)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Meganium (#154)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cyndaquil (#155)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Quilava (#156)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Typhlosion (#157)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Totodile (#158)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Croconaw (#159)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Feraligatr (#160)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Sentret (#161)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Furret (#162)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hoothoot (#163)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Noctowl (#164)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ledyba (#165)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Ledian (#166)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Spinarak (#167)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ariados (#168)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Crobat (#169)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chinchou (#170)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Lanturn (#171)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pichu (#172)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cleffa (#173)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Igglybuff (#174)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Togepi (#175)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Togetic (#176)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Natu (#177)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Xatu (#178)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mareep (#179)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Flaaffy (#180)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Ampharos (#181)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bellossom (#182)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Marill (#183)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Azumarill (#184)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sudowoodo (#185)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Politoed (#186)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hoppip (#187)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Skiploom (#188)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Jumpluff (#189)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Aipom (#190)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Sunkern (#191)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sunflora (#192)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Yanma (#193)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wooper (#194)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Quagsire (#195)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Espeon (#196)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Umbreon (#197)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Murkrow (#198)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Slowking (#199)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Misdreavus (#200)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Unown (#201)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wobbuffet (#202)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Girafarig (#203)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pineco (#204)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Forretress (#205)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Dunsparce (#206)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gligar (#207)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Steelix (#208)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Snubbull (#209)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Granbull (#210)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Qwilfish (#211)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Scizor (#212)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shuckle (#213)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Heracross (#214)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sneasel (#215)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Teddiursa (#216)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ursaring (#217)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Slugma (#218)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Magcargo (#219)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Swinub (#220)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Piloswine (#221)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Corsola (#222)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Remoraid (#223)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Octillery (#224)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Delibird (#225)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Mantine (#226)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Skarmory (#227)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Houndour (#228)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Houndoom (#229)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kingdra (#230)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Phanpy (#231)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Donphan (#232)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Porygon2 (#233)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Stantler (#234)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Smeargle (#235)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Tyrogue (#236)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hitmontop (#237)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Smoochum (#238)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Elekid (#239)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Magby (#240)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Miltank (#241)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Blissey (#242)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Raikou (#243)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Entei (#244)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Suicune (#245)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Larvitar (#246)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pupitar (#247)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tyranitar (#248)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lugia (#249)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ho-Oh (#250)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Celebi (#251)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Treecko (#252)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Grovyle (#253)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sceptile (#254)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Torchic (#255)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Combusken (#256)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Blaziken (#257)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mudkip (#258)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Marshtomp (#259)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Swampert (#260)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Poochyena (#261)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mightyena (#262)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zigzagoon (#263)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Linoone (#264)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wurmple (#265)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Silcoon (#266)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Beautifly (#267)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cascoon (#268)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dustox (#269)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lotad (#270)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Lombre (#271)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ludicolo (#272)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Seedot (#273)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nuzleaf (#274)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shiftry (#275)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Taillow (#276)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Swellow (#277)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wingull (#278)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pelipper (#279)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ralts (#280)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Kirlia (#281)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gardevoir (#282)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Surskit (#283)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Masquerain (#284)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shroomish (#285)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Breloom (#286)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Slakoth (#287)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vigoroth (#288)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Slaking (#289)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nincada (#290)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Ninjask (#291)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shedinja (#292)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Whismur (#293)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Loudred (#294)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Exploud (#295)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Makuhita (#296)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hariyama (#297)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Azurill (#298)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nosepass (#299)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Skitty (#300)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Delcatty (#301)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sableye (#302)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mawile (#303)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Aron (#304)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lairon (#305)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Aggron (#306)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Meditite (#307)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Medicham (#308)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Electrike (#309)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Manectric (#310)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Plusle (#311)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Minun (#312)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Volbeat (#313)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Illumise (#314)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Roselia (#315)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Gulpin (#316)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Swalot (#317)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Carvanha (#318)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sharpedo (#319)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wailmer (#320)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Wailord (#321)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Numel (#322)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Camerupt (#323)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Torkoal (#324)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Spoink (#325)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Grumpig (#326)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Spinda (#327)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Trapinch (#328)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vibrava (#329)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Flygon (#330)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Cacnea (#331)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cacturne (#332)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Swablu (#333)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Altaria (#334)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zangoose (#335)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Seviper (#336)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lunatone (#337)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Solrock (#338)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Barboach (#339)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Whiscash (#340)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Corphish (#341)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Crawdaunt (#342)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Baltoy (#343)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Claydol (#344)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lileep (#345)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Cradily (#346)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Anorith (#347)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Armaldo (#348)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Feebas (#349)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Milotic (#350)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Castform (#351)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kecleon (#352)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shuppet (#353)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Banette (#354)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Duskull (#355)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Dusclops (#356)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tropius (#357)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chimecho (#358)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Absol (#359)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wynaut (#360)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Snorunt (#361)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Glalie (#362)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Spheal (#363)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sealeo (#364)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Walrein (#365)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Clamperl (#366)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Huntail (#367)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gorebyss (#368)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Relicanth (#369)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Luvdisc (#370)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Bagon (#371)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shelgon (#372)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Salamence (#373)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Beldum (#374)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Metang (#375)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Metagross (#376)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Regirock (#377)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Regice (#378)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Registeel (#379)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Latias (#380)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Latios (#381)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kyogre (#382)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Groudon (#383)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rayquaza (#384)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Jirachi (#385)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Deoxys (#386)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Turtwig (#387)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Grotle (#388)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Torterra (#389)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chimchar (#390)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Monferno (#391)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Infernape (#392)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Piplup (#393)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Prinplup (#394)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Empoleon (#395)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Starly (#396)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Staravia (#397)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Staraptor (#398)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bidoof (#399)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bibarel (#400)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Kricketot (#401)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kricketune (#402)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shinx (#403)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Luxio (#404)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Luxray (#405)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Budew (#406)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Roserade (#407)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cranidos (#408)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rampardos (#409)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shieldon (#410)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Bastiodon (#411)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Burmy (#412)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wormadam (#413)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mothim (#414)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Combee (#415)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Vespiquen (#416)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pachirisu (#417)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Buizel (#418)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Floatzel (#419)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cherubi (#420)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Cherrim (#421)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shellos (#422)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gastrodon (#423)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ambipom (#424)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Drifloon (#425)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Drifblim (#426)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Buneary (#427)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lopunny (#428)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mismagius (#429)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Honchkrow (#430)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Glameow (#431)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Purugly (#432)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chingling (#433)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Stunky (#434)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Skuntank (#435)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Bronzor (#436)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bronzong (#437)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bonsly (#438)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mime Jr. (#439)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Happiny (#440)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Chatot (#441)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Spiritomb (#442)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gible (#443)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gabite (#444)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Garchomp (#445)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Munchlax (#446)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Riolu (#447)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lucario (#448)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hippopotas (#449)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hippowdon (#450)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Skorupi (#451)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Drapion (#452)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Croagunk (#453)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Toxicroak (#454)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Carnivine (#455)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Finneon (#456)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lumineon (#457)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mantyke (#458)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Snover (#459)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Abomasnow (#460)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Weavile (#461)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Magnezone (#462)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lickilicky (#463)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rhyperior (#464)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tangrowth (#465)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Electivire (#466)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Magmortar (#467)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Togekiss (#468)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Yanmega (#469)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Leafeon (#470)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Glaceon (#471)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gliscor (#472)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mamoswine (#473)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Porygon-Z (#474)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gallade (#475)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Probopass (#476)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dusknoir (#477)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Froslass (#478)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rotom (#479)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Uxie (#480)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Mesprit (#481)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Azelf (#482)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dialga (#483)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Palkia (#484)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Heatran (#485)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Regigigas (#486)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Giratina (#487)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cresselia (#488)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Phione (#489)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Manaphy (#490)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Darkrai (#491)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shaymin (#492)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Arceus (#493)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Victini (#494)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Snivy (#495)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Servine (#496)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Serperior (#497)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tepig (#498)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pignite (#499)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Emboar (#500)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Oshawott (#501)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dewott (#502)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Samurott (#503)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Patrat (#504)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Watchog (#505)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Lillipup (#506)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Herdier (#507)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Stoutland (#508)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Purrloin (#509)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Liepard (#510)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Pansage (#511)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Simisage (#512)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pansear (#513)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Simisear (#514)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Panpour (#515)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Simipour (#516)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Munna (#517)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Musharna (#518)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pidove (#519)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tranquill (#520)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Unfezant (#521)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Blitzle (#522)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zebstrika (#523)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Roggenrola (#524)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Boldore (#525)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Gigalith (#526)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Woobat (#527)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Swoobat (#528)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Drilbur (#529)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Excadrill (#530)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Audino (#531)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Timburr (#532)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gurdurr (#533)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Conkeldurr (#534)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tympole (#535)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Palpitoad (#536)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Seismitoad (#537)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Throh (#538)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sawk (#539)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sewaddle (#540)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Swadloon (#541)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Leavanny (#542)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Venipede (#543)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Whirlipede (#544)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Scolipede (#545)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Cottonee (#546)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Whimsicott (#547)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Petilil (#548)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lilligant (#549)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Basculin (#550)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Sandile (#551)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Krokorok (#552)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Krookodile (#553)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Darumaka (#554)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Darmanitan (#555)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Maractus (#556)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dwebble (#557)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Crustle (#558)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Scraggy (#559)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Scrafty (#560)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Sigilyph (#561)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Yamask (#562)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cofagrigus (#563)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tirtouga (#564)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Carracosta (#565)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Archen (#566)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Archeops (#567)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Trubbish (#568)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Garbodor (#569)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zorua (#570)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Zoroark (#571)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Minccino (#572)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cinccino (#573)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gothita (#574)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gothorita (#575)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Gothitelle (#576)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Solosis (#577)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Duosion (#578)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Reuniclus (#579)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ducklett (#580)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Swanna (#581)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vanillite (#582)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vanillish (#583)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vanilluxe (#584)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Deerling (#585)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Sawsbuck (#586)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Emolga (#587)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Karrablast (#588)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Escavalier (#589)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Foongus (#590)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Amoonguss (#591)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Frillish (#592)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Jellicent (#593)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Alomomola (#594)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Joltik (#595)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Galvantula (#596)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ferroseed (#597)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Ferrothorn (#598)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Klink (#599)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Klang (#600)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Klinklang (#601)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tynamo (#602)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Eelektrik (#603)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Eelektross (#604)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Elgyem (#605)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Beheeyem (#606)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Litwick (#607)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lampent (#608)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chandelure (#609)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Axew (#610)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Fraxure (#611)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Haxorus (#612)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cubchoo (#613)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Beartic (#614)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cryogonal (#615)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Shelmet (#616)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Accelgor (#617)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Stunfisk (#618)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mienfoo (#619)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mienshao (#620)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Druddigon (#621)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Golett (#622)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Golurk (#623)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pawniard (#624)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bisharp (#625)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Bouffalant (#626)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rufflet (#627)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Braviary (#628)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Vullaby (#629)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mandibuzz (#630)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Heatmor (#631)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Durant (#632)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Deino (#633)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zweilous (#634)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hydreigon (#635)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Larvesta (#636)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Volcarona (#637)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cobalion (#638)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Terrakion (#639)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Virizion (#640)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Tornadus (#641)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Thundurus (#642)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Reshiram (#643)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zekrom (#644)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Landorus (#645)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Kyurem (#646)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Keldeo (#647)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Meloetta (#648)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Genesect (#649)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chespin (#650)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Quilladin (#651)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Chesnaught (#652)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Fennekin (#653)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Braixen (#654)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Delphox (#655)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Froakie (#656)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Frogadier (#657)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Greninja (#658)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bunnelby (#659)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Diggersby (#660)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Fletchling (#661)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Fletchinder (#662)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Talonflame (#663)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Scatterbug (#664)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Spewpa (#665)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Vivillon (#666)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Litleo (#667)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pyroar (#668)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Flabebe (#669)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Floette (#670)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Florges (#671)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Skiddo (#672)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gogoat (#673)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pancham (#674)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pangoro (#675)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Furfrou (#676)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Espurr (#677)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Meowstic (#678)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Honedge (#679)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Doublade (#680)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Aegislash (#681)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Spritzee (#682)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Aromatisse (#683)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Swirlix (#684)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Slurpuff (#685)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Inkay (#686)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Malamar (#687)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Binacle (#688)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Barbaracle (#689)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Skrelp (#690)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Dragalge (#691)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Helioptile (#694)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Heliolisk (#695)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tyrunt (#696)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tyrantrum (#697)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Amaura (#698)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Aurorus (#699)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sylveon (#700)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hawlucha (#701)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dedenne (#702)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Carbink (#703)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Goomy (#704)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sliggoo (#705)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Goodra (#706)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Klefki (#707)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Phantump (#708)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Trevenant (#709)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pumpkaboo (#710)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gourgeist (#711)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bergmite (#712)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Avalugg (#713)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Noibat (#714)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Noivern (#715)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Xerneas (#716)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Yveltal (#717)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Zygarde (#718)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Diancie (#719)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hoopa (#720)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Volcanion (#721)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rowlet (#722)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Dartrix (#723)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Decidueye (#724)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Litten (#725)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Torracat (#726)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Incineroar (#727)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Popplio (#728)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Brionne (#729)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Primarina (#730)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pikipek (#731)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Trumbeak (#732)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Toucannon (#733)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Yungoos (#734)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gumshoos (#735)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Grubbin (#736)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Charjabug (#737)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Vikavolt (#738)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Crabrawler (#739)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Crabominable (#740)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Oricorio (#741)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cutiefly (#742)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Ribombee (#743)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rockruff (#744)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lycanroc (#745)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wishiwashi (#746)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mareanie (#747)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Toxapex (#748)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mudbray (#749)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mudsdale (#750)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dewpider (#751)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Araquanid (#752)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Fomantis (#753)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lurantis (#754)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Morelull (#755)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Shiinotic (#756)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Salandit (#757)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Salazzle (#758)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Stufful (#759)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bewear (#760)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bounsweet (#761)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Steenee (#762)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Tsareena (#763)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Comfey (#764)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Oranguru (#765)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Passimian (#766)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wimpod (#767)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Golisopod (#768)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sandygast (#769)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Palossand (#770)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pyukumuku (#771)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Type: Null (#772)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Silvally (#773)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Minior (#774)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Komala (#775)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Turtonator (#776)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Togedemaru (#777)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Mimikyu (#778)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Bruxish (#779)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Drampa (#780)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dhelmise (#781)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Jangmo-o (#782)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Hakamo-o (#783)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kommo-o (#784)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tapu Koko (#785)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tapu Lele (#786)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Tapu Bulu (#787)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Tapu Fini (#788)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cosmog (#789)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cosmoem (#790)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Solgaleo (#791)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Lunala (#792)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Nihilego (#793)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Buzzwole (#794)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pheromosa (#795)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Xurkitree (#796)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Celesteela (#797)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Kartana (#798)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Guzzlord (#799)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Necrozma (#800)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Magearna (#801)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Marshadow (#802)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Poipole (#803)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Naganadel (#804)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Stakataka (#805)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Blacephalon (#806)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zeraora (#807)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Meltan (#808)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Melmetal (#809)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Grookey (#810)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Thwackey (#811)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rillaboom (#812)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Scorbunny (#813)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Raboot (#814)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cinderace (#815)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sobble (#816)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Drizzile (#817)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Inteleon (#818)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Skwovet (#819)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Greedent (#820)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rookidee (#821)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Convisquire (#822)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Conviknight (#823)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Blipbug (#824)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dottler (#825)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Orbeetle (#826)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Nickit (#827)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Thievul (#828)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Gossifleur (#829)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Eldegoss (#830)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Wooloo (#831)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dubwool (#832)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Chewtle (#833)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Drednaw (#834)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Yamper (#835)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Boltund (#836)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Rolycoly (#837)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Carkol (#838)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Coalossal (#839)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Applin (#840)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Flapple (#841)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Appletun (#842)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Silicobra (#843)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sandaconda (#844)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cramorant (#845)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Arrokuda (#846)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Barraskewda (#847)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Toxel (#848)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Toxtricity (#849)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sizzlipede (#850)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Centiskorch (#851)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Clobbopus (#852)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Grapploct (#853)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sinistea (#854)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Polteageist (#855)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hatenna (#856)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hattrem (#857)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Hatterene (#858)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Impidimp (#859)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Morgrem (#860)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Grimmsnarl (#861)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Obstagoon (#862)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Perrserker (#863)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Cursola (#864)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Sirfetch'd (#865)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Mr. Rime (#866)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Runerigus (#867)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Milcery (#868)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Alcremie (#869)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Falinks (#870)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Pincurchin (#871)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Snom (#872)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Frosmoth (#873)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Stonjourner (#874)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Eiscue (#875)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Indeedee (#876)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Morpeko (#877)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Cufant (#878)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Copperajah (#879)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dracozolt (#880)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Arctozolt (#881)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dracovish (#882)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Arctovish (#883)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Duraludon (#884)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dreepy (#885)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Drakloak (#886)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Dragapult (#887)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Zacian (#888)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Zamazanta (#889)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Eternatus (#890)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Kubfu (#891)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Urshifu (#892)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Zarude (#893)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Regieleki (#894)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Regidrago (#895)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Glastrier (#896)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Spectrier (#897)"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="s2"&gt;"Calyrex (#898)"&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kd"&gt;function&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;handle_request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;response&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;await&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;fetch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="kd"&gt;let&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;new_headers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ow"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;Headers&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;headers&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="nx"&gt;new_headers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;set&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"X-Pokemon"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="nx"&gt;pokemon&lt;/span&gt;&lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="nb"&gt;Math&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;random&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;pokemon&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;length&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mf"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)])&lt;/span&gt;&lt;span class="w"&gt;

    &lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="ow"&gt;new&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;Response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;body&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="nx"&gt;status&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;status&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="nx"&gt;statusText&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;response&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;statusText&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="nx"&gt;headers&lt;/span&gt;&lt;span class="o"&gt;:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;new_headers&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="nx"&gt;addEventListener&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'fetch'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&amp;gt;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;respondWith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;handle_request&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nx"&gt;event&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="nx"&gt;request&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;})&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="pokemon cloudflare http"></category></entry><entry><title>Google Workspace Gmail MX records signed with DNSSEC</title><link href="https://kura.gg/2021/10/14/google-workspace-gmail-mx-dnssec-signed/" rel="alternate"></link><published>2021-10-14T16:50:00+01:00</published><updated>2021-10-14T16:50:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2021-10-14:/2021/10/14/google-workspace-gmail-mx-dnssec-signed/</id><summary type="html">&lt;p&gt;Gmail provided by the paid Google Workspace service (formerly
known as G Suite and Google Apps) has unofficial &lt;span class="caps"&gt;DNSSEC&lt;/span&gt;-signed
&lt;span class="caps"&gt;MX&lt;/span&gt; records available for use. The officially supported ones
that you’re told to configure do not offer &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; signing.&lt;/p&gt;
&lt;p&gt;These &lt;span class="caps"&gt;MX&lt;/span&gt; records have both IPv4 and IPv6 addresses, although
the records are not officially supported or documented and
may be unreliable or removed at any point. (I’ve been using them
for a while now and they seem perfectly fine to me but use at
your own risk.)&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
mx1.smtp.goog
mx2.smtp.goog
mx3.smtp.goog
mx4.smtp.goog
&lt;/pre&gt;
&lt;p&gt;The table below has the &lt;span class="caps"&gt;MX&lt;/span&gt; record and the A and &lt;span class="caps"&gt;AAAA&lt;/span&gt; record values.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
mx1.smtp.goog
    216.239.32.151
    2001:4860:4802:32::97

mx2.smtp.goog
    216.239.34.151
    2001:4860:4802:34::97

mx3.smtp.goog
    216.239.36.151
    2001:4860:4802:36 …&lt;/pre&gt;</summary><content type="html">&lt;p&gt;Gmail provided by the paid Google Workspace service (formerly
known as G Suite and Google Apps) has unofficial &lt;span class="caps"&gt;DNSSEC&lt;/span&gt;-signed
&lt;span class="caps"&gt;MX&lt;/span&gt; records available for use. The officially supported ones
that you’re told to configure do not offer &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; signing.&lt;/p&gt;
&lt;p&gt;These &lt;span class="caps"&gt;MX&lt;/span&gt; records have both IPv4 and IPv6 addresses, although
the records are not officially supported or documented and
may be unreliable or removed at any point. (I’ve been using them
for a while now and they seem perfectly fine to me but use at
your own risk.)&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
mx1.smtp.goog
mx2.smtp.goog
mx3.smtp.goog
mx4.smtp.goog
&lt;/pre&gt;
&lt;p&gt;The table below has the &lt;span class="caps"&gt;MX&lt;/span&gt; record and the A and &lt;span class="caps"&gt;AAAA&lt;/span&gt; record values.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
mx1.smtp.goog
    216.239.32.151
    2001:4860:4802:32::97

mx2.smtp.goog
    216.239.34.151
    2001:4860:4802:34::97

mx3.smtp.goog
    216.239.36.151
    2001:4860:4802:36::97
    216.239.32.151

mx4.smtp.goog
    216.239.38.151
    2001:4860:4802:38::97
&lt;/pre&gt;
&lt;p&gt;I am using them myself but I am also willing to take the risk of
them possibly vanishing without any warning.&lt;/p&gt;
&lt;pre class="code literal-block"&gt;
kura.gg.    300     IN      MX      10      mx1.smtp.goog.
kura.gg.    300     IN      MX      20      mx2.smtp.goog.
kura.gg.    300     IN      MX      30      mx3.smtp.goog.
kura.gg.    300     IN      MX      40      mx4.smtp.goog.
&lt;/pre&gt;
</content><category term="email"></category><category term="gmail"></category><category term="email"></category><category term="smtp"></category><category term="dnssec"></category></entry><entry><title>Configuring upstreams dynamically with DNS in OpenResty</title><link href="https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/" rel="alternate"></link><published>2020-08-30T17:30:00+01:00</published><updated>2020-08-30T17:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2020-08-30:/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/</id><summary type="html">
&lt;p&gt;This article is a continuation of &lt;a class="reference external" href="https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/"&gt;retrying dynamically configured
upstreams&lt;/a&gt;
that gives an example of how you can configure OpenResty to update your
upstream backend servers dynamically with &lt;span class="caps"&gt;DNS&lt;/span&gt;.&lt;/p&gt;
&lt;div class="section" id="breaking-down-init-worker-by-lua-block"&gt;
&lt;h2&gt;Breaking down &lt;cite&gt;init_worker_by_lua_block&lt;/cite&gt;&lt;/h2&gt;
&lt;p&gt;&lt;cite&gt;init_worker_by_lua_block&lt;/cite&gt; can be used to make an nginx worker do some fun
stuff. In this instance we’re going to use it in conjunction with
&lt;cite&gt;ngx.timer.every&lt;/cite&gt; and the &lt;cite&gt;resty.dns.resolver&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;Here is the full example of my &lt;cite&gt;init_worker_by_lua_block&lt;/cite&gt;.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="n"&gt;init_worker_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{}&lt;/span&gt;

    &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="kr"&gt;function&lt;/span&gt; &lt;span class="nf"&gt;update_dns&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="c1"&gt;-- Set up the resolver&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;resolver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"resty.dns.resolver"&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;resolver&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="n"&gt;nameservers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"1.1.1.1"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"1.0.0.1"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;53&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="p"&gt;},&lt;/span&gt;  &lt;span class="c1"&gt;-- Cloudflare&lt;/span&gt;
            &lt;span class="n"&gt;retrans&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;  &lt;span class="c1"&gt;-- 5 retransmissions on receive timeout&lt;/span&gt;
            &lt;span class="n"&gt;timeout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;  &lt;span class="c1"&gt;-- 1 sec&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"failed to instantiate resolver: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="kr"&gt;return&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;

        &lt;span class="c1"&gt;-- Pull DNS records&lt;/span&gt;
        &lt;span class="c1"&gt;-- Use a hardcoded domain to make this example easier&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tries&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"kura.gg …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This article is a continuation of &lt;a class="reference external" href="https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/"&gt;retrying dynamically configured
upstreams&lt;/a&gt;
that gives an example of how you can configure OpenResty to update your
upstream backend servers dynamically with &lt;span class="caps"&gt;DNS&lt;/span&gt;.&lt;/p&gt;
&lt;div class="section" id="breaking-down-init-worker-by-lua-block"&gt;
&lt;h2&gt;Breaking down &lt;cite&gt;init_worker_by_lua_block&lt;/cite&gt;&lt;/h2&gt;
&lt;p&gt;&lt;cite&gt;init_worker_by_lua_block&lt;/cite&gt; can be used to make an nginx worker do some fun
stuff. In this instance we’re going to use it in conjunction with
&lt;cite&gt;ngx.timer.every&lt;/cite&gt; and the &lt;cite&gt;resty.dns.resolver&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;Here is the full example of my &lt;cite&gt;init_worker_by_lua_block&lt;/cite&gt;.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="n"&gt;init_worker_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{}&lt;/span&gt;

    &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="kr"&gt;function&lt;/span&gt; &lt;span class="nf"&gt;update_dns&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="c1"&gt;-- Set up the resolver&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;resolver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"resty.dns.resolver"&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;resolver&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
            &lt;span class="n"&gt;nameservers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"1.1.1.1"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"1.0.0.1"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;53&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="p"&gt;},&lt;/span&gt;  &lt;span class="c1"&gt;-- Cloudflare&lt;/span&gt;
            &lt;span class="n"&gt;retrans&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;  &lt;span class="c1"&gt;-- 5 retransmissions on receive timeout&lt;/span&gt;
            &lt;span class="n"&gt;timeout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;  &lt;span class="c1"&gt;-- 1 sec&lt;/span&gt;
        &lt;span class="p"&gt;}&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"failed to instantiate resolver: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="kr"&gt;return&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;

        &lt;span class="c1"&gt;-- Pull DNS records&lt;/span&gt;
        &lt;span class="c1"&gt;-- Use a hardcoded domain to make this example easier&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tries&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"kura.gg"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{})&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"failed to query resolved: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="kr"&gt;return&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errcode&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"server returned error code: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errcode&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                    &lt;span class="s2"&gt;": "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errstr&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="c1"&gt;-- Have a return here so that the old servers remain even if&lt;/span&gt;
            &lt;span class="c1"&gt;-- this lookup fails.&lt;/span&gt;
            &lt;span class="kr"&gt;return&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;

        &lt;span class="c1"&gt;-- Dump records in a global variable&lt;/span&gt;
        &lt;span class="c1"&gt;-- Note I am only pulling out addresses not CNAMEs&lt;/span&gt;
        &lt;span class="n"&gt;_new_backend_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{}&lt;/span&gt;
        &lt;span class="kr"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="kr"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;ipairs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
            &lt;span class="nb"&gt;table.insert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_new_backend_servers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;
        &lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;_new_backend_servers&lt;/span&gt;
    &lt;span class="kr"&gt;end&lt;/span&gt;

    &lt;span class="c1"&gt;-- Run an at timer to force update_dns to trigger on worker init&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;at&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;update_dns&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;-- Set a timer to run every 10 seconds&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;every&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;update_dns&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;div class="section" id="configuring-the-dns-resolver"&gt;
&lt;h3&gt;Configuring the &lt;span class="caps"&gt;DNS&lt;/span&gt; resolver&lt;/h3&gt;
&lt;p&gt;Let’s break this block down in to easier to understand blocks.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{}&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Here we define an empty backend servers table that’ll be modified by modified
by &lt;span class="caps"&gt;DNS&lt;/span&gt; resolver and is used by the balancer module for direction clients.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="kr"&gt;function&lt;/span&gt; &lt;span class="nf"&gt;update_dns&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="c1"&gt;-- Set up the resolver&lt;/span&gt;
    &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;resolver&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt; &lt;span class="s2"&gt;"resty.dns.resolver"&lt;/span&gt;
    &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;resolver&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;new&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="n"&gt;nameservers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"1.1.1.1"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="s2"&gt;"1.0.0.1"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;53&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt; &lt;span class="p"&gt;},&lt;/span&gt;  &lt;span class="c1"&gt;-- Cloudflare&lt;/span&gt;
        &lt;span class="n"&gt;retrans&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;  &lt;span class="c1"&gt;-- 5 retransmissions on receive timeout&lt;/span&gt;
        &lt;span class="n"&gt;timeout&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;  &lt;span class="c1"&gt;-- 1 sec&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Here we’re defining the &lt;cite&gt;update_dns&lt;/cite&gt; function and within that setting up a
&lt;span class="caps"&gt;DNS&lt;/span&gt; resolver using the &lt;cite&gt;resty.dns.resolver&lt;/cite&gt; module.
I’m using Cloudflare’s &lt;span class="caps"&gt;DNS&lt;/span&gt; servers in this example with 5 retransmissions and
a timeout of 1 second.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"failed to instantiate resolver: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;return&lt;/span&gt;
&lt;span class="kr"&gt;end&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;If instantiating the resolver fails, the function will return, leaving the
backend server table unmodified. If this happens randomly during operation then
the old server table will remain in use. If it fails during start up, the
backend server table will be empty and cause &lt;cite&gt;&lt;span class="caps"&gt;HTTP&lt;/span&gt; 500&lt;/cite&gt; errors to be thrown
(this is set up later.)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="querying-the-dns-resolver"&gt;
&lt;h3&gt;Querying the &lt;span class="caps"&gt;DNS&lt;/span&gt; resolver&lt;/h3&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="c1"&gt;-- Pull DNS records&lt;/span&gt;
&lt;span class="c1"&gt;-- Use a hardcoded domain to make this example easier&lt;/span&gt;
&lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;tries&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="n"&gt;query&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"kura.gg"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="kc"&gt;nil&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;{})&lt;/span&gt;
&lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"failed to query resolved: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;return&lt;/span&gt;
&lt;span class="kr"&gt;end&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Here we query the &lt;span class="caps"&gt;DNS&lt;/span&gt; server for records, I’m using my own domain &lt;cite&gt;kura.gg&lt;/cite&gt; in
this example.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errcode&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"server returned error code: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errcode&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
            &lt;span class="s2"&gt;": "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errstr&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;-- Have a return here so that the old servers remain even if&lt;/span&gt;
    &lt;span class="c1"&gt;-- this lookup fails.&lt;/span&gt;
    &lt;span class="kr"&gt;return&lt;/span&gt;
&lt;span class="kr"&gt;end&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;If querying the records fails or if no records are found the
function will return and leave the backend server table unmodified, allowing
clients to attempt to use the old servers if they’re still alive.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="using-the-returned-dns-records-to-configure-the-backend"&gt;
&lt;h3&gt;Using the returned &lt;span class="caps"&gt;DNS&lt;/span&gt; records to configure the backend&lt;/h3&gt;
&lt;pre class="code lua literal-block"&gt;
    &lt;span class="c1"&gt;-- Dump records in a global variable&lt;/span&gt;
    &lt;span class="c1"&gt;-- Note I am only pulling out addresses not CNAMEs&lt;/span&gt;
    &lt;span class="n"&gt;_new_backend_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{}&lt;/span&gt;
    &lt;span class="kr"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ans&lt;/span&gt; &lt;span class="kr"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;ipairs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;answers&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
        &lt;span class="nb"&gt;table.insert&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_new_backend_servers&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ans&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;end&lt;/span&gt;
    &lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;_new_backend_servers&lt;/span&gt;
&lt;span class="kr"&gt;end&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Finally we reach this block if no errors have occured. This will create a new
table of backend servers from the &lt;span class="caps"&gt;DNS&lt;/span&gt; records queried and replace the old table
with the new one.&lt;/p&gt;
&lt;p&gt;It’s worth noting that this code will only store records that have an &lt;cite&gt;A&lt;/cite&gt; or
&lt;cite&gt;&lt;span class="caps"&gt;AAAA&lt;/span&gt;&lt;/cite&gt; record, not &lt;cite&gt;&lt;span class="caps"&gt;CNAMES&lt;/span&gt;&lt;/cite&gt; etc. Although it’s easy enough to modify it to
change this behaviour.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="set-up-a-timer-to-update-the-backend-servers-periodically"&gt;
&lt;h3&gt;Set up a timer to update the backend servers periodically&lt;/h3&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="c1"&gt;-- Run an at timer to force update_dns to trigger on worker init&lt;/span&gt;
&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;at&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;update_dns&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="c1"&gt;-- Set a timer to run every 10 seconds&lt;/span&gt;
&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;every&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;update_dns&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Here we’re setting up 2 timers. The first is an &lt;cite&gt;ngx.timer.at&lt;/cite&gt; timer that
tiggers when a worker is started to attempt to set up the backend server table
on worker init.&lt;/p&gt;
&lt;p&gt;The second is an &lt;cite&gt;ngx.timer.every&lt;/cite&gt; timer that runs in the worker every 10 seconds.&lt;/p&gt;
&lt;p&gt;Each worker will do this and have it’s own copy of the backend servers table.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="breaking-down-balancer-by-lua-block"&gt;
&lt;h2&gt;Breaking down &lt;cite&gt;balancer_by_lua_block&lt;/cite&gt;&lt;/h2&gt;
&lt;p&gt;Just like in the  &lt;a class="reference external" href="https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/"&gt;retrying dynamically configured
upstreams&lt;/a&gt;
article we’ll use OpenResty’s &lt;cite&gt;balancer_by_lua_block&lt;/cite&gt; to allow the balancer
to use these records.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="n"&gt;balancer_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"ngx.balancer"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
        &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"no backend servers available"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="c1"&gt;-- This block will only trigger if ngx.ctx.retry is not true.&lt;/span&gt;
    &lt;span class="c1"&gt;-- We set this to true during the initial request so future&lt;/span&gt;
    &lt;span class="c1"&gt;-- requests within this context will not go down this path.&lt;/span&gt;
    &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;retry&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
        &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;retry&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;
        &lt;span class="c1"&gt;-- Pick a random backend to start with&lt;/span&gt;
        &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;_backend_servers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;math.random&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;_backend_servers&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;

        &lt;span class="c1"&gt;-- Kinda messy but, create a context table we dump tried&lt;/span&gt;
        &lt;span class="c1"&gt;-- backends to.&lt;/span&gt;
        &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tried&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{}&lt;/span&gt;
        &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tried&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;

        &lt;span class="c1"&gt;-- set up more tries using the length of the server list minus 1.&lt;/span&gt;
        &lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_more_tries&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_more_tries failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;

    &lt;span class="kr"&gt;else&lt;/span&gt;
        &lt;span class="c1"&gt;-- This block will trigger on a retry&lt;/span&gt;
        &lt;span class="c1"&gt;-- Here we'll run through the backends and pick one we haven't&lt;/span&gt;
        &lt;span class="c1"&gt;-- tried yet.&lt;/span&gt;
        &lt;span class="kr"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ip&lt;/span&gt; &lt;span class="kr"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;ipairs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_backend_servers&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
            &lt;span class="n"&gt;in_ctx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tried&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;ip&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;~=&lt;/span&gt; &lt;span class="kc"&gt;nil&lt;/span&gt;
            &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="n"&gt;in_ctx&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="kc"&gt;false&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
                &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tried&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;ip&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;
                &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ip&lt;/span&gt;
                &lt;span class="kr"&gt;break&lt;/span&gt;
            &lt;span class="kr"&gt;end&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;
    &lt;span class="kr"&gt;end&lt;/span&gt;

    &lt;span class="c1"&gt;-- Hardcoded port again to make example easier&lt;/span&gt;
    &lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_current_peer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;443&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
        &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_current_peer failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;end&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;As with the &lt;cite&gt;init_worker_by_lua_block&lt;/cite&gt; I’ll break the &lt;cite&gt;balancer_by_lua_block&lt;/cite&gt;
block down in more manageable chunks.&lt;/p&gt;
&lt;div class="section" id="setting-up-balancer-by-lua"&gt;
&lt;h3&gt;Setting up balancer_by_lua&lt;/h3&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"ngx.balancer"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

&lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"no backend servers available"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="kr"&gt;end&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;First thing we do is include the &lt;cite&gt;ngx.balancer&lt;/cite&gt; module, then we check to see
if the backend servers table has any records. If not all we can do is write
an error message to log and send the client an &lt;cite&gt;&lt;span class="caps"&gt;HTTP&lt;/span&gt; 500&lt;/cite&gt; because we have no
backends available.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="handling-an-initial-request"&gt;
&lt;h3&gt;Handling an initial request&lt;/h3&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="c1"&gt;-- This block will only trigger if ngx.ctx.retry is not true or is&lt;/span&gt;
&lt;span class="c1"&gt;-- unset.&lt;/span&gt;
&lt;span class="c1"&gt;-- We set this to true during the initial request so future&lt;/span&gt;
&lt;span class="c1"&gt;-- requests within this context will not go down this path.&lt;/span&gt;
&lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;retry&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;retry&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;
    &lt;span class="c1"&gt;-- Pick a random backend to start with&lt;/span&gt;
    &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;_backend_servers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;math.random&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;_backend_servers&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;

    &lt;span class="c1"&gt;-- Kinda messy but, create a context table we dump tried&lt;/span&gt;
    &lt;span class="c1"&gt;-- backends to.&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tried&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{}&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tried&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;

    &lt;span class="c1"&gt;-- set up more tries using the length of the server list minus 1.&lt;/span&gt;
    &lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_more_tries&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;_backend_servers&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
        &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_more_tries failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;end&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Here we set up what happens when &lt;cite&gt;ngx.ctx.retry&lt;/cite&gt; is undefined or false, which
will happen on first request for a client.&lt;/p&gt;
&lt;p&gt;Within this block we pick a random backend, set up a table of addresses already
tried so if a retry is necessary it won’t use the same host.&lt;/p&gt;
&lt;p&gt;Then we set the number of retries to attempt as the length of the server table
minus one.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="handling-a-retry-request"&gt;
&lt;h3&gt;Handling a retry request&lt;/h3&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="kr"&gt;else&lt;/span&gt;
    &lt;span class="c1"&gt;-- This block will trigger on a retry&lt;/span&gt;
    &lt;span class="c1"&gt;-- Here we'll run through the backends and pick one we haven't&lt;/span&gt;
    &lt;span class="c1"&gt;-- tried yet.&lt;/span&gt;
    &lt;span class="kr"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;ip&lt;/span&gt; &lt;span class="kr"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;ipairs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;_backend_servers&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="kr"&gt;do&lt;/span&gt;
        &lt;span class="n"&gt;in_ctx&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tried&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;ip&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;~=&lt;/span&gt; &lt;span class="kc"&gt;nil&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="n"&gt;in_ctx&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="kc"&gt;false&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;tried&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;ip&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;
            &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ip&lt;/span&gt;
            &lt;span class="kr"&gt;break&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;
    &lt;span class="kr"&gt;end&lt;/span&gt;
&lt;span class="kr"&gt;end&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;This block is what will be called if the request is a retry. In it we simply
iterate through the backend server table looking for a backend we haven’t tried
yet. Once we find one we add it to the list of servers tried and break the loop
to send the client to that server.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="passing-the-request-back-to-nginx"&gt;
&lt;h3&gt;Passing the request back to nginx&lt;/h3&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="c1"&gt;-- Hardcoded port again to make example easier&lt;/span&gt;
&lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_current_peer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="mi"&gt;443&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
    &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_current_peer failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="kr"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="kr"&gt;end&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;This final block is where nginx is told which backend to send the client to.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="putting-it-all-together"&gt;
&lt;h2&gt;Putting it all together&lt;/h2&gt;
&lt;p&gt;Below is the full example written as a single &lt;cite&gt;nginx.conf&lt;/cite&gt;. Sadly syntax
highlighters have issues with nginx and Lua in a single file.&lt;/p&gt;
&lt;pre class="code nginx literal-block"&gt;
&lt;span class="c1"&gt;# set 2 worker processes to show the timer spawning on each one
&lt;/span&gt;&lt;span class="k"&gt;worker_processes&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="k"&gt;events&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="kn"&gt;worker_connections&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="k"&gt;http&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;

    &lt;/span&gt;&lt;span class="c1"&gt;# Do this for each worker so each worker has it's own copy of the DNS
&lt;/span&gt;&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# records.
&lt;/span&gt;&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;init_worker_by_lua_block&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="kn"&gt;_backend_servers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{}&lt;/span&gt;&lt;span class="w"&gt;

        &lt;/span&gt;&lt;span class="kn"&gt;local&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;function&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;update_dns()&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;up&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;resolver&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;local&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;resolver&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;require&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"resty.dns.resolver"&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;local&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;r,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;err&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;resolver:new&lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="kn"&gt;nameservers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="kn"&gt;"1.1.1.1",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="kn"&gt;"1.0.0.1",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;53&lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;&lt;span class="s"&gt;,&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Cloudflare&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;retrans&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="s"&gt;,&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;retransmissions&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;receive&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;timeout&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;timeout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1000&lt;/span&gt;&lt;span class="s"&gt;,&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;sec&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;not&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;r&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;then&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;ngx.log(ngx.ERR,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"failed&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;instantiate&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;resolver:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;err)&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;return&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;

            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Pull&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;DNS&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;records&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Use&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;hardcoded&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;domain&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;make&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;this&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;example&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;easier&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;local&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;answers,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;err,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;tries&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;r:query("kura.gg",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;nil,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{}&lt;/span&gt;&lt;span class="kn"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;not&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;answers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;then&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;ngx.log(ngx.ERR,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"failed&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;query&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;resolved:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;err)&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;return&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;answers.errcode&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;then&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;ngx.log(ngx.ERR,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;returned&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;error&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;code:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;answers.errcode,&lt;/span&gt;&lt;span class="w"&gt;
                        &lt;/span&gt;&lt;span class="s"&gt;":&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;answers.errstr)&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Have&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;here&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;so&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;that&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;old&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;servers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;remain&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;even&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;this&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;lookup&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fails.&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;return&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;

            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Dump&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;records&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;global&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;variable&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Note&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;I&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;am&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="s"&gt;ly&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;pulling&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;out&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;addresses&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;not&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;CNAMEs&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;_new_backend_servers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{}&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="kn"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;i,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ans&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ipairs(answers)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;do&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;table.insert(_new_backend_servers,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ans.address)&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;_backend_servers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;_new_backend_servers&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;

        &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Run&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;an&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;at&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;timer&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;force&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;update_dns&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;trigger&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;worker&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;init&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="s"&gt;ngx.timer.at(0,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;update_dns)&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;timer&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;run&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;every&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;seconds&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="s"&gt;ngx.timer.every(10,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;update_dns)&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

    &lt;/span&gt;&lt;span class="s"&gt;upstream&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backend&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;127&lt;/span&gt;&lt;span class="s"&gt;.0.0.1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;

        &lt;/span&gt;&lt;span class="kn"&gt;balancer_by_lua_block&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="kn"&gt;local&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;balancer&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;require("ngx.balancer")&lt;/span&gt;&lt;span class="w"&gt;

            &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;#_backend_servers == 0 then
&lt;/span&gt;&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="s"&gt;ngx.log(ngx.ERR,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"no&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backend&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;servers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;available")&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ngx.exit(500)&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;

            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;This&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;block&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;will&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="s"&gt;ly&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;trigger&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ngx.ctx.retry&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;is&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;not&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;true&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;or&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;is&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;unset.&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;We&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;this&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;true&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;during&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;initial&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;request&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;so&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;future&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;requests&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;within&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;this&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;context&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;will&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;not&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;go&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;down&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;this&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;path.&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;not&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ngx.ctx.retry&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;then&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;ngx.ctx.retry&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;true&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Pick&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;random&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backend&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;start&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;with&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;_backend_servers[math.random(&lt;/span&gt;&lt;span class="c1"&gt;#_backend_servers)]
&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Kinda&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;messy&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;but,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;create&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;context&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;table&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;we&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;dump&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;tried&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backends&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to.&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;ngx.ctx.tried&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{}&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="kn"&gt;ngx.ctx.tried[server]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;true&lt;/span&gt;&lt;span class="w"&gt;

                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;up&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;more&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;tries&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;using&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;length&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;of&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;list&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;minus&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="s"&gt;.&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;ok,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;err&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;balancer.set_more_tries(&lt;/span&gt;&lt;span class="c1"&gt;#_backend_servers - 1)
&lt;/span&gt;&lt;span class="w"&gt;                &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;not&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ok&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;then&lt;/span&gt;&lt;span class="w"&gt;
                    &lt;/span&gt;&lt;span class="s"&gt;ngx.log(ngx.ERR,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"set_more_tries&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;failed:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;err)&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;

            &lt;/span&gt;&lt;span class="s"&gt;else&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;This&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;block&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;will&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;trigger&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;a&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;retry&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Here&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;we'll&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;run&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;through&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;the&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backends&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;and&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;pick&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="s"&gt;e&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;we&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;haven't&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;tried&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;yet.&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;for&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;i,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ip&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ipairs(_backend_servers)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;do&lt;/span&gt;&lt;span class="w"&gt;
                    &lt;/span&gt;&lt;span class="s"&gt;in_ctx&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ngx.ctx.tried[ip]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;nil&lt;/span&gt;&lt;span class="w"&gt;
                    &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;in_ctx&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;==&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;false&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;then&lt;/span&gt;&lt;span class="w"&gt;
                        &lt;/span&gt;&lt;span class="s"&gt;ngx.ctx.tried[ip]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;true&lt;/span&gt;&lt;span class="w"&gt;
                        &lt;/span&gt;&lt;span class="s"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ip&lt;/span&gt;&lt;span class="w"&gt;
                        &lt;/span&gt;&lt;span class="s"&gt;break&lt;/span&gt;&lt;span class="w"&gt;
                    &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;

            &lt;/span&gt;&lt;span class="s"&gt;--&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Hardcoded&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;port&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;again&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;to&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;make&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;example&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;easier&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;ok,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;err&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;balancer.set_current_peer(server,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;443&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;not&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ok&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;then&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;ngx.log(ngx.ERR,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"set_current_peer&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;failed:&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;",&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;err)&lt;/span&gt;&lt;span class="w"&gt;
                &lt;/span&gt;&lt;span class="s"&gt;return&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ngx.exit(500)&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="s"&gt;end&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="err"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

    &lt;/span&gt;&lt;span class="s"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;localhost&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;

        &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
            &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://backend&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;&lt;span class="w"&gt;

&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="full-example-on-github"&gt;
&lt;h2&gt;Full example on GitHub&lt;/h2&gt;
&lt;p&gt;The full example nginx config is &lt;a class="reference external" href="https://github.com/kura/openresty-upstream-dns-example/blob/master/nginx.conf"&gt;available on GitHub&lt;/a&gt;
so you can quickly spin it up yourself and try it out.&lt;/p&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="nginx"></category><category term="openresty"></category><category term="lua"></category></entry><entry><title>Retrying dynamically configured upstreams with OpenResty</title><link href="https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/" rel="alternate"></link><published>2020-08-09T17:00:00+01:00</published><updated>2020-08-09T17:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2020-08-09:/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/</id><summary type="html">
&lt;div class="section" id="preamble"&gt;
&lt;h2&gt;Preamble&lt;/h2&gt;
&lt;p&gt;OpenResty is a modified version of nginx with LuaJIT compiled in and many
nginx options that can be controlled or modified via Lua. It is very commonly
used in content delivery networks for it’s configurability.&lt;/p&gt;
&lt;p&gt;As such, we use OpenResty and one of the features we use is the ability to
dynamically modify upstream backends. To achieve this we use some logic within
OpenResty to update upstreams based on &lt;span class="caps"&gt;DNS&lt;/span&gt; records. This means we can pull
upstreams in and out of service via &lt;span class="caps"&gt;DNS&lt;/span&gt; records and have OpenResty
update it’s upstream proxy passing configuration without needing to push
configs out to hundreds of servers and reload daemons.&lt;/p&gt;
&lt;p&gt;The logic behind how we update the upstream backends is beyond the scope of
this post, so let’s just say we have a table of upstream servers.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;upstream_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="s2"&gt;"10.0.0.1:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s2"&gt;"10.0.0.2:443 …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="preamble"&gt;
&lt;h2&gt;Preamble&lt;/h2&gt;
&lt;p&gt;OpenResty is a modified version of nginx with LuaJIT compiled in and many
nginx options that can be controlled or modified via Lua. It is very commonly
used in content delivery networks for it’s configurability.&lt;/p&gt;
&lt;p&gt;As such, we use OpenResty and one of the features we use is the ability to
dynamically modify upstream backends. To achieve this we use some logic within
OpenResty to update upstreams based on &lt;span class="caps"&gt;DNS&lt;/span&gt; records. This means we can pull
upstreams in and out of service via &lt;span class="caps"&gt;DNS&lt;/span&gt; records and have OpenResty
update it’s upstream proxy passing configuration without needing to push
configs out to hundreds of servers and reload daemons.&lt;/p&gt;
&lt;p&gt;The logic behind how we update the upstream backends is beyond the scope of
this post, so let’s just say we have a table of upstream servers.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;upstream_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="s2"&gt;"10.0.0.1:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s2"&gt;"10.0.0.2:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s2"&gt;"10.0.0.3:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s2"&gt;"10.0.0.4:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="introduction-to-balancer-by-lua"&gt;
&lt;h2&gt;Introduction to &lt;cite&gt;balancer_by_lua&lt;/cite&gt;&lt;/h2&gt;
&lt;p&gt;In nginx you’d normally specify multiple backends in an upstream block.&lt;/p&gt;
&lt;pre class="code nginx literal-block"&gt;
&lt;span class="k"&gt;upstream&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backend&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;10.0.0.1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;443&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;max_fails=3&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=3&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;10.0.0.2&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;443&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;max_fails=3&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=3&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;10.0.0.3&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;443&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;max_fails=3&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=3&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;10.0.0.4&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;443&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;max_fails=3&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=3&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt;
&lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Doing this in OpenResty with a dynamic set of backends is slightly different
and requires using &lt;cite&gt;balancer_by_lua_block&lt;/cite&gt; or &lt;cite&gt;balancer_by_lua_file&lt;/cite&gt;.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="n"&gt;upstream&lt;/span&gt; &lt;span class="n"&gt;backend&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="mf"&gt;127.0.0.1&lt;/span&gt; &lt;span class="n"&gt;fail_timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;balancer_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"ngx.balancer"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="c1"&gt;-- ...&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Using this as a base we can get &lt;cite&gt;balancer_by_lua&lt;/cite&gt; to pick a backend from our table.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="n"&gt;init_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;upstream_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.1:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.2:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.3:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.4:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;upstream&lt;/span&gt; &lt;span class="n"&gt;backend&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="mf"&gt;127.0.0.1&lt;/span&gt; &lt;span class="n"&gt;fail_timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;balancer_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"ngx.balancer"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="c1"&gt;-- Pick a random backend&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;upstream_servers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;math.random&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;upstream_servers&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;

        &lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_current_peer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_current_peer failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="kr"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;With this block each request will pick a random server from the table and use
it for reverse proxying.&lt;/p&gt;
&lt;p&gt;This approach is great for multiple reasons; you can dynamically update the
server of backends available, you can add logic to how a backend is chosen,
and more.&lt;/p&gt;
&lt;p&gt;The downside to this approach is in using it you are disabling nginx’s builtin
retry logic.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fixing-retries"&gt;
&lt;h2&gt;Fixing retries&lt;/h2&gt;
&lt;p&gt;The &lt;cite&gt;ngx.balancer&lt;/cite&gt; module of OpenResty has a method for setting up retries and
it’s called &lt;cite&gt;set_more_tries&lt;/cite&gt;. So let’s implement it.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="c1"&gt;-- DO NOT COPY AND PASTE THIS WITHOUT READING FURTHER. IT HAS A DELIBERATE&lt;/span&gt;
&lt;span class="c1"&gt;-- BUG TO SHOW HOW JUST USING set_more_tries WON'T WORK.&lt;/span&gt;

&lt;span class="n"&gt;init_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;upstream_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.1:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.2:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.3:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.4:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;upstream&lt;/span&gt; &lt;span class="n"&gt;backend&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="mf"&gt;127.0.0.1&lt;/span&gt; &lt;span class="n"&gt;fail_timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;balancer_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"ngx.balancer"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="c1"&gt;-- Pick a random backend&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;upstream_servers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;math.random&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;upstream_servers&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;

        &lt;span class="c1"&gt;-- set up more tries using the length of the server list minus 1.&lt;/span&gt;
        &lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_more_tries&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;upstream_servers&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_more_tries failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;

        &lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_current_peer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_current_peer failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="kr"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;This approach will allow retries to happen, but it also introduces a bug.
Each time &lt;cite&gt;balancer_by_lua_block&lt;/cite&gt; is called it sets &lt;cite&gt;set_more_tries&lt;/cite&gt;,
including for retries. Which means a client will retry endlessly.&lt;/p&gt;
&lt;p&gt;We can fix that using the request context.&lt;/p&gt;
&lt;pre class="code lua literal-block"&gt;
&lt;span class="n"&gt;init_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;upstream_servers&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.1:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.2:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.3:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
        &lt;span class="s2"&gt;"10.0.0.4:443"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;upstream&lt;/span&gt; &lt;span class="n"&gt;backend&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="mf"&gt;127.0.0.1&lt;/span&gt; &lt;span class="n"&gt;fail_timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;3&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
    &lt;span class="n"&gt;balancer_by_lua_block&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="nb"&gt;require&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"ngx.balancer"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="c1"&gt;-- Pick a random backend&lt;/span&gt;
        &lt;span class="kd"&gt;local&lt;/span&gt; &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;upstream_servers&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="nb"&gt;math.random&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;upstream_servers&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;

        &lt;span class="c1"&gt;-- This block will only trigger if ngx.ctx.retry is not true.&lt;/span&gt;
        &lt;span class="c1"&gt;-- We set this to true during the initial request so future&lt;/span&gt;
        &lt;span class="c1"&gt;-- requests within this context will not go down this path.&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;retry&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ctx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;retry&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;true&lt;/span&gt;
            &lt;span class="c1"&gt;-- set up more tries using the length of the server list minus 1.&lt;/span&gt;
            &lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_more_tries&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;#&lt;/span&gt;&lt;span class="n"&gt;upstream_servers&lt;/span&gt; &lt;span class="o"&gt;-&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
                &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_more_tries failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="kr"&gt;end&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;

        &lt;span class="n"&gt;ok&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;balancer&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;set_current_peer&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;ok&lt;/span&gt; &lt;span class="kr"&gt;then&lt;/span&gt;
            &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERR&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s2"&gt;"set_current_peer failed: "&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;err&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="kr"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ngx&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;500&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="kr"&gt;end&lt;/span&gt;
    &lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;Obviously this approach isn’t perfect. It picks a random backend server to use
for the initial request and for retries, which means a client could get
unlucky and hit the same bad backend multiple times. This is just an example
of what you can do with OpenResty and Lua.&lt;/p&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="nginx"></category><category term="openresty"></category><category term="lua"></category></entry><entry><title>Eevee — Adding more structure to posts</title><link href="https://kura.gg/2016/06/25/eevee-adding-more-structure-to-posts/" rel="alternate"></link><published>2016-06-25T21:00:00+01:00</published><updated>2016-06-25T21:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2016-06-25:/2016/06/25/eevee-adding-more-structure-to-posts/</id><summary type="html">&lt;img alt="Eevee the Pokémon" class="align-center" src="/images/eeveelutions.png"/&gt;

&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="/eevee/"&gt;Eevee&lt;/a&gt; is a theme for &lt;a class="reference external" href="https://getpelican.com"&gt;Pelican&lt;/a&gt;, based on
Google’s &lt;a class="reference external" href="https://material.google.com/"&gt;Material Design&lt;/a&gt; specification that I
released in June 2016.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://schema.org/"&gt;Schema.org&lt;/a&gt; is a collaborative effort, including
private companies like Google and the open source community to promoter adding
additional structure to data that indentifies what parts of &lt;span class="caps"&gt;HTML&lt;/span&gt; are being used
for, for example it can help a search engine understand what content is more
important to index or, it can help a user with a screen reader get to the
important content more easily. These structures are more commonly known as
microformats or microdata.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="structure-is-a-beautiful-thing"&gt;
&lt;h2&gt;Structure is a beautiful thing&lt;/h2&gt;
&lt;p&gt;&lt;span class="caps"&gt;HTML&lt;/span&gt; — by it’s very design is structured — the difference is that the content
defines or modifies that structure.&lt;/p&gt;
&lt;p&gt;By using microformat data structures from schema.org you can define what
elements are more prominent or important through a large set of additional
vocabulary, improving the experience for everyone …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;img alt="Eevee the Pokémon" class="align-center" src="/images/eeveelutions.png"/&gt;

&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="/eevee/"&gt;Eevee&lt;/a&gt; is a theme for &lt;a class="reference external" href="https://getpelican.com"&gt;Pelican&lt;/a&gt;, based on
Google’s &lt;a class="reference external" href="https://material.google.com/"&gt;Material Design&lt;/a&gt; specification that I
released in June 2016.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://schema.org/"&gt;Schema.org&lt;/a&gt; is a collaborative effort, including
private companies like Google and the open source community to promoter adding
additional structure to data that indentifies what parts of &lt;span class="caps"&gt;HTML&lt;/span&gt; are being used
for, for example it can help a search engine understand what content is more
important to index or, it can help a user with a screen reader get to the
important content more easily. These structures are more commonly known as
microformats or microdata.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="structure-is-a-beautiful-thing"&gt;
&lt;h2&gt;Structure is a beautiful thing&lt;/h2&gt;
&lt;p&gt;&lt;span class="caps"&gt;HTML&lt;/span&gt; — by it’s very design is structured — the difference is that the content
defines or modifies that structure.&lt;/p&gt;
&lt;p&gt;By using microformat data structures from schema.org you can define what
elements are more prominent or important through a large set of additional
vocabulary, improving the experience for everyone that uses your website.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;article&lt;/span&gt; &lt;span class="na"&gt;itemscope&lt;/span&gt; &lt;span class="na"&gt;itemtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"https://schema.org/BlogPosting"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"accessibilityControl"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"fullKeyboardControl"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"accessibilityControl"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"fullMouseControl"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"accessibilityControl"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"bookmarks"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"accessibilityAPI"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"ARIA"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"author"&lt;/span&gt; &lt;span class="na"&gt;itemscope&lt;/span&gt;
         &lt;span class="na"&gt;itemtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"https://schema.org/Person"&lt;/span&gt; &lt;span class="na"&gt;role&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"presentation"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"name"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"Kura"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
        &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"name"&lt;/span&gt;
              &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"https://kura.gg/authors/kura/"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"keywords"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"eevee,html,pelican"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"eevee-article eevee-article-padding"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"eevee-meta mdl-color-text--grey-500"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
            &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;time&lt;/span&gt; &lt;span class="na"&gt;datetime&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"2016-06-25T21:00:00+01:00"&lt;/span&gt;
                  &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"datePublished"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
                 25 Jun 2016
            &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;time&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"name"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
            &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;a&lt;/span&gt; &lt;span class="na"&gt;href&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"https://kura.gg/eevee"&lt;/span&gt; &lt;span class="na"&gt;rel&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"bookmark"&lt;/span&gt;
               &lt;span class="na"&gt;title&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"Permalink to 'Eevee -- A Material Design theme for Pelican'"&lt;/span&gt;
               &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"url"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
                Eevee -- A Material Design theme for Pelican
            &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;a&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;section&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"articleBody"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
            Some random content here
        &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;section&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"eevee-comment"&lt;/span&gt; &lt;span class="na"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"article-comments"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
        &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;section&lt;/span&gt; &lt;span class="na"&gt;itemscope&lt;/span&gt; &lt;span class="na"&gt;itemtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'https://schema.org/UserComments'&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
            &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;Discuss&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
            Disqus/Muut stuff here.
        &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;section&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;article&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Above is an example of a blog post with the additional vocabulary, below I’ll
outline each important section and explain what it does.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;article&lt;/span&gt; &lt;span class="na"&gt;itemscope&lt;/span&gt; &lt;span class="na"&gt;itemtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"https://schema.org/BlogPosting"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This simply tells the client which schema is being used for the content within
it. The client uses that data to determine what elements should be provided
based on that schema. Here I’m using the &lt;a class="reference external" href="https://schema.org/BlogPosting"&gt;BlogPosting&lt;/a&gt; schema.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"accessibilityControl"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"fullKeyboardControl"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"accessibilityControl"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"fullMouseControl"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"accessibilityControl"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"bookmarks"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"accessibilityAPI"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"ARIA"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;These elements — as you may have guess from their names — are used to improve
accessibility. More information on available options is provided on the
&lt;a class="reference external" href="https://www.w3.org/wiki/WebSchemas/Accessibility"&gt;&lt;span class="caps"&gt;W3C&lt;/span&gt; wiki&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"author"&lt;/span&gt; &lt;span class="na"&gt;itemscope&lt;/span&gt;
     &lt;span class="na"&gt;itemtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"https://schema.org/Person"&lt;/span&gt; &lt;span class="na"&gt;role&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"presentation"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"name"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"Kura"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"name"&lt;/span&gt;
          &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"https://kura.gg/authors/kura/"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;div&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This set of markup simply defines who the author is and where more of their
content is located. Note that it uses a different schema named &lt;a class="reference external" href="https://schema.org/Person"&gt;Person&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Because the div element has no style and consists of only meta data, a role
is defined that tells screen readers this data is only for presentation
purposes and can be ignored.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;meta&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"keywords"&lt;/span&gt; &lt;span class="na"&gt;content&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"eevee,html,pelican"&lt;/span&gt; &lt;span class="p"&gt;/&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This a pretty simple element, it is generated from the blog articles category
and any tags it may have.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;time&lt;/span&gt; &lt;span class="na"&gt;datetime&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"2016-06-25T21:00:00+01:00"&lt;/span&gt;
      &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"datePublished"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
     25 Jun 2016
&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;time&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This element is a date provided as a universally understood value and in a
more user-friendly format that is displayed to the user.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"name"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;a&lt;/span&gt; &lt;span class="na"&gt;href&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"https://kura.gg/eevee"&lt;/span&gt; &lt;span class="na"&gt;rel&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"bookmark"&lt;/span&gt;
       &lt;span class="na"&gt;title&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"Permalink to 'Eevee -- A Material Design theme for Pelican'"&lt;/span&gt;
       &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"url"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
        Eevee -- A Material Design theme for Pelican
    &lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;a&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here the name of the article is defined, as is the &lt;span class="caps"&gt;URL&lt;/span&gt; to that article.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;section&lt;/span&gt; &lt;span class="na"&gt;itemprop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"articleBody"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    Some random content here
&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;section&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This section informs the client that this is the main content of the post.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;section&lt;/span&gt; &lt;span class="na"&gt;itemscope&lt;/span&gt; &lt;span class="na"&gt;itemtype&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;'https://schema.org/UserComments'&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;Discuss&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;h2&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
    Disqus/Muut stuff here.
&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;section&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally we add another schema &lt;a class="reference external" href="https://schema.org/UserComments"&gt;UserComments&lt;/a&gt;
that defines user comment content.&lt;/p&gt;
&lt;/div&gt;
</content><category term="eevee"></category><category term="pelican"></category></entry><entry><title>Eevee — Updating share buttons and adding Muut</title><link href="https://kura.gg/2016/06/19/eevee-updating-share-buttons-and-adding-muut/" rel="alternate"></link><published>2016-06-19T01:45:00+01:00</published><updated>2016-06-19T01:45:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2016-06-19:/2016/06/19/eevee-updating-share-buttons-and-adding-muut/</id><summary type="html">&lt;img alt="Eevee the Pokémon" class="align-center" src="/images/eeveelutions.png"/&gt;

&lt;p&gt;This week I pushed the &lt;a class="reference external" href="https://github.com/kura/eevee/tree/0.0.3"&gt;0.0.3 update&lt;/a&gt; for my Pelican theme &lt;a class="reference external" href="/eevee/"&gt;Eevee&lt;/a&gt; containing new and improved styling for share buttons and adding
the ability to use &lt;a class="reference external" href="https://muut.com/"&gt;Muut&lt;/a&gt; instead of Disqus for comments.&lt;/p&gt;
&lt;div class="section" id="share-button-changes"&gt;
&lt;h2&gt;Share button changes&lt;/h2&gt;
&lt;p&gt;The original styling of the share buttons wasn’t particularly pretty.&lt;/p&gt;
&lt;img alt="Eevee's original share button styling" class="align-center" src="/images/eevee-original-share-buttons.png"/&gt;
&lt;p&gt;They badly needed a make over, and so they were restyled to be more prominent,
look less out of place and randomly pasted in to the page and to have a colour
scheme that matches the social media site they share to.&lt;/p&gt;
&lt;img alt="Eevee's new 0.0.3 share button styling" class="align-center" src="/images/eevee-0.0.3-share-buttons.png"/&gt;
&lt;p&gt;These buttons appear on articles and pages, but when viewing an article with
&lt;tt class="docutils literal"&gt;DISQUS_SITENAME&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;MUUT_SITENAME&lt;/tt&gt; enabled a fourth button is shown that
links to the comments section of the current article.&lt;/p&gt;
&lt;img alt="Eevee's new 0.0.3 article share button styling" class="align-center" src="/images/eevee-0.0.3-article-share-buttons.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="comments-powered-by-muut"&gt;
&lt;h2&gt;Comments powered by Muut&lt;/h2&gt;
&lt;p&gt;To enable commenting with Muut, simply modify &lt;tt class="docutils literal"&gt;pelicanconf.py&lt;/tt&gt; and set the
Muut site name.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;MUUT_SITENAME&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'somethinghere'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will automatically cause Eevee to enable …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;img alt="Eevee the Pokémon" class="align-center" src="/images/eeveelutions.png"/&gt;

&lt;p&gt;This week I pushed the &lt;a class="reference external" href="https://github.com/kura/eevee/tree/0.0.3"&gt;0.0.3 update&lt;/a&gt; for my Pelican theme &lt;a class="reference external" href="/eevee/"&gt;Eevee&lt;/a&gt; containing new and improved styling for share buttons and adding
the ability to use &lt;a class="reference external" href="https://muut.com/"&gt;Muut&lt;/a&gt; instead of Disqus for comments.&lt;/p&gt;
&lt;div class="section" id="share-button-changes"&gt;
&lt;h2&gt;Share button changes&lt;/h2&gt;
&lt;p&gt;The original styling of the share buttons wasn’t particularly pretty.&lt;/p&gt;
&lt;img alt="Eevee's original share button styling" class="align-center" src="/images/eevee-original-share-buttons.png"/&gt;
&lt;p&gt;They badly needed a make over, and so they were restyled to be more prominent,
look less out of place and randomly pasted in to the page and to have a colour
scheme that matches the social media site they share to.&lt;/p&gt;
&lt;img alt="Eevee's new 0.0.3 share button styling" class="align-center" src="/images/eevee-0.0.3-share-buttons.png"/&gt;
&lt;p&gt;These buttons appear on articles and pages, but when viewing an article with
&lt;tt class="docutils literal"&gt;DISQUS_SITENAME&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;MUUT_SITENAME&lt;/tt&gt; enabled a fourth button is shown that
links to the comments section of the current article.&lt;/p&gt;
&lt;img alt="Eevee's new 0.0.3 article share button styling" class="align-center" src="/images/eevee-0.0.3-article-share-buttons.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="comments-powered-by-muut"&gt;
&lt;h2&gt;Comments powered by Muut&lt;/h2&gt;
&lt;p&gt;To enable commenting with Muut, simply modify &lt;tt class="docutils literal"&gt;pelicanconf.py&lt;/tt&gt; and set the
Muut site name.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;MUUT_SITENAME&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'somethinghere'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will automatically cause Eevee to enable the Muut comment template which
will styled similarly to how the Disqus comments section is styled.&lt;/p&gt;
&lt;p&gt;Please be aware that if &lt;tt class="docutils literal"&gt;DISQUS_SITENAME&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;MUUT_SITENAME&lt;/tt&gt; are
configured, Disqus will be prioritized over Muut and therefore only the Disqus
template will be loaded.&lt;/p&gt;
&lt;div class="lightbox-block align-center"&gt;&lt;a href="#eee18045-b1e4-4cc3-b53b-180bf6d897f2" title="Eevee using Muut for comments (click to view large image)"&gt;&lt;img alt="Eevee using Muut for comments (click to view large image)" class="align-center" src="/images/eevee-0.0.3-muut-thumb.png"/&gt;&lt;/a&gt;&lt;a class="lightbox" href="#_" id="eee18045-b1e4-4cc3-b53b-180bf6d897f2" title="Click to close"&gt;&lt;img alt="Click to close" src="/images/eevee-0.0.3-muut.png"/&gt;&lt;/a&gt;&lt;p class="align-center"&gt;Eevee using Muut for comments (click to view large image)&lt;/p&gt;&lt;/div&gt;&lt;div class="lightbox-divider"&gt;&lt;/div&gt;&lt;/div&gt;
&lt;div class="section" id="back-to-the-top-of-the-page-links"&gt;
&lt;h2&gt;Back to the top of the page links&lt;/h2&gt;
&lt;p&gt;A small addition are the &lt;cite&gt;back to the top of the page&lt;/cite&gt; links that will now
appear under each article on index pages.&lt;/p&gt;
&lt;img alt="Eevee's new 0.0.3 back to top of the page links" class="align-center" src="/images/eevee-0.0.3-back-to-top-links.png"/&gt;
&lt;p&gt;A link has also been added to the footer to take users back to the top of the page.&lt;/p&gt;
&lt;img alt="Eevee's new 0.0.3 back to top of the page footer link" class="align-center" src="/images/eevee-0.0.3-back-to-top-footer.png"/&gt;
&lt;/div&gt;
</content><category term="eevee"></category><category term="pelican"></category><category term="eevee"></category><category term="muut"></category></entry><entry><title>Lightbox — A pure CSS lightbox for Pelican</title><link href="https://kura.gg/2016/06/13/lightbox--a-pure-css-lightbox-for-pelican/" rel="alternate"></link><published>2016-06-13T20:50:00+01:00</published><updated>2016-06-13T20:50:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2016-06-13:/2016/06/13/lightbox--a-pure-css-lightbox-for-pelican/</id><content type="html">&lt;img alt="Lightbox" class="align-center" src="/images/lightbox.png"/&gt;

&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;With the release of my &lt;a class="reference external" href="/eevee/"&gt;Eevee&lt;/a&gt; theme for Pelican, I realised
displaying a thumbnail image of the theme that linked to a larger image wasn’t
the most appealing design choice. I prefer to leave Javascript out of the
equation where possible, being one of those weird people that have it disabled
by default.&lt;/p&gt;
&lt;p&gt;As such I sought out a way to create a pure &lt;span class="caps"&gt;CSS&lt;/span&gt; equivalent of a Lightbox and
turn it in to an &lt;span class="caps"&gt;RST&lt;/span&gt; directive to plug directly in to Pelican.&lt;/p&gt;
&lt;/div&gt;
</content><category term="lightbox"></category><category term="pelican"></category><category term="lightbox"></category><category term="eevee"></category></entry><entry><title>Eevee — Using Font Awesome icons in menus</title><link href="https://kura.gg/2016/06/12/eevee-using-font-awesome-icons-in-menus/" rel="alternate"></link><published>2016-06-12T23:40:00+01:00</published><updated>2016-06-12T23:40:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2016-06-12:/2016/06/12/eevee-using-font-awesome-icons-in-menus/</id><summary type="html">&lt;img alt="Eevee the Pokémon" class="align-center" src="/images/eeveelutions.png"/&gt;

&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="/eevee/"&gt;Eevee&lt;/a&gt; is a theme for &lt;a class="reference external" href="https://getpelican.com"&gt;Pelican&lt;/a&gt;, based on
Google’s &lt;a class="reference external" href="https://material.google.com/"&gt;Material Design&lt;/a&gt; specification that I
released in June 2016.&lt;/p&gt;
&lt;p&gt;Eevee allows configuring menu links in the header and footer of a template —
including social links.&lt;/p&gt;
&lt;p&gt;Eevee also includes &lt;a class="reference external" href="https://fontawesome.com/"&gt;Font Awesome&lt;/a&gt; by default, at
time of release and writing of this article it provides Font Awesome version 4.6.3.&lt;/p&gt;
&lt;p&gt;Because the links are totally customisable, it means you can inject &lt;span class="caps"&gt;HTML&lt;/span&gt;
directly in to a link name and — because Font Awesome is included by default
— you can inject Font Awesome icons in to link names using &lt;span class="caps"&gt;HTML&lt;/span&gt;.&lt;/p&gt;
&lt;img alt="Social icons in Eevee menu" src="/images/eevee-social-icons.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="using-icons-in-links"&gt;
&lt;h2&gt;Using icons in links&lt;/h2&gt;
&lt;p&gt;Menu’s in Eevee are controlled by Pelican’s configuration, for information on
how to modify menu’s please see &lt;a class="reference external" href="/eevee/#header-and-footer-options"&gt;the Eevee documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Imagine you have a list of links to social websites in your menu, similar to
the list below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;SOCIAL&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="s1"&gt;'Github'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https://github.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Twitter'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">&lt;img alt="Eevee the Pokémon" class="align-center" src="/images/eeveelutions.png"/&gt;

&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="/eevee/"&gt;Eevee&lt;/a&gt; is a theme for &lt;a class="reference external" href="https://getpelican.com"&gt;Pelican&lt;/a&gt;, based on
Google’s &lt;a class="reference external" href="https://material.google.com/"&gt;Material Design&lt;/a&gt; specification that I
released in June 2016.&lt;/p&gt;
&lt;p&gt;Eevee allows configuring menu links in the header and footer of a template —
including social links.&lt;/p&gt;
&lt;p&gt;Eevee also includes &lt;a class="reference external" href="https://fontawesome.com/"&gt;Font Awesome&lt;/a&gt; by default, at
time of release and writing of this article it provides Font Awesome version 4.6.3.&lt;/p&gt;
&lt;p&gt;Because the links are totally customisable, it means you can inject &lt;span class="caps"&gt;HTML&lt;/span&gt;
directly in to a link name and — because Font Awesome is included by default
— you can inject Font Awesome icons in to link names using &lt;span class="caps"&gt;HTML&lt;/span&gt;.&lt;/p&gt;
&lt;img alt="Social icons in Eevee menu" src="/images/eevee-social-icons.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="using-icons-in-links"&gt;
&lt;h2&gt;Using icons in links&lt;/h2&gt;
&lt;p&gt;Menu’s in Eevee are controlled by Pelican’s configuration, for information on
how to modify menu’s please see &lt;a class="reference external" href="/eevee/#header-and-footer-options"&gt;the Eevee documentation&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Imagine you have a list of links to social websites in your menu, similar to
the list below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;SOCIAL&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="s1"&gt;'Github'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https://github.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Twitter'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https://twitter.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Facebook'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https://facebook.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'Instagram'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https://instagram.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'LinkedIn'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'https://linkedin.com/'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Adding the relevant icons to these links is very simple.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;SOCIAL&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;((&lt;/span&gt;&lt;span class="s1"&gt;'&amp;lt;i class="fa fa-github aria-hidden="true"&amp;gt;&amp;lt;/i&amp;gt; Github'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="s1"&gt;'https://github.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'&amp;lt;i class="fa fa-twitter aria-hidden="true"&amp;gt;&amp;lt;/i&amp;gt; Twitter'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="s1"&gt;'https://twitter.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'&amp;lt;i class="fa fa-facebook aria-hidden="true"&amp;gt;&amp;lt;/i&amp;gt; Facebook'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="s1"&gt;'https://facebook.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'&amp;lt;i class="fa fa-instagram aria-hidden="true"&amp;gt;&amp;lt;/i&amp;gt; Instagram'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="s1"&gt;'https://instagram.com/'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
          &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'&amp;lt;i class="fa fa-linkedin aria-hidden="true"&amp;gt;&amp;lt;/i&amp;gt; LinkedIn'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
           &lt;span class="s1"&gt;'https://linkedin.com/'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Turning a rather dull menu, in to a more pleasing menu.&lt;/p&gt;
&lt;img alt="Eevee menu with no icons" src="/images/eevee-social-icons--no-icons.png"/&gt;
&lt;img alt="Social icons in Eevee menu" src="/images/eevee-social-icons.png"/&gt;
&lt;/div&gt;
</content><category term="eevee"></category><category term="pelican"></category></entry><entry><title>Eevee — A Material Design theme for Pelican</title><link href="https://kura.gg/2016/06/12/eevee-a-material-design-theme-for-pelican/" rel="alternate"></link><published>2016-06-12T10:25:00+01:00</published><updated>2016-06-12T10:25:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2016-06-12:/2016/06/12/eevee-a-material-design-theme-for-pelican/</id><content type="html">&lt;img alt="Eevee the Pokémon" class="align-center" src="/images/eeveelutions.png"/&gt;

&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Eevee is a theme for &lt;a class="reference external" href="https://getpelican.com"&gt;Pelican&lt;/a&gt;, based on Google’s
&lt;a class="reference external" href="https://material.google.com/"&gt;Material Design&lt;/a&gt; specification. It is named
after the Pokémon &lt;a class="reference external" href="https://www.pokemon.com/uk/pokedex/eevee"&gt;Eevee&lt;/a&gt; because
— like the Pokémon — it can evolve in to many ‘elemental types.’&lt;/p&gt;
&lt;/div&gt;
</content><category term="eevee"></category><category term="pelican"></category></entry><entry><title>Blackhole 2.0: or, How I Learned to Love Asyncio</title><link href="https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/" rel="alternate"></link><published>2016-05-21T00:20:00+01:00</published><updated>2016-05-21T00:20:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2016-05-21:/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/</id><summary type="html">
&lt;p&gt;A brief history of a tiny part of the Internet.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://blackhole.io/1"&gt;Blackhole 1 — Blackhole as it was originally
known&lt;/a&gt; — was written on &lt;a class="reference external" href="https://docs.python.org/2/whatsnew/2.7.html"&gt;Python 2.7&lt;/a&gt;, briefly supporting &lt;a class="reference external" href="https://docs.python.org/2.6/whatsnew/2.6.html"&gt;Python 2.6&lt;/a&gt; for a time and also
supporting early version of &lt;a class="reference external" href="https://docs.python.org/3.2/whatsnew/3.2.html"&gt;Python 3&lt;/a&gt;, &lt;a class="reference external" href="https://www.pypy.org/features.html"&gt;PyPy 2&lt;/a&gt; and &lt;a class="reference external" href="https://www.pypy.org/features.html"&gt;PyPy 3&lt;/a&gt;. Built on top of &lt;a class="reference external" href="https://www.tornadoweb.org/en/stable/"&gt;Tornado&lt;/a&gt;, it was asynchronous in a fashion and
— quite simply — worked.&lt;/p&gt;
&lt;p&gt;The original prototype that became Blackhole was &lt;a class="reference external" href="/simplemta"&gt;SimpleMTA&lt;/a&gt; — a
prototype that was created quickly, to serve a very simple testing purpose that
I had for it.&lt;/p&gt;
&lt;p&gt;As I needed SimpleMTA to do more, I wrote Blackhole to accomplish that task.
I’d been using Tornado a bit and wanted to experiment with it more. Building
on top of Tornado created some oddities in how the program was designed and
that always irked me.&lt;/p&gt;
&lt;p&gt;Between the time of the last 1.8.X and the 2.0 release, I experimented with …&lt;/p&gt;</summary><content type="html">
&lt;p&gt;A brief history of a tiny part of the Internet.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://blackhole.io/1"&gt;Blackhole 1 — Blackhole as it was originally
known&lt;/a&gt; — was written on &lt;a class="reference external" href="https://docs.python.org/2/whatsnew/2.7.html"&gt;Python 2.7&lt;/a&gt;, briefly supporting &lt;a class="reference external" href="https://docs.python.org/2.6/whatsnew/2.6.html"&gt;Python 2.6&lt;/a&gt; for a time and also
supporting early version of &lt;a class="reference external" href="https://docs.python.org/3.2/whatsnew/3.2.html"&gt;Python 3&lt;/a&gt;, &lt;a class="reference external" href="https://www.pypy.org/features.html"&gt;PyPy 2&lt;/a&gt; and &lt;a class="reference external" href="https://www.pypy.org/features.html"&gt;PyPy 3&lt;/a&gt;. Built on top of &lt;a class="reference external" href="https://www.tornadoweb.org/en/stable/"&gt;Tornado&lt;/a&gt;, it was asynchronous in a fashion and
— quite simply — worked.&lt;/p&gt;
&lt;p&gt;The original prototype that became Blackhole was &lt;a class="reference external" href="/simplemta"&gt;SimpleMTA&lt;/a&gt; — a
prototype that was created quickly, to serve a very simple testing purpose that
I had for it.&lt;/p&gt;
&lt;p&gt;As I needed SimpleMTA to do more, I wrote Blackhole to accomplish that task.
I’d been using Tornado a bit and wanted to experiment with it more. Building
on top of Tornado created some oddities in how the program was designed and
that always irked me.&lt;/p&gt;
&lt;p&gt;Between the time of the last 1.8.X and the 2.0 release, I experimented with
rewriting the program on top of various libraries. The most obvious of these
was &lt;a class="reference external" href="https://twistedmatrix.com/trac/"&gt;Twisted&lt;/a&gt;. I’ve always been a fan of
Twisted but I don’t like &lt;tt class="docutils literal"&gt;theFormattingOfItsFunctionNames&lt;/tt&gt; and — like too
much of a good thing — callbacks can be bad for you.&lt;/p&gt;
&lt;p&gt;Another experiment was built on top of the old &lt;a class="reference external" href="https://docs.python.org/2/library/asyncore.html"&gt;asyncore&lt;/a&gt; and &lt;a class="reference external" href="https://docs.python.org/2/library/asynchat.html"&gt;asynchat&lt;/a&gt; standard library modules. A
branch of Blackhole 1.8 is indeed built and in working order built on top of
these very modules. Although never merged and released in the wild.&lt;/p&gt;
&lt;div class="section" id="enter-asyncio"&gt;
&lt;h2&gt;Enter asyncio&lt;/h2&gt;
&lt;p&gt;Originating as &lt;a class="reference external" href="https://github.com/python/asyncio"&gt;Tulip&lt;/a&gt; and merged in to
the Python standard library in &lt;a class="reference external" href="https://docs.python.org/3.4/whatsnew/3.4.html"&gt;Python 3.4&lt;/a&gt;, asyncio looked like a great
module to achieve what I wanted to achieve and to force me to actually use
Python 3.&lt;/p&gt;
&lt;p&gt;With &lt;a class="reference external" href="https://docs.python.org/3.5/whatsnew/3.5.html"&gt;Python 3.5&lt;/a&gt; came the
&lt;a class="reference external" href="https://docs.python.org/3.5/reference/compound_stmts.html#async-def"&gt;async def&lt;/a&gt;
declaration, the &lt;a class="reference external" href="https://docs.python.org/3.5/reference/expressions.html#await"&gt;await&lt;/a&gt; expression and
the &lt;a class="reference external" href="https://docs.python.org/3.5/reference/compound_stmts.html#async-for"&gt;async for&lt;/a&gt; statement.&lt;/p&gt;
&lt;p&gt;Since Blackhole is a tool written by me, for me and exposed as a service, it
made complete sense for me to jump-in-at-the-deep-end as it were and rewrite
the entirety of the software specifically for Python 3.5.&lt;/p&gt;
&lt;p&gt;Doing so meant I bypassed the need to use the &lt;tt class="docutils literal"&gt;@coroutine&lt;/tt&gt; decorator and the
&lt;tt class="docutils literal"&gt;yield from&lt;/tt&gt; expression, instead using their 3.5 equivalents in &lt;tt class="docutils literal"&gt;async def&lt;/tt&gt;
and &lt;tt class="docutils literal"&gt;await&lt;/tt&gt; respectively.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="all-i-see-are-bytes"&gt;
&lt;h2&gt;All I see are bytes&lt;/h2&gt;
&lt;p&gt;The trickest part for me was forcing myself to remember that the data passed
to and from the socket in Python 3 are bytes.&lt;/p&gt;
&lt;p&gt;That took a little while of constantly smashing my head in to my desk to
realise and remember. If something didn’t work during development, it was
always because I forgot to use &lt;tt class="docutils literal"&gt;.encode()&lt;/tt&gt; or &lt;tt class="docutils literal"&gt;.decode()&lt;/tt&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="getting-to-grips-with-asyncio"&gt;
&lt;h2&gt;Getting to grips with asyncio&lt;/h2&gt;
&lt;p&gt;I can honestly say that, with a little reading and checking out how some
libraries like &lt;a class="reference external" href="https://github.com/KeepSafe/aiohttp"&gt;aiohttp&lt;/a&gt; work, I got to
grips with the actual &lt;tt class="docutils literal"&gt;asyncio&lt;/tt&gt; module pretty quickly.&lt;/p&gt;
&lt;p&gt;I found using the &lt;tt class="docutils literal"&gt;async def&lt;/tt&gt; and &lt;tt class="docutils literal"&gt;await&lt;/tt&gt; syntax made it even easier for me
to read and write the code, because I instantly knew how a function I’d written
previously should work, simply by looking at it’s declaration. Something I
have sometimes forgotten when passing callbacks all over the place.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="show-me-the-code"&gt;
&lt;h2&gt;Show me the code&lt;/h2&gt;
&lt;p&gt;So, let’s take a specific task and look at the code that handles it, written
on top of asyncio in Python 3.5.&lt;/p&gt;
&lt;p&gt;First up I’ll show the method that waits for data to be received on the socket.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;wait&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;    Wait for data from the client.&lt;/span&gt;
&lt;span class="sd"&gt;    :returns: A line of received data.&lt;/span&gt;
&lt;span class="sd"&gt;    :rtype: :any:`str`&lt;/span&gt;
&lt;span class="sd"&gt;    .. note::&lt;/span&gt;
&lt;span class="sd"&gt;       Also handles client timeouts if they wait too long before sending&lt;/span&gt;
&lt;span class="sd"&gt;       data. -- https://blackhole.io/configuration-options.html#timeout&lt;/span&gt;
&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connection_closed&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wait_for&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_reader&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readline&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;
                                          &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                          &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TimeoutError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This function waits for data to be received from a client and returns it once
it’s been received.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;wait&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The declaration of this function is different to how you’d write it for Python
3.4 or lower.&lt;/p&gt;
&lt;p&gt;The equivalent of this declaration for Python 3.4 is as follows:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nd"&gt;@coroutine&lt;/span&gt;
&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;wait&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Both ways declare that the function is an asynchronous coroutine.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;connection_close&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This line does exactly what you’d expect, it runs the while loop until
&lt;tt class="docutils literal"&gt;self.connection_closed&lt;/tt&gt; does not equal &lt;tt class="docutils literal"&gt;False&lt;/tt&gt; or until the loop is exited
for another reason.&lt;/p&gt;
&lt;p&gt;This simply allows the connection handler to have connection state and stop
waiting for data if the connection is terminated elsewhere. Because the
entire program is asynchronous, the connection state may get modified elsewhere
while this method is still waiting for new data.&lt;/p&gt;
&lt;p&gt;The &lt;tt class="docutils literal"&gt;try except&lt;/tt&gt; block actually works with the while statement.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wait_for&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_reader&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readline&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt;
                                  &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;config&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                  &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It’s easier to explain the arguments of the &lt;tt class="docutils literal"&gt;wait_for&lt;/tt&gt; method before anything else.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;self._reader.readline()&lt;/tt&gt; reads a line of data from a socket stream,
&lt;tt class="docutils literal"&gt;self.config.timeout&lt;/tt&gt; is the maximum time in seconds to wait for data, for
the sake of this example, let’s call it &lt;tt class="docutils literal"&gt;10&lt;/tt&gt; and finally &lt;tt class="docutils literal"&gt;loop=self.loop&lt;/tt&gt;
sets the event loop that the code executes on.&lt;/p&gt;
&lt;p&gt;&lt;tt class="docutils literal"&gt;asyncio.wait_for&lt;/tt&gt; creates an asynchronous task that waits for the
&lt;tt class="docutils literal"&gt;self._reader.readline()&lt;/tt&gt; future to complete or raises an
&lt;tt class="docutils literal"&gt;asyncio.TimeoutError&lt;/tt&gt; if the future does not complete within the time limit.&lt;/p&gt;
&lt;p&gt;As a example.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wait_for&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_reader&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;readline&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Would wait for data for 10 seconds before raising a timeout error.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;asyncio&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TimeoutError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="kc"&gt;None&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;How the exception is handled shows how the &lt;tt class="docutils literal"&gt;while&lt;/tt&gt; statement is used. When a
timeout exception is raised, part of the code that handles that in the
&lt;tt class="docutils literal"&gt;self.timeout()&lt;/tt&gt; method changes the &lt;tt class="docutils literal"&gt;connection_closed&lt;/tt&gt; value.&lt;/p&gt;
&lt;p&gt;And finally the data received is returned.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Without going in to too much detail, below is the piece of code for handling
a timeout and terminating a connection, setting &lt;tt class="docutils literal"&gt;connection_closed&lt;/tt&gt; to exit
all possibly running &lt;tt class="docutils literal"&gt;while&lt;/tt&gt; loops.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;timeout&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;    Timeout a client connection.&lt;/span&gt;
&lt;span class="sd"&gt;    Sends the 421 timeout message to the client and closes the connection.&lt;/span&gt;
&lt;span class="sd"&gt;    https://blackhole.io/configuration-options.html#timeout&lt;/span&gt;
&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;push&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;421&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'Timeout'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;close&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""Close the connection from the client."""&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_writer&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;clients&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_writer&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;ValueError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;pass&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_writer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_writer&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;drain&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_connection_closed&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="lambda-woes-aka-use-functools-partial"&gt;
&lt;h2&gt;lambda woes aka. use functools.partial&lt;/h2&gt;
&lt;p&gt;Later in the development of the new version of blackhole I added a feature
called &lt;tt class="docutils literal"&gt;flags&lt;/tt&gt;. These flags allow multiple listeners to be configured with
different runtime parameters. i.e. bounce all emails received on port 587
while accepting all emails received on port 25.&lt;/p&gt;
&lt;p&gt;These flags allow flexibility to control how email is handled on any specified port.&lt;/p&gt;
&lt;p&gt;It was during development of this feature that I discovered using a lambda
rather than a partial object from functools didn’t work quite how I was
expecting it to.&lt;/p&gt;
&lt;p&gt;The original piece of code iterated over each socket object and created an
asyncio server object for that socket as below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""Create an asyncio 'server' for each socket."""&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;sock&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socks&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Smtp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;clients&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                               &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;servers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I wanted to change this code to pass in a set of flags that also belonged to
that specific socket, as below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""Create an asyncio 'server' for each socket."""&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;sock&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socks&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;flags&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'flags'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="k"&gt;lambda&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;Smtp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;clients&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                                            &lt;span class="n"&gt;flags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;flags&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                               &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;servers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Can you spot the problem?&lt;/p&gt;
&lt;p&gt;When using a lambda in that context, creating an anonymous function to pass to
the &lt;tt class="docutils literal"&gt;create_server&lt;/tt&gt; method, I discovered the flag arguments were incorrect.
In fact, none of the sockets had their correct flags set, they were being
jumbled up instead of being used as expected.&lt;/p&gt;
&lt;p&gt;I’m not sure why that’s the case and I never actually looked it up to find out
why either. I knew the way to fix it was to use &lt;tt class="docutils literal"&gt;functools.partial&lt;/tt&gt; and it’s
also a nice, cleaner way to do it so I did.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;async&lt;/span&gt; &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;_start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""Create an asyncio 'server' for each socket."""&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;sock&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socks&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;flags&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'flags'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
        &lt;span class="n"&gt;factory&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;functools&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;partial&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Smtp&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;clients&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;flags&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;flags&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;server&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="k"&gt;await&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;create_server&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;factory&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;servers&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;server&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="so-is-asyncio-any-good"&gt;
&lt;h2&gt;So is asyncio any good?&lt;/h2&gt;
&lt;p&gt;I’m going to roundup this article with this possibly loaded and difficult question.&lt;/p&gt;
&lt;p&gt;Well, is it?&lt;/p&gt;
&lt;p&gt;In my eyes, yes. I have to admit that this is the first time in a very long
time — possibly ever — that I have fallen so head-over-heels in-love with a
library or module.&lt;/p&gt;
&lt;p&gt;I went from someone that didn’t use Python 3 and grudgingly added Python 3
support to libraries I’ve written, to someone that only uses Python 3.5 now.&lt;/p&gt;
&lt;p&gt;I haven’t use asyncio with Python 3.4 and I probably never will, I like the
3.5-only syntax changes far too much to go backwards and start using the
&lt;tt class="docutils literal"&gt;@coroutine&lt;/tt&gt; decorator and &lt;tt class="docutils literal"&gt;yield from&lt;/tt&gt; statement.&lt;/p&gt;
&lt;p&gt;My only gripe is that currently &lt;span class="caps"&gt;STARTTLS&lt;/span&gt; is not supported. Hopefully that will
arrive in the not-so-distant future and I understand why it’s currently not supported.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="python3.5"></category><category term="3.5"></category><category term="asyncio"></category><category term="email"></category><category term="smtp"></category><category term="mta"></category></entry><entry><title>Farewell Ian</title><link href="https://kura.gg/2015/12/30/farewell-ian/" rel="alternate"></link><published>2015-12-30T22:34:00+00:00</published><updated>2015-12-30T22:34:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-12-30:/2015/12/30/farewell-ian/</id><content type="html">&lt;div class="figure"&gt;
&lt;img alt="Ian Murdock" src="/images/ian-murdock.png"/&gt;
&lt;p class="caption"&gt;Image by Stephen Shankland&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Today news arrived that broke my heart, Ian Murdock has passed away. I never
met Ian but he had an enormous impact on my life, through his work.&lt;/p&gt;
&lt;p&gt;Debian has been my operating system of choice for many years now, it runs on
all of my servers and my home computers. Ian’s vision for the operating system
is why I started using it and use it to this day. It’s why I’ve continued to
work on the operating system and create packages of all of my work for it.&lt;/p&gt;
&lt;p&gt;Ian is, without a doubt, one of the biggest influences on my career and on my life.&lt;/p&gt;
&lt;p&gt;Farewell sir, you will be missed.&lt;/p&gt;
</content><category term="misc"></category><category term="Ian Murdock"></category><category term="Debian"></category></entry><entry><title>SSHFP DNS records</title><link href="https://kura.gg/2015/10/18/sshfp-dns-records/" rel="alternate"></link><published>2015-10-18T03:30:00+01:00</published><updated>2015-10-18T03:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-10-18:/2015/10/18/sshfp-dns-records/</id><summary type="html">&lt;p&gt;&lt;a class="reference external" href="https://tools.ietf.org/html/rfc4255"&gt;&lt;span class="caps"&gt;SSHFP&lt;/span&gt;&lt;/a&gt; records are a defense against
people blindly typing ‘yes’ when asked if they want to continue connecting to
an &lt;span class="caps"&gt;SSH&lt;/span&gt; host who’s authenticity is unknown.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ssh some.host.tld
The authenticity of host 'some.host.tld (123.456.789.10)' can't be established.
ED25519 key fingerprint is 69:76:51:39:a4:c6:de:15:7c:50:4b:4a:a7:98:40:5e.
Are you sure you want to continue connecting (yes/no)?
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This prompt is likely to be extremely familiar to you and, most people seem to
just type ‘yes’ to move on with their lives, which defeats the whole purpose of
this prompt.&lt;/p&gt;
&lt;p&gt;If you use &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; you can bypass this prompt entirely by publishing your
server’s key fingerprints via &lt;span class="caps"&gt;DNS&lt;/span&gt; and having &lt;span class="caps"&gt;SSH&lt;/span&gt; authenticate them for you.&lt;/p&gt;
&lt;div class="section" id="generating-your-sshfp-record"&gt;
&lt;h2&gt;Generating your &lt;span class="caps"&gt;SSHFP&lt;/span&gt; record&lt;/h2&gt;
&lt;p&gt;You can get &lt;span class="caps"&gt;SSH&lt;/span&gt; to generate the &lt;span class="caps"&gt;DNS&lt;/span&gt; records for you, log in …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;&lt;a class="reference external" href="https://tools.ietf.org/html/rfc4255"&gt;&lt;span class="caps"&gt;SSHFP&lt;/span&gt;&lt;/a&gt; records are a defense against
people blindly typing ‘yes’ when asked if they want to continue connecting to
an &lt;span class="caps"&gt;SSH&lt;/span&gt; host who’s authenticity is unknown.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ssh some.host.tld
The authenticity of host 'some.host.tld (123.456.789.10)' can't be established.
ED25519 key fingerprint is 69:76:51:39:a4:c6:de:15:7c:50:4b:4a:a7:98:40:5e.
Are you sure you want to continue connecting (yes/no)?
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This prompt is likely to be extremely familiar to you and, most people seem to
just type ‘yes’ to move on with their lives, which defeats the whole purpose of
this prompt.&lt;/p&gt;
&lt;p&gt;If you use &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; you can bypass this prompt entirely by publishing your
server’s key fingerprints via &lt;span class="caps"&gt;DNS&lt;/span&gt; and having &lt;span class="caps"&gt;SSH&lt;/span&gt; authenticate them for you.&lt;/p&gt;
&lt;div class="section" id="generating-your-sshfp-record"&gt;
&lt;h2&gt;Generating your &lt;span class="caps"&gt;SSHFP&lt;/span&gt; record&lt;/h2&gt;
&lt;p&gt;You can get &lt;span class="caps"&gt;SSH&lt;/span&gt; to generate the &lt;span class="caps"&gt;DNS&lt;/span&gt; records for you, log in to the server in
question and run the command below to get similar content.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ssh-keygen -r some.host.tld
some.host.tld IN SSHFP 1 1 c53bfb3d5d053280b17db76909f707f3ac9cbb47
some.host.tld IN SSHFP 1 2 56310ad73fae7a3861f87c246f1fb7c0884706f9a65e94d75be4fb14ca973275
some.host.tld IN SSHFP 4 1 fe3a67a65b71631c8c16c173c09ad9885b72bd4e
some.host.tld IN SSHFP 4 2 7dd9225ef20b806e78fca60935c8b051565ab6077d7735e2c8d23fdfd26289d2
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Each line in response contains the following information.&lt;/p&gt;
&lt;table class="docutils"&gt;

&lt;thead&gt;
&lt;tr&gt;&lt;th class="head"&gt;Hostname&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;IN&lt;/span&gt; &lt;span class="caps"&gt;SSHFP&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;Algorithm&lt;/th&gt;
&lt;th class="head"&gt;Fingerprint type&lt;/th&gt;
&lt;th class="head"&gt;Hash&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;some.host.tld&lt;/td&gt;
&lt;td&gt;&lt;span class="caps"&gt;IN&lt;/span&gt; &lt;span class="caps"&gt;SSHFP&lt;/span&gt;&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;c53bfb3d5d053280b17db76909f707f3ac9cbb47&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class="section" id="algorithm"&gt;
&lt;h3&gt;Algorithm&lt;/h3&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;span class="caps"&gt;RSA&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;DSA&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;ECDSA&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;ED25519&lt;/span&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/div&gt;
&lt;div class="section" id="fingerprint-type"&gt;
&lt;h3&gt;Fingerprint type&lt;/h3&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;span class="caps"&gt;SHA&lt;/span&gt;-1&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;SHA&lt;/span&gt;-2&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I would advise you do not use &lt;span class="caps"&gt;DSA&lt;/span&gt; or &lt;span class="caps"&gt;ECDSA&lt;/span&gt; algorithms or &lt;span class="caps"&gt;SHA&lt;/span&gt;-1 fingerprints.&lt;/p&gt;
&lt;p&gt;Add the relevant records to your &lt;span class="caps"&gt;DNS&lt;/span&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="ssh-config"&gt;
&lt;h2&gt;~/.ssh/config&lt;/h2&gt;
&lt;p&gt;Add the following to your ~/.ssh/config file.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Host *
    VerifyHostKeyDNS yes
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This means &lt;span class="caps"&gt;SSH&lt;/span&gt; will always try to validate host keys from &lt;span class="caps"&gt;DNS&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Now, when you try to &lt;span class="caps"&gt;SSH&lt;/span&gt; to a host it should validate against &lt;span class="caps"&gt;SSHFP&lt;/span&gt; records automatically.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$ ssh -v some.host.tld
...
debug1: found 2 secure fingerprints in DNS
debug1: matching host key fingerprint found in DNS
...
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you’re not using &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; then automatic validation will not happen, instead
you will be told that records match but the fingerprints are insecure.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="dnssec"></category><category term="dns"></category><category term="sshfp"></category><category term="ssh"></category></entry><entry><title>DNSSEC with Rage4 and name.com</title><link href="https://kura.gg/2015/10/18/dnssec-with-rage4-and-name.com/" rel="alternate"></link><published>2015-10-18T03:10:00+01:00</published><updated>2015-10-18T03:10:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-10-18:/2015/10/18/dnssec-with-rage4-and-name.com/</id><summary type="html">&lt;p&gt;I currently use &lt;a class="reference external" href="https://www.name.com/"&gt;name.com&lt;/a&gt; as my registrar and I use
&lt;a class="reference external" href="https://rage4.com/"&gt;Rage4&lt;/a&gt; because Rage4 are awesome, they also support &lt;span class="caps"&gt;TLSA&lt;/span&gt;
and &lt;span class="caps"&gt;SSHFP&lt;/span&gt; records and of course, &lt;span class="caps"&gt;DNSSEC&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I’m writing this up because I found getting &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; from Rage4 to work with
name.com as my registrar was a pain and the name.com support were not very helpful,
linking me to a support article that I’d already read and did not help at all.&lt;/p&gt;
&lt;div class="section" id="rage4-1"&gt;
&lt;h2&gt;Rage4&lt;/h2&gt;
&lt;p&gt;I’m going to assume you’ve already got your records in Rage4, if not, the
interface is really easy so you’ll figure it out.&lt;/p&gt;
&lt;p&gt;Within the management section for your domain’s zone, there is a menu bar of
icons, the icon pictured below enabled &lt;span class="caps"&gt;DNSSEC&lt;/span&gt;.&lt;/p&gt;
&lt;img alt="Enabled DNSSEC" src="/images/rage4-dnssec-icon.png"/&gt;
&lt;p&gt;Clicking this will turn on &lt;span class="caps"&gt;DNSSEC&lt;/span&gt;. You will then have a new icon that will
allow you to display your &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; information.&lt;/p&gt;
&lt;img alt="Display DNSSEC info" src="/images/rage4-dnssec-info-icon.png"/&gt;
&lt;p&gt;Clicking this icon …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;I currently use &lt;a class="reference external" href="https://www.name.com/"&gt;name.com&lt;/a&gt; as my registrar and I use
&lt;a class="reference external" href="https://rage4.com/"&gt;Rage4&lt;/a&gt; because Rage4 are awesome, they also support &lt;span class="caps"&gt;TLSA&lt;/span&gt;
and &lt;span class="caps"&gt;SSHFP&lt;/span&gt; records and of course, &lt;span class="caps"&gt;DNSSEC&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I’m writing this up because I found getting &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; from Rage4 to work with
name.com as my registrar was a pain and the name.com support were not very helpful,
linking me to a support article that I’d already read and did not help at all.&lt;/p&gt;
&lt;div class="section" id="rage4-1"&gt;
&lt;h2&gt;Rage4&lt;/h2&gt;
&lt;p&gt;I’m going to assume you’ve already got your records in Rage4, if not, the
interface is really easy so you’ll figure it out.&lt;/p&gt;
&lt;p&gt;Within the management section for your domain’s zone, there is a menu bar of
icons, the icon pictured below enabled &lt;span class="caps"&gt;DNSSEC&lt;/span&gt;.&lt;/p&gt;
&lt;img alt="Enabled DNSSEC" src="/images/rage4-dnssec-icon.png"/&gt;
&lt;p&gt;Clicking this will turn on &lt;span class="caps"&gt;DNSSEC&lt;/span&gt;. You will then have a new icon that will
allow you to display your &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; information.&lt;/p&gt;
&lt;img alt="Display DNSSEC info" src="/images/rage4-dnssec-info-icon.png"/&gt;
&lt;p&gt;Clicking this icon will give you a window that is similar to the image below,
containing all of the &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; info you need. You will also have several extra
fields but you’ll only need the ones shown below.&lt;/p&gt;
&lt;img alt="DNSSEC info" src="/images/rage4-dnssec-info.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="name-com-1"&gt;
&lt;h2&gt;name.com&lt;/h2&gt;
&lt;p&gt;With the information from Rage4, you now need to go to name.com and configure
&lt;span class="caps"&gt;DNSSEC&lt;/span&gt; on your registrar.
&lt;a class="reference external" href="https://www.name.com/support/articles/205439058-DNSSEC"&gt;This support page&lt;/a&gt;
will guide you through their interface.&lt;/p&gt;
&lt;p&gt;The form is slightly confusing since it has different naming conventions than
the information provided by Rage4.&lt;/p&gt;
&lt;p&gt;Below is an image of the form with pre-filled data taken from the previous
image from Rage4.&lt;/p&gt;
&lt;img alt="Pre-filled DNSSEC form" src="/images/name.com-dnssec-form.png"/&gt;
&lt;p&gt;You can fill this form in and submit it for both type 1 (&lt;span class="caps"&gt;RSASHA1&lt;/span&gt;) and type 2
(&lt;span class="caps"&gt;RSASHA256&lt;/span&gt;.)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="testing"&gt;
&lt;h2&gt;Testing&lt;/h2&gt;
&lt;p&gt;It may take some time for your &lt;span class="caps"&gt;DNSSEC&lt;/span&gt; information to propagate but you can test
it using &lt;a class="reference external" href="https://dnssec-debugger.verisignlabs.com/"&gt;the debugger from Verisign&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="dnssec"></category><category term="dns"></category><category term="rage4. name.com"></category></entry><entry><title>Running a Tor exit node is not as scary as it sounds</title><link href="https://kura.gg/2015/02/02/running-a-tor-exit-node-is-not-as-scary-as-it-sounds/" rel="alternate"></link><published>2015-02-02T09:59:00+00:00</published><updated>2015-02-02T09:59:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-02-02:/2015/02/02/running-a-tor-exit-node-is-not-as-scary-as-it-sounds/</id><summary type="html">
&lt;p&gt;There is a variety of information out there about being a Tor exit node
operator. Articles like &lt;a class="reference external" href="https://testbit.eu/tor-exit-node-less-week/"&gt;this one&lt;/a&gt;
make the thought of running a Tor exit as scary prospect, it’s understandable,
some countries have laws that make running an exit scary too.&lt;/p&gt;
&lt;p&gt;I run &lt;a class="reference external" href="/tor/"&gt;a variety of relays&lt;/a&gt; in various countries in this crazy World
and thought I’d share my experiences.&lt;/p&gt;
&lt;div class="section" id="choosing-a-hosting-partner"&gt;
&lt;h2&gt;Choosing a hosting partner&lt;/h2&gt;
&lt;p&gt;I personally choose to use a third party hosting provider for my relays,
rather than using colocation. I just find this is easier and I don’t have to
think about the hardware much at all.&lt;/p&gt;
&lt;p&gt;Finding a provider can be a pain, there is a decent list on the &lt;a class="reference external" href="https://trac.torproject.org/projects/tor/wiki/doc/GoodBadISPs"&gt;Tor wiki&lt;/a&gt;. I use
some of the providers on this list but I’ve also found it can be a really
good idea to just contact a provider and talk to them …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;There is a variety of information out there about being a Tor exit node
operator. Articles like &lt;a class="reference external" href="https://testbit.eu/tor-exit-node-less-week/"&gt;this one&lt;/a&gt;
make the thought of running a Tor exit as scary prospect, it’s understandable,
some countries have laws that make running an exit scary too.&lt;/p&gt;
&lt;p&gt;I run &lt;a class="reference external" href="/tor/"&gt;a variety of relays&lt;/a&gt; in various countries in this crazy World
and thought I’d share my experiences.&lt;/p&gt;
&lt;div class="section" id="choosing-a-hosting-partner"&gt;
&lt;h2&gt;Choosing a hosting partner&lt;/h2&gt;
&lt;p&gt;I personally choose to use a third party hosting provider for my relays,
rather than using colocation. I just find this is easier and I don’t have to
think about the hardware much at all.&lt;/p&gt;
&lt;p&gt;Finding a provider can be a pain, there is a decent list on the &lt;a class="reference external" href="https://trac.torproject.org/projects/tor/wiki/doc/GoodBadISPs"&gt;Tor wiki&lt;/a&gt;. I use
some of the providers on this list but I’ve also found it can be a really
good idea to just contact a provider and talk to them. There is a company I
spoke to recently that is quite small and were really happy about the idea of
having an exit operator using them. When we have figured things out, I’ll
add them to the wiki.&lt;/p&gt;
&lt;p&gt;You’ll really want to find a provider with 1Gbps link and lots of bandwidth, I
like to find or pay for unmetered 1Gbps connectivity, but &lt;span class="caps"&gt;10TB&lt;/span&gt;/month should be
a good amount.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="a-good-exit-policy"&gt;
&lt;h2&gt;A good exit policy&lt;/h2&gt;
&lt;p&gt;The exit policy is everything, it can mean the difference between lots of abuse
complaints or very few. There is a &lt;a class="reference external" href="https://trac.torproject.org/projects/tor/wiki/doc/ReducedExitPolicy"&gt;good reduced exit policy on the Tor Wiki&lt;/a&gt;, I use
this on all of my nodes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="abuse-complaints"&gt;
&lt;h2&gt;Abuse complaints&lt;/h2&gt;
&lt;p&gt;With the reduced exit policy from the Tor wiki, I find abuse complaints are
actually very rare.&lt;/p&gt;
&lt;p&gt;The complaints I get are usually automatic emails from some hosting companies
that have &lt;span class="caps"&gt;HTTP&lt;/span&gt; brute force attempts logged. Not many companies use these
things but there are a few. There’s not much you can do, they are automated
and you should reply to them like you should reply to all abuse complaints but,
the response will never be read.&lt;/p&gt;
&lt;p&gt;The majority of complaints I get are related to &lt;a class="reference external" href="https://stopforumspam.com/"&gt;stopforumspam.com&lt;/a&gt;. Again, there’s not really anything you can do
about this except reply.&lt;/p&gt;
&lt;p&gt;Generally though, I will receive maybe one complaint per month on each node,
sometimes two, but that’s about it and it’s always one of the two abuse reports
I mentioned above.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="use-the-exit-notice"&gt;
&lt;h2&gt;Use the exit notice&lt;/h2&gt;
&lt;p&gt;I can’t really give any evidence as to whether or not this helps but, use the
&lt;a class="reference external" href="https://svn.torproject.org/svn/tor/branches/hidserv-perf/contrib/tor-exit-notice.html"&gt;Tor exit notice&lt;/a&gt;
on port 80. This means any admins that look up your &lt;span class="caps"&gt;IP&lt;/span&gt; may browse to it and see
it’s a Tor exit node and also has your email address in case they want to get
in touch about blocking their servers from your node.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="incorporate"&gt;
&lt;h2&gt;Incorporate&lt;/h2&gt;
&lt;p&gt;I haven’t had any reason to result to this myself but, I started my own
company (easy to do in the &lt;span class="caps"&gt;UK&lt;/span&gt;) and my servers are paid for through this company.&lt;/p&gt;
&lt;p&gt;It’s really not much hassle to set-up a company and a company bank account.&lt;/p&gt;
&lt;p&gt;Any of the donations I receive that aren’t Bitcoin are paid in to this company
too to continue paying for my nodes and put new ones online.&lt;/p&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="tor"></category></entry><entry><title>HPKP: HTTP Public Key Pinning with HAProxy</title><link href="https://kura.gg/2015/01/27/hpkp-http-public-key-pinning-with-haproxy/" rel="alternate"></link><published>2015-01-27T07:04:00+00:00</published><updated>2015-01-27T07:04:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-01-27:/2015/01/27/hpkp-http-public-key-pinning-with-haproxy/</id><summary type="html">
&lt;p&gt;Public Key Pinning is a security feature that tells a web browser to associate
a public cryptographic key with a server or servers. When a web browser visits
a website for the first time, it will read the &lt;span class="caps"&gt;HPKP&lt;/span&gt; header and store the hashes
for the certificates that are provided. Each time the browser then revisits
that website, the hash from the provided public key is compared against the
stored keys, if the hashes do not match, the web browser should display a warning.&lt;/p&gt;
&lt;p&gt;The &lt;span class="caps"&gt;HPKP&lt;/span&gt; header adds protection against man-in-the-middle (&lt;span class="caps"&gt;MITM&lt;/span&gt;) attacks but,
if incorrectly configured can make your website display a &lt;span class="caps"&gt;TLS&lt;/span&gt; error for a long
period of time.&lt;/p&gt;
&lt;p&gt;Here’s a look at what this website publishes as it’s &lt;span class="caps"&gt;HKPK&lt;/span&gt; header.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Public-Key-Pins: pin-sha256="cYf9T3Il8DaCnaMaM0LatIAru1vqmcu2JSwS7uvyEB0=";
                 pin-sha256="u2q8QZ8Hjp3o/efZjsch9NKjnZmrISJQjwoi/rmsKLU=";
                 max-age=15768000; includeSubDomains
&lt;/pre&gt;
&lt;p&gt;To explain it, the first &lt;cite&gt;pin-sha265&lt;/cite&gt; key is the hash of the public key that …&lt;/p&gt;</summary><content type="html">
&lt;p&gt;Public Key Pinning is a security feature that tells a web browser to associate
a public cryptographic key with a server or servers. When a web browser visits
a website for the first time, it will read the &lt;span class="caps"&gt;HPKP&lt;/span&gt; header and store the hashes
for the certificates that are provided. Each time the browser then revisits
that website, the hash from the provided public key is compared against the
stored keys, if the hashes do not match, the web browser should display a warning.&lt;/p&gt;
&lt;p&gt;The &lt;span class="caps"&gt;HPKP&lt;/span&gt; header adds protection against man-in-the-middle (&lt;span class="caps"&gt;MITM&lt;/span&gt;) attacks but,
if incorrectly configured can make your website display a &lt;span class="caps"&gt;TLS&lt;/span&gt; error for a long
period of time.&lt;/p&gt;
&lt;p&gt;Here’s a look at what this website publishes as it’s &lt;span class="caps"&gt;HKPK&lt;/span&gt; header.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Public-Key-Pins: pin-sha256="cYf9T3Il8DaCnaMaM0LatIAru1vqmcu2JSwS7uvyEB0=";
                 pin-sha256="u2q8QZ8Hjp3o/efZjsch9NKjnZmrISJQjwoi/rmsKLU=";
                 max-age=15768000; includeSubDomains
&lt;/pre&gt;
&lt;p&gt;To explain it, the first &lt;cite&gt;pin-sha265&lt;/cite&gt; key is the hash of the public key that
was used to generate the certificate this website uses, the second &lt;cite&gt;pin-sha256&lt;/cite&gt;
key is the hash of the public key that I have as a backup for when I either need
to generate a new certificate when the old one expires or if something happens
and I need to revoke the old key. &lt;cite&gt;max-age&lt;/cite&gt; tells the browser how long to store
the pin-sha256 details, for me that is 182 days and finally &lt;cite&gt;includeSubDomains&lt;/cite&gt;
tells the browser that these hashes are valid for this domain and all sub domains.&lt;/p&gt;
&lt;div class="section" id="extracting-the-public-key-information"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;Extracting the public key information&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;These commands will extract the public key information and encode it in base64.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;rsa&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;KEYFILE&lt;span class="w"&gt; &lt;/span&gt;-outform&lt;span class="w"&gt; &lt;/span&gt;der&lt;span class="w"&gt; &lt;/span&gt;-pubout&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;dgst&lt;span class="w"&gt; &lt;/span&gt;-sha256&lt;span class="w"&gt; &lt;/span&gt;-binary&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;base64
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above command will extract the public key from a private key generated with
&lt;cite&gt;openssl genrsa&lt;/cite&gt;, you can replace rsa with dsa for &lt;span class="caps"&gt;DSA&lt;/span&gt; keys.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;req&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;CSRFILE&lt;span class="w"&gt; &lt;/span&gt;-pubkey&lt;span class="w"&gt; &lt;/span&gt;-noout&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;rsa&lt;span class="w"&gt; &lt;/span&gt;-pubin&lt;span class="w"&gt; &lt;/span&gt;-outform&lt;span class="w"&gt; &lt;/span&gt;der&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;dgst&lt;span class="w"&gt; &lt;/span&gt;-sha256&lt;span class="w"&gt; &lt;/span&gt;-binary&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;base64
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above command will extract the public key from a &lt;span class="caps"&gt;CSR&lt;/span&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;x509&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;PEMFILE&lt;span class="w"&gt; &lt;/span&gt;-pubkey&lt;span class="w"&gt; &lt;/span&gt;-noout&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;rsa&lt;span class="w"&gt; &lt;/span&gt;-pubin&lt;span class="w"&gt; &lt;/span&gt;-outform&lt;span class="w"&gt; &lt;/span&gt;der&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;dgst&lt;span class="w"&gt; &lt;/span&gt;-sha256&lt;span class="w"&gt; &lt;/span&gt;-binary&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;base64
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And the above command here will extract the public key from an existing x509 certificate.&lt;/p&gt;
&lt;p&gt;All three of the above commands will generate something similar to below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
writing RSA key
cYf9T3Il8DaCnaMaM0LatIAru1vqmcu2JSwS7uvyEB0=
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="backup-key-s"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;Backup key(s)&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The backup key is actually really simple, you make any number of backups and
store them for future use in case of problems or emergencies with the primary
key file.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;genrsa&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;backup1.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can then use the command in the previous section to get the base64 encoded
public key of this backup key.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-hpkp-header"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-3"&gt;The &lt;span class="caps"&gt;HPKP&lt;/span&gt; header&lt;/a&gt;&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
Public-Key-Pins: pin-sha256="PUBLIC_KEY";
                 max-age=EXPIRE_TIME [; includeSubdomains]
                 [; report-uri="REPORT_URI"]
&lt;/pre&gt;
&lt;p&gt;As you can see the header is relatively simple, a definition of each option is below.&lt;/p&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;pin-sha256&lt;/dt&gt;
&lt;dd&gt;The quoted string is the Base64 encoded fingerprint. You can specify this
option multiple times.&lt;/dd&gt;
&lt;dt&gt;max-age&lt;/dt&gt;
&lt;dd&gt;The time, in seconds, that the browser should remember that this site is
only to be accessed using one of the pinned keys.&lt;/dd&gt;
&lt;dt&gt;includeSubdomains &lt;em&gt;optional&lt;/em&gt;&lt;/dt&gt;
&lt;dd&gt;If this optional parameter is specified, this rule applies to all of
the website’s subdomains.&lt;/dd&gt;
&lt;dt&gt;report-uri &lt;em&gt;optional&lt;/em&gt;&lt;/dt&gt;
&lt;dd&gt;If this optional parameter is specified, pin validation failures are
reported to this &lt;span class="caps"&gt;URL&lt;/span&gt;. This won’t be covered here though.&lt;/dd&gt;
&lt;/dl&gt;
&lt;/div&gt;
&lt;div class="section" id="haproxy"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-4"&gt;HAProxy&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;In HAproxy you simply using the &lt;cite&gt;rspadd&lt;/cite&gt; config option inside the &lt;cite&gt;frontend&lt;/cite&gt;
declaration.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
rspadd Public-Key-Pins:\ pin-sha256="KEY=";\ pin-sha256="BACKUP_KEY";\ max-age=15768000;\ includeSubDomains
&lt;/pre&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="haproxy"></category><category term="http"></category><category term="tls"></category><category term="ssl"></category><category term="hpkp"></category><category term="public key pinning"></category></entry><entry><title>Debian Wheezy encrypted Maildir using encfs</title><link href="https://kura.gg/2015/01/26/debian-wheezy-encrypted-maildir-using-encfs/" rel="alternate"></link><published>2015-01-26T21:25:00+00:00</published><updated>2015-01-26T21:25:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-01-26:/2015/01/26/debian-wheezy-encrypted-maildir-using-encfs/</id><summary type="html">
&lt;p&gt;This is really a follow up article to &lt;a class="reference external" href="/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/"&gt;one I wrote earlier this year&lt;/a&gt;
but is really applicable to any similar set-up, with some modifications. The
only configuration similarity this requires is that mail for all users is
stored on the filesystem in the same place, rather than to separate locations
i.e. each user having ~/.Maildir.&lt;/p&gt;
&lt;div class="section" id="encfs"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;EncFS&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;encfs
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed, you’ll need to make a directory for encrypted and decrypted
mail to live.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/var/mail/encrypted&lt;span class="w"&gt; &lt;/span&gt;/var/mail/decrypted
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll need to set up permissions so your mail user can access the fuse device
and the new directories.&lt;/p&gt;
&lt;p&gt;For me, this user and group are called &lt;em&gt;vmail&lt;/em&gt; but yours may be different.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chgrp&lt;span class="w"&gt; &lt;/span&gt;mail&lt;span class="w"&gt; &lt;/span&gt;/var/mail/decrypted
sudo&lt;span class="w"&gt; &lt;/span&gt;g+rw&lt;span class="w"&gt; &lt;/span&gt;/var/mail/decrypted
sudo&lt;span class="w"&gt; &lt;/span&gt;usermod&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;-g&lt;span class="w"&gt; &lt;/span&gt;fuse&lt;span class="w"&gt; &lt;/span&gt;vmail
sudo&lt;span class="w"&gt; &lt;/span&gt;chgrp&lt;span class="w"&gt; &lt;/span&gt;fuse&lt;span class="w"&gt; &lt;/span&gt;/dev/fuse
sudo&lt;span class="w"&gt; &lt;/span&gt;chmod&lt;span class="w"&gt; &lt;/span&gt;g+rw&lt;span class="w"&gt; &lt;/span&gt;/dev/fuse
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This is really a follow up article to &lt;a class="reference external" href="/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/"&gt;one I wrote earlier this year&lt;/a&gt;
but is really applicable to any similar set-up, with some modifications. The
only configuration similarity this requires is that mail for all users is
stored on the filesystem in the same place, rather than to separate locations
i.e. each user having ~/.Maildir.&lt;/p&gt;
&lt;div class="section" id="encfs"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;EncFS&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;encfs
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed, you’ll need to make a directory for encrypted and decrypted
mail to live.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/var/mail/encrypted&lt;span class="w"&gt; &lt;/span&gt;/var/mail/decrypted
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll need to set up permissions so your mail user can access the fuse device
and the new directories.&lt;/p&gt;
&lt;p&gt;For me, this user and group are called &lt;em&gt;vmail&lt;/em&gt; but yours may be different.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chgrp&lt;span class="w"&gt; &lt;/span&gt;mail&lt;span class="w"&gt; &lt;/span&gt;/var/mail/decrypted
sudo&lt;span class="w"&gt; &lt;/span&gt;g+rw&lt;span class="w"&gt; &lt;/span&gt;/var/mail/decrypted
sudo&lt;span class="w"&gt; &lt;/span&gt;usermod&lt;span class="w"&gt; &lt;/span&gt;-a&lt;span class="w"&gt; &lt;/span&gt;-g&lt;span class="w"&gt; &lt;/span&gt;fuse&lt;span class="w"&gt; &lt;/span&gt;vmail
sudo&lt;span class="w"&gt; &lt;/span&gt;chgrp&lt;span class="w"&gt; &lt;/span&gt;fuse&lt;span class="w"&gt; &lt;/span&gt;/dev/fuse
sudo&lt;span class="w"&gt; &lt;/span&gt;chmod&lt;span class="w"&gt; &lt;/span&gt;g+rw&lt;span class="w"&gt; &lt;/span&gt;/dev/fuse
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next you need to build the encrypted volume.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;encfs&lt;span class="w"&gt; &lt;/span&gt;/var/mail/encrypted&lt;span class="w"&gt; &lt;/span&gt;/var/mail/decrypted&lt;span class="w"&gt; &lt;/span&gt;--public
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When prompted for an option, choose &lt;strong&gt;p&lt;/strong&gt; for paranoid mode.&lt;/p&gt;
&lt;p&gt;Finally, &lt;strong&gt;don’t forget to choose a good, strong passphrase. Really this
should be a phrase, not a password.&lt;/strong&gt; It’ll be needed each time you unmount the
volume or reboot the machine.&lt;/p&gt;
&lt;p&gt;It is important to include the &lt;cite&gt;—public&lt;/cite&gt; argument, this forces Fuse to be more
Linux multi-user friendly, it’s kind of a bad option to use due to it being a
hammer option. You could always try to do this properly but for me I think it’s
fine in this case.&lt;/p&gt;
&lt;p&gt;If you unmount the volume for any reason, you can remount it using the same
command that was used to create the volume.&lt;/p&gt;
&lt;p&gt;Now you’ll just want to copy over your existing mail in to &lt;cite&gt;/var/mail/decrypted/&lt;/cite&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="dovecot"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;Dovecot&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The final step to getting this to work is to tell Dovecot to use this mail location.&lt;/p&gt;
&lt;p&gt;With my setup there are two pleces to modify this, the first is
&lt;cite&gt;/etc/dovecot/conf.d/10-mail.conf&lt;/cite&gt;. It’s really hard to tell you what this
exact value should be, due to set-ups being different but if you followed my
previous article, it’ll look like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mail_location = maildir:/var/mail/decrypted/vhosts/%d/%n/maildir
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The other file that is likely to need modification is
&lt;cite&gt;/etc/dovecot/conf.d/auth-sql.conf.ext&lt;/cite&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;userdb {
    driver = static
    args = uid=vmail gid=vmail home=/var/spool/mail/decrypted/vhosts/%d/%n/maildir
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That’s everything you technically need to do, just restart Dovecot.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/dovecot&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="tomcat-solr"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-3"&gt;Tomcat/Solr&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If you use Solr for &lt;span class="caps"&gt;IMAP&lt;/span&gt; &lt;span class="caps"&gt;SEARCH&lt;/span&gt;, you’ll just want to move that index inside of
the new directory.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/tomcat6&lt;span class="w"&gt; &lt;/span&gt;stop
sudo&lt;span class="w"&gt; &lt;/span&gt;mv&lt;span class="w"&gt; &lt;/span&gt;/var/lib/solr&lt;span class="w"&gt; &lt;/span&gt;/var/mail/decrypted/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll need to tell Solr to get it’s data from this directory, this is done in
&lt;cite&gt;/etc/solr/conf/solrconfig.xml&lt;/cite&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;dataDir&amp;gt;&lt;/span&gt;/var/mail/decrypted/solr&lt;span class="nt"&gt;&amp;lt;/dataDir&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Start tomcat again.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/tomcat6&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally, it’s always good when you mess with Solr’s indexes like this to
run optimize task.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;curl&lt;span class="w"&gt; &lt;/span&gt;https://localhost:8080/solr/update?optimize&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="init-d"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-4"&gt;init.d&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Something to remember is that encfs will not mount on it’s own, that’s the
entire point of doing this. This means that Postfix, Dovecot, Solr etc will
not have any data to read on a server reboot.&lt;/p&gt;
&lt;p&gt;I just “fix” this by forcing the init scripts for those processes to look for
the mount point and fail if it’s not there.&lt;/p&gt;
&lt;p&gt;In each init script for Postfix, Dovecot, Tomcat6 and anything else that will
try to read data from /var/mail/decrypted you’ll want to find where
&lt;cite&gt;/lib/lsb/init-functions&lt;/cite&gt; is loaded and a check after it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;!&lt;span class="w"&gt; &lt;/span&gt;mount&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"on /var/mail/decrypted"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/dev/null
&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;log_daemon_msg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"/var/mail/decrypted not mounted"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;log_end_msg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It’ll look similar to below if you put it in the right place.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Define LSB log_* functions.&lt;/span&gt;
&lt;span class="c1"&gt;# Depend on lsb-base (&amp;gt;= 3.0-6) to ensure that this file is present.&lt;/span&gt;
.&lt;span class="w"&gt; &lt;/span&gt;/lib/lsb/init-functions

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;!&lt;span class="w"&gt; &lt;/span&gt;mount&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"on /var/mail/decrypted"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/dev/null
&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;log_daemon_msg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"/var/mail/decrypted not mounted"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;log_end_msg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;exit&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="wheezy"></category><category term="postfix"></category><category term="dovecot"></category><category term="mail"></category><category term="encrypted"></category></entry><entry><title>Block yourself from emailing someone using Postfix</title><link href="https://kura.gg/2015/01/20/block-yourself-from-emailing-someone-using-postfix/" rel="alternate"></link><published>2015-01-20T23:38:00+00:00</published><updated>2015-01-20T23:38:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-01-20:/2015/01/20/block-yourself-from-emailing-someone-using-postfix/</id><summary type="html">&lt;p&gt;I think most of us have been in a position where we really shouldn’t continue
communicating with someone or contact that person when drunk… You know what I
mean, ex relationships etc (it happens.)&lt;/p&gt;
&lt;p&gt;With Postfix you can block yourself from emailing that person again, which is
quite useful.&lt;/p&gt;
&lt;p&gt;In &lt;cite&gt;/etc/postfix/main.cf&lt;/cite&gt; add make the start of your &lt;cite&gt;smtpd_recipient_restrictions&lt;/cite&gt;
look like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;smtpd_recipient_restrictions =
    check_recipient_access hash:/etc/postfix/recipient_access,
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create a new file &lt;cite&gt;/etc/postfix/recipient_access&lt;/cite&gt; and add the email address you
wish to block, the word &lt;cite&gt;&lt;span class="caps"&gt;REJECT&lt;/span&gt;&lt;/cite&gt; in capitals and optionally; a  reason. Example below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;test@example.com REJECT Don't be silly... You're probably drunk.
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For every address you wish to block yourself from emailing, simply add them on
a new line.&lt;/p&gt;
&lt;p&gt;You can see the email is blocked from being sent in &lt;cite&gt;/var/log/mail.log&lt;/cite&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;NOQUEUE: reject: RCPT from 123.123.123.123: 554 5 …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;I think most of us have been in a position where we really shouldn’t continue
communicating with someone or contact that person when drunk… You know what I
mean, ex relationships etc (it happens.)&lt;/p&gt;
&lt;p&gt;With Postfix you can block yourself from emailing that person again, which is
quite useful.&lt;/p&gt;
&lt;p&gt;In &lt;cite&gt;/etc/postfix/main.cf&lt;/cite&gt; add make the start of your &lt;cite&gt;smtpd_recipient_restrictions&lt;/cite&gt;
look like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;smtpd_recipient_restrictions =
    check_recipient_access hash:/etc/postfix/recipient_access,
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create a new file &lt;cite&gt;/etc/postfix/recipient_access&lt;/cite&gt; and add the email address you
wish to block, the word &lt;cite&gt;&lt;span class="caps"&gt;REJECT&lt;/span&gt;&lt;/cite&gt; in capitals and optionally; a  reason. Example below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;test@example.com REJECT Don't be silly... You're probably drunk.
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For every address you wish to block yourself from emailing, simply add them on
a new line.&lt;/p&gt;
&lt;p&gt;You can see the email is blocked from being sent in &lt;cite&gt;/var/log/mail.log&lt;/cite&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;NOQUEUE: reject: RCPT from 123.123.123.123: 554 5.7.1 &amp;lt;test@example.com&amp;gt;: Recipient address rejected: Don't be silly... You're probably drunk.; from=&amp;lt;me@domain.tld&amp;gt; to=&amp;lt;test@example.com&amp;gt; proto=ESMTP helo=&amp;lt;[123.123.123.123]&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Each time you change the file, you need to generate a new hashed version and
reload Postfix.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;postmap&lt;span class="w"&gt; &lt;/span&gt;hash:/etc/postfix/recipient_access
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/postfix&lt;span class="w"&gt; &lt;/span&gt;reload
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="postfix"></category><category term="smtp"></category></entry><entry><title>Debian Wheezy TLS mailserver with MySQL, ClamAV, DomainKeys, DKIM, SPF and Solr-powered IMAP SEARCH</title><link href="https://kura.gg/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/" rel="alternate"></link><published>2015-01-03T19:48:00+00:00</published><updated>2015-01-03T19:48:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-01-03:/2015/01/03/debian-wheezy-tls-mailserver-with-mysql-clamav-domainkeys-dkim-spf-solr-imap-search/</id><summary type="html">
&lt;p&gt;This mail platform does use a fair amount of memory, the memory usage is ClamAV
and Solr, the latter being used for &lt;span class="caps"&gt;IMAP&lt;/span&gt; &lt;span class="caps"&gt;SEARCH&lt;/span&gt;. I personally use 2 &lt;span class="caps"&gt;GB&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I’ll warn you all now, this is a long article.&lt;/p&gt;
&lt;div class="section" id="ssl"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo openssl genrsa -out /etc/ssl/private/mail.key 4096
sudo openssl req -new -key /etc/ssl/private/mail.key -out /tmp/mail.csr
sudo openssl x509 -req -days 365 -in /tmp/mail.csr -signkey /etc/ssl/private/mail.key -out /etc/ssl/certs/mail.crt
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mysql"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;MySQL&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install mysql-server
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll be prompted several times for a password for MySQL during the installation,
just come up with something nice and secure.&lt;/p&gt;
&lt;p&gt;The first thing to set-up will be the MySQL database and schema.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mysql -u root -p
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next up, create the database.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;CREATE DATABASE mailserver CHARACTER SET utf8 COLLATE utf8_general_ci;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And grant some privileges, you’ll need …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This mail platform does use a fair amount of memory, the memory usage is ClamAV
and Solr, the latter being used for &lt;span class="caps"&gt;IMAP&lt;/span&gt; &lt;span class="caps"&gt;SEARCH&lt;/span&gt;. I personally use 2 &lt;span class="caps"&gt;GB&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I’ll warn you all now, this is a long article.&lt;/p&gt;
&lt;div class="section" id="ssl"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo openssl genrsa -out /etc/ssl/private/mail.key 4096
sudo openssl req -new -key /etc/ssl/private/mail.key -out /tmp/mail.csr
sudo openssl x509 -req -days 365 -in /tmp/mail.csr -signkey /etc/ssl/private/mail.key -out /etc/ssl/certs/mail.crt
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mysql"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;MySQL&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install mysql-server
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll be prompted several times for a password for MySQL during the installation,
just come up with something nice and secure.&lt;/p&gt;
&lt;p&gt;The first thing to set-up will be the MySQL database and schema.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mysql -u root -p
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next up, create the database.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;CREATE DATABASE mailserver CHARACTER SET utf8 COLLATE utf8_general_ci;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And grant some privileges, you’ll need to set a password yourself.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;GRANT ALL PRIVILEGES ON mailserver.* TO 'mailuser'@'localhost' IDENTIFIED BY '&amp;lt;PASSWORD_HERE&amp;gt;';
FLUSH PRIVILEGES;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next, set up the schema.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;CREATE TABLE `virtual_domains` (
    `id` int(11) NOT NULL auto_increment,
    `name` varchar(50) NOT NULL,
    PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `virtual_users` (
    `id` int(11) NOT NULL auto_increment,
    `domain_id` int(11) NOT NULL,
    `password` varchar(106) NOT NULL,
    `email` varchar(100) NOT NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `email` (`email`),
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `virtual_aliases` (
    `id` int(11) NOT NULL auto_increment,
    `domain_id` int(11) NOT NULL,
    `source` varchar(100) NOT NULL,
    `destination` varchar(100) NOT NULL,
    PRIMARY KEY (`id`),
    FOREIGN KEY (domain_id) REFERENCES virtual_domains(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally, add a domain name, user and alias.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;INSERT INTO virtual_domains (name) VALUES ('example.com');
INSERT INTO virtual_users (domain_id, password, email) VALUES (1, ENCRYPT('&amp;lt;PASSWORD_HERE&amp;gt;', CONCAT('$6$', SUBSTRING(SHA(RAND()), -16))), 'user@example.com');
INSERT INTO virtual_aliases (domain_id, source, destination) VALUES (1, 'alias@exampe.com', 'user@example.com');
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Drop back to the Bash prompt using &lt;cite&gt;&lt;span class="caps"&gt;CTRL&lt;/span&gt;-D&lt;/cite&gt; or with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;EXIT
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="postfix"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-3"&gt;Postfix&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install postfix postfix-mysql postfix-policyd-spf-python
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When prompted for a Postfix configuration, just select &lt;cite&gt;Internet Site&lt;/cite&gt;. You’ll
also be prompted for a mail name, I’ll be using &lt;cite&gt;mail.example.com&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;Back up the original &lt;cite&gt;main.cf&lt;/cite&gt; and &lt;cite&gt;master.cf&lt;/cite&gt; for Postfix.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo mv /etc/postfix/main.cf{,.orig}
sudo mv /etc/postfix/master.cf{,.org}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create a new &lt;cite&gt;/etc/postfix/main.cf&lt;/cite&gt; with the content below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;smtpd_banner = $myhostname ESMTP
biff = no
append_dot_mydomain = no
readme_directory = no

smtpd_use_tls = yes
smtpd_tls_cert_file = /etc/ssl/certs/mail.crt
smtpd_tls_key_file = /etc/ssl/private/mail.key
smtpd_tls_auth_only = yes
smtpd_tls_security_level = encrypt
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtpd_tls_session_cache_timeout = 3600s
smtpd_helo_required = yes
smtpd_tls_received_header = yes
smtpd_tls_security_level = may
smtpd_tls_mandatory_ciphers = high
smtpd_tls_mandatory_exclude_ciphers = aNULL, MD5, RC4
smtpd_tls_mandatory_protocols = TLSv1
smtpd_tls_loglevel = 1
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname

smtp_use_tls = yes
smtp_tls_cert_file = /etc/ssl/certs/mail.crt
smtp_tls_key_file = /etc/ssl/private/mail.key

tls_random_source = dev:/dev/urandom
broken_sasl_auth_clients = yes

smtpd_recipient_restrictions =
    permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_unknown_sender_domain,
    check_policy_service unix:private/policy-spf

smtpd_sender_restrictions =
    permit_sasl_authenticated,
    permit_mynetworks

policy-spf_time_limit = 3600s
myhostname = mail.example.com
myorigin = /etc/mailname
mydestination = localhost
relayhost =
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
mailbox_size_limit = 0
recipient_delimiter = +
inet_interfaces = all

virtual_transport = lmtp:unix:private/dovecot-lmtp
virtual_mailbox_domains = mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf
virtual_mailbox_maps = mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf
virtual_alias_maps = mysql:/etc/postfix/mysql-virtual-alias-maps.cf

smtpd_recipient_limit = 2000
smtpd_milters =
    unix:clamav/clamav-milter.ctl,
    unix:spamass/spamass.sock
milter_connect_macros = j {daemon_name} v {if_name} _
milter_default_action = tempfail
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create a new &lt;cite&gt;/etc/postfix/master.cf&lt;/cite&gt; and make it look like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;smtp      inet  n       -       -       -       -       smtpd
    -o strict_rfc821_envelopes=yes
submission inet n       -       -       -       -       smtpd
    -o syslog_name=postfix/submission
    -o smtpd_tls_security_level=encrypt
    -o smtpd_sasl_auth_enable=yes
    -o content_filter=dksign:[127.0.0.1]:10027
    -o smtpd_client_restrictions=permit_sasl_authenticated,reject
    -o milter_macro_daemon_name=ORIGINATING
smtps     inet  n       -       -       -       -       smtpd
    -o syslog_name=postfix/smtps
    -o smtpd_tls_wrappermode=yes
    -o smtpd_sasl_auth_enable=yes
    -o content_filter=dksign:[127.0.0.1]:10027
    -o smtpd_client_restrictions=permit_sasl_authenticated,reject
    -o milter_macro_daemon_name=ORIGINATING
pickup    fifo  n       -       -       60      1       pickup
cleanup   unix  n       -       -       -       0       cleanup
qmgr      fifo  n       -       n       300     1       qmgr
tlsmgr    unix  -       -       -       1000?   1       tlsmgr
rewrite   unix  -       -       -       -       -       trivial-rewrite
bounce    unix  -       -       -       -       0       bounce
defer     unix  -       -       -       -       0       bounce
trace     unix  -       -       -       -       0       bounce
verify    unix  -       -       -       -       1       verify
flush     unix  n       -       -       1000?   0       flush
proxymap  unix  -       -       n       -       -       proxymap
proxywrite unix -       -       n       -       1       proxymap
smtp      unix  -       -       -       -       -       smtp
relay     unix  -       -       -       -       -       smtp
showq     unix  n       -       -       -       -       showq
error     unix  -       -       -       -       -       error
retry     unix  -       -       -       -       -       error
discard   unix  -       -       -       -       -       discard
local     unix  -       n       n       -       -       local
virtual   unix  -       n       n       -       -       virtual
lmtp      unix  -       -       -       -       -       lmtp
anvil     unix  -       -       -       -       1       anvil
scache    unix  -       -       -       -       1       scache
maildrop  unix  -       n       n       -       -       pipe
    flags=DRhu user=vmail argv=/usr/bin/maildrop -d ${recipient}
uucp      unix  -       n       n       -       -       pipe
    flags=Fqhu user=uucp argv=uux -r -n -z -a$sender - $nexthop!rmail ($recipient)
ifmail    unix  -       n       n       -       -       pipe
    flags=F user=ftn argv=/usr/lib/ifmail/ifmail -r $nexthop ($recipient)
bsmtp     unix  -       n       n       -       -       pipe
    flags=Fq. user=bsmtp argv=/usr/lib/bsmtp/bsmtp -t$nexthop -f$sender $recipient
scalemail-backend unix      -       n       n       -       2       pipe
    flags=R user=scalemail argv=/usr/lib/scalemail/bin/scalemail-store ${nexthop} ${user} ${extension}
mailman   unix  -       n       n       -       -       pipe
    flags=FR user=list argv=/usr/lib/mailman/bin/postfix-to-mailman.py
    ${nexthop} ${user}
policy-spf unix -       n       n       -       -       spawn
    user=nobody argv=/usr/bin/policyd-spf
dksign    unix  -       -       n       -       4       smtp
    -o smtp_send_xforward_command=yes
    -o smtp_discard_ehlo_keywords=8bitmime,starttls
127.0.0.1:10028 inet n  -        n      -       10      smtpd
    -o content_filter=
    -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks
    -o smtpd_helo_restrictions=
    -o smtpd_client_restrictions=
    -o smtpd_sender_restrictions=
    -o smtpd_recipient_restrictions=permit_mynetworks,reject
    -o mynetworks=127.0.0.0/8
    -o smtpd_authorized_xforward_hosts=127.0.0.0/8
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next you’ll create the config files to query MySQL.&lt;/p&gt;
&lt;p&gt;Create &lt;cite&gt;/etc/postfix/mysql-virtual-mailbox-domains.cf&lt;/cite&gt; with the content below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;user = mailuser
password = &amp;lt;MYSQL_PASSWORD&amp;gt;
hosts = 127.0.0.1
dbname = mailserver
query = SELECT 1 FROM virtual_domains WHERE name='%s'
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create &lt;cite&gt;/etc/postfix/mysql-virtual-mailbox-maps.cf&lt;/cite&gt; with the content below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;user = mailuser
password = &amp;lt;MYSQL_PASSWORD&amp;gt;
hosts = 127.0.0.1
dbname = mailserver
query = SELECT 1 FROM virtual_users WHERE email='%s'
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create &lt;cite&gt;/etc/postfix/mysql-virtual-alias-maps.cf&lt;/cite&gt; with the content below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;user = mailuser
password = &amp;lt;MYSQL_PASSWORD&amp;gt;
hosts = 127.0.0.1
dbname = mailserver
query = SELECT destination FROM virtual_aliases WHERE source='%s'
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Reload Postfix and test that the domain and users work.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo /etc/init.d/postfix reload
postmap -q example.com mysql:/etc/postfix/mysql-virtual-mailbox-domains.cf
postmap -q user@example.com mysql:/etc/postfix/mysql-virtual-mailbox-maps.cf
postmap -q alias@example.com mysql:/etc/postfix/mysql-virtual-alias-maps.cf
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see output similar to below&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;1
1
user@example.com
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="dovecot"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-4"&gt;Dovecot&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install dovecot-core dovecot-imapd dovecot-lmtpd dovecot-mysql
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Backup the default Dovecot config files.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo cp /etc/dovecot/dovecot.conf{,.orig}
sudo cp /etc/dovecot/conf.d/10-mail.conf{,.orig}
sudo cp /etc/dovecot/conf.d/10-auth.conf{,.orig}
sudo cp /etc/dovecot/dovecot-sql.conf.ext{,.orig}
sudo cp /etc/dovecot/conf.d/10-master.conf{,.orig}
sudo cp /etc/dovecot/conf.d/10-ssl.conf {,.orig}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For each domain you want to serve mail for, you will need to create a
directory for it to be stored in.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo mkdir -p /var/mail/vhosts/example.com
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Add a user and group for the mail and give permissions on the mail directory.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo groupadd -g 5000 vmail
sudo useradd -g vmail -u 5000 vmail -d /var/mail
sudo chown -R vmail:vmail /var/mail
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Modify the line in &lt;cite&gt;/etc/dovecot/dovecot.conf&lt;/cite&gt; so it looks like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;!include_try /usr/share/dovecot/protocols.d/*.protocol
protocols = imap lmtp
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Modify &lt;cite&gt;/etc/dovecot/dovecot.conf&lt;/cite&gt; so it has the following lines.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mail_location = maildir:/var/mail/vhosts/%d/%n
mail_privileged_group = mail
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Edit &lt;cite&gt;/etc/dovecot/conf.d/10-auth.conf&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;You’ll need to uncomment the following line.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;disable_plaintext_auth = yes
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Set &lt;cite&gt;auth_mechanisms&lt;/cite&gt; to look like below&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;auth_mechanisms = plain login
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next up, make sure the include lines look like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;#!include auth-system.conf.ext
!include auth-sql.conf.ext
#!include auth-ldap.conf.ext
#!include auth-passwdfile.conf.ext
#!include auth-checkpassword.conf.ext
#!include auth-vpopmail.conf.ext
#!include auth-static.conf.ext
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create &lt;cite&gt;/etc/dovecot/conf.d/auth-sql.conf.ext&lt;/cite&gt; and add the content below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;passdb {
    driver = sql
    args = /etc/dovecot/dovecot-sql.conf.ext
}

userdb {
    driver = static
    args = uid=vmail gid=vmail home=/var/mail/vhosts/%d/%n
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Edit &lt;cite&gt;/etc/dovecot/dovecot-sql.conf.ext&lt;/cite&gt; and set the following values.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;driver = mysql
connect = host=127.0.0.1 dbname=mailserver user=mailuser password=&amp;lt;PASSWORD&amp;gt;
default_pass_scheme = SHA512-CRYPT
password_query = SELECT email as user, password FROM virtual_users WHERE email='%u'
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Add the following content to &lt;cite&gt;/etc/dovecot/conf.d/10-master.conf&lt;/cite&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;service imap-login {
    inet_listener imaps {
        port = 993
        ssl = yes
    }
}

service lmtp {
    unix_listener /var/spool/postfix/private/dovecot-lmtp {
        mode = 0600
        user = postfix
        group = postfix
    }
}

service auth {
    unix_listener /var/spool/postfix/private/auth {
        mode = 0666
        user = postfix
        group = postfix
    }
    unix_listener auth-userdb {
        mode = 0600
        user = vmail
    }
    user = dovecot
}

service auth-worker {
    user = vmail
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Modify &lt;cite&gt;/etc/dovecot/conf.d/10-ssl.conf&lt;/cite&gt; to have the following lines.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssl_cert = &amp;lt;/etc/ssl/certs/mail.crt
ssl_key = &amp;lt;/etc/ssl/private/mail.key
ssl = required
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For fulltext searching, you’ll want to enable wheezy-backports and install
&lt;cite&gt;dovecot-solr&lt;/cite&gt; from there.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo echo "deb https://ftp.debian.org/debian wheezy-backports main contrib non-free" &amp;gt;&amp;gt; /etc/apt/sources.list
sudo apt-get update
sudo apt-get install dovecot-solr solr-tomcat
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There is a bug in &lt;cite&gt;dovecot-solr&lt;/cite&gt; where it doesn’t set up the Solr schema for,
you’ll have to do it by downloading &lt;cite&gt;orig.tar.gz&lt;/cite&gt; from &lt;a class="reference external" href="https://packages.debian.org/wheezy/dovecot-solr"&gt;the Debian website&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Extract the archive and copy the included schema in to Solr.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo cp docs/solr-schema.xml /etc/solr/conf/schema.xml
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For security reasons, modify &lt;cite&gt;/etc/tomcat6/server.xml&lt;/cite&gt; to have the local address
in the Connectory.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&amp;lt;Connector address="127.0.0.1" port="8080" protocol="HTTP/1.1"
           connectionTimeout="20000"
           URIEncoding="UTF-8"
           redirectPort="8443" /&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Modify &lt;cite&gt;/etc/dovecot/conf.d/20-imap.conf&lt;/cite&gt; to have the following line.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mail_plugins = $mail_plugins fts fts_solr
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next up, add the following lines to &lt;cite&gt;/etc/dovecot/conf.d/90-plugin.conf&lt;/cite&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;plugin {
    fts = solr
    fts_solr = break-imap-search url=https://localhost:8080/solr/
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create &lt;cite&gt;/etc/cron.daily/solr&lt;/cite&gt; with the following contents.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;#!/bin/sh
curl https://localhost:8080/solr/update?optimize=true
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create &lt;cite&gt;/etc/cron.hourly/solr&lt;/cite&gt; with the following contents.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;#!/bin/sh
curl https://localhost:8080/solr/update?commit=true
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Make both files executable.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo chmod +x /etc/cron.daily/solr /etc/cron.hourly/solr
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Solr uses soft commits when it indexes new mail, this only commits to memory so
a cron task is good for committing every hour and a daily optimize for keeping
things fast.&lt;/p&gt;
&lt;p&gt;That’s all for Dovecot and Solr, so restart them.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo /etc/init.d/dovecot restart
sudo /etc/init.d/tomcat6 restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="clamav-and-spamassassin-milters"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-5"&gt;ClamAV and SpamAssassin milters&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install clamav-milter clamav-unofficial-sigs spamass-milter
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll likely get an error when installing these, don’t worry.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo freshclam
sudo /etc/init.d/clamav-daemon start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Uncomment the last line in &lt;cite&gt;/etc/default/clamav-milter&lt;/cite&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;SOCKET_RWGROUP=postfix
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now create somewhere for the clamav-milter socket to reside.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo mkdir /var/spool/postfix/clamav
sudo chown clamav /var/spool/postfix/clamav
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Edit &lt;cite&gt;/etc/clamav/clamav-milter.conf&lt;/cite&gt; to look like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;MilterSocket /var/spool/postfix/clamav/clamav-milter.ctl
FixStaleSocket true
User clamav
AllowSupplementaryGroups true
ReadTimeout 120
Foreground false
PidFile /var/run/clamav/clamav-milter.pid
ClamdSocket unix:/var/run/clamav/clamd.ctl
OnClean Accept
OnInfected Reject
OnFail Defer
AddHeader Replace
LogSyslog false
LogFacility LOG_LOCAL6
LogVerbose false
LogInfected Off
LogClean Off
LogRotate true
MaxFileSize 100M
SupportMultipleRecipients true
RejectMsg Rejecting harmful e-mail: %v found.
TemporaryDirectory /tmp
LogFile /var/log/clamav/clamav-milter.log
LogTime true
LogFileUnlock false
LogFileMaxSize 0
MilterSocketGroup clamav
MilterSocketMode 666
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Edit &lt;cite&gt;/etc/default/spamass-milter&lt;/cite&gt; and add the following line.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;OPTIONS="-u spamass-milter -i 127.0.0.1 -m -r -1 -I"
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Edit &lt;cite&gt;/etc/default/spamassassin&lt;/cite&gt; to have the following values.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ENABLED=1
CRON=1
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Update SpamAssassin and start the service.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo sa-update
sudo /etc/init.d/spamassassin start
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="dkimproxy"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-6"&gt;DKIMProxy&lt;/a&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install dkimproxy
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create a private and public keypair.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo openssl genrsa -out /etc/dkimproxy/private.key 1024
sudo openssl rsa -in /etc/dkimproxy/private.key -out /etc/dkimproxy/public.key -pubout -outform PEM
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Modify &lt;cite&gt;/etc/dkimproxy/dkimproxy_in.conf&lt;/cite&gt; to look like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;listen 127.0.0.1:10025
relay 27.0.0.1:10026
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Modify &lt;cite&gt;/etc/dkimproxy/dkimproxy_out.conf&lt;/cite&gt; to look like below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;listen 127.0.0.1:10027
relay 127.0.0.1:10028
domain example.com
keyfile /etc/dkimproxy/private.key
selector mail
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;There seems to be a rather annoying bug where signatures are not modified
based on the config, I found the easiest way to cheat this is to just modify
the init.d file for dkimproxy.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;DKIMPROXY_OUT_ARGS="${COMMON_ARGS} --pidfile=${PIDDKIMPROXY_OUT} --min_servers=${DKIMPROXY_OUT_MIN_SERVERS} --domain=example.com --method=simple --conf_file=${DKOUT_CONF} --keyfile=/etc/dkimproxy/private.key --selector=mail --signature=dkim(a=rsa-sha256) --signature=domainkeys(a=rsa-sha1)"
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally, restart dkimproxy.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/init.d/dkimproxy restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="dns"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-7"&gt;&lt;span class="caps"&gt;DNS&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;All that needs to be done now is to create two three records.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;example.com. IN TXT "v=spf1 a mx -all"
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;_domainkey.example.com. IN TXT "o=-;"
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mail._domainkey.example.com. IN TXT "k=rsa; p=MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDGTLLBUsIH..."
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The contents of the latter record are the public key from &lt;cite&gt;/etc/dkimproxy/public.key&lt;/cite&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="wheezy"></category><category term="postfix"></category><category term="dovecot"></category><category term="clamav"></category><category term="domainkeys"></category><category term="dkim"></category><category term="spf"></category><category term="imap"></category></entry><entry><title>torproject.org mirror</title><link href="https://kura.gg/2015/01/02/torproject.org-mirror/" rel="alternate"></link><published>2015-01-02T04:48:00+00:00</published><updated>2015-01-02T04:48:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2015-01-02:/2015/01/02/torproject.org-mirror/</id><content type="html">
&lt;div class="section" id="mirror"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;Mirror&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;With the DDoS attacks on the &lt;a class="reference external" href="https://www.torproject.org"&gt;torproject.org&lt;/a&gt;
website over the mid to end of December, I decided it would be prudent to join
the relatively small list of mirrors.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="access"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;Access&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;+——- —-+—————————+
| Website | Dist / Downloads |
+=========+==================+
| &lt;span class="caps"&gt;HTTP&lt;/span&gt;    | &lt;span class="caps"&gt;HTTP&lt;/span&gt; &lt;span class="caps"&gt;DIST&lt;/span&gt;        |
+————-+—————————+
| &lt;span class="caps"&gt;HTTPS&lt;/span&gt;   | &lt;span class="caps"&gt;HTTPS&lt;/span&gt; &lt;span class="caps"&gt;DIST&lt;/span&gt;       |
+————-+—————————+
| &lt;span class="caps"&gt;FTP&lt;/span&gt;     | &lt;span class="caps"&gt;FTP&lt;/span&gt; &lt;span class="caps"&gt;DIST&lt;/span&gt;         |
+————-+—————————+
| &lt;span class="caps"&gt;RSYNC&lt;/span&gt;   | &lt;span class="caps"&gt;RSYNC&lt;/span&gt; &lt;span class="caps"&gt;DIST&lt;/span&gt;       | +————-+—————————+&lt;/p&gt;
&lt;p&gt;Note: This mirror is now dead and links have been removed.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tor"></category><category term="tor"></category></entry><entry><title>Santa’s tor relay changes</title><link href="https://kura.gg/2014/12/27/santas-tor-relay-changes/" rel="alternate"></link><published>2014-12-27T01:12:00+00:00</published><updated>2014-12-27T01:12:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-12-27:/2014/12/27/santas-tor-relay-changes/</id><content type="html">
&lt;div class="section" id="exiting-relays"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;Exiting relays&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Both &lt;a class="reference external" href="https://globe.torproject.org/#/relay/865A408E2B1EA3E18C9A12E80A8D458F9C985C16"&gt;SpunkWeasel (&lt;span class="caps"&gt;865A408E2B1EA3E18C9A12E80A8D458F9C985C16&lt;/span&gt;)&lt;/a&gt;
and &lt;a class="reference external" href="https://globe.torproject.org/#/relay/B8E6FFEB6F91FA3D26BC572836FB0ABBD142DC87"&gt;AnorexicSquirrel (&lt;span class="caps"&gt;B8E6FFEB6F91FA3D26BC572836FB0ABBD142DC87&lt;/span&gt;)&lt;/a&gt;
have been given additional horsepower in terms of &lt;span class="caps"&gt;CPU&lt;/span&gt; and memory and both have
been allowed to exit. Additionally, both are now capable of IPv6 connectivity
as guards, relays and exits.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-relays"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;New relays&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;A new exit relay has been put online called &lt;a class="reference external" href="https://globe.torproject.org/#/relay/24B1783665A9B0A4BF640A1CD02F685C0CA098ED"&gt;VivaciousAlpaca (&lt;span class="caps"&gt;24B1783665A9B0A4BF640A1CD02F685C0CA098ED&lt;/span&gt;)&lt;/a&gt;.
It has the same &lt;span class="caps"&gt;CPU&lt;/span&gt; and memory as SpunkWeasel and AnorexicSquirrel and also
has full IPv6 capabilities.&lt;/p&gt;
&lt;p&gt;A full list of my public Tor relays can be found on the &lt;a class="reference external" href="/tor/"&gt;tor page&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tor"></category><category term="tor"></category></entry><entry><title>Tor all the things!</title><link href="https://kura.gg/2014/10/02/tor-all-the-things/" rel="alternate"></link><published>2014-10-02T03:45:00+01:00</published><updated>2014-10-02T03:45:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-10-02:/2014/10/02/tor-all-the-things/</id><summary type="html">
&lt;div class="section" id="privacy-is-key"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;Privacy is key&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;I am a big fan of keeping my browsing habits and other personal information
private. As such, I use a &lt;span class="caps"&gt;VPN&lt;/span&gt; service provided by &lt;a class="reference external" href="https://proxy.sh/panel/aff.php?aff=079"&gt;proxy.sh (affiliate link)&lt;/a&gt;, I also use their proxies, Tor and
various other proxies, usually from online lists, should I feel the need.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="anonymous-nodes"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;Anonymous nodes&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;I’ve run some Tor nodes for quite a while now, two Exits and five relays to be
precise. They are all listed as being part of the same family and have never
had any reference to me being their operator.&lt;/p&gt;
&lt;p&gt;Sadly, these seven nodes will always remain a secret due to the hassle that
inherently comes with running Tor Exit nodes. These issues include some mean
emails and &lt;span class="caps"&gt;IP&lt;/span&gt; addresses and &lt;span class="caps"&gt;CIDR&lt;/span&gt; blocks being blacklisted by services like Netflix.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-nodes"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-3"&gt;New nodes!&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The good news is, I have recently launched three more nodes! These nodes
belong to a …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="privacy-is-key"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-1"&gt;Privacy is key&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;I am a big fan of keeping my browsing habits and other personal information
private. As such, I use a &lt;span class="caps"&gt;VPN&lt;/span&gt; service provided by &lt;a class="reference external" href="https://proxy.sh/panel/aff.php?aff=079"&gt;proxy.sh (affiliate link)&lt;/a&gt;, I also use their proxies, Tor and
various other proxies, usually from online lists, should I feel the need.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="anonymous-nodes"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-2"&gt;Anonymous nodes&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;I’ve run some Tor nodes for quite a while now, two Exits and five relays to be
precise. They are all listed as being part of the same family and have never
had any reference to me being their operator.&lt;/p&gt;
&lt;p&gt;Sadly, these seven nodes will always remain a secret due to the hassle that
inherently comes with running Tor Exit nodes. These issues include some mean
emails and &lt;span class="caps"&gt;IP&lt;/span&gt; addresses and &lt;span class="caps"&gt;CIDR&lt;/span&gt; blocks being blacklisted by services like Netflix.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="new-nodes"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-3"&gt;New nodes!&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;The good news is, I have recently launched three more nodes! These nodes
belong to a different family and share my &lt;span class="caps"&gt;PGP&lt;/span&gt; identity, an email address I can
be contacted at with regards to the nodes and my lovely bitcoin address for
anyone interested in firing off a donation.&lt;/p&gt;
&lt;p&gt;At time of writing, the servers are part of the Tor network but they are
currently in their initial phase of being rarely used by the network itself.
A &lt;a class="reference external" href="https://blog.torproject.org/blog/lifecycle-of-a-new-relay"&gt;post on the Tor blog&lt;/a&gt; gives some
anecdotal information as to each phase, why it happens and what it means. I
suggest giving it a read since it’s quite interesting.&lt;/p&gt;
&lt;p&gt;In my experience, within about two weeks, all three new nodes will be available
as fast relays and be acceptable is guard relays too.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="bandwidth"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-4"&gt;Bandwidth&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Each of the three nodes has a 1Gbps network interface, two of the nodes have
truly infinite bandwidth while the third only has &lt;span class="caps"&gt;1TB&lt;/span&gt; of outbound transfer but
infinite inbound.&lt;/p&gt;
&lt;p&gt;Hopefully all three servers will add some much needed bandwidth and speed
capacity to the Tor network.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-us"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-5"&gt;The &lt;span class="caps"&gt;US&lt;/span&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Another piece of good news is one of these servers is actually running in the
U.S., which is something I tend to stay away from in general. This will be my
second &lt;span class="caps"&gt;U.S.&lt;/span&gt; Tor node, hopefully it will push me to run more nodes in that
region in the future.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-nodes"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-6"&gt;The nodes&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;These new nodes having a nickname scheme akin to the Ubuntu convention, but
slightly more disgusting, as befits my warped personality.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://globe.torproject.org/#/relay/865A408E2B1EA3E18C9A12E80A8D458F9C985C16"&gt;SpunkWeasel &lt;span class="caps"&gt;865A408E2B1EA3E18C9A12E80A8D458F9C985C16&lt;/span&gt;&lt;/a&gt;,&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://globe.torproject.org/#/relay/B8E6FFEB6F91FA3D26BC572836FB0ABBD142DC87"&gt;AnorexicSquirrel &lt;span class="caps"&gt;B8E6FFEB6F91FA3D26BC572836FB0ABBD142DC87&lt;/span&gt;&lt;/a&gt; and,&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://globe.torproject.org/#/relay/E803339621BD78503AC333F0FDA35DB705B18071"&gt;EjactulatingWhale &lt;span class="caps"&gt;E803339621BD78503AC333F0FDA35DB705B18071&lt;/span&gt;&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Feel free to contact the address listed on the nodes if you have any queries or
questions regarding the nodes or running your own. Bitcoin donations are always
welcome and will help keep these nodes running and allow more to be onlined.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="relay-relay-relay"&gt;
&lt;h2&gt;&lt;a class="toc-backref" href="#toc-entry-7"&gt;Relay, relay, relay&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;As a final note, running a relay is pretty damn safe. You can do it pretty
cheaply too on &lt;span class="caps"&gt;AWS&lt;/span&gt;, with DigitalOcean or any other &lt;span class="caps"&gt;VPS&lt;/span&gt; provide. Relays are
generally allowed to be run on those environments too, although dropping an
email or support ticket to say you’re doing it is always a good idea.&lt;/p&gt;
&lt;p&gt;The Tor network needs nodes, especially Guards and Exits. Exits are a
difficult thing for most people to run but relays and Guards are easy. A Guard
relay is simply just a standard relay that has currently been chosen to have
the Guard flag, which is in a time period-based rotation, so it really is simple.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tor"></category><category term="tor"></category></entry><entry><title>batfish(1) - writing a Digital Ocean V2 API wrapper</title><link href="https://kura.gg/2014/09/15/batfish-writing-a-digital-ocean-v2-api-wrapper/" rel="alternate"></link><published>2014-09-15T22:20:00+01:00</published><updated>2014-09-15T22:20:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-09-15:/2014/09/15/batfish-writing-a-digital-ocean-v2-api-wrapper/</id><summary type="html">
&lt;p&gt;Batfish is a Python client and &lt;span class="caps"&gt;API&lt;/span&gt; wrapper for the &lt;a class="reference external" href="https://developers.digitalocean.com/"&gt;Digital Ocean V2 &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/a&gt;. It can be used as a library module in
your own Python code but also provides a &lt;span class="caps"&gt;CLI&lt;/span&gt; interface and a shell-like command interpreter.&lt;/p&gt;
&lt;p&gt;Batfish is still under development and is considered in the Alpha stage. It is
not yet available via PyPI but can be tried out using the &lt;a class="reference external" href="https://github.com/kura/batfish"&gt;code available on
GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There is a small amount of &lt;a class="reference external" href="https://batfish.readthedocs.org"&gt;documentation available on Read The Docs&lt;/a&gt; and tests are still being written to get as
much coverage as possible and eaked out all of the bugs. You can find the
&lt;a class="reference external" href="https://travis-ci.org/kura/batfish"&gt;latest test status on Travis &lt;span class="caps"&gt;CI&lt;/span&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="module-interface"&gt;
&lt;h2&gt;Module interface&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;batfish&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Client&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Client&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;authorize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"abcde12345"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;droplets&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Droplet&lt;/span&gt; &lt;span class="n"&gt;ego&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kura&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Droplet&lt;/span&gt; &lt;span class="n"&gt;fax&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kura&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Droplet&lt;/span&gt; &lt;span class="n"&gt;jet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kura&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Droplet&lt;/span&gt; &lt;span class="n"&gt;ski&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kura&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;droplet_reboot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1234&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="cli-interface"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;CLI&lt;/span&gt; interface&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;batfish&lt;span class="w"&gt; &lt;/span&gt;authorize
abcde12345
$&lt;span class="w"&gt; &lt;/span&gt;batfish&lt;span class="w"&gt; &lt;/span&gt;droplets
ego …&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Batfish is a Python client and &lt;span class="caps"&gt;API&lt;/span&gt; wrapper for the &lt;a class="reference external" href="https://developers.digitalocean.com/"&gt;Digital Ocean V2 &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/a&gt;. It can be used as a library module in
your own Python code but also provides a &lt;span class="caps"&gt;CLI&lt;/span&gt; interface and a shell-like command interpreter.&lt;/p&gt;
&lt;p&gt;Batfish is still under development and is considered in the Alpha stage. It is
not yet available via PyPI but can be tried out using the &lt;a class="reference external" href="https://github.com/kura/batfish"&gt;code available on
GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;There is a small amount of &lt;a class="reference external" href="https://batfish.readthedocs.org"&gt;documentation available on Read The Docs&lt;/a&gt; and tests are still being written to get as
much coverage as possible and eaked out all of the bugs. You can find the
&lt;a class="reference external" href="https://travis-ci.org/kura/batfish"&gt;latest test status on Travis &lt;span class="caps"&gt;CI&lt;/span&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="module-interface"&gt;
&lt;h2&gt;Module interface&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;batfish&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Client&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Client&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;authorize&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"abcde12345"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;droplets&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Droplet&lt;/span&gt; &lt;span class="n"&gt;ego&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kura&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Droplet&lt;/span&gt; &lt;span class="n"&gt;fax&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kura&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Droplet&lt;/span&gt; &lt;span class="n"&gt;jet&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kura&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Droplet&lt;/span&gt; &lt;span class="n"&gt;ski&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;kura&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;gg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;client&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;droplet_reboot&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1234&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="cli-interface"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;CLI&lt;/span&gt; interface&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;batfish&lt;span class="w"&gt; &lt;/span&gt;authorize
abcde12345
$&lt;span class="w"&gt; &lt;/span&gt;batfish&lt;span class="w"&gt; &lt;/span&gt;droplets
ego.kura.gg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;id:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12345&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;cpu&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,&lt;span class="w"&gt; &lt;/span&gt;mem:&lt;span class="w"&gt; &lt;/span&gt;512MB,&lt;span class="w"&gt; &lt;/span&gt;disk:&lt;span class="w"&gt; &lt;/span&gt;20GB,&lt;span class="w"&gt; &lt;/span&gt;ip:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.123.123.123&lt;span class="w"&gt; &lt;/span&gt;status:&lt;span class="w"&gt; &lt;/span&gt;active,&lt;span class="w"&gt; &lt;/span&gt;region:&lt;span class="w"&gt; &lt;/span&gt;Amsterdam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
fax.kura.gg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;id:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12346&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;cpu&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,&lt;span class="w"&gt; &lt;/span&gt;mem:&lt;span class="w"&gt; &lt;/span&gt;512MB,&lt;span class="w"&gt; &lt;/span&gt;disk:&lt;span class="w"&gt; &lt;/span&gt;20GB,&lt;span class="w"&gt; &lt;/span&gt;ip:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.123.123.123&lt;span class="w"&gt; &lt;/span&gt;status:&lt;span class="w"&gt; &lt;/span&gt;active,&lt;span class="w"&gt; &lt;/span&gt;region:&lt;span class="w"&gt; &lt;/span&gt;Amsterdam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
jet.kura.gg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;id:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12347&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;cpu&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,&lt;span class="w"&gt; &lt;/span&gt;mem:&lt;span class="w"&gt; &lt;/span&gt;512MB,&lt;span class="w"&gt; &lt;/span&gt;disk:&lt;span class="w"&gt; &lt;/span&gt;20GB,&lt;span class="w"&gt; &lt;/span&gt;ip:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.123.123.123&lt;span class="w"&gt; &lt;/span&gt;status:&lt;span class="w"&gt; &lt;/span&gt;active,&lt;span class="w"&gt; &lt;/span&gt;region:&lt;span class="w"&gt; &lt;/span&gt;Amsterdam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
ski.kura.gg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;id:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12348&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;cpu&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,&lt;span class="w"&gt; &lt;/span&gt;mem:&lt;span class="w"&gt; &lt;/span&gt;512MB,&lt;span class="w"&gt; &lt;/span&gt;disk:&lt;span class="w"&gt; &lt;/span&gt;20GB,&lt;span class="w"&gt; &lt;/span&gt;ip:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.123.123.123&lt;span class="w"&gt; &lt;/span&gt;status:&lt;span class="w"&gt; &lt;/span&gt;active,&lt;span class="w"&gt; &lt;/span&gt;region:&lt;span class="w"&gt; &lt;/span&gt;Amsterdam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
$&lt;span class="w"&gt; &lt;/span&gt;batfish&lt;span class="w"&gt; &lt;/span&gt;droplet_reboot&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12345&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="console-interface"&gt;
&lt;h2&gt;Console interface&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;batfish&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;authorize
abcde12345
batfish&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;droplets
ego.kura.gg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;id:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12345&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;cpu&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,&lt;span class="w"&gt; &lt;/span&gt;mem:&lt;span class="w"&gt; &lt;/span&gt;512MB,&lt;span class="w"&gt; &lt;/span&gt;disk:&lt;span class="w"&gt; &lt;/span&gt;20GB,&lt;span class="w"&gt; &lt;/span&gt;ip:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.123.123.123&lt;span class="w"&gt; &lt;/span&gt;status:&lt;span class="w"&gt; &lt;/span&gt;active,&lt;span class="w"&gt; &lt;/span&gt;region:&lt;span class="w"&gt; &lt;/span&gt;Amsterdam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
fax.kura.gg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;id:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12346&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;cpu&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,&lt;span class="w"&gt; &lt;/span&gt;mem:&lt;span class="w"&gt; &lt;/span&gt;512MB,&lt;span class="w"&gt; &lt;/span&gt;disk:&lt;span class="w"&gt; &lt;/span&gt;20GB,&lt;span class="w"&gt; &lt;/span&gt;ip:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.123.123.123&lt;span class="w"&gt; &lt;/span&gt;status:&lt;span class="w"&gt; &lt;/span&gt;active,&lt;span class="w"&gt; &lt;/span&gt;region:&lt;span class="w"&gt; &lt;/span&gt;Amsterdam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
jet.kura.gg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;id:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12347&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;cpu&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,&lt;span class="w"&gt; &lt;/span&gt;mem:&lt;span class="w"&gt; &lt;/span&gt;512MB,&lt;span class="w"&gt; &lt;/span&gt;disk:&lt;span class="w"&gt; &lt;/span&gt;20GB,&lt;span class="w"&gt; &lt;/span&gt;ip:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.123.123.123&lt;span class="w"&gt; &lt;/span&gt;status:&lt;span class="w"&gt; &lt;/span&gt;active,&lt;span class="w"&gt; &lt;/span&gt;region:&lt;span class="w"&gt; &lt;/span&gt;Amsterdam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
ski.kura.gg&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;id:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12348&lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;cpu&lt;span class="o"&gt;(&lt;/span&gt;s&lt;span class="o"&gt;)&lt;/span&gt;:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;,&lt;span class="w"&gt; &lt;/span&gt;mem:&lt;span class="w"&gt; &lt;/span&gt;512MB,&lt;span class="w"&gt; &lt;/span&gt;disk:&lt;span class="w"&gt; &lt;/span&gt;20GB,&lt;span class="w"&gt; &lt;/span&gt;ip:&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;123&lt;/span&gt;.123.123.123&lt;span class="w"&gt; &lt;/span&gt;status:&lt;span class="w"&gt; &lt;/span&gt;active,&lt;span class="w"&gt; &lt;/span&gt;region:&lt;span class="w"&gt; &lt;/span&gt;Amsterdam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;3&lt;/span&gt;&lt;span class="o"&gt;)&lt;/span&gt;
batfish&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;droplet_reboot&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12345&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="digital ocean"></category></entry><entry><title>yarg(1) — A semi hard Cornish cheese, also queries PyPI</title><link href="https://kura.gg/2014/08/09/yarg/" rel="alternate"></link><published>2014-08-09T13:30:00+01:00</published><updated>2014-08-09T13:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-08-09:/2014/08/09/yarg/</id><content type="html">
&lt;p&gt;Yarg is a PyPI client, it was written for &lt;a class="reference external" href="https://pypip.in"&gt;pypip.in&lt;/a&gt; and can search packages as well as read the &lt;span class="caps"&gt;RSS&lt;/span&gt; feeds
from PyPI for new packages and new package version releases.&lt;/p&gt;
&lt;div class="section" id="search-interface"&gt;
&lt;h2&gt;Search interface&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;yarg&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;package&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;yarg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"yarg"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;package&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;
&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;'yarg'&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;package&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;author&lt;/span&gt;
&lt;span class="n"&gt;Author&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;'Kura'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;email&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;'kura@kura.gg'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="newest-packages-interface"&gt;
&lt;h2&gt;Newest packages interface&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;yarg&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;yarg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;newest_packages&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Package&lt;/span&gt; &lt;span class="n"&gt;yarg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Package&lt;/span&gt; &lt;span class="n"&gt;gray&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Package&lt;/span&gt; &lt;span class="n"&gt;ragy&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;
&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;'yarg'&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;
&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;'https://pypi.python.org/pypi/yarg&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="updated-packages-interface"&gt;
&lt;h2&gt;Updated packages interface&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="nn"&gt;yarg&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;yarg&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;latest_updated_packages&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt;
&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Package&lt;/span&gt; &lt;span class="n"&gt;yarg&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Package&lt;/span&gt; &lt;span class="n"&gt;gray&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;Package&lt;/span&gt; &lt;span class="n"&gt;ragy&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;
&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;'yarg'&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;version&lt;/span&gt;
&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;'0.1.2'&lt;/span&gt;
&lt;span class="o"&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class="n"&gt;packages&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt;
&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;'https://pypi.python.org/pypi/yarg/0.1.2&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="documentation"&gt;
&lt;h2&gt;Documentation&lt;/h2&gt;
&lt;p&gt;Full documentation is at &amp;lt;&lt;a class="reference external" href="https://yarg.readthedocs.org"&gt;https://yarg.readthedocs.org&lt;/a&gt;&amp;gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="pypi"></category></entry><entry><title>Speeding up pypip.in and reducing load on PyPI</title><link href="https://kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/" rel="alternate"></link><published>2014-08-07T08:42:00+01:00</published><updated>2014-08-07T08:42:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-08-07:/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/</id><summary type="html">
&lt;p&gt;As you might expect, &lt;a class="reference external" href="https://pypip.in"&gt;pypip.in&lt;/a&gt; employes a fair amount of
caching in the backend to control load on the imaging &lt;span class="caps"&gt;API&lt;/span&gt; and servers.&lt;/p&gt;
&lt;p&gt;For a long time, this cache was entirely managed by Varnish and was doing a
fantastic job. Varnish has a hit:miss ratio of 10:1, for every 10 hits we get
1 miss. This is a fairly decent ratio when you consider where these images are
displayed, how often they are viewed and that Varnish only caches the images
for an hour.&lt;/p&gt;
&lt;div class="section" id="the-impact-on-pypi"&gt;
&lt;h2&gt;The impact on PyPI&lt;/h2&gt;
&lt;p&gt;You will firstly need to understand how pypip.in used to work to understand the
changes that were made and why they were made.&lt;/p&gt;
&lt;p&gt;Let’s set up the request first - a request for a shield is made and it is not
present in the Varnish cache.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Request received in API layer
              |
              v
    API layer queries PyPI
              |
              v
   PyPI …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;As you might expect, &lt;a class="reference external" href="https://pypip.in"&gt;pypip.in&lt;/a&gt; employes a fair amount of
caching in the backend to control load on the imaging &lt;span class="caps"&gt;API&lt;/span&gt; and servers.&lt;/p&gt;
&lt;p&gt;For a long time, this cache was entirely managed by Varnish and was doing a
fantastic job. Varnish has a hit:miss ratio of 10:1, for every 10 hits we get
1 miss. This is a fairly decent ratio when you consider where these images are
displayed, how often they are viewed and that Varnish only caches the images
for an hour.&lt;/p&gt;
&lt;div class="section" id="the-impact-on-pypi"&gt;
&lt;h2&gt;The impact on PyPI&lt;/h2&gt;
&lt;p&gt;You will firstly need to understand how pypip.in used to work to understand the
changes that were made and why they were made.&lt;/p&gt;
&lt;p&gt;Let’s set up the request first - a request for a shield is made and it is not
present in the Varnish cache.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Request received in API layer
              |
              v
    API layer queries PyPI
              |
              v
   PyPI response translated
              |
              v
Image request for imaging layer
&lt;/pre&gt;
&lt;p&gt;This was true for every request made that did not exist in Varnish’s cache.&lt;/p&gt;
&lt;p&gt;Generally, if one shield was displayed for a project a second or more usually
was displayed too. This meant when loading the &lt;span class="caps"&gt;README&lt;/span&gt; document on GitHub for a
project would involve pypip.in making more than one request to PyPI for
information and then translating that data.&lt;/p&gt;
&lt;p&gt;I decided that caching the initial response for the first request from PyPI to
Redis would be a good idea. This cache is only meant to be short term and is in
place to make multiple images requested at the same time generate faster.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
       Request received in API layer
                     |
                     v
API layer queries Redis and falls back to PyPI
                     |
                     v
          PyPI response translated
                     |
                     v
       Image request for imaging layer
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="reducing-load-on-the-imaging-layer"&gt;
&lt;h2&gt;Reducing load on the imaging layer&lt;/h2&gt;
&lt;p&gt;I realised that out of all of the shields pypip.in serves, all but two of them
are generic and can be re-used.&lt;/p&gt;
&lt;p&gt;&lt;cite&gt;Downloads&lt;/cite&gt; and &lt;cite&gt;version&lt;/cite&gt; information are almost entirely unique but, &lt;cite&gt;Python
versions&lt;/cite&gt;, &lt;cite&gt;Python implementations&lt;/cite&gt;, &lt;cite&gt;development status&lt;/cite&gt;, &lt;cite&gt;wheel&lt;/cite&gt;, &lt;cite&gt;egg&lt;/cite&gt;,
&lt;cite&gt;format&lt;/cite&gt; and &lt;cite&gt;license&lt;/cite&gt; are all generic and will be identical for multiple projects.&lt;/p&gt;
&lt;p&gt;It would make perfect sense to cache these images and re-use them as required.
While caching them in Varnish would not be possible due to the &lt;span class="caps"&gt;URI&lt;/span&gt; structure,
caching the images on disk based on their data, colour and mime type would be
perfectly acceptable.&lt;/p&gt;
&lt;p&gt;The disks used to power pypip.in are of &lt;span class="caps"&gt;SSD&lt;/span&gt; quality (&lt;a class="reference external" href="https://www.digitalocean.com/?refcode=d76795840b23"&gt;thanks DigitalOcean&lt;/a&gt;,) so storing the images
on the disks themselves would be perfectly reasonable and, due to their nature
can be stored for a good length of time. I opted for 24 hours.&lt;/p&gt;
&lt;p&gt;Now the diagram looks like this:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
       Request received in API layer
                     |
                     v
API layer queries Redis and falls back to PyPI
                     |
                     v
          PyPI response translated
                     |
                     v
   Look for image in generic disk cache or
         request from imaging layer
&lt;/pre&gt;
&lt;p&gt;Due to the nature of the shields and their content, a request has to be made to
Redis or PyPI before a look up can be made to the generic disk cache (we need
to know the text data and shield colour from PyPI data,) it is still a very
good performance improvement on the whole.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="pypipins"></category><category term="pypip.in"></category><category term="shields"></category></entry><entry><title>So you want to run your own copy of pypip.in?</title><link href="https://kura.gg/2014/07/26/so-you-want-to-run-your-own-copy-of-pypip.in/" rel="alternate"></link><published>2014-07-26T23:40:00+01:00</published><updated>2014-07-26T23:40:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-07-26:/2014/07/26/so-you-want-to-run-your-own-copy-of-pypip.in/</id><summary type="html">
&lt;p&gt;While pypip.in is available under the &lt;span class="caps"&gt;MIT&lt;/span&gt; license on &lt;a class="reference external" href="https://github.com/badges/pypipins"&gt;GitHub&lt;/a&gt;, it’s not explained how to really use it properly.&lt;/p&gt;
&lt;p&gt;You can gather how to set-up the Python source of the project and get the
&lt;a class="reference external" href="https://twistedmatrix.com"&gt;Twisted&lt;/a&gt; process running, this is totally reliant
on using the &lt;a class="reference external" href="https://img.shields.io"&gt;img.shields.io&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I decided to write this article explaining how to install your own copy of the
shields nodejs code, pypipin itself and even cover off supervisord and Varnish too.&lt;/p&gt;
&lt;div class="section" id="shields-nodejs"&gt;
&lt;h2&gt;shields &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; nodejs&lt;/h2&gt;
&lt;div class="section" id="nodejs"&gt;
&lt;h3&gt;nodejs&lt;/h3&gt;
&lt;p&gt;First of all you’ll need to get the latest source code copy of nodejs from the
&lt;a class="reference external" href="https://nodejs.org/download/"&gt;nodejs download page&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Extract it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tar -xvzf node-&amp;lt;VERSION&amp;gt;.tar.gz
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cd node-&amp;lt;VERSION&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll need to install the build tools, if you don’t have them already.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install build-essential
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And then make and install node.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;make &amp;amp;&amp;amp; sudo make install
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="redis"&gt;
&lt;h3&gt;Redis&lt;/h3&gt;
&lt;p&gt;Redis is used to temporarily store PyPI responses.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo …&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;While pypip.in is available under the &lt;span class="caps"&gt;MIT&lt;/span&gt; license on &lt;a class="reference external" href="https://github.com/badges/pypipins"&gt;GitHub&lt;/a&gt;, it’s not explained how to really use it properly.&lt;/p&gt;
&lt;p&gt;You can gather how to set-up the Python source of the project and get the
&lt;a class="reference external" href="https://twistedmatrix.com"&gt;Twisted&lt;/a&gt; process running, this is totally reliant
on using the &lt;a class="reference external" href="https://img.shields.io"&gt;img.shields.io&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I decided to write this article explaining how to install your own copy of the
shields nodejs code, pypipin itself and even cover off supervisord and Varnish too.&lt;/p&gt;
&lt;div class="section" id="shields-nodejs"&gt;
&lt;h2&gt;shields &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; nodejs&lt;/h2&gt;
&lt;div class="section" id="nodejs"&gt;
&lt;h3&gt;nodejs&lt;/h3&gt;
&lt;p&gt;First of all you’ll need to get the latest source code copy of nodejs from the
&lt;a class="reference external" href="https://nodejs.org/download/"&gt;nodejs download page&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Extract it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tar -xvzf node-&amp;lt;VERSION&amp;gt;.tar.gz
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cd node-&amp;lt;VERSION&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll need to install the build tools, if you don’t have them already.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install build-essential
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And then make and install node.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;make &amp;amp;&amp;amp; sudo make install
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="redis"&gt;
&lt;h3&gt;Redis&lt;/h3&gt;
&lt;p&gt;Redis is used to temporarily store PyPI responses.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install redis-server
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="shields"&gt;
&lt;h3&gt;shields&lt;/h3&gt;
&lt;p&gt;You’ll need to install git for the next step.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install git-core
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And get a copy of the shields repository.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git clone git@github.com:badges/shields.git
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once it’s checked out, you’ll need to install it’s requirements.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cd shields &amp;amp;&amp;amp; npm install
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can confirm this works by running the shields server.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;node server 8080
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="pypipin"&gt;
&lt;h2&gt;pypipin&lt;/h2&gt;
&lt;p&gt;Clone the shields repository, the same way you did for shields above.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git clone git@github.com:badges/pypipins.git
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To do this properly, you’ll need to make sure you have virtualenv for Python.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install python-dev
wget -O - https://bootstrap.pypa.io/get-pip.py | sudo python
sudo pip install virtualenv
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next, you’ll need to create a virtual environment.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;virtualenv /path/to/where/you/want/it/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then you can active it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;. /path/to/your/virtualenv/bin/activate
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And install the dev requirements from the pypipins directory.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pip install -r /path/to/pypipins/clone/requirements-dev.txt
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll need to edit shields.py, commenting out the img.shields.io host and
uncommon the local one.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/path/to/pypipins/clone/shields/shields.py


# SHIELD_URL = "https://img.shields.io/badge/%s-%s-%s.%s"
SHIELD_URL = "http://localhost:9000/badge/%s-%s-%s.%s"  # pypip.in uses a local version of img.shields.io
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once this is done, you can test the pypipins server.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/path/to/your/virtualenv/bin/python /path/to/pypipins/clone/shields/shields.py
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="supervisor-d"&gt;
&lt;h2&gt;supervisor(d)&lt;/h2&gt;
&lt;p&gt;Always install supervisor from apt, rather than from pip.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install supervisor
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then cd to where conf.d config files are stored for supervisor.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cd /etc/supervisor/conf.d/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In here, you’ll need to create a configuration for the shields nodejs server
and also for pypipins server.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;shields.conf


[program:shields]
directory=/path/to/shields/
command=node server 9000
stdout_logfile=/var/log/supervisor/shields.log
stderr_logfile=/var/log/supervisor/shields.error.log
user=www-data
group=www-data
autostart=true
autorestart=true
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pypipin.conf


[program:pypipin]
command=/path/to/virtualenv/bin/python /path/to/pypipin/clone/shields/shields.py
stdout_logfile=/var/log/supervisor/pypipin.log
stderr_logfile=/var/log/supervisor/pypipin.error.log
user=www-data
group=www-data
autostart=true
autorestart=true
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once this is done, you’ll need to load them in to supervisor itself.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo supervisorctl
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;reread
add shields
add pypipin
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now supervisor will automatically start both processes and keep them alive.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="varnish"&gt;
&lt;h2&gt;Varnish&lt;/h2&gt;
&lt;p&gt;The final step is to put Varnish in front of the system to cache images for you.
The shields server has the ability to use redis for caching but, I’d rather do
this with a proper &lt;span class="caps"&gt;HTTP&lt;/span&gt; cache rather than use redis.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get install varnish
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Tell Varnish to run on port 80.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/default/varnish


DAEMON_OPTS="-a :80 \
             -T localhost:6082 \
             -f /etc/varnish/default.vcl \
             -S /etc/varnish/secret \
             -s malloc,256m"
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will run the Varnish &lt;span class="caps"&gt;HTTP&lt;/span&gt; server on port 80 and keep it’s admin interface
hidden from the world, binding it to port 6082 on the lo interface.&lt;/p&gt;
&lt;p&gt;The final step is to tell Varnish about the pypipins server.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/varnish/default.vcl


backend default {
    .host = "127.0.0.1";
    .port = "8888";
}

sub vcl_recv {
    if (req.request != "GET") {
        return(pipe);
    }

    if (req.request == "GET") {
        remove req.http.cookie;
        remove req.http.authenticate;
        remove req.http.Etag;
        remove req.http.If-None-Match;
        return(lookup);
    }
    return(pass);
}

sub vcl_fetch {
    if (beresp.status &amp;gt;= 300) {
        return(hit_for_pass);
    }

    set beresp.ttl = 1h;
    set beresp.grace = 6h;
    unset beresp.http.Set-Cookie;
    unset beresp.http.Etag;
    unset beresp.http.Cache-Control;
    set beresp.http.Cache-Control = "no-cache";
    return (deliver);
}

sub vcl_deliver {
      if (obj.hits &amp;gt; 0) {
            set resp.http.X-Cache = "HIT";
            set resp.http.X-Cache-Hits = obj.hits;
      } else {
            set resp.http.X-Cache = "MISS";
      }
}
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;All done, restart Varnish.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo /etc/init.d/varnish restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll be able to go to &lt;a class="reference external" href="http://yourserver.tld/download/PACKAGE/badge.svg"&gt;http://yourserver.tld/download/&amp;lt;&lt;span class="caps"&gt;PACKAGE&lt;/span&gt;&amp;gt;/badge.svg&lt;/a&gt; and everything should be
working as expected.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="notes-on-pypy"&gt;
&lt;h2&gt;Notes on PyPy&lt;/h2&gt;
&lt;p&gt;I personally use PyPy for running the pypipins server because, it’s a long
running process and PyPy speeds it up wonderfully.&lt;/p&gt;
&lt;p&gt;If you’re using Debian 7, the latest version of PyPy as of writing is 2.3.1 and
requires libffi6, if you’re using one of the prebuilt binaries. libffi6 is only
available in Jessie which is currently in testing.&lt;/p&gt;
&lt;p&gt;You can either use an older version of PyPy or, backport libffi6 from Jessie.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/apt/sources.list


deb ftp://ftp.debian.org/debian/ jessie main
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/apt/preferences.d/jessie


Package: *
Pin: release a=wheezy
Pin-Priority: 900

Package: libffi*
Pin: release a=jessie
Pin-Priority: 910
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will keep all packages pinned to wheezy except libffi+wildcard, which will
be pulled from Jessie.&lt;/p&gt;
&lt;p&gt;You can then simply install libffi6 from Jessie.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo apt-get update
sudo apt-get -u install libffi6/jessie
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="ssl"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;If you want to use &lt;span class="caps"&gt;SSL&lt;/span&gt; with your shields, you’ll need to install nginx in front
of Varnish.&lt;/p&gt;
&lt;p&gt;So instead of running Varnish on port 80, as shown above. Put it on a different
port, install and use nginx as you would for any other website and simply proxy
all requests back to Varnish.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="pypipins"></category><category term="pypip.in"></category><category term="shields"></category></entry><entry><title>New pypip.in shields and styling</title><link href="https://kura.gg/2014/07/25/new-pypip.in-shields-and-styling/" rel="alternate"></link><published>2014-07-25T01:00:00+01:00</published><updated>2014-07-25T01:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-07-25:/2014/07/25/new-pypip.in-shields-and-styling/</id><summary type="html">
&lt;div class="section" id="supported-python-versions"&gt;
&lt;h2&gt;Supported Python versions&lt;/h2&gt;
&lt;p&gt;This one is generated from the list of classifiers you provide to PyPI.&lt;/p&gt;
&lt;p&gt;If no Python version classifiers exist, it defaults to Python 2.7. This is
because really, Python 3 is not widely used in production or supported by libraries.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-implementation-s"&gt;
&lt;h2&gt;Python implementation(s)&lt;/h2&gt;
&lt;p&gt;I think this one is really cool. Chances are you’re unlikely to get more than
two supported implementations, like CPython and PyPy or CPython and Stackless.&lt;/p&gt;
&lt;p&gt;The shield uses the Python implementation classifiers to generate this shield.
It supports all classifiers that PyPI supports (CPython, Jython, Iron Python,
PyPy and Stackless) and defaults to CPython is none are set.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="styling-changes"&gt;
&lt;h2&gt;Styling changes&lt;/h2&gt;
&lt;p&gt;This change is simply because of the upgrade of the shields library. This
allows us to use the default rounded badges like below.&lt;/p&gt;
&lt;p&gt;But also allow you to use a much nicer, cleaner, flat styling like the ones
used on this …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="supported-python-versions"&gt;
&lt;h2&gt;Supported Python versions&lt;/h2&gt;
&lt;p&gt;This one is generated from the list of classifiers you provide to PyPI.&lt;/p&gt;
&lt;p&gt;If no Python version classifiers exist, it defaults to Python 2.7. This is
because really, Python 3 is not widely used in production or supported by libraries.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="python-implementation-s"&gt;
&lt;h2&gt;Python implementation(s)&lt;/h2&gt;
&lt;p&gt;I think this one is really cool. Chances are you’re unlikely to get more than
two supported implementations, like CPython and PyPy or CPython and Stackless.&lt;/p&gt;
&lt;p&gt;The shield uses the Python implementation classifiers to generate this shield.
It supports all classifiers that PyPI supports (CPython, Jython, Iron Python,
PyPy and Stackless) and defaults to CPython is none are set.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="styling-changes"&gt;
&lt;h2&gt;Styling changes&lt;/h2&gt;
&lt;p&gt;This change is simply because of the upgrade of the shields library. This
allows us to use the default rounded badges like below.&lt;/p&gt;
&lt;p&gt;But also allow you to use a much nicer, cleaner, flat styling like the ones
used on this page.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="svg-png"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SVG&lt;/span&gt; &amp;gt; &lt;span class="caps"&gt;PNG&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;The final change is that by default pypip.in now returns &lt;span class="caps"&gt;SVG&lt;/span&gt; images by default,
rather than &lt;span class="caps"&gt;PNG&lt;/span&gt;. You can of course get the badge in whatever format you wish.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;https://pypip.in/download/&amp;lt;PACKAGE&amp;gt;/badge.&amp;lt;MIMETYPE&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="pypi"></category><category term="shields"></category></entry><entry><title>nginx 1.7.3 released with pagespeed/psol 1.8.31.4 and naxsi 0.53-2</title><link href="https://kura.gg/2014/07/09/nginx-1.7.3-released-with-pagespeed-psol-1.8.31.4-and-naxsi-0.53-2/" rel="alternate"></link><published>2014-07-09T13:30:00+01:00</published><updated>2014-07-09T13:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-07-09:/2014/07/09/nginx-1.7.3-released-with-pagespeed-psol-1.8.31.4-and-naxsi-0.53-2/</id><content type="html">&lt;p&gt;nginx 1.7.3 is now available on &lt;a class="reference external" href="/apt.kura.gg/"&gt;apt.kura.gg&lt;/a&gt; with updated
versions of both pagespeed and naxsi.&lt;/p&gt;
&lt;p&gt;Pagespeed is now version 1.8.31.4 and Naxsi is 0.53-2, both are the latest
versions available and will be used for each nginx release until newer
versions are available.&lt;/p&gt;
</content><category term="deb builds"></category><category term="apt"></category></entry><entry><title>haproxy OCSP stapling</title><link href="https://kura.gg/2014/07/02/haproxy-ocsp-stapling/" rel="alternate"></link><published>2014-07-02T23:45:00+01:00</published><updated>2014-07-02T23:45:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-07-02:/2014/07/02/haproxy-ocsp-stapling/</id><summary type="html">
&lt;p&gt;With haproxy 1.5 finally being released we are lucky enough to get a basic
interface around &lt;span class="caps"&gt;OCSP&lt;/span&gt; stapling.&lt;/p&gt;
&lt;p&gt;Sadly this interface really is quite basic and it’s not the simplest thing to
figure out without some trial and error.&lt;/p&gt;
&lt;p&gt;According to the official documentation, you should be able to pipe your
&lt;span class="caps"&gt;OCSP&lt;/span&gt; response to haproxy via it’s stats socket. Sadly I could not get this to
work properly at all, so I decided to swap the piping for a file and reload solution.&lt;/p&gt;
&lt;p&gt;You’ll need to get a copy of your certification authorities root certificate
to proceed with this.&lt;/p&gt;
&lt;div class="section" id="looking-for-your-ocsp-uri"&gt;
&lt;h2&gt;Looking for your &lt;span class="caps"&gt;OCSP&lt;/span&gt; &lt;span class="caps"&gt;URI&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;If you don’t know the &lt;span class="caps"&gt;URI&lt;/span&gt; you need to do an &lt;span class="caps"&gt;OCSP&lt;/span&gt; lookup against, you can find
it in your certificate data.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;x509&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;/path/to/your/certificate&lt;span class="w"&gt; &lt;/span&gt;-text
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Inside the output, look for the following section.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Authority Information Access …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;With haproxy 1.5 finally being released we are lucky enough to get a basic
interface around &lt;span class="caps"&gt;OCSP&lt;/span&gt; stapling.&lt;/p&gt;
&lt;p&gt;Sadly this interface really is quite basic and it’s not the simplest thing to
figure out without some trial and error.&lt;/p&gt;
&lt;p&gt;According to the official documentation, you should be able to pipe your
&lt;span class="caps"&gt;OCSP&lt;/span&gt; response to haproxy via it’s stats socket. Sadly I could not get this to
work properly at all, so I decided to swap the piping for a file and reload solution.&lt;/p&gt;
&lt;p&gt;You’ll need to get a copy of your certification authorities root certificate
to proceed with this.&lt;/p&gt;
&lt;div class="section" id="looking-for-your-ocsp-uri"&gt;
&lt;h2&gt;Looking for your &lt;span class="caps"&gt;OCSP&lt;/span&gt; &lt;span class="caps"&gt;URI&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;If you don’t know the &lt;span class="caps"&gt;URI&lt;/span&gt; you need to do an &lt;span class="caps"&gt;OCSP&lt;/span&gt; lookup against, you can find
it in your certificate data.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;x509&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;/path/to/your/certificate&lt;span class="w"&gt; &lt;/span&gt;-text
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Inside the output, look for the following section.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Authority Information Access:
    CA Issuers - URI:https://secure.globalsign.com/cacert/gsdomainvalsha2g2r1.crt
    OCSP - URI:https://ocsp2.globalsign.com/gsdomainvalsha2g2
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="testing-ocsp-response"&gt;
&lt;h2&gt;Testing &lt;span class="caps"&gt;OCSP&lt;/span&gt; response&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;ocsp&lt;span class="w"&gt; &lt;/span&gt;-noverify&lt;span class="w"&gt; &lt;/span&gt;-issuer&lt;span class="w"&gt; &lt;/span&gt;/path/to/your/ca/root/certificate&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;-cert&lt;span class="w"&gt; &lt;/span&gt;/path/to/your/certificate&lt;span class="w"&gt; &lt;/span&gt;-url&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"OCSP_URI"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see a response like the one below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/path/to/your/certificate: good
This Update: Jul  2 23:01:54 2014 GMT
&lt;/pre&gt;
&lt;p&gt;If you get any errors from this, you may need to try these additional arguments;&lt;/p&gt;
&lt;div class="section" id="disable-nonces"&gt;
&lt;h3&gt;Disable nonces&lt;/h3&gt;
&lt;pre class="literal-block"&gt;
-no_nonce
&lt;/pre&gt;
&lt;p&gt;This will disable nonces, some servers are not able to handle nonces so you may
need to disable them.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="send-a-host-header"&gt;
&lt;h3&gt;Send a “Host” header&lt;/h3&gt;
&lt;p&gt;If you get an &lt;span class="caps"&gt;HTTP&lt;/span&gt; status like a 403 or 404 then you may need to specify
a host header.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-header Host OCSP_URI_DOMAIN
&lt;/pre&gt;
&lt;p&gt;For my certificate the &lt;span class="caps"&gt;OCSP&lt;/span&gt; &lt;span class="caps"&gt;URI&lt;/span&gt; is &lt;em&gt;https://ocsp2.globalsign.com/gsdomainvalsha2g2&lt;/em&gt;
so the Host header would be like below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-header Host ocsp2.globalsign.com
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="proving-ocsp-data-to-haproxy"&gt;
&lt;h2&gt;Proving &lt;span class="caps"&gt;OCSP&lt;/span&gt; data to haproxy&lt;/h2&gt;
&lt;p&gt;If the above testing was all &lt;span class="caps"&gt;OK&lt;/span&gt;, we can now actually use the data.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;ocsp&lt;span class="w"&gt; &lt;/span&gt;-noverify&lt;span class="w"&gt; &lt;/span&gt;-issuer&lt;span class="w"&gt; &lt;/span&gt;/path/to/your/ca/root/certificate&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;-cert&lt;span class="w"&gt; &lt;/span&gt;/path/to/your/certificate&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;-url&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"OCSP_URI"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-respout&lt;span class="w"&gt; &lt;/span&gt;/path/to/your/certificate.ocsp
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;One thing to note is, if your certificate file is &lt;em&gt;/etc/ssl/certs/kura.gg.crt&lt;/em&gt;
then you must set -respout to &lt;em&gt;/etc/ssl/certs/kura.gg.crt.ocsp&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;You can now simply reload haproxy and check your &lt;span class="caps"&gt;OCSP&lt;/span&gt; staping is working.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="testing-ocsp-from-haproxy"&gt;
&lt;h2&gt;Testing &lt;span class="caps"&gt;OCSP&lt;/span&gt; from haproxy&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;s_client&lt;span class="w"&gt; &lt;/span&gt;-connect&lt;span class="w"&gt; &lt;/span&gt;domain.tld:443&lt;span class="w"&gt; &lt;/span&gt;-tls1&lt;span class="w"&gt; &lt;/span&gt;-tlsextdebug&lt;span class="w"&gt; &lt;/span&gt;-status
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Near the top of the response you’ll see your &lt;span class="caps"&gt;OCSP&lt;/span&gt; information.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
OCSP response:
======================================
OCSP Response Data:
    OCSP Response Status: successful (0x0)
    Response Type: Basic OCSP Response
    Version: 1 (0x0)
    Responder Id: DFDE6C7C4B6C4098FA6992156D2B082875FD6443
    Produced At: Jul  2 22:58:27 2014 GMT
    Responses:
    Certificate ID:
        Hash Algorithm: sha1
        Issuer Name Hash: D1F1B576F9EEC0C10F7AFC7C3124A9C3625D7C61
        Issuer Key Hash: EA4E7CD4802DE5158186268C826DC098A4CF970F
        Serial Number: 1121C92209F7127584AAFEB2B08ECDD30A9D
    Cert Status: good
    This Update: Jul  2 22:58:27 2014 GMT
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="updating-ocsp"&gt;
&lt;h2&gt;Updating &lt;span class="caps"&gt;OCSP&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;The simplest way of doing this is by using cron.daily or something similar
to update your certificate.ocsp file.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="haproxy"></category><category term="ssl"></category><category term="ocsp"></category><category term="ocsp stapling"></category></entry><entry><title>Hauntr - A theme for Pelican</title><link href="https://kura.gg/2014/06/09/hauntr/" rel="alternate"></link><published>2014-06-09T18:00:00+01:00</published><updated>2014-06-09T18:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-06-09:/2014/06/09/hauntr/</id><content type="html">&lt;div class="figure align-center"&gt;
&lt;img alt="Haunter, the evolved Pokémon form of Gastly" src="/images/haunter.png"/&gt;
&lt;p class="caption"&gt;(Image by &lt;a class="reference external" href="https://kawiku.deviantart.com/art/Haunter-350580512"&gt;Kawiku&lt;/a&gt;)&lt;/p&gt;
&lt;/div&gt;

&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;Hauntr is a minimal, lightweight and clean theme for the
&lt;a class="reference external" href="https://getpelican.com"&gt;Pelican&lt;/a&gt; blogging platform.&lt;/p&gt;
&lt;p&gt;It is named after the Pokémon ‘Haunter’ because it is a modified version
(you might say evolved) of my previous theme, &lt;a class="reference external" href="/ghastly/"&gt;Ghastly&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="features"&gt;
&lt;h2&gt;Features&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Disqus&lt;/li&gt;
&lt;li&gt;Pygments&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;CSS&lt;/span&gt; minifying using webassets&lt;/li&gt;
&lt;li&gt;Share buttons&lt;/li&gt;
&lt;li&gt;Custom 404 page&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="pelican"></category></entry><entry><title>Pelican FontAwesome</title><link href="https://kura.gg/2014/06/08/pelican-fontawesome/" rel="alternate"></link><published>2014-06-08T11:30:00+01:00</published><updated>2014-06-08T11:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-06-08:/2014/06/08/pelican-fontawesome/</id><content type="html">
&lt;p&gt;Pelican FontAwesome allows you to embed &lt;a class="reference external" href="https://fortawesome.github.io/Font-Awesome/"&gt;FontAwesome&lt;/a&gt; icons in your &lt;span class="caps"&gt;RST&lt;/span&gt; posts and pages.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;To install pelican-fontawesome, simply install it from PyPI:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;pip&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;pelican-fontawesome
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then enable it in your pelicanconf.py&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;PLUGINS&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
    &lt;span class="c1"&gt;# ...&lt;/span&gt;
    &lt;span class="s1"&gt;'pelican_fontawesome'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Include the FontAwesome &lt;span class="caps"&gt;CSS&lt;/span&gt; in your base template.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;link&lt;/span&gt; &lt;span class="na"&gt;href&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css"&lt;/span&gt; &lt;span class="na"&gt;rel&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"stylesheet"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="usage"&gt;
&lt;h2&gt;Usage&lt;/h2&gt;
&lt;p&gt;In your article or page, you simply need to add a reference to FontAwesome and
then the icon name.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;:fa:&lt;/span&gt;&lt;span class="nv"&gt;`fa-github`&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Which will result in:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;span&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;"fa fa-github"&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;span&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And the user will see: &lt;span class="fa fa-github"&gt;&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;You can also increase the size, just like the &lt;a class="reference external" href="https://fortawesome.github.io/Font-Awesome/examples/"&gt;FontAwesome documentation&lt;/a&gt; shows.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;:fa:&lt;/span&gt;&lt;span class="nv"&gt;`fa-github fa-4x`&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Will result in: &lt;span class="fa fa-github fa-4x"&gt;&lt;/span&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="license"&gt;
&lt;h2&gt;License&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://opensource.org/licenses/MIT"&gt;&lt;span class="caps"&gt;MIT&lt;/span&gt;&lt;/a&gt; license.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="pelican"></category><category term="fontawesome"></category><category term="icons"></category><category term="python"></category></entry><entry><title>Python platform and version dependent wheel build bot proposal</title><link href="https://kura.gg/2014/05/29/python-platform-and-version-dependent-wheel-build-bot-proposal/" rel="alternate"></link><published>2014-05-29T12:30:00+01:00</published><updated>2014-05-29T12:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-05-29:/2014/05/29/python-platform-and-version-dependent-wheel-build-bot-proposal/</id><summary type="html">&lt;div class="section" id="abstract"&gt;
&lt;h2&gt;Abstract&lt;/h2&gt;
&lt;p&gt;This proposal describes a build system for generating “wheel” archives and is
very, very informal. This plan was drawn up after a random discussion with
Jannis Liedel on Twitter and &lt;span class="caps"&gt;IRC&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Wheel files can be platform and Python-version dependent, a way of generating
these files automatically needs to be created and linked to the Packaging
Index (PyPI.)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="design"&gt;
&lt;h2&gt;Design&lt;/h2&gt;
&lt;p&gt;After discussions with Jannis, I believe the simplest
solution would likely be the best solution for this problem. As such, I feel
that using a custom-built, lightweight solution makes more sense than using
something like buildbot.&lt;/p&gt;
&lt;div class="section" id="technology"&gt;
&lt;h3&gt;Technology&lt;/h3&gt;
&lt;p&gt;I feel the platform should leverage existing Python packages that are tried,
tested and well used in the community. Therefore I feel we should use a
combination of the following;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;RabbitMQ for queueing builds&lt;/li&gt;
&lt;li&gt;Celery for building wheels and&lt;/li&gt;
&lt;li&gt;pyenv for managing multiple Python versions&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="operating-systems"&gt;
&lt;h3&gt;Operating systems&lt;/h3&gt;
&lt;p&gt;I lack any understanding of Windows or …&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">&lt;div class="section" id="abstract"&gt;
&lt;h2&gt;Abstract&lt;/h2&gt;
&lt;p&gt;This proposal describes a build system for generating “wheel” archives and is
very, very informal. This plan was drawn up after a random discussion with
Jannis Liedel on Twitter and &lt;span class="caps"&gt;IRC&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Wheel files can be platform and Python-version dependent, a way of generating
these files automatically needs to be created and linked to the Packaging
Index (PyPI.)&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="design"&gt;
&lt;h2&gt;Design&lt;/h2&gt;
&lt;p&gt;After discussions with Jannis, I believe the simplest
solution would likely be the best solution for this problem. As such, I feel
that using a custom-built, lightweight solution makes more sense than using
something like buildbot.&lt;/p&gt;
&lt;div class="section" id="technology"&gt;
&lt;h3&gt;Technology&lt;/h3&gt;
&lt;p&gt;I feel the platform should leverage existing Python packages that are tried,
tested and well used in the community. Therefore I feel we should use a
combination of the following;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;RabbitMQ for queueing builds&lt;/li&gt;
&lt;li&gt;Celery for building wheels and&lt;/li&gt;
&lt;li&gt;pyenv for managing multiple Python versions&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="operating-systems"&gt;
&lt;h3&gt;Operating systems&lt;/h3&gt;
&lt;p&gt;I lack any understanding of Windows or Mac &lt;span class="caps"&gt;OS&lt;/span&gt; but, I believe the initial plan
should cover &lt;span class="caps"&gt;OS&lt;/span&gt; X and Linux, using a distro such as Ubuntu for building Linux packages.&lt;/p&gt;
&lt;p&gt;This way we can at least have wheels being built for &lt;span class="caps"&gt;OS&lt;/span&gt; X and Linux and work
on a plan to implement a Windows solution.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="pypi"&gt;
&lt;h2&gt;PyPI&lt;/h2&gt;
&lt;p&gt;My knowledge of PyPI internals are rather lacking, therefore I have no decided
how packages are passed to the build system to have their wheels built and
added to the PyPI warehouse.&lt;/p&gt;
&lt;p&gt;To begin with, we could simply provide a web form that allows a developer to
upload an sdist archive and be provided links to download their generated
wheel files.&lt;/p&gt;
&lt;p&gt;While this is not a good long term solution, it would at least allow for
testing of the build platform and for integration in to PyPI itself to be
fully discussed and implemented.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="notes"&gt;
&lt;h2&gt;Notes&lt;/h2&gt;
&lt;p&gt;This document is just a set of thoughts and ideas for how to do this, I’d
really like to get any feedback about this so we can action it and get
something going.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="wheel"></category></entry><entry><title>tugboat-bash-completion</title><link href="https://kura.gg/2014/05/28/tugboat-bash-completion/" rel="alternate"></link><published>2014-05-28T09:00:00+01:00</published><updated>2014-05-28T09:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-05-28:/2014/05/28/tugboat-bash-completion/</id><summary type="html">
&lt;p&gt;tugboat-bash-completion is a bash completion script the &lt;a class="reference external" href="https://github.com/pearkes/tugboat"&gt;tugboat&lt;/a&gt; &lt;span class="caps"&gt;CLI&lt;/span&gt; interface for the &lt;a class="reference external" href="https://www.digitalocean.com/"&gt;Digital Ocean&lt;/a&gt; &lt;span class="caps"&gt;API&lt;/span&gt;.&lt;/p&gt;
&lt;div class="section" id="downloads"&gt;
&lt;h2&gt;Downloads&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion/tarball/master"&gt;.tar.gz&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion/zipball/master"&gt;.zip&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="section" id="debian-ubuntu"&gt;
&lt;h3&gt;Debian/Ubuntu&lt;/h3&gt;
&lt;div class="section" id="install-manually"&gt;
&lt;h4&gt;Install manually&lt;/h4&gt;
&lt;p&gt;Download the source file from above and run the commands below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;make&lt;span class="w"&gt; &lt;/span&gt;install
.&lt;span class="w"&gt; &lt;/span&gt;~/bashrc
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Or you can do it the lazy way&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;https://github.com/kura/tugboat-bash-completion/blob/master/tugboat&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;-O&lt;span class="w"&gt; &lt;/span&gt;/etc/bash_completion.d/tugboat
.&lt;span class="w"&gt; &lt;/span&gt;~/bashrc
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="notes"&gt;
&lt;h2&gt;Notes&lt;/h2&gt;
&lt;p&gt;It’s worth noting that any command that supports a FUZZY_MATCH will take a
small amount of time to respond, due to querying the &lt;span class="caps"&gt;API&lt;/span&gt; for a list of either
droplets or images.&lt;/p&gt;
&lt;p&gt;Commands that do a droplet lookup;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;destroy&lt;/li&gt;
&lt;li&gt;halt&lt;/li&gt;
&lt;li&gt;info&lt;/li&gt;
&lt;li&gt;password-reset&lt;/li&gt;
&lt;li&gt;rebuild&lt;/li&gt;
&lt;li&gt;resize&lt;/li&gt;
&lt;li&gt;restart&lt;/li&gt;
&lt;li&gt;snapshot&lt;/li&gt;
&lt;li&gt;ssh&lt;/li&gt;
&lt;li&gt;start&lt;/li&gt;
&lt;li&gt;wait&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;An image lookup;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;destroy_image&lt;/li&gt;
&lt;li&gt;info_image&lt;/li&gt;
&lt;li&gt;rebuild&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="source"&gt;
&lt;h2&gt;Source&lt;/h2&gt;
&lt;p&gt;The source can be found on &lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion"&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="issues"&gt;
&lt;h2&gt;Issues&lt;/h2&gt;
&lt;p&gt;Issues can be tracked using &lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion/issues"&gt;GitHub Issues&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="license"&gt;
&lt;h2&gt;License&lt;/h2&gt;
&lt;p&gt;This software is licensed using the &lt;span class="caps"&gt;MIT&lt;/span&gt; License.
The license is provided in …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;tugboat-bash-completion is a bash completion script the &lt;a class="reference external" href="https://github.com/pearkes/tugboat"&gt;tugboat&lt;/a&gt; &lt;span class="caps"&gt;CLI&lt;/span&gt; interface for the &lt;a class="reference external" href="https://www.digitalocean.com/"&gt;Digital Ocean&lt;/a&gt; &lt;span class="caps"&gt;API&lt;/span&gt;.&lt;/p&gt;
&lt;div class="section" id="downloads"&gt;
&lt;h2&gt;Downloads&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion/tarball/master"&gt;.tar.gz&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion/zipball/master"&gt;.zip&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="section" id="debian-ubuntu"&gt;
&lt;h3&gt;Debian/Ubuntu&lt;/h3&gt;
&lt;div class="section" id="install-manually"&gt;
&lt;h4&gt;Install manually&lt;/h4&gt;
&lt;p&gt;Download the source file from above and run the commands below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;make&lt;span class="w"&gt; &lt;/span&gt;install
.&lt;span class="w"&gt; &lt;/span&gt;~/bashrc
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Or you can do it the lazy way&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;https://github.com/kura/tugboat-bash-completion/blob/master/tugboat&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;-O&lt;span class="w"&gt; &lt;/span&gt;/etc/bash_completion.d/tugboat
.&lt;span class="w"&gt; &lt;/span&gt;~/bashrc
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="notes"&gt;
&lt;h2&gt;Notes&lt;/h2&gt;
&lt;p&gt;It’s worth noting that any command that supports a FUZZY_MATCH will take a
small amount of time to respond, due to querying the &lt;span class="caps"&gt;API&lt;/span&gt; for a list of either
droplets or images.&lt;/p&gt;
&lt;p&gt;Commands that do a droplet lookup;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;destroy&lt;/li&gt;
&lt;li&gt;halt&lt;/li&gt;
&lt;li&gt;info&lt;/li&gt;
&lt;li&gt;password-reset&lt;/li&gt;
&lt;li&gt;rebuild&lt;/li&gt;
&lt;li&gt;resize&lt;/li&gt;
&lt;li&gt;restart&lt;/li&gt;
&lt;li&gt;snapshot&lt;/li&gt;
&lt;li&gt;ssh&lt;/li&gt;
&lt;li&gt;start&lt;/li&gt;
&lt;li&gt;wait&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;An image lookup;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;destroy_image&lt;/li&gt;
&lt;li&gt;info_image&lt;/li&gt;
&lt;li&gt;rebuild&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="source"&gt;
&lt;h2&gt;Source&lt;/h2&gt;
&lt;p&gt;The source can be found on &lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion"&gt;GitHub&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="issues"&gt;
&lt;h2&gt;Issues&lt;/h2&gt;
&lt;p&gt;Issues can be tracked using &lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion/issues"&gt;GitHub Issues&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="license"&gt;
&lt;h2&gt;License&lt;/h2&gt;
&lt;p&gt;This software is licensed using the &lt;span class="caps"&gt;MIT&lt;/span&gt; License.
The license is provided in the &lt;a class="reference external" href="https://github.com/kura/tugboat-bash-completion/blob/master/LICENSE"&gt;source code repository&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="digital ocean"></category><category term="tugboat"></category><category term="bash"></category><category term="completion"></category></entry><entry><title>Ghastly - A theme for Pelican</title><link href="https://kura.gg/2014/05/26/ghastly-a-theme-for-pelican/" rel="alternate"></link><published>2014-05-26T23:00:00+01:00</published><updated>2014-05-26T23:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-05-26:/2014/05/26/ghastly-a-theme-for-pelican/</id><content type="html">&lt;div class="figure"&gt;
&lt;img alt="Gastly, the Ghost Pokémon" src="/images/gastly.png"/&gt;
&lt;p class="caption"&gt;(Image by &lt;a class="reference external" href="https://raiba-art.deviantart.com/art/Gastly-294533100"&gt;Raiba-art&lt;/a&gt;)&lt;/p&gt;
&lt;/div&gt;

&lt;div class="section" id="introduction"&gt;
&lt;h2&gt;Introduction&lt;/h2&gt;
&lt;p&gt;I’d like to introduce Ghastly, a clean and minimal, lightweight theme for the
&lt;a class="reference external" href="https://getpelican.com"&gt;Pelican&lt;/a&gt; blogging platform.&lt;/p&gt;
&lt;p&gt;Ghastly is based heavily off of Casper, the default theme for
&lt;a class="reference external" href="https://ghost.org"&gt;Ghost&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It’s name is derived from the D&amp;amp;D monster, the Ghast and Gastly, the Pokémon.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="pelican"></category><category term="ghost"></category></entry><entry><title>Moved debian and ubuntu to separate repositories on apt.kura.gg</title><link href="https://kura.gg/2014/03/24/moved-debian-and-ubuntu-to-separate-repositories-on-apt.kura.gg/" rel="alternate"></link><published>2014-03-24T19:19:00+00:00</published><updated>2014-03-24T19:19:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-03-24:/2014/03/24/moved-debian-and-ubuntu-to-separate-repositories-on-apt.kura.gg/</id><content type="html">
&lt;p&gt;I have made a breaking change to the &lt;a class="reference external" href="/apt.kura.gg/"&gt;apt.kura.gg&lt;/a&gt; repositories.&lt;/p&gt;
&lt;p&gt;Ubuntu is now properly supported, but to do this properly it meant separating
Ubuntu and Debian in to totally separate sections to fix the dependency issues.&lt;/p&gt;
&lt;div class="section" id="breaking-changes"&gt;
&lt;h2&gt;Breaking changes&lt;/h2&gt;
&lt;p&gt;Anyone currently using apt.kura.gg as it is will get 404 errors and will need to
reconfigure their &lt;span class="caps"&gt;APT&lt;/span&gt; settings.&lt;/p&gt;
&lt;div class="section" id="debian"&gt;
&lt;h3&gt;Debian&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo sed -i 's/apt.kura.gg\//apt.kura.gg\/debian\//g' /etc/apt/sources.list.d/apt.kura.gg.list
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="ubuntu"&gt;
&lt;h3&gt;Ubuntu&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo sed -i 's/apt.kura.gg\//apt.kura.gg\/ubuntu\//g' /etc/apt/sources.list.d/apt.kura.gg.list
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="deb builds"></category><category term="apt"></category></entry><entry><title>apt.kura.gg now supports i386</title><link href="https://kura.gg/2014/03/08/apt.kura.gg-now-supports-i386/" rel="alternate"></link><published>2014-03-08T15:20:00+00:00</published><updated>2014-03-08T15:20:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-03-08:/2014/03/08/apt.kura.gg-now-supports-i386/</id><content type="html">&lt;p&gt;I have decided to support the i386 architecture on &lt;a class="reference external" href="/apt.kura.gg/"&gt;apt.kura.gg&lt;/a&gt; as well as amd64.&lt;/p&gt;
</content><category term="deb builds"></category><category term="apt"></category></entry><entry><title>haproxy1.5-dev22kura1</title><link href="https://kura.gg/2014/03/06/haproxy1.5-dev22kura1/" rel="alternate"></link><published>2014-03-06T03:32:00+00:00</published><updated>2014-03-06T03:32:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-03-06:/2014/03/06/haproxy1.5-dev22kura1/</id><summary type="html">
&lt;div class="section" id="changes"&gt;
&lt;h2&gt;Changes&lt;/h2&gt;
&lt;p&gt;This patched version is built using the &lt;cite&gt;USE_ZLIB&lt;/cite&gt; option, allowing for usage
of compression or using haproxy as a compression offloader.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;p&gt;haproxy requires openssl-1.0.1d or higher.&lt;/p&gt;
&lt;p&gt;On a standard Debian 7 install you should have openssl-1.0.1e-2, you
can find which version you have by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dpkg -l openssl
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This should return something similar to&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ii  openssl        1.0.1e-2        amd64        Secure Socket Layer (SSL) binary and related cryptographic tools
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="build-notes"&gt;
&lt;h2&gt;Build notes&lt;/h2&gt;
&lt;p&gt;Builds were done on Debian 7 &lt;span class="caps"&gt;AMD64&lt;/span&gt;, I will not be providing 32bit versions as
this is mainly for my own usage and amusement.&lt;/p&gt;
&lt;p&gt;This haproxy build is compiled against openssl, providing the npn module,
allowing for haproxy to work under &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt; and allowing the use of &lt;span class="caps"&gt;SPDY&lt;/span&gt;/2 and
&lt;span class="caps"&gt;SPDY&lt;/span&gt;/3.&lt;/p&gt;
&lt;p&gt;This version is available on &lt;a class="reference external" href="/apt.kura.gg/"&gt;apt.kura.gg&lt;/a&gt;
or as a manual download, from the link below.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="manual-download"&gt;
&lt;h2&gt;Manual download&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5-dev22kura1_amd64.deb"&gt;haproxy_1 …&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="changes"&gt;
&lt;h2&gt;Changes&lt;/h2&gt;
&lt;p&gt;This patched version is built using the &lt;cite&gt;USE_ZLIB&lt;/cite&gt; option, allowing for usage
of compression or using haproxy as a compression offloader.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;p&gt;haproxy requires openssl-1.0.1d or higher.&lt;/p&gt;
&lt;p&gt;On a standard Debian 7 install you should have openssl-1.0.1e-2, you
can find which version you have by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dpkg -l openssl
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This should return something similar to&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ii  openssl        1.0.1e-2        amd64        Secure Socket Layer (SSL) binary and related cryptographic tools
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="build-notes"&gt;
&lt;h2&gt;Build notes&lt;/h2&gt;
&lt;p&gt;Builds were done on Debian 7 &lt;span class="caps"&gt;AMD64&lt;/span&gt;, I will not be providing 32bit versions as
this is mainly for my own usage and amusement.&lt;/p&gt;
&lt;p&gt;This haproxy build is compiled against openssl, providing the npn module,
allowing for haproxy to work under &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt; and allowing the use of &lt;span class="caps"&gt;SPDY&lt;/span&gt;/2 and
&lt;span class="caps"&gt;SPDY&lt;/span&gt;/3.&lt;/p&gt;
&lt;p&gt;This version is available on &lt;a class="reference external" href="/apt.kura.gg/"&gt;apt.kura.gg&lt;/a&gt;
or as a manual download, from the link below.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="manual-download"&gt;
&lt;h2&gt;Manual download&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5-dev22kura1_amd64.deb"&gt;haproxy_1.5-dev22kura1_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="md5"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;5b1fbc3121fdc4ecb6687acd0bf7d83a  haproxy_1.5-dev22kura1_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="sha1"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;9d87ddacde26b75f8c9d723093cf2ef51615ec6e  haproxy_1.5-dev22kura1_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="deb builds"></category><category term="debian"></category><category term="ubuntu"></category><category term="haproxy"></category><category term="spdy"></category><category term="ssl"></category></entry><entry><title>pypip.in most requested shields</title><link href="https://kura.gg/2014/03/03/pypip.in-most-requested-shields/" rel="alternate"></link><published>2014-03-03T21:40:00+00:00</published><updated>2014-03-03T21:40:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-03-03:/2014/03/03/pypip.in-most-requested-shields/</id><summary type="html">
&lt;div class="section" id="pypip-in"&gt;
&lt;h2&gt;pypip.in&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://pypip.in/"&gt;pypip.in&lt;/a&gt; is a website &lt;a class="reference external" href="/2013/12/24/shields-for-pypi-packages/"&gt;I have written about before&lt;/a&gt;. I decided I would
look at the shields and see which ones were the most requested so far this year.&lt;/p&gt;
&lt;p&gt;Due to the volumn of requests, I only keep 90 days
of logs from nginx and no logs from Varnish, pypipin or the local version of
buckler. nginx sits in front of Varnish so, even if Varnish responds with a
cached version of the shield, a log line is still written to say it was requested.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="top-20"&gt;
&lt;h2&gt;Top 20&lt;/h2&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://docs.python-requests.org/en/latest/index.html"&gt;requests&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://pillow.readthedocs.org/en/latest/"&gt;Pillow&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;Pillow [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://deeplearning.net/software/theano/"&gt;Theano&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;Theano [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/joke2k/faker"&gt;fake-factory&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://livestreamer.tanuki.se/en/latest/install.html"&gt;livestreamer&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.django-cms.org/en/"&gt;django-cms&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;django-cms [version]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/sivel/speedtest-cli"&gt;speedtest-cli&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;speedtest-cli [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://boto.readthedocs.org/en/latest/"&gt;boto&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/globocom/thumbor"&gt;thumbor&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;thumbor [version]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.pip-installer.org/en/latest/"&gt;pip&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://pythonhosted.org/tweepy/html/"&gt;tweepy&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;tweepy [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://django-allauth.readthedocs.org/en/latest/"&gt;django-allauth&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://pymssql.org/"&gt;pymssql&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;pymssql [version]&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The first thing that struck me is that I actually hadn’t heard of or used
quite a lot of …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="pypip-in"&gt;
&lt;h2&gt;pypip.in&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://pypip.in/"&gt;pypip.in&lt;/a&gt; is a website &lt;a class="reference external" href="/2013/12/24/shields-for-pypi-packages/"&gt;I have written about before&lt;/a&gt;. I decided I would
look at the shields and see which ones were the most requested so far this year.&lt;/p&gt;
&lt;p&gt;Due to the volumn of requests, I only keep 90 days
of logs from nginx and no logs from Varnish, pypipin or the local version of
buckler. nginx sits in front of Varnish so, even if Varnish responds with a
cached version of the shield, a log line is still written to say it was requested.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="top-20"&gt;
&lt;h2&gt;Top 20&lt;/h2&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://docs.python-requests.org/en/latest/index.html"&gt;requests&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://pillow.readthedocs.org/en/latest/"&gt;Pillow&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;Pillow [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://deeplearning.net/software/theano/"&gt;Theano&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;Theano [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/joke2k/faker"&gt;fake-factory&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://livestreamer.tanuki.se/en/latest/install.html"&gt;livestreamer&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.django-cms.org/en/"&gt;django-cms&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;django-cms [version]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/sivel/speedtest-cli"&gt;speedtest-cli&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;speedtest-cli [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://boto.readthedocs.org/en/latest/"&gt;boto&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://github.com/globocom/thumbor"&gt;thumbor&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;thumbor [version]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.pip-installer.org/en/latest/"&gt;pip&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://pythonhosted.org/tweepy/html/"&gt;tweepy&lt;/a&gt; [version]&lt;/li&gt;
&lt;li&gt;tweepy [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://django-allauth.readthedocs.org/en/latest/"&gt;django-allauth&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://pymssql.org/"&gt;pymssql&lt;/a&gt; [downloads]&lt;/li&gt;
&lt;li&gt;pymssql [version]&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The first thing that struck me is that I actually hadn’t heard of or used
quite a lot of those packages from the list.&lt;/p&gt;
&lt;p&gt;The second thing that struck me is the popularity of the pymssql package, but
that popularity in this instance is only based on the number of requests for
the shields and cannot be used to verify the usage popularity of the package itself.&lt;/p&gt;
&lt;p&gt;Anyway, pretty much useless information, but I was bored.&lt;/p&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="python"></category><category term="pypi"></category><category term="pip"></category></entry><entry><title>vagrant-bash-completion &amp; go-bash-completion on apt.kura.gg</title><link href="https://kura.gg/2014/02/27/vagrant-bash-completion-and-go-bash-completion-on-apt.kura.gg/" rel="alternate"></link><published>2014-02-27T23:14:00+00:00</published><updated>2014-02-27T23:14:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-02-27:/2014/02/27/vagrant-bash-completion-and-go-bash-completion-on-apt.kura.gg/</id><content type="html">
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;bash-completion 1:2.0&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="downloads"&gt;
&lt;h2&gt;Downloads&lt;/h2&gt;
&lt;p&gt;There versions are available on &lt;a class="reference external" href="/apt.kura.gg/"&gt;apt.kura.gg&lt;/a&gt;
or as a manual download, from the links below.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="manual-download"&gt;
&lt;h2&gt;Manual download&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/vagrant-bash-completion-0.0.6.deb"&gt;vagrant-bash-completion-0.0.6.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/go-bash-completion-0.0.1.deb"&gt;go-bash-completion-0.0.1.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="md5"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;1dcb73ca965b3731df20823a6005392c  vagrant-bash-completion-0.0.6.deb
db494d0bf1b3dcdbcce5b0111ad377a0  go-bash-completion-0.0.1.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="sha1"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ed6890fdd08ac459a0f61112fcfb48f9e3ce953d  vagrant-bash-completion-0.0.6.deb
fd92cd53f2d6ff98077cb10d3578381025d002e7  go-bash-completion-0.0.1.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="deb builds"></category><category term="debian"></category><category term="ubuntu"></category><category term="vagrant"></category><category term="go"></category><category term="bash"></category><category term="completion"></category></entry><entry><title>haproxy1.5-dev22</title><link href="https://kura.gg/2014/02/22/haproxy1.5-dev22/" rel="alternate"></link><published>2014-02-22T05:32:00+00:00</published><updated>2014-02-22T05:32:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-02-22:/2014/02/22/haproxy1.5-dev22/</id><content type="html">
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;p&gt;haproxy requires openssl-1.0.1d or higher.&lt;/p&gt;
&lt;p&gt;On a standard Debian 7 install you should have openssl-1.0.1e-2, you
can find which version you have by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dpkg -l openssl
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This should return something similar to&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ii  openssl        1.0.1e-2        amd64        Secure Socket Layer (SSL) binary and related cryptographic tools
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="build-notes"&gt;
&lt;h2&gt;Build notes&lt;/h2&gt;
&lt;p&gt;Builds were done on Debian 7 &lt;span class="caps"&gt;AMD64&lt;/span&gt;, I will not be providing 32bit versions as
this is mainly for my own usage and amusement.&lt;/p&gt;
&lt;p&gt;This haproxy build is compiled against openssl, providing the npn module,
allowing for haproxy to work under &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt; and allowing the use of &lt;span class="caps"&gt;SPDY&lt;/span&gt;/2 and
&lt;span class="caps"&gt;SPDY&lt;/span&gt;/3.&lt;/p&gt;
&lt;p&gt;This version is available on &lt;a class="reference external" href="/apt.kura.gg/"&gt;apt.kura.gg&lt;/a&gt;
or as a manual download, from the link below.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="manual-download"&gt;
&lt;h2&gt;Manual download&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5-dev22_amd64.deb"&gt;haproxy_1.5-dev22_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="md5"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;1d258aaf1592ac5d6cb34e495e283591  haproxy_1.5-dev22_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="sha1"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;f17cb661d2ceb1686a0a4b8566168503a0d372d9  haproxy_1.5-dev22_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="deb builds"></category><category term="debian"></category><category term="ubuntu"></category><category term="haproxy"></category><category term="spdy"></category><category term="ssl"></category></entry><entry><title>haproxy stateful SSL session resumption</title><link href="https://kura.gg/2014/02/22/haproxy-stateful-ssl-session-resumption/" rel="alternate"></link><published>2014-02-22T05:10:00+00:00</published><updated>2014-02-22T05:10:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-02-22:/2014/02/22/haproxy-stateful-ssl-session-resumption/</id><content type="html">
&lt;p&gt;By default haproxy enables stateless &lt;span class="caps"&gt;SSL&lt;/span&gt; session resumption, but you can enable
stateful session resumption in accordance with
&lt;a class="reference external" href="https://www.ietf.org/rfc/rfc5077.txt"&gt;&lt;span class="caps"&gt;RFC&lt;/span&gt; 5077&lt;/a&gt;. This functionality, like
the &lt;span class="caps"&gt;SSL&lt;/span&gt; handling it relies on is only available from haproxy 1.5.&lt;/p&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;The option to enable stateful &lt;span class="caps"&gt;SSL&lt;/span&gt; session resumption is as below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
no-tls-tickets
&lt;/pre&gt;
&lt;p&gt;You will need to add it in to your bind line, like below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
bind 0.0.0.0:443 ssl ... no-tls-tickets
&lt;/pre&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="haproxy"></category><category term="ssl"></category></entry><entry><title>nginx 1.5.10 with SPDY 3.1</title><link href="https://kura.gg/2014/02/06/nnginx-1.5.10-with-spdy3.1/" rel="alternate"></link><published>2014-02-06T03:30:00+00:00</published><updated>2014-02-06T03:30:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-02-06:/2014/02/06/nnginx-1.5.10-with-spdy3.1/</id><summary type="html">
&lt;p&gt;I have built and released nginx 1.5.10 with &lt;span class="caps"&gt;SPDY&lt;/span&gt; 3.1. Like the &lt;a class="reference external" href="/2014/02/02/nginx-1.5.9-and-ngx_pagespeed-1.7.30.3-beta/"&gt;nginx 1.5.9
release&lt;/a&gt;
, this release comes with ngx_pagespeed 1.7.30.3-beta and is available
on &lt;a class="reference external" href="https://apt.kura.gg"&gt;apt.kura.gg&lt;/a&gt; or as downloads below.&lt;/p&gt;
&lt;div class="section" id="manual-download"&gt;
&lt;h2&gt;Manual download&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.5.10_all.deb"&gt;nginx_1.5.10_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.5.10_all.deb"&gt;nginx-common_1.5.10_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.5.10_all.deb"&gt;nginx-doc_1.5.10_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light_1.5.10_amd64.deb"&gt;nginx-light_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.5.10_amd64.deb"&gt;nginx-full_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras_1.5.10_amd64.deb"&gt;nginx-extras_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi_1.5.10_amd64.deb"&gt;nginx-naxsi_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-ui_1.5.10_all.deb"&gt;nginx-naxsi-ui_1.5.10_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light-dbg_1.5.10_amd64.deb"&gt;nginx-light-dbg_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full-dbg_1.5.10_amd64.deb"&gt;nginx-full-dbg_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras-dbg_1.5.10_amd64.deb"&gt;nginx-extras-dbg_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-dbg_1.5.10_amd64.deb"&gt;nginx-naxsi-dbg_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="md5"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;9fe2e5273cc195161268f7d85261c4e2  nginx_1.5.10_all.deb
edc55aa4866036eade02cd49957a9126  nginx-common_1.5.10_all.deb
0361cdb3d00ac6e65c5e9d6167ba0d36  nginx-doc_1.5.10_all.deb
833264c08fc6212f55ae37c26bd5cbc5  nginx-light_1.5.10_amd64.deb
c5c1ffa0dd93673ac4a859a11d1b3b50  nginx-full_1.5.10_amd64.deb
245d7628f143a6116ceb30c707264737  nginx-extras_1.5.10_amd64.deb
dc404a346db86006672b5a6f8b016402  nginx-naxsi_1.5.10_amd64.deb
ad3b7cf166752c2a8017bba8f6810496  nginx-naxsi-ui_1.5.10_all.deb
cdb47100b4fef09bb8a8e414cd48554e  nginx-light-dbg_1.5.10_amd64.deb
1ee2067aef2e1fcbc559dfdf9b8269ad  nginx-full-dbg_1.5.10_amd64.deb
9f528d80802dd6a78d85b8558e65f650  nginx-extras-dbg_1.5.10_amd64.deb
324dbf6afdff615d7c2bbe367f73bd1f  nginx-naxsi-dbg_1.5.10_amd64 …&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I have built and released nginx 1.5.10 with &lt;span class="caps"&gt;SPDY&lt;/span&gt; 3.1. Like the &lt;a class="reference external" href="/2014/02/02/nginx-1.5.9-and-ngx_pagespeed-1.7.30.3-beta/"&gt;nginx 1.5.9
release&lt;/a&gt;
, this release comes with ngx_pagespeed 1.7.30.3-beta and is available
on &lt;a class="reference external" href="https://apt.kura.gg"&gt;apt.kura.gg&lt;/a&gt; or as downloads below.&lt;/p&gt;
&lt;div class="section" id="manual-download"&gt;
&lt;h2&gt;Manual download&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.5.10_all.deb"&gt;nginx_1.5.10_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.5.10_all.deb"&gt;nginx-common_1.5.10_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.5.10_all.deb"&gt;nginx-doc_1.5.10_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light_1.5.10_amd64.deb"&gt;nginx-light_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.5.10_amd64.deb"&gt;nginx-full_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras_1.5.10_amd64.deb"&gt;nginx-extras_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi_1.5.10_amd64.deb"&gt;nginx-naxsi_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-ui_1.5.10_all.deb"&gt;nginx-naxsi-ui_1.5.10_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light-dbg_1.5.10_amd64.deb"&gt;nginx-light-dbg_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full-dbg_1.5.10_amd64.deb"&gt;nginx-full-dbg_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras-dbg_1.5.10_amd64.deb"&gt;nginx-extras-dbg_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-dbg_1.5.10_amd64.deb"&gt;nginx-naxsi-dbg_1.5.10_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="md5"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;9fe2e5273cc195161268f7d85261c4e2  nginx_1.5.10_all.deb
edc55aa4866036eade02cd49957a9126  nginx-common_1.5.10_all.deb
0361cdb3d00ac6e65c5e9d6167ba0d36  nginx-doc_1.5.10_all.deb
833264c08fc6212f55ae37c26bd5cbc5  nginx-light_1.5.10_amd64.deb
c5c1ffa0dd93673ac4a859a11d1b3b50  nginx-full_1.5.10_amd64.deb
245d7628f143a6116ceb30c707264737  nginx-extras_1.5.10_amd64.deb
dc404a346db86006672b5a6f8b016402  nginx-naxsi_1.5.10_amd64.deb
ad3b7cf166752c2a8017bba8f6810496  nginx-naxsi-ui_1.5.10_all.deb
cdb47100b4fef09bb8a8e414cd48554e  nginx-light-dbg_1.5.10_amd64.deb
1ee2067aef2e1fcbc559dfdf9b8269ad  nginx-full-dbg_1.5.10_amd64.deb
9f528d80802dd6a78d85b8558e65f650  nginx-extras-dbg_1.5.10_amd64.deb
324dbf6afdff615d7c2bbe367f73bd1f  nginx-naxsi-dbg_1.5.10_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="sha1"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;7d66910ba00a49d04f8f00bd82470f8c9fbcb99f  nginx_1.5.10_all.deb
6ce87bbcd1f87bc10bf75db5dc54470987bc6074  nginx-common_1.5.10_all.deb
e18587fa5ce6638105455c1ef2b761cde848b9cf  nginx-doc_1.5.10_all.deb
4add8919e34e3c95375d41fd2d14a07aad983f4e  nginx-light_1.5.10_amd64.deb
87cfa2171f47e662c95599011500c9aa9ef26b2e  nginx-full_1.5.10_amd64.deb
153f77b5d21b396f603bbd8486641b3d7fcde8a8  nginx-extras_1.5.10_amd64.deb
5392e0dd57df0475d028766aceda7630d486a23f  nginx-naxsi_1.5.10_amd64.deb
a294cbe57021eed9ddcd2e921a6e2644f601bd77  nginx-naxsi-ui_1.5.10_all.deb
b61ace4af4be8bef7210e5bbf4b69410b7bca010  nginx-light-dbg_1.5.10_amd64.deb
b334bb1e57d3920f68e2dd37399156281105eefb  nginx-full-dbg_1.5.10_amd64.deb
05bac4c8bbb913ca0e3bdb11b2a82befe84198c4  nginx-extras-dbg_1.5.10_amd64.deb
97b51fc8e05be3ba00e8daf11050d4bde67d5824  nginx-naxsi-dbg_1.5.10_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="deb builds"></category><category term="debian"></category><category term="ubuntu"></category><category term="nginx"></category><category term="spdy"></category><category term="pagespeed"></category><category term="ngx_pagespeed"></category></entry><entry><title>nginx 1.5.9 and ngx_pagespeed 1.7.30.3-beta</title><link href="https://kura.gg/2014/02/02/nginx-1.5.9-and-ngx_pagespeed-1.7.30.3-beta/" rel="alternate"></link><published>2014-02-02T17:54:00+00:00</published><updated>2014-02-02T17:54:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-02-02:/2014/02/02/nginx-1.5.9-and-ngx_pagespeed-1.7.30.3-beta/</id><summary type="html">
&lt;p&gt;I have built and released nginx 1.5.9 with ngx_pagespeed module 1.7.30.3-beta
and published them on &lt;a class="reference external" href="https://apt.kura.gg"&gt;apt.kura.gg&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="manual-download-install"&gt;
&lt;h2&gt;Manual download &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; install&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.5.9_all.deb"&gt;nginx_1.5.9_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.5.9_all.deb"&gt;nginx-common_1.5.9_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.5.9_all.deb"&gt;nginx-doc_1.5.9_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light_1.5.9_amd64.deb"&gt;nginx-light_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.5.9_amd64.deb"&gt;nginx-full_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras_1.5.9_amd64.deb"&gt;nginx-extras_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi_1.5.9_amd64.deb"&gt;nginx-naxsi_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-ui_1.5.9_all.deb"&gt;nginx-naxsi-ui_1.5.9_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light-dbg_1.5.9_amd64.deb"&gt;nginx-light-dbg_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full-dbg_1.5.9_amd64.deb"&gt;nginx-full-dbg_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras-dbg_1.5.9_amd64.deb"&gt;nginx-extras-dbg_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-dbg_1.5.9_amd64.deb"&gt;nginx-naxsi-dbg_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="md5"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;e3595519df9865941f0bd5c2c28bba18  nginx_1.5.9_all.deb
b2f3e4dcded2ce419175be8f4329b81e  nginx-common_1.5.9_all.deb
379ea6ad2805f3584609617deb5d1db9  nginx-doc_1.5.9_all.deb
140247350a651b24bde7278ce1f18148  nginx-light_1.5.9_amd64.deb
0a28a4965f00a5e739187aa81a16af3f  nginx-full_1.5.9_amd64.deb
e54ab6b670cfe7d56502ef08b6e2656f  nginx-extras_1.5.9_amd64.deb
9bb9b524c523a69f9f263eefbe5f5783  nginx-naxsi_1.5.9_amd64.deb
7b8e254515d3b6f90b8e55c720d314b8  nginx-naxsi-ui_1.5.9_all.deb
389b8b53360695d5fbbff183a3e94c4a  nginx-light-dbg_1.5.9_amd64.deb
b8b44d1519cb59761984bc06159aee85  nginx-full-dbg_1.5.9_amd64.deb
c8139d0abb8a04b22507342a80e6f5ea  nginx-naxsi-dbg_1.5.9_amd64.deb
76466c2c427e7263b3629b413ebd49a6  nginx-extras-dbg_1.5.9_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="sha1"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cc1e71b89c30de80083e55acb4b4cebc0f5f1fd7  nginx_1.5.9_all.deb
07d2bb7bdb038f5491b8707a56dafbf0a10a1b74  nginx-common_1.5.9_all.deb
ba0921fc31ae539fba175ab4392b3bc691593047  nginx-doc_1.5.9_all …&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I have built and released nginx 1.5.9 with ngx_pagespeed module 1.7.30.3-beta
and published them on &lt;a class="reference external" href="https://apt.kura.gg"&gt;apt.kura.gg&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="manual-download-install"&gt;
&lt;h2&gt;Manual download &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; install&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.5.9_all.deb"&gt;nginx_1.5.9_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.5.9_all.deb"&gt;nginx-common_1.5.9_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.5.9_all.deb"&gt;nginx-doc_1.5.9_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light_1.5.9_amd64.deb"&gt;nginx-light_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.5.9_amd64.deb"&gt;nginx-full_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras_1.5.9_amd64.deb"&gt;nginx-extras_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi_1.5.9_amd64.deb"&gt;nginx-naxsi_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-ui_1.5.9_all.deb"&gt;nginx-naxsi-ui_1.5.9_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light-dbg_1.5.9_amd64.deb"&gt;nginx-light-dbg_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full-dbg_1.5.9_amd64.deb"&gt;nginx-full-dbg_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras-dbg_1.5.9_amd64.deb"&gt;nginx-extras-dbg_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-dbg_1.5.9_amd64.deb"&gt;nginx-naxsi-dbg_1.5.9_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="md5"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;e3595519df9865941f0bd5c2c28bba18  nginx_1.5.9_all.deb
b2f3e4dcded2ce419175be8f4329b81e  nginx-common_1.5.9_all.deb
379ea6ad2805f3584609617deb5d1db9  nginx-doc_1.5.9_all.deb
140247350a651b24bde7278ce1f18148  nginx-light_1.5.9_amd64.deb
0a28a4965f00a5e739187aa81a16af3f  nginx-full_1.5.9_amd64.deb
e54ab6b670cfe7d56502ef08b6e2656f  nginx-extras_1.5.9_amd64.deb
9bb9b524c523a69f9f263eefbe5f5783  nginx-naxsi_1.5.9_amd64.deb
7b8e254515d3b6f90b8e55c720d314b8  nginx-naxsi-ui_1.5.9_all.deb
389b8b53360695d5fbbff183a3e94c4a  nginx-light-dbg_1.5.9_amd64.deb
b8b44d1519cb59761984bc06159aee85  nginx-full-dbg_1.5.9_amd64.deb
c8139d0abb8a04b22507342a80e6f5ea  nginx-naxsi-dbg_1.5.9_amd64.deb
76466c2c427e7263b3629b413ebd49a6  nginx-extras-dbg_1.5.9_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="sha1"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;cc1e71b89c30de80083e55acb4b4cebc0f5f1fd7  nginx_1.5.9_all.deb
07d2bb7bdb038f5491b8707a56dafbf0a10a1b74  nginx-common_1.5.9_all.deb
ba0921fc31ae539fba175ab4392b3bc691593047  nginx-doc_1.5.9_all.deb
f9f60ee3801763f4aff2fc6aa1caf888b283c136  nginx-extras_1.5.9_amd64.deb
90680c8ac48712b5e50c88b61362c49edafc1f4a  nginx-full_1.5.9_amd64.deb
d9a1adc90d95d8ff59de73d355bfcc931938d9de  nginx-light_1.5.9_amd64.deb
45e51765ac9e4d7fb987ca73e601b3bf308dc509  nginx-naxsi_1.5.9_amd64.deb
410a9e383336d9976a4d09a16a219b8cc5f61d49  nginx-naxsi-ui_1.5.9_all.deb
5aa804a3b39054ff8b209165dd6b04c41d14a835  nginx-light-dbg_1.5.9_amd64.deb
736be8c2e3bf1e2a0a29fc8c31aec39173dbe0d1  nginx-full-dbg_1.5.9_amd64.deb
d5b759c20d63e9e1a004f2eb032728ff23a38ee8  nginx-extras-dbg_1.5.9_amd64.deb
9ada12946cd24f948ea193d3d4b2db780cc40adf  nginx-naxsi-dbg_1.5.9_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="deb builds"></category><category term="debian"></category><category term="ubuntu"></category><category term="haproxy"></category><category term="nginx"></category><category term="spdy"></category><category term="pagespeed"></category><category term="ngx_pagespeed"></category></entry><entry><title>kura.gg’s A* SSL rating</title><link href="https://kura.gg/2014/02/02/kura.gg-a-star-ssl-rating/" rel="alternate"></link><published>2014-02-02T15:18:00+00:00</published><updated>2014-02-02T15:18:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-02-02:/2014/02/02/kura.gg-a-star-ssl-rating/</id><summary type="html">
&lt;p&gt;I am a firm believer in using &lt;span class="caps"&gt;SSL&lt;/span&gt; as much as possible, for me that is pretty
much everywhere and, thanks to the wonderful guys at
&lt;a class="reference external" href="https://www.globalsign.com/"&gt;GlobalSign&lt;/a&gt;, most of
my &lt;span class="caps"&gt;SSL&lt;/span&gt; certificates are free becauses my projects are all open source.&lt;/p&gt;
&lt;p&gt;I used a blog post by &lt;a class="reference external" href="https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/"&gt;Hynek Schlawack&lt;/a&gt;
as a base for my &lt;span class="caps"&gt;SSL&lt;/span&gt; setup, he is keeping this article up-to-date as much as
possible so it should be a great source for any security conscious people that
would like to know more and get good explanations about each part.&lt;/p&gt;
&lt;p&gt;Let’s take a brief look at how this website achieves it’s A* rating.&lt;/p&gt;
&lt;div class="section" id="key"&gt;
&lt;h2&gt;Key&lt;/h2&gt;
&lt;p&gt;I use a 4096 bit &lt;span class="caps"&gt;RSA&lt;/span&gt; key that is no a &lt;a class="reference external" href="https://wiki.debian.org/SSLkeys#Identifying_Weak_Keys"&gt;Debian weak key&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="protcols"&gt;
&lt;h2&gt;Protcols&lt;/h2&gt;
&lt;p&gt;I do not support SSLv2 or SSLv3 but I do support much stronger protocols;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;span class="caps"&gt;TLS&lt;/span&gt; 1.2,&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;TLS&lt;/span&gt; 1.1 and,&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;TLS&lt;/span&gt; 1.0.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="dhparam"&gt;
&lt;h2&gt;dhparam&lt;/h2&gt;
&lt;p&gt;It’s a …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I am a firm believer in using &lt;span class="caps"&gt;SSL&lt;/span&gt; as much as possible, for me that is pretty
much everywhere and, thanks to the wonderful guys at
&lt;a class="reference external" href="https://www.globalsign.com/"&gt;GlobalSign&lt;/a&gt;, most of
my &lt;span class="caps"&gt;SSL&lt;/span&gt; certificates are free becauses my projects are all open source.&lt;/p&gt;
&lt;p&gt;I used a blog post by &lt;a class="reference external" href="https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/"&gt;Hynek Schlawack&lt;/a&gt;
as a base for my &lt;span class="caps"&gt;SSL&lt;/span&gt; setup, he is keeping this article up-to-date as much as
possible so it should be a great source for any security conscious people that
would like to know more and get good explanations about each part.&lt;/p&gt;
&lt;p&gt;Let’s take a brief look at how this website achieves it’s A* rating.&lt;/p&gt;
&lt;div class="section" id="key"&gt;
&lt;h2&gt;Key&lt;/h2&gt;
&lt;p&gt;I use a 4096 bit &lt;span class="caps"&gt;RSA&lt;/span&gt; key that is no a &lt;a class="reference external" href="https://wiki.debian.org/SSLkeys#Identifying_Weak_Keys"&gt;Debian weak key&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="protcols"&gt;
&lt;h2&gt;Protcols&lt;/h2&gt;
&lt;p&gt;I do not support SSLv2 or SSLv3 but I do support much stronger protocols;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;span class="caps"&gt;TLS&lt;/span&gt; 1.2,&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;TLS&lt;/span&gt; 1.1 and,&lt;/li&gt;
&lt;li&gt;&lt;span class="caps"&gt;TLS&lt;/span&gt; 1.0.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="dhparam"&gt;
&lt;h2&gt;dhparam&lt;/h2&gt;
&lt;p&gt;It’s a good idea to generate a set of &lt;span class="caps"&gt;DH&lt;/span&gt; parameters with a prime that is larger than the &lt;span class="caps"&gt;RSA&lt;/span&gt; key being used.
For me that’s 4096 so to generate this I use:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;dhparam&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once generated it gets appended to our &lt;span class="caps"&gt;PEM&lt;/span&gt; chain.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;-----BEGIN CERTIFICATE-----
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
-----END RSA PRIVATE KEY-----
-----BEGIN CERTIFICATE----- # intermediate cert
-----END CERTIFICATE-----
-----BEGIN DH PARAMETERS-----
-----END DH PARAMETERS-----
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="cipher-suites-key-exchanges"&gt;
&lt;h2&gt;Cipher suites &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; key exchanges&lt;/h2&gt;
&lt;p&gt;I only support &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Elliptic_curve_Diffie%E2%80%93Hellman"&gt;Elliptic curve Diffie–Hellman&lt;/a&gt; and
&lt;a class="reference external" href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange"&gt;Diffie–Hellman&lt;/a&gt; for key exchange.&lt;/p&gt;
&lt;p&gt;The website prefers &lt;span class="caps"&gt;ECDH&lt;/span&gt;+&lt;span class="caps"&gt;AESGCM&lt;/span&gt; or &lt;span class="caps"&gt;DH&lt;/span&gt;+&lt;span class="caps"&gt;AESGCM&lt;/span&gt; which specifically uses &lt;span class="caps"&gt;AES&lt;/span&gt;-128,
if &lt;span class="caps"&gt;AESGCM&lt;/span&gt; isn’t supported by the browser (at time of writing, it’s only
support by Chrome 32) it will fall back to &lt;span class="caps"&gt;ECDH&lt;/span&gt;+&lt;span class="caps"&gt;AES256&lt;/span&gt; or &lt;span class="caps"&gt;DH&lt;/span&gt;+&lt;span class="caps"&gt;AES256&lt;/span&gt; or fall
further back to &lt;span class="caps"&gt;ECDH&lt;/span&gt;+&lt;span class="caps"&gt;AES128&lt;/span&gt; or &lt;span class="caps"&gt;DH&lt;/span&gt;+&lt;span class="caps"&gt;AES&lt;/span&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ECDH+AESGCM:DH+AESGCM:ECDH+AES256:DH+AES256:ECDH+AES128:DH+AES:HIGH:!aNULL:!eNULL:!EXPORT:!MD5:!DSS:!DES:!3DES:!RC4:!PSK
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For most browser versions this should provide extremely secure connectivity
and &lt;a class="reference external" href="https://community.qualys.com/blogs/securitylabs/2013/06/25/ssl-labs-deploying-forward-secrecy"&gt;Forward Secrecy&lt;/a&gt;.
Please consult the &lt;a class="reference internal" href="#notes"&gt;Notes&lt;/a&gt; section for more information.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="forcing-ssl-usage"&gt;
&lt;h2&gt;Forcing &lt;span class="caps"&gt;SSL&lt;/span&gt; usage&lt;/h2&gt;
&lt;p&gt;This one is really quite simple, if you attempt to browse this site using
the unsecure interface (&lt;span class="caps"&gt;HTTP&lt;/span&gt;) you will simply be redirected to a secure interface.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="ssl-compression"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt; compression&lt;/h2&gt;
&lt;p&gt;Thankfully, at time of writing, I am using OpenSSL 1.0.1e and nginx 1.5.8
meaning &lt;span class="caps"&gt;SSL&lt;/span&gt; compression is disabled, you will have to do some Googling to find
out what specific versions you will need to disable &lt;span class="caps"&gt;SSL&lt;/span&gt; compression.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="hsts"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;HSTS&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Finally, I support &lt;a class="reference external" href="https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security"&gt;&lt;span class="caps"&gt;HSTS&lt;/span&gt;&lt;/a&gt;
telling my browser it should only access this website via a secure method, this
is done by simply providing an &lt;span class="caps"&gt;STS&lt;/span&gt; header as shown below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;Strict-Transport-Security: max-age=15768000
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="notes"&gt;
&lt;h2&gt;Notes&lt;/h2&gt;
&lt;p&gt;This configuration does not allow for Windows &lt;span class="caps"&gt;XP&lt;/span&gt; operating system or &lt;span class="caps"&gt;IE6&lt;/span&gt;. It
supports &lt;span class="caps"&gt;IE7&lt;/span&gt; and above on Windows Vista or higher.&lt;/p&gt;
&lt;p&gt;Consult &lt;a class="reference external" href="https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/"&gt;Hynek’s article&lt;/a&gt; for support for Windows &lt;span class="caps"&gt;XP&lt;/span&gt; and &lt;span class="caps"&gt;IE6&lt;/span&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="testing"&gt;
&lt;h2&gt;Testing&lt;/h2&gt;
&lt;p&gt;You can use &lt;a class="reference external" href="https://www.ssllabs.com/ssltest/analyze.html"&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt; Labs by Qualys&lt;/a&gt;
to determine your own website’s security and you can look at the
&lt;a class="reference external" href="https://www.ssllabs.com/ssltest/analyze.html?d=kura.gg"&gt;Qualys report&lt;/a&gt; for
this website as a comparison.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="more-information"&gt;
&lt;h2&gt;More information&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://hynek.me/articles/hardening-your-web-servers-ssl-ciphers/"&gt;Hynek’s article&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://wiki.mozilla.org/Security/Server_Side_TLS"&gt;Mozilla Security/Server Side &lt;span class="caps"&gt;TLS&lt;/span&gt; article&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="ssl"></category></entry><entry><title>Advertise multiple NPN protocols with haproxy</title><link href="https://kura.gg/2014/01/31/advertise-multiple-npn-protocols-with-haproxy/" rel="alternate"></link><published>2014-01-31T15:25:00+00:00</published><updated>2014-01-31T15:25:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-01-31:/2014/01/31/advertise-multiple-npn-protocols-with-haproxy/</id><content type="html">&lt;p&gt;I have previously written an article on &lt;a class="reference external" href="/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/"&gt;using &lt;span class="caps"&gt;SPDY&lt;/span&gt; with haproxy&lt;/a&gt;
but have been spending some time recently being annoyed that the &lt;a class="reference external" href="https://spdycheck.org/#kura.gg"&gt;&lt;span class="caps"&gt;SPDY&lt;/span&gt; check
tool&lt;/a&gt; said I didn’t advertise a fall back to
&lt;span class="caps"&gt;HTTP&lt;/span&gt; over &lt;span class="caps"&gt;SSL&lt;/span&gt; in the &lt;span class="caps"&gt;NPN&lt;/span&gt; protocol list.&lt;/p&gt;
&lt;p&gt;After some digging I discovered it was actually quite simple to advertise
multiple protocols using npn and haproxy.&lt;/p&gt;
&lt;p&gt;Previously my article called for using the following section of configuration
at the end of the bind line.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;npn spdy/2
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To advertise &lt;span class="caps"&gt;HTTP&lt;/span&gt; protocols as well as &lt;span class="caps"&gt;SPDY&lt;/span&gt; you simply need to add them to the
npn list, using commas as a delimiter.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;npn spdy/2,http/1.1
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="haproxy"></category><category term="npn"></category><category term="spdy"></category><category term="http/1.1"></category></entry><entry><title>apt.kura.gg</title><link href="https://kura.gg/2014/01/26/apt.kura.gg/" rel="alternate"></link><published>2014-01-26T02:05:00+00:00</published><updated>2014-01-26T02:05:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-01-26:/2014/01/26/apt.kura.gg/</id><content type="html">&lt;p&gt;After releasing my own versions of haproxy with &lt;span class="caps"&gt;SPDY&lt;/span&gt; support and nginx with
ngx_pagespeed and &lt;span class="caps"&gt;SPDY&lt;/span&gt; support, I decided it would make sense to actually
host these in my own apt repository, so I did.&lt;/p&gt;
&lt;p&gt;You can enable this by adding it to your apt config.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;-qO&lt;span class="w"&gt; &lt;/span&gt;-&lt;span class="w"&gt; &lt;/span&gt;https://apt.kura.gg/apt.kura.gg.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-key&lt;span class="w"&gt; &lt;/span&gt;add&lt;span class="w"&gt; &lt;/span&gt;-
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"deb https://apt.kura.gg/ `lsb_release -cs` main"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;tee&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/sources.list.d/apt.kura.gg.list
sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;update
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Simple.&lt;/p&gt;
</content><category term="deb builds"></category><category term="apt"></category></entry><entry><title>deadsnakes.sh</title><link href="https://kura.gg/2014/01/26/deadsnakes.sh/" rel="alternate"></link><published>2014-01-26T01:50:00+00:00</published><updated>2014-01-26T01:50:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-01-26:/2014/01/26/deadsnakes.sh/</id><content type="html">&lt;p&gt;If you’re an Python developer that uses Ubuntu or even Debian, you have
probably heard of Felix Krull’s &lt;a class="reference external" href="https://launchpad.net/~fkrull/+archive/deadsnakes"&gt;deadsnakes&lt;/a&gt; &lt;span class="caps"&gt;PPA&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I find myself using it a lot and since I tend to destroy my environments quite
frequently, I thought I’d save myself some time and write a simple
shell script to install the &lt;span class="caps"&gt;PPA&lt;/span&gt;, the versions of Python I frequently use and,
after messing up a machine — ignore the existing version of python.&lt;/p&gt;
&lt;p&gt;Gist removed. Sorry.&lt;/p&gt;
</content><category term="coding"></category><category term="python"></category></entry><entry><title>haproxy1.5-dev21, nginx 1.5.8, SPDY &amp; pagespeed 1.7.30.2</title><link href="https://kura.gg/2014/01/08/haproxy1.5-dev21-nginx-1.5.8-spdy-pagespeed-1.7.30.2/" rel="alternate"></link><published>2014-01-08T13:00:00+00:00</published><updated>2014-01-08T13:00:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2014-01-08:/2014/01/08/haproxy1.5-dev21-nginx-1.5.8-spdy-pagespeed-1.7.30.2/</id><summary type="html">
&lt;p&gt;I have previously released &lt;a class="reference external" href="/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/"&gt;haproxy1.5-dev19 with &lt;span class="caps"&gt;SSL&lt;/span&gt; &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; &lt;span class="caps"&gt;SPDY&lt;/span&gt; support enabled&lt;/a&gt;
and &lt;a class="reference external" href="/2013/07/10/nginx-spdy-and-ngx-pagespeed/"&gt;nginx 1.4.1 with &lt;span class="caps"&gt;SPDY&lt;/span&gt; support and pagespeed&lt;/a&gt;, although I do
not remember which version of pagespeed.&lt;/p&gt;
&lt;p&gt;I have received a few messages asking me for the latest version of haproxy,
nginx and pagespeed so I decided to finally build and release them.&lt;/p&gt;
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;p&gt;haproxy requires openssl-1.0.1d or higher.&lt;/p&gt;
&lt;p&gt;On a standard Debian 7 install you should have openssl-1.0.1e-2, you
can find which version you have by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;-l&lt;span class="w"&gt; &lt;/span&gt;openssl
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This should return something similar to&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ii  openssl        1.0.1e-2        amd64        Secure Socket Layer (SSL) binary and related cryptographic tools
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="build-notes"&gt;
&lt;h2&gt;Build notes&lt;/h2&gt;
&lt;p&gt;Builds were done on Debian 7 &lt;span class="caps"&gt;AMD64&lt;/span&gt;, I will not be providing 32bit versions as
this is mainly for my own usage and amusement.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="haproxy"&gt;
&lt;h2&gt;haproxy&lt;/h2&gt;
&lt;p&gt;This haproxy build is compiled against openssl, providing the npn module,
allowing for haproxy …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I have previously released &lt;a class="reference external" href="/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/"&gt;haproxy1.5-dev19 with &lt;span class="caps"&gt;SSL&lt;/span&gt; &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; &lt;span class="caps"&gt;SPDY&lt;/span&gt; support enabled&lt;/a&gt;
and &lt;a class="reference external" href="/2013/07/10/nginx-spdy-and-ngx-pagespeed/"&gt;nginx 1.4.1 with &lt;span class="caps"&gt;SPDY&lt;/span&gt; support and pagespeed&lt;/a&gt;, although I do
not remember which version of pagespeed.&lt;/p&gt;
&lt;p&gt;I have received a few messages asking me for the latest version of haproxy,
nginx and pagespeed so I decided to finally build and release them.&lt;/p&gt;
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;p&gt;haproxy requires openssl-1.0.1d or higher.&lt;/p&gt;
&lt;p&gt;On a standard Debian 7 install you should have openssl-1.0.1e-2, you
can find which version you have by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;-l&lt;span class="w"&gt; &lt;/span&gt;openssl
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This should return something similar to&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ii  openssl        1.0.1e-2        amd64        Secure Socket Layer (SSL) binary and related cryptographic tools
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="build-notes"&gt;
&lt;h2&gt;Build notes&lt;/h2&gt;
&lt;p&gt;Builds were done on Debian 7 &lt;span class="caps"&gt;AMD64&lt;/span&gt;, I will not be providing 32bit versions as
this is mainly for my own usage and amusement.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="haproxy"&gt;
&lt;h2&gt;haproxy&lt;/h2&gt;
&lt;p&gt;This haproxy build is compiled against openssl, providing the npn module,
allowing for haproxy to work under &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt; and allowing the use of &lt;span class="caps"&gt;SPDY&lt;/span&gt;/2 and
&lt;span class="caps"&gt;SPDY&lt;/span&gt;/3.&lt;/p&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5-dev21_amd64.deb"&gt;haproxy_1.5-dev21_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5-dev21_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5-dev21_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5-dev21_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class="section" id="source"&gt;
&lt;h3&gt;Source&lt;/h3&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/haproxy-1.5-dev21.tar.gz"&gt;haproxy-1.5-dev21.tar.gz&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy-1.5-dev21.tar.gz.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy-1.5-dev21.tar.gz.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy-1.5-dev21.tar.gz.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="nginx"&gt;
&lt;h2&gt;nginx&lt;/h2&gt;
&lt;p&gt;All of these builds are compiled with the &lt;span class="caps"&gt;SPDY&lt;/span&gt; module and ngx_pagespeed modules
enabled. The version of pagespeed used is 1.7.30.2.&lt;/p&gt;
&lt;p&gt;Sadly nginx 1.5.8 currently only supports &lt;span class="caps"&gt;SPDY&lt;/span&gt;/2, &lt;span class="caps"&gt;SPDY&lt;/span&gt;/3 support is still unfinished.&lt;/p&gt;
&lt;div class="section" id="light-full"&gt;
&lt;h3&gt;Light/Full&lt;/h3&gt;
&lt;p&gt;You will need to choose one of the two below, if in doubt, just use full.&lt;/p&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.5.8_amd64.deb"&gt;nginx-full_1.5.8_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.5.8_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.5.8_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.5.8_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light_1.5.8_amd64.deb"&gt;nginx-light_1.5.8_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light_1.5.8_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light_1.5.8_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light_1.5.8_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="meta-common-doc"&gt;
&lt;h3&gt;Meta/Common/Doc&lt;/h3&gt;
&lt;p&gt;All three of these are required.&lt;/p&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.5.8_all.deb"&gt;nginx_1.5.8_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.5.8_all.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.5.8_all.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.5.8_all.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.5.8_all.deb"&gt;nginx-common_1.5.8_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.5.8_all.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.5.8_all.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.5.8_all.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.5.8_all.deb"&gt;nginx-doc_1.5.8_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.5.8_all.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.5.8_all.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.5.8_all.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="extras"&gt;
&lt;h3&gt;Extras&lt;/h3&gt;
&lt;p&gt;I’d only recommend installing this if you know what optional extras are
installed with this package.&lt;/p&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras_1.5.8_amd64.deb"&gt;nginx-extras_1.5.8_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras_1.5.8_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras_1.5.8_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras_1.5.8_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="naxsi"&gt;
&lt;h3&gt;Naxsi&lt;/h3&gt;
&lt;p&gt;The Naxsi &lt;span class="caps"&gt;WAF&lt;/span&gt;.&lt;/p&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi_1.5.8_amd64.deb"&gt;nginx-naxsi_1.5.8_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi_1.5.8_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi_1.5.8_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi_1.5.8_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-ui_1.5.8_all.deb"&gt;nginx-naxsi-ui_1.5.8_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-ui_1.5.8_all.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-ui_1.5.8_all.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-ui_1.5.8_all.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="debug-symbols"&gt;
&lt;h3&gt;Debug symbols&lt;/h3&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full-dbg_1.5.8_amd64.deb"&gt;nginx-full-dbg_1.5.8_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full-dbg_1.5.8_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full-dbg_1.5.8_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full-dbg_1.5.8_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light-dbg_1.5.8_amd64.deb"&gt;nginx-light-dbg_1.5.8_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light-dbg_1.5.8_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light-dbg_1.5.8_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-light-dbg_1.5.8_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras-dbg_1.5.8_amd64.deb"&gt;nginx-extras-dbg_1.5.8_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras-dbg_1.5.8_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras-dbg_1.5.8_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-extras-dbg_1.5.8_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-dbg_1.5.8_amd64.deb"&gt;nginx-naxsi-dbg_1.5.8_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-dbg_1.5.8_amd64.deb.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-dbg_1.5.8_amd64.deb.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-naxsi-dbg_1.5.8_amd64.deb.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;div class="section" id="source-1"&gt;
&lt;h4&gt;Source&lt;/h4&gt;
&lt;table class="docutils"&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-1.5.8.tar.gz"&gt;nginx-1.5.8.tar.gz&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-1.5.8.tar.gz.asc"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-1.5.8.tar.gz.md5"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-1.5.8.tar.gz.sha1"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="deb builds"></category><category term="debian"></category><category term="ubuntu"></category><category term="haproxy"></category><category term="nginx"></category><category term="spdy"></category><category term="pagespeed"></category><category term="ngx_pagespeed"></category></entry><entry><title>Shields for PyPI packages</title><link href="https://kura.gg/2013/12/24/shields-for-pypi-packages/" rel="alternate"></link><published>2013-12-24T14:07:00+00:00</published><updated>2013-12-24T14:07:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-12-24:/2013/12/24/shields-for-pypi-packages/</id><summary type="html">
&lt;p&gt;Some time back in April 2013 I was bored and looking for a new project to keep
my attention, if only for a short period of time.&lt;/p&gt;
&lt;p&gt;My colleague &lt;a class="reference external" href="https://twitter.com/codeinthehole"&gt;@codeinthehole&lt;/a&gt; had an idea
but no time to implement it, this idea was to have shields like those of
&lt;a class="reference external" href="https://travis-ci.org"&gt;travis-ci&lt;/a&gt; (shown below) but displaying package
download counts.&lt;/p&gt;
&lt;img alt="Status of blackhole on Travis CI" src="https://api.travis-ci.org/kura/blackhole.png?branch=master"/&gt;
&lt;div class="section" id="tech-stack"&gt;
&lt;h2&gt;Tech stack&lt;/h2&gt;
&lt;p&gt;From the very start I decided to use
&lt;a class="reference external" href="https://www.tornadoweb.org/en/stable/"&gt;Tornado framework&lt;/a&gt;, although this may
change in the future.&lt;/p&gt;
&lt;p&gt;The original plan was to generate the images using Pillow (&lt;span class="caps"&gt;PIL&lt;/span&gt;) and then simply
cache them to disk. I decided it would make far more sense to do this using
&lt;a class="reference external" href="https://www.varnish-cache.org/"&gt;Varnish&lt;/a&gt; and not have to worry about it
working as expected.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="manually-generating-the-images"&gt;
&lt;h2&gt;Manually generating the images&lt;/h2&gt;
&lt;p&gt;The images were originally generated from a base template using Pillow, but
sadly Python’s image manipulation is not very good, especially it’s text
manipulation and the shields could …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Some time back in April 2013 I was bored and looking for a new project to keep
my attention, if only for a short period of time.&lt;/p&gt;
&lt;p&gt;My colleague &lt;a class="reference external" href="https://twitter.com/codeinthehole"&gt;@codeinthehole&lt;/a&gt; had an idea
but no time to implement it, this idea was to have shields like those of
&lt;a class="reference external" href="https://travis-ci.org"&gt;travis-ci&lt;/a&gt; (shown below) but displaying package
download counts.&lt;/p&gt;
&lt;img alt="Status of blackhole on Travis CI" src="https://api.travis-ci.org/kura/blackhole.png?branch=master"/&gt;
&lt;div class="section" id="tech-stack"&gt;
&lt;h2&gt;Tech stack&lt;/h2&gt;
&lt;p&gt;From the very start I decided to use
&lt;a class="reference external" href="https://www.tornadoweb.org/en/stable/"&gt;Tornado framework&lt;/a&gt;, although this may
change in the future.&lt;/p&gt;
&lt;p&gt;The original plan was to generate the images using Pillow (&lt;span class="caps"&gt;PIL&lt;/span&gt;) and then simply
cache them to disk. I decided it would make far more sense to do this using
&lt;a class="reference external" href="https://www.varnish-cache.org/"&gt;Varnish&lt;/a&gt; and not have to worry about it
working as expected.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="manually-generating-the-images"&gt;
&lt;h2&gt;Manually generating the images&lt;/h2&gt;
&lt;p&gt;The images were originally generated from a base template using Pillow, but
sadly Python’s image manipulation is not very good, especially it’s text
manipulation and the shields could have really used a bit of work.&lt;/p&gt;
&lt;p&gt;I reached out to the &lt;a class="reference external" href="https://github.com/gittip/shields.io"&gt;shields project&lt;/a&gt;
but sadly got no response so the images remained as they were.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="crate-io-shuts-down"&gt;
&lt;h2&gt;crate.io shuts down&lt;/h2&gt;
&lt;p&gt;Sadly &lt;a class="reference external" href="https://crate.io"&gt;crate.io&lt;/a&gt; stopped being a custom PyPI mirror in mid
December which meant I had to rewrite the codebase to use the official PyPI
&lt;span class="caps"&gt;JSON&lt;/span&gt; &lt;span class="caps"&gt;API&lt;/span&gt;. In doing so I lost the ability to get download counts for all
versions or a specific version and instead, could only get a count by day,
week or month.&lt;/p&gt;
&lt;p&gt;It was while changing this functionality that I stumbled upon a &lt;a class="reference external" href="https://github.com/gittip/shields.io/issues/83"&gt;ticket from
the shields project&lt;/a&gt;
mentioning my shields and their poor artistic styling. The ticked mentioned an
&lt;a class="reference external" href="https://shields.io/"&gt;public &lt;span class="caps"&gt;API&lt;/span&gt;&lt;/a&gt; for generating these images.&lt;/p&gt;
&lt;p&gt;After switching to this &lt;span class="caps"&gt;API&lt;/span&gt; I quickly found from PyPI Pin users on Twitter that
there was an issue in their &lt;span class="caps"&gt;API&lt;/span&gt;, specifically with version number formats.
Version numbers with a format of &lt;span class="caps"&gt;X.X.&lt;/span&gt;X worked fine but X.&lt;span class="caps"&gt;XX&lt;/span&gt; did not. I can only
assume that many other formats didn’t work either.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="b-repl-ca"&gt;
&lt;h2&gt;b.repl.ca&lt;/h2&gt;
&lt;p&gt;While trying to find the source code for shields.io on GitHub I found what they
consider &lt;a class="reference external" href="https://b.repl.ca/"&gt;a newer, better version&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I promptly switched to PyPI Pins to use this and queried the authors on GitHub
to make sure the &lt;span class="caps"&gt;API&lt;/span&gt; was meant to be public and usable, thankfully it was.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="eggs-wheels-and-licenses"&gt;
&lt;h2&gt;Eggs, wheels and licenses&lt;/h2&gt;
&lt;p&gt;With this new found image &lt;span class="caps"&gt;API&lt;/span&gt; and the wealth of data in the PyPI &lt;span class="caps"&gt;JSON&lt;/span&gt; &lt;span class="caps"&gt;API&lt;/span&gt; I
quickly decided to leverage it as much as I could and thus the egg, wheel and
license shields were created.&lt;/p&gt;
&lt;p&gt;The tech stack remains the same, I still cache all successful image requests
using Varnish to limit the impact on my Tornado servers and on the shields.io
service. I look forward to adding more shields and functionality in the future.&lt;/p&gt;
&lt;p&gt;You can access this set of services &lt;a class="reference external" href="https://pypip.in"&gt;on PyPI Pins&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="pypi"></category><category term="shields"></category></entry><entry><title>Bye bye Google Analytics, hello self-hosted Open Web Analytics &amp; DuckDuckGo search</title><link href="https://kura.gg/2013/09/17/bye-bye-google-analytics-hello-self-hosted-open-web-analytics-duckduckgo-search/" rel="alternate"></link><published>2013-09-17T18:00:00+01:00</published><updated>2013-09-17T18:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-09-17:/2013/09/17/bye-bye-google-analytics-hello-self-hosted-open-web-analytics-duckduckgo-search/</id><summary type="html">
&lt;p&gt;Today I can happily announce that &lt;a class="reference external" href="https://github.com/kura/kura.gg/commit/5e82c14bab3922d81b430549dd258a2047d1367f"&gt;the Google Analytics tracking code has been
removed from this website&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="goodybye-google-analytics-hello-open-web-analytics"&gt;
&lt;h2&gt;Goodybye Google Analytics &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; hello Open Web Analytics&lt;/h2&gt;
&lt;p&gt;I’ve been planning on doing it from a while because I do not like Google Analytics,
I don’t like being tracked and I actively stopped trying to use Google services
for my own reasons.&lt;/p&gt;
&lt;p&gt;The company I work for uses &lt;a class="reference external" href="https://piwik.org/"&gt;Piwik&lt;/a&gt;
for some of our clients, I am not a fan
of Piwik or how it works and does things. I did some research and found some
service providers but their free options were limited or I felt they weren’t a
good fit, eventually I stumbled upon &lt;a class="reference external" href="https://www.openwebanalytics.com"&gt;Open Web Analytics&lt;/a&gt; and decided that it
not only suited my purposes, but it meant servers I control would hold the
analytical data, rather than some third party.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="hello-duckduckgo"&gt;
&lt;h2&gt;Hello DuckDuckGo&lt;/h2&gt;
&lt;p&gt;After launching the new version of …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Today I can happily announce that &lt;a class="reference external" href="https://github.com/kura/kura.gg/commit/5e82c14bab3922d81b430549dd258a2047d1367f"&gt;the Google Analytics tracking code has been
removed from this website&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="goodybye-google-analytics-hello-open-web-analytics"&gt;
&lt;h2&gt;Goodybye Google Analytics &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; hello Open Web Analytics&lt;/h2&gt;
&lt;p&gt;I’ve been planning on doing it from a while because I do not like Google Analytics,
I don’t like being tracked and I actively stopped trying to use Google services
for my own reasons.&lt;/p&gt;
&lt;p&gt;The company I work for uses &lt;a class="reference external" href="https://piwik.org/"&gt;Piwik&lt;/a&gt;
for some of our clients, I am not a fan
of Piwik or how it works and does things. I did some research and found some
service providers but their free options were limited or I felt they weren’t a
good fit, eventually I stumbled upon &lt;a class="reference external" href="https://www.openwebanalytics.com"&gt;Open Web Analytics&lt;/a&gt; and decided that it
not only suited my purposes, but it meant servers I control would hold the
analytical data, rather than some third party.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="hello-duckduckgo"&gt;
&lt;h2&gt;Hello DuckDuckGo&lt;/h2&gt;
&lt;p&gt;After launching the new version of my site, I got upset at the fact I had lost
my search functionality. Sadly &lt;a class="reference external" href="https://docs.getpelican.com/"&gt;Pelican&lt;/a&gt;
does not have any working search
functionality and I undertook the task of building &lt;a class="reference external" href="https://sphinx-doc.org/"&gt;Sphinx&lt;/a&gt;
-style searches
in to Pelican, making it entirely static.&lt;/p&gt;
&lt;p&gt;The task of building this functionality is still under way, but I decided that
I would like a more immediate option.&lt;/p&gt;
&lt;p&gt;I’ve been using DuckDuckGo as my primary and only search provider for quite a
long time now and learned that you can embed it on your site easily, just like
with Google site searches.&lt;/p&gt;
&lt;p&gt;So there it is, embded happily and with adverts enabled on their end to make
sure they make some revenue from it.&lt;/p&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="google analytics"></category><category term="duckduckgo"></category><category term="open web analytics"></category><category term="owa"></category></entry><entry><title>My $PS1 with git branch, new files, staged files and commit status</title><link href="https://kura.gg/2013/08/18/my-ps1-with-git-branch-new-files-staged-files-and-commit-status/" rel="alternate"></link><published>2013-08-18T17:25:00+01:00</published><updated>2013-08-18T17:25:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-08-18:/2013/08/18/my-ps1-with-git-branch-new-files-staged-files-and-commit-status/</id><summary type="html">&lt;p&gt;I love my prompt, always have and always will. I spend so much of my life
in a terminal, usually with half a dozen mini terminals open in each tab.
As such I like to tweak it and get it as perfect as possible for my life, needs
and even mood.&lt;/p&gt;
&lt;p&gt;In the past I’ve had quite a large &lt;span class="caps"&gt;PS1&lt;/span&gt; that covers multiple lines and gives a
lot of information, after having that &lt;span class="caps"&gt;PS1&lt;/span&gt; in one form or another for some time
I decided it was time for a change, to a smaller &lt;span class="caps"&gt;PS1&lt;/span&gt; that takes up a lot less space.&lt;/p&gt;
&lt;p&gt;So here it is, the first image is my standard &lt;span class="caps"&gt;PS1&lt;/span&gt; when in a git repository,
the red @ means a file hasn’t been added to Git, a blue @ means a tracked file
has been modified but not stage and finally a green @ means a file is staged …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I love my prompt, always have and always will. I spend so much of my life
in a terminal, usually with half a dozen mini terminals open in each tab.
As such I like to tweak it and get it as perfect as possible for my life, needs
and even mood.&lt;/p&gt;
&lt;p&gt;In the past I’ve had quite a large &lt;span class="caps"&gt;PS1&lt;/span&gt; that covers multiple lines and gives a
lot of information, after having that &lt;span class="caps"&gt;PS1&lt;/span&gt; in one form or another for some time
I decided it was time for a change, to a smaller &lt;span class="caps"&gt;PS1&lt;/span&gt; that takes up a lot less space.&lt;/p&gt;
&lt;p&gt;So here it is, the first image is my standard &lt;span class="caps"&gt;PS1&lt;/span&gt; when in a git repository,
the red @ means a file hasn’t been added to Git, a blue @ means a tracked file
has been modified but not stage and finally a green @ means a file is staged
but still needs to be committed.&lt;/p&gt;
&lt;img alt="PS1 while in a git repository" src="/images/new-ps1.png"/&gt;
&lt;p&gt;When I have run &lt;cite&gt;sudo -s&lt;/cite&gt; my &lt;span class="caps"&gt;PS1&lt;/span&gt; changes to alert me to the fact I have
superuser privileges.&lt;/p&gt;
&lt;img alt="PS1 when I have scary privileges" src="/images/new-ps1-root.png"/&gt;
&lt;p&gt;You can find the source code used to power this &lt;span class="caps"&gt;PS1&lt;/span&gt; below which is stored in a
Gist on GitHub.&lt;/p&gt;
&lt;p&gt;Gist removed. Sorry.&lt;/p&gt;
</content><category term="coding"></category><category term="bash"></category><category term="dash"></category><category term="ps1"></category><category term="git"></category></entry><entry><title>Blackhole 1.8.0 development, Mock and Python entry_points</title><link href="https://kura.gg/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/" rel="alternate"></link><published>2013-08-18T12:00:00+01:00</published><updated>2013-08-18T12:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-08-18:/2013/08/18/blackhole-1.8.0-development-mock-and-python-entry-points/</id><summary type="html">
&lt;p&gt;Over the last week I’ve been doing a huge amount of refactoring of
&lt;a class="reference external" href="https://blackhole.io"&gt;Blackhole&lt;/a&gt; as well as writing dozens of additional
tests. To make Blackhole more testable I needed to make a big change to
how the program is launched and controlled.&lt;/p&gt;
&lt;div class="section" id="setup-py-scripts-vs-entry-points"&gt;
&lt;h2&gt;setup.py scripts vs. entry_points&lt;/h2&gt;
&lt;p&gt;Whenever I’ve written Python programs that require some kind of command line
script I’ve always used distutils’ scripts, this can be seen &lt;a class="reference external" href="https://github.com/kura/blackhole/blob/05c6647aeb25ecfcc17d9df535db330a68016a24/setup.py#L37-L39"&gt;in blackhole’s
setup.py on GitHub&lt;/a&gt;
or in the three line example below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;scripts&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;
    &lt;span class="s1"&gt;'blackhole/bin/blackhole'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;],&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In doing so, it allowed me to be lazy and write a lot of prodecural code in the
main “binary” which made it pretty much impossible to test. You can also see
that &lt;a class="reference external" href="https://github.com/kura/blackhole/blob/bb6cccca3a75def324ed5cb64a32fd2e5773a038/blackhole/bin/blackhole"&gt;on GitHub in the main “binary”&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I’ve noticed that most people who write Python packages that have some kind of
command line entry point use distutils …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Over the last week I’ve been doing a huge amount of refactoring of
&lt;a class="reference external" href="https://blackhole.io"&gt;Blackhole&lt;/a&gt; as well as writing dozens of additional
tests. To make Blackhole more testable I needed to make a big change to
how the program is launched and controlled.&lt;/p&gt;
&lt;div class="section" id="setup-py-scripts-vs-entry-points"&gt;
&lt;h2&gt;setup.py scripts vs. entry_points&lt;/h2&gt;
&lt;p&gt;Whenever I’ve written Python programs that require some kind of command line
script I’ve always used distutils’ scripts, this can be seen &lt;a class="reference external" href="https://github.com/kura/blackhole/blob/05c6647aeb25ecfcc17d9df535db330a68016a24/setup.py#L37-L39"&gt;in blackhole’s
setup.py on GitHub&lt;/a&gt;
or in the three line example below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;scripts&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;
    &lt;span class="s1"&gt;'blackhole/bin/blackhole'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
&lt;span class="p"&gt;],&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In doing so, it allowed me to be lazy and write a lot of prodecural code in the
main “binary” which made it pretty much impossible to test. You can also see
that &lt;a class="reference external" href="https://github.com/kura/blackhole/blob/bb6cccca3a75def324ed5cb64a32fd2e5773a038/blackhole/bin/blackhole"&gt;on GitHub in the main “binary”&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I’ve noticed that most people who write Python packages that have some kind of
command line entry point use distutils’ &lt;cite&gt;entry_points&lt;/cite&gt; option instead of
&lt;cite&gt;scripts&lt;/cite&gt;. I decided to rewrite Blackhole to make it use the same entry_points
option and also make it’s new entry point as testable as possible.&lt;/p&gt;
&lt;div class="section" id="setup-py-entry-point-change"&gt;
&lt;h3&gt;setup.py entry_point change&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;entry_points&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="s1"&gt;'console_scripts'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
        &lt;span class="s1"&gt;'blackhole = blackhole.application:run'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="p"&gt;]&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;setup&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'blackhole'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="c1"&gt;# ...&lt;/span&gt;
      &lt;span class="n"&gt;entry_points&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;entry_points&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
      &lt;span class="c1"&gt;# ...&lt;/span&gt;
      &lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I’m not going to go in to any real detal on how &lt;cite&gt;entry_points&lt;/cite&gt; works, there are
plenty of articles elsewhere on the internet that detail this.&lt;/p&gt;
&lt;p&gt;That being said, &lt;cite&gt;entry_points&lt;/cite&gt; is a dictionary, in it I set a &lt;cite&gt;console_scripts&lt;/cite&gt;
key that has a list of scripts that should be usable from the command line.&lt;/p&gt;
&lt;p&gt;Each list item is made up of two parts; the command name (what will be typed on
the command line to trigger the command) and the module(s) and method to run.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="blackhole-application-run"&gt;
&lt;h3&gt;blackhole.application:run&lt;/h3&gt;
&lt;p&gt;With the &lt;cite&gt;entry_points&lt;/cite&gt; changes outlined above, this allowed me to write an
entirely new and testable application.&lt;/p&gt;
&lt;p&gt;Now the method that launches Blackhole is much smaller and split in to testable parts.&lt;/p&gt;
&lt;p&gt;For example the &lt;cite&gt;run&lt;/cite&gt; method is below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;run&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;    The run method is what actually spawns and manages blackhole.&lt;/span&gt;
&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;signal&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SIGTERM&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;terminate&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;action&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;set_action&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;set_options&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="c1"&gt;# Grab the sockets early for multiprocessing&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;action&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'start'&lt;/span&gt;&lt;span class="p"&gt;,):&lt;/span&gt;
        &lt;span class="n"&gt;socks&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sockets&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;setgid&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;setuid&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;d&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;daemon&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;action&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="c1"&gt;# Change group and user&lt;/span&gt;
    &lt;span class="n"&gt;io_loop&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;fork&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="c1"&gt;# Iterate over the dictionary of socket connections&lt;/span&gt;
    &lt;span class="c1"&gt;# and add them to the IOLoop&lt;/span&gt;
    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sock&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;socks&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;iteritems&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
        &lt;span class="n"&gt;callback&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;functools&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;partial&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection_ready&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;io_loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;add_handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fileno&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;io_loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;READ&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;io_loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="ne"&gt;KeyboardInterrupt&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ne"&gt;SystemExit&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;io_loop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For the full set of changes, take a look &lt;a class="reference external" href="https://github.com/kura/blackhole/blob/05c6647aeb25ecfcc17d9df535db330a68016a24/blackhole/application.py"&gt;on GitHub at blackhole.application&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="fun-with-mock"&gt;
&lt;h2&gt;Fun with Mock&lt;/h2&gt;
&lt;p&gt;&lt;a class="reference external" href="https://www.voidspace.org.uk/python/mock/"&gt;Mock&lt;/a&gt; is an amazing library that
allows you to mock (fake) method calls and much more.&lt;/p&gt;
&lt;p&gt;I’ve known about Mock for a while, it’s used quite heavily at work but I’ve
never really felt like I needed to use it. Then I started writing more and more
tests for Blackhole, started using Mock and instantly fell in love.&lt;/p&gt;
&lt;div class="section" id="mocking-fqdn"&gt;
&lt;h3&gt;Mocking &lt;span class="caps"&gt;FQDN&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;As an example, with Blackhole 1.6.4 I added functionality to return an &lt;span class="caps"&gt;FQDN&lt;/span&gt;
when &lt;span class="caps"&gt;HELO&lt;/span&gt; or &lt;span class="caps"&gt;EHLO&lt;/span&gt; commands are received. I didn’t write any tests for this
because it uses a file on the filesystem or falls back to getting the &lt;span class="caps"&gt;FQDN&lt;/span&gt;
from the socket library.&lt;/p&gt;
&lt;p&gt;After playing with Mock, I decided I would actually write tests for this piece
of functionality and thankfully Mock made it insanely simple.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TestMailNameFile&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unittest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TestCase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;check_value&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"file.blackhole.io"&lt;/span&gt;

    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'os.path.exists'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;return_value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_mail_name_file&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;exists_mock&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'__builtin__.open'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                       &lt;span class="n"&gt;return_value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;StringIO&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;check_value&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
                &lt;span class="n"&gt;mn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_mailname&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;assertEqual&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;check_value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;ImportError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;with&lt;/span&gt; &lt;span class="n"&gt;patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'builtins.open'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                       &lt;span class="n"&gt;return_value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;StringIO&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;check_value&lt;/span&gt;&lt;span class="p"&gt;)):&lt;/span&gt;
                &lt;span class="n"&gt;mn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_mailname&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;assertEqual&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;check_value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above test mocks the filesystem calls, returning a known value. This allows
the tests to be run no matter how the machine running the tests is configured.&lt;/p&gt;
&lt;p&gt;The one slightly less standard part of this test is the fact it has a
try: except: block inside it, this is because I need to mock Python’s builtin
&lt;cite&gt;open&lt;/cite&gt; method. Blackhole works on both Python 2.6/7 and on Python 3.X and with
Python 3 the &lt;cite&gt;open&lt;/cite&gt; method was moved from &lt;cite&gt;__builtin__.open&lt;/cite&gt; to &lt;cite&gt;builtins.open&lt;/cite&gt;.
As such I have to attempt to run the Python 2.X version of the code and fallback
to Python 3.X version if the import fails.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TestMailNameSocket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unittest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TestCase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;check_value&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"socket.blackhole.io"&lt;/span&gt;

    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'os.path.exists'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;return_value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="kc"&gt;False&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'socket.getfqdn'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;return_value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;check_value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_mail_name_socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;exists_mock&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;socket_mock&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;mn&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;get_mailname&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;assertEqual&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;check_value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And the test above is for forcing the &lt;span class="caps"&gt;FQDN&lt;/span&gt; to be returned by Python’s socket
library, again the return value is a known value so that it can be tested
on any machine.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="mocking-delay-and-debug-options"&gt;
&lt;h3&gt;Mocking —delay and —debug options&lt;/h3&gt;
&lt;p&gt;Very little changes when the &lt;cite&gt;—delay&lt;/cite&gt; and &lt;cite&gt;—debug&lt;/cite&gt; arguments are passed in to
Blackhole and sadly it’s quite hard to test both of those calls.&lt;/p&gt;
&lt;p&gt;One thing that I would like to test is that a relevant warning message is
printed out to the console when either of these arguments is passed. Because
both options can be quite dangerous to use.&lt;/p&gt;
&lt;p&gt;It’s kind of a pointless thing to test for but it’s also nice to know that the
user is being warned correctly.&lt;/p&gt;
&lt;p&gt;With Mock I am able to to mock &lt;cite&gt;sys.stdout&lt;/cite&gt; and have it write the output to
&lt;cite&gt;StringIO&lt;/cite&gt; instead, so I can test the contents of &lt;cite&gt;StringIO&lt;/cite&gt; and confirm they
match what I expect them to be.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TestSetOptionsDebug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unittest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TestCase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;setUp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delay&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;0&lt;/span&gt;
        &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;
        &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;

    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'sys.stdout'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new_callable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;StringIO&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_set_options_debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;stdout_mock&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;val&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"""WARNING: Using the debug flag!&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;This will generate a lots"""&lt;/span&gt;\
&lt;span class="w"&gt;              &lt;/span&gt;&lt;span class="sd"&gt;""" of disk I/O and large log files\n\n"""&lt;/span&gt;
        &lt;span class="n"&gt;set_options&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;assertEquals&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stdout_mock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getvalue&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;val&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TestSetOptionsDelay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unittest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TestCase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;setUp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;
        &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;delay&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
        &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;

    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'sys.stdout'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;new_callable&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;StringIO&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_set_options_delay&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;stdout_mock&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;val&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"""WARNING: Using the delay flag!&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"""&lt;/span&gt;\
&lt;span class="w"&gt;              &lt;/span&gt;&lt;span class="sd"&gt;"""The delay flag is a blocking action """&lt;/span&gt;\
&lt;span class="w"&gt;              &lt;/span&gt;&lt;span class="sd"&gt;"""and will cause connections to block.\n\n"""&lt;/span&gt;
        &lt;span class="n"&gt;set_options&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;assertEquals&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;stdout_mock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getvalue&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;val&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mocking-daemon-actions"&gt;
&lt;h3&gt;Mocking daemon actions&lt;/h3&gt;
&lt;p&gt;Another thing that is nice to test is that the daemon is working correctly. I
decided it would be a good idea to mock start, stop and status commands as well
as mocking unknown commands too, to be sure how Blackhole would respond to a
user’s actions.&lt;/p&gt;
&lt;p&gt;Thankfully Mock allows you to mock calls and confirm that they have indeed been
called, for example the stop method calls &lt;cite&gt;sys.exit&lt;/cite&gt;, so I can confirm that this
call has actually been made.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TestDaemonStop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unittest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TestCase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;setUp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'blackhole'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'stop'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'sys.exit'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'deiman.Deiman.stop'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_daemon_stop&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;exit_mock&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;daemon_mock&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;daemon&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'stop'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;daemon_mock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;called&lt;/span&gt;
            &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;exit_mock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;called&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TestDaemonStatus&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unittest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TestCase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;setUp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'blackhole'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'status'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'sys.exit'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'deiman.Deiman.status'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_daemon_status&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;exit_mock&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;daemon_mock&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;daemon&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'status'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;daemon_mock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;called&lt;/span&gt;
            &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;exit_mock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;called&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TestDaemonStart&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unittest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TestCase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;setUp&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="n"&gt;sys&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'blackhole'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'start'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'deiman.Deiman.start'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_daemon_start&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;daemon_mock&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;d&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;daemon&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'start'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;daemon_mock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;called&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;assertTrue&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;d&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Deiman&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;TestDaemonInvalidAction&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;unittest&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;TestCase&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="nd"&gt;@patch&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'sys.exit'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;test_daemon_invalid_action&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;exit_mock&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;daemon&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'kurakurakura'&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;assert&lt;/span&gt; &lt;span class="n"&gt;exit_mock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;called&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="blackhole"></category><category term="setup.py"></category><category term="entry_points"></category><category term="mock"></category><category term="tests"></category><category term="testing"></category></entry><entry><title>Writing a Vimeo and YouTube plugin for Pelican</title><link href="https://kura.gg/2013/08/09/writing-a-vimeo-and-youtube-plugin-for-pelican/" rel="alternate"></link><published>2013-08-09T17:38:00+01:00</published><updated>2013-08-09T17:38:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-08-09:/2013/08/09/writing-a-vimeo-and-youtube-plugin-for-pelican/</id><summary type="html">
&lt;p&gt;&lt;a class="reference external" href="https://getpelican.com/"&gt;Pelican&lt;/a&gt; is a Python-powered static blog generator
that processes &lt;a class="reference external" href="https://docutils.sourceforge.net/rst.html"&gt;ReStructuredText&lt;/a&gt;
and &lt;a class="reference external" href="https://daringfireball.net/projects/markdown/"&gt;Markdown&lt;/a&gt; articles and
pages and converts them to &lt;span class="caps"&gt;HTML&lt;/span&gt;. I use Pelican to power this blog.&lt;/p&gt;
&lt;p&gt;There is a YouTube &lt;span class="caps"&gt;RST&lt;/span&gt; directive built in to Pelican core but it really
shouldn’t exist there.&lt;/p&gt;
&lt;p&gt;I submitted a pull request for Pelican core to enable Vimeo videos in articles
but that request was declined because it didn’t belong in the core. So I
decided I would write it as a plugin instead and while I was doing it, also
wrote a plugin for YouTube so that it could be removed from the core.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://docs.getpelican.com/en/3.2/plugins.html#how-to-create-plugins"&gt;There is a decent amount of detail in the Pelican documentation on how to
write plugins&lt;/a&gt;, I’m
not going to cover the whole process but I thought I would cover a little of
what I did.&lt;/p&gt;
&lt;div class="section" id="adding-an-rst-directive"&gt;
&lt;h2&gt;Adding an &lt;span class="caps"&gt;RST&lt;/span&gt; directive&lt;/h2&gt;
&lt;p&gt;Really all we’re doing …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;&lt;a class="reference external" href="https://getpelican.com/"&gt;Pelican&lt;/a&gt; is a Python-powered static blog generator
that processes &lt;a class="reference external" href="https://docutils.sourceforge.net/rst.html"&gt;ReStructuredText&lt;/a&gt;
and &lt;a class="reference external" href="https://daringfireball.net/projects/markdown/"&gt;Markdown&lt;/a&gt; articles and
pages and converts them to &lt;span class="caps"&gt;HTML&lt;/span&gt;. I use Pelican to power this blog.&lt;/p&gt;
&lt;p&gt;There is a YouTube &lt;span class="caps"&gt;RST&lt;/span&gt; directive built in to Pelican core but it really
shouldn’t exist there.&lt;/p&gt;
&lt;p&gt;I submitted a pull request for Pelican core to enable Vimeo videos in articles
but that request was declined because it didn’t belong in the core. So I
decided I would write it as a plugin instead and while I was doing it, also
wrote a plugin for YouTube so that it could be removed from the core.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://docs.getpelican.com/en/3.2/plugins.html#how-to-create-plugins"&gt;There is a decent amount of detail in the Pelican documentation on how to
write plugins&lt;/a&gt;, I’m
not going to cover the whole process but I thought I would cover a little of
what I did.&lt;/p&gt;
&lt;div class="section" id="adding-an-rst-directive"&gt;
&lt;h2&gt;Adding an &lt;span class="caps"&gt;RST&lt;/span&gt; directive&lt;/h2&gt;
&lt;p&gt;Really all we’re doing is modifying docutils on-the-fly to tell it how to
understand new directives, so we need to import directives from docutils&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;docutils.parsers.rst&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;directives&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Directive&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With this in place, we can dynamically register a new directive to docutils&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;directives&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;register_directive&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'vimeo'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Vimeo&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The first argument we pass in is the name of our directive, the second
argument is the name of the class we wish to be invoked.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="writing-the-directive"&gt;
&lt;h2&gt;Writing the Directive&lt;/h2&gt;
&lt;p&gt;I’ll now break down the Vimeo class and explain what it does, piece by piece.&lt;/p&gt;
&lt;p&gt;We will need to import an extra method from docutils&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;docutils&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;nodes&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is used to append segments of data together, in our case &lt;span class="caps"&gt;HTML&lt;/span&gt;.&lt;/p&gt;
&lt;div class="section" id="class-vimeo"&gt;
&lt;h3&gt;class Vimeo&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Vimeo&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Directive&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is pretty self explanatory, we define a new class that inherits from
&lt;cite&gt;docutils.parsers.rst.Directive&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;Next we define a method for handling our alignment choices&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;align&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;argument&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;directives&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;choice&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;argument&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;'left'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'center'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'right'&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we need to set some base values against our class for docutils to know how
many arguments are required and so on, it’s pretty easy to understand. For the
alignment option we pass it the callable method declared above, but without
calling it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;required_arguments&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;1&lt;/span&gt;
&lt;span class="n"&gt;optional_arguments&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;2&lt;/span&gt;
&lt;span class="n"&gt;option_spec&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;{&lt;/span&gt;
    &lt;span class="s1"&gt;'width'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;directives&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;positive_int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s1"&gt;'height'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;directives&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;positive_int&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
    &lt;span class="s1"&gt;'align'&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;align&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="n"&gt;final_argument_whitespace&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;
&lt;span class="n"&gt;has_content&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="kc"&gt;False&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally we move on to the meat of the plugin, the method that actually does
the processing.&lt;/p&gt;
&lt;p&gt;The method name is called run because that is required by docutils.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;run&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;First I get the videoID from the first argument in the &lt;span class="caps"&gt;RST&lt;/span&gt;, I tend set default
values for width, height and alignment. Those three arguments are optional, but
if they have been defined then I override the defaults.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;videoID&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;arguments&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;strip&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="n"&gt;width&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;420&lt;/span&gt;
&lt;span class="n"&gt;height&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;315&lt;/span&gt;
&lt;span class="n"&gt;align&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'left'&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;'width'&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;width&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'width'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;'height'&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;height&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'height'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="s1"&gt;'align'&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;align&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;'align'&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next I define the Vimeo &lt;span class="caps"&gt;URL&lt;/span&gt; and the two blocks of &lt;span class="caps"&gt;HTML&lt;/span&gt; that create the
surrounding div element and the video iframe. Here I also replace the videoID
in to the &lt;span class="caps"&gt;URL&lt;/span&gt; and also the optional arguments specified above.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;url&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'https://player.vimeo.com/video/&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;videoID&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;div_block&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'&amp;lt;div class="vimeo" align="&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;"&amp;gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;align&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="n"&gt;embed_block&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;'&amp;lt;iframe width="&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;" height="&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;" src="&lt;/span&gt;&lt;span class="si"&gt;{}&lt;/span&gt;&lt;span class="s1"&gt;" '&lt;/span&gt;\
              &lt;span class="s1"&gt;'frameborder="0"&amp;gt;&amp;lt;/iframe&amp;gt;'&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;width&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;height&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;url&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally I create a list of docutils nodes with the &lt;span class="caps"&gt;HTML&lt;/span&gt; we created above.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;
    &lt;span class="n"&gt;nodes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;raw&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;''&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;div_block&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;format&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'html'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="n"&gt;nodes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;raw&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;''&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;embed_block&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;format&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'html'&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
    &lt;span class="n"&gt;nodes&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;raw&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;''&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;'&amp;lt;/div&amp;gt;'&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;format&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;'html'&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And that’s really it, it’s a simple as that. &lt;a class="reference external" href="https://github.com/kura/pelican_vimeo"&gt;You can view full source on
GitHub&lt;/a&gt; and also &lt;a class="reference external" href="/pelican-vimeo"&gt;read the manual for
pelican-vimeo on it’s software page on this website&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="pelican"></category><category term="youtube"></category><category term="vimeo"></category></entry><entry><title>Writing the STARTTLS command in to Blackhole</title><link href="https://kura.gg/2013/07/31/writing-the-starttls-command-in-to-blackhole/" rel="alternate"></link><published>2013-07-31T13:36:00+01:00</published><updated>2013-07-31T13:36:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-07-31:/2013/07/31/writing-the-starttls-command-in-to-blackhole/</id><summary type="html">
&lt;p&gt;Blackhole has always been able to handle unencrypted &lt;span class="caps"&gt;SMTP&lt;/span&gt; and
for a long time it’s been able to handle encrypted &lt;span class="caps"&gt;SMTP&lt;/span&gt; via TLSv1.&lt;/p&gt;
&lt;p&gt;One thing Blackhole hasn’t been able to do until the 1.7.0 release
is handle &lt;cite&gt;&lt;span class="caps"&gt;STARTTLS&lt;/span&gt;&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;In the past the &lt;cite&gt;&lt;span class="caps"&gt;STARTTLS&lt;/span&gt;&lt;/cite&gt; command would cause Blackhole to return the
standard &lt;cite&gt;250 &lt;span class="caps"&gt;OK&lt;/span&gt;&lt;/cite&gt; response but would continue to operate on unencrypted
&lt;span class="caps"&gt;SMTP&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I wanted to fix this and do it properly, but this meant learning how
to do so with Tornado, which itself proved to be tricky. I ended up
deciding to go to my local coding spot - the pub and hash it out.&lt;/p&gt;
&lt;div class="section" id="connection-stream"&gt;
&lt;h2&gt;connection_stream&lt;/h2&gt;
&lt;p&gt;The first thing I had to do was refactor the code that created the
instance of &lt;cite&gt;tornado.iostream.IOStream&lt;/cite&gt; and &lt;cite&gt;tornado.iostream.SSLIOStream&lt;/cite&gt;
so that it didn’t actually do the ssl wrapping.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connection_stream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;    Detect which socket the connection …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Blackhole has always been able to handle unencrypted &lt;span class="caps"&gt;SMTP&lt;/span&gt; and
for a long time it’s been able to handle encrypted &lt;span class="caps"&gt;SMTP&lt;/span&gt; via TLSv1.&lt;/p&gt;
&lt;p&gt;One thing Blackhole hasn’t been able to do until the 1.7.0 release
is handle &lt;cite&gt;&lt;span class="caps"&gt;STARTTLS&lt;/span&gt;&lt;/cite&gt;.&lt;/p&gt;
&lt;p&gt;In the past the &lt;cite&gt;&lt;span class="caps"&gt;STARTTLS&lt;/span&gt;&lt;/cite&gt; command would cause Blackhole to return the
standard &lt;cite&gt;250 &lt;span class="caps"&gt;OK&lt;/span&gt;&lt;/cite&gt; response but would continue to operate on unencrypted
&lt;span class="caps"&gt;SMTP&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I wanted to fix this and do it properly, but this meant learning how
to do so with Tornado, which itself proved to be tricky. I ended up
deciding to go to my local coding spot - the pub and hash it out.&lt;/p&gt;
&lt;div class="section" id="connection-stream"&gt;
&lt;h2&gt;connection_stream&lt;/h2&gt;
&lt;p&gt;The first thing I had to do was refactor the code that created the
instance of &lt;cite&gt;tornado.iostream.IOStream&lt;/cite&gt; and &lt;cite&gt;tornado.iostream.SSLIOStream&lt;/cite&gt;
so that it didn’t actually do the ssl wrapping.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connection_stream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;    Detect which socket the connection is being made on,&lt;/span&gt;
&lt;span class="sd"&gt;    create and iostream for the connection, wrapping it&lt;/span&gt;
&lt;span class="sd"&gt;    in SSL if connected over the SSL socket.&lt;/span&gt;

&lt;span class="sd"&gt;    The parameter 'connection' is an instance of 'socket'&lt;/span&gt;
&lt;span class="sd"&gt;    from stdlib.&lt;/span&gt;
&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getsockname&lt;/span&gt;&lt;span class="p"&gt;()[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssl_port&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;iostream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IOStream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="ssl-connection"&gt;
&lt;h2&gt;ssl_connection&lt;/h2&gt;
&lt;p&gt;In doing so I added another method that actually created an instance of
&lt;cite&gt;tornado.iostream.SSLIOStream&lt;/cite&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;ssl_connection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;ssl_connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wrap_socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;sslkwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;iostream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLIOStream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLError&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errno&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSL_ERROR_EOF&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errno&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;errno&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ECONNABORTED&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This now gave me the ability to create an instance of &lt;cite&gt;SSLIOStream&lt;/cite&gt; without
doing all of the port checks that are required to create it when a connection
is made through the &lt;span class="caps"&gt;SSL&lt;/span&gt; enabled port.&lt;/p&gt;
&lt;p&gt;Next I had to find a way of modifying the stream on-the-fly, which was really
just a case of adding the current stream as an attribute of the &lt;cite&gt;MailState&lt;/cite&gt;
object which is unique for each connection to the server.&lt;/p&gt;
&lt;p&gt;The next and final step was to identify if &lt;cite&gt;&lt;span class="caps"&gt;STARTTLS&lt;/span&gt;&lt;/cite&gt; had been called and
overwrite the stream attribute of &lt;cite&gt;IOStream&lt;/cite&gt; with &lt;cite&gt;SSLIOStream&lt;/cite&gt;… This is
where everything got tricky.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="broken-file-descriptors"&gt;
&lt;h2&gt;Broken file descriptors&lt;/h2&gt;
&lt;p&gt;Tornado would error out when &lt;cite&gt;&lt;span class="caps"&gt;STARTTLS&lt;/span&gt;&lt;/cite&gt; was called with the following error&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;callback&lt;/span&gt; &lt;span class="o"&gt;&amp;lt;&lt;/span&gt;&lt;span class="n"&gt;functools&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;partial&lt;/span&gt; &lt;span class="nb"&gt;object&lt;/span&gt; &lt;span class="n"&gt;at&lt;/span&gt; &lt;span class="mh"&gt;0x26d8260&lt;/span&gt;&lt;span class="o"&gt;&amp;gt;&lt;/span&gt;
    &lt;span class="n"&gt;Traceback&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;most&lt;/span&gt; &lt;span class="n"&gt;recent&lt;/span&gt; &lt;span class="n"&gt;call&lt;/span&gt; &lt;span class="n"&gt;last&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/ioloop.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;453&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;_run_callback&lt;/span&gt;
        &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/stack_context.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;241&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;wrapped&lt;/span&gt;
        &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;316&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;wrapper&lt;/span&gt;
        &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/stack_context.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;241&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;wrapped&lt;/span&gt;
        &lt;span class="n"&gt;callback&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;kwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/workspace/blackhole.io/blackhole/connection.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;212&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt;
        &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/workspace/blackhole.io/blackhole/connection.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;219&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;loop&lt;/span&gt;
        &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read_until&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;148&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;read_until&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_try_inline_read&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;404&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;_try_inline_read&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_maybe_add_error_listener&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;550&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;_maybe_add_error_listener&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_add_io_state&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ioloop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IOLoop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;READ&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/iostream.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;580&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;_add_io_state&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fileno&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_handle_events&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_state&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
      &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="s2"&gt;"/home/kura/.virtualenvs/blackhole-python2.7/local/lib/python2.7/site-packages/tornado-3.0.1-py2.7.egg/tornado/ioloop.py"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt; &lt;span class="mi"&gt;516&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;add_handler&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;_impl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;register&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;events&lt;/span&gt; &lt;span class="o"&gt;|&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ERROR&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="ne"&gt;IOError&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="n"&gt;Errno&lt;/span&gt; &lt;span class="mi"&gt;17&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="n"&gt;File&lt;/span&gt; &lt;span class="n"&gt;exists&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I had no choice at this point but to do what I always do when I’m stumped,
&lt;a class="reference external" href="https://groups.google.com/forum/#!topic/python-tornado/"&gt;head over to the mailing list!&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;I didn’t get a response for a while so while waiting I decided to ask some intelligent people.&lt;/p&gt;
&lt;p&gt;I pointed a tweet at &lt;a class="reference external" href="https://twitter.com/alex_gaynor"&gt;@alex_gaynor&lt;/a&gt; which was
responded to by &lt;a class="reference external" href="https://twitter.com/fijall"&gt;@fijall&lt;/a&gt; but neither could help.
Alex mentioned Twisted which triggered a response from &lt;a class="reference external" href="https://twitter.com/hynek"&gt;@hynek&lt;/a&gt;
but sadly still no solution.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-fix"&gt;
&lt;h2&gt;The fix&lt;/h2&gt;
&lt;p&gt;Then I received an email response from Ben Darnell on the Tornado mailing list which pointed
me in the right direction.&lt;/p&gt;
&lt;p&gt;In the end the simple fix was to modify the instance of &lt;cite&gt;tornado.ioloop.IOLoop&lt;/cite&gt; during run time
and removed the original instance of &lt;cite&gt;IOStream&lt;/cite&gt; from it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;lower&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"starttls"&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;fileno&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fileno&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;IOLoop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;current&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove_handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fileno&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="connection-ready"&gt;
&lt;h2&gt;connection_ready&lt;/h2&gt;
&lt;p&gt;You can see this at work in the final version of the connect_ready method.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connection_ready&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;fd&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;events&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;    Accepts the socket connections and passes them off&lt;/span&gt;
&lt;span class="sd"&gt;    to be handled.&lt;/span&gt;

&lt;span class="sd"&gt;    'sock' is an instance of 'socket'.&lt;/span&gt;
&lt;span class="sd"&gt;    'fd' is an open file descriptor for the current connection.&lt;/span&gt;
&lt;span class="sd"&gt;    'events' is an integer of the number of events on the socket.&lt;/span&gt;
&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;sock&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;accept&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errno&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;errno&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EWOULDBLOCK&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;errno&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;EAGAIN&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="k"&gt;raise&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt;

        &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Connection from '&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;'"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="n"&gt;address&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

        &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;setblocking&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;connection_stream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt;
        &lt;span class="n"&gt;mail_state&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;MailState&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;email_id&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;email_id&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;stream&lt;/span&gt;

        &lt;span class="c1"&gt;# Sadly there is nothing I can do about the handle and loop&lt;/span&gt;
        &lt;span class="c1"&gt;# fuctions. They have to exist within connection_ready&lt;/span&gt;
        &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;            Handle a line of socket data, figure out if&lt;/span&gt;
&lt;span class="sd"&gt;            it's a valid SMTP keyword and handle it&lt;/span&gt;
&lt;span class="sd"&gt;            accordingly.&lt;/span&gt;
&lt;span class="sd"&gt;            """&lt;/span&gt;
            &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"[&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;] RECV: &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;email_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;rstrip&lt;/span&gt;&lt;span class="p"&gt;()))&lt;/span&gt;
            &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;close&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;handle_command&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="nb"&gt;isinstance&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="nb"&gt;list&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                    &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                        &lt;span class="n"&gt;write_response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;r&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                    &lt;span class="c1"&gt;# Otherwise it's a single response&lt;/span&gt;
                    &lt;span class="n"&gt;write_response&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;resp&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;line&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;lower&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;startswith&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"starttls"&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
                &lt;span class="n"&gt;fileno&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;fileno&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
                &lt;span class="n"&gt;IOLoop&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;current&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove_handler&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;fileno&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;close&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="kc"&gt;True&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;debug&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"Closing"&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
                &lt;span class="k"&gt;del&lt;/span&gt; &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;
                &lt;span class="k"&gt;return&lt;/span&gt;
            &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

        &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;            Loop over the socket data until we receive&lt;/span&gt;
&lt;span class="sd"&gt;            a newline character (\n)&lt;/span&gt;
&lt;span class="sd"&gt;            """&lt;/span&gt;
            &lt;span class="c1"&gt;# Protection against stream already reading exceptions&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;reading&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
                &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;read_until&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;hm&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;"220 &lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt; [&lt;/span&gt;&lt;span class="si"&gt;%s&lt;/span&gt;&lt;span class="s2"&gt;]&lt;/span&gt;&lt;span class="se"&gt;\r\n&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt; &lt;span class="o"&gt;%&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;get_mailname&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;__fullname__&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;mail_state&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;hm&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;loop&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="tornado"></category><category term="iostream"></category><category term="ssl"></category><category term="starttls"></category><category term="blackhole"></category></entry><entry><title>Wrapping a Tornado IOStream with SSL</title><link href="https://kura.gg/2013/07/29/wrapping-a-tornado-iostream-with-ssl/" rel="alternate"></link><published>2013-07-29T20:00:00+01:00</published><updated>2013-07-29T20:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-07-29:/2013/07/29/wrapping-a-tornado-iostream-with-ssl/</id><summary type="html">
&lt;p&gt;As part of my effort to make &lt;a class="reference external" href="https://blackhole.io/"&gt;Blackhole&lt;/a&gt; as
useful and usable as possible, I needed to be able to support &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt;
enabled connections.&lt;/p&gt;
&lt;p&gt;Tornado itself has two built-in IOStreams that help us do the job;
the first is the standard &lt;a class="reference external" href="https://www.tornadoweb.org/en/stable/iostream.html#tornado.iostream.IOStream"&gt;IOStream&lt;/a&gt;
and the second is the &lt;a class="reference external" href="https://www.tornadoweb.org/en/stable/iostream.html#tornado.iostream.SSLIOStream"&gt;SSLIOStream&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;With this in mind we simply need to spawn two sockets, by default these
listen on port 25 for standard &lt;span class="caps"&gt;SMTP&lt;/span&gt; and port 465 for &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt;
encrypted &lt;span class="caps"&gt;SMTP&lt;/span&gt;. With these two sockets bound we’re then very
simply able to listen for incoming connections on either socket
and use &lt;cite&gt;socket.socket.getsockname()&lt;/cite&gt; to figure out if the
connection is to the encrypted or unencrypted socket.&lt;/p&gt;
&lt;div class="section" id="code"&gt;
&lt;h2&gt;Code&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connection_stream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;    Detect which socket the connection is being made on,&lt;/span&gt;
&lt;span class="sd"&gt;    create and iostream for the connection, wrapping it&lt;/span&gt;
&lt;span class="sd"&gt;    in SSL if connected over the SSL socket.&lt;/span&gt;

&lt;span class="sd"&gt;    The parameter 'connection' is an instance …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;As part of my effort to make &lt;a class="reference external" href="https://blackhole.io/"&gt;Blackhole&lt;/a&gt; as
useful and usable as possible, I needed to be able to support &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt;
enabled connections.&lt;/p&gt;
&lt;p&gt;Tornado itself has two built-in IOStreams that help us do the job;
the first is the standard &lt;a class="reference external" href="https://www.tornadoweb.org/en/stable/iostream.html#tornado.iostream.IOStream"&gt;IOStream&lt;/a&gt;
and the second is the &lt;a class="reference external" href="https://www.tornadoweb.org/en/stable/iostream.html#tornado.iostream.SSLIOStream"&gt;SSLIOStream&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;With this in mind we simply need to spawn two sockets, by default these
listen on port 25 for standard &lt;span class="caps"&gt;SMTP&lt;/span&gt; and port 465 for &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt;
encrypted &lt;span class="caps"&gt;SMTP&lt;/span&gt;. With these two sockets bound we’re then very
simply able to listen for incoming connections on either socket
and use &lt;cite&gt;socket.socket.getsockname()&lt;/cite&gt; to figure out if the
connection is to the encrypted or unencrypted socket.&lt;/p&gt;
&lt;div class="section" id="code"&gt;
&lt;h2&gt;Code&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;connection_stream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="sd"&gt;"""&lt;/span&gt;
&lt;span class="sd"&gt;    Detect which socket the connection is being made on,&lt;/span&gt;
&lt;span class="sd"&gt;    create and iostream for the connection, wrapping it&lt;/span&gt;
&lt;span class="sd"&gt;    in SSL if connected over the SSL socket.&lt;/span&gt;

&lt;span class="sd"&gt;    The parameter 'connection' is an instance of 'socket'&lt;/span&gt;
&lt;span class="sd"&gt;    from stdlib.&lt;/span&gt;
&lt;span class="sd"&gt;    """&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getsockname&lt;/span&gt;&lt;span class="p"&gt;()[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssl_port&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;ssl_connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wrap_socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;sslkwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLError&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errno&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSL_ERROR_EOF&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errno&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;errno&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ECONNABORTED&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
                &lt;span class="k"&gt;return&lt;/span&gt;
            &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;raise&lt;/span&gt;
        &lt;span class="c1"&gt;# Do a nasty blanket Exception until SSL exceptions are fully known&lt;/span&gt;
        &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;iostream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLIOStream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;iostream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IOStream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So let’s explain a little bit how this works.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="if-connection-getsockname"&gt;
&lt;h2&gt;if connection.getsockname…&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;getsockname&lt;/span&gt;&lt;span class="p"&gt;()[&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssl_port&lt;/span&gt; &lt;span class="ow"&gt;and&lt;/span&gt; &lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This piece of code checks the second value in the list returned by &lt;cite&gt;getsockname()&lt;/cite&gt;,
this item in the list will be the port number the socket is listening to.&lt;/p&gt;
&lt;p&gt;So we simply check to see if it’s the configured &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt; port and if
&lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt; is turned on.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="st-try-except"&gt;
&lt;h2&gt;1st try… except…&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;ssl_connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wrap_socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;sslkwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLError&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;socket&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errno&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSL_ERROR_EOF&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;errno&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="n"&gt;errno&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ECONNABORTED&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt;
    &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="k"&gt;raise&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The first try/except group will attemp to wrap the socket using Python’s
built-in &lt;span class="caps"&gt;SSL&lt;/span&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="n"&gt;ssl_connection&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;ssl&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;wrap_socket&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;sslkwargs&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If this throws an exception we try to determine what caused it and
close the connection, otherwise we raise the exception and crash out.
It’s not the nicest way to do it but in theory you shouldn’t be able
to reach the else (I may be wrong on this point though…).&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="nd-try-except"&gt;
&lt;h2&gt;2nd try… except…&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Do a nasty blanket Exception until SSL exceptions are fully known&lt;/span&gt;
&lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;iostream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;SSLIOStream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="ne"&gt;Exception&lt;/span&gt; &lt;span class="k"&gt;as&lt;/span&gt; &lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;log&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;error&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;e&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;ssl_connection&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;close&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here we simply try to return an instance of Tornado’s
&lt;cite&gt;iostream.SSLIOStream&lt;/cite&gt;, if we get any kind of Exception it will be
raised, logged and the connection will be close.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="else"&gt;
&lt;h2&gt;else&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;iostream&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;IOStream&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And the final else will return an instance of Tornado’s
&lt;cite&gt;iostream.IOStream&lt;/cite&gt; if &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt; is disabled or if the connection
was made to the non &lt;span class="caps"&gt;SSL&lt;/span&gt;/&lt;span class="caps"&gt;TLS&lt;/span&gt; port.&lt;/p&gt;
&lt;/div&gt;
</content><category term="coding"></category><category term="python"></category><category term="tornado"></category><category term="iostream"></category><category term="ssl"></category><category term="blackhole"></category></entry><entry><title>haproxy stats</title><link href="https://kura.gg/2013/07/19/haproxy-stats/" rel="alternate"></link><published>2013-07-19T13:00:00+01:00</published><updated>2013-07-19T13:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-07-19:/2013/07/19/haproxy-stats/</id><content type="html">
&lt;p&gt;I recently wrote an article on &lt;a class="reference external" href="/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/"&gt;using haproxy, &lt;span class="caps"&gt;SSL&lt;/span&gt; and
&lt;span class="caps"&gt;SPDY&lt;/span&gt; with nginx backend servers&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This article is a little extra on top of that to explain
how to enable statistics for haproxy so you can monitor
the backend statuses etc.&lt;/p&gt;
&lt;div class="section" id="example-stats-page"&gt;
&lt;h2&gt;Example stats page&lt;/h2&gt;
&lt;img alt="Moar stats!" src="/images/haproxy-stats.png"/&gt;
&lt;/div&gt;
&lt;div class="section" id="enabling-stats"&gt;
&lt;h2&gt;Enabling stats&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
listen stats :8000
    mode http
    stats enable
    stats hide-version
    stats realm haproxy\ stats
    stats uri /
    stats auth admin:admin
&lt;/pre&gt;
&lt;p&gt;Place the above content in the haproxy configuration
file (&lt;em&gt;/etc/haproxy/haproxy.cfg&lt;/em&gt;).&lt;/p&gt;
&lt;p&gt;Be sure to replace &lt;em&gt;admin:admin&lt;/em&gt; with your a proper
username and password, username first, password
after the colon.&lt;/p&gt;
&lt;p&gt;Restart haproxy, and then browse to &lt;a class="reference external" href="https://yoursite.com:8000"&gt;https://yousite.com:8000&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="haproxy"></category><category term="stats"></category></entry><entry><title>DJUGL June 2013 talk on blackhole and blackhole.io</title><link href="https://kura.gg/2013/07/17/djugl-june-2013-talk-on-blackhole-and-blackhole-io/" rel="alternate"></link><published>2013-07-17T21:00:00+01:00</published><updated>2013-07-17T21:00:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-07-17:/2013/07/17/djugl-june-2013-talk-on-blackhole-and-blackhole-io/</id><summary type="html">&lt;p&gt;I have been a frequent audience member of &lt;a class="reference external" href="https://www.djugl.org/item/443153"&gt;&lt;span class="caps"&gt;DJUGL&lt;/span&gt;&lt;/a&gt;
for a few years now and spend most of the time asking questions,
playing devils advocate and generally being my annoying self.&lt;/p&gt;
&lt;p&gt;I have repeatedly said I would do a talk but never got round to it
until &lt;a class="reference external" href="https://twitter.com/JonWebJobs"&gt;Jon&lt;/a&gt; basically forced me
to get round to it.&lt;/p&gt;
&lt;p&gt;My talk was on &lt;a class="reference external" href="https://blackhole.io"&gt;blackhole/blackhole.io&lt;/a&gt; and
covered several topics including &lt;a class="reference external" href="https://pypy.org"&gt;PyPy&lt;/a&gt;,
&lt;a class="reference external" href="/simplemta/"&gt;SimpleMTA&lt;/a&gt; and moved on to talking
about spamming and starting work on my honey pot suite called
&lt;a class="reference external" href="https://nectar.blackhole.io"&gt;Nectar&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;You can find the slides on &lt;a class="reference external" href="https://speakerdeck.com/kura/djugl-june-2013"&gt;Speaker Deck&lt;/a&gt;,
sadly I ran out of time when creating them and although I was
promised time to finish them at work, I got busy. So I replaced
content with “Taylor Replacements(tm)”.&lt;/p&gt;
&lt;p&gt;The event, attendees and other speakers are listen on the &lt;a class="reference external" href="https://lanyrd.com/2013/djugl-june/"&gt;Lanyrd
event page&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Several people took photos of the event, I don’t remember …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I have been a frequent audience member of &lt;a class="reference external" href="https://www.djugl.org/item/443153"&gt;&lt;span class="caps"&gt;DJUGL&lt;/span&gt;&lt;/a&gt;
for a few years now and spend most of the time asking questions,
playing devils advocate and generally being my annoying self.&lt;/p&gt;
&lt;p&gt;I have repeatedly said I would do a talk but never got round to it
until &lt;a class="reference external" href="https://twitter.com/JonWebJobs"&gt;Jon&lt;/a&gt; basically forced me
to get round to it.&lt;/p&gt;
&lt;p&gt;My talk was on &lt;a class="reference external" href="https://blackhole.io"&gt;blackhole/blackhole.io&lt;/a&gt; and
covered several topics including &lt;a class="reference external" href="https://pypy.org"&gt;PyPy&lt;/a&gt;,
&lt;a class="reference external" href="/simplemta/"&gt;SimpleMTA&lt;/a&gt; and moved on to talking
about spamming and starting work on my honey pot suite called
&lt;a class="reference external" href="https://nectar.blackhole.io"&gt;Nectar&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;You can find the slides on &lt;a class="reference external" href="https://speakerdeck.com/kura/djugl-june-2013"&gt;Speaker Deck&lt;/a&gt;,
sadly I ran out of time when creating them and although I was
promised time to finish them at work, I got busy. So I replaced
content with “Taylor Replacements(tm)”.&lt;/p&gt;
&lt;p&gt;The event, attendees and other speakers are listen on the &lt;a class="reference external" href="https://lanyrd.com/2013/djugl-june/"&gt;Lanyrd
event page&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Several people took photos of the event, I don’t remember who they
were to give them credit but you can view them below.&lt;/p&gt;
&lt;p&gt;Unsurprisingly I was the only speaker at the event that
didn’t have a Mac. I have a ginormous Alienware M17x R3 running Linux.&lt;/p&gt;
&lt;ol class="arabic"&gt;
&lt;li&gt;&lt;img alt="I look like a hairy beast..." class="first" src="/images/djugl-june-2013-3.png"/&gt;
&lt;/li&gt;
&lt;li&gt;&lt;img alt="I look like a hairy beast..." class="first" src="/images/djugl-june-2013-2.png"/&gt;
&lt;/li&gt;
&lt;li&gt;&lt;img alt="I look like a hairy beast..." class="first" src="/images/djugl-june-2013-1.png"/&gt;
&lt;/li&gt;
&lt;/ol&gt;
</content><category term="talks"></category><category term="python"></category><category term="pypy"></category><category term="blackhole"></category><category term="blackhole.io"></category><category term="mta"></category><category term="email"></category><category term="honeypot"></category></entry><entry><title>haproxy, nginx and SPDY with SSL termination (Debian 7)</title><link href="https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/" rel="alternate"></link><published>2013-07-15T22:30:00+01:00</published><updated>2013-07-15T22:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-07-15:/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/</id><summary type="html">
&lt;p&gt;&lt;a class="reference external" href="/2013/07/10/nginx-spdy-and-ngx-pagespeed/"&gt;I wrote an article last week&lt;/a&gt; explaining that I had changed my blog
and built my own nginx packages with &lt;a class="reference external" href="https://www.chromium.org/spdy"&gt;&lt;span class="caps"&gt;SPDY&lt;/span&gt;&lt;/a&gt; built in.&lt;/p&gt;
&lt;p&gt;I decided I would take things a little further and poke around with
haproxy some more. The initial plan was to compile the latest dev
source of haproxy with &lt;span class="caps"&gt;SSL&lt;/span&gt; termination enabled.&lt;/p&gt;
&lt;p&gt;In doing so I realised I would lose &lt;span class="caps"&gt;SPDY&lt;/span&gt; support, which upset me a
little. After some digging I found that the 1.5-dev branch of
haproxy supports npn and thus can handle &lt;span class="caps"&gt;SPDY&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I tweaked my builds a little more and managed to get haproxy
running as an &lt;span class="caps"&gt;SSL&lt;/span&gt; terminating load balancer, with &lt;span class="caps"&gt;SPDY&lt;/span&gt; connections
being sent off to my nginx servers with &lt;span class="caps"&gt;SPDY&lt;/span&gt; enabled and all other
non-&lt;span class="caps"&gt;SPDY&lt;/span&gt; connections were passed on to an nginx virtual host with
&lt;span class="caps"&gt;SPDY&lt;/span&gt; disabled.&lt;/p&gt;
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;p&gt;I have released my haproxy build as a debian file below …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;&lt;a class="reference external" href="/2013/07/10/nginx-spdy-and-ngx-pagespeed/"&gt;I wrote an article last week&lt;/a&gt; explaining that I had changed my blog
and built my own nginx packages with &lt;a class="reference external" href="https://www.chromium.org/spdy"&gt;&lt;span class="caps"&gt;SPDY&lt;/span&gt;&lt;/a&gt; built in.&lt;/p&gt;
&lt;p&gt;I decided I would take things a little further and poke around with
haproxy some more. The initial plan was to compile the latest dev
source of haproxy with &lt;span class="caps"&gt;SSL&lt;/span&gt; termination enabled.&lt;/p&gt;
&lt;p&gt;In doing so I realised I would lose &lt;span class="caps"&gt;SPDY&lt;/span&gt; support, which upset me a
little. After some digging I found that the 1.5-dev branch of
haproxy supports npn and thus can handle &lt;span class="caps"&gt;SPDY&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I tweaked my builds a little more and managed to get haproxy
running as an &lt;span class="caps"&gt;SSL&lt;/span&gt; terminating load balancer, with &lt;span class="caps"&gt;SPDY&lt;/span&gt; connections
being sent off to my nginx servers with &lt;span class="caps"&gt;SPDY&lt;/span&gt; enabled and all other
non-&lt;span class="caps"&gt;SPDY&lt;/span&gt; connections were passed on to an nginx virtual host with
&lt;span class="caps"&gt;SPDY&lt;/span&gt; disabled.&lt;/p&gt;
&lt;div class="section" id="requirements"&gt;
&lt;h2&gt;Requirements&lt;/h2&gt;
&lt;p&gt;I have released my haproxy build as a debian file below, it is built
off of haproxy_1.5~dev19 and is compiled for amd64. It should work on
any installation of Debian 7 and requires openssl-1.0.1d or higher.&lt;/p&gt;
&lt;p&gt;On a standard Debian 7 install you should have openssl-1.0.1e-2, you
can find which version you have by running&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;-l&lt;span class="w"&gt; &lt;/span&gt;openssl
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This should return something similar to&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ii  openssl        1.0.1e-2        amd64        Secure Socket Layer (SSL) binary and related cryptographic tools
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="installing-haproxy"&gt;
&lt;h2&gt;Installing haproxy&lt;/h2&gt;
&lt;p&gt;Download the deb file below, use either the &lt;span class="caps"&gt;GPG&lt;/span&gt; key or &lt;span class="caps"&gt;MD5&lt;/span&gt;/&lt;span class="caps"&gt;SHA1&lt;/span&gt; sums to verify it.&lt;/p&gt;
&lt;table class="docutils"&gt;
&lt;thead&gt;
&lt;tr&gt;&lt;th class="head"&gt;&lt;span class="caps"&gt;FILE&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5~dev19_amd64.deb"&gt;haproxy_1.5~dev19_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5~dev19_amd64.deb.asc"&gt;owGMeXVU1G…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5~dev19_amd64.deb.md5"&gt;715317e082…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/haproxy_1.5~dev19_amd64.deb.sha1"&gt;e116e1c597…&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;If you already have haproxy installed, make sure to remove it first.&lt;/p&gt;
&lt;p&gt;You can install them by simply running:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;haproxy_1.5~dev19_amd64.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You may receive an error due to missing dependencies, to fix this run:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;-f
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-haproxy"&gt;
&lt;h2&gt;Configuring haproxy&lt;/h2&gt;
&lt;p&gt;First we need to enabled haproxy by running the following command&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sed&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'s/ENABLED=0/ENABLED=1/'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/default/haproxy
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We then need to empty the contents of the haproxy configuration and
replace it with a nice blank file. The following command will copy
the original file to a new location and create a blank file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mv&lt;span class="w"&gt; &lt;/span&gt;/etc/haproxy/haproxy.cfg&lt;span class="o"&gt;{&lt;/span&gt;,.orig&lt;span class="o"&gt;}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;/etc/haproxy/haproxy.cfg
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class="caps"&gt;SPDY&lt;/span&gt; only works over &lt;span class="caps"&gt;HTTPS&lt;/span&gt;, so bare that in mind. All you need to do is
enable &lt;span class="caps"&gt;SPDY&lt;/span&gt; in your server configuration as below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
global
    maxconn 4096
    user haproxy
    group haproxy

defaults
    option dontlognull
    retries 3
    option redispatch
    maxconn 2000
    contimeout 5000
    clitimeout 50000
    srvtimeout 50000

frontend http
    mode http
    bind 0.0.0.0:80
    redirect sheme https if !{ ssl_fc }

frontend kura-gg
    mode tcp
    bind 0.0.0.0:443 ssl crt /etc/ssl/certs/kura.gg.pem npn spdy/2 # pem is certificate, intermediate and finally private key
    use_backend kura-app-spdy if { ssl_fc_npn -i spdy/2 }
    default_backend kura-app-http

backend kura-app-spdy
    mode tcp
    server kura-gg-app1 127.0.0.1:80 check

backend kura-app-http
    mode http
    server kura-gg-app1 127.0.0.1:81 check
&lt;/pre&gt;
&lt;p&gt;You don’t need to worry about the &lt;em&gt;global&lt;/em&gt; and &lt;em&gt;defaults&lt;/em&gt; sections, I will now
explain what the final four sections do.&lt;/p&gt;
&lt;div class="section" id="frontend-http"&gt;
&lt;h3&gt;frontend http&lt;/h3&gt;
&lt;pre class="literal-block"&gt;
frontend http
    mode http
    bind 0.0.0.0:80
    redirect sheme https if !{ ssl_fc }
&lt;/pre&gt;
&lt;p&gt;This tells haproxy to listen on port 80 and redirect all traffic
to the &lt;span class="caps"&gt;HTTPS&lt;/span&gt; version of the site.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="frontend-kura-gg"&gt;
&lt;h3&gt;frontend kura-gg&lt;/h3&gt;
&lt;pre class="literal-block"&gt;
frontend kura-gg
    mode tcp
    bind 0.0.0.0:443 ssl crt /etc/ssl/certs/kura.gg.pem npn spdy/2 # pem is certificate, intermediate and finally private key
    use_backend kura-app-spdy if { ssl_fc_npn -i spdy/2 }
    default_backend kura-app-http
&lt;/pre&gt;
&lt;p&gt;This section sets the proxy mode to tcp, which sends tcp
data over to the backend servers rather than http requests.&lt;/p&gt;
&lt;p&gt;We then bind to all interfaces on port 443, enabling &lt;span class="caps"&gt;SSL&lt;/span&gt; and
passing in a &lt;span class="caps"&gt;PEM&lt;/span&gt; version of the certificate in the following format&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-----BEGIN CERTIFICATE-----
MAIN CERTIFICATE FOR KURA.IO
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
INTERMEDIATE CERTIFICATE
-----END CERTIFICATE-----
-----BEGIN RSA PRIVATE KEY-----
PRIVATE KEY
-----END RSA PRIVATE KEY-----
&lt;/pre&gt;
&lt;p&gt;Finally we do some magic. We tell haproxy to use
the &lt;span class="caps"&gt;SPDY&lt;/span&gt; backend if a &lt;span class="caps"&gt;SPDY&lt;/span&gt; header is present:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
use_backend kura-app-spdy if { ssl_fc_npn -i spdy/2 }
&lt;/pre&gt;
&lt;p&gt;If not then we fall back to the default &lt;span class="caps"&gt;HTTP&lt;/span&gt; backend:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
default_backend kura-app-http
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="backend-kura-app-spdy"&gt;
&lt;h3&gt;backend kura-app-spdy&lt;/h3&gt;
&lt;pre class="literal-block"&gt;
backend kura-app-spdy
    mode tcp
    server kura-gg-app1 127.0.0.1:80 check
&lt;/pre&gt;
&lt;p&gt;This section simply defines the server we should talk to if
the client is using an &lt;span class="caps"&gt;SPDY&lt;/span&gt; enabled connection.&lt;/p&gt;
&lt;p&gt;Simply define multiple servers for additional servers.&lt;/p&gt;
&lt;p&gt;You can see I am point it at 127.0.0.1 on port 80.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="backend-kura-app-http"&gt;
&lt;h3&gt;backend kura-app-http&lt;/h3&gt;
&lt;pre class="literal-block"&gt;
backend kura-app-http
    mode http
    server kura-gg-app1 127.0.0.1:81 check
&lt;/pre&gt;
&lt;p&gt;And finally, here I am defining the http backends
to fall back on for non-&lt;span class="caps"&gt;SPDY&lt;/span&gt; connections.&lt;/p&gt;
&lt;p&gt;You can see this is almost identical to the &lt;span class="caps"&gt;SPDY&lt;/span&gt;
backend except it is running in &lt;span class="caps"&gt;HTTP&lt;/span&gt; mode.&lt;/p&gt;
&lt;p&gt;As with the &lt;span class="caps"&gt;SPDY&lt;/span&gt; backends, simply define multiple
servers as required. Here I am using 127.0.0.1 and
port 81.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="nginx"&gt;
&lt;h2&gt;nginx&lt;/h2&gt;
&lt;p&gt;To make this all tie together we simply need to
install an &lt;span class="caps"&gt;SPDY&lt;/span&gt;-enabled nginx.&lt;/p&gt;
&lt;p&gt;You can &lt;a class="reference external" href="/2013/07/10/nginx-spdy-and-ngx-pagespeed/"&gt;follow my guide on how to install my
packaged version of nginx with &lt;span class="caps"&gt;SPDY&lt;/span&gt; enabled&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Follow this guide up until the configuration of nginx.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-nginx"&gt;
&lt;h2&gt;Configuring nginx&lt;/h2&gt;
&lt;p&gt;Within nginx we need to enable two virtual hosts&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;spdy&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;kura.gg&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# make nginx 301 redirects work&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;port_in_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name_in_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="s"&gt;/var/www/kura.gg/&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;index&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s"&gt;index.html&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;index.htm&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;81&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;kura.gg&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# make nginx 301 redirects work&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;port_in_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name_in_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="s"&gt;/var/www/kura.gg/&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;index&lt;/span&gt;&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="s"&gt;index.html&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;index.htm&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The first virtual host is our &lt;span class="caps"&gt;SPDY&lt;/span&gt; enabled host
which is configured to run on port 80.&lt;/p&gt;
&lt;p&gt;The second is our standard &lt;span class="caps"&gt;HTTP&lt;/span&gt; host which is
running on port 81.&lt;/p&gt;
&lt;p&gt;We have two lines &lt;em&gt;port_in_redirect&lt;/em&gt; and &lt;em&gt;server_name_in_redirect&lt;/em&gt;
set to &lt;em&gt;off&lt;/em&gt; because otherwise nginx would try to redirect to
&lt;a class="reference external" href="https://kura.gg:81/"&gt;https://kura.gg:81/&lt;/a&gt; and cause issues with haproxy.&lt;/p&gt;
&lt;p&gt;It’s a simple as that, you can test this using the &lt;a class="reference external" href="https://addons.mozilla.org/en-us/firefox/addon/spdy-indicator/"&gt;Firefox&lt;/a&gt; and
&lt;a class="reference external" href="https://chrome.google.com/webstore/detail/spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin"&gt;Chrome&lt;/a&gt; extensions that show you websites with &lt;span class="caps"&gt;SPDY&lt;/span&gt; enabled.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="ubuntu"></category><category term="haproxy"></category><category term="nginx"></category><category term="spdy"></category><category term="ssl"></category><category term="ssl termination"></category></entry><entry><title>nginx, SPDY and ngx_pagespeed (Debian/Ubuntu)</title><link href="https://kura.gg/2013/07/10/nginx-spdy-and-ngx-pagespeed/" rel="alternate"></link><published>2013-07-10T22:30:00+01:00</published><updated>2013-07-10T22:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-07-10:/2013/07/10/nginx-spdy-and-ngx-pagespeed/</id><summary type="html">
&lt;p&gt;I decided to rebuild syslog.tv as pure &lt;span class="caps"&gt;HTML&lt;/span&gt; using &lt;span class="caps"&gt;RST&lt;/span&gt; and
&lt;a class="reference external" href="https://blog.getpelican.com/"&gt;Pelican&lt;/a&gt; and rebrand it as kura.gg.&lt;/p&gt;
&lt;p&gt;In doing so I decided I would go all out and use &lt;a class="reference external" href="https://www.chromium.org/spdy"&gt;&lt;span class="caps"&gt;SPDY&lt;/span&gt;&lt;/a&gt; and
&lt;a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_spdy_module.html"&gt;ngx_pagespeed&lt;/a&gt; (&lt;a class="reference external" href="https://developers.google.com/speed/"&gt;mod_pagespeed&lt;/a&gt;) for fun to see exactly
what I could do.&lt;/p&gt;
&lt;p&gt;Sadly no version of nginx has been officially released with &lt;span class="caps"&gt;SPDY&lt;/span&gt;
or ngx_pagespeed enabled, you can compile nginx from source to
enable &lt;span class="caps"&gt;SPDY&lt;/span&gt; so I thought I would go ahead and do it, releasing
some Debian packages in the process.&lt;/p&gt;
&lt;p&gt;After compiling nginx from the source package available at the
&lt;a class="reference external" href="https://launchpad.net/~nginx"&gt;Ubuntu &lt;span class="caps"&gt;PPA&lt;/span&gt;&lt;/a&gt;, I decided I would go further and compile in ngx_pagespeed.&lt;/p&gt;
&lt;div class="section" id="installing"&gt;
&lt;h2&gt;Installing&lt;/h2&gt;
&lt;p&gt;I have released the 4 required debian packages below (please note
they are only available for amd64);&lt;/p&gt;
&lt;table class="docutils"&gt;
&lt;thead&gt;
&lt;tr&gt;&lt;th class="head"&gt;&lt;span class="caps"&gt;FILE&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.4.1_all.deb"&gt;nginx_1.4.1_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.4.1_all.deb.asc"&gt;owGMl1NwLw…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.4.1_all.deb.md5"&gt;42f790a1f6…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.4.1_all.deb.sha1"&gt;f4495055e9…&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.4.1_all.deb"&gt;nginx-common_1.4.1_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.4.1_all.deb.asc"&gt;owGMt1NwJU…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.4.1_all.deb.md5"&gt;ca4ec5688d…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.4.1_all.deb.sha1"&gt;633bfc2eaa…&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.4.1_amd64.deb"&gt;nginx-full_1.4.1_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.4.1_amd64.deb.asc"&gt;owG09ndUk1…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.4.1_amd64.deb.md5"&gt;4776dc6c7f…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.4.1_amd64.deb.sha1"&gt;0e4e124acc…&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.4.1_all.deb"&gt;nginx-doc_1 …&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I decided to rebuild syslog.tv as pure &lt;span class="caps"&gt;HTML&lt;/span&gt; using &lt;span class="caps"&gt;RST&lt;/span&gt; and
&lt;a class="reference external" href="https://blog.getpelican.com/"&gt;Pelican&lt;/a&gt; and rebrand it as kura.gg.&lt;/p&gt;
&lt;p&gt;In doing so I decided I would go all out and use &lt;a class="reference external" href="https://www.chromium.org/spdy"&gt;&lt;span class="caps"&gt;SPDY&lt;/span&gt;&lt;/a&gt; and
&lt;a class="reference external" href="https://nginx.org/en/docs/http/ngx_http_spdy_module.html"&gt;ngx_pagespeed&lt;/a&gt; (&lt;a class="reference external" href="https://developers.google.com/speed/"&gt;mod_pagespeed&lt;/a&gt;) for fun to see exactly
what I could do.&lt;/p&gt;
&lt;p&gt;Sadly no version of nginx has been officially released with &lt;span class="caps"&gt;SPDY&lt;/span&gt;
or ngx_pagespeed enabled, you can compile nginx from source to
enable &lt;span class="caps"&gt;SPDY&lt;/span&gt; so I thought I would go ahead and do it, releasing
some Debian packages in the process.&lt;/p&gt;
&lt;p&gt;After compiling nginx from the source package available at the
&lt;a class="reference external" href="https://launchpad.net/~nginx"&gt;Ubuntu &lt;span class="caps"&gt;PPA&lt;/span&gt;&lt;/a&gt;, I decided I would go further and compile in ngx_pagespeed.&lt;/p&gt;
&lt;div class="section" id="installing"&gt;
&lt;h2&gt;Installing&lt;/h2&gt;
&lt;p&gt;I have released the 4 required debian packages below (please note
they are only available for amd64);&lt;/p&gt;
&lt;table class="docutils"&gt;
&lt;thead&gt;
&lt;tr&gt;&lt;th class="head"&gt;&lt;span class="caps"&gt;FILE&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;GPG&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;MD5&lt;/span&gt;&lt;/th&gt;
&lt;th class="head"&gt;&lt;span class="caps"&gt;SHA1&lt;/span&gt;&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.4.1_all.deb"&gt;nginx_1.4.1_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.4.1_all.deb.asc"&gt;owGMl1NwLw…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.4.1_all.deb.md5"&gt;42f790a1f6…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx_1.4.1_all.deb.sha1"&gt;f4495055e9…&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.4.1_all.deb"&gt;nginx-common_1.4.1_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.4.1_all.deb.asc"&gt;owGMt1NwJU…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.4.1_all.deb.md5"&gt;ca4ec5688d…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-common_1.4.1_all.deb.sha1"&gt;633bfc2eaa…&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.4.1_amd64.deb"&gt;nginx-full_1.4.1_amd64.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.4.1_amd64.deb.asc"&gt;owG09ndUk1…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.4.1_amd64.deb.md5"&gt;4776dc6c7f…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-full_1.4.1_amd64.deb.sha1"&gt;0e4e124acc…&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.4.1_all.deb"&gt;nginx-doc_1.4.1_all.deb&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.4.1_all.deb.asc"&gt;owGMtlOQJQ…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.4.1_all.deb.md5"&gt;ad8ae70215…&lt;/a&gt;&lt;/td&gt;
&lt;td&gt;&lt;a class="reference external" href="/files/nginx-doc_1.4.1_all.deb.sha1"&gt;690563e7cc…&lt;/a&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;You can install them by simply running:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;nginx*.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you already have nginx installed, make sure to remove it first.&lt;/p&gt;
&lt;p&gt;You may receive an error due to missing dependencies, to fix this run:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;-f
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-spdy"&gt;
&lt;h2&gt;Configuring &lt;span class="caps"&gt;SPDY&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;span class="caps"&gt;SPDY&lt;/span&gt; only works over &lt;span class="caps"&gt;HTTPS&lt;/span&gt;, so bare that in mind. All you need to do is
enable &lt;span class="caps"&gt;SPDY&lt;/span&gt; in your server configuration as below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;443&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;ssl&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;spdy&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;kura.gg&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It’s a simple as that, you can test this using the &lt;a class="reference external" href="https://addons.mozilla.org/en-us/firefox/addon/spdy-indicator/"&gt;Firefox&lt;/a&gt; and
&lt;a class="reference external" href="https://chrome.google.com/webstore/detail/spdy-indicator/mpbpobfflnpcgagjijhmgnchggcjblin"&gt;Chrome&lt;/a&gt; extensions that show you websites with &lt;span class="caps"&gt;SPDY&lt;/span&gt; enabled.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-ngx-pagespeed"&gt;
&lt;h2&gt;Configuring ngx_pagespeed&lt;/h2&gt;
&lt;p&gt;To enable ngx_pagespeed you first need to create a directory
that it can write cache files to.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/var/cache/ngx_pagespeed/
sudo&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;www-data:www-data&lt;span class="w"&gt; &lt;/span&gt;/var/cache/ngx_pagespeed/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once this is done you can enable ngx_pagespeed in your
server configuration as below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;pagespeed&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;pagespeed&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;RewriteLevel&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;CoreFilters&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;pagespeed&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;FileCachePath&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"/var/cache/ngx_pagespeed/"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;pagespeed&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;EnableFilters&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;combine_css,combine_javascript,remove_comments,collapse_whitespace&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# ...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The three filters that are enabled do the following:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;combines &lt;span class="caps"&gt;CSS&lt;/span&gt; &amp;lt;style&amp;gt; elements in to one,&lt;/li&gt;
&lt;li&gt;combines multiple &amp;lt;script&amp;gt; elements in to one,&lt;/li&gt;
&lt;li&gt;removes all comments from &lt;span class="caps"&gt;HTML&lt;/span&gt; and,&lt;/li&gt;
&lt;li&gt;removes additional whitespace from &lt;span class="caps"&gt;HTML&lt;/span&gt; excluding &amp;lt;pre&amp;gt;, &amp;lt;script&amp;gt;, &amp;lt;style&amp;gt; and &amp;lt;textarea&amp;gt; elements.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can test this by simply viewing the source code of your
website and seeing all of the &lt;span class="caps"&gt;HTML&lt;/span&gt; compressed.&lt;/p&gt;
&lt;p&gt;You can find &lt;a class="reference external" href="https://developers.google.com/speed/pagespeed/module/config_filters"&gt;more information on filters here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="ubuntu"></category><category term="nginx"></category><category term="spdy"></category><category term="pagespeed"></category><category term="ngx_pagespeed"></category><category term="mod_pagespeed"></category></entry><entry><title>Bash portforwarding with autocompletion</title><link href="https://kura.gg/2013/03/12/bash-portforwarding-with-autocompletion/" rel="alternate"></link><published>2013-03-12T18:00:00+00:00</published><updated>2013-03-12T18:00:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2013-03-12:/2013/03/12/bash-portforwarding-with-autocompletion/</id><content type="html">
&lt;p&gt;I spend a &lt;span class="caps"&gt;LOT&lt;/span&gt; of time with tunnels open to multiple machines, connecting
directly to PostgreSQL, RabbitMQ and many other services all via &lt;span class="caps"&gt;SSH&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;I have written several helper functions and this is the final version
that I created in a small competition with &lt;a class="reference external" href="https://twitter.com/codeinthehole"&gt;@codeinthehole.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Gist removed. Sorry.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;Simply add the contents to &lt;em&gt;~/.bashrc&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="usage"&gt;
&lt;h2&gt;Usage&lt;/h2&gt;
&lt;p&gt;Usage is pretty simply, just called portforward from the command line,
pressing &amp;lt;&lt;span class="caps"&gt;TAB&lt;/span&gt;&amp;gt; as you type in a server name from your ~/.ssh/config file
and the same with the port.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;portforward&lt;span class="w"&gt; &lt;/span&gt;sy&amp;lt;TAB&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Will become:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;portforward&lt;span class="w"&gt; &lt;/span&gt;syslog.tv
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;portforward&lt;span class="w"&gt; &lt;/span&gt;syslog.tv&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;15672&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="autocompletion"></category><category term="bash"></category><category term="port forwarding"></category></entry><entry><title>Unbanning an IP, multiple IPs or a block of IPs from DenyHost</title><link href="https://kura.gg/2012/11/13/unbanning-an-ip-a-block-of-ips-or-a-block-of-ips-from-denyhost/" rel="alternate"></link><published>2012-11-13T17:45:00+00:00</published><updated>2012-11-13T17:45:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2012-11-13:/2012/11/13/unbanning-an-ip-a-block-of-ips-or-a-block-of-ips-from-denyhost/</id><summary type="html">&lt;p&gt;I wrote this little Python program a while ago and now people are
starting to email me about it, asking for it to be part of the DenyHosts
Debian packages so I figured I’d write a quick article on it.&lt;/p&gt;
&lt;p&gt;If you’re like my developers, you’ll find yourself getting banned from
servers all the time and have to come speak to someone like me (your sys
engineer/admin), or maybe you are an admin and are sick of people
banning themselves and want and easy way to unban them.&lt;/p&gt;
&lt;p&gt;So give this a try:&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/kura/denyhosts-unban"&gt;https://github.com/kura/denyhosts-unban&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;From the GitHub page you can download either the tarballs, zipballs or a
Debian .deb package. Install it using the instructions in the &lt;span class="caps"&gt;README&lt;/span&gt; and
you’re good to go.&lt;/p&gt;
&lt;div class="section" id="unban"&gt;
&lt;h2&gt;Unban&lt;/h2&gt;
&lt;p&gt;Unbanning is simple, you can either unban a single &lt;span class="caps"&gt;IP&lt;/span&gt; using:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;denyhosts-unban&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.0.1 …&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;I wrote this little Python program a while ago and now people are
starting to email me about it, asking for it to be part of the DenyHosts
Debian packages so I figured I’d write a quick article on it.&lt;/p&gt;
&lt;p&gt;If you’re like my developers, you’ll find yourself getting banned from
servers all the time and have to come speak to someone like me (your sys
engineer/admin), or maybe you are an admin and are sick of people
banning themselves and want and easy way to unban them.&lt;/p&gt;
&lt;p&gt;So give this a try:&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="https://github.com/kura/denyhosts-unban"&gt;https://github.com/kura/denyhosts-unban&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;From the GitHub page you can download either the tarballs, zipballs or a
Debian .deb package. Install it using the instructions in the &lt;span class="caps"&gt;README&lt;/span&gt; and
you’re good to go.&lt;/p&gt;
&lt;div class="section" id="unban"&gt;
&lt;h2&gt;Unban&lt;/h2&gt;
&lt;p&gt;Unbanning is simple, you can either unban a single &lt;span class="caps"&gt;IP&lt;/span&gt; using:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;denyhosts-unban&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.0.1
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Or multiples using:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;denyhosts-unban&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.0.1&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.0.2
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Or, you can use a bashism to unban an entire range:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;denyhosts-unban&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;.0.0.&lt;span class="o"&gt;{&lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;..255&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="denyhosts"></category><category term="unban"></category></entry><entry><title>Java 6 on Ubuntu 12.04 (including Tomcat 6)</title><link href="https://kura.gg/2012/11/08/java-6-on-ubuntu-12-04-including-tomcat-6/" rel="alternate"></link><published>2012-11-08T11:47:00+00:00</published><updated>2012-11-08T11:47:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2012-11-08:/2012/11/08/java-6-on-ubuntu-12-04-including-tomcat-6/</id><summary type="html">
&lt;p&gt;If like me you run in to issue when using OpenJDK, my issues come from
it’s memory problems when you’re allocating and using large amounts of
memory - mostly for Solr where we’re concerned but obviously I’d switch
for other high memory usage instances too.&lt;/p&gt;
&lt;p&gt;So without further ado, lets get the installation going.&lt;/p&gt;
&lt;p&gt;You’ll need Debian’s “add-apt-repository”, on servers this doesn’t
usually come by default so we’ll need to install it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;python-software-properties
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we need to add Java’s &lt;span class="caps"&gt;PPA&lt;/span&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;add-apt-repository&lt;span class="w"&gt; &lt;/span&gt;ppa:sun-java-community-team/sun-java6
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once this is done we’ll need to update our apt caches and install Java 6.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;sun-java6-jdk
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that this is installed we should get the Java version, remember it
for future.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;java&lt;span class="w"&gt; &lt;/span&gt;-version
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll get something like this&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;java&lt;span class="w"&gt; &lt;/span&gt;version&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"1.6.0_20"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;OpenJDK&lt;span class="w"&gt; &lt;/span&gt;Runtime&lt;span class="w"&gt; &lt;/span&gt;Environment&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;IcedTea6&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.9 …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;If like me you run in to issue when using OpenJDK, my issues come from
it’s memory problems when you’re allocating and using large amounts of
memory - mostly for Solr where we’re concerned but obviously I’d switch
for other high memory usage instances too.&lt;/p&gt;
&lt;p&gt;So without further ado, lets get the installation going.&lt;/p&gt;
&lt;p&gt;You’ll need Debian’s “add-apt-repository”, on servers this doesn’t
usually come by default so we’ll need to install it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;python-software-properties
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we need to add Java’s &lt;span class="caps"&gt;PPA&lt;/span&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;add-apt-repository&lt;span class="w"&gt; &lt;/span&gt;ppa:sun-java-community-team/sun-java6
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once this is done we’ll need to update our apt caches and install Java 6.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;sun-java6-jdk
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that this is installed we should get the Java version, remember it
for future.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;java&lt;span class="w"&gt; &lt;/span&gt;-version
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll get something like this&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;java&lt;span class="w"&gt; &lt;/span&gt;version&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"1.6.0_20"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;OpenJDK&lt;span class="w"&gt; &lt;/span&gt;Runtime&lt;span class="w"&gt; &lt;/span&gt;Environment&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;IcedTea6&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.9.9&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;6b20-1.9.9-0ubuntu1~10.04.2&lt;span class="o"&gt;)&lt;/span&gt;
OpenJDK&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;64&lt;/span&gt;-Bit&lt;span class="w"&gt; &lt;/span&gt;Server&lt;span class="w"&gt; &lt;/span&gt;VM&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;build&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;19&lt;/span&gt;.0-b09,&lt;span class="w"&gt; &lt;/span&gt;mixed&lt;span class="w"&gt; &lt;/span&gt;mode&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we update our alternatives to switch OpenJDK with Sun’s Java.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;update-java-alternatives&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;java-6-sun
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally we’ll confirm the change is made by comparing the new Java
version against the one from before&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;java&lt;span class="w"&gt; &lt;/span&gt;-version
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see something similar to this.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;java&lt;span class="w"&gt; &lt;/span&gt;version&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"1.6.0_21"&lt;/span&gt;
Java&lt;span class="o"&gt;(&lt;/span&gt;TM&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;SE&lt;span class="w"&gt; &lt;/span&gt;Runtime&lt;span class="w"&gt; &lt;/span&gt;Environment&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;build&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.6.0_21-b06&lt;span class="o"&gt;)&lt;/span&gt;
Java&lt;span class="w"&gt; &lt;/span&gt;HotSpot&lt;span class="o"&gt;(&lt;/span&gt;TM&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;64&lt;/span&gt;-Bit&lt;span class="w"&gt; &lt;/span&gt;Server&lt;span class="w"&gt; &lt;/span&gt;VM&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;(&lt;/span&gt;build&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;17&lt;/span&gt;.0-b16,&lt;span class="w"&gt; &lt;/span&gt;mixed&lt;span class="w"&gt; &lt;/span&gt;mode&lt;span class="o"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="tomcat-6"&gt;
&lt;h2&gt;Tomcat 6&lt;/h2&gt;
&lt;p&gt;To make Tomcat use this version of Java we’ll need to change JAVA_HOME.&lt;/p&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/default/tomcat6&lt;/strong&gt; for editing, you’ll need to open this
using sudo or as root.&lt;/p&gt;
&lt;p&gt;Scroll down, you’ll see JAVA_HOME is set, it may be commented out so
edit it to look like the line below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;JAVA_HOME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;/usr/lib/jvm/java-6-sun
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And restart Tomcat.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/tomcat6&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category></entry><entry><title>How to generate an /etc/shadow compatible password</title><link href="https://kura.gg/2012/10/11/how-to-generate-an-etcshadow-compatible-password/" rel="alternate"></link><published>2012-10-11T09:56:00+01:00</published><updated>2012-10-11T09:56:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2012-10-11:/2012/10/11/how-to-generate-an-etcshadow-compatible-password/</id><content type="html">&lt;p&gt;You’ll need mkpasswd, on Debian 6 and Ubuntu 12.04 you can install this using:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;whois
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It is pretty weird that it comes with the whois package though…&lt;/p&gt;
&lt;p&gt;And then run&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkpasswd&lt;span class="w"&gt; &lt;/span&gt;-m&lt;span class="w"&gt; &lt;/span&gt;sha-512
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="/etc/shadow"></category><category term="mkpasswd"></category><category term="password"></category><category term="sha-512"></category><category term="sha512"></category></entry><entry><title>Send all email to a blackhole (never gets delivered), test delivery speed and much more using blackhole.io</title><link href="https://kura.gg/2012/06/26/send-all-email-to-a-blackhole-never-gets-delivered-test-delivery-speed-and-much-more-using-blackhole-io/" rel="alternate"></link><published>2012-06-26T23:05:00+01:00</published><updated>2012-06-26T23:05:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2012-06-26:/2012/06/26/send-all-email-to-a-blackhole-never-gets-delivered-test-delivery-speed-and-much-more-using-blackhole-io/</id><summary type="html">
&lt;p&gt;I have built and released an open-source email server in the past for
testing send rates and speeds, this project was called SimpleMTA and is
available &lt;a class="reference external" href="https://syslog.tv/simplemta/"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Recently I have rebuilt this project for an internal project at work
using the &lt;a class="reference external" href="https://www.tornadoweb.org/"&gt;Tornado framework&lt;/a&gt;. Sadly this project as a whole cannot be
released but a version of this code will be released in the near future.&lt;/p&gt;
&lt;p&gt;Until that is released I have launched a new service called
&lt;a class="reference external" href="https://blackhole.io"&gt;blackhole.io&lt;/a&gt;&lt;/p&gt;
&lt;div class="section" id="what-is-blackhole-io"&gt;
&lt;h2&gt;What is blackhole.io?&lt;/h2&gt;
&lt;p&gt;blackhole.io is a completely open mail relay that forgets anything that
is sent to it, meaning there is no auth requirements and no storage of
email data within the service. Literally anyone can send anything to it
and have it never get delivered.&lt;/p&gt;
&lt;p&gt;You can even send commands out of order, meaning you can call the &lt;span class="caps"&gt;DATA&lt;/span&gt;
command without ever using &lt;span class="caps"&gt;HELO&lt;/span&gt;, &lt;span class="caps"&gt;MAIL&lt;/span&gt; &lt;span class="caps"&gt;FROM&lt;/span&gt; or &lt;span class="caps"&gt;RCPT&lt;/span&gt; &lt;span class="caps"&gt;TO …&lt;/span&gt;&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I have built and released an open-source email server in the past for
testing send rates and speeds, this project was called SimpleMTA and is
available &lt;a class="reference external" href="https://syslog.tv/simplemta/"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Recently I have rebuilt this project for an internal project at work
using the &lt;a class="reference external" href="https://www.tornadoweb.org/"&gt;Tornado framework&lt;/a&gt;. Sadly this project as a whole cannot be
released but a version of this code will be released in the near future.&lt;/p&gt;
&lt;p&gt;Until that is released I have launched a new service called
&lt;a class="reference external" href="https://blackhole.io"&gt;blackhole.io&lt;/a&gt;&lt;/p&gt;
&lt;div class="section" id="what-is-blackhole-io"&gt;
&lt;h2&gt;What is blackhole.io?&lt;/h2&gt;
&lt;p&gt;blackhole.io is a completely open mail relay that forgets anything that
is sent to it, meaning there is no auth requirements and no storage of
email data within the service. Literally anyone can send anything to it
and have it never get delivered.&lt;/p&gt;
&lt;p&gt;You can even send commands out of order, meaning you can call the &lt;span class="caps"&gt;DATA&lt;/span&gt;
command without ever using &lt;span class="caps"&gt;HELO&lt;/span&gt;, &lt;span class="caps"&gt;MAIL&lt;/span&gt; &lt;span class="caps"&gt;FROM&lt;/span&gt; or &lt;span class="caps"&gt;RCPT&lt;/span&gt; &lt;span class="caps"&gt;TO&lt;/span&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="what-can-i-use-it-for"&gt;
&lt;h2&gt;What can I use it for?&lt;/h2&gt;
&lt;p&gt;Honestly, anything. I have spoken to a few people and have come up with
a few use cases but I’m sure there will be more:&lt;/p&gt;
&lt;div class="section" id="you-want-to-work-on-production-data-but-do-not-want-to-accidentally-send-an-email-to-real-users"&gt;
&lt;h3&gt;1. You want to work on production data but do not want to accidentally send an email to real users&lt;/h3&gt;
&lt;p&gt;This is bit of a nasty situation to be in but, it happens every so
often. Sure, you can spend time anonymising all of your user data (and
that is the best thing to do), but sometimes you don’t have time or you
cannot be 100% sure that you have got it all.&lt;/p&gt;
&lt;p&gt;If you application is written in such a way that changing it’s &lt;span class="caps"&gt;SMTP&lt;/span&gt;
settings will work across the whole application then you can simply
point the &lt;span class="caps"&gt;SMTP&lt;/span&gt; host to “blackhole.io” and ensure that any outgoing
emails will go to the blackhole and thus, never reach real people.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="testing-the-speed-of-your-email-sends"&gt;
&lt;h3&gt;2. Testing the speed of your email sends&lt;/h3&gt;
&lt;p&gt;Maybe you’re writing your own mail platform and want to see how fast you
can really send email. blackhole.io is a very fast server and, because
it does no real validation and has no data storage it has an extremely
low &lt;span class="caps"&gt;CPU&lt;/span&gt; and memory footprint. You can fire a vast amount of mail at it
and it should not feel it in the slightest.&lt;/p&gt;
&lt;p&gt;I have managed to send over 150,000 emails within an 10 minute period
and it didn’t feel any stress.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="integration-tests"&gt;
&lt;h3&gt;3. Integration tests&lt;/h3&gt;
&lt;p&gt;This one was pointed out by a colleague of mine - you have a system,
you’ve done your basic testing and unit testing but you want to test
integration. blackhole.io allows you to do this, you can send all of
your test email data at the service to test your &lt;span class="caps"&gt;SMTP&lt;/span&gt; outbound connections.&lt;/p&gt;
&lt;p&gt;In a future release of blackhole.io you will be able to create a free
account and set-up logging of mail, allowing you to log the from address
and subject line and possibly some custom header data, but this feature
is not available currently.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="outro"&gt;
&lt;h2&gt;Outro&lt;/h2&gt;
&lt;p&gt;I hope some people will find this service useful, let me know if you use
it and what you think of it.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="blackhole"></category><category term="blackhole.io"></category><category term="email"></category><category term="mail"></category></entry><entry><title>Mount Amazon S3 bucket locally on Debian 5 &amp; 6/Ubuntu 10.04</title><link href="https://kura.gg/2012/03/03/mount-amazon-s3-bucket-locally/" rel="alternate"></link><published>2012-03-03T16:05:00+00:00</published><updated>2012-03-03T16:05:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2012-03-03:/2012/03/03/mount-amazon-s3-bucket-locally/</id><summary type="html">
&lt;p&gt;I’ve recently been toying with my &lt;a class="reference external" href="https://rpi.syslog.tv/"&gt;Raspberry Pi mirror&lt;/a&gt; including
moving it out on to Amazon’s S3. I’ve written an article on &lt;a class="reference external" href="https://syslog.tv/2012/02/29/backup-a-linux-server-to-amazon-s3-on-debian-6ubuntu-10-04/"&gt;how to back
up to S3&lt;/a&gt;, but that isn’t enough when it comes to serving data
from S3.&lt;/p&gt;
&lt;p&gt;I needed the ability to &lt;span class="caps"&gt;RSYNC&lt;/span&gt; data from the official Raspberry Pi
servers on to mine and then in to S3 and for that I used &lt;a class="reference external" href="https://code.google.com/p/s3fs/"&gt;s3fs&lt;/a&gt; and
&lt;a class="reference external" href="https://fuse.sourceforge.net/"&gt;&lt;span class="caps"&gt;FUSE&lt;/span&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="fuse-1"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;FUSE&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;You can actually do this successfully without requiring &lt;span class="caps"&gt;FUSE&lt;/span&gt;, just by
installing the s3fs binary on to your system, but this only allows the
user who mounted to access the mounted bucket and also is not possible
via /etc/fstab.&lt;/p&gt;
&lt;p&gt;&lt;span class="caps"&gt;FUSE&lt;/span&gt; allows you to implement a filesystem within a userspace program,
thus allowing us to give other users access and auto-mount using /etc/fstab.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="section" id="fuse-2"&gt;
&lt;h3&gt;Fuse&lt;/h3&gt;
&lt;p&gt;Installing &lt;span class="caps"&gt;FUSE&lt;/span&gt; is simple&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;fuse-utils
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="s3fs-1"&gt;
&lt;h3&gt;s3fs&lt;/h3&gt;
&lt;p&gt;We …&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I’ve recently been toying with my &lt;a class="reference external" href="https://rpi.syslog.tv/"&gt;Raspberry Pi mirror&lt;/a&gt; including
moving it out on to Amazon’s S3. I’ve written an article on &lt;a class="reference external" href="https://syslog.tv/2012/02/29/backup-a-linux-server-to-amazon-s3-on-debian-6ubuntu-10-04/"&gt;how to back
up to S3&lt;/a&gt;, but that isn’t enough when it comes to serving data
from S3.&lt;/p&gt;
&lt;p&gt;I needed the ability to &lt;span class="caps"&gt;RSYNC&lt;/span&gt; data from the official Raspberry Pi
servers on to mine and then in to S3 and for that I used &lt;a class="reference external" href="https://code.google.com/p/s3fs/"&gt;s3fs&lt;/a&gt; and
&lt;a class="reference external" href="https://fuse.sourceforge.net/"&gt;&lt;span class="caps"&gt;FUSE&lt;/span&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="fuse-1"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;FUSE&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;You can actually do this successfully without requiring &lt;span class="caps"&gt;FUSE&lt;/span&gt;, just by
installing the s3fs binary on to your system, but this only allows the
user who mounted to access the mounted bucket and also is not possible
via /etc/fstab.&lt;/p&gt;
&lt;p&gt;&lt;span class="caps"&gt;FUSE&lt;/span&gt; allows you to implement a filesystem within a userspace program,
thus allowing us to give other users access and auto-mount using /etc/fstab.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="section" id="fuse-2"&gt;
&lt;h3&gt;Fuse&lt;/h3&gt;
&lt;p&gt;Installing &lt;span class="caps"&gt;FUSE&lt;/span&gt; is simple&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;fuse-utils
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="s3fs-1"&gt;
&lt;h3&gt;s3fs&lt;/h3&gt;
&lt;p&gt;We’ll need to get build-essential, pkg-config, libfuse-dev,
libcurl4-openssl-dev and libxml2-dev to be able to compile s3fs&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;build-essential&lt;span class="w"&gt; &lt;/span&gt;pkg-config&lt;span class="w"&gt; &lt;/span&gt;libfuse-dev&lt;span class="w"&gt; &lt;/span&gt;libcurl4-openssl-dev&lt;span class="w"&gt; &lt;/span&gt;libxml2-dev
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="debian-5-ubuntu-10-04"&gt;
&lt;h4&gt;Debian 5 &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; Ubuntu 10.04&lt;/h4&gt;
&lt;p&gt;If installing either Debian 5 or Ubuntu 10.04, you’ll need to install a
newer version of fuse than is packaged, I found this info on the &lt;a class="reference external" href="https://code.google.com/p/s3fs/issues/detail?id=143#c2"&gt;s3fs
issue tracker&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;First we need to remove the install fuse-utils and libfuse-dev that we
install above.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;purge&lt;span class="w"&gt; &lt;/span&gt;fuse-utils&lt;span class="w"&gt; &lt;/span&gt;libfuse-dev
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You’ll need to export a variable with your arch, i.e&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;export&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;PLATFORM&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;amd64
wget&lt;span class="w"&gt; &lt;/span&gt;https://ftp.us.debian.org/debian/pool/main/f/fuse/libfuse2_2.8.4-1.1_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;PLATFORM&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.deb
wget&lt;span class="w"&gt; &lt;/span&gt;https://ftp.us.debian.org/debian/pool/main/f/fuse/libfuse-dev_2.8.4-1.1_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;PLATFORM&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.deb
wget&lt;span class="w"&gt; &lt;/span&gt;https://ftp.us.debian.org/debian/pool/main/f/fuse/fuse-utils_2.8.4-1.1_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;PLATFORM&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.deb
sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;libfuse2_2.8.4-1.1_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;PLATFORM&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.deb&lt;span class="w"&gt; &lt;/span&gt;libfuse-dev_2.8.4-1.1_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;PLATFORM&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.deb&lt;span class="w"&gt; &lt;/span&gt;fuse-utils_2.8.4-1.1_&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;PLATFORM&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;.deb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Fix missing dependencies&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;install
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now run the command below and confirm the output&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pkg-config&lt;span class="w"&gt; &lt;/span&gt;--modversion&lt;span class="w"&gt; &lt;/span&gt;fuse
&lt;span class="m"&gt;2&lt;/span&gt;.8.4
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;s3fs has to be done manually, first off go download the latest revision
archive from &lt;a class="reference external" href="https://code.google.com/p/s3fs/downloads/list"&gt;Google code&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Once download, gunzip and untar it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;tar&lt;span class="w"&gt; &lt;/span&gt;xvzf&lt;span class="w"&gt; &lt;/span&gt;s3fs-x.xx.tar.gz
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Change directory in to your newly extracted archive, and configure.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;./configure&lt;span class="w"&gt; &lt;/span&gt;--exec-prefix&lt;span class="o"&gt;=&lt;/span&gt;/usr/&lt;span class="w"&gt; &lt;/span&gt;--prefix&lt;span class="o"&gt;=&lt;/span&gt;/&lt;span class="w"&gt; &lt;/span&gt;--includedir&lt;span class="o"&gt;=&lt;/span&gt;/usr/include/&lt;span class="w"&gt; &lt;/span&gt;--mandir&lt;span class="o"&gt;=&lt;/span&gt;/usr/share/man/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This configure command will install the s3fs binary in to /usr/bin and
man pages in to /usr/share/man/ which is Debian and Ubuntu correct locations.&lt;/p&gt;
&lt;p&gt;Then you’ll need to compile and install.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;make
sudo&lt;span class="w"&gt; &lt;/span&gt;make&lt;span class="w"&gt; &lt;/span&gt;install
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;You’ll noticed I only run make install as sudo/root, because the other
commands do not require it and you should never compile as root.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configure-s3fs"&gt;
&lt;h2&gt;Configure s3fs&lt;/h2&gt;
&lt;p&gt;The only configuration you need to do for s3fs is store your S3
credential which you can get &lt;a class="reference external" href="https://aws-portal.amazon.com/gp/aws/securityCredentials"&gt;the Amazon website&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Create a file called &lt;strong&gt;/etc/passwd-s3fs&lt;/strong&gt; - &lt;strong&gt;&lt;span class="caps"&gt;MAKE&lt;/span&gt; &lt;span class="caps"&gt;SURE&lt;/span&gt; &lt;span class="caps"&gt;YOU&lt;/span&gt; &lt;span class="caps"&gt;DON&lt;/span&gt;’T &lt;span class="caps"&gt;BREAK&lt;/span&gt; /etc/passwd&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;In it you need to put your access key &lt;span class="caps"&gt;ID&lt;/span&gt; and secret access key,
separated with a colon.&lt;/p&gt;
&lt;blockquote&gt;
ACCESS_KEY_ID:SECRET_ACCESS_KEY&lt;/blockquote&gt;
&lt;p&gt;And for security reasons, change the file permissions&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chmod&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0600&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/passwd-s3fs
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mounting"&gt;
&lt;h2&gt;Mounting&lt;/h2&gt;
&lt;div class="section" id="manual"&gt;
&lt;h3&gt;Manual&lt;/h3&gt;
&lt;p&gt;Once all the above is done you can mount a bucket using the s3fs binary,
I’m going to mount directly to /mnt&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;s3fs&lt;span class="w"&gt; &lt;/span&gt;your-bucket-name&lt;span class="w"&gt; &lt;/span&gt;/mnt
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will mount it and make it usable for your user.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="fstab"&gt;
&lt;h3&gt;fstab&lt;/h3&gt;
&lt;p&gt;Mounting via fstab requires the above &lt;span class="caps"&gt;FUSE&lt;/span&gt; step to be completed.&lt;/p&gt;
&lt;p&gt;Your &lt;strong&gt;/etc/fstab&lt;/strong&gt; entry should look like this&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;s3fs#your-bucket-name&lt;span class="w"&gt; &lt;/span&gt;/mnt&lt;span class="w"&gt; &lt;/span&gt;fuse&lt;span class="w"&gt; &lt;/span&gt;allow_other,_netdev,nosuid,nodev,url&lt;span class="o"&gt;=&lt;/span&gt;https://s3.amazonaws.com&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A brief description of the mount arguments;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;strong&gt;allow_other&lt;/strong&gt; - allow all users to access the mount point,&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;_netdev&lt;/strong&gt; - The filesystem resides on a device that requires
network access,&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;nosuid&lt;/strong&gt; - Do not allow set-user-identifier or set-group-identifier
bits to take effect,&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;nodev&lt;/strong&gt; - Do not interpret character or block special devices on
the file system and&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;url&lt;/strong&gt; - Use &lt;span class="caps"&gt;HTTPS&lt;/span&gt; instead of &lt;span class="caps"&gt;HTTP&lt;/span&gt; when configure as above&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="aws"></category><category term="fstab"></category><category term="fuse"></category><category term="mount"></category><category term="s3"></category><category term="s3fs"></category></entry><entry><title>Visualised: 24 hours of SSH attacks against a single server</title><link href="https://kura.gg/2012/03/02/visualised-24-hours-of-ssh-attacks-against-a-single-server/" rel="alternate"></link><published>2012-03-02T18:36:00+00:00</published><updated>2012-03-02T18:36:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2012-03-02:/2012/03/02/visualised-24-hours-of-ssh-attacks-against-a-single-server/</id><content type="html">&lt;p&gt;24 hours of &lt;span class="caps"&gt;SSH&lt;/span&gt; attacks against a single server, visualised on a world
map using Python.&lt;/p&gt;
&lt;p&gt;When a country stays lit up for more than 1 tick of the clock in the
left hand corner it means that multiple attacks are happening from
different &lt;span class="caps"&gt;IP&lt;/span&gt; addresses. An attacker is banned after;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;1 failed root login,&lt;/li&gt;
&lt;li&gt;3 failed user logins (including invalid users) and&lt;/li&gt;
&lt;li&gt;3 failed system logins.&lt;/li&gt;
&lt;/ul&gt;
&lt;div align="center" class="vimeo"&gt;&lt;iframe allowfullscreen="" frameborder="0" height="500" mozallowfullscreen="" src="https://player.vimeo.com/video/37818131" webkitallowfullscreen="" width="800"&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;div class="section" id="direct-links"&gt;
&lt;h2&gt;Direct links&lt;/h2&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://vimeo.com/37818131"&gt;Vimeo&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.youtube.com/watch?v=S_p0G2oLuDU"&gt;YouTube&lt;/a&gt; - older version of the video with yellow colouring instead of red.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="misc"></category><category term="bruteforce"></category><category term="ssh"></category></entry><entry><title>Backup a Linux server to Amazon S3 on Debian 6/Ubuntu 10.04</title><link href="https://kura.gg/2012/02/29/backup-a-linux-server-to-amazon-s3-on-debian-6ubuntu-10-04/" rel="alternate"></link><published>2012-02-29T20:55:00+00:00</published><updated>2012-02-29T20:55:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2012-02-29:/2012/02/29/backup-a-linux-server-to-amazon-s3-on-debian-6ubuntu-10-04/</id><summary type="html">
&lt;p&gt;I have several servers powering syslog including it’s &lt;a class="reference external" href="https://rpi.syslog.tv/"&gt;Raspberry Pi&lt;/a&gt;
mirror, load balancer and email servers. All of my servers are hosted
using &lt;a class="reference external" href="https://www.linode.com/?r=8d58820f89940a1a68832c0cdd53109727cfa622"&gt;Linode&lt;/a&gt; in their London data centre and have Linode’s back-up
system doing both daily and weekly snapshots.&lt;/p&gt;
&lt;p&gt;For the app and database servers I do server-side backups storing each
website and it’s database in it’s own folder within /backup in case I
require a quick back-up to fix something, rather than the server has died.&lt;/p&gt;
&lt;p&gt;This is all well and good but I like having an off-site backup too and
for that I use &lt;a class="reference external" href="https://aws.amazon.com/s3/"&gt;S3&lt;/a&gt;…&lt;/p&gt;
&lt;div class="section" id="about-s3"&gt;
&lt;h2&gt;About S3&lt;/h2&gt;
&lt;p&gt;Amazon’s S3 is pretty cheap and very easy to use. Because only data is
going in you don’t pay a transfer fee and the cost of storage is very
affordable, you can see a &lt;a class="reference external" href="https://aws.amazon.com/s3/#pricing"&gt;pricing list here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To do the backup I use a …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I have several servers powering syslog including it’s &lt;a class="reference external" href="https://rpi.syslog.tv/"&gt;Raspberry Pi&lt;/a&gt;
mirror, load balancer and email servers. All of my servers are hosted
using &lt;a class="reference external" href="https://www.linode.com/?r=8d58820f89940a1a68832c0cdd53109727cfa622"&gt;Linode&lt;/a&gt; in their London data centre and have Linode’s back-up
system doing both daily and weekly snapshots.&lt;/p&gt;
&lt;p&gt;For the app and database servers I do server-side backups storing each
website and it’s database in it’s own folder within /backup in case I
require a quick back-up to fix something, rather than the server has died.&lt;/p&gt;
&lt;p&gt;This is all well and good but I like having an off-site backup too and
for that I use &lt;a class="reference external" href="https://aws.amazon.com/s3/"&gt;S3&lt;/a&gt;…&lt;/p&gt;
&lt;div class="section" id="about-s3"&gt;
&lt;h2&gt;About S3&lt;/h2&gt;
&lt;p&gt;Amazon’s S3 is pretty cheap and very easy to use. Because only data is
going in you don’t pay a transfer fee and the cost of storage is very
affordable, you can see a &lt;a class="reference external" href="https://aws.amazon.com/s3/#pricing"&gt;pricing list here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To do the backup I use a daily cron job which then uploads the data to
S3 using &lt;a class="reference external" href="https://s3tools.org/s3cmd"&gt;s3cmd&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;Download the S3 tools package list in to apt&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;-O-&lt;span class="w"&gt; &lt;/span&gt;-q&lt;span class="w"&gt; &lt;/span&gt;https://s3tools.org/repo/deb-all/stable/s3tools.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-key&lt;span class="w"&gt; &lt;/span&gt;add&lt;span class="w"&gt; &lt;/span&gt;-
sudo&lt;span class="w"&gt; &lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;https://s3tools.org/repo/deb-all/stable/s3tools.list&lt;span class="w"&gt; &lt;/span&gt;-O&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/sources.list.d/s3tools.list
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Update your package list and install s3cmd&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;update&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;s3cmd
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;You’ll need to configure the tool to work with your &lt;span class="caps"&gt;AWS&lt;/span&gt; account, so run&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;s3cmd&lt;span class="w"&gt; &lt;/span&gt;--configure
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;When prompted, fill in your access and secret key which you can find
&lt;a class="reference external" href="https://aws-portal.amazon.com/gp/aws/securityCredentials"&gt;on the Amazone website&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;When asked to provide an encryption password, I choose yes but you can
say no.&lt;/p&gt;
&lt;p&gt;When asking if you want to use &lt;span class="caps"&gt;HTTPS&lt;/span&gt;, I choose yes but again, you can
say no, it really depends on how secure you want the data transfer.&lt;/p&gt;
&lt;p&gt;I would suggest using an encryption password and enabling &lt;span class="caps"&gt;HTTPS&lt;/span&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="using-s3cmd"&gt;
&lt;h2&gt;Using s3cmd&lt;/h2&gt;
&lt;p&gt;Now that s3cmd is installed and configured you can use it.&lt;/p&gt;
&lt;p&gt;You can create a bucket using the s3cmd command below, but as far as I
know you can’t select a location so I create my buckets manually
&lt;a class="reference external" href="https://console.aws.amazon.com/s3/home"&gt;on the web interface&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;s3cmd&lt;span class="w"&gt; &lt;/span&gt;mb&lt;span class="w"&gt; &lt;/span&gt;s3://your-bucket-name
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once done you can see a list of available buckets with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;s3cmd&lt;span class="w"&gt; &lt;/span&gt;ls
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As shown below&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;s3cmd&lt;span class="w"&gt; &lt;/span&gt;ls

&lt;span class="m"&gt;2012&lt;/span&gt;-02-29&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;20&lt;/span&gt;:28&lt;span class="w"&gt; &lt;/span&gt;s3://kura-linode-test
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that this is done we can put some data in there, create a test file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"this is a test"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;test.file
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And put it in S3&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;s3cmd&lt;span class="w"&gt; &lt;/span&gt;put&lt;span class="w"&gt; &lt;/span&gt;test.file&lt;span class="w"&gt; &lt;/span&gt;s3://your-bucket-name/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can see it using&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;s3cmd&lt;span class="w"&gt; &lt;/span&gt;ls&lt;span class="w"&gt; &lt;/span&gt;s3://your-bucket-name
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Download it with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;s3cmd&lt;span class="w"&gt; &lt;/span&gt;get&lt;span class="w"&gt; &lt;/span&gt;s3://your-bucket-name/test.file
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And delete it with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;s3cmd&lt;span class="w"&gt; &lt;/span&gt;del&lt;span class="w"&gt; &lt;/span&gt;s3://your-bucket-name/test.file
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once satisfied with this you can create a shell script to automate some
backups for you, I’ll provide a simple one below that uploads my home directory.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="example"&gt;
&lt;h2&gt;Example&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/sh&lt;/span&gt;
s3cmd&lt;span class="w"&gt; &lt;/span&gt;sync&lt;span class="w"&gt; &lt;/span&gt;--recursive&lt;span class="w"&gt; &lt;/span&gt;--skip-existing&lt;span class="w"&gt; &lt;/span&gt;/home/kura
s3://kura-linode-test/
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="amazon"></category><category term="aws"></category><category term="backup"></category><category term="debian"></category><category term="s3"></category><category term="ubuntu"></category></entry><entry><title>Automatic/Unattended updates on Debian 6 (Squeeze)</title><link href="https://kura.gg/2012/01/28/automaticunattended-updates-on-debian-6-squeeze/" rel="alternate"></link><published>2012-01-28T17:41:00+00:00</published><updated>2012-01-28T17:41:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2012-01-28:/2012/01/28/automaticunattended-updates-on-debian-6-squeeze/</id><summary type="html">
&lt;p&gt;The unattended-upgrades package used on Debian is based on the one from
Ubuntu. It is generally pretty safe in my opinion but I only ever enable
it for security upgrades.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;unattended-upgrades&lt;span class="w"&gt; &lt;/span&gt;apticron
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;unattended-upgrades&lt;/em&gt; handles the actual updates, &lt;em&gt;apticron&lt;/em&gt; is used for
emailing you of available updates - it is not required but I like it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-unattended-upgrades"&gt;
&lt;h2&gt;Configuring unattended-upgrades&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/apt/apt.conf.d/50unattended-upgrades&lt;/strong&gt; and change it to
the content below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
APT::Periodic::Enable "1";
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";
Unattended-Upgrade::Mail "**YOUR_EMAIL_HERE**";

// Automatically upgrade packages from these (origin, archive) pairs
Unattended-Upgrade::Allowed-Origins {
    "${distro_id} stable";
    "${distro_id} ${distro_codename}-security";
};

// Automatically reboot *WITHOUT CONFIRMATION* if a
 // the file /var/run/reboot-required is found after the upgrade
 Unattended-Upgrade::Automatic-Reboot "false";
&lt;/pre&gt;
&lt;p&gt;So lets explain the above. As you can see we enable periodic updates,
enable update package lists (triggers an apt-get update), enable
autoclean …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;The unattended-upgrades package used on Debian is based on the one from
Ubuntu. It is generally pretty safe in my opinion but I only ever enable
it for security upgrades.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;unattended-upgrades&lt;span class="w"&gt; &lt;/span&gt;apticron
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;em&gt;unattended-upgrades&lt;/em&gt; handles the actual updates, &lt;em&gt;apticron&lt;/em&gt; is used for
emailing you of available updates - it is not required but I like it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-unattended-upgrades"&gt;
&lt;h2&gt;Configuring unattended-upgrades&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/apt/apt.conf.d/50unattended-upgrades&lt;/strong&gt; and change it to
the content below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
APT::Periodic::Enable "1";
APT::Periodic::Update-Package-Lists "1";
APT::Periodic::AutocleanInterval "7";
APT::Periodic::Unattended-Upgrade "1";
Unattended-Upgrade::Mail "**YOUR_EMAIL_HERE**";

// Automatically upgrade packages from these (origin, archive) pairs
Unattended-Upgrade::Allowed-Origins {
    "${distro_id} stable";
    "${distro_id} ${distro_codename}-security";
};

// Automatically reboot *WITHOUT CONFIRMATION* if a
 // the file /var/run/reboot-required is found after the upgrade
 Unattended-Upgrade::Automatic-Reboot "false";
&lt;/pre&gt;
&lt;p&gt;So lets explain the above. As you can see we enable periodic updates,
enable update package lists (triggers an apt-get update), enable
autoclean to clean out the local package repository every 7 days, enable
the actual unattended update and finally you can set your email address
so that you will get an email when an update has happened.
Next up we configure the origins to update from, as you can see we’ve
only enabled security and as a very final step we make sure we’ve
disabled automatic reboots - you probably don’t want your server
randomly rebooting to update the running kernel, this means you will
have to reboot when convenient after a kernel update.&lt;/p&gt;
&lt;p&gt;Your unattended update will happen every day, triggered by
&lt;strong&gt;cron.daily&lt;/strong&gt;. Next time your cron.daily has triggered, look inside
&lt;strong&gt;/var/log/unattended-upgrades/unattended-upgrades.log&lt;/strong&gt;, you should see
something like this&lt;/p&gt;
&lt;pre class="literal-block"&gt;
2012-01-28 06:54:04,730 INFO Initial blacklisted packages:
2012-01-28 06:54:04,730 INFO Starting unattended upgrades script
2012-01-28 06:54:04,731 INFO Allowed origins are: ["('Debian','squeeze-security')"]
2012-01-28 06:54:05,952 INFO No packages found that can be upgraded unattended
&lt;/pre&gt;
&lt;p&gt;If you installed apticron in the above step and want to configure it and
use it then continue reading, if not then congratulations everything is done.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-apticron"&gt;
&lt;h2&gt;Configuring apticron&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/apticron/apticron.conf&lt;/strong&gt;, all you need to change is the
&lt;strong&gt;&lt;span class="caps"&gt;EMAIL&lt;/span&gt;&lt;/strong&gt; option.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
EMAIL="**YOUR_EMAIL_HERE**"
&lt;/pre&gt;
&lt;p&gt;Now each day you will receive an email when &lt;strong&gt;cron.daily&lt;/strong&gt; runs with all
available package updates.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="automatic update"></category><category term="debian"></category><category term="unattended-upgrades"></category><category term="update"></category></entry><entry><title>Running your own PGP keyserver with SKS on Debian 6/Ubuntu 10.04</title><link href="https://kura.gg/2011/12/17/running-your-own-pgp-keyserver-with-sks-on-debian-6ubuntu-10-04/" rel="alternate"></link><published>2011-12-17T15:58:00+00:00</published><updated>2011-12-17T15:58:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-12-17:/2011/12/17/running-your-own-pgp-keyserver-with-sks-on-debian-6ubuntu-10-04/</id><summary type="html">
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;To install we need to run the following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;-y&lt;span class="w"&gt; &lt;/span&gt;sks
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we build the key database:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sks&lt;span class="w"&gt; &lt;/span&gt;build
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And change the permissions for the sks user:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;-R&lt;span class="w"&gt; &lt;/span&gt;debian-sks:debian-sks&lt;span class="w"&gt; &lt;/span&gt;/var/lib/sks/DB
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we need to make sks start from init, open up &lt;strong&gt;/etc/default/sks&lt;/strong&gt;
in your favourite editor and &lt;strong&gt;*initstart*&lt;/strong&gt; to look like below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;initstart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;yes
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we can start the service with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/sks&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Your keyserver will now be up and running on port 11371.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="web-interface"&gt;
&lt;h2&gt;Web interface&lt;/h2&gt;
&lt;p&gt;We’ll need to create a web folder within sks with the following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;/var/lib/sks/www/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Change it’s permissions so the sks user can access it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;-R&lt;span class="w"&gt; &lt;/span&gt;debian-sks:debian-sks&lt;span class="w"&gt; &lt;/span&gt;/var/lib/sks/www
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally we need create a single &lt;span class="caps"&gt;HTML&lt;/span&gt; file for the interface, I have
provided that …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;To install we need to run the following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;-y&lt;span class="w"&gt; &lt;/span&gt;sks
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we build the key database:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sks&lt;span class="w"&gt; &lt;/span&gt;build
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And change the permissions for the sks user:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;-R&lt;span class="w"&gt; &lt;/span&gt;debian-sks:debian-sks&lt;span class="w"&gt; &lt;/span&gt;/var/lib/sks/DB
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we need to make sks start from init, open up &lt;strong&gt;/etc/default/sks&lt;/strong&gt;
in your favourite editor and &lt;strong&gt;*initstart*&lt;/strong&gt; to look like below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;initstart&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;yes
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we can start the service with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/sks&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Your keyserver will now be up and running on port 11371.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="web-interface"&gt;
&lt;h2&gt;Web interface&lt;/h2&gt;
&lt;p&gt;We’ll need to create a web folder within sks with the following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;/var/lib/sks/www/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Change it’s permissions so the sks user can access it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;-R&lt;span class="w"&gt; &lt;/span&gt;debian-sks:debian-sks&lt;span class="w"&gt; &lt;/span&gt;/var/lib/sks/www
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally we need create a single &lt;span class="caps"&gt;HTML&lt;/span&gt; file for the interface, I have
provided that too.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;/files/sks-index.html&lt;span class="w"&gt; &lt;/span&gt;-O&lt;span class="w"&gt; &lt;/span&gt;/var/lib/sks/www/index.html
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now your &lt;span class="caps"&gt;PGP&lt;/span&gt; server should be accessible from a web browser at
&lt;a class="reference external" href="https://YOUR_SERVER:11371/"&gt;https://YOUR_SERVER:11371/&lt;/a&gt; and it should look like mine
&lt;a class="reference external" href="https://syslog.tv/"&gt;:11371/&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="keyserver"></category><category term="pgp"></category><category term="sks"></category><category term="ubuntu"></category></entry><entry><title>Host git repositories with git, gitosis and gitweb on Debian 6/Ubuntu 10.04</title><link href="https://kura.gg/2011/12/17/host-git-repositories-with-git-gitosis-and-gitweb-on-debian-6ubuntu-10-04/" rel="alternate"></link><published>2011-12-17T15:40:00+00:00</published><updated>2011-12-17T15:40:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-12-17:/2011/12/17/host-git-repositories-with-git-gitosis-and-gitweb-on-debian-6ubuntu-10-04/</id><summary type="html">
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;First up we’ll need to install git and some Python tools to get Gitosis installed.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;-y&lt;span class="w"&gt; &lt;/span&gt;git-core&lt;span class="w"&gt; &lt;/span&gt;gitweb&lt;span class="w"&gt; &lt;/span&gt;python-setuptools
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we have to clone gitosis from it’s git repository and install it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/tmp
git&lt;span class="w"&gt; &lt;/span&gt;clone&lt;span class="w"&gt; &lt;/span&gt;git://eagain.net/gitosis.git
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;gitosis
sudo&lt;span class="w"&gt; &lt;/span&gt;python&lt;span class="w"&gt; &lt;/span&gt;setup.py&lt;span class="w"&gt; &lt;/span&gt;install
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-your-git-user"&gt;
&lt;h2&gt;Adding your git user&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;adduser&lt;span class="w"&gt; &lt;/span&gt;--system&lt;span class="w"&gt; &lt;/span&gt;--shell&lt;span class="w"&gt; &lt;/span&gt;/bin/sh&lt;span class="w"&gt; &lt;/span&gt;--gecos&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'git version control'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--group&lt;span class="w"&gt; &lt;/span&gt;--disabled-password&lt;span class="w"&gt; &lt;/span&gt;--home&lt;span class="w"&gt; &lt;/span&gt;/home/git&lt;span class="w"&gt; &lt;/span&gt;git
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above command creates a new system user with &lt;strong&gt;/bin/sh&lt;/strong&gt; as it’s
shell with &lt;strong&gt;no password&lt;/strong&gt; and a homedir of &lt;strong&gt;/home/git/&lt;/strong&gt; and also
creates a group with the same name.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="initialising-gitosis"&gt;
&lt;h2&gt;Initialising gitosis&lt;/h2&gt;
&lt;p&gt;You’ll need an &lt;span class="caps"&gt;SSH&lt;/span&gt; key for this, if you have one simply copy the
contents of it to your new git server, if you do not have one then you
can generate one on your machine using&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh-keygen
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And then …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;First up we’ll need to install git and some Python tools to get Gitosis installed.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;-y&lt;span class="w"&gt; &lt;/span&gt;git-core&lt;span class="w"&gt; &lt;/span&gt;gitweb&lt;span class="w"&gt; &lt;/span&gt;python-setuptools
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we have to clone gitosis from it’s git repository and install it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/tmp
git&lt;span class="w"&gt; &lt;/span&gt;clone&lt;span class="w"&gt; &lt;/span&gt;git://eagain.net/gitosis.git
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;gitosis
sudo&lt;span class="w"&gt; &lt;/span&gt;python&lt;span class="w"&gt; &lt;/span&gt;setup.py&lt;span class="w"&gt; &lt;/span&gt;install
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-your-git-user"&gt;
&lt;h2&gt;Adding your git user&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;adduser&lt;span class="w"&gt; &lt;/span&gt;--system&lt;span class="w"&gt; &lt;/span&gt;--shell&lt;span class="w"&gt; &lt;/span&gt;/bin/sh&lt;span class="w"&gt; &lt;/span&gt;--gecos&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'git version control'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;--group&lt;span class="w"&gt; &lt;/span&gt;--disabled-password&lt;span class="w"&gt; &lt;/span&gt;--home&lt;span class="w"&gt; &lt;/span&gt;/home/git&lt;span class="w"&gt; &lt;/span&gt;git
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above command creates a new system user with &lt;strong&gt;/bin/sh&lt;/strong&gt; as it’s
shell with &lt;strong&gt;no password&lt;/strong&gt; and a homedir of &lt;strong&gt;/home/git/&lt;/strong&gt; and also
creates a group with the same name.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="initialising-gitosis"&gt;
&lt;h2&gt;Initialising gitosis&lt;/h2&gt;
&lt;p&gt;You’ll need an &lt;span class="caps"&gt;SSH&lt;/span&gt; key for this, if you have one simply copy the
contents of it to your new git server, if you do not have one then you
can generate one on your machine using&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh-keygen
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And then copy the contents to your server.&lt;/p&gt;
&lt;p&gt;My file was copied to &lt;strong&gt;/tmp/kura.pub&lt;/strong&gt; so to initialise I used&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;-H&lt;span class="w"&gt; &lt;/span&gt;-u&lt;span class="w"&gt; &lt;/span&gt;git&lt;span class="w"&gt; &lt;/span&gt;gitosis-init&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;/tmp/kura.pub
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;*This command &lt;span class="caps"&gt;MUST&lt;/span&gt; be run as sudo.*&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;You need to do the same but replacing &lt;strong&gt;kura.pub&lt;/strong&gt; with your own key, it
has to end in .pub&lt;/p&gt;
&lt;div class="section" id="a-note-on-key-format"&gt;
&lt;h3&gt;A note on key format&lt;/h3&gt;
&lt;p&gt;One of my users (&lt;a class="reference external" href="https://syslog.tv/2011/12/17/host-git-repositories-with-git-gitosis-and-gitweb-on-debian-6ubuntu-10-04/#comment-374"&gt;@gump&lt;/a&gt;) had an issue where Gitosis would complain
about his username having invalid characters&lt;/p&gt;
&lt;pre class="literal-block"&gt;
gitosis.init.InsecureSSHKeyUsername: Username contains not allowed
characters
&lt;/pre&gt;
&lt;p&gt;This is because Gitosis expects your key to have a username and host at
the end of the base64 string like below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ssh-rsa AAAAB3NzaC1yc2EA ... NOHgpPwEBzpnw== kura@odin
&lt;/pre&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-and-controlling-gitosis"&gt;
&lt;h2&gt;Configuring and controlling gitosis&lt;/h2&gt;
&lt;p&gt;Now that git and gitosis are working on your server, from your local
machine you now need to clone your gitosis admin and do all your changes
locally, pushing them back to the git server where gitosis will
automatically pick them up.&lt;/p&gt;
&lt;p&gt;So you need to run&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git&lt;span class="w"&gt; &lt;/span&gt;clone&lt;span class="w"&gt; &lt;/span&gt;git@YOUR_SERVER:gitosis-admin.git
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If everything worked correctly you should have a copy on your local
machine now, if you run &lt;strong&gt;ls&lt;/strong&gt; you’ll see 1 file and a directory.&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;gitosis.conf&lt;/li&gt;
&lt;li&gt;keydir&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Unsurprisingly gitosis.conf is where gitosis is configured and keydir
contains public keys for your users. Each user needs their own public
key and it must end in &lt;em&gt;.pub&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;So open up &lt;strong&gt;gitosis.conf&lt;/strong&gt; in your favourite editor and add the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[gitosis]&lt;/span&gt;
&lt;span class="na"&gt;gitweb&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;

&lt;span class="k"&gt;[group admins]&lt;/span&gt;
&lt;span class="na"&gt;writable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;gitosis-admin test1&lt;/span&gt;
&lt;span class="na"&gt;members&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;kura&lt;/span&gt;

&lt;span class="k"&gt;[repo gitosis-admin]&lt;/span&gt;
&lt;span class="na"&gt;description&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Gitosis admin repository&lt;/span&gt;
&lt;span class="na"&gt;gitweb&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;yes&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So lets separate that in to parts.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Part 1&lt;/strong&gt; - we simply tell gitosis to enable gitweb support.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Part 2&lt;/strong&gt; - we configure a group called &lt;strong&gt;*admins*&lt;/strong&gt;, the admins group
has write permissions to 2 repositories; &lt;strong&gt;*gitosis-admin*&lt;/strong&gt; and
&lt;strong&gt;*test*&lt;/strong&gt;. The test repository will automatically become available once
we push this configuration back to gitosis later. We also define a user
called &lt;strong&gt;kura&lt;/strong&gt; which you should replace with your own username, &lt;strong&gt;each
user must have a public key in the keydir with the same name as the user
with .pub suffix. E.g. the kura user has a key called kura.pub&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Part 3&lt;/strong&gt; - We create a repository section which is only really used
for gitweb to tell it to display that repository publicly via a browser.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;If you do not want your repositories to be public then I advice you
skip the parts with gitweb = yes above and also uninstall gitweb and
skip the gitweb section below. Or you could lock your gitweb via
&lt;span class="caps"&gt;HTAUTH&lt;/span&gt;.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Now the changes have been made you need to commit them to git.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git&lt;span class="w"&gt; &lt;/span&gt;add&lt;span class="w"&gt; &lt;/span&gt;*
git&lt;span class="w"&gt; &lt;/span&gt;commit&lt;span class="w"&gt; &lt;/span&gt;-m&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Initial configuration"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And push them back to the server&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git&lt;span class="w"&gt; &lt;/span&gt;push&lt;span class="w"&gt; &lt;/span&gt;origin&lt;span class="w"&gt; &lt;/span&gt;master
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that is done you can test your access to the test repository created earlier.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;git&lt;span class="w"&gt; &lt;/span&gt;clone&lt;span class="w"&gt; &lt;/span&gt;git@YOUR_SERVER:test.git
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;test&lt;/span&gt;
&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Hello world"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;hello
git&lt;span class="w"&gt; &lt;/span&gt;add&lt;span class="w"&gt; &lt;/span&gt;hello
git&lt;span class="w"&gt; &lt;/span&gt;commit&lt;span class="w"&gt; &lt;/span&gt;-m&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"Test"&lt;/span&gt;
git&lt;span class="w"&gt; &lt;/span&gt;push&lt;span class="w"&gt; &lt;/span&gt;origin&lt;span class="w"&gt; &lt;/span&gt;master
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If the above works then congratulations, everything is good.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-users-and-repositories"&gt;
&lt;h2&gt;Adding users and repositories&lt;/h2&gt;
&lt;div class="section" id="users"&gt;
&lt;h3&gt;Users&lt;/h3&gt;
&lt;p&gt;To add a user to gitosis you need to add them to a group and put a
public key with username.pub as the naming format in to keydir.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="repositories"&gt;
&lt;h3&gt;Repositories&lt;/h3&gt;
&lt;p&gt;You simply need to name it in a writable section of a group and it’ll
instantly be accessible. If you want to make it public in gitweb then
you’ll need to a [repo] section as shown above.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configure-gitweb"&gt;
&lt;h2&gt;Configure gitweb&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/gitweb.conf&lt;/strong&gt; in your favourite editor and change
&lt;strong&gt;*$projectroot*&lt;/strong&gt; to&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;$projectroot&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"/home/git/repositories/"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You will also need to add the Apache user to the git group&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;usermod&lt;span class="w"&gt; &lt;/span&gt;-G&lt;span class="w"&gt; &lt;/span&gt;www-data,git&lt;span class="w"&gt; &lt;/span&gt;www-data
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By default Debian and Ubuntu will symlink in an Apache2 config to
&lt;strong&gt;/etc/apache2/conf.d/gitweb&lt;/strong&gt; which is accessible from a browser on
&lt;a class="reference external" href="https://YOUR_SERVER/gitweb"&gt;https://YOUR_SERVER/gitweb&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="git"></category><category term="gitosis"></category><category term="gitweb"></category><category term="ubuntu"></category></entry><entry><title>Rebooting on OOM</title><link href="https://kura.gg/2011/10/25/rebooting-on-oom/" rel="alternate"></link><published>2011-10-25T10:26:00+01:00</published><updated>2011-10-25T10:26:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-10-25:/2011/10/25/rebooting-on-oom/</id><summary type="html">
&lt;p&gt;&lt;strong&gt;*I would generally not advise using this unless you have skill at
debugging why &lt;span class="caps"&gt;OOM&lt;/span&gt; has spawned and also debugging kernel panics after
they happen, from logs.*&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;It is possible to configure your kernel to panic when &lt;span class="caps"&gt;OOM&lt;/span&gt; is spawned,
which in itself is not useful but, coupled with a kernel option for
auto-rebooting a system when the kernel panics it can be a very useful tool.&lt;/p&gt;
&lt;p&gt;Think before implementing this and use at your own risk, I take zero
responsibility for you using this.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sysctl&lt;span class="w"&gt; &lt;/span&gt;vm.panic_on_oom&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
sudo&lt;span class="w"&gt; &lt;/span&gt;sysctl&lt;span class="w"&gt; &lt;/span&gt;kernel.panic&lt;span class="o"&gt;=&lt;/span&gt;X&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# X is the amount of seconds to wait before rebooting&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;*&lt;span class="caps"&gt;DO&lt;/span&gt; &lt;span class="caps"&gt;NOT&lt;/span&gt; &lt;span class="caps"&gt;FORGET&lt;/span&gt; &lt;span class="caps"&gt;TO&lt;/span&gt; &lt;span class="caps"&gt;CHANGE&lt;/span&gt; X*&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This will inject the changes in to a system that is currently running
but will be forgotten on reboot so use the lines below to save permanently.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"vm.panic_on_oom=1"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/sysctl.conf
sudo&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"kernel.panic …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;&lt;strong&gt;*I would generally not advise using this unless you have skill at
debugging why &lt;span class="caps"&gt;OOM&lt;/span&gt; has spawned and also debugging kernel panics after
they happen, from logs.*&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;It is possible to configure your kernel to panic when &lt;span class="caps"&gt;OOM&lt;/span&gt; is spawned,
which in itself is not useful but, coupled with a kernel option for
auto-rebooting a system when the kernel panics it can be a very useful tool.&lt;/p&gt;
&lt;p&gt;Think before implementing this and use at your own risk, I take zero
responsibility for you using this.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;sysctl&lt;span class="w"&gt; &lt;/span&gt;vm.panic_on_oom&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
sudo&lt;span class="w"&gt; &lt;/span&gt;sysctl&lt;span class="w"&gt; &lt;/span&gt;kernel.panic&lt;span class="o"&gt;=&lt;/span&gt;X&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# X is the amount of seconds to wait before rebooting&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;*&lt;span class="caps"&gt;DO&lt;/span&gt; &lt;span class="caps"&gt;NOT&lt;/span&gt; &lt;span class="caps"&gt;FORGET&lt;/span&gt; &lt;span class="caps"&gt;TO&lt;/span&gt; &lt;span class="caps"&gt;CHANGE&lt;/span&gt; X*&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;This will inject the changes in to a system that is currently running
but will be forgotten on reboot so use the lines below to save permanently.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"vm.panic_on_oom=1"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/sysctl.conf
sudo&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"kernel.panic=X"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/sysctl.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;*X is the amount of seconds to wait before rebooting. &lt;span class="caps"&gt;DO&lt;/span&gt; &lt;span class="caps"&gt;NOT&lt;/span&gt; &lt;span class="caps"&gt;FORGET&lt;/span&gt; &lt;span class="caps"&gt;TO&lt;/span&gt;
&lt;span class="caps"&gt;CHANGE&lt;/span&gt; X*&lt;/strong&gt;&lt;/p&gt;
&lt;div class="section" id="testing"&gt;
&lt;h2&gt;Testing&lt;/h2&gt;
&lt;p&gt;You can test the changes with a simple C program. &lt;strong&gt;Please note if you
run this you do so at your own risk&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="cp"&gt;#include&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="cpf"&gt;&amp;lt;stdio.h&amp;gt;&lt;/span&gt;
&lt;span class="cp"&gt;#include&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="cpf"&gt;&amp;lt;stdlib.h&amp;gt;&lt;/span&gt;
&lt;span class="cp"&gt;#include&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="cpf"&gt;&amp;lt;string.h&amp;gt;&lt;/span&gt;

&lt;span class="cp"&gt;#define MB 10485760&lt;/span&gt;

&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nf"&gt;main&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;argc&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="kt"&gt;char&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;argv&lt;/span&gt;&lt;span class="p"&gt;[])&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;NULL&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kt"&gt;int&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="k"&gt;while&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="kt"&gt;void&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;malloc&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;MB&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;!&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="k"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;memset&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;b&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;MB&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="n"&gt;printf&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s"&gt;"Allocating %d MB&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="o"&gt;++&lt;/span&gt;&lt;span class="n"&gt;c&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;10&lt;/span&gt;&lt;span class="p"&gt;));&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="n"&gt;exit&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="mi"&gt;0&lt;/span&gt;&lt;span class="p"&gt;);&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="compilation"&gt;
&lt;h2&gt;Compilation&lt;/h2&gt;
&lt;p&gt;You can download the &lt;a class="reference external" href="/files/oom.c"&gt;source here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;To compile run the command below&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;gcc&lt;span class="w"&gt; &lt;/span&gt;-O2&lt;span class="w"&gt; &lt;/span&gt;oom.c&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;oom
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Or download a &lt;a class="reference external" href="/files/oom"&gt;pre-compiled version here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="usage"&gt;
&lt;h2&gt;Usage&lt;/h2&gt;
&lt;p&gt;And simply run it using&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;./oom
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;After a short period of time allocating and using &lt;span class="caps"&gt;10MB&lt;/span&gt; chunks of memory
your system should run out and restart.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="kernel panic"></category><category term="oom"></category><category term="reboot"></category></entry><entry><title>Nagios3 + MK Livestatus + xinetd on Debian 6/Ubuntu</title><link href="https://kura.gg/2011/10/13/nagios3-mk-livestatus-xinetd/" rel="alternate"></link><published>2011-10-13T23:17:00+01:00</published><updated>2011-10-13T23:17:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-10-13:/2011/10/13/nagios3-mk-livestatus-xinetd/</id><summary type="html">
&lt;div class="section" id="preparation"&gt;
&lt;h2&gt;Preparation&lt;/h2&gt;
&lt;p&gt;First we need to make sure we have all the stuff we need to compile mk
livestatus and run it&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;make&lt;span class="w"&gt; &lt;/span&gt;build-essential&lt;span class="w"&gt; &lt;/span&gt;xinetd&lt;span class="w"&gt; &lt;/span&gt;ucspi-unix
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mk-livestatus"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MK&lt;/span&gt; Livestatus&lt;/h2&gt;
&lt;p&gt;Grab the mk livestatus source from &lt;a class="reference external" href="https://mathias-kettner.de/check_mk_download.html"&gt;here&lt;/a&gt;, currently it’s version
1.1.10p3 but update the commands below to match your version.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;https://mathias-kettner.de/download/mk-livestatus-1.1.10p3.tar.gz
tar&lt;span class="w"&gt; &lt;/span&gt;xvzf&lt;span class="w"&gt; &lt;/span&gt;mk-livestatus-1.1.10p3.tar.gz
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;mk-livestatus-1.1.10p3
./configure
make
sudo&lt;span class="w"&gt; &lt;/span&gt;make&lt;span class="w"&gt; &lt;/span&gt;install
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="xinetd"&gt;
&lt;h2&gt;Xinetd&lt;/h2&gt;
&lt;p&gt;Now that it’s compiled we need to write a xinetd config for it, create a
new file called &lt;strong&gt;/etc/xinetd.d/livestatus&lt;/strong&gt; and put the following in it&lt;/p&gt;
&lt;pre class="literal-block"&gt;
service livestatus {
    type = UNLISTED
    port = 6557
    socket_type = stream
    protocol = tcp
    wait = no
    cps = 100 3
    instances = 500
    per_source = 250
    flags = NODELAY
    user = nagios
    server = /usr/bin/unixcat
    server_args = /var/lib/nagios3/rw/live
    only_from = 127.0.0.1 # modify this to …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="preparation"&gt;
&lt;h2&gt;Preparation&lt;/h2&gt;
&lt;p&gt;First we need to make sure we have all the stuff we need to compile mk
livestatus and run it&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;make&lt;span class="w"&gt; &lt;/span&gt;build-essential&lt;span class="w"&gt; &lt;/span&gt;xinetd&lt;span class="w"&gt; &lt;/span&gt;ucspi-unix
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="mk-livestatus"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;MK&lt;/span&gt; Livestatus&lt;/h2&gt;
&lt;p&gt;Grab the mk livestatus source from &lt;a class="reference external" href="https://mathias-kettner.de/check_mk_download.html"&gt;here&lt;/a&gt;, currently it’s version
1.1.10p3 but update the commands below to match your version.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;wget&lt;span class="w"&gt; &lt;/span&gt;https://mathias-kettner.de/download/mk-livestatus-1.1.10p3.tar.gz
tar&lt;span class="w"&gt; &lt;/span&gt;xvzf&lt;span class="w"&gt; &lt;/span&gt;mk-livestatus-1.1.10p3.tar.gz
&lt;span class="nb"&gt;cd&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;mk-livestatus-1.1.10p3
./configure
make
sudo&lt;span class="w"&gt; &lt;/span&gt;make&lt;span class="w"&gt; &lt;/span&gt;install
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="xinetd"&gt;
&lt;h2&gt;Xinetd&lt;/h2&gt;
&lt;p&gt;Now that it’s compiled we need to write a xinetd config for it, create a
new file called &lt;strong&gt;/etc/xinetd.d/livestatus&lt;/strong&gt; and put the following in it&lt;/p&gt;
&lt;pre class="literal-block"&gt;
service livestatus {
    type = UNLISTED
    port = 6557
    socket_type = stream
    protocol = tcp
    wait = no
    cps = 100 3
    instances = 500
    per_source = 250
    flags = NODELAY
    user = nagios
    server = /usr/bin/unixcat
    server_args = /var/lib/nagios3/rw/live
    only_from = 127.0.0.1 # modify this to only allow specific hosts to connect, currenly localhost only
    disable = no
}
&lt;/pre&gt;
&lt;p&gt;Now we restart xinetd using&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/xinetd&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="nagios3"&gt;
&lt;h2&gt;Nagios3&lt;/h2&gt;
&lt;p&gt;Now we need to open up &lt;strong&gt;/etc/nagios3/nagios.cfg&lt;/strong&gt; and add the following line&lt;/p&gt;
&lt;pre class="literal-block"&gt;
event_broker_options=-1 broker_module=/usr/local/lib/mk-livestatus/livestatus.o /var/lib/nagios3/rw/live
&lt;/pre&gt;
&lt;p&gt;Now we need to restart Nagios&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/nagios3&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you take a look in &lt;strong&gt;/var/log/nagios3/nagios.log&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;tail&lt;span class="w"&gt; &lt;/span&gt;-n&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;100&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/var/log/nagios3/nagios.log
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;you should see something like below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
[1318547328] livestatus: Livestatus 1.1.10p3 by Mathias Kettner. Socket: '/var/lib/nagios3/rw/live'
[1318547328] livestatus: Please visit us at https://mathias-kettner.de/
[1318547328] livestatus: Hint: please try out OMD - the Open Monitoring Distribution
[1318547328] livestatus: Please visit OMD at https://omdistro.org
[1318547328] Event broker module '/usr/local/lib/mk-livestatus/livestatus.o' initialized successfully.
&lt;/pre&gt;
&lt;p&gt;Also, we can ls the newly created socket&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ls&lt;span class="w"&gt; &lt;/span&gt;-lah&lt;span class="w"&gt; &lt;/span&gt;/var/lib/nagios3/rw/live

srw-rw----&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;nagios&lt;span class="w"&gt; &lt;/span&gt;www-data&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2011&lt;/span&gt;-10-14&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;00&lt;/span&gt;:08&lt;span class="w"&gt; &lt;/span&gt;/var/lib/nagios3/rw/live
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can test is by creating a test file called host_query with the
following content&lt;/p&gt;
&lt;pre class="literal-block"&gt;
GET hosts
&lt;/pre&gt;
&lt;p&gt;And run the following command&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;unixcat&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;host_query&lt;span class="w"&gt; &lt;/span&gt;/var/lib/nagios3/rw/live
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If all worked you should see output.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="mk livestatus"></category><category term="nagios"></category><category term="nagios 3"></category><category term="nagios broker"></category><category term="xinetd"></category></entry><entry><title>nginx config for reverse proxying Wordpress &amp; WP Super Cache and keeping the load off Apache2</title><link href="https://kura.gg/2011/09/30/nginx-config-for-reverse-proxying-wordpress-wp-super-cache-and-keeping-the-load-off-apache2/" rel="alternate"></link><published>2011-09-30T23:21:00+01:00</published><updated>2011-09-30T23:21:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-30:/2011/09/30/nginx-config-for-reverse-proxying-wordpress-wp-super-cache-and-keeping-the-load-off-apache2/</id><summary type="html">
&lt;div class="section" id="the-point"&gt;
&lt;h2&gt;The point&lt;/h2&gt;
&lt;p&gt;The whole point of this is to get as much load off of Apache as possible
to keep the server running nice and smoothly.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;The configuration below will mean that nginx will serve basically everything;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;static files&lt;/li&gt;
&lt;li&gt;uploaded files and&lt;/li&gt;
&lt;li&gt;cached content&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;simply replace the &lt;strong&gt;&lt;span class="caps"&gt;VARIABLES&lt;/span&gt;&lt;/strong&gt; below and everything should be good to
go, if copy-pasting from below isn’t working properly you can download a
full copy from &lt;a class="reference external" href="/files/2011/09/server.txt"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;**DOMAIN_HERE**&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/access.**DOMAIN_HERE**.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_disable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;msie6&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# disable gzip for IE6&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_comp_level&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# highest level of compression&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_proxied&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;any&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_types&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/plain&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/css&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/x-javascript&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml+rss&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/javascript&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Set-Cookie&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;**/PATH/TO/WORDPRESS**&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# default location, used for the basic proxying&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# if we're requesting a file and …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="the-point"&gt;
&lt;h2&gt;The point&lt;/h2&gt;
&lt;p&gt;The whole point of this is to get as much load off of Apache as possible
to keep the server running nice and smoothly.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;The configuration below will mean that nginx will serve basically everything;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;static files&lt;/li&gt;
&lt;li&gt;uploaded files and&lt;/li&gt;
&lt;li&gt;cached content&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;simply replace the &lt;strong&gt;&lt;span class="caps"&gt;VARIABLES&lt;/span&gt;&lt;/strong&gt; below and everything should be good to
go, if copy-pasting from below isn’t working properly you can download a
full copy from &lt;a class="reference external" href="/files/2011/09/server.txt"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;**DOMAIN_HERE**&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/access.**DOMAIN_HERE**.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_disable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;msie6&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# disable gzip for IE6&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_comp_level&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# highest level of compression&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_proxied&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;any&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;gzip_types&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/plain&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/css&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/x-javascript&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml+rss&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/javascript&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Set-Cookie&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;**/PATH/TO/WORDPRESS**&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# default location, used for the basic proxying&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# if we're requesting a file and it exists, return it and bail out&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(-f&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$request_filename&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;      &lt;/span&gt;&lt;span class="kn"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;client_max_body_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;2m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# increase this to increase file upload size&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://localhost:**APACHE_PORT**&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# handle uploaded files&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;files/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;**/PATH/TO/WORDPRESS**/blogs.dir/**BLOG_ID**/&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# handle static files&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;\.(jpg|png|gif|jpeg|js|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx|txt|htm|html)&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# if the static file doesn't exist, handle it with Apache&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(!-f&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$request_filename&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://localhost:**APACHE_PORT**&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_file&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$request_uri&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# reset cache URI if POSTing - bypass cache&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$request_method&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;POST)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# bypass cache if there's a query string&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$query_string&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# bypass cache if one of the cookies below is set&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_|wordpress|wp-postpass_")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# if the URI is still set (rules above don't trigger) then set our file location!&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sr"&gt;^(.+)$)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_file&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/wp-content/cache/supercache/&lt;/span&gt;&lt;span class="nv"&gt;$http_host$1index.html&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# rewrite the request to the cached HTML file&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(-f&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$document_root$supercache_file&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;rewrite&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;^(.*)&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_file&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="c1"&gt;# if file exists, return it - will bypass back to Apache if not&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(-f&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$request_filename&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;  &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache2"></category><category term="nginx"></category><category term="wordpress"></category><category term="wp-super-cache"></category></entry><entry><title>Load balancing HTTP/HTTPS with Pound on Debian 6/Ubuntu</title><link href="https://kura.gg/2011/09/29/load-balancing-httphttps-with-pound-on-debian-6ubuntu/" rel="alternate"></link><published>2011-09-29T23:15:00+01:00</published><updated>2011-09-29T23:15:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-29:/2011/09/29/load-balancing-httphttps-with-pound-on-debian-6ubuntu/</id><summary type="html">
&lt;p&gt;Pound is a great little load balancer, it’s fast, opensource and
supports &lt;span class="caps"&gt;SSL&lt;/span&gt; termination, which is great!&lt;/p&gt;
&lt;div class="section" id="install"&gt;
&lt;h2&gt;Install&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;pound
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;The default configuration should be pretty good for most purposes, but
feel free to tweak as you require.&lt;/p&gt;
&lt;div class="section" id="http"&gt;
&lt;h3&gt;&lt;span class="caps"&gt;HTTP&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;We’ll first look at load balancing &lt;span class="caps"&gt;HTTP&lt;/span&gt;, in case you don’t want or need
&lt;span class="caps"&gt;HTTPS&lt;/span&gt; load balancing.&lt;/p&gt;
&lt;p&gt;We’ll need delete all the content within &lt;em&gt;ListenHTTP&lt;/em&gt; block, once done
it should look like this&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ListenHTTP
End
&lt;/pre&gt;
&lt;p&gt;Now we add an address and port to listen on and finally a line to remove
an &lt;span class="caps"&gt;HTTP&lt;/span&gt; header&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ListenHTTP
    Address 0.0.0.0 # all interfaces
    Port 80
    HeadRemove "X-Forwarded-For"
End
&lt;/pre&gt;
&lt;p&gt;This is a basic configuration, for each backend we want to load balance
we’ll need to add a service within that listener.&lt;/p&gt;
&lt;p&gt;You’ll notice we’re removing incoming headers called &lt;em&gt;X-Forwarded-For&lt;/em&gt;,
this is to make …&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Pound is a great little load balancer, it’s fast, opensource and
supports &lt;span class="caps"&gt;SSL&lt;/span&gt; termination, which is great!&lt;/p&gt;
&lt;div class="section" id="install"&gt;
&lt;h2&gt;Install&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;pound
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;The default configuration should be pretty good for most purposes, but
feel free to tweak as you require.&lt;/p&gt;
&lt;div class="section" id="http"&gt;
&lt;h3&gt;&lt;span class="caps"&gt;HTTP&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;We’ll first look at load balancing &lt;span class="caps"&gt;HTTP&lt;/span&gt;, in case you don’t want or need
&lt;span class="caps"&gt;HTTPS&lt;/span&gt; load balancing.&lt;/p&gt;
&lt;p&gt;We’ll need delete all the content within &lt;em&gt;ListenHTTP&lt;/em&gt; block, once done
it should look like this&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ListenHTTP
End
&lt;/pre&gt;
&lt;p&gt;Now we add an address and port to listen on and finally a line to remove
an &lt;span class="caps"&gt;HTTP&lt;/span&gt; header&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ListenHTTP
    Address 0.0.0.0 # all interfaces
    Port 80
    HeadRemove "X-Forwarded-For"
End
&lt;/pre&gt;
&lt;p&gt;This is a basic configuration, for each backend we want to load balance
we’ll need to add a service within that listener.&lt;/p&gt;
&lt;p&gt;You’ll notice we’re removing incoming headers called &lt;em&gt;X-Forwarded-For&lt;/em&gt;,
this is to make sure someone doesn’t try to craft them in to a request
and abuse them.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ListenHTTP
    Address 0.0.0.0 # all interfaces
    Port 80
    HeadRemove "X-Forwarded-For"

    Service
        BackEnd
            Address 10.0.0.1
            Port 80
            Priority 1
        End
        BackEnd
            Address 10.0.0.2
            Port 80
            Priority 1
        End
    End
End
&lt;/pre&gt;
&lt;p&gt;Here I’ve added 2 BackEnds that connect to port 80, it’s all pretty
simple. Add as many as you want/need.&lt;/p&gt;
&lt;p&gt;Pound will pass correct &lt;span class="caps"&gt;HTTP&lt;/span&gt; headers through to the backends so you
configure those just like you normally would.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="https"&gt;
&lt;h3&gt;&lt;span class="caps"&gt;HTTPS&lt;/span&gt;&lt;/h3&gt;
&lt;p&gt;&lt;span class="caps"&gt;HTTPS&lt;/span&gt; is basically exactly the same as &lt;span class="caps"&gt;HTTP&lt;/span&gt; except for one fantastic
option - &lt;span class="caps"&gt;SSL&lt;/span&gt; termination! Which means we can do the &lt;span class="caps"&gt;SSL&lt;/span&gt; decryption
within Pound and talk to our backend servers over standard unencrypted
&lt;span class="caps"&gt;HTTP&lt;/span&gt; - &lt;strong&gt;this should only be done on a private network.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;So, we’ll create an &lt;span class="caps"&gt;HTTPS&lt;/span&gt; listened like the one above but with extra options.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ListenHTTPS
    Address 0.0.0.0 # all interfaces
    Port 443
    AddHeader "X-Forwarded-Proto: https"
    HeadRemove "X-Forwarded-Proto"
    HeadRemove "X-Forwarded-For"
    Cert "/path/to/certificate.pem

    Service
        BackEnd
            Address 10.0.0.1
            Port 80
            Priority 1
        End
        BackEnd
            Address 10.0.0.2
            Port 80
            Priority 1
            End
    End
End
&lt;/pre&gt;
&lt;p&gt;You’ll notice a few changes here, first we tell the &lt;span class="caps"&gt;HTTPS&lt;/span&gt; listener to
listen on port 443 - &lt;span class="caps"&gt;SSL&lt;/span&gt; port.&lt;/p&gt;
&lt;p&gt;We add a header to pass back to our backend servers called
&lt;em&gt;X-Forwarded-Proto&lt;/em&gt;, this is so that on our backend we can inspect this
header and use it if required to know we’re secure.&lt;/p&gt;
&lt;p&gt;We also remove incoming headers called &lt;em&gt;X-Forwarded-Proto&lt;/em&gt; and
&lt;em&gt;X-Forwarded-For&lt;/em&gt;, this is to make sure someone doesn’t try to craft
them in to a request and abuse them.&lt;/p&gt;
&lt;p&gt;Finally is the certificate which needs to be a &lt;span class="caps"&gt;PEM&lt;/span&gt; file with all
certificates and keys within it and without passphrases.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="done"&gt;
&lt;h2&gt;Done&lt;/h2&gt;
&lt;p&gt;Once configured, reload Pound.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/pound&lt;span class="w"&gt; &lt;/span&gt;reload
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That really was simple.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="http"></category><category term="https"></category><category term="load"></category><category term="load balancing"></category><category term="pound"></category><category term="ssl"></category><category term="ssl offloading"></category><category term="ssl termination"></category></entry><entry><title>Postfix spam protection with greylisting using Postgrey on Debian 6/Ubuntu</title><link href="https://kura.gg/2011/09/24/postfix-spam-protection-with-greylisting-using-postgrey-on-debian-6ubuntu/" rel="alternate"></link><published>2011-09-24T21:29:00+01:00</published><updated>2011-09-24T21:29:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-24:/2011/09/24/postfix-spam-protection-with-greylisting-using-postgrey-on-debian-6ubuntu/</id><summary type="html">
&lt;p&gt;A simple yet effective method for protecting your mail server from spam
is to use greylisting. In simple terms, when an email is received the
server will temporarily reject it with a 450 response code claiming that
the server is busy, the sending server should then attempt to try to
deliver at a later point in time, if enough time has passed the
recipient server will then accept the incoming mail and whitelist the
send address for a period of time.&lt;/p&gt;
&lt;p&gt;This is effective because most spam servers are configured not to retry
the send whereas real mail servers generally will retry. This sadly does
not protect against spam coming from comprised mail servers or accounts
like on Hotmail.com.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;postgrey
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-postgrey"&gt;
&lt;h2&gt;Configuring Postgrey&lt;/h2&gt;
&lt;p&gt;By default Postgrey runs on &lt;em&gt;127.0.0.1:60000&lt;/em&gt;, which is the local
loopback interface so it is not exposed to the …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;A simple yet effective method for protecting your mail server from spam
is to use greylisting. In simple terms, when an email is received the
server will temporarily reject it with a 450 response code claiming that
the server is busy, the sending server should then attempt to try to
deliver at a later point in time, if enough time has passed the
recipient server will then accept the incoming mail and whitelist the
send address for a period of time.&lt;/p&gt;
&lt;p&gt;This is effective because most spam servers are configured not to retry
the send whereas real mail servers generally will retry. This sadly does
not protect against spam coming from comprised mail servers or accounts
like on Hotmail.com.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;postgrey
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-postgrey"&gt;
&lt;h2&gt;Configuring Postgrey&lt;/h2&gt;
&lt;p&gt;By default Postgrey runs on &lt;em&gt;127.0.0.1:60000&lt;/em&gt;, which is the local
loopback interface so it is not exposed to the outside world.&lt;/p&gt;
&lt;p&gt;If you open up &lt;strong&gt;/etc/default/postgrey&lt;/strong&gt; and modify the &lt;em&gt;POSTGREY_OPTS&lt;/em&gt;
line you can configure how long to grey list for.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;--delay&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;60&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;would greylist the sending server for 60 seconds (the default value is
300 second, 5 minutes), if a retry was attempted after 60 seconds the
sender would automatically become whitelisted, by default this sender is
whitelisted for 35 days but can be changed using the &lt;em&gt;—max-age&lt;/em&gt; option&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;--max-age&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;10&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;would whitelist for 10 days.&lt;/p&gt;
&lt;p&gt;They can be combined as below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;POSTGREY_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"--inet=127.0.0.1:60000 --delay=60 --max-age=10"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once you’re satisfied save and closed and restart Postgrey.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/postgrey&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-postfix"&gt;
&lt;h2&gt;Configuring Postfix&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/postfix/main.cf&lt;/strong&gt; and add the following within
&lt;em&gt;smtpd_receipient_restrictions&lt;/em&gt;&lt;/p&gt;
&lt;pre class="literal-block"&gt;
check_policy_service inet:127.0.0.1:60000
&lt;/pre&gt;
&lt;p&gt;This is best added after your &lt;span class="caps"&gt;SASL&lt;/span&gt; and sender domain checks but before
&lt;span class="caps"&gt;SPF&lt;/span&gt; and blacklists, see below for an example&lt;/p&gt;
&lt;pre class="literal-block"&gt;
smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_unknown_sender_domain,
    check_policy_service inet:127.0.0.1:60000
&lt;/pre&gt;
&lt;p&gt;Now reload Postfix&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/postfix&lt;span class="w"&gt; &lt;/span&gt;reload
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="testing"&gt;
&lt;h2&gt;Testing&lt;/h2&gt;
&lt;p&gt;Now if you tail your mail.log you will see your Postgrey instance
rejecting incoming email like below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Sept 24 22:26:18 heimdall postfix/smtpd[4256]: NOQUEUE: reject: RCPT from example.com[xxx.xxx.xxx.xxx]: 450: Recipient address rejected: Greylisted for 300 seconds (see https://isg.ee.ethz.ch/tools/postgrey/help/spammed.com.html); from=to=proto=ESMTP helo=&amp;lt;example.com&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="email"></category><category term="greylist"></category><category term="mail"></category><category term="postfix"></category><category term="postgrey"></category><category term="spam"></category><category term="ubuntu"></category></entry><entry><title>Postfix spam protection with blacklists</title><link href="https://kura.gg/2011/09/24/postfix-spam-protection-with-blacklists/" rel="alternate"></link><published>2011-09-24T21:05:00+01:00</published><updated>2011-09-24T21:05:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-24:/2011/09/24/postfix-spam-protection-with-blacklists/</id><summary type="html">&lt;p&gt;This really should be quite a quick and simple post.&lt;/p&gt;
&lt;p&gt;I use several tools to protect my mail servers from spam, the most
effective of these I’ve found is using external lists in conjunction
with &lt;strong&gt;reject_rbl_client&lt;/strong&gt; and &lt;strong&gt;reject_rhsbl_client&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;+======================+======================================================================================================+
| Service              | description                                                                                          |
+======================+======================================================================================================+
| zen.spamhaus.org     | A single lookup for querying the &lt;span class="caps"&gt;SBL&lt;/span&gt;, &lt;span class="caps"&gt;XBL&lt;/span&gt; and &lt;span class="caps"&gt;PBL&lt;/span&gt; databases.                                         |
|                      |  - &lt;span class="caps"&gt;SBL&lt;/span&gt; - Verified sources of spam, including spammers and their support services                     |
|                      |  - &lt;span class="caps"&gt;XBL&lt;/span&gt; - Illegal third-party exploits (e.g. open proxies and Trojan Horses)                          |
|                      |  - &lt;span class="caps"&gt;PBL&lt;/span&gt; - Static, dial-up &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; &lt;span class="caps"&gt;DHCP&lt;/span&gt; &lt;span class="caps"&gt;IP&lt;/span&gt; address space that is not meant to be initiating &lt;span class="caps"&gt;SMTP&lt;/span&gt; connections |
+———————————+———————————————————————————————————————————————————+
| dnsbl.sorbs.net      | Unsolicited bulk/commercial email senders                                                            |
+———————————+———————————————————————————————————————————————————+
| spam.dnsbl.sorbs.net | Hosts that have allegedly sent spam to the admins of &lt;span class="caps"&gt;SORBS&lt;/span&gt; at any time                               |
+———————————+———————————————————————————————————————————————————+
| b1.spamcop.net       | &lt;span class="caps"&gt;IP&lt;/span&gt; addresses which have been used to transmit reported email to SpamCop users                        |
+———————————+———————————————————————————————————————————————————+
| rhsbl.ahbl.org       | Domains sending spam, domains owned by spammers, comment spam domains, spammed URLs …&lt;/p&gt;</summary><content type="html">&lt;p&gt;This really should be quite a quick and simple post.&lt;/p&gt;
&lt;p&gt;I use several tools to protect my mail servers from spam, the most
effective of these I’ve found is using external lists in conjunction
with &lt;strong&gt;reject_rbl_client&lt;/strong&gt; and &lt;strong&gt;reject_rhsbl_client&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;+======================+======================================================================================================+
| Service              | description                                                                                          |
+======================+======================================================================================================+
| zen.spamhaus.org     | A single lookup for querying the &lt;span class="caps"&gt;SBL&lt;/span&gt;, &lt;span class="caps"&gt;XBL&lt;/span&gt; and &lt;span class="caps"&gt;PBL&lt;/span&gt; databases.                                         |
|                      |  - &lt;span class="caps"&gt;SBL&lt;/span&gt; - Verified sources of spam, including spammers and their support services                     |
|                      |  - &lt;span class="caps"&gt;XBL&lt;/span&gt; - Illegal third-party exploits (e.g. open proxies and Trojan Horses)                          |
|                      |  - &lt;span class="caps"&gt;PBL&lt;/span&gt; - Static, dial-up &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; &lt;span class="caps"&gt;DHCP&lt;/span&gt; &lt;span class="caps"&gt;IP&lt;/span&gt; address space that is not meant to be initiating &lt;span class="caps"&gt;SMTP&lt;/span&gt; connections |
+———————————+———————————————————————————————————————————————————+
| dnsbl.sorbs.net      | Unsolicited bulk/commercial email senders                                                            |
+———————————+———————————————————————————————————————————————————+
| spam.dnsbl.sorbs.net | Hosts that have allegedly sent spam to the admins of &lt;span class="caps"&gt;SORBS&lt;/span&gt; at any time                               |
+———————————+———————————————————————————————————————————————————+
| b1.spamcop.net       | &lt;span class="caps"&gt;IP&lt;/span&gt; addresses which have been used to transmit reported email to SpamCop users                        |
+———————————+———————————————————————————————————————————————————+
| rhsbl.ahbl.org       | Domains sending spam, domains owned by spammers, comment spam domains, spammed URLs                  | +———————————+———————————————————————————————————————————————————+&lt;/p&gt;
&lt;p&gt;The description for each of these services was shamelessly taken from
Wikipedia, I have listed the services that I actually use but you can
find a much larger list on the &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Comparison_of_DNS_blacklists"&gt;page that I took the descriptions
from&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;*Please note that the &lt;span class="caps"&gt;SORBS&lt;/span&gt; lists are generally classed as being
aggressive and a lot of people advise not to use them due to this. They
have been known to block emails from senders like Facebook.*&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;You can pick and choose which ones you use and you configure them as
below within &lt;strong&gt;smtp_recipient_restrictions&lt;/strong&gt; in &lt;strong&gt;/etc/postfix/main.cf&lt;/strong&gt;&lt;/p&gt;
&lt;pre class="literal-block"&gt;
smtpd_recipient_restrictions =
  reject_rbl_client zen.spamhaus.org,
  reject_rbl_client dnsbl.sorbs.net,
  reject_rbl_client spam.dnsbl.sorbs.net,
  reject_rbl_client bl.spamcop.net,
  reject_rhsbl_client rhsbl.ahbl.org
&lt;/pre&gt;
</content><category term="tutorials"></category><category term="blackhole"></category><category term="blacklist"></category><category term="email"></category><category term="mail"></category><category term="postfix"></category><category term="spam"></category></entry><entry><title>SpamAssassin + Razor + Pyzor on Debian 6/Ubuntu</title><link href="https://kura.gg/2011/09/22/spamassassin-razor-pyzor/" rel="alternate"></link><published>2011-09-22T19:17:00+01:00</published><updated>2011-09-22T19:17:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-22:/2011/09/22/spamassassin-razor-pyzor/</id><summary type="html">
&lt;p&gt;This is part 4 of my series on configuring a mail server, please see
&lt;a class="reference external" href="/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/"&gt;part one&lt;/a&gt;, &lt;a class="reference external" href="/2011/09/16/postfix-spamassassin-clamav-procmail/"&gt;part two&lt;/a&gt; and &lt;a class="reference external" href="/2011/09/17/postfix-dk-dkim-spf/"&gt;part three&lt;/a&gt; if you’re not familiar with them.&lt;/p&gt;
&lt;p&gt;The content of this article was written to work with the previous three
articles but should work on any SpamAssassin set-up.&lt;/p&gt;
&lt;div class="section" id="razor"&gt;
&lt;h2&gt;Razor&lt;/h2&gt;
&lt;p&gt;First off we need to install Razor.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;razor
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we need to run three commands to register and configure Razor.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;razor-admin&lt;span class="w"&gt; &lt;/span&gt;-home&lt;span class="o"&gt;=&lt;/span&gt;/etc/spamassassin/.razor&lt;span class="w"&gt; &lt;/span&gt;-register
sudo&lt;span class="w"&gt; &lt;/span&gt;razor-admin&lt;span class="w"&gt; &lt;/span&gt;-home&lt;span class="o"&gt;=&lt;/span&gt;/etc/spamassassin/.razor&lt;span class="w"&gt; &lt;/span&gt;-create
sudo&lt;span class="w"&gt; &lt;/span&gt;razor-admin&lt;span class="w"&gt; &lt;/span&gt;-home&lt;span class="o"&gt;=&lt;/span&gt;/etc/spamassassin/.razor&lt;span class="w"&gt; &lt;/span&gt;-discover
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;These 3 commands should be pretty self explanatory, they register Razor,
create it’s configuration and discover the Razor servers.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pyzor"&gt;
&lt;h2&gt;Pyzor&lt;/h2&gt;
&lt;p&gt;Now we’ll install Pyzor.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;pyzor
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we also need to tell Pyzor to discover it’s servers.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pyzor&lt;span class="w"&gt; &lt;/span&gt;--homedir&lt;span class="w"&gt; &lt;/span&gt;/etc/mail/spamassassin&lt;span class="w"&gt; &lt;/span&gt;discover
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="spamassassin"&gt;
&lt;h2&gt;SpamAssassin&lt;/h2&gt;
&lt;p&gt;Add the following lines to the end …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This is part 4 of my series on configuring a mail server, please see
&lt;a class="reference external" href="/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/"&gt;part one&lt;/a&gt;, &lt;a class="reference external" href="/2011/09/16/postfix-spamassassin-clamav-procmail/"&gt;part two&lt;/a&gt; and &lt;a class="reference external" href="/2011/09/17/postfix-dk-dkim-spf/"&gt;part three&lt;/a&gt; if you’re not familiar with them.&lt;/p&gt;
&lt;p&gt;The content of this article was written to work with the previous three
articles but should work on any SpamAssassin set-up.&lt;/p&gt;
&lt;div class="section" id="razor"&gt;
&lt;h2&gt;Razor&lt;/h2&gt;
&lt;p&gt;First off we need to install Razor.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;razor
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we need to run three commands to register and configure Razor.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;razor-admin&lt;span class="w"&gt; &lt;/span&gt;-home&lt;span class="o"&gt;=&lt;/span&gt;/etc/spamassassin/.razor&lt;span class="w"&gt; &lt;/span&gt;-register
sudo&lt;span class="w"&gt; &lt;/span&gt;razor-admin&lt;span class="w"&gt; &lt;/span&gt;-home&lt;span class="o"&gt;=&lt;/span&gt;/etc/spamassassin/.razor&lt;span class="w"&gt; &lt;/span&gt;-create
sudo&lt;span class="w"&gt; &lt;/span&gt;razor-admin&lt;span class="w"&gt; &lt;/span&gt;-home&lt;span class="o"&gt;=&lt;/span&gt;/etc/spamassassin/.razor&lt;span class="w"&gt; &lt;/span&gt;-discover
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;These 3 commands should be pretty self explanatory, they register Razor,
create it’s configuration and discover the Razor servers.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="pyzor"&gt;
&lt;h2&gt;Pyzor&lt;/h2&gt;
&lt;p&gt;Now we’ll install Pyzor.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;pyzor
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we also need to tell Pyzor to discover it’s servers.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pyzor&lt;span class="w"&gt; &lt;/span&gt;--homedir&lt;span class="w"&gt; &lt;/span&gt;/etc/mail/spamassassin&lt;span class="w"&gt; &lt;/span&gt;discover
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="spamassassin"&gt;
&lt;h2&gt;SpamAssassin&lt;/h2&gt;
&lt;p&gt;Add the following lines to the end of &lt;strong&gt;/etc/spamassassin/local.cf&lt;/strong&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;razor_config&lt;span class="w"&gt; &lt;/span&gt;/etc/mail/spamassassin/.razor/razor-agent.conf
pyzor_options&lt;span class="w"&gt; &lt;/span&gt;--homedir&lt;span class="w"&gt; &lt;/span&gt;/etc/mail/spamassassin
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Finally we restart SpamAssassin&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/spamassasin&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And we’re all done.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="/2011/09/22/spamassassin-razor-pyzor/"&gt;« Part 3 - Postfix + &lt;span class="caps"&gt;DK&lt;/span&gt; (DomainKeys) + &lt;span class="caps"&gt;DKIM&lt;/span&gt; + &lt;span class="caps"&gt;SPF&lt;/span&gt;&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="email"></category><category term="mail"></category><category term="postfix"></category><category term="pyzor"></category><category term="razor"></category><category term="spam"></category><category term="spamassassin"></category></entry><entry><title>Debian/Ubuntu upgrade security packages only - a better way to do it</title><link href="https://kura.gg/2011/09/21/debianubuntu-upgrade-security-packages-only-a-better-way-to-do-it/" rel="alternate"></link><published>2011-09-21T13:21:00+01:00</published><updated>2011-09-21T13:21:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-21:/2011/09/21/debianubuntu-upgrade-security-packages-only-a-better-way-to-do-it/</id><content type="html">&lt;p&gt;&lt;strong&gt;I have created a scripts that handle these tasks for you, available `here`_.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;First thing we need to do is create an sources list specifically for security.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"-security"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/sources.list&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;-v&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"#"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/apt/security.sources.list
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that this is done we can simply continue to use the command below to
trigger security-only upgrades&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;upgrade&lt;span class="w"&gt; &lt;/span&gt;-o&lt;span class="w"&gt; &lt;/span&gt;Dir::Etc::SourceList&lt;span class="o"&gt;=&lt;/span&gt;/etc/apt/security.sources.list
&lt;/pre&gt;&lt;/div&gt;
&lt;div class="section" id="note"&gt;
&lt;h2&gt;Note&lt;/h2&gt;
&lt;p&gt;&lt;strong&gt;This will work until you upgrade your distro (e.g. 10.04 -&amp;gt; 12.04), at
which point you will need to re-run the first command to regenerate the
security.sources.list file.&lt;/strong&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apt"></category><category term="debian"></category><category term="security"></category><category term="ubuntu"></category><category term="upgrades"></category></entry><entry><title>Postfix + DK (DomainKeys) + DKIM + SPF on Debian 6/Ubuntu</title><link href="https://kura.gg/2011/09/17/postfix-dk-dkim-spf/" rel="alternate"></link><published>2011-09-17T18:18:00+01:00</published><updated>2011-09-17T18:18:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-17:/2011/09/17/postfix-dk-dkim-spf/</id><summary type="html">
&lt;p&gt;This is part 3 of my guide to getting a mail server configured with all
the sexy bits to improve deliverability, spam and virus protection.&lt;/p&gt;
&lt;p&gt;You can view &lt;a class="reference external" href="/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/"&gt;part 1 here&lt;/a&gt; and &lt;a class="reference external" href="/2011/09/16/postfix-spamassassin-clamav-procmail/"&gt;part 2 here&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="the-key-pair"&gt;
&lt;h2&gt;The key pair&lt;/h2&gt;
&lt;p&gt;We need to create a key pair to sign emails with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
.. code-block:: bash
&lt;/pre&gt;
&lt;blockquote&gt;
openssl genrsa -out private.key 1024
openssl rsa -in private.key -out public.key -pubout -outform &lt;span class="caps"&gt;PEM&lt;/span&gt;
sudo mkdir /etc/dk/
sudo cp private.key /etc/dk/dk.key&lt;/blockquote&gt;
&lt;p&gt;Now we can move on to &lt;span class="caps"&gt;DK&lt;/span&gt; and &lt;span class="caps"&gt;DKIM&lt;/span&gt; signing, make sure you keep the public
key for later.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="dkim"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;DKIM&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;First we’ll need to install an application to sign our emails.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;dkim-filter
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed we need to configure it, open up
&lt;strong&gt;/etc/default/dkim-filter&lt;/strong&gt;, modify the file to look like below
replacing &amp;lt;&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;&amp;gt; with the domain you want to sign email from.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"-l -o X-DomainKeys …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This is part 3 of my guide to getting a mail server configured with all
the sexy bits to improve deliverability, spam and virus protection.&lt;/p&gt;
&lt;p&gt;You can view &lt;a class="reference external" href="/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/"&gt;part 1 here&lt;/a&gt; and &lt;a class="reference external" href="/2011/09/16/postfix-spamassassin-clamav-procmail/"&gt;part 2 here&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="the-key-pair"&gt;
&lt;h2&gt;The key pair&lt;/h2&gt;
&lt;p&gt;We need to create a key pair to sign emails with:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
.. code-block:: bash
&lt;/pre&gt;
&lt;blockquote&gt;
openssl genrsa -out private.key 1024
openssl rsa -in private.key -out public.key -pubout -outform &lt;span class="caps"&gt;PEM&lt;/span&gt;
sudo mkdir /etc/dk/
sudo cp private.key /etc/dk/dk.key&lt;/blockquote&gt;
&lt;p&gt;Now we can move on to &lt;span class="caps"&gt;DK&lt;/span&gt; and &lt;span class="caps"&gt;DKIM&lt;/span&gt; signing, make sure you keep the public
key for later.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="dkim"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;DKIM&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;First we’ll need to install an application to sign our emails.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;dkim-filter
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed we need to configure it, open up
&lt;strong&gt;/etc/default/dkim-filter&lt;/strong&gt;, modify the file to look like below
replacing &amp;lt;&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;&amp;gt; with the domain you want to sign email from.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"-l -o X-DomainKeys,DomainKey-Signature"&lt;/span&gt;
&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$DAEMON_OPTS&lt;/span&gt;&lt;span class="s2"&gt; -d &amp;lt;DOMAIN&amp;gt; -k /etc/dk/dk.key -s mail"&lt;/span&gt;
&lt;span class="nv"&gt;SOCKET&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"inet:12345@localhost"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# listen on loopback on port 12345&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We use the &lt;strong&gt;-o&lt;/strong&gt; flag to tell the filter to ignore any DomainKeys
headers when signing.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="dk-domainkeys"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;DK&lt;/span&gt; (DomainKeys)&lt;/h2&gt;
&lt;p&gt;The dk-filter package is not installable from &lt;span class="caps"&gt;APT&lt;/span&gt; on Debian 6 for me,
try to install it using &lt;span class="caps"&gt;APT&lt;/span&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;dk-filter
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If it doesn’t work then install it by hand, go to
&lt;a class="reference external" href="https://ftp.us.debian.org/debian/pool/main/d/dk-milter/"&gt;https://ftp.us.debian.org/debian/pool/main/d/dk-milter/&lt;/a&gt; and download
the .deb file for your architecture. To install it run the command below
replacing &amp;lt;&lt;span class="caps"&gt;FILE&lt;/span&gt;&amp;gt; with the file you downloaded.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;FILE&amp;gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that it’s installed we can configure it, open up
&lt;strong&gt;/etc/default/dk-filter&lt;/strong&gt;, modify the file to look like below replacing
&amp;lt;&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;&amp;gt; with the domain you want to sign email from.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"-l -o DKIM-Signature,X-DKIM"&lt;/span&gt;
&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$DAEMON_OPTS&lt;/span&gt;&lt;span class="s2"&gt; -d &amp;lt;DOMAIN&amp;gt; -s /etc/dk/dk.key -S mail"&lt;/span&gt;
&lt;span class="nv"&gt;SOCKET&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"inet:12346@localhost"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# listen on loopback on port 12346&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We use the &lt;strong&gt;-o&lt;/strong&gt; flag to tell the filter to ignore any &lt;span class="caps"&gt;DKIM&lt;/span&gt; headers
when signing.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="spf"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SPF&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Install with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;postfix-policyd-spf-python
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="postfix"&gt;
&lt;h2&gt;Postfix&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/postfix/main.cf&lt;/strong&gt; and add the following lines to it&lt;/p&gt;
&lt;pre class="literal-block"&gt;
milter_default_action = accept
milter_protocol = 6
smtpd_milters = inet:localhost:12345 inet:localhost:12346
non_smtpd_milters = inet:localhost:12345 inet:localhost:12346
spf-policyd_time_limit = 3600s
&lt;/pre&gt;
&lt;p&gt;This tells Postfix to pass incoming and outgoing email through the &lt;span class="caps"&gt;DK&lt;/span&gt;
and &lt;span class="caps"&gt;DKIM&lt;/span&gt; filters, as well as mail that arrives from the queue, local
commands like sendmail and cleanup. It also sets a time limit on &lt;span class="caps"&gt;SPF&lt;/span&gt; checks.&lt;/p&gt;
&lt;p&gt;Add the following to &lt;em&gt;smtpd_recipient_restrictions =&lt;/em&gt; it should look
like this&lt;/p&gt;
&lt;pre class="literal-block"&gt;
smtpd_recipient_restrictions = permit_mynetworks,

permit_sasl_authenticated,
reject_unauth_destination,
reject_unknown_sender_domain,
check_policy_service unix:private/policy-spf
&lt;/pre&gt;
&lt;p&gt;Now open up &lt;strong&gt;/etc/postfix/master.cf&lt;/strong&gt; and add the following&lt;/p&gt;
&lt;pre class="literal-block"&gt;
policy-spf unix - n n - - spawn
    user=nobody argv=/usr/bin/policyd-spf
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="dns"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;DNS&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;We need to modify your &lt;span class="caps"&gt;DNS&lt;/span&gt; entries so that &lt;span class="caps"&gt;DK&lt;/span&gt; and &lt;span class="caps"&gt;DKIM&lt;/span&gt; actually work and
we also need to add &lt;span class="caps"&gt;SPF&lt;/span&gt; records.&lt;/p&gt;
&lt;p&gt;We need to create 3 &lt;span class="caps"&gt;TXT&lt;/span&gt; records, 1 for &lt;span class="caps"&gt;SPF&lt;/span&gt; and 2 for &lt;span class="caps"&gt;DK&lt;/span&gt;/&lt;span class="caps"&gt;DKIM&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Creating the &lt;span class="caps"&gt;SPF&lt;/span&gt; record is easy, create a new &lt;span class="caps"&gt;TXT&lt;/span&gt; record called
&lt;strong&gt;&amp;lt;&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;&amp;gt;.&lt;/strong&gt; e.g. &lt;strong&gt;syslog.tv.&lt;/strong&gt; with the following content. replacing
&amp;lt;&lt;span class="caps"&gt;IP&lt;/span&gt;&amp;gt; with the &lt;span class="caps"&gt;IP&lt;/span&gt; of your mail server.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
v=spf1 a mx ip4:&amp;lt;IP&amp;gt;
&lt;/pre&gt;
&lt;p&gt;The &lt;span class="caps"&gt;DK&lt;/span&gt; and &lt;span class="caps"&gt;DKIM&lt;/span&gt; records are a little trickier, first create a &lt;span class="caps"&gt;TXT&lt;/span&gt; record
with the following name &lt;strong&gt;_domainkey.&amp;lt;&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;&amp;gt;.&lt;/strong&gt; e.g.
&lt;strong&gt;_domainkey.syslog.tv&lt;/strong&gt; with the following content&lt;/p&gt;
&lt;pre class="literal-block"&gt;
t=y; o=-
&lt;/pre&gt;
&lt;p&gt;With &lt;strong&gt;t&lt;/strong&gt; set to &lt;strong&gt;y&lt;/strong&gt; it puts your &lt;span class="caps"&gt;DK&lt;/span&gt; and &lt;span class="caps"&gt;DKIM&lt;/span&gt; in test mode, just in-case.&lt;/p&gt;
&lt;p&gt;Now we need to create a second record called
&lt;strong&gt;mail._domainkey.&amp;lt;&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;&amp;gt;.&lt;/strong&gt; e.g. &lt;strong&gt;mail._domainkey.syslog.tv&lt;/strong&gt;,
you’ll need to copy the contents of the public key file we created
earlier. Open it up and copy everything between &lt;strong&gt;——-&lt;span class="caps"&gt;BEGIN&lt;/span&gt; &lt;span class="caps"&gt;PUBLIC&lt;/span&gt;
&lt;span class="caps"&gt;KEY&lt;/span&gt;——-&lt;/strong&gt; and &lt;strong&gt;——-&lt;span class="caps"&gt;END&lt;/span&gt; &lt;span class="caps"&gt;PUBLIC&lt;/span&gt; &lt;span class="caps"&gt;KEY&lt;/span&gt;——-&lt;/strong&gt; in to one long line. Once
done put it in the &lt;span class="caps"&gt;DNS&lt;/span&gt; record like below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
k=rsa; p=&amp;lt;KEY_CONTENT&amp;gt;
&lt;/pre&gt;
&lt;p&gt;like this&lt;/p&gt;
&lt;pre class="literal-block"&gt;
k=rsa; p=MIGfMA0GCSqGSIb3DQE ... snip ... 03hFbY5y2QbQIDAQAB
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="finally"&gt;
&lt;h2&gt;Finally&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/dk-filter&lt;span class="w"&gt; &lt;/span&gt;restart
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/dkim-filter&lt;span class="w"&gt; &lt;/span&gt;restart
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/postfix&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Try send an email to yourself, you should see both &lt;span class="caps"&gt;DK&lt;/span&gt; and &lt;span class="caps"&gt;DKIM&lt;/span&gt;
signatures in the source.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="/2011/09/16/postfix-spamassassin-clamav-procmail/"&gt;« Part 2 - Postfix + SpamAssassin + ClamAV + Procmail&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="/2011/09/22/spamassassin-razor-pyzor/"&gt;Part 4 - SpamAssassin + Razor + Pyzor »&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="dk"></category><category term="dkim"></category><category term="domainkeys"></category><category term="email"></category><category term="mail"></category><category term="postfix"></category><category term="spf"></category><category term="ubuntu"></category></entry><entry><title>Postfix + SpamAssassin + ClamAV + Procmail on Debian 6/Ubuntu</title><link href="https://kura.gg/2011/09/16/postfix-spamassassin-clamav-procmail/" rel="alternate"></link><published>2011-09-16T21:28:00+01:00</published><updated>2011-09-16T21:28:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-16:/2011/09/16/postfix-spamassassin-clamav-procmail/</id><summary type="html">
&lt;p&gt;This is part 2 of my series on mail servers on Debian 6/Ubuntu 10.04, it
should work on other versions of each though. &lt;a class="reference external" href="/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/"&gt;Part 1 is available here&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="spamassassin"&gt;
&lt;h2&gt;SpamAssassin&lt;/h2&gt;
&lt;p&gt;First off we’ll get SpamAssassin installed and configured.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;spamassassin
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We’ll be configuring SpamAssassin as a daemon that Postfix interfaces
with using &lt;strong&gt;spamc&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;SpamAssassin on Debian and Ubuntu runs as root which is &lt;span class="caps"&gt;NOT&lt;/span&gt; a good thing
so we’ll need to make some changes.&lt;/p&gt;
&lt;p&gt;We’ll add a group called &lt;strong&gt;spamd&lt;/strong&gt; with &lt;span class="caps"&gt;GID&lt;/span&gt;**5001**.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;groupadd&lt;span class="w"&gt; &lt;/span&gt;-g&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5001&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;spamd
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we add a user spamd with &lt;span class="caps"&gt;UID&lt;/span&gt; &lt;strong&gt;5001&lt;/strong&gt; and add it to the spamd
group, as well as set it’s home directory as &lt;strong&gt;/var/lib/spamassassin&lt;/strong&gt;
and make sure it has no shell access or &lt;span class="caps"&gt;SSH&lt;/span&gt; access.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;useradd&lt;span class="w"&gt; &lt;/span&gt;-u&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5001&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-g&lt;span class="w"&gt; &lt;/span&gt;spamd&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;/usr/sbin/nologin&lt;span class="w"&gt; &lt;/span&gt;-d&lt;span class="w"&gt; &lt;/span&gt;/var/lib/spamassassin&lt;span class="w"&gt; &lt;/span&gt;spamd
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This is part 2 of my series on mail servers on Debian 6/Ubuntu 10.04, it
should work on other versions of each though. &lt;a class="reference external" href="/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/"&gt;Part 1 is available here&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="spamassassin"&gt;
&lt;h2&gt;SpamAssassin&lt;/h2&gt;
&lt;p&gt;First off we’ll get SpamAssassin installed and configured.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;spamassassin
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We’ll be configuring SpamAssassin as a daemon that Postfix interfaces
with using &lt;strong&gt;spamc&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;SpamAssassin on Debian and Ubuntu runs as root which is &lt;span class="caps"&gt;NOT&lt;/span&gt; a good thing
so we’ll need to make some changes.&lt;/p&gt;
&lt;p&gt;We’ll add a group called &lt;strong&gt;spamd&lt;/strong&gt; with &lt;span class="caps"&gt;GID&lt;/span&gt;**5001**.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;groupadd&lt;span class="w"&gt; &lt;/span&gt;-g&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5001&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;spamd
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we add a user spamd with &lt;span class="caps"&gt;UID&lt;/span&gt; &lt;strong&gt;5001&lt;/strong&gt; and add it to the spamd
group, as well as set it’s home directory as &lt;strong&gt;/var/lib/spamassassin&lt;/strong&gt;
and make sure it has no shell access or &lt;span class="caps"&gt;SSH&lt;/span&gt; access.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;useradd&lt;span class="w"&gt; &lt;/span&gt;-u&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;5001&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-g&lt;span class="w"&gt; &lt;/span&gt;spamd&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;/usr/sbin/nologin&lt;span class="w"&gt; &lt;/span&gt;-d&lt;span class="w"&gt; &lt;/span&gt;/var/lib/spamassassin&lt;span class="w"&gt; &lt;/span&gt;spamd
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we make that users home directory.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/var/lib/spamassassin
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally change the permissions of that directory so the spamd user
can write there.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;spamd:spamd&lt;span class="w"&gt; &lt;/span&gt;/var/lib/spamassassin
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next up we have to enabled the daemon and configure it. Open up
&lt;strong&gt;/etc/default/spamassassin&lt;/strong&gt; and make the following changes.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;ENABLED&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;span class="nv"&gt;CRON&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will actually allow the spamassassin daemon to start. We also need
to configure it’s new home directory and more.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;SAHOME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"/var/lib/spamassassin/"&lt;/span&gt;
&lt;span class="nv"&gt;OPTIONS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"--create-prefs --max-children 5 --username spamd --helper-home-dir &lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;SAHOME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt; -s /var/log/spamd.log"&lt;/span&gt;
&lt;span class="nv"&gt;PIDFILE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="si"&gt;${&lt;/span&gt;&lt;span class="nv"&gt;SAHOME&lt;/span&gt;&lt;span class="si"&gt;}&lt;/span&gt;&lt;span class="s2"&gt;spamd.pid"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next up we’ll make some changes to &lt;strong&gt;/etc/spamassassin/local.cf&lt;/strong&gt;&lt;/p&gt;
&lt;pre class="literal-block"&gt;
rewrite_header Subject ***** SPAM _SCORE_ *****
report_safe 1

use_bayes 1
use_bayes_rules 1
bayes_auto_learn 1
&lt;/pre&gt;
&lt;p&gt;These changes will rewrite the email subject to show that it is spam and
add the spam score too, like this &lt;strong&gt;*&lt;/strong&gt; &lt;span class="caps"&gt;SPAM&lt;/span&gt; 6.0 &lt;strong&gt;*&lt;/strong&gt;,
report_safe will attach the spam email as a plain text attachment to
the email to filter out any bad stuff. The 3 bayes options enabled the
Bayesian classifier and enable auto learn functionality. For more info
on Bayesian cliassifier, go &lt;a class="reference external" href="https://en.wikipedia.org/wiki/Bayesian_spam_filtering"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;SpamAssassin is now configured but Postfix doesn’t know how to talk to
it, we’ll configure that later. Now on to…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="clamav"&gt;
&lt;h2&gt;ClamAV&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;clamsmtp&lt;span class="w"&gt; &lt;/span&gt;clamav-freshclam
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed you’ll have an &lt;span class="caps"&gt;SMTP&lt;/span&gt; wrapper for ClamAV installed and a
daemon that automatically updates your anti-virus database.&lt;/p&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/clamsmtpd.conf&lt;/strong&gt; and make the following changes&lt;/p&gt;
&lt;pre class="literal-block"&gt;
OutAddress: 10026
&lt;/pre&gt;
&lt;p&gt;and&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Listen: 127.0.0.1:10025
&lt;/pre&gt;
&lt;p&gt;Now we move on to…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="procmail"&gt;
&lt;h2&gt;Procmail&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;procmail
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we need to create &lt;strong&gt;/etc/procmailrc&lt;/strong&gt; and add the following to it&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;DROPPRIVS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;YES
&lt;span class="nv"&gt;ORGMAIL&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$HOME&lt;/span&gt;/Maildir
&lt;span class="nv"&gt;MAILDIR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$ORGMAIL&lt;/span&gt;
&lt;span class="nv"&gt;DEFAULT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nv"&gt;$ORGMAIL&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This tells Procmail to deliver email to your Maildir folder instead of /var/mail/&lt;/p&gt;
&lt;p&gt;And now to glue it all together!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="postfix"&gt;
&lt;h2&gt;Postfix&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/postfix/main.cf&lt;/strong&gt; and add the following lines&lt;/p&gt;
&lt;pre class="literal-block"&gt;
content_filter = scan:127.0.0.1:10025
receive_override_options = no_address_mappings
&lt;/pre&gt;
&lt;p&gt;This tells Postfix to scan content using ClamAV which is listening on
port 10025.&lt;/p&gt;
&lt;p&gt;Now add the following to tell Postfix to deliver mail locally using Procmail.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
mailbox_command = procmail -a "$EXTENSION"
&lt;/pre&gt;
&lt;p&gt;Next open up &lt;strong&gt;/etc/postfix/master.cf&lt;/strong&gt; and change&lt;/p&gt;
&lt;pre class="literal-block"&gt;
smtp inet n - - - - smtpd
&lt;/pre&gt;
&lt;p&gt;to&lt;/p&gt;
&lt;pre class="literal-block"&gt;
smtp inet n - - - - smtpd
    -o content_filter=spamassassin
&lt;/pre&gt;
&lt;p&gt;Then add the following lines to the end of the file&lt;/p&gt;
&lt;pre class="literal-block"&gt;
scan unix - - n - 16 smtp
    -o smtp_send_xforward_command=yes

127.0.0.1:10026 inet n - n - 16 smtpd
    -o content_filter=
    -o receive_override_options=no_unknown_recipient_checks,no_header_body_checks
    -o smtpd_helo_restrictions=
    -o smtpd_client_restrictions=
    -o smtpd_sender_restrictions=
    -o smtpd_recipient_restrictions=permit_mynetworks,reject
    -o mynetworks_style=host
    -o smtpd_authorized_xforward_hosts=127.0.0.0/8

spamassassin unix - n n - - pipe
    user=spamd argv=/usr/bin/spamc -f -e
    /usr/sbin/sendmail -oi -f ${sender} ${recipient}
&lt;/pre&gt;
&lt;p&gt;These changes tell Postfix to talk to ClamAV and SpamAssassin.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="finally"&gt;
&lt;h2&gt;Finally&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/spamassassin&lt;span class="w"&gt; &lt;/span&gt;restart
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/clamsmtp&lt;span class="w"&gt; &lt;/span&gt;restart
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/postfix&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That should be everything done, good luck!&lt;/p&gt;
&lt;dl class="docutils"&gt;
&lt;dt&gt;&lt;a class="reference external" href="/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/"&gt;« Part 1 - Postfix + Dovecot (&lt;span class="caps"&gt;IMAP&lt;/span&gt;/&lt;span class="caps"&gt;IMAPS&lt;/span&gt;) + &lt;span class="caps"&gt;SASL&lt;/span&gt; + Maildir&lt;/a&gt;&lt;/dt&gt;
&lt;dd&gt;&lt;a class="reference external" href="/2011/09/17/postfix-dk-dkim-spf/"&gt;Part 2 - Postfix + &lt;span class="caps"&gt;DK&lt;/span&gt; (DomainKeys) + &lt;span class="caps"&gt;DKIM&lt;/span&gt; + &lt;span class="caps"&gt;SPF&lt;/span&gt; »&lt;/a&gt;&lt;/dd&gt;
&lt;/dl&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="clamav"></category><category term="clamsmtp"></category><category term="debian"></category><category term="email"></category><category term="mail"></category><category term="postfix"></category><category term="procmail"></category><category term="spamassassin"></category><category term="ubuntu"></category></entry><entry><title>Postfix + Dovecot (IMAP/IMAPS) + SASL + Maildir on Debian 6/Ubuntu</title><link href="https://kura.gg/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/" rel="alternate"></link><published>2011-09-15T23:04:00+01:00</published><updated>2011-09-15T23:04:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-15:/2011/09/15/postfix-dovecot-imapimaps-sasl-maildir/</id><summary type="html">
&lt;p&gt;This guide is part 1 of what I plan will be a couple of guides that take
you through installing a base mail system, SpamAssassin, &lt;span class="caps"&gt;DKIM&lt;/span&gt; and much
more. Stay tuned.&lt;/p&gt;
&lt;p&gt;This guide was written for Debian 6 but should be the same or similar
for Debian 5 and Ubuntu 10.04 and above.&lt;/p&gt;
&lt;div class="section" id="the-installation"&gt;
&lt;h2&gt;The installation&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;dovecot-imapd&lt;span class="w"&gt; &lt;/span&gt;postfix&lt;span class="w"&gt; &lt;/span&gt;sasl2-bin&lt;span class="w"&gt; &lt;/span&gt;libsasl2-2&lt;span class="w"&gt; &lt;/span&gt;libsasl2-modules
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Choose “Internet site” when prompted and enter the fully qualified name
of your server.&lt;/p&gt;
&lt;p&gt;Once all this is done installing we’ll need to make some changes, first
off will be Postfix.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="postfix"&gt;
&lt;h2&gt;Postfix&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/postfix/main.cf&lt;/strong&gt; and add the following to the end of the file&lt;/p&gt;
&lt;pre class="literal-block"&gt;
home_mailbox = Maildir/
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname
broken_sasl_auth_clients = yes

smtpd_sender_restrictions = permit_sasl_authenticated,
    permit_mynetworks,

smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_unknown_sender_domain,
&lt;/pre&gt;
&lt;p&gt;Here we basically tell Postfix to store all email in maildir format in
the user’s home directory. We …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This guide is part 1 of what I plan will be a couple of guides that take
you through installing a base mail system, SpamAssassin, &lt;span class="caps"&gt;DKIM&lt;/span&gt; and much
more. Stay tuned.&lt;/p&gt;
&lt;p&gt;This guide was written for Debian 6 but should be the same or similar
for Debian 5 and Ubuntu 10.04 and above.&lt;/p&gt;
&lt;div class="section" id="the-installation"&gt;
&lt;h2&gt;The installation&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;dovecot-imapd&lt;span class="w"&gt; &lt;/span&gt;postfix&lt;span class="w"&gt; &lt;/span&gt;sasl2-bin&lt;span class="w"&gt; &lt;/span&gt;libsasl2-2&lt;span class="w"&gt; &lt;/span&gt;libsasl2-modules
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Choose “Internet site” when prompted and enter the fully qualified name
of your server.&lt;/p&gt;
&lt;p&gt;Once all this is done installing we’ll need to make some changes, first
off will be Postfix.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="postfix"&gt;
&lt;h2&gt;Postfix&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/postfix/main.cf&lt;/strong&gt; and add the following to the end of the file&lt;/p&gt;
&lt;pre class="literal-block"&gt;
home_mailbox = Maildir/
smtpd_sasl_auth_enable = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname
broken_sasl_auth_clients = yes

smtpd_sender_restrictions = permit_sasl_authenticated,
    permit_mynetworks,

smtpd_recipient_restrictions = permit_mynetworks,
    permit_sasl_authenticated,
    reject_unauth_destination,
    reject_unknown_sender_domain,
&lt;/pre&gt;
&lt;p&gt;Here we basically tell Postfix to store all email in maildir format in
the user’s home directory. We then enable &lt;span class="caps"&gt;SASL&lt;/span&gt; with and tell it to not
allow anonymous auth and, tell it the hostname and enabled broken &lt;span class="caps"&gt;SASL&lt;/span&gt;
auth clients, just in-case.&lt;/p&gt;
&lt;p&gt;The next section tells Postfix to allow users to send if they pass &lt;span class="caps"&gt;SASL&lt;/span&gt;
auth or are listed in the allowed networks section.&lt;/p&gt;
&lt;p&gt;Finally we set Postfix’s recipient rules where we allow our networks,
&lt;span class="caps"&gt;SASL&lt;/span&gt; auth and reject any unauthorised destinations and unknown senders.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="dovecot"&gt;
&lt;h2&gt;Dovecot&lt;/h2&gt;
&lt;p&gt;Open up &lt;strong&gt;/etc/dovecot/dovecot.conf&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Uncomment the &lt;span class="caps"&gt;IMAP&lt;/span&gt; and &lt;span class="caps"&gt;IMAPS&lt;/span&gt; protocols&lt;/p&gt;
&lt;pre class="literal-block"&gt;
protocols = imap imaps
&lt;/pre&gt;
&lt;p&gt;Next we configure the protocols, add the following lines just below the
protocols option&lt;/p&gt;
&lt;pre class="literal-block"&gt;
protocol imap {
    listen = *:143
    ssl_listen = *:993/
}
&lt;/pre&gt;
&lt;p&gt;Search through the file for “&lt;em&gt;mail_location =&lt;/em&gt;” without the quotes,
make sure it’s commented out and add the following below it:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
mail_location = maildir:~/Maildir/
&lt;/pre&gt;
&lt;p&gt;Now we need to search down the file and comment out everything within
the “&lt;em&gt;auth default&lt;/em&gt;” section and add the following below it&lt;/p&gt;
&lt;pre class="literal-block"&gt;
auth default {
    mechanisms = plain login
    passdb pam {
    }

    userdb passwd {
    }

    socket listen {
        client {
            path = /var/spool/postfix/private/auth
            mode = 0660
            user = postfix
            group = postfix
        }
    }
}
&lt;/pre&gt;
&lt;p&gt;Just to explain what we’ve done, we’ve enabled &lt;span class="caps"&gt;IMAP&lt;/span&gt; and &lt;span class="caps"&gt;IMAPS&lt;/span&gt; protocols
and configured the ports to be used, both ports are the standard ports.&lt;/p&gt;
&lt;p&gt;Next up we configure Dovecot to handle Maildir, just like with Postfix.&lt;/p&gt;
&lt;p&gt;And finally we set up our auth mechanism, specifying that it needs to do
so via Postfix.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="sasl"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SASL&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Open up the following file**/etc/default/saslauthd**, we need to modify
a couple of things. Set &lt;span class="caps"&gt;START&lt;/span&gt; to yes and &lt;span class="caps"&gt;MECHANISMS&lt;/span&gt; to pam.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nv"&gt;START&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;yes
&lt;span class="nv"&gt;MECHANISMS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"pam"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Due to the fact Postfix will be chrooted we need to make a few system
changes for &lt;span class="caps"&gt;SASL&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;First we remove the default &lt;span class="caps"&gt;SASL&lt;/span&gt; run location.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;rm&lt;span class="w"&gt; &lt;/span&gt;-r&lt;span class="w"&gt; &lt;/span&gt;/var/run/saslauthd/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we make one within the Postfix chroot.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;/var/spool/postfix/var/run/saslauthd
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Symlink it back to /var/run so things work.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;ln&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;/var/spool/postfix/var/run/saslauthd&lt;span class="w"&gt; &lt;/span&gt;/var/run
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Change the group for the directory we created.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chgrp&lt;span class="w"&gt; &lt;/span&gt;sasl&lt;span class="w"&gt; &lt;/span&gt;/var/spool/postfix/var/run/saslauthd
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And finally add the Postfix user to the &lt;span class="caps"&gt;SASL&lt;/span&gt; group.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;adduser&lt;span class="w"&gt; &lt;/span&gt;postfix&lt;span class="w"&gt; &lt;/span&gt;sasl
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="finally"&gt;
&lt;h2&gt;Finally&lt;/h2&gt;
&lt;p&gt;Now we just need to restart our services.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/dovecot&lt;span class="w"&gt; &lt;/span&gt;restart
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/postfix&lt;span class="w"&gt; &lt;/span&gt;restart
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/saslauthd&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If all went according to plan normal system users should now be able to
send and receive mail.&lt;/p&gt;
&lt;p&gt;&lt;a class="reference external" href="/2011/09/16/postfix-spamassassin-clamav-procmail/"&gt;Part 2 - Postfix + SpamAssassin + ClamAV + Procmail »&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="dovecot"></category><category term="email"></category><category term="imap"></category><category term="imaps"></category><category term="mail"></category><category term="maildir"></category><category term="postfix"></category><category term="sasl"></category><category term="ubuntu"></category></entry><entry><title>Installing kernel headers for current kernel version with ease on Debian/Ubuntu</title><link href="https://kura.gg/2011/09/15/installing-kernel-headers-for-current-kernel-version-with-ease-on-debianubuntu/" rel="alternate"></link><published>2011-09-15T13:30:00+01:00</published><updated>2011-09-15T13:30:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-09-15:/2011/09/15/installing-kernel-headers-for-current-kernel-version-with-ease-on-debianubuntu/</id><content type="html">&lt;p&gt;This is a simple one but I found out that there are people out there
that don’t know about it, so here we go.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;linux-headers-&lt;span class="k"&gt;$(&lt;/span&gt;uname&lt;span class="w"&gt; &lt;/span&gt;-r&lt;span class="k"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will install kernel headers for your current active kernel on Debian/Ubuntu.&lt;/p&gt;
</content><category term="tutorials"></category><category term="apt"></category><category term="apt-get"></category><category term="debian"></category><category term="headers"></category><category term="kernel"></category><category term="ubuntu"></category></entry><entry><title>nginx log real IP from Pound</title><link href="https://kura.gg/2011/08/10/nginx-log-real-ip-from-pound/" rel="alternate"></link><published>2011-08-10T12:34:00+01:00</published><updated>2011-08-10T12:34:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-08-10:/2011/08/10/nginx-log-real-ip-from-pound/</id><content type="html">&lt;p&gt;Recently I started using Pound as a load balancer to a cluster of nginx
servers and found my access logs were filled with the &lt;span class="caps"&gt;IP&lt;/span&gt; address of the
load balancer. I did some digging and found the correct way to “fix” this.&lt;/p&gt;
&lt;p&gt;First thing you need to do is make sure you remove X-Forwarded-For from Pound&lt;/p&gt;
&lt;pre class="literal-block"&gt;
ListenHTTP
    # ... snip ...
    # ... snip ...
    HeadRemove "X-Forwarded-For"
End
&lt;/pre&gt;
&lt;p&gt;Once this is done, reload Pound.&lt;/p&gt;
&lt;p&gt;Next you need nginx compiled with realip module -
&lt;a class="reference external" href="https://wiki.nginx.org/NginxHttpRealIpModule"&gt;https://wiki.nginx.org/NginxHttpRealIpModule&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;On Ubuntu/Debian servers this module comes by default, otherwise you may
have to compile it in yourself using the following option:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;--with-http_realip_module
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once this is all done modify your nginx vhosts and add the following 2 lines&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;set_real_ip_from&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;[IP]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;real_ip_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Where [&lt;span class="caps"&gt;IP&lt;/span&gt;] is the &lt;span class="caps"&gt;IP&lt;/span&gt; address of your load balancer.&lt;/p&gt;
&lt;p&gt;To configure this to work with Apache you need the mod_rpaf module.&lt;/p&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="load balancer"></category><category term="nginx"></category><category term="pound"></category><category term="reaip"></category><category term="x-forwarded-for"></category></entry><entry><title>Shared VMDKs on ESX vSphere</title><link href="https://kura.gg/2011/07/09/shared-vmdks-on-esx-vsphere/" rel="alternate"></link><published>2011-07-09T02:07:00+01:00</published><updated>2011-07-09T02:07:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-07-09:/2011/07/09/shared-vmdks-on-esx-vsphere/</id><summary type="html">&lt;p&gt;I’d first like to point out that although the VMDKs are shared between
hosts using a shared &lt;span class="caps"&gt;SCSI&lt;/span&gt; &lt;span class="caps"&gt;BUS&lt;/span&gt; they are not synched, meaning that if you
write to the mounted point on any machine it will not display on other
machines with the same mount point until you remount the drive.
Annoying, but understandable.&lt;/p&gt;
&lt;p&gt;To business.&lt;/p&gt;
&lt;p&gt;First off all machines that you want to share this &lt;span class="caps"&gt;VMDK&lt;/span&gt; with will need
to be &lt;span class="caps"&gt;OFFLINE&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Next up we create the &lt;span class="caps"&gt;VMDK&lt;/span&gt;, I find it easiest to do this by adding
hardware to an already existing machine, I’m going to use one that I
want the &lt;span class="caps"&gt;VMDK&lt;/span&gt; shared with to make it even simpler.&lt;/p&gt;
&lt;img alt="Create a new disk" src="/images/shared-vmdks-on-esx-vsphere1.png"/&gt;
&lt;p&gt;You will need to enable clustering features as shown below, this means
you cannot use thin provisioning.&lt;/p&gt;
&lt;img alt="Choose disk size" src="/images/shared-vmdks-on-esx-vsphere2.png"/&gt;
&lt;p&gt;You will need to add the &lt;span class="caps"&gt;VMDK&lt;/span&gt; to a new &lt;span class="caps"&gt;SCSI&lt;/span&gt; &lt;span class="caps"&gt;BUS&lt;/span&gt;, this will usually begin
with 1: or …&lt;/p&gt;</summary><content type="html">&lt;p&gt;I’d first like to point out that although the VMDKs are shared between
hosts using a shared &lt;span class="caps"&gt;SCSI&lt;/span&gt; &lt;span class="caps"&gt;BUS&lt;/span&gt; they are not synched, meaning that if you
write to the mounted point on any machine it will not display on other
machines with the same mount point until you remount the drive.
Annoying, but understandable.&lt;/p&gt;
&lt;p&gt;To business.&lt;/p&gt;
&lt;p&gt;First off all machines that you want to share this &lt;span class="caps"&gt;VMDK&lt;/span&gt; with will need
to be &lt;span class="caps"&gt;OFFLINE&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;Next up we create the &lt;span class="caps"&gt;VMDK&lt;/span&gt;, I find it easiest to do this by adding
hardware to an already existing machine, I’m going to use one that I
want the &lt;span class="caps"&gt;VMDK&lt;/span&gt; shared with to make it even simpler.&lt;/p&gt;
&lt;img alt="Create a new disk" src="/images/shared-vmdks-on-esx-vsphere1.png"/&gt;
&lt;p&gt;You will need to enable clustering features as shown below, this means
you cannot use thin provisioning.&lt;/p&gt;
&lt;img alt="Choose disk size" src="/images/shared-vmdks-on-esx-vsphere2.png"/&gt;
&lt;p&gt;You will need to add the &lt;span class="caps"&gt;VMDK&lt;/span&gt; to a new &lt;span class="caps"&gt;SCSI&lt;/span&gt; &lt;span class="caps"&gt;BUS&lt;/span&gt;, this will usually begin
with 1: or 2: depending on how many &lt;span class="caps"&gt;SCSI&lt;/span&gt; &lt;span class="caps"&gt;BUS&lt;/span&gt; you have connected already,
I’m using 1:0 as shown below.&lt;/p&gt;
&lt;p&gt;You will also need to set it’s &lt;span class="caps"&gt;MODE&lt;/span&gt; as “Independent” and “Persistent”.&lt;/p&gt;
&lt;img alt="Set disk mode" src="/images/shared-vmdks-on-esx-vsphere3.png"/&gt;
&lt;p&gt;Once the drive has been added it will appear in your &lt;span class="caps"&gt;VM&lt;/span&gt; hardware list
along with the new &lt;span class="caps"&gt;SCSI&lt;/span&gt; controller. Click on the controller to modify it
and set it as “Physical” as shown below.&lt;/p&gt;
&lt;img alt="New disk is added" src="/images/shared-vmdks-on-esx-vsphere4.png"/&gt;
&lt;p&gt;Once this is down, close out of the hardware panel and modify the other
VMs you wish this disk to be shared to, do exactly as above but adding
the existing &lt;span class="caps"&gt;VMDK&lt;/span&gt; to each &lt;span class="caps"&gt;VM&lt;/span&gt; rather than creating a new drive.&lt;/p&gt;
&lt;p&gt;When you’re finished, power on all of the machines and mount the device
as you normally would for your operating system.&lt;/p&gt;
</content><category term="tutorials"></category><category term="esx"></category><category term="iscsi"></category><category term="scsi"></category><category term="shared vmdk"></category><category term="vmdk"></category><category term="vmware"></category></entry><entry><title>Logging Google Analytics cookies with nginx</title><link href="https://kura.gg/2011/06/05/logging-google-analytics-cookies-with-nginx/" rel="alternate"></link><published>2011-06-05T20:41:00+01:00</published><updated>2011-06-05T20:41:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-06-05:/2011/06/05/logging-google-analytics-cookies-with-nginx/</id><summary type="html">&lt;p&gt;I was recently tasked with adding Google tracking cookies to our nginx
logging for a couple of sites. It was so it could be pushed through a
log processor.&lt;/p&gt;
&lt;p&gt;It turned out too be a little trickier than it would have been with
Apache, but the process itself is still quite simple.&lt;/p&gt;
&lt;p&gt;Open up the server definition you wish to add it to and add a custom log
format like below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
log_format g-a '$remote_addr - $remote_user [$time_local] ' '"$request" $status $body_bytes_sent ' '"$http_referer" "$http_user_agent" ' '"__utma=$cookie___utma;__utmb=$cookie___utmb;__utmc=$cookie___utmc;__utmv=$cookie___utmv;__utmz=$cookie_umtz"';
&lt;/pre&gt;
&lt;p&gt;This log format can then be added to your access log like below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/access.example.com.log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;g-a&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Reload nginx&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/nginx&lt;span class="w"&gt; &lt;/span&gt;reload
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If all goes well, you should see Google Analytics appearing in your
access logs like below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
1.1.1.1 - - [05/Jun/2011:20:35:50 +0100] "GET / HTTP …&lt;/pre&gt;</summary><content type="html">&lt;p&gt;I was recently tasked with adding Google tracking cookies to our nginx
logging for a couple of sites. It was so it could be pushed through a
log processor.&lt;/p&gt;
&lt;p&gt;It turned out too be a little trickier than it would have been with
Apache, but the process itself is still quite simple.&lt;/p&gt;
&lt;p&gt;Open up the server definition you wish to add it to and add a custom log
format like below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
log_format g-a '$remote_addr - $remote_user [$time_local] ' '"$request" $status $body_bytes_sent ' '"$http_referer" "$http_user_agent" ' '"__utma=$cookie___utma;__utmb=$cookie___utmb;__utmc=$cookie___utmc;__utmv=$cookie___utmv;__utmz=$cookie_umtz"';
&lt;/pre&gt;
&lt;p&gt;This log format can then be added to your access log like below:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/access.example.com.log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;g-a&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Reload nginx&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/nginx&lt;span class="w"&gt; &lt;/span&gt;reload
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If all goes well, you should see Google Analytics appearing in your
access logs like below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
1.1.1.1 - - [05/Jun/2011:20:35:50 +0100] "GET / HTTP/1.1" 200 368 "" "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/535.1 (KHTML, like Gecko) Chrome/13.0.782.1 Safari/535.1" "__utma=65957554.1846091937.1301339836.1306174686.1306258917.5;__utmb=-;__utmc=-;__utmv=-;__utmz=-"
&lt;/pre&gt;
</content><category term="tutorials"></category><category term="google analytics"></category><category term="logging"></category><category term="nginx"></category></entry><entry><title>SSH Tunnelling</title><link href="https://kura.gg/2011/02/14/ssh-tunnelling/" rel="alternate"></link><published>2011-02-14T20:37:00+00:00</published><updated>2011-02-14T20:37:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2011-02-14:/2011/02/14/ssh-tunnelling/</id><content type="html">&lt;p&gt;Quite a simple one:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;USER@INTERMEDIATE_DEVICE&lt;span class="w"&gt; &lt;/span&gt;-L&lt;span class="w"&gt; &lt;/span&gt;LOCAL_PORT:DESTINATION_DEVICE:DESTINATION_PORT&lt;span class="w"&gt; &lt;/span&gt;-N
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;strong&gt;-f&lt;/strong&gt; tells ssh to go to background
&lt;strong&gt;-L&lt;/strong&gt; binds a local port to a remote device and port
&lt;strong&gt;-N&lt;/strong&gt; tells ssh not to execute any commands&lt;/p&gt;
&lt;p&gt;So use this to tunnel from local port 8000 in to a remote machine on
port 22 you’d use&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;user@server.test.com&lt;span class="w"&gt; &lt;/span&gt;-L&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;8000&lt;/span&gt;:server.destination.com:22&lt;span class="w"&gt; &lt;/span&gt;-N
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once the tunnel is open you can use the following to ssh or scp data around&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;ssh&lt;span class="w"&gt; &lt;/span&gt;localhost&lt;span class="w"&gt; &lt;/span&gt;-p&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;8000&lt;/span&gt;
scp&lt;span class="w"&gt; &lt;/span&gt;-P&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;8000&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/path/to/local/file&lt;span class="w"&gt; &lt;/span&gt;user@localhost:~
scp&lt;span class="w"&gt; &lt;/span&gt;-P&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;8000&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;user@localhost:/path/to/remote/file&lt;span class="w"&gt; &lt;/span&gt;.
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I use ssh tunnels all the time to remote access and use one of our Solr
servers that is blocked behind a firewall.&lt;/p&gt;
</content><category term="tutorials"></category><category term="ssh"></category><category term="tunnel"></category></entry><entry><title>Debian/Ubuntu upgrade security packages only</title><link href="https://kura.gg/2010/12/13/debianubuntu-upgrade-security-packages-only/" rel="alternate"></link><published>2010-12-13T16:27:00+00:00</published><updated>2010-12-13T16:27:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-12-13:/2010/12/13/debianubuntu-upgrade-security-packages-only/</id><content type="html">&lt;p&gt;&lt;strong&gt;The command below no longer works, for an updated version that does
work and should continue to work (until you upgrade to a new distro
version e.g. 10.04 -&amp;gt; 12.04) please see `here`_.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Really simple, should work for most cases, I’ve not found anything wrong
with it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;aptitude&lt;span class="w"&gt; &lt;/span&gt;update&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;aptitude&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'?and(~U,~Asecurity)'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="apt-get"></category><category term="aptitude"></category><category term="security"></category><category term="update"></category><category term="upgrade"></category></entry><entry><title>Refresh Linux partition table online</title><link href="https://kura.gg/2010/10/20/refresh-linux-partition-table-online/" rel="alternate"></link><published>2010-10-20T17:17:00+01:00</published><updated>2010-10-20T17:17:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-10-20:/2010/10/20/refresh-linux-partition-table-online/</id><content type="html">
&lt;div class="section" id="if-the-device-is-not-mounted"&gt;
&lt;h2&gt;If the device is not mounted&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;blockdev&lt;span class="w"&gt; &lt;/span&gt;--rereadpt&lt;span class="w"&gt; &lt;/span&gt;DEVICE
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;E.g.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;blockdev&lt;span class="w"&gt; &lt;/span&gt;--rereadpt&lt;span class="w"&gt; &lt;/span&gt;/dev/sda
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="if-the-device-is-mounted"&gt;
&lt;h2&gt;If the device is mounted&lt;/h2&gt;
&lt;p&gt;Parted is awesome and does this job amazingly.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;parted
sudo&lt;span class="w"&gt; &lt;/span&gt;partprobe
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="linux"></category><category term="online"></category><category term="partition"></category></entry><entry><title>WordPress + nginx + Varnish + Apache 2</title><link href="https://kura.gg/2010/09/26/nginx-varnish-apache2/" rel="alternate"></link><published>2010-09-26T19:41:00+01:00</published><updated>2010-09-26T19:41:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-09-26:/2010/09/26/nginx-varnish-apache2/</id><summary type="html">
&lt;p&gt;Lately I’ve been doing a lot of work with Varnish, this includes testing
it within a load balanced environment, putting it behind nginx, putting
it in front of Solr, the list goes on.&lt;/p&gt;
&lt;p&gt;This blog post will hopefully give you an insight in to a simple way of
combining nginx, Varnish and Apache to create a powerful Wordpress
environment that can really take a hammering.&lt;/p&gt;
&lt;p&gt;I’m going to assume you already have Apache and nginx working together,
if not I suggest you read my other articles on these subjects to learn
how to combine them.&lt;/p&gt;
&lt;div class="section" id="installing-varnish"&gt;
&lt;h2&gt;Installing Varnish&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;varnish
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-apache"&gt;
&lt;h2&gt;Configuring Apache&lt;/h2&gt;
&lt;p&gt;I suggest binding Apache to port 81, this is easy to change, open the
following file in your favourite editor.&lt;/p&gt;
&lt;blockquote&gt;
/etc/apache2/ports.conf&lt;/blockquote&gt;
&lt;p&gt;Change the Listen and NameVirtualHost lines to:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;Listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;81&lt;/span&gt;
&lt;span class="nb"&gt;NameVirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;*:81
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will mean you need to go and change all …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Lately I’ve been doing a lot of work with Varnish, this includes testing
it within a load balanced environment, putting it behind nginx, putting
it in front of Solr, the list goes on.&lt;/p&gt;
&lt;p&gt;This blog post will hopefully give you an insight in to a simple way of
combining nginx, Varnish and Apache to create a powerful Wordpress
environment that can really take a hammering.&lt;/p&gt;
&lt;p&gt;I’m going to assume you already have Apache and nginx working together,
if not I suggest you read my other articles on these subjects to learn
how to combine them.&lt;/p&gt;
&lt;div class="section" id="installing-varnish"&gt;
&lt;h2&gt;Installing Varnish&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;varnish
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-apache"&gt;
&lt;h2&gt;Configuring Apache&lt;/h2&gt;
&lt;p&gt;I suggest binding Apache to port 81, this is easy to change, open the
following file in your favourite editor.&lt;/p&gt;
&lt;blockquote&gt;
/etc/apache2/ports.conf&lt;/blockquote&gt;
&lt;p&gt;Change the Listen and NameVirtualHost lines to:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;Listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;81&lt;/span&gt;
&lt;span class="nb"&gt;NameVirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;*:81
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will mean you need to go and change all of your virtualhost
definitions to work on port 81.&lt;/p&gt;
&lt;p&gt;Example below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;VirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;*:81&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ServerAdmin&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;webmaster@example.com
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ServerName&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;example.com
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;DocumentRoot&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/var/www/website&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;CustomLog&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/var/log/apache2/access.example.com.log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;combined
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ErrorLog&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/var/log/apache2/error.example.com.log&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/VirtualHost&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-varnish"&gt;
&lt;h2&gt;Configuring Varnish&lt;/h2&gt;
&lt;p&gt;Open the following file in your favourite editor&lt;/p&gt;
&lt;blockquote&gt;
/etc/varnish/default.vcl&lt;/blockquote&gt;
&lt;p&gt;First we define a backend&lt;/p&gt;
&lt;pre class="literal-block"&gt;
backend default {
    .host = "localhost";
    .port = "81";
}
&lt;/pre&gt;
&lt;p&gt;This defines a host, this should be pretty straight forward, we set the
host and port number to use.&lt;/p&gt;
&lt;p&gt;Next we define a list of allowed hosts, this is going to be used to
verify if the requester is allowed to use the &lt;span class="caps"&gt;PURGE&lt;/span&gt; request type, this
is used for purging pages on-the-fly and will be explained later.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
acl purge {
    "localhost";
}
&lt;/pre&gt;
&lt;p&gt;Next we set up our vcl_recv method, this is called when a request is received.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sub vcl_recv {
    set req.grace = 6h;

    if (req.request == "PURGE") {
        if(!client.ip ~ purge) {
            error 405 "Not allowed.";
        }

    purge("req.url ~ ^" req.url "$ &amp;amp;&amp;amp; req.http.host == "req.http.host);

    }

    if (req.url ~ ".(jpg|png|gif|gz|tgz|bz2|lzma|tbz)(?.*|)$") {
        remove req.http.Accept-Encoding;
    } elsif (req.http.Accept-Encoding ~ "gzip") {
        set req.http.Accept-Encoding = "gzip";
    } elsif (req.http.Accept-Encoding ~ "deflate") {
        set req.http.Accept-Encoding = "deflate";
    } else {
        remove req.http.Accept-Encoding;
    }

    if (req.url ~ "wp-(login|admin)") {
        return (pass);
    }

    if (req.request != "GET" &amp;amp;&amp;amp; req.request != "HEAD") {
        return (pass);
    }

    unset req.http.cookie;

    if (req.url ~ ".(jpeg|jpg|png|gif|ico|swf|js|css|txt|gz|zip|rar|bz2|tgz|tbz|html|htm|pdf|pls|torrent)(?.*|)$") {
        unset req.http.Authenticate;
        unset req.http.POSTDATA;
        set req.request = "GET";
        set req.url = regsub(req.url, "?.*$", "");
        return (lookup);
    }

}
&lt;/pre&gt;
&lt;p&gt;I should explain what the above method does.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;We set req.grace to 6 hours, this means that if the cache expires and
the backend is unreachable Varnish will continue using the cached
copy for 6 hours. The first if statement checks to see if the request
type is &lt;span class="caps"&gt;PURGE&lt;/span&gt;, if it is then it looks to see if the requester is in
the access list, if they are then it purges the requested page. More
on this later.&lt;/li&gt;
&lt;li&gt;The next if/elseif/else statement is for handling encoding, it should
be relatively straight forward.&lt;/li&gt;
&lt;li&gt;Next we look to see if the url is either wp-login or wp-admin, if it
is we tell Varnish to pass to the backend and exit the vcl_recv function.&lt;/li&gt;
&lt;li&gt;We then check to see if the request type is neither &lt;span class="caps"&gt;GET&lt;/span&gt; nor &lt;span class="caps"&gt;HEAD&lt;/span&gt;, if
not we pass to the backend and exit vcl_recv.&lt;/li&gt;
&lt;li&gt;Next we unset all cookies, this is required since Varnish will not
cache content when cookies are present.&lt;/li&gt;
&lt;li&gt;The final if statement checks to see if the url has a static content
extension, removes all &lt;span class="caps"&gt;HTTP&lt;/span&gt; Auth and &lt;span class="caps"&gt;POST&lt;/span&gt; data, sets the request type
to &lt;span class="caps"&gt;GET&lt;/span&gt; and removes all QUERY_STRING content from the &lt;span class="caps"&gt;URL&lt;/span&gt; if it is
static content.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Next is vcl_pipe and vcl_pass.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sub vcl_pipe {
    set bereq.http.connection = "close";
    if (req.http.X-Forwarded-For) {
        set bereq.http.X-Forwarded-For = req.http.X-Forwarded-For;
    } else {
        set bereq.http.X-Forwarded-For = regsub(client.ip, ":.*", "");
    }
}
sub vcl_pass {
    set bereq.http.connection = "close";
    if (req.http.X-Forwarded-For) {
        set bereq.http.X-Forwarded-For = req.http.X-Forwarded-For;
    } else {
        set bereq.http.X-Forwarded-For = regsub(client.ip, ":.*", "");
    }
}
&lt;/pre&gt;
&lt;p&gt;These methods are identical and simply pass our X-Forwarded-For headers
around, this is used within nginx and Apache for logging correct &lt;span class="caps"&gt;IP&lt;/span&gt;
addresses in the access logs.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sub vcl_fetch {
    set beresp.ttl = 1h;
    set req.grace = 6h;
    if (req.url ~ "wp-(login|admin)") {
        return (pass);
    }

    unset beresp.http.set-cookie;

    if (req.url ~ ".(jpeg|jpg|png|gif|ico|swf|js|css|txt|gz|zip|rar|bz2|tgz|tbz|html|htm|pdf|pls|torrent)$") {
        set beresp.ttl = 24h;
    }
}
&lt;/pre&gt;
&lt;p&gt;This method is where content is returned from Varnish back to nginx.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;First we set the &lt;span class="caps"&gt;TTL&lt;/span&gt; of the cache to 1 hour.&lt;/li&gt;
&lt;li&gt;We again set the grace period as above in vcl_recv,&lt;/li&gt;
&lt;li&gt;again we check for wp-login or wp-admin and drop out of the method if
it’s found, this stops admin pages being cached.&lt;/li&gt;
&lt;li&gt;Next we unset the Set-Cookie header&lt;/li&gt;
&lt;li&gt;and finally if we detect the url contains a static content extension
we set the &lt;span class="caps"&gt;TTL&lt;/span&gt; of the cache to 24 hours.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;And last but not least is vcl_deliver, this one simply adds some
X-Cache header information for debug purposes and can be ignored.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
sub vcl_deliver {
    if (obj.hits &amp;gt; 0) {
        set resp.http.X-Cache = "HIT";
        set resp.http.X-Cache-Hits = obj.hits;
    } else {
        set resp.http.X-Cache = "MISS";
    }
}
&lt;/pre&gt;
&lt;p&gt;Varnish is now configured.&lt;/p&gt;
&lt;p&gt;You can find a copy of my default.vcl file here -
&lt;a class="reference external" href="/files/syslog-varnish-default-vcl-26-sept-2010"&gt;/files/syslog-varnish-default-vcl-26-sept-2010&lt;/a&gt;&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-nginx"&gt;
&lt;h2&gt;Configuring nginx&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;example.com&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/access.example.com.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_disable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;msie6&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_comp_level&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_proxied&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;any&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_types&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/plain&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/css&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/x-javascript&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml+rss&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/javascript&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Set-Cookie&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://localhost:6081&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This nginx host config should be simple to those of you who’ve read my
other articles, if not then here’s a quick summary;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;listen and server_name are simply the port to listen on and the
domain name,&lt;/li&gt;
&lt;li&gt;gzip enables gzip,&lt;/li&gt;
&lt;li&gt;gzip_disable tells nginx not to gzip compress for &lt;span class="caps"&gt;IE6&lt;/span&gt;,&lt;/li&gt;
&lt;li&gt;gzip_static is on to enable compression of static content (jpeg, gif etc),&lt;/li&gt;
&lt;li&gt;gzip_comp_level is the level of compression, 1-9 (higher = more compressed)&lt;/li&gt;
&lt;li&gt;gzip_proxied is set to any to gzip proxied content&lt;/li&gt;
&lt;li&gt;and finally we set the types of files to gzip.&lt;/li&gt;
&lt;li&gt;Next we set up our location,&lt;/li&gt;
&lt;li&gt;disable proxy redirects&lt;/li&gt;
&lt;li&gt;set Host, X-Real-Ip and X-Forwarded-For headers&lt;/li&gt;
&lt;li&gt;pass back the Set-Cookie header&lt;/li&gt;
&lt;li&gt;and pass the connection over to Varnish.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="finishing-up"&gt;
&lt;h2&gt;Finishing up&lt;/h2&gt;
&lt;p&gt;Now we simply need to restart the services&lt;/p&gt;
&lt;blockquote&gt;
/etc/init.d/apache2 force-reload &amp;amp;&amp;amp; /etc/init.d/varnish restart &amp;amp;&amp;amp; /etc/init.d/nginx reload&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="testing"&gt;
&lt;h2&gt;Testing&lt;/h2&gt;
&lt;p&gt;Now you can browse your site and it should be going through nginx and
Varnish and only hitting Apache if the content is not cached or if
you’re using the WordPress admin panel or doing a &lt;span class="caps"&gt;POST&lt;/span&gt; request.&lt;/p&gt;
&lt;p&gt;You can test this with Live &lt;span class="caps"&gt;HTTP&lt;/span&gt; Headers extension for Firefox -
&lt;a class="reference external" href="https://addons.mozilla.org/en-US/firefox/addon/3829/"&gt;https://addons.mozilla.org/en-&lt;span class="caps"&gt;US&lt;/span&gt;/firefox/addon/3829/&lt;/a&gt; (this will only
work if you used my vcl_delivery method in your Varnish config).&lt;/p&gt;
&lt;p&gt;Go to a page on your site, refresh a few times, open up Live &lt;span class="caps"&gt;HTTP&lt;/span&gt;
Headers and refresh again, you should see the following&lt;/p&gt;
&lt;pre class="literal-block"&gt;
HTTP/1.1 200 OK
Server: nginx
... snip ...
Via: 1.1 varnish
X-Cache: HIT
X-Cache-Hits: &amp;lt;numeric value&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="nginx"></category><category term="varnish"></category><category term="wordpress"></category></entry><entry><title>Mounting a remote filesystem using sshfs</title><link href="https://kura.gg/2010/09/26/mounting-a-remote-filesystem-using-sshfs/" rel="alternate"></link><published>2010-09-26T01:55:00+01:00</published><updated>2010-09-26T01:55:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-09-26:/2010/09/26/mounting-a-remote-filesystem-using-sshfs/</id><content type="html">&lt;p&gt;First we need to install sshfs.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;sshfs&lt;span class="w"&gt; &lt;/span&gt;fuse-utils
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we make a mount point, I’m going to use a directory in my home
directory for this.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;mkd﻿ir&lt;span class="w"&gt; &lt;/span&gt;~/remote-content
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And now we simply mount our remote directory to it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sshfs&lt;span class="w"&gt; &lt;/span&gt;user@host:/path/to/location&lt;span class="w"&gt; &lt;/span&gt;~/remote-content
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It’s as simple as that.&lt;/p&gt;
</content><category term="tutorials"></category><category term="ssh"></category><category term="sshfs"></category></entry><entry><title>MySQL Master-Master-Slave-Slave Replication</title><link href="https://kura.gg/2010/09/04/mysql-master-master-slave-slave-replication/" rel="alternate"></link><published>2010-09-04T18:14:00+01:00</published><updated>2010-09-04T18:14:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-09-04:/2010/09/04/mysql-master-master-slave-slave-replication/</id><summary type="html">
&lt;div class="section" id="quick-introduction"&gt;
&lt;h2&gt;Quick introduction&lt;/h2&gt;
&lt;p&gt;My employers presented me with a challenge this week. The task was not
difficult in the end but to me it was an untried concept involving MySQL.&lt;/p&gt;
&lt;p&gt;I have never been a fan of MySQL and generally turn my nose at the
thought of using it, let alone replicating it etc.&lt;/p&gt;
&lt;p&gt;The task in question? Master -&amp;gt; Master -&amp;gt; Slave -&amp;gt; Slave replication.&lt;/p&gt;
&lt;p&gt;From this point forward I will expect you to have MySQL installed and
set-up as normal.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Master 1 will be known as Master 1 and Slave 2 with &lt;span class="caps"&gt;IP&lt;/span&gt; 10.1.1.1&lt;/li&gt;
&lt;li&gt;Master 2 will be known as Master 2 and Slave 1 with &lt;span class="caps"&gt;IP&lt;/span&gt; 10.1.1.2&lt;/li&gt;
&lt;li&gt;Slave 1 will be known as Slave 3 with &lt;span class="caps"&gt;IP&lt;/span&gt; 10.1.1.3&lt;/li&gt;
&lt;li&gt;and Slave 2 will be known as Slave 4 with &lt;span class="caps"&gt;IP&lt;/span&gt; 10.1.1.4&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="master-1"&gt;
&lt;h2&gt;Master 1&lt;/h2&gt;
&lt;p&gt;Modify your MySQL config file, usually named …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="quick-introduction"&gt;
&lt;h2&gt;Quick introduction&lt;/h2&gt;
&lt;p&gt;My employers presented me with a challenge this week. The task was not
difficult in the end but to me it was an untried concept involving MySQL.&lt;/p&gt;
&lt;p&gt;I have never been a fan of MySQL and generally turn my nose at the
thought of using it, let alone replicating it etc.&lt;/p&gt;
&lt;p&gt;The task in question? Master -&amp;gt; Master -&amp;gt; Slave -&amp;gt; Slave replication.&lt;/p&gt;
&lt;p&gt;From this point forward I will expect you to have MySQL installed and
set-up as normal.&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Master 1 will be known as Master 1 and Slave 2 with &lt;span class="caps"&gt;IP&lt;/span&gt; 10.1.1.1&lt;/li&gt;
&lt;li&gt;Master 2 will be known as Master 2 and Slave 1 with &lt;span class="caps"&gt;IP&lt;/span&gt; 10.1.1.2&lt;/li&gt;
&lt;li&gt;Slave 1 will be known as Slave 3 with &lt;span class="caps"&gt;IP&lt;/span&gt; 10.1.1.3&lt;/li&gt;
&lt;li&gt;and Slave 2 will be known as Slave 4 with &lt;span class="caps"&gt;IP&lt;/span&gt; 10.1.1.4&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="master-1"&gt;
&lt;h2&gt;Master 1&lt;/h2&gt;
&lt;p&gt;Modify your MySQL config file, usually named my.cnf or mysql.cnf&lt;/p&gt;
&lt;p&gt;Add the following lines to [mysqld]&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[mysqld]&lt;/span&gt;
&lt;span class="na"&gt;server-id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;1&lt;/span&gt;
&lt;span class="na"&gt;auto_increment_offset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;1&lt;/span&gt;
&lt;span class="na"&gt;auto_increment_increment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;2&lt;/span&gt;

&lt;span class="na"&gt;log-bin&lt;/span&gt;
&lt;span class="na"&gt;binlog-ignore-db&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;mysql&lt;/span&gt;
&lt;span class="na"&gt;binlog-ignore-db&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;test&lt;/span&gt;
&lt;span class="na"&gt;log-slave-updates&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save and close.&lt;/p&gt;
&lt;p&gt;You should note that I have included &lt;em&gt;auto_increment_offset*and
*auto_increment_increment&lt;/em&gt;. auto_increment_offset is the same as
server-id in my case, it does as the name suggests - offsets the auto
increment value. auto_increment_increment should be set to the number
of servers you have as masters, in this example we have 2.&lt;/p&gt;
&lt;p&gt;Open up a MySQL prompt and run the following query&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;GRANT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;REPLICATION&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;ON&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;TO&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'replication'&lt;/span&gt;&lt;span class="nv"&gt;@'10.1.1.2'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;IDENTIFIED&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;BY&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'password'&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now restart MySQL.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="master-2-slave-1"&gt;
&lt;h2&gt;Master 2 (Slave 1)&lt;/h2&gt;
&lt;p&gt;Modify your MySQL config file.&lt;/p&gt;
&lt;p&gt;Add the following in [mysqld]&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[mysqld]&lt;/span&gt;
&lt;span class="na"&gt;server-id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;2&lt;/span&gt;
&lt;span class="na"&gt;auto_increment_offset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;2&lt;/span&gt;
&lt;span class="na"&gt;auto_increment_increment&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;2&lt;/span&gt;

&lt;span class="na"&gt;log-bin&lt;/span&gt;
&lt;span class="na"&gt;binlog-ignore-db&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;mysql&lt;/span&gt;
&lt;span class="na"&gt;binlog-ignore-db&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;test&lt;/span&gt;
&lt;span class="na"&gt;log-slave-updates&lt;/span&gt;

&lt;span class="na"&gt;master-host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;10.1.1.1&lt;/span&gt;
&lt;span class="na"&gt;master-user&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;replication&lt;/span&gt;
&lt;span class="na"&gt;master-password&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;password&lt;/span&gt;
&lt;span class="na"&gt;master-port&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;3306&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save and restart MySQL.&lt;/p&gt;
&lt;p&gt;Now open a MySQL prompt and run the following queries&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;START&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;SHOW&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;STATUS&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Slave_IO_Running and Slave_SQL_Running must be set to &lt;strong&gt;Yes&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="master-1-slave-2"&gt;
&lt;h2&gt;Master 1 (Slave 2)&lt;/h2&gt;
&lt;p&gt;Open a MySQL prompt and run the following query&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;SHOW&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;MASTER&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;STATUS&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see a master record has been created.&lt;/p&gt;
&lt;p&gt;Now we need to configure Master 1 to run as Slave 2.&lt;/p&gt;
&lt;p&gt;Modify MySQL config and add the following lines to [mysqld]&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[mysqld]&lt;/span&gt;
&lt;span class="na"&gt;master-host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;10.1.1.2&lt;/span&gt;
&lt;span class="na"&gt;master-user&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;replication&lt;/span&gt;
&lt;span class="na"&gt;master-password&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;password&lt;/span&gt;
&lt;span class="na"&gt;master-port&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;3306&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save and restart MySQL.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="master-2"&gt;
&lt;h2&gt;Master 2&lt;/h2&gt;
&lt;p&gt;Open a MySQL prompt and run the following query&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;GRANT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;REPLICATION&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;ON&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;TO&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'replication'&lt;/span&gt;&lt;span class="nv"&gt;@'10.1.1.1'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;IDENTIFIED&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;BY&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'password'&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="master-1-1"&gt;
&lt;h2&gt;Master 1&lt;/h2&gt;
&lt;p&gt;Open a MySQL prompt and run the following queries&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;START&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;SHOW&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;STATUS&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Slave_IO_Running and Slave_SQL_Running must be set to &lt;strong&gt;Yes&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="slave-3-and-slave-4"&gt;
&lt;h2&gt;Slave 3 and Slave 4&lt;/h2&gt;
&lt;p&gt;Now that you have Master - Master replication set up it’s time to attach
the slaves.&lt;/p&gt;
&lt;p&gt;I am going to do the following&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;make Slave 3 slave of Master 1&lt;/li&gt;
&lt;li&gt;and Slave 4 a slave of Master 2.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class="section" id="master-1-2"&gt;
&lt;h2&gt;Master 1&lt;/h2&gt;
&lt;p&gt;Open a MySQL prompt and run the following query&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;GRANT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;REPLICATION&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;ON&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;TO&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'replication'&lt;/span&gt;&lt;span class="nv"&gt;@'10.1.1.3'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;IDENTIFIED&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;BY&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'password'&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="master-2-1"&gt;
&lt;h2&gt;Master 2&lt;/h2&gt;
&lt;p&gt;Open a MySQL prompt and run the following query&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;GRANT&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;REPLICATION&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;ON&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="p"&gt;.&lt;/span&gt;&lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;TO&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'replication'&lt;/span&gt;&lt;span class="nv"&gt;@'10.1.1.4'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;IDENTIFIED&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;BY&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'password'&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="slave-3"&gt;
&lt;h2&gt;Slave 3&lt;/h2&gt;
&lt;p&gt;Open your MySQL config file, under [mysqld] put the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[mysqld]&lt;/span&gt;
&lt;span class="na"&gt;server-id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;3&lt;/span&gt;

&lt;span class="na"&gt;master-host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;10.1.1.1&lt;/span&gt;
&lt;span class="na"&gt;master-user&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;replication&lt;/span&gt;
&lt;span class="na"&gt;master-password&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;password&lt;/span&gt;
&lt;span class="na"&gt;master-port&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;3306&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save and restart MySQL.&lt;/p&gt;
&lt;p&gt;Open a MySQL prompt and run the following queries&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;START&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;SHOW&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;STATUS&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Slave_IO_Running and Slave_SQL_Running must be set to &lt;strong&gt;Yes&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="slave-4"&gt;
&lt;h2&gt;Slave 4&lt;/h2&gt;
&lt;p&gt;Open your MySQL config file, under [mysqld] put the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;[mysql]&lt;/span&gt;
&lt;span class="na"&gt;server-id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;4&lt;/span&gt;

&lt;span class="na"&gt;master-host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;10.1.1.2&lt;/span&gt;
&lt;span class="na"&gt;master-user&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;replication&lt;/span&gt;
&lt;span class="na"&gt;master-password&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;password&lt;/span&gt;
&lt;span class="na"&gt;master-port&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;3306&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save and restart MySQL.&lt;/p&gt;
&lt;p&gt;Open a MySQL prompt and run the following queries&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;START&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;SHOW&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;SLAVE&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;STATUS&lt;/span&gt;&lt;span class="err"&gt;\&lt;/span&gt;&lt;span class="n"&gt;G&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Slave_IO_Running and Slave_SQL_Running must be set to &lt;strong&gt;Yes&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="mysql"></category><category term="replication"></category></entry><entry><title>Find and replace across multiple files</title><link href="https://kura.gg/2010/08/13/find-and-replace-across-multiple-files/" rel="alternate"></link><published>2010-08-13T19:19:00+01:00</published><updated>2010-08-13T19:19:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-08-13:/2010/08/13/find-and-replace-across-multiple-files/</id><content type="html">&lt;p&gt;I needed to quickly modify 500 hundred &lt;span class="caps"&gt;XML&lt;/span&gt; files, each was about &lt;span class="caps"&gt;10MB&lt;/span&gt; in
size, thankfully Linux makes that pretty fast and very easy.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;find&lt;span class="w"&gt; &lt;/span&gt;.&lt;span class="w"&gt; &lt;/span&gt;-name&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"*.xml"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-print&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;xargs&lt;span class="w"&gt; &lt;/span&gt;sed&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'s/FROM/TO/g'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;A semi “real world” example:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;find&lt;span class="w"&gt; &lt;/span&gt;.&lt;span class="w"&gt; &lt;/span&gt;-name&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"*.xml"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-print&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;xargs&lt;span class="w"&gt; &lt;/span&gt;sed&lt;span class="w"&gt; &lt;/span&gt;-i&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'s/foo/bar/g'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="find"></category><category term="sed"></category><category term="xargs"></category></entry><entry><title>Adding swap while the server is online with Debian and VMWare ESX</title><link href="https://kura.gg/2010/07/07/adding-swap-while-the-server-is-online-with-debian-and-vmware-esx/" rel="alternate"></link><published>2010-07-07T18:56:00+01:00</published><updated>2010-07-07T18:56:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-07-07:/2010/07/07/adding-swap-while-the-server-is-online-with-debian-and-vmware-esx/</id><summary type="html">
&lt;p&gt;Recently I had to install Oracle on a virtual machine but didn’t find
out until after I’d spun up of the machine that Oracle required at least
&lt;span class="caps"&gt;2GB&lt;/span&gt; of swap space, my machine did not have enough.&lt;/p&gt;
&lt;p&gt;Thankfully it’s quite simple to increase swap space, using VMWare &lt;span class="caps"&gt;ESX&lt;/span&gt;,
simple add a new drive to the machine as you normally would, I used &lt;span class="caps"&gt;5GB&lt;/span&gt;.&lt;/p&gt;
&lt;div class="section" id="detecting-the-new-scsi-drive-and-partitioning-it"&gt;
&lt;h2&gt;Detecting the new &lt;span class="caps"&gt;SCSI&lt;/span&gt; drive and partitioning it&lt;/h2&gt;
&lt;p&gt;This bit is simple, I’m going to assume you’re logged in as root.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"- - -"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/sys/class/scsi_host/**host0**/scan&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;fdisk&lt;span class="w"&gt; &lt;/span&gt;-l
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If host0 doesn’t work, try changing to host1, host2 etc.&lt;/p&gt;
&lt;p&gt;Now we need to format the drive, for me it was /dev/sdb.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;cfdisk&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create a new logical partition, set it’s type to &lt;strong&gt;82 Linux Swap&lt;/strong&gt; and
simply write the changes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-swap"&gt;
&lt;h2&gt;Adding swap&lt;/h2&gt;
&lt;p&gt;Next we simply add …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Recently I had to install Oracle on a virtual machine but didn’t find
out until after I’d spun up of the machine that Oracle required at least
&lt;span class="caps"&gt;2GB&lt;/span&gt; of swap space, my machine did not have enough.&lt;/p&gt;
&lt;p&gt;Thankfully it’s quite simple to increase swap space, using VMWare &lt;span class="caps"&gt;ESX&lt;/span&gt;,
simple add a new drive to the machine as you normally would, I used &lt;span class="caps"&gt;5GB&lt;/span&gt;.&lt;/p&gt;
&lt;div class="section" id="detecting-the-new-scsi-drive-and-partitioning-it"&gt;
&lt;h2&gt;Detecting the new &lt;span class="caps"&gt;SCSI&lt;/span&gt; drive and partitioning it&lt;/h2&gt;
&lt;p&gt;This bit is simple, I’m going to assume you’re logged in as root.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"- - -"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/sys/class/scsi_host/**host0**/scan&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;fdisk&lt;span class="w"&gt; &lt;/span&gt;-l
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If host0 doesn’t work, try changing to host1, host2 etc.&lt;/p&gt;
&lt;p&gt;Now we need to format the drive, for me it was /dev/sdb.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;cfdisk&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Create a new logical partition, set it’s type to &lt;strong&gt;82 Linux Swap&lt;/strong&gt; and
simply write the changes.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-swap"&gt;
&lt;h2&gt;Adding swap&lt;/h2&gt;
&lt;p&gt;Next we simply add the swap space to the machine and enable it, for me
it was /dev/sdb5&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkswap&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb5
sudo&lt;span class="w"&gt; &lt;/span&gt;swapon&lt;span class="w"&gt; &lt;/span&gt;/dev/sdb5
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Add on reboot&lt;/p&gt;
&lt;p&gt;And now we simply need to be sure to add the swap when the machine
reboots. Open the following file:&lt;/p&gt;
&lt;blockquote&gt;
/etc/fstab&lt;/blockquote&gt;
&lt;p&gt;And add&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/dev/sdb5 swap swap defaults 0 0
&lt;/pre&gt;
&lt;p&gt;Simple.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="swap"></category><category term="vmware"></category></entry><entry><title>Trigger command on filesystem changes with inotify + incron</title><link href="https://kura.gg/2010/07/03/trigger-command-on-filesystem-changes-with-inotify-incron/" rel="alternate"></link><published>2010-07-03T15:26:00+01:00</published><updated>2010-07-03T15:26:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-07-03:/2010/07/03/trigger-command-on-filesystem-changes-with-inotify-incron/</id><summary type="html">
&lt;p&gt;During a seemingly normal work day a colleague pointed out a problem to
me and asked if I had any solution.&lt;/p&gt;
&lt;p&gt;The problem was that they were trying to use InfoBright
(&lt;a class="reference external" href="https://www.infobright.com/"&gt;https://www.infobright.com/&lt;/a&gt;) for some data crunching, export the data
to &lt;span class="caps"&gt;CSV&lt;/span&gt; and then import in to MySQL. My first idea was to output the data
from InfoBright as &lt;span class="caps"&gt;SQL&lt;/span&gt; and pipe it directly in to MySQL, this turned out
to not be possible as the version of &lt;span class="caps"&gt;IB&lt;/span&gt; they were using only supported
output as &lt;span class="caps"&gt;CSV&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;This in itself wasn’t a problem, the problem lay with the fact that &lt;span class="caps"&gt;IB&lt;/span&gt;
would only output the file with 0660 permissions, and although both &lt;span class="caps"&gt;IB&lt;/span&gt;
and MySQL ran as user mysql and group mysql, MySQL itself flat out
refused to import the &lt;span class="caps"&gt;CSV&lt;/span&gt; file unless it was world readable (0664),
which was slightly annoying.&lt;/p&gt;
&lt;p&gt;If the &lt;span class="caps"&gt;CSV&lt;/span&gt; didn’t …&lt;/p&gt;</summary><content type="html">
&lt;p&gt;During a seemingly normal work day a colleague pointed out a problem to
me and asked if I had any solution.&lt;/p&gt;
&lt;p&gt;The problem was that they were trying to use InfoBright
(&lt;a class="reference external" href="https://www.infobright.com/"&gt;https://www.infobright.com/&lt;/a&gt;) for some data crunching, export the data
to &lt;span class="caps"&gt;CSV&lt;/span&gt; and then import in to MySQL. My first idea was to output the data
from InfoBright as &lt;span class="caps"&gt;SQL&lt;/span&gt; and pipe it directly in to MySQL, this turned out
to not be possible as the version of &lt;span class="caps"&gt;IB&lt;/span&gt; they were using only supported
output as &lt;span class="caps"&gt;CSV&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;This in itself wasn’t a problem, the problem lay with the fact that &lt;span class="caps"&gt;IB&lt;/span&gt;
would only output the file with 0660 permissions, and although both &lt;span class="caps"&gt;IB&lt;/span&gt;
and MySQL ran as user mysql and group mysql, MySQL itself flat out
refused to import the &lt;span class="caps"&gt;CSV&lt;/span&gt; file unless it was world readable (0664),
which was slightly annoying.&lt;/p&gt;
&lt;p&gt;If the &lt;span class="caps"&gt;CSV&lt;/span&gt; didn’t need to be instantly imported in to MySQL as soon as
it was generated then we could’ve just used &lt;span class="caps"&gt;CRON&lt;/span&gt; to change the file
permissions, but also this would’ve meant remembering which files needed
to be imported.&lt;/p&gt;
&lt;p&gt;So the answer lay in &lt;strong&gt;inotify&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;I could’ve written some C or Python to interface with inotify but I am
lazy, so I decided to just use incron.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;inotify&lt;span class="w"&gt; &lt;/span&gt;incron
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;Once installed we need to modify /etc/incron.allow to set which users
can actually use incron.&lt;/p&gt;
&lt;p&gt;I just choose the root user.&lt;/p&gt;
&lt;blockquote&gt;
/etc/incron.allow&lt;/blockquote&gt;
&lt;p&gt;Put the following in:&lt;/p&gt;
&lt;blockquote&gt;
root&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="using-incron"&gt;
&lt;h2&gt;Using incron&lt;/h2&gt;
&lt;p&gt;Now that root can actually set up incron tasks, as root you can use
incrontab just like you do crontab&lt;/p&gt;
&lt;div class="section" id="listing-incron-tasks"&gt;
&lt;h3&gt;Listing incron tasks&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;incrontab&lt;span class="w"&gt; &lt;/span&gt;-l
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-editing-tasks"&gt;
&lt;h3&gt;Adding/editing tasks&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;incrontab&lt;span class="w"&gt; &lt;/span&gt;-e
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="delete-all-tasks"&gt;
&lt;h3&gt;Delete all tasks&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;incrontab&lt;span class="w"&gt; &lt;/span&gt;-r
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;All incron tasks must be in the following format&lt;/p&gt;
&lt;pre class="literal-block"&gt;
&amp;lt;path&amp;gt; &amp;lt;mask&amp;gt; &amp;lt;command&amp;gt;
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="masks"&gt;
&lt;h3&gt;Masks&lt;/h3&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;IN_ACCESS&lt;/strong&gt; - File was accessed (read) (*)
&lt;strong&gt;IN_ATTRIB&lt;/strong&gt; - Metadata changed (permissions, timestamps, extended attributes, etc.) (*)
&lt;strong&gt;IN_CLOSE_WRITE&lt;/strong&gt; - File opened for writing was closed (*)
&lt;strong&gt;IN_CLOSE_NOWRITE&lt;/strong&gt; - File not opened for writing was closed (*)
&lt;strong&gt;IN_CLOSE&lt;/strong&gt; - Covers IN_CLOSE_WRITE and IN_CLOSE_NOWRITE
&lt;strong&gt;IN_CREATE&lt;/strong&gt; - File/directory created in watched directory (*)
&lt;strong&gt;IN_DELETE&lt;/strong&gt; - File/directory deleted from watched directory (*)
&lt;strong&gt;IN_DELETE_SELF&lt;/strong&gt; - Watched file/directory was itself deleted
&lt;strong&gt;IN_MODIFY&lt;/strong&gt; - File was modified (*)
&lt;strong&gt;IN_MOVE_SELF&lt;/strong&gt; - Watched file/directory was itself moved
&lt;strong&gt;IN_MOVED_FROM&lt;/strong&gt; - File moved out of watched directory (*)
&lt;strong&gt;IN_MOVED_TO&lt;/strong&gt; - File moved into watched directory (*)
&lt;strong&gt;IN_MOVE&lt;/strong&gt; - Covers IN_MOVED_FROM and IN_MOVED_TO
&lt;strong&gt;IN_OPEN&lt;/strong&gt; - File was opened (*)
&lt;strong&gt;IN_ALL_EVENTS&lt;/strong&gt; - All of the above&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;IN_DONT_FOLLOW&lt;/strong&gt; - Don’t dereference pathname if it is a symbolic link
&lt;strong&gt;IN_ONESHOT&lt;/strong&gt; - Monitor pathname for only one event
&lt;strong&gt;IN_ONLYDIR&lt;/strong&gt; - Only watch pathname if it is a directory&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;em&gt;When monitoring a directory, the masks marked with an asterisk (&lt;/em&gt;)
above can occur for files in the directory, in which case the name field
in the returned event data identifies the name of the file within the directory.*&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="command"&gt;
&lt;h3&gt;Command&lt;/h3&gt;
&lt;p&gt;Commands can be any system commands that the user has permissions to
use, but incron also has some symbols that can be accessed to use within
the commands.&lt;/p&gt;
&lt;blockquote&gt;
&lt;strong&gt;$$&lt;/strong&gt; - Dollar sign
&lt;strong&gt;$@&lt;/strong&gt; - Watched filesystem path
&lt;strong&gt;$#&lt;/strong&gt; - Event-related file name
&lt;strong&gt;$%&lt;/strong&gt; - Event flags (textually)
&lt;strong&gt;$&amp;amp;&lt;/strong&gt; - Event flags (numerically)&lt;/blockquote&gt;
&lt;p&gt;A simple way of testing incron would be to add a basic task on the root
users home directory.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/root/ IN_CREATE echo "$@$# $% $&amp;amp;"
&lt;/pre&gt;
&lt;p&gt;Open up a second root shell on the system and tail syslog&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;tail&lt;span class="w"&gt; &lt;/span&gt;-f&lt;span class="w"&gt; &lt;/span&gt;/var/log/syslog
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And simply create a random file on the system in /root/&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&amp;gt;test-incron
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see the following appear within syslog:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Jul 03 15:19:26 eurus incrond[5049]: (root) CMD (echo "/tmp/test-incron IN_CREATE 256")
&lt;/pre&gt;
&lt;p&gt;Success, you now have incron working.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="how-i-used-it"&gt;
&lt;h2&gt;How I used it&lt;/h2&gt;
&lt;p&gt;For me it meant I could set up one simple task to modify file access&lt;/p&gt;
&lt;pre class="literal-block"&gt;
/tmp/mysql-ib-exports/ IN_CREATE /bin/chmod 0664 $@$#
&lt;/pre&gt;
&lt;p&gt;This will instantly change permissions on created files to 0664,
allowing the &lt;span class="caps"&gt;CSV&lt;/span&gt; to be loaded directly in to MySQL.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="incron"></category><category term="infobright"></category><category term="inotify"></category><category term="mysql"></category></entry><entry><title>Using dpkg selections to backup and install packages</title><link href="https://kura.gg/2010/07/02/using-dpkg-selections-to-backup-and-install-packages/" rel="alternate"></link><published>2010-07-02T18:32:00+01:00</published><updated>2010-07-02T18:32:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-07-02:/2010/07/02/using-dpkg-selections-to-backup-and-install-packages/</id><summary type="html">
&lt;p&gt;Sometimes you want to be able to install packages on another machine
without the hassle of a long apt-get install command or having to write
down every single package you’ve installed.&lt;/p&gt;
&lt;p&gt;Luckily Debian has the wonderful dpkg which has 2 methods for generating
a list of installed packages and another for importing a list.&lt;/p&gt;
&lt;div class="section" id="generating-a-list-of-installed-packages"&gt;
&lt;h2&gt;Generating a list of installed packages&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;--get-selections&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;selections
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will generate a file called &lt;em&gt;selections&lt;/em&gt; which will contain
something like&lt;/p&gt;
&lt;pre class="literal-block"&gt;
... snip ...
adduser install
apache2 install
apache2-mpm-prefork install
apache2-utils install
apache2.2-bin install
apache2.2-common install
apt install
... snip...
&lt;/pre&gt;
&lt;p&gt;This is just a simple, plain text file so can be copied between servers.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installing-packages-from-an-exported-list"&gt;
&lt;h2&gt;Installing packages from an exported list&lt;/h2&gt;
&lt;p&gt;This is almost just as easy, first we need to actually set the list of
selected packages&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;--set-selections&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;selections
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then we need to actually do an update and install&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;update&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo …&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Sometimes you want to be able to install packages on another machine
without the hassle of a long apt-get install command or having to write
down every single package you’ve installed.&lt;/p&gt;
&lt;p&gt;Luckily Debian has the wonderful dpkg which has 2 methods for generating
a list of installed packages and another for importing a list.&lt;/p&gt;
&lt;div class="section" id="generating-a-list-of-installed-packages"&gt;
&lt;h2&gt;Generating a list of installed packages&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;--get-selections&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;selections
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will generate a file called &lt;em&gt;selections&lt;/em&gt; which will contain
something like&lt;/p&gt;
&lt;pre class="literal-block"&gt;
... snip ...
adduser install
apache2 install
apache2-mpm-prefork install
apache2-utils install
apache2.2-bin install
apache2.2-common install
apt install
... snip...
&lt;/pre&gt;
&lt;p&gt;This is just a simple, plain text file so can be copied between servers.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installing-packages-from-an-exported-list"&gt;
&lt;h2&gt;Installing packages from an exported list&lt;/h2&gt;
&lt;p&gt;This is almost just as easy, first we need to actually set the list of
selected packages&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;dpkg&lt;span class="w"&gt; &lt;/span&gt;--set-selections&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;selections
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Then we need to actually do an update and install&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;update&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;-u&lt;span class="w"&gt; &lt;/span&gt;dselect-upgrade
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This last command will update your apt cache and then install all of the
selected packages.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Please note that version numbers are **not*&lt;/em&gt; remembered so you will
install the latest version of each package.*&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apt"></category><category term="backup"></category><category term="dpkg"></category><category term="packages"></category></entry><entry><title>New syslog.tv nginx wordpress site configuration explained</title><link href="https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/" rel="alternate"></link><published>2010-04-18T12:51:00+01:00</published><updated>2010-04-18T12:51:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-04-18:/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/</id><summary type="html">
&lt;div class="section" id="configuration-changes"&gt;
&lt;h2&gt;Configuration changes&lt;/h2&gt;
&lt;p&gt;I made some modifications to my nginx configuration this weekend to
improve performance and clear up some bugs.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;upstream&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backend&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;127.0.0.1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;81&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=120s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/access.syslog.tv.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_disable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;msie6&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_comp_level&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_proxied&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;any&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_types&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/plain&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/css&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/x-javascript&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/xml&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="s"&gt;application/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml+rss&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/javascript&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$wordpress_logged_in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author_email&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"wordpress_logged_in_[^=]*=([^%]+)%7C")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$wordpress_logged_in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;wordpress_logged_in_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_email_[^=]*=([^&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;]+)(&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;|$)")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author_email&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;comment_author_email_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_[^=]*=([^&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;]+)(&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;|$)")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;comment_author_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$my_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$scheme://$host$uri$is_args$args$wordpress_logged_in$comment_author_email$comment_author"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;client_max_body_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;8m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Set-Cookie&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$my_cache_key&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;302&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;60m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;404&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://backend&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.(jpg|png|gif|jpeg|js|css …&lt;/span&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="configuration-changes"&gt;
&lt;h2&gt;Configuration changes&lt;/h2&gt;
&lt;p&gt;I made some modifications to my nginx configuration this weekend to
improve performance and clear up some bugs.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;upstream&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backend&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;127.0.0.1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;81&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=120s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/access.syslog.tv.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_disable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;msie6&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_comp_level&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_proxied&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;any&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_types&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/plain&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/css&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/x-javascript&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/xml&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="s"&gt;application/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml+rss&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/javascript&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;   &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$wordpress_logged_in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author_email&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"wordpress_logged_in_[^=]*=([^%]+)%7C")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;             &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$wordpress_logged_in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;wordpress_logged_in_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_email_[^=]*=([^&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;]+)(&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;|$)")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author_email&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;comment_author_email_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_[^=]*=([^&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;]+)(&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="kn"&gt;|$)")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;comment_author_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$my_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$scheme://$host$uri$is_args$args$wordpress_logged_in$comment_author_email$comment_author"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;client_max_body_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;8m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Set-Cookie&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$my_cache_key&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;302&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;60m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;404&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://backend&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.(jpg|png|gif|jpeg|js|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Sadly Wordpress messes up the config when displayed like that so you can
view the proper version &lt;a class="reference external" href="/satic/files/syslog-nginx-config-18-apr-2010"&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="explanation"&gt;
&lt;h2&gt;Explanation&lt;/h2&gt;
&lt;p&gt;It’d be a good idea to actually explain what the configuration is doing
and why it’s configured that way, I’ll do this “chunk-by-chunk”.&lt;/p&gt;
&lt;div class="section" id="upstream"&gt;
&lt;h3&gt;upstream&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;upstream&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;backend&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;127.0.0.1&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;81&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=120s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This one is relatively simple, it basically configures an upstream proxy
to 127.0.0.1 on port 81, fail_timeout controls how long nginx will try
talking to that server before giving up.&lt;/p&gt;
&lt;p&gt;I’ll assume you understand the basic listen, server_name and
access_log parameters in the first section of the server definition.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="gzip"&gt;
&lt;h3&gt;gzip&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;gzip&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;gzip_disable&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;msie6&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;gzip_static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;gzip_comp_level&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;9&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;gzip_proxied&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;any&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;gzip_types&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/plain&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/css&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/x-javascript&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/xml&lt;/span&gt;
&lt;span class="s"&gt;application/xml&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;application/xml+rss&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;text/javascript&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Again, this one is rather simple. We enabled &lt;span class="caps"&gt;GZIP&lt;/span&gt;, disable it for anyone
still using &lt;span class="caps"&gt;IE6&lt;/span&gt;, we explicitly enable &lt;span class="caps"&gt;GZIP&lt;/span&gt; compression of static files,
set the compression level to 9 which is the highest level but also uses
the most resource, tell &lt;span class="caps"&gt;GZIP&lt;/span&gt; to compress any proxied data and then set
the mimetypes which &lt;span class="caps"&gt;GZIP&lt;/span&gt; is allowed to compress.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="location"&gt;
&lt;h3&gt;location&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="k"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$wordpress_logged_in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author_email&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;""&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"wordpress_logged_in_[^=]*=([^%]+)%7C")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$wordpress_logged_in&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;wordpress_logged_in_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_email_[^=]*=([^&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="k"&gt;]+)(&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="k"&gt;|$)")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author_email&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;comment_author_email_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_[^=]*=([^&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="k"&gt;]+)(&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="k"&gt;|$)")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$comment_author&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;comment_author_&lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is a rather large chunk but is very simple once you understand it.
I’m setting up my document root, then setting some basic variables for
“” so that I can overwrite them further down. This is actually by the
following set of three if statements. I check for three different &lt;span class="caps"&gt;HTTP&lt;/span&gt;
cookies and then set the relevant variable to the correct value if it
exists, this is later used in the cache key to make sure each user has
their own private cache if they have certain cookies.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="my-cache-key"&gt;
&lt;h3&gt;$my_cache_key&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$my_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$scheme://$host$uri$is_args$args$wordpress_logged_in$comment_author_email$comment_author"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This sets up a variable called $my_cache_key which contains the
current scheme (&lt;span class="caps"&gt;HTTP&lt;/span&gt; or &lt;span class="caps"&gt;HTTPS&lt;/span&gt;), host (syslog.tv), uri, various arguments
and then finally sets the variables from the previous block from the
cookie checks.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="proxy-time"&gt;
&lt;h3&gt;Proxy time!&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;client_max_body_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;8m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="k"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_pass_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Set-Cookie&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$my_cache_key&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;302&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;60m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;404&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://backend&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here I am setting the maximum size of the client body content to &lt;span class="caps"&gt;8MB&lt;/span&gt;,
disabling proxy redirects, passing through some basic headers to the
backend which allows my backend system to see which host the user is
trying to access, their real &lt;span class="caps"&gt;IP&lt;/span&gt; address rather than the &lt;span class="caps"&gt;IP&lt;/span&gt; of the nginx
server and x-Forwarded-For also contains the users &lt;span class="caps"&gt;IP&lt;/span&gt; address, it’s
basically standard when proxying.&lt;/p&gt;
&lt;p&gt;Next I pass Set-Cookie headers back to the backend, tell it to use a
cache definition called “cache” which I set up in a &lt;a class="reference external" href="/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/"&gt;previous blog
post&lt;/a&gt;. I set the proxy_cache_key to use the variable defined earlier
contains all of the users cookie information in it’s key to make it a
private cache.&lt;/p&gt;
&lt;p&gt;I then pass through some basic validation rules that set &lt;span class="caps"&gt;HTTP&lt;/span&gt; 200 and
302 responses to cache for 60 minutes and 404 responses to cache for 1
minute, then I simply pass back to the backend system.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="static-location-block"&gt;
&lt;h3&gt;Static location block&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.(jpg|png|gif|jpeg|js|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This one could look a little scary but is actually really simple. I do a
location check again some defined extensions, if it matches then it will
simply serve these up from nginx rather than reverse proxy.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="in-layman-s-terms"&gt;
&lt;h2&gt;In layman’s terms&lt;/h2&gt;
&lt;p&gt;Although possibly daunting it really is quite simple, I am configuring
nginx to reverse proxy back to Apache on port 81, setting up some &lt;span class="caps"&gt;GZIP&lt;/span&gt;
compression rules to decrease the size of static files, checking to see
if a user has a WordPress cookie and giving them a private cache if they
do, serving dynamic (&lt;span class="caps"&gt;PHP&lt;/span&gt;) content via the reverse proxy to Apache if no
cache exists, serving cached content from nginx and also serving static
content from nginx.&lt;/p&gt;
&lt;p&gt;This basically means that Apache is used very sparingly and nginx is
doing what it does best, serving static/cached content.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="cache"></category><category term="nginx"></category><category term="proxy"></category><category term="proxy_cache"></category><category term="wordpress"></category></entry><entry><title>Convert PEM &amp; Key to a single PKCS#12 file</title><link href="https://kura.gg/2010/04/13/convert-pem-key-to-a-single-pkcs12-file/" rel="alternate"></link><published>2010-04-13T19:19:00+01:00</published><updated>2010-04-13T19:19:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-04-13:/2010/04/13/convert-pem-key-to-a-single-pkcs12-file/</id><content type="html">&lt;p&gt;Sometimes keeping multiple copies of keys, certificates and root
certificates can be a real annoyance, thankfully it’s quite simple to
convert them in to a single &lt;span class="caps"&gt;PKCS&lt;/span&gt;#12 file with the following command.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;pkcs12&lt;span class="w"&gt; &lt;/span&gt;-export&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;certificate.pkcs&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;certificate.crt&lt;span class="w"&gt; &lt;/span&gt;-inkey&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;-certfile&lt;span class="w"&gt; &lt;/span&gt;rootcert.crt&lt;span class="w"&gt; &lt;/span&gt;-name&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"PKCS#12 Certificate Bundle"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will create a file called &lt;strong&gt;certificate.pkcs&lt;/strong&gt; which will contain
the contents of the &lt;strong&gt;certificate.crt&lt;/strong&gt;, &lt;strong&gt;private.key&lt;/strong&gt; and your root
certificate &lt;strong&gt;rootcert.crt&lt;/strong&gt;, it will also have an internal reference to
it’s name &lt;strong&gt;&lt;span class="caps"&gt;PKCS&lt;/span&gt;#12 Certificate Bundle&lt;/strong&gt; to make it easier to inspect
the certificate to find what it should contain, usually you’d set this
to something more useful.&lt;/p&gt;
</content><category term="tutorials"></category><category term="crt"></category><category term="openssl"></category><category term="pem"></category><category term="pkcs12"></category><category term="ssl"></category></entry><entry><title>Building nginx on Red Hat and Debian to RPM/DEB-style locations</title><link href="https://kura.gg/2010/04/02/building-nginx-on-red-hat-and-debian-to-rpmdeb-style-locations/" rel="alternate"></link><published>2010-04-02T16:54:00+01:00</published><updated>2010-04-02T16:54:00+01:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-04-02:/2010/04/02/building-nginx-on-red-hat-and-debian-to-rpmdeb-style-locations/</id><summary type="html">
&lt;p&gt;The title of this post is a bit stupid, but I honestly couldn’t think of
any other way to write it…&lt;/p&gt;
&lt;p&gt;When compiling nginx by hand, by default make install will push the
binaries out to /usr/local/nginx and it doesn’t come with a start/stop
script, understandably because it doesn’t know which &lt;span class="caps"&gt;OS&lt;/span&gt; it is going to
be installed on etc etc.&lt;/p&gt;
&lt;p&gt;Recently I was tasked with building nginx to an old Red Hat Enterprise
Live 4 server with no yum installation, no nginx package in up2date and
not being able to find an &lt;span class="caps"&gt;RPM&lt;/span&gt; that’s link wasn’t dead.&lt;/p&gt;
&lt;p&gt;I’ve always felt that, being a Debian user, people think of me as only
being able to use apt-get and if I’m feeling especially adventurous dpkg
- to install applications. Some people know that I build .deb files in
my spare time, but …&lt;/p&gt;</summary><content type="html">
&lt;p&gt;The title of this post is a bit stupid, but I honestly couldn’t think of
any other way to write it…&lt;/p&gt;
&lt;p&gt;When compiling nginx by hand, by default make install will push the
binaries out to /usr/local/nginx and it doesn’t come with a start/stop
script, understandably because it doesn’t know which &lt;span class="caps"&gt;OS&lt;/span&gt; it is going to
be installed on etc etc.&lt;/p&gt;
&lt;p&gt;Recently I was tasked with building nginx to an old Red Hat Enterprise
Live 4 server with no yum installation, no nginx package in up2date and
not being able to find an &lt;span class="caps"&gt;RPM&lt;/span&gt; that’s link wasn’t dead.&lt;/p&gt;
&lt;p&gt;I’ve always felt that, being a Debian user, people think of me as only
being able to use apt-get and if I’m feeling especially adventurous dpkg
- to install applications. Some people know that I build .deb files in
my spare time, but most don’t and for some weird reason I still feel
they think that about me. Paranoia?&lt;/p&gt;
&lt;p&gt;Anyway, I decided to do it the old fashioned way and build nginx from
source on the &lt;span class="caps"&gt;RHEL4&lt;/span&gt; box, simple tasks if you know how to do it correctly.&lt;/p&gt;
&lt;div class="section" id="brief-introduction-of-what-s-to-come"&gt;
&lt;h2&gt;Brief introduction of what’s to come&lt;/h2&gt;
&lt;p&gt;In this article I will explain the build process, options I pass to
configure and also provide a start/stop script for &lt;span class="caps"&gt;RHEL4&lt;/span&gt;, 5 and Debian.&lt;/p&gt;
&lt;p&gt;The build process can be found on the nginx wiki and is a very simple
thing, but I passed some different arguments to do the follow;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;Install all modules that I wanted&lt;/li&gt;
&lt;li&gt;Build to /usr/bin, store config files in /etc/nginx, add
sites-available, sites-enabled folders and logs to /var/log/nginx&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;I’m going to assume you have the latest 0.7.X or even 0.8.X source
already downloaded, untarred and also have gcc and all other required
build modules installed.&lt;/p&gt;
&lt;p&gt;You’ll need to be in your source directory to execute the following commands.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;First we will add a www-data user and group to run as. You may already
have this set up for you if you’ve already installed Apache or nginx
from yum or apt in the past.&lt;/p&gt;
&lt;p&gt;To check to see if you already have a www-data user run the following
command as root.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;grep&lt;span class="w"&gt; &lt;/span&gt;www-data&lt;span class="w"&gt; &lt;/span&gt;/etc/passwd
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should see the following output, the at signs (@) represent a number.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
www-data:x:@@:@@:www-data:/var/www:/bin/sh
&lt;/pre&gt;
&lt;p&gt;If you don’t see this user then we will need to create it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;useradd&lt;span class="w"&gt; &lt;/span&gt;-d&lt;span class="w"&gt; &lt;/span&gt;/var/www&lt;span class="w"&gt; &lt;/span&gt;-m&lt;span class="w"&gt; &lt;/span&gt;-U&lt;span class="w"&gt; &lt;/span&gt;www-data
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The -d argument sets the user’s home directory to /var/www, -m creates
the home directory if it does not exist and -U will create a group with
the same name as the user.&lt;/p&gt;
&lt;p&gt;I install nginx with both &lt;span class="caps"&gt;SSL&lt;/span&gt; and rewrite enabled, both of these modules
require some extra modules install on your system.&lt;/p&gt;
&lt;div class="section" id="ssl"&gt;
&lt;h3&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt;&lt;/h3&gt;
&lt;div class="section" id="debian"&gt;
&lt;h4&gt;Debian&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;libssl-dev
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="redhat-yum"&gt;
&lt;h4&gt;RedHat (yum)&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;yum&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;libssl-dev
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you don’t have yum installed you will either need to find an &lt;span class="caps"&gt;RPM&lt;/span&gt; or
install openssl from source (&lt;a class="reference external" href="https://www.openssl.org/source/"&gt;https://www.openssl.org/source/&lt;/a&gt;)&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="rewrite-module"&gt;
&lt;h3&gt;Rewrite module&lt;/h3&gt;
&lt;div class="section" id="debian-1"&gt;
&lt;h4&gt;Debian&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;libpcre3&lt;span class="w"&gt; &lt;/span&gt;libpcre3-dev
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="redhat-yum-1"&gt;
&lt;h4&gt;RedHat (yum)&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;yum&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;libpcre-dev
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Or compile from source (&lt;a class="reference external" href="https://www.pcre.org/"&gt;https://www.pcre.org/&lt;/a&gt;)&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring"&gt;
&lt;h3&gt;Configuring&lt;/h3&gt;
&lt;p&gt;Next we will configure the source&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;./configure&lt;span class="w"&gt; &lt;/span&gt;--sbin-path&lt;span class="o"&gt;=&lt;/span&gt;/usr/bin/nginx&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--conf-path&lt;span class="o"&gt;=&lt;/span&gt;/etc/nginx/nginx.conf&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--pid-path&lt;span class="o"&gt;=&lt;/span&gt;/var/run/nginx.pid&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--lock-path&lt;span class="o"&gt;=&lt;/span&gt;/var/lock/nginx.lock&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--error-log-path&lt;span class="o"&gt;=&lt;/span&gt;/var/log/nginx/error.log&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--http-log-path&lt;span class="o"&gt;=&lt;/span&gt;/var/log/nginx/access.log&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--user&lt;span class="o"&gt;=&lt;/span&gt;www-data&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--group&lt;span class="o"&gt;=&lt;/span&gt;www-data&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--http-client-body-temp-path&lt;span class="o"&gt;=&lt;/span&gt;/var/lib/nginx/body&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--http-proxy-temp-path&lt;span class="o"&gt;=&lt;/span&gt;/var/lib/nginx/proxy&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--http-fastcgi-temp-path&lt;span class="o"&gt;=&lt;/span&gt;/var/lib/nginx/fastcgi&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--with-http_ssl_module&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--with-http_realip_module&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--with-http_addition_module&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--with-debug&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--with-http_flv_module&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
--with-http_stub_status_module&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="se"&gt;\&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above command will configure nginx, setting the path to it’s binary
to /usr/bin/nginx, config file path to /etc/nginx/nginx.conf, pid to
/var/run/nginx.pid, lock file to /var/lock/nginx.lock, error and access
logs to /var/log/nginx, tell nginx to run as www-data with group
www-data, set it’s temp paths to /var/lib/nginx and enable the following
modules; ssl, realip, addition (used for adding content to the start and
end of pages), debug, flash video and status modules.&lt;/p&gt;
&lt;p&gt;If you didn’t want to install openssl or pcre then you will have to
compile without ssl and pcre. Remove —with-http_ssl_module from above
and disable the rewrite module.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;--without-http_rewrite_module
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="compiling"&gt;
&lt;h3&gt;Compiling&lt;/h3&gt;
&lt;p&gt;Once done, if you have no errors you can actually compile nginx.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;make
sudo&lt;span class="w"&gt; &lt;/span&gt;make&lt;span class="w"&gt; &lt;/span&gt;install
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="nginx-configuration"&gt;
&lt;h2&gt;nginx configuration&lt;/h2&gt;
&lt;p&gt;Next we need to configure nginx to give it some nice configuration
options. First open up nginx’s main configuration file&lt;/p&gt;
&lt;blockquote&gt;
/etc/nginx/nginx.conf&lt;/blockquote&gt;
&lt;p&gt;Modify it to look like the one below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;user&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;www-data&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;www-data&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;worker_processes&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="k"&gt;error_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/error.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;pid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/run/nginx.pid&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="k"&gt;events&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;worker_connections&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1024&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;http&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;include&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/etc/nginx/mime.types&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/access.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;sendfile&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;tcp_nopush&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;keepalive_timeout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;5&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;tcp_nodelay&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;include&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/etc/nginx/conf.d/*.conf&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;include&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/etc/nginx/sites-enabled/*&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we’ll create the sub directories for holding site and module configuation.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/etc/nginx/sites-available
sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/etc/nginx/sites-enabled
sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/etc/nginx/conf.d
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we’ll create the default server definition.&lt;/p&gt;
&lt;blockquote&gt;
/etc/nginx/sites-available/default&lt;/blockquote&gt;
&lt;p&gt;And put the following in it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;localhost&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/localhost.access.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;index&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;index.html&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;index.htm&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/nginx_status&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;stub_status&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;allow&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;127&lt;/span&gt;&lt;span class="s"&gt;.0.0.1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;deny&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;all&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we symlink it in to the sites-enabled directory.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;ln&lt;span class="w"&gt; &lt;/span&gt;-s&lt;span class="w"&gt; &lt;/span&gt;/etc/nginx/sites-available/default&lt;span class="w"&gt; &lt;/span&gt;/etc/nginx/sites-enabled
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="start-stop-scripts"&gt;
&lt;h2&gt;Start/stop scripts&lt;/h2&gt;
&lt;p&gt;Once installation is complete we need to install a start/stop script, to
simply make life easier.&lt;/p&gt;
&lt;p&gt;You can get the &lt;a class="reference external" href="/files/nginx-debian"&gt;Debian version from here&lt;/a&gt; or the &lt;a class="reference external" href="/files/nginx-redhat"&gt;RedHat version from
here&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="starting-nginx"&gt;
&lt;h2&gt;Starting nginx&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/init.d/nginx&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Starting the service on boot&lt;/p&gt;
&lt;p&gt;Edit the following file:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/rc.local
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And add the following before the exit call.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/etc/init.d/nginx&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="fedora"></category><category term="install"></category><category term="nginx"></category><category term="redhat"></category><category term="ubuntu"></category></entry><entry><title>Apache internal dummy connection</title><link href="https://kura.gg/2010/03/27/apache-internal-dummy-connection/" rel="alternate"></link><published>2010-03-27T19:29:00+00:00</published><updated>2010-03-27T19:29:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-03-27:/2010/03/27/apache-internal-dummy-connection/</id><summary type="html">&lt;p&gt;Recently I found that one of the servers I look after that runs a high
profile site was generating semi-high load at traffic peaks. You could
generally say that this would be understandable but the server was
shooting up to a load of around 10 for a few seconds and with that load
jump I was able to graph an increase of Apache processes on top of it.
Again though, this would generally be considered normal, but knowing how
well the server performs and having nginx sitting on top handling all
static content I knew something wasn’t quite right.&lt;/p&gt;
&lt;p&gt;Looking through the logs I found quite a lot of requests from a badly
written spider which was generating a lot of server load when it hit the
server, but after &lt;span class="caps"&gt;IP&lt;/span&gt; banning the culprit I also found several instances
of Apache waking it’s child processes.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
127.0.0 …&lt;/pre&gt;</summary><content type="html">&lt;p&gt;Recently I found that one of the servers I look after that runs a high
profile site was generating semi-high load at traffic peaks. You could
generally say that this would be understandable but the server was
shooting up to a load of around 10 for a few seconds and with that load
jump I was able to graph an increase of Apache processes on top of it.
Again though, this would generally be considered normal, but knowing how
well the server performs and having nginx sitting on top handling all
static content I knew something wasn’t quite right.&lt;/p&gt;
&lt;p&gt;Looking through the logs I found quite a lot of requests from a badly
written spider which was generating a lot of server load when it hit the
server, but after &lt;span class="caps"&gt;IP&lt;/span&gt; banning the culprit I also found several instances
of Apache waking it’s child processes.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
127.0.0.1 - - [23/Mar/2010:17:02:38 +0000] "OPTIONS * HTTP/1.0" 200 - "-" "Apache (internal dummy connection)"
&lt;/pre&gt;
&lt;p&gt;This in itself is normal and nothing to worry about, generally, it is
known and also mentioned on the Apache wiki (&lt;a class="reference external" href="https://wiki.apache.org/httpd/InternalDummyConnection"&gt;explanation here&lt;/a&gt;) that
servers running 2.2.6 or lower can suffer performance problems due to
how Apache wakes it’s children because it used &lt;span class="caps"&gt;GET&lt;/span&gt; / to wake them, but I
run 2.2.8 which doesn’t actually used that same method.&lt;/p&gt;
&lt;p&gt;I applied the well known “work around” for this to test it and see if it
made any difference.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;RewriteEngine&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;on&lt;/span&gt;
&lt;span class="nb"&gt;RewriteCond&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;%{HTTP_USER_AGENT}&lt;span class="w"&gt; &lt;/span&gt;^.*internal&lt;span class="w"&gt; &lt;/span&gt;dummy&lt;span class="w"&gt; &lt;/span&gt;connection.*$&lt;span class="w"&gt; &lt;/span&gt;[NC]
&lt;span class="nb"&gt;RewriteRule&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;^/$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/blank.html&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;[L]
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Adding the virtual hosts with dynamic content will simple rewrite
Apache’s internal dummy connection requests to blank.html, thus stopping
it from trying to generate all dynamic page content just to wake the child.&lt;/p&gt;
&lt;p&gt;All seems normal but time will tell as to whether this makes a
difference with versions &amp;gt; 2.2.6.&lt;/p&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="load average"></category></entry><entry><title>Configuring Nagios to monitor remote load, disk, swap etc using NRPE</title><link href="https://kura.gg/2010/03/21/configuring-nagios-to-monitor-remote-load-disk-using-nrpe/" rel="alternate"></link><published>2010-03-21T21:55:00+00:00</published><updated>2010-03-21T21:55:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-03-21:/2010/03/21/configuring-nagios-to-monitor-remote-load-disk-using-nrpe/</id><summary type="html">
&lt;p&gt;I’ll assume you already have Nagios installed and configured and have an
understanding of actually configuring and using Nagios.&lt;/p&gt;
&lt;div class="section" id="remote-server-the-server-to-be-monitored"&gt;
&lt;h2&gt;Remote server — the server to be monitored&lt;/h2&gt;
&lt;p&gt;First we’ll install the needed plugins and daemon on the &lt;strong&gt;remote&lt;/strong&gt; server.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;nagios-plugins&lt;span class="w"&gt; &lt;/span&gt;nagios-nrpe-server
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed, open up &lt;strong&gt;/etc/nagios/nrpe_local.cfg&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;And place the following in it&lt;/p&gt;
&lt;pre class="literal-block"&gt;
allowed_hosts=NAGIOS.SERVER.IP,127.0.0.1

command[check_users]=/usr/lib/nagios/plugins/check_users -w 5 -c 10
command[check_load]=/usr/lib/nagios/plugins/check_load -w 15,10,5 -c 30,25,20
command[check_all_disks]=/usr/lib/nagios/plugins/check_disk -w 20 -c 10
command[check_zombie_procs]=/usr/lib/nagios/plugins/check_procs -w 5 -c 10 -s Z
command[check_total_procs]=/usr/lib/nagios/plugins/check_procs -w 150 -c 200
command[check_swap]=/usr/lib/nagios/plugins/check_swap -w 20 -c 10
&lt;/pre&gt;
&lt;p&gt;Save and exit.&lt;/p&gt;
&lt;p&gt;Commands need to explicitly be enabled on the …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;I’ll assume you already have Nagios installed and configured and have an
understanding of actually configuring and using Nagios.&lt;/p&gt;
&lt;div class="section" id="remote-server-the-server-to-be-monitored"&gt;
&lt;h2&gt;Remote server — the server to be monitored&lt;/h2&gt;
&lt;p&gt;First we’ll install the needed plugins and daemon on the &lt;strong&gt;remote&lt;/strong&gt; server.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;nagios-plugins&lt;span class="w"&gt; &lt;/span&gt;nagios-nrpe-server
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed, open up &lt;strong&gt;/etc/nagios/nrpe_local.cfg&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;And place the following in it&lt;/p&gt;
&lt;pre class="literal-block"&gt;
allowed_hosts=NAGIOS.SERVER.IP,127.0.0.1

command[check_users]=/usr/lib/nagios/plugins/check_users -w 5 -c 10
command[check_load]=/usr/lib/nagios/plugins/check_load -w 15,10,5 -c 30,25,20
command[check_all_disks]=/usr/lib/nagios/plugins/check_disk -w 20 -c 10
command[check_zombie_procs]=/usr/lib/nagios/plugins/check_procs -w 5 -c 10 -s Z
command[check_total_procs]=/usr/lib/nagios/plugins/check_procs -w 150 -c 200
command[check_swap]=/usr/lib/nagios/plugins/check_swap -w 20 -c 10
&lt;/pre&gt;
&lt;p&gt;Save and exit.&lt;/p&gt;
&lt;p&gt;Commands need to explicitly be enabled on the remote server to actually
be runnable remotely, so you can add more plugins to this command list
any time you want.&lt;/p&gt;
&lt;p&gt;Start the nagios-nrpe-server daemon.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/nagios-nrpe-server&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="monitoring-server-the-server-with-nagios-installed"&gt;
&lt;h2&gt;Monitoring server — the server with Nagios installed&lt;/h2&gt;
&lt;p&gt;Install the nagios nrpe plugin&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;nagios-nrpe-plugin
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now test the connection to the remote server we set up just now.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/usr/lib/nagios/plugins/check_nrpe&lt;span class="w"&gt; &lt;/span&gt;-H&lt;span class="w"&gt; &lt;/span&gt;REMOTE.SERVER.IP
NRPE&lt;span class="w"&gt; &lt;/span&gt;v2.8.1
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you get a version response it means it all works.&lt;/p&gt;
&lt;p&gt;Now we simply add a service check for the host but use the check_nrpe
plugin to do so.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
define service {
    host_name HOSTNAME
    service_description Load
    check_command check_nrpe_1arg!check_load
    use generic-service
    notification_interval 0
}
&lt;/pre&gt;
&lt;p&gt;We have already defined the tolerances on the remote server in
nrpe_local.cfg so we only need to use the check_nrpe_1arg command,
you can actually pass arguments using check_nrpe as below.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
define service {
    host_name HOSTNAME
    service_description Load
    check_command check_nrpe!check_load!5!10
    use generic-service
    notification_interval 0
}
&lt;/pre&gt;
&lt;p&gt;Save, exit and reload nagios.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/nagios2&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="monitoring"></category><category term="nagios"></category><category term="nrpe"></category><category term="ubuntu"></category></entry><entry><title>Show IP in Apache logs from nginx reverse proxy</title><link href="https://kura.gg/2010/03/20/show-ip-in-apache-logs-from-nginx-reverse-proxy/" rel="alternate"></link><published>2010-03-20T19:24:00+00:00</published><updated>2010-03-20T19:24:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-03-20:/2010/03/20/show-ip-in-apache-logs-from-nginx-reverse-proxy/</id><content type="html">&lt;p&gt;This is a very quick blog to show you how to show a users &lt;span class="caps"&gt;IP&lt;/span&gt; address in
your Apache access logs when the site in question is being reverse
proxied to Apache through nginx.&lt;/p&gt;
&lt;p&gt;You need the rpaf module for Apache, on Debian and Ubuntu this is simple
to install&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;libapache2-mod-rpaf
sudo&lt;span class="w"&gt; &lt;/span&gt;a2enmod&lt;span class="w"&gt; &lt;/span&gt;rpaf
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/apache2&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This set of commands will do the following;&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;Update apt package list&lt;/li&gt;
&lt;li&gt;Install libapache2-mod-rpaf&lt;/li&gt;
&lt;li&gt;Enable mod-rpaf&lt;/li&gt;
&lt;li&gt;Gracefully restart Apache (doesn’t kill connections)&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;Once installed you simple need to be sure to pass the correct headers
through, so open up one of your nginx site configuration files and add
the following within the server definition.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So you should have something that looks like this, but without the “… snip …”&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# ...snip...&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="c1"&gt;# ...snip...&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="c1"&gt;# ...snip...&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="log"></category><category term="nginx"></category><category term="proxy"></category></entry><entry><title>nginx - increase increase server_names_hash_bucket_size</title><link href="https://kura.gg/2010/03/18/nginx-increase-increase-server_names_hash_bucket_size/" rel="alternate"></link><published>2010-03-18T21:54:00+00:00</published><updated>2010-03-18T21:54:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-03-18:/2010/03/18/nginx-increase-increase-server_names_hash_bucket_size/</id><content type="html">&lt;p&gt;Today I ran in to something I’d never seen before when configuring nginx.&lt;/p&gt;
&lt;p&gt;I ran the nginx config test, as I usually do before I restart it.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;nginx&lt;span class="w"&gt; &lt;/span&gt;-t
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;But, the response I got was interesting&lt;/p&gt;
&lt;pre class="literal-block"&gt;
2010/03/18 21:16:09 [emerg] 12299#0: could not build the server_names_hash, you should increase server_names_hash_bucket_size: 32
2010/03/18 21:16:09 [emerg] 12299#0: the configuration file /etc/nginx/nginx.conf test failed
&lt;/pre&gt;
&lt;p&gt;I found that one of the domain names I was using was over 32 characters
in length, nginx’s default max length.&lt;/p&gt;
&lt;p&gt;Thankfully the fix was simple.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;http&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# ...snip...&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_names_hash_bucket_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;64&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c1"&gt;# ...snip...&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="nginx"></category></entry><entry><title>Finding files over a set size with find &amp; awk</title><link href="https://kura.gg/2010/03/17/finding-files-over-a-set-size-with-find-and-awk/" rel="alternate"></link><published>2010-03-17T11:19:00+00:00</published><updated>2010-03-17T11:19:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-03-17:/2010/03/17/finding-files-over-a-set-size-with-find-and-awk/</id><content type="html">&lt;p&gt;This is a really great simple way to find files on the filesystem that
are over 200k in size.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;find&lt;span class="w"&gt; &lt;/span&gt;/path/to/directory/&lt;span class="w"&gt; &lt;/span&gt;-type&lt;span class="w"&gt; &lt;/span&gt;f&lt;span class="w"&gt; &lt;/span&gt;-size&lt;span class="w"&gt; &lt;/span&gt;+200k&lt;span class="w"&gt; &lt;/span&gt;-exec&lt;span class="w"&gt; &lt;/span&gt;ls&lt;span class="w"&gt; &lt;/span&gt;-lh&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;awk&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'{ print $NF ": " $5 }'&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can use the output of this to either store in a file, or pipe to wc
for a count of lines&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;find&lt;span class="w"&gt; &lt;/span&gt;/path/to/directory/&lt;span class="w"&gt; &lt;/span&gt;-type&lt;span class="w"&gt; &lt;/span&gt;f&lt;span class="w"&gt; &lt;/span&gt;-size&lt;span class="w"&gt; &lt;/span&gt;+200k&lt;span class="w"&gt; &lt;/span&gt;-exec&lt;span class="w"&gt; &lt;/span&gt;ls&lt;span class="w"&gt; &lt;/span&gt;-lh&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;awk&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'{ print $NF ": " $5 }'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;wc&lt;span class="w"&gt; &lt;/span&gt;-l
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You can also use egrep before wc to look for specific filetypes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;find&lt;span class="w"&gt; &lt;/span&gt;/path/to/directory/&lt;span class="w"&gt; &lt;/span&gt;-type&lt;span class="w"&gt; &lt;/span&gt;f&lt;span class="w"&gt; &lt;/span&gt;-size&lt;span class="w"&gt; &lt;/span&gt;+200k&lt;span class="w"&gt; &lt;/span&gt;-exec&lt;span class="w"&gt; &lt;/span&gt;ls&lt;span class="w"&gt; &lt;/span&gt;-lh&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;{}&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;awk&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'{ print $NF ": " $5 }'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;egrep&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'(jpg|bmp|gif|tiff|jpeg)'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;|&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;wc&lt;span class="w"&gt; &lt;/span&gt;-l
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="awk"></category><category term="egrep"></category><category term="find"></category><category term="linux"></category><category term="ls"></category><category term="wc"></category></entry><entry><title>Convert DER certificate to PEM</title><link href="https://kura.gg/2010/03/03/convert-der-certificate-to-pem/" rel="alternate"></link><published>2010-03-03T17:26:00+00:00</published><updated>2010-03-03T17:26:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-03-03:/2010/03/03/convert-der-certificate-to-pem/</id><content type="html">&lt;p&gt;Some times as an administrator you will be given a certificate from a
third party that will be in the &lt;span class="caps"&gt;DER&lt;/span&gt; format, which cannot be loaded in to Apache.&lt;/p&gt;
&lt;p&gt;Converting it is a simple process:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;x509&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;certificate.crt&lt;span class="w"&gt; &lt;/span&gt;-inform&lt;span class="w"&gt; &lt;/span&gt;DER&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;certificate.pem&lt;span class="w"&gt; &lt;/span&gt;-outform&lt;span class="w"&gt; &lt;/span&gt;PEM
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="certificate"></category><category term="crt"></category><category term="der"></category><category term="pem"></category><category term="ssl"></category></entry><entry><title>less is more</title><link href="https://kura.gg/2010/03/01/less-is-more/" rel="alternate"></link><published>2010-03-01T21:30:00+00:00</published><updated>2010-03-01T21:30:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-03-01:/2010/03/01/less-is-more/</id><summary type="html">
&lt;p&gt;To my surprise I have found that there are still people out there who
use &lt;em&gt;“more”&lt;/em&gt;, this has shocked me.&lt;/p&gt;
&lt;p&gt;So this is a very, very short blog post to tell those who visit that
&lt;strong&gt;less is more and more is less&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="section" id="what"&gt;
&lt;h2&gt;What?&lt;/h2&gt;
&lt;p&gt;less is a command that comes as standard in almost all Linux distros
now, and unlike more it actually has the ability to do backwards and
forwards scrolling with Page Up, Page Down, arrow keys and spacebar.
It’s a fantastic little command!&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;less&lt;span class="w"&gt; &lt;/span&gt;FILE
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Very simple to use and an all round great tool. The best thing about
less is it doesn’t need to read the whole file in one go, it reads in
chunks. Opening a &lt;span class="caps"&gt;100MB&lt;/span&gt; log file is simple with less!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="useful-options"&gt;
&lt;h2&gt;Useful options&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;thead&gt;
&lt;tr&gt;&lt;th class="head"&gt;&lt;strong&gt;-g&lt;/strong&gt;&lt;/th&gt;
&lt;th class="head"&gt;Highlights just the current match of any searched string,&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;-I&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Case-insensitive searches,&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;-M&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Show a more detailed prompt …&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;To my surprise I have found that there are still people out there who
use &lt;em&gt;“more”&lt;/em&gt;, this has shocked me.&lt;/p&gt;
&lt;p&gt;So this is a very, very short blog post to tell those who visit that
&lt;strong&gt;less is more and more is less&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="section" id="what"&gt;
&lt;h2&gt;What?&lt;/h2&gt;
&lt;p&gt;less is a command that comes as standard in almost all Linux distros
now, and unlike more it actually has the ability to do backwards and
forwards scrolling with Page Up, Page Down, arrow keys and spacebar.
It’s a fantastic little command!&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;less&lt;span class="w"&gt; &lt;/span&gt;FILE
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Very simple to use and an all round great tool. The best thing about
less is it doesn’t need to read the whole file in one go, it reads in
chunks. Opening a &lt;span class="caps"&gt;100MB&lt;/span&gt; log file is simple with less!&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="useful-options"&gt;
&lt;h2&gt;Useful options&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;thead&gt;
&lt;tr&gt;&lt;th class="head"&gt;&lt;strong&gt;-g&lt;/strong&gt;&lt;/th&gt;
&lt;th class="head"&gt;Highlights just the current match of any searched string,&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;-I&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Case-insensitive searches,&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;-M&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Show a more detailed prompt, including file position,&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;-N&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Show line numbers.&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;+F&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Follow (like tail -f)&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
&lt;div class="section" id="useful-key-bindings"&gt;
&lt;h2&gt;Useful key bindings&lt;/h2&gt;
&lt;table class="docutils"&gt;
&lt;thead&gt;
&lt;tr&gt;&lt;th class="head"&gt;&lt;strong&gt;/&lt;/strong&gt;&lt;/th&gt;
&lt;th class="head"&gt;Search e.g. /test&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;n&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Goto next search match&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;N&lt;/strong&gt; (Shift + n)&lt;/td&gt;
&lt;td&gt;Goto previous search match&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;^&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Goto start of the file&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;$&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Goto end of the file&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;Spacebar&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Next page&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;&lt;strong&gt;b&lt;/strong&gt;&lt;/td&gt;
&lt;td&gt;Previous page&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="less"></category><category term="linux"></category><category term="unix"></category></entry><entry><title>HOWTO: SSH config on Debian/Ubuntu</title><link href="https://kura.gg/2010/02/18/howto-ssh-config-on-debian-ubuntu/" rel="alternate"></link><published>2010-02-18T21:03:00+00:00</published><updated>2010-02-18T21:03:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-18:/2010/02/18/howto-ssh-config-on-debian-ubuntu/</id><summary type="html">
&lt;p&gt;Today I &lt;em&gt;finally&lt;/em&gt; got round to setting up my local user ssh config on my
new work laptop and figured I’d do a quick write up on it and it’s uses.&lt;/p&gt;
&lt;p&gt;You can create a configuration file in your home directory that will
override the options set in your machine-wide config.&lt;/p&gt;
&lt;div class="section" id="your-configuration-files"&gt;
&lt;h2&gt;Your configuration files&lt;/h2&gt;
&lt;p&gt;Your local config can be found/created in:&lt;/p&gt;
&lt;blockquote&gt;
~/.ssh/config&lt;/blockquote&gt;
&lt;p&gt;And your machine-wide configuration is in:&lt;/p&gt;
&lt;blockquote&gt;
/etc/ssh/ssh_config&lt;/blockquote&gt;
&lt;p&gt;Rather than editing my ssh config across my whole machine I’m doing it
for my local user specifically.&lt;/p&gt;
&lt;p&gt;Reading the man page for ssh_config will give you a full list of
available options, below I will outline several that I use and find very useful.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="your-host-definitions"&gt;
&lt;h2&gt;Your host definitions&lt;/h2&gt;
&lt;p&gt;First things first, we need to define a host.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Host host.domain.com
&lt;/pre&gt;
&lt;p&gt;Each host you add to your config will need to have a host …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Today I &lt;em&gt;finally&lt;/em&gt; got round to setting up my local user ssh config on my
new work laptop and figured I’d do a quick write up on it and it’s uses.&lt;/p&gt;
&lt;p&gt;You can create a configuration file in your home directory that will
override the options set in your machine-wide config.&lt;/p&gt;
&lt;div class="section" id="your-configuration-files"&gt;
&lt;h2&gt;Your configuration files&lt;/h2&gt;
&lt;p&gt;Your local config can be found/created in:&lt;/p&gt;
&lt;blockquote&gt;
~/.ssh/config&lt;/blockquote&gt;
&lt;p&gt;And your machine-wide configuration is in:&lt;/p&gt;
&lt;blockquote&gt;
/etc/ssh/ssh_config&lt;/blockquote&gt;
&lt;p&gt;Rather than editing my ssh config across my whole machine I’m doing it
for my local user specifically.&lt;/p&gt;
&lt;p&gt;Reading the man page for ssh_config will give you a full list of
available options, below I will outline several that I use and find very useful.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="your-host-definitions"&gt;
&lt;h2&gt;Your host definitions&lt;/h2&gt;
&lt;p&gt;First things first, we need to define a host.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Host host.domain.com
&lt;/pre&gt;
&lt;p&gt;Each host you add to your config will need to have a host definition&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Host host.domain.com

...

Host host2.domain.com

...
&lt;/pre&gt;
&lt;p&gt;You can also create a wildcard host, hosts will actually build together
unless overwritten, so if you set a variable within the wildcard host it
will be set on all other defined hosts, unless the option is respecified
on that host.&lt;/p&gt;
&lt;p&gt;You can set up a wildcard host with this option:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Hostname *

...
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration-options"&gt;
&lt;h2&gt;Configuration options&lt;/h2&gt;
&lt;p&gt;I use several options across all my hosts&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Compression yes
&lt;/pre&gt;
&lt;p&gt;Setting this to yes will enable &lt;span class="caps"&gt;SSH&lt;/span&gt; compression. See setting below for
more information.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
CompressionLevel 9
&lt;/pre&gt;
&lt;p&gt;This is used to set compression on &lt;span class="caps"&gt;SSH&lt;/span&gt;, the higher the level (1-9) the
higher the compression rate, this also means less bandwidth is needed
but will require more processing to actually compress the request. I
generally set this in my wildcard host and leave it set.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
HostName 192.168.1.2
&lt;/pre&gt;
&lt;p&gt;This is a great little option, it means you can set an &lt;span class="caps"&gt;IP&lt;/span&gt; address to
connect to within a host definition, this basically means no more need
for /etc/hosts specifically for &lt;span class="caps"&gt;SSH&lt;/span&gt;.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
KeepAlive yes
&lt;/pre&gt;
&lt;p&gt;Setting this will enable keep alive packets to be sent to the host,
making it easier to continue working after network disconnect.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
TCPKeepAlive yes
&lt;/pre&gt;
&lt;p&gt;This option is like the one above, except it only sends &lt;span class="caps"&gt;TCP&lt;/span&gt; keep alive packets.&lt;/p&gt;
&lt;p&gt;There are many, many more settings but these are the ones I find useful.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration-example"&gt;
&lt;h2&gt;Configuration example&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
Host host1
    HostName 192.168.1.1

Host host2
    HostName 192.168.1.2

Host host3
    HostName host3.example.com

Host *
    Compression yes
    CompressionLevel 9
    KeepAlive yes
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="why-use-it"&gt;
&lt;h2&gt;Why use it?&lt;/h2&gt;
&lt;p&gt;The beauty of this config means that you are able to type ssh, press
your Tab key and a whole list of your hosts will be displayed, using the
name set in the host definition, just like when you type commands, this
also means you could type “ssh h” with the above config file and it will
display host1, host2 and host3 for you to chose from.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="howto"></category><category term="ssh"></category><category term="ssh_config"></category><category term="ubuntu"></category></entry><entry><title>HOWTO: Guest Virtual Machine disk extend online with Debian/Ubuntu, LVM2 and VMWare ESX</title><link href="https://kura.gg/2010/02/16/howto-guest-virtual-machine-disk-extend-online-with-debian-ubuntu-lvm2-and-vmware-esx/" rel="alternate"></link><published>2010-02-16T18:20:00+00:00</published><updated>2010-02-16T18:20:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-16:/2010/02/16/howto-guest-virtual-machine-disk-extend-online-with-debian-ubuntu-lvm2-and-vmware-esx/</id><summary type="html">
&lt;p&gt;Over the last two days I’ve had the interesting task of online some VMs
from clones and increasing their disk space to accommodate a mass of
user uploaded content. I’ve done this before but never actually with an
Logical Volume Management (&lt;span class="caps"&gt;LVM&lt;/span&gt;) disk.&lt;/p&gt;
&lt;p&gt;My first approach, like a fool, was to clone the &lt;span class="caps"&gt;VM&lt;/span&gt; from source and boot
it from a remotely mounted GParted &lt;span class="caps"&gt;ISO&lt;/span&gt;, this didn’t actually go as
expected and I was unable to add it to the &lt;span class="caps"&gt;LVM&lt;/span&gt;, I found a nice guide
online and consulted a colleague because I knew he’d done something
similar recently. After the first successful size increase I realised I
was able to do it without ever rebooting the machine itself, this is
accomplished by actually adding an extra disk to the &lt;span class="caps"&gt;VM&lt;/span&gt;, this disk can
then be partition with cfdisk and then added to the &lt;span class="caps"&gt;LVM&lt;/span&gt;, thus …&lt;/p&gt;</summary><content type="html">
&lt;p&gt;Over the last two days I’ve had the interesting task of online some VMs
from clones and increasing their disk space to accommodate a mass of
user uploaded content. I’ve done this before but never actually with an
Logical Volume Management (&lt;span class="caps"&gt;LVM&lt;/span&gt;) disk.&lt;/p&gt;
&lt;p&gt;My first approach, like a fool, was to clone the &lt;span class="caps"&gt;VM&lt;/span&gt; from source and boot
it from a remotely mounted GParted &lt;span class="caps"&gt;ISO&lt;/span&gt;, this didn’t actually go as
expected and I was unable to add it to the &lt;span class="caps"&gt;LVM&lt;/span&gt;, I found a nice guide
online and consulted a colleague because I knew he’d done something
similar recently. After the first successful size increase I realised I
was able to do it without ever rebooting the machine itself, this is
accomplished by actually adding an extra disk to the &lt;span class="caps"&gt;VM&lt;/span&gt;, this disk can
then be partition with cfdisk and then added to the &lt;span class="caps"&gt;LVM&lt;/span&gt;, thus increasing
disk space without the need to resize the actual main disk. The &lt;span class="caps"&gt;LVM&lt;/span&gt;
doesn’t care if the disks are physically separate (in this case they
aren’t, they’re on the same &lt;span class="caps"&gt;SAN&lt;/span&gt; but are still seen by the &lt;span class="caps"&gt;OS&lt;/span&gt; as being
different devices), as far as the &lt;span class="caps"&gt;LVM&lt;/span&gt; is concerned it will actually just
make them appear to the &lt;span class="caps"&gt;OS&lt;/span&gt; as one disk, even though made up from
different parts.&lt;/p&gt;
&lt;p&gt;So, onwards.&lt;/p&gt;
&lt;div class="section" id="assigning-the-additional-space-to-the-vm"&gt;
&lt;h2&gt;Assigning the additional space to the &lt;span class="caps"&gt;VM&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;This is rather easy, I’m going to assume anyone that is reading this
guide has VMWare installed, their host and guests configured properly.
etc. This guide is also aimed at &lt;span class="caps"&gt;ESX&lt;/span&gt; but is still easily applicable to
ESXi, VMWare player, etc.&lt;/p&gt;
&lt;p&gt;Within &lt;span class="caps"&gt;ESX&lt;/span&gt;, modify your VMs settings, adding an additional &lt;span class="caps"&gt;SCSI&lt;/span&gt; hard
disk, I’m going to give mine an additional drive with &lt;span class="caps"&gt;210GB&lt;/span&gt; of space.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="partitioning-the-newly-added-space"&gt;
&lt;h2&gt;Partitioning the newly added space&lt;/h2&gt;
&lt;p&gt;Once done, go to your &lt;span class="caps"&gt;VM&lt;/span&gt;, and as root run the following command:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"- - -"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/sys/class/scsi_host/**host0**/scan&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;fdisk&lt;span class="w"&gt; &lt;/span&gt;-l
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If the newly added unpartitioned drive isn’t displayed, try again with a
different &lt;strong&gt;host#&lt;/strong&gt; - host1, host2 etc.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;cfdisk&lt;span class="w"&gt; &lt;/span&gt;/dev/sda
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you don’t have cfdisk installed, you should be able to install it
with the following command on Debian-based systems:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;cfdisk
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once you have it running the &lt;span class="caps"&gt;ASCII&lt;/span&gt; interface should be simple to follow,
select your unallocated space and partition it, making sure you select
it’s type as &lt;strong&gt;Logical Volume&lt;/strong&gt; (8E) and &lt;strong&gt;not set it as bootable&lt;/strong&gt;.
Write these changes and close cfdisk.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Name Flags Part Type FS Type [Label] Size (MB)

------------------------------------------------------------------------------
sda1 Boot Primary Linux ext3 254.99
sda5 Logical Linux LVM 10479.01
sda6 Logical Linux LVM 225487.83
&lt;/pre&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-to-an-existing-lvm"&gt;
&lt;h2&gt;Adding to an existing &lt;span class="caps"&gt;LVM&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;Lets take a look at our current list of physical volumes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pvs

PV&lt;span class="w"&gt; &lt;/span&gt;VG&lt;span class="w"&gt; &lt;/span&gt;Fmt&lt;span class="w"&gt; &lt;/span&gt;Attr&lt;span class="w"&gt; &lt;/span&gt;PSize&lt;span class="w"&gt; &lt;/span&gt;PFree
/dev/sda5&lt;span class="w"&gt; &lt;/span&gt;jeos-base&lt;span class="w"&gt; &lt;/span&gt;lvm2&lt;span class="w"&gt; &lt;/span&gt;a-&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;9&lt;/span&gt;.76G&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see we have our existing list of volumes, in my case one.&lt;/p&gt;
&lt;p&gt;So now all we need to do is create another physical volume, my partition
is labelled &lt;strong&gt;sda6&lt;/strong&gt; so that’s what I will be using.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;pvcreate&lt;span class="w"&gt; &lt;/span&gt;/dev/sda6
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that we’ve added the volume it’s time to add it to the volume group,
this is really simple and again I’ll be using sda6.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;vgextend&lt;span class="w"&gt; &lt;/span&gt;jeos-base&lt;span class="w"&gt; &lt;/span&gt;/dev/sda6
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;jeos-root is the name of my volume group, you’d obviously replace this
with your own groups name.&lt;/p&gt;
&lt;p&gt;Now if we actually take a look at pvs again you will see that your
physical volume has been created and added to your volume group.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pvs&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;lvdisplay

PV&lt;span class="w"&gt; &lt;/span&gt;VG&lt;span class="w"&gt; &lt;/span&gt;Fmt&lt;span class="w"&gt; &lt;/span&gt;Attr&lt;span class="w"&gt; &lt;/span&gt;PSize&lt;span class="w"&gt; &lt;/span&gt;PFree
/dev/sda5&lt;span class="w"&gt; &lt;/span&gt;jeos-base&lt;span class="w"&gt; &lt;/span&gt;lvm2&lt;span class="w"&gt; &lt;/span&gt;a-&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;9&lt;/span&gt;.76G&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
/dev/sda6&lt;span class="w"&gt; &lt;/span&gt;lvm2&lt;span class="w"&gt; &lt;/span&gt;--&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;210&lt;/span&gt;.00G&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;

---&lt;span class="w"&gt; &lt;/span&gt;Logical&lt;span class="w"&gt; &lt;/span&gt;volume&lt;span class="w"&gt; &lt;/span&gt;---
LV&lt;span class="w"&gt; &lt;/span&gt;Name&lt;span class="w"&gt; &lt;/span&gt;/dev/jeos-base/root
VG&lt;span class="w"&gt; &lt;/span&gt;Name&lt;span class="w"&gt; &lt;/span&gt;jeos-base
LV&lt;span class="w"&gt; &lt;/span&gt;UUID&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1234&lt;/span&gt;
LV&lt;span class="w"&gt; &lt;/span&gt;Write&lt;span class="w"&gt; &lt;/span&gt;Access&lt;span class="w"&gt; &lt;/span&gt;read/write
LV&lt;span class="w"&gt; &lt;/span&gt;Status&lt;span class="w"&gt; &lt;/span&gt;available
&lt;span class="c1"&gt;# open 1&lt;/span&gt;
LV&lt;span class="w"&gt; &lt;/span&gt;Size&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;9&lt;/span&gt;.76&lt;span class="w"&gt; &lt;/span&gt;GB
Current&lt;span class="w"&gt; &lt;/span&gt;LE&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;12620&lt;/span&gt;
Segments&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;2&lt;/span&gt;
Allocation&lt;span class="w"&gt; &lt;/span&gt;inherit
Read&lt;span class="w"&gt; &lt;/span&gt;ahead&lt;span class="w"&gt; &lt;/span&gt;sectors&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0&lt;/span&gt;
Block&lt;span class="w"&gt; &lt;/span&gt;device&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;254&lt;/span&gt;:0
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The first output shows that your device has been added to the volume
group, the second output will show you that it isn’t actually added to
the &lt;span class="caps"&gt;LVM&lt;/span&gt;, so the next step is to actually extend the &lt;span class="caps"&gt;LVM&lt;/span&gt;&lt;/p&gt;
&lt;p&gt;Thanks to Ivan Marinkovic from the comments for this improved command:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
.. code-block:: bash
&lt;/pre&gt;
&lt;blockquote&gt;
&lt;p&gt;sudo lvextend -l+100%&lt;span class="caps"&gt;FREE&lt;/span&gt; /dev/jeos-base/root &amp;amp;&amp;amp; lvdisplay&lt;/p&gt;
&lt;p class="attribution"&gt;—Logical volume —-
&lt;span class="caps"&gt;LV&lt;/span&gt; Name /dev/jeos-base/root
&lt;span class="caps"&gt;VG&lt;/span&gt; Name jeos-base
&lt;span class="caps"&gt;LV&lt;/span&gt; &lt;span class="caps"&gt;UUID&lt;/span&gt; 1234
&lt;span class="caps"&gt;LV&lt;/span&gt; Write Access read/write
&lt;span class="caps"&gt;LV&lt;/span&gt; Status available
# open 1
&lt;span class="caps"&gt;LV&lt;/span&gt; Size 219.30 &lt;span class="caps"&gt;GB&lt;/span&gt;
Current &lt;span class="caps"&gt;LE&lt;/span&gt; 56140
Segments 2
Allocation inherit
Read ahead sectors 0
Block device 254:0&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;With the output of lvextend you will see that it successfully extending
the logical volume and lvdisplay should confirm that.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="resizing-the-file-system"&gt;
&lt;h2&gt;Resizing the file system&lt;/h2&gt;
&lt;p&gt;Now that we have the &lt;span class="caps"&gt;LVM&lt;/span&gt; extended we will actually want to extend the
file system too, so that it can use the full extra space freely, this
can be done online, I’d recommend doing a snapshot or backup of your &lt;span class="caps"&gt;VM&lt;/span&gt;
before doing this though.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;resize2fs&lt;span class="w"&gt; &lt;/span&gt;/dev/mapper/jeos--base-root&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;&amp;amp;&amp;amp;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;df&lt;span class="w"&gt; &lt;/span&gt;-h

Filesystem&lt;span class="w"&gt; &lt;/span&gt;Size&lt;span class="w"&gt; &lt;/span&gt;Used&lt;span class="w"&gt; &lt;/span&gt;Avail&lt;span class="w"&gt; &lt;/span&gt;Use%&lt;span class="w"&gt; &lt;/span&gt;Mounted&lt;span class="w"&gt; &lt;/span&gt;on
/dev/mapper/jeos--base-root
218G&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;.7G&lt;span class="w"&gt; &lt;/span&gt;205G&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1&lt;/span&gt;%&lt;span class="w"&gt; &lt;/span&gt;/
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And that’s it, all done. The output of df should confirm that your free
space has now increased in size.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Credits&lt;/em&gt;&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="https://www.randombugs.com/linux/howto-extend-lvm-partition-online.html"&gt;Original guide that I partially followed with a colleague&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;cite&gt;Federico Marani, the colleague that helped &amp;lt;`https://marro.wordpress.com/&lt;/cite&gt;&amp;gt;_ (Italian)&lt;/li&gt;
&lt;li&gt;Thanks to Mike Heald for linking me to reloading &lt;span class="caps"&gt;SCSI&lt;/span&gt; list&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="cfdisk"></category><category term="debian"></category><category term="esx"></category><category term="howto"></category><category term="logical volume management"></category><category term="lvm"></category><category term="lvm2"></category><category term="partition"></category><category term="ubuntu"></category><category term="vmware"></category></entry><entry><title>More nginx proxy_cache optimizations and nginx load balancing</title><link href="https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/" rel="alternate"></link><published>2010-02-14T14:27:00+00:00</published><updated>2010-02-14T14:27:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-14:/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/</id><summary type="html">
&lt;p&gt;This is yet another follow up to post to several previous posts about
using nginx as a reverse proxy with caching. It is actually a direct
addition to my post from a week or so ago which outlined how to actually
using nginx’s proxy caching feature which can be read here —
&lt;a class="reference external" href="https://syslog.tv/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/"&gt;/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="even-more-changes"&gt;
&lt;h2&gt;Even more changes?&lt;/h2&gt;
&lt;p&gt;Yes, even more changes, these are basic changes that are there to
improve the caching capabilities and also implement load balancing.&lt;/p&gt;
&lt;div class="section" id="cache-changes"&gt;
&lt;h3&gt;Cache changes&lt;/h3&gt;
&lt;p&gt;The first set of changes are in the main nginx configuration file&lt;/p&gt;
&lt;blockquote&gt;
/etc/nginx/nginx.conf&lt;/blockquote&gt;
&lt;p&gt;These changes basically just change the proxy_cache key&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;proxy_cache_path&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/nginx_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;levels=1:2&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;keys_zone=cache:8m&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;max_size=1000m&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;inactive=600m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_temp_path&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/tmp/nginx&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$scheme://$host$request_uri"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I’ve decided to put the temporary caches file in to an nginx specific
directory, just to separate them from other cache files …&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This is yet another follow up to post to several previous posts about
using nginx as a reverse proxy with caching. It is actually a direct
addition to my post from a week or so ago which outlined how to actually
using nginx’s proxy caching feature which can be read here —
&lt;a class="reference external" href="https://syslog.tv/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/"&gt;/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/&lt;/a&gt;.&lt;/p&gt;
&lt;div class="section" id="even-more-changes"&gt;
&lt;h2&gt;Even more changes?&lt;/h2&gt;
&lt;p&gt;Yes, even more changes, these are basic changes that are there to
improve the caching capabilities and also implement load balancing.&lt;/p&gt;
&lt;div class="section" id="cache-changes"&gt;
&lt;h3&gt;Cache changes&lt;/h3&gt;
&lt;p&gt;The first set of changes are in the main nginx configuration file&lt;/p&gt;
&lt;blockquote&gt;
/etc/nginx/nginx.conf&lt;/blockquote&gt;
&lt;p&gt;These changes basically just change the proxy_cache key&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;proxy_cache_path&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/nginx_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;levels=1:2&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;keys_zone=cache:8m&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;max_size=1000m&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;inactive=600m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_temp_path&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/tmp/nginx&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$scheme://$host$request_uri"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I’ve decided to put the temporary caches file in to an nginx specific
directory, just to separate them from other cache files. I’ve also
modified the proxy_cache_key to add the following variables:&lt;/p&gt;
&lt;ul class="simple"&gt;
&lt;li&gt;&lt;strong&gt;$scheme&lt;/strong&gt; - This will be the protocol; http or https&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;$host&lt;/strong&gt; - Host name, this will be set as syslog.tv for me&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;$request_uri&lt;/strong&gt; - The full request uri, this is simple&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Why add these variables? Quite simple really, it means I can have
multiple sites running with proxy caching enabled and have them set a
meaningful key so they don’t clash.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="load-balancing-changes"&gt;
&lt;h3&gt;Load balancing changes&lt;/h3&gt;
&lt;p&gt;The next set of changes will be specific to my site specific
configuration file, the first of which is an addition on an upstream definition.&lt;/p&gt;
&lt;p&gt;/etc/nginx/sites-available/syslog.tv&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;upstream&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;apachesyslogtv&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;apache.syslog.tv&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;weight=1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=60s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So what does this mean? This is really actually quite simple, we define
an upstream set called &lt;strong&gt;apachesyslogtv&lt;/strong&gt;, which contains, in this
example, a single server definition with a weight of 1 and a fail
timeout of 60 seconds. You would actually be able to add multiple server
definitions to this with different weights and fail timeouts. This is
used for load balancing.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;upstream&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;apachesyslogtv&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;apache1.syslog.tv&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;weight=1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=60s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;apache2.syslog.tv&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;weight=1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=60s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="server-definition-changes"&gt;
&lt;h3&gt;Server definition changes&lt;/h3&gt;
&lt;p&gt;There are quite a lot of changes that are made to the actual server
definition, I will go through these step-by-step to explain what has
changed and why it’s changed.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/path/to/site&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_|wordpress_(?!test_cookie)|wp-postpass_")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$do_not_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$scheme://$host$request_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$do_not_cache"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;302&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;60m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;404&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://apachesyslogtv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Ok, so that’s the first location, definition. Several things have
changed with this.&lt;/p&gt;
&lt;p&gt;The first change is an addition of a cookie check, in my case I’m
running a WordPress site so I check for various WordPress cookies, if
they exist I set the variable &lt;strong&gt;$do_not_cache&lt;/strong&gt; to 1.&lt;/p&gt;
&lt;p&gt;Next is a change to the proxy_cache_key to incorporate the
$do_not_cache variable, this tells nginx not to cache the current page.&lt;/p&gt;
&lt;p&gt;And finally is a change to proxy_pass, this now points to the name of
my upstream definition, which nginx will then use to decide which server
to use.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.(jpg|png|gif|jpeg|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;120m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;expires&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;604800&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://apachesyslogtv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The second and final location definition, which will match a file
extension in the &lt;span class="caps"&gt;URL&lt;/span&gt;, if a match is found it will set the cache validity
to 2 hours, expire to 7 days, pass back to our upstream definition and
cache the result. You may notice that out of all of these static file
extensions .js is missing, this is because a lot of my site is generated
by Javascript/Ajax and this will not work with caching.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="why-the-changes"&gt;
&lt;h2&gt;Why the changes?&lt;/h2&gt;
&lt;p&gt;With these changes I am able to properly store with a cache key which
allows me to cache all of my nginx sites, I’ve added the ability to
balance load across multiple servers and I’ve increased the power of the
caching to only cache pages if you’re not logged in and to always cache
static files for a long time. Meaning that the cache shouldn’t need to
be regenerated very often.&lt;/p&gt;
&lt;p&gt;All in all these changes do not increase the power of the server at all,
but with a load balanced environment this would obviously increase the
performance dramatically.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-full-config"&gt;
&lt;h2&gt;The full config&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;upstream&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;apachesyslogtv&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;apache.syslog.tv&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;weight=1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;fail_timeout=60s&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;174.143.241.61&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/syslog.tv.access.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_vary&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;gzip_static&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/path/to/site&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"comment_author_|wordpress_(?!test_cookie)|wp-postpass_")&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;            &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$do_not_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$scheme://$host$request_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$do_not_cache"&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;302&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;60m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;404&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://apachesyslogtv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.(jpg|png|gif|jpeg|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;120m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;expires&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;604800&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://apachesyslogtv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;cache&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="cache"></category><category term="debian"></category><category term="howto"></category><category term="load balancing"></category><category term="nginx"></category><category term="ubuntu"></category><category term="wordpress"></category></entry><entry><title>code_swarm - Apache, Python and PostgreSQL commit visualization</title><link href="https://kura.gg/2010/02/13/code_swarm-apache-python-and-postgresql-commit-visualization/" rel="alternate"></link><published>2010-02-13T23:01:00+00:00</published><updated>2010-02-13T23:01:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-13:/2010/02/13/code_swarm-apache-python-and-postgresql-commit-visualization/</id><content type="html">
&lt;p&gt;These videos are pretty old now and I had forgotten about them until a
colleague tweeted about a Twitter code_swarm visualization which made
me remember.&lt;/p&gt;
&lt;p&gt;So here they are, best viewed in full screen mode.&lt;/p&gt;
&lt;div class="section" id="apache"&gt;
&lt;h2&gt;Apache&lt;/h2&gt;
&lt;div align="center" class="vimeo"&gt;&lt;iframe allowfullscreen="" frameborder="0" height="500" mozallowfullscreen="" src="https://player.vimeo.com/video/1076588" webkitallowfullscreen="" width="800"&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;/div&gt;
&lt;div class="section" id="python"&gt;
&lt;h2&gt;Python&lt;/h2&gt;
&lt;div align="center" class="vimeo"&gt;&lt;iframe allowfullscreen="" frameborder="0" height="500" mozallowfullscreen="" src="https://player.vimeo.com/video/1093745" webkitallowfullscreen="" width="800"&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;/div&gt;
&lt;div class="section" id="postgresql"&gt;
&lt;h2&gt;PostgreSQL&lt;/h2&gt;
&lt;div align="center" class="vimeo"&gt;&lt;iframe allowfullscreen="" frameborder="0" height="500" mozallowfullscreen="" src="https://player.vimeo.com/video/1081680" webkitallowfullscreen="" width="800"&gt;&lt;/iframe&gt;&lt;/div&gt;&lt;/div&gt;
</content><category term="misc"></category><category term="apache"></category><category term="code_swarm"></category><category term="postgresql"></category><category term="python"></category></entry><entry><title>HOWTO: DomainKeys with Postfix on Debian/Ubuntu</title><link href="https://kura.gg/2010/02/12/howto-domainkeys-with-postfix-on-debian-ubuntu/" rel="alternate"></link><published>2010-02-12T19:08:00+00:00</published><updated>2010-02-12T19:08:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-12:/2010/02/12/howto-domainkeys-with-postfix-on-debian-ubuntu/</id><summary type="html">&lt;p&gt;&lt;strong&gt;I have written a much newer, clearer and better article on DomainKeys
signing email `here`_.&lt;/strong&gt;&lt;/p&gt;
&lt;div class="section" id="about"&gt;
&lt;h2&gt;About&lt;/h2&gt;
&lt;p&gt;This guide is a sister to another guide I wrote a while back about how
to use DomainKeys Identified Mail (&lt;span class="caps"&gt;DKIM&lt;/span&gt;) with Postfix on Debian, which
can be read here - &lt;a class="reference external" href="/2010/01/11/dkim-on-debian-with-postfix/"&gt;/2010/01/11/dkim-on-debian-with-postfix/&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;DomainKeys is an older implementation than &lt;span class="caps"&gt;DKIM&lt;/span&gt;, &lt;span class="caps"&gt;DKIM&lt;/span&gt; is a merge of
DomainKeys and Identified Mail. Both DomainKeys and &lt;span class="caps"&gt;DKIM&lt;/span&gt; are used so
having both configured is a good idea.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="getting-started"&gt;
&lt;h2&gt;Getting started&lt;/h2&gt;
&lt;p&gt;Lets start off by installing the dk-filter&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;dk-filter
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed you can can create a public and private key set using the
commands below, if you’re already using &lt;span class="caps"&gt;DKIM&lt;/span&gt; you can skip this step and
just use your already existing key.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;genrsa&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1024&lt;/span&gt;
openssl&lt;span class="w"&gt; &lt;/span&gt;rsa&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;public.key&lt;span class="w"&gt; &lt;/span&gt;-pubout&lt;span class="w"&gt; &lt;/span&gt;-outform&lt;span class="w"&gt; &lt;/span&gt;PEM
sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/etc/mail
sudo …&lt;/pre&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">&lt;p&gt;&lt;strong&gt;I have written a much newer, clearer and better article on DomainKeys
signing email `here`_.&lt;/strong&gt;&lt;/p&gt;
&lt;div class="section" id="about"&gt;
&lt;h2&gt;About&lt;/h2&gt;
&lt;p&gt;This guide is a sister to another guide I wrote a while back about how
to use DomainKeys Identified Mail (&lt;span class="caps"&gt;DKIM&lt;/span&gt;) with Postfix on Debian, which
can be read here - &lt;a class="reference external" href="/2010/01/11/dkim-on-debian-with-postfix/"&gt;/2010/01/11/dkim-on-debian-with-postfix/&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;DomainKeys is an older implementation than &lt;span class="caps"&gt;DKIM&lt;/span&gt;, &lt;span class="caps"&gt;DKIM&lt;/span&gt; is a merge of
DomainKeys and Identified Mail. Both DomainKeys and &lt;span class="caps"&gt;DKIM&lt;/span&gt; are used so
having both configured is a good idea.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="getting-started"&gt;
&lt;h2&gt;Getting started&lt;/h2&gt;
&lt;p&gt;Lets start off by installing the dk-filter&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;dk-filter
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed you can can create a public and private key set using the
commands below, if you’re already using &lt;span class="caps"&gt;DKIM&lt;/span&gt; you can skip this step and
just use your already existing key.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;genrsa&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1024&lt;/span&gt;
openssl&lt;span class="w"&gt; &lt;/span&gt;rsa&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;public.key&lt;span class="w"&gt; &lt;/span&gt;-pubout&lt;span class="w"&gt; &lt;/span&gt;-outform&lt;span class="w"&gt; &lt;/span&gt;PEM
sudo&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/etc/mail
sudo&lt;span class="w"&gt; &lt;/span&gt;cp&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;/etc/mail/dk.key
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So that’s the key sorted, now we’ll configure dk-filter.&lt;/p&gt;
&lt;p&gt;Open the following file&lt;/p&gt;
&lt;blockquote&gt;
/etc/default/dk-filter&lt;/blockquote&gt;
&lt;p&gt;You should see something like this&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Sane defaults: log to syslog&lt;/span&gt;
&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"-l"&lt;/span&gt;
&lt;span class="c1"&gt;# Sign for domain.tld with key in /etc/mail/domainkey.key using&lt;/span&gt;
&lt;span class="c1"&gt;# selector '2007' (e.g. 2007._domainkey.domain.tld)&lt;/span&gt;
&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$DAEMON_OPTS&lt;/span&gt;&lt;span class="s2"&gt; -d domain.tld -s&lt;/span&gt;
&lt;span class="s2"&gt;/etc/mail/domainkey.key -S 2007"&lt;/span&gt;
&lt;span class="c1"&gt;# See dk-filter(8) for a complete list of options&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Uncomment to specify an alternate socket&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="/var/run/dk-filter/dk-filter.sock" # default&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="inet:54321" # listen on all interfaces on port 54321&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="inet:8892@localhost" # listen on loopback on port 8892&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="inet:12345@192.0.2.1" # listen on 192.0.2.1 on port 12345&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You will need to modify the DAEMON_OPTS, changing the domain (-d), key
file and location (-s) and selector (-S), an example is below&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Sane defaults: log to syslog&lt;/span&gt;
&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"-l"&lt;/span&gt;
&lt;span class="c1"&gt;# Sign for domain.tld with key in /etc/mail/domainkey.key using&lt;/span&gt;
&lt;span class="c1"&gt;# selector '2007' (e.g. 2007._domainkey.domain.tld)&lt;/span&gt;
&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"&lt;/span&gt;&lt;span class="nv"&gt;$DAEMON_OPTS&lt;/span&gt;&lt;span class="s2"&gt; -d syslog.tv -s /etc/mail/dk.key -S mail"&lt;/span&gt;
&lt;span class="c1"&gt;# See dk-filter(8) for a complete list of options&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;
&lt;span class="c1"&gt;# Uncomment to specify an alternate socket&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="/var/run/dk-filter/dk-filter.sock" # default&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="inet:54321" # listen on all interfaces on port 54321&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="inet:8892@localhost" # listen on loopback on port 8892&lt;/span&gt;
&lt;span class="nv"&gt;SOCKET&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"inet:12345@localhost"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# listen on loopback on port 12345&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You should notice that I specifically told the daemon to run on loopback
on port 12345, you should do the same, if you already have something
running on that port (like &lt;span class="caps"&gt;DKIM&lt;/span&gt;, which uses the same port in my other
guide,) you should set this to something different, like 12346.&lt;/p&gt;
&lt;p&gt;On Debian Sid I had problems with DAEMON_OPTS, for some reason the
second DAEMON_OPTS was not overwriting and including the first, so I
modified it to look like this&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Sane defaults: log to syslog&lt;/span&gt;
&lt;span class="c1"&gt;#DAEMON_OPTS="-l"&lt;/span&gt;
&lt;span class="c1"&gt;# Sign for domain.tld with key in /etc/mail/domainkey.key using&lt;/span&gt;
&lt;span class="c1"&gt;# selector '2007' (e.g. 2007._domainkey.domain.tld)&lt;/span&gt;
&lt;span class="nv"&gt;DAEMON_OPTS&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"-l -d syslog.tv -s /etc/mail/dk.key -S mail"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The problem meant that when the daemon was actually started, it would
not know which domain, key or selector to use, doing the above solved
this issue for me.&lt;/p&gt;
&lt;p&gt;Now that dk-filter is configured, we can start it&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/dk-filter&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-postfix"&gt;
&lt;h2&gt;Configuring Postfix&lt;/h2&gt;
&lt;p&gt;Next we need to modify Postfix to tell it to use dk-filter to sign
emails. Lets open up&lt;/p&gt;
&lt;blockquote&gt;
/etc/postfix/main.cf&lt;/blockquote&gt;
&lt;p&gt;Place the following as the end of that file&lt;/p&gt;
&lt;pre class="literal-block"&gt;
milter_default_action = accept
milter_protocol = 6
smtpd_milters = inet:localhost:12345
non_smtpd_milters = inet:localhost:12345
&lt;/pre&gt;
&lt;p&gt;If you’ve already got this defined you simple append to the end,
separating with commas&lt;/p&gt;
&lt;pre class="literal-block"&gt;
milter_default_action = accept
milter_protocol = 6
smtpd_milters = inet:localhost:12345, inet:localhost:12346
non_smtpd_milters = inet:localhost:12345, inet:localhost:12346
&lt;/pre&gt;
&lt;p&gt;That’s Postfix configured, we’ll reload it once the &lt;span class="caps"&gt;DNS&lt;/span&gt; is configured.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuring-the-dns"&gt;
&lt;h2&gt;Configuring the &lt;span class="caps"&gt;DNS&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;How you configured your &lt;span class="caps"&gt;DNS&lt;/span&gt; is up to you, you will need to add the
following 2 new records&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;_domainkey.&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;.&lt;span class="caps"&gt;TLD&lt;/span&gt;. &lt;span class="caps"&gt;IN&lt;/span&gt; &lt;span class="caps"&gt;TXT&lt;/span&gt; “t=y; o=-;”&lt;/p&gt;
&lt;p&gt;&lt;span class="caps"&gt;SELECTOR&lt;/span&gt;._domainkey.&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;.&lt;span class="caps"&gt;TLD&lt;/span&gt;. &lt;span class="caps"&gt;IN&lt;/span&gt; &lt;span class="caps"&gt;TXT&lt;/span&gt; “k=rsa; t=y; p=YOUR_PUBLIC_KEY_HERE”&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Replace the instances of &lt;strong&gt;&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;.&lt;span class="caps"&gt;TLD&lt;/span&gt;&lt;/strong&gt; with your actual mail domain
name in both records, &lt;strong&gt;&lt;span class="caps"&gt;SELECTOR&lt;/span&gt;&lt;/strong&gt; was configured in to opendkim
earlier, in my example I used &lt;strong&gt;mail&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Your key will be called public.key, we created both public and private
keys earlier. You only need to add the actual key from between the &lt;span class="caps"&gt;BEGIN&lt;/span&gt;
and &lt;span class="caps"&gt;END&lt;/span&gt; lines, e.g. my test one below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-----BEGIN PUBLIC KEY-----
MIGfMWGwregWREGREwgERGREGergerDGdEPzFCAdYnf1Z9nRtfTqwP/mcdGg
NmbY11tCtwwFMu8/qEQwaK/Nc61q0D/z7NYwlsPFi08lnVSHGrewherh5630n
F6S0z961h6li/pOHiJy/l2ehnenhehO3d/NmATY90WlpEDmnlVAMTYgALBFJplp
1ruZ66Bgrewhg43y634567gewrgB
-----END PUBLIC KEY-----
&lt;/pre&gt;
&lt;p&gt;Becomes&lt;/p&gt;
&lt;p&gt;:&lt;/p&gt;
&lt;blockquote&gt;
MIGfMWGwregWREGREwgERGREGerg […snip…] plp1ruZ66Bgrewhg43y634567gewrgB&lt;/blockquote&gt;
&lt;p&gt;Now we simply reload the Postfix config with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/postfix&lt;span class="w"&gt; &lt;/span&gt;reload
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now you can send test mails once you’re sure &lt;span class="caps"&gt;DNS&lt;/span&gt; changes have
propagated. You will see any errors in &lt;strong&gt;/var/log/mail.log&lt;/strong&gt;.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="dkim"></category><category term="domainkeys"></category><category term="howto"></category><category term="mail"></category><category term="postfix"></category><category term="ubuntu"></category></entry><entry><title>HOWTO: Using SPF to validate outgoing mail</title><link href="https://kura.gg/2010/02/11/howto-using-spf-to-validate-outgoing-mail/" rel="alternate"></link><published>2010-02-11T18:25:00+00:00</published><updated>2010-02-11T18:25:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-11:/2010/02/11/howto-using-spf-to-validate-outgoing-mail/</id><summary type="html">
&lt;p&gt;You can get a basic overview on what &lt;span class="caps"&gt;SPF&lt;/span&gt; is, what it’s for and it’s more
advanced usages here - &lt;a class="reference external" href="https://www.openspf.org/"&gt;https://www.openspf.org/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This article is to give only a basic insight in to how you can use an
&lt;span class="caps"&gt;SPF&lt;/span&gt; record to valid mail from your servers.&lt;/p&gt;
&lt;div class="section" id="the-dns"&gt;
&lt;h2&gt;The &lt;span class="caps"&gt;DNS&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;span class="caps"&gt;SPF&lt;/span&gt; records work from your &lt;span class="caps"&gt;DNS&lt;/span&gt;, it’s really simple. Technically there is
a &lt;span class="caps"&gt;DNS&lt;/span&gt; type defined for &lt;span class="caps"&gt;SPF&lt;/span&gt; records as of &lt;a class="reference external" href="https://tools.ietf.org/html/rfc4408"&gt;&lt;span class="caps"&gt;RFC&lt;/span&gt; 4408&lt;/a&gt;, but since not all
servers recognise this type it also works in the &lt;span class="caps"&gt;TXT&lt;/span&gt; type.&lt;/p&gt;
&lt;p&gt;A simple usage of &lt;span class="caps"&gt;SPF&lt;/span&gt; is&lt;/p&gt;
&lt;pre class="literal-block"&gt;
v=spf1 a mx -all
&lt;/pre&gt;
&lt;p&gt;Imagine this exists on this domain, &lt;strong&gt;syslog.tv&lt;/strong&gt;. This spf record would
mean that &lt;span class="caps"&gt;ALL&lt;/span&gt; &lt;span class="caps"&gt;AN&lt;/span&gt; and &lt;span class="caps"&gt;MX&lt;/span&gt; servers listed in the &lt;span class="caps"&gt;DNS&lt;/span&gt; records of syslog.tv
would be valid senders.&lt;/p&gt;
&lt;p&gt;The hypen (-) before &lt;em&gt;all&lt;/em&gt; means that if the mail appears to be coming
from a server that isn …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;You can get a basic overview on what &lt;span class="caps"&gt;SPF&lt;/span&gt; is, what it’s for and it’s more
advanced usages here - &lt;a class="reference external" href="https://www.openspf.org/"&gt;https://www.openspf.org/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;This article is to give only a basic insight in to how you can use an
&lt;span class="caps"&gt;SPF&lt;/span&gt; record to valid mail from your servers.&lt;/p&gt;
&lt;div class="section" id="the-dns"&gt;
&lt;h2&gt;The &lt;span class="caps"&gt;DNS&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;&lt;span class="caps"&gt;SPF&lt;/span&gt; records work from your &lt;span class="caps"&gt;DNS&lt;/span&gt;, it’s really simple. Technically there is
a &lt;span class="caps"&gt;DNS&lt;/span&gt; type defined for &lt;span class="caps"&gt;SPF&lt;/span&gt; records as of &lt;a class="reference external" href="https://tools.ietf.org/html/rfc4408"&gt;&lt;span class="caps"&gt;RFC&lt;/span&gt; 4408&lt;/a&gt;, but since not all
servers recognise this type it also works in the &lt;span class="caps"&gt;TXT&lt;/span&gt; type.&lt;/p&gt;
&lt;p&gt;A simple usage of &lt;span class="caps"&gt;SPF&lt;/span&gt; is&lt;/p&gt;
&lt;pre class="literal-block"&gt;
v=spf1 a mx -all
&lt;/pre&gt;
&lt;p&gt;Imagine this exists on this domain, &lt;strong&gt;syslog.tv&lt;/strong&gt;. This spf record would
mean that &lt;span class="caps"&gt;ALL&lt;/span&gt; &lt;span class="caps"&gt;AN&lt;/span&gt; and &lt;span class="caps"&gt;MX&lt;/span&gt; servers listed in the &lt;span class="caps"&gt;DNS&lt;/span&gt; records of syslog.tv
would be valid senders.&lt;/p&gt;
&lt;p&gt;The hypen (-) before &lt;em&gt;all&lt;/em&gt; means that if the mail appears to be coming
from a server that isn’t listen in syslog.tv’s &lt;span class="caps"&gt;DNS&lt;/span&gt; records then the
check should fail.&lt;/p&gt;
&lt;div class="section" id="mechanisms"&gt;
&lt;h3&gt;Mechanisms&lt;/h3&gt;
&lt;p&gt;+=============+=============================================================================================================+
| Mechanism   | Description                                                                                                 |
| +=============+===========================================================================================================+
| &lt;strong&gt;&lt;span class="caps"&gt;ALL&lt;/span&gt;&lt;/strong&gt;     | Matches always                                                                                              |
+——————-+——————————————————————————————————————————————————————-+
| &lt;strong&gt;A&lt;/strong&gt;       | If the domain name has an A (or &lt;span class="caps"&gt;AAAA&lt;/span&gt; for IPv6) record corresponding to the sender’s address, it will match. |
+——————-+——————————————————————————————————————————————————————-+
| &lt;strong&gt;&lt;span class="caps"&gt;IP4&lt;/span&gt;&lt;/strong&gt;     | If the sender is in a given IPv4 range, match.                                                              |
+——————-+——————————————————————————————————————————————————————-+
| &lt;strong&gt;&lt;span class="caps"&gt;IP6&lt;/span&gt;&lt;/strong&gt;     | If the sender is in a given IPv6 range, match.                                                              |
+——————-+——————————————————————————————————————————————————————-+
| &lt;strong&gt;&lt;span class="caps"&gt;MX&lt;/span&gt;&lt;/strong&gt;      | If the domain name has an &lt;span class="caps"&gt;MX&lt;/span&gt; record resolving to the sender’s address, it will match.                       |
+——————-+——————————————————————————————————————————————————————-+
| &lt;strong&gt;&lt;span class="caps"&gt;PTR&lt;/span&gt;&lt;/strong&gt;     | If the &lt;span class="caps"&gt;RDNS&lt;/span&gt; domain of the sending &lt;span class="caps"&gt;IP&lt;/span&gt; ending in the domain name.                                             |
+——————-+——————————————————————————————————————————————————————-+
| &lt;strong&gt;&lt;span class="caps"&gt;EXISTS&lt;/span&gt;&lt;/strong&gt;  | If the given domain resolves, matches.                                                                      |
+——————-+——————————————————————————————————————————————————————-+
| &lt;strong&gt;&lt;span class="caps"&gt;INCLUDE&lt;/span&gt;&lt;/strong&gt; | If the included policy passes the test this mechanism matches.                                              | +——————-+——————————————————————————————————————————————————————-+&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="qualifiers"&gt;
&lt;h3&gt;Qualifiers&lt;/h3&gt;
&lt;p&gt;+===========+=====================================================+
| Qualifier | Description                                         |
+===========+=====================================================+
| &lt;strong&gt;+&lt;/strong&gt;     | &lt;span class="caps"&gt;PASS&lt;/span&gt; result.                                        |
+—————-+——————————————————————————-+
| &lt;strong&gt;?&lt;/strong&gt;     | &lt;span class="caps"&gt;NEUTRAL&lt;/span&gt; result interpreted like no policy.          |
+—————-+——————————————————————————-+
| &lt;strong&gt;~&lt;/strong&gt;     | &lt;span class="caps"&gt;SOFTFAIL&lt;/span&gt;, a debugging aid between &lt;span class="caps"&gt;NEUTRAL&lt;/span&gt; and &lt;span class="caps"&gt;FAIL&lt;/span&gt;. |
+—————-+——————————————————————————-+
| &lt;strong&gt;-&lt;/strong&gt;     | &lt;span class="caps"&gt;FAIL&lt;/span&gt;, the mail should be rejected.                  | +—————-+——————————————————————————-+&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="more-examples"&gt;
&lt;h2&gt;More examples&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
v=spf1 include:google.com -all
&lt;/pre&gt;
&lt;p&gt;Include &lt;span class="caps"&gt;SPF&lt;/span&gt; records from the domain &lt;strong&gt;google.com&lt;/strong&gt; and pass if record
matches any from the include, failing if it doesn’t.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
v=spf1 exists:syslog.tv
&lt;/pre&gt;
&lt;p&gt;If syslog.tv resolves, pass.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
v=spf mx ~all
&lt;/pre&gt;
&lt;p&gt;If record matches against an &lt;span class="caps"&gt;MX&lt;/span&gt; record for the domain in the &lt;span class="caps"&gt;DNS&lt;/span&gt;, pass,
if not then neutrally fail but still be accepted.&lt;/p&gt;
&lt;p&gt;Hopefully this basic guide is helpful, &lt;span class="caps"&gt;SPF&lt;/span&gt; records are very useful and
we use them a lot at work across our mail platform, going so far as to
get clients to include our &lt;span class="caps"&gt;SPF&lt;/span&gt; records in their &lt;span class="caps"&gt;DNS&lt;/span&gt; to ensure no
failures when they send email via our servers.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="howto"></category><category term="mail"></category></entry><entry><title>HOWTO: IPTables on Debian/Ubuntu</title><link href="https://kura.gg/2010/02/11/howto-iptables-on-debian-ubuntu/" rel="alternate"></link><published>2010-02-11T16:51:00+00:00</published><updated>2010-02-11T16:51:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-11:/2010/02/11/howto-iptables-on-debian-ubuntu/</id><summary type="html">
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;Simple, if it’s not installed already then run the following commands&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;iptables
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/iptables&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The safest and best way of configuring iptables, in my opinion, is to
have two files. The first is a temporary/test set that you will save to
first, the second is the actual rule set that will be loaded to iptables.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;So, first we’ll create an empty temp rules file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;touch&lt;span class="w"&gt; &lt;/span&gt;/etc/iptables.temp.rules
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Add some simple rules to it:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
*filter
# Allows all loopback traffic and drop all traffic to 127/8 that doesn't use lo

-A INPUT -i lo -j ACCEPT
-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT

# Accepts all established inbound connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allows all outbound traffic
-A OUTPUT -j ACCEPT

#SSH
-A INPUT -p tcp -m …&lt;/pre&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;Simple, if it’s not installed already then run the following commands&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;iptables
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/iptables&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The safest and best way of configuring iptables, in my opinion, is to
have two files. The first is a temporary/test set that you will save to
first, the second is the actual rule set that will be loaded to iptables.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="configuration"&gt;
&lt;h2&gt;Configuration&lt;/h2&gt;
&lt;p&gt;So, first we’ll create an empty temp rules file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;touch&lt;span class="w"&gt; &lt;/span&gt;/etc/iptables.temp.rules
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Add some simple rules to it:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
*filter
# Allows all loopback traffic and drop all traffic to 127/8 that doesn't use lo

-A INPUT -i lo -j ACCEPT
-A INPUT ! -i lo -d 127.0.0.0/8 -j REJECT

# Accepts all established inbound connections
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

# Allows all outbound traffic
-A OUTPUT -j ACCEPT

#SSH
-A INPUT -p tcp -m tcp --dport 22 -j ACCEPT
#HTTP
-A INPUT -p tcp -m tcp --dport 80 -j ACCEPT
#HTTPS
-A INPUT -p tcp -m tcp --dport 443 -j ACCEPT
#SMTP
-A INPUT -p tcp -m tcp --dport 25 -j ACCEPT
#IMAP
-A INPUT -p tcp -m tcp --dport 143 -j ACCEPT
#POP3
-A INPUT -p tcp -m tcp --dport 110 -j ACCEPT
#PING
-A INPUT -p icmp -m icmp --icmp-type 8 -j ACCEPT

# Log
-I INPUT 5 -m limit --limit 5/min -j LOG --log-prefix "iptables denied: " --log-level 7

# Reject all other inbound - default deny unless explicitly allowed
policy
-A INPUT -j REJECT
-A FORWARD -j REJECT

COMMIT
&lt;/pre&gt;
&lt;p&gt;Next we apply this rule set to the currently running iptables instance&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;iptables-restore&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;/etc/iptables.temp.rules
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Check to make sure they loaded correctly&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;iptables&lt;span class="w"&gt; &lt;/span&gt;-L
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If everything looks &lt;span class="caps"&gt;OK&lt;/span&gt; and ready to go then we simply save, this time to
the secondary file that I mentioned earlier&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;iptables-save&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/iptables.up.rules
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="network-interface-configuration"&gt;
&lt;h2&gt;Network interface configuration&lt;/h2&gt;
&lt;p&gt;Open up the following file with your favourite editor&lt;/p&gt;
&lt;blockquote&gt;
/etc/network/interfaces&lt;/blockquote&gt;
&lt;p&gt;Find the following lines:&lt;/p&gt;
&lt;pre class="literal-block"&gt;
auto lo
iface lo inet loopback
&lt;/pre&gt;
&lt;p&gt;And add this to the end&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;pre-up&lt;span class="w"&gt; &lt;/span&gt;iptables-restore&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;/etc/iptables.up.rules
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So that it becomes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;auto&lt;span class="w"&gt; &lt;/span&gt;lo
iface&lt;span class="w"&gt; &lt;/span&gt;lo&lt;span class="w"&gt; &lt;/span&gt;inet&lt;span class="w"&gt; &lt;/span&gt;loopback
&lt;span class="w"&gt;    &lt;/span&gt;pre-up&lt;span class="w"&gt; &lt;/span&gt;iptables-restore&lt;span class="w"&gt; &lt;/span&gt;&amp;lt;&lt;span class="w"&gt; &lt;/span&gt;/etc/iptables.up.rules
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This will restore your custom set of iptables rules when it instantiates
the network devices.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-future"&gt;
&lt;h2&gt;The future&lt;/h2&gt;
&lt;p&gt;When you need to add more rules in the future, simply add them to your
iptables.temp.rules set, load them in to iptables as shown, if
everything looks good then save to iptables.up.rules&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Please note; this is only an extremely basic rule set and will need to
be improved upon by you or another sys admin in your team to properly
secure your server.&lt;/em&gt;&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="howto"></category><category term="iptables"></category><category term="networking"></category><category term="security"></category><category term="ubuntu"></category></entry><entry><title>nginx, proxy_cache and reverse proxying explained &amp; benchmarked</title><link href="https://kura.gg/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/" rel="alternate"></link><published>2010-02-07T10:27:00+00:00</published><updated>2010-02-07T10:27:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-07:/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/</id><summary type="html">
&lt;div class="section" id="the-beginning"&gt;
&lt;h2&gt;The beginning&lt;/h2&gt;
&lt;p&gt;Where to begin? nginx would be a good start I suppose. It’s far easier
and makes much for sense for you to actually read about nginx from it’s
own website - &lt;a class="reference external" href="https://nginx.org/en/"&gt;https://nginx.org/en/&lt;/a&gt; - but just to give a simple
explanation too; `nginx is king of static content &lt;span class="caps"&gt;HTTP&lt;/span&gt; servers.`&lt;/p&gt;
&lt;p&gt;Anyone that has dealt with Apache on medium to high traffic websites
will know that Apache is bit of a `wheezy, old geezer` when it comes
to content serving using it’s mpm-worker (threaded). Very often high
traffic will cause server load to go through the roof but for serving
dynamic content, there really is no better &lt;span class="caps"&gt;HTTP&lt;/span&gt; server than Apache, so
this leaves us in a bit of a predicament; a high powered website with
dynamic content and lots of static files like &lt;span class="caps"&gt;JS&lt;/span&gt;, &lt;span class="caps"&gt;CSS&lt;/span&gt; and imagery, what
do we do?!&lt;/p&gt;
&lt;p&gt;In this example `dynamic …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="the-beginning"&gt;
&lt;h2&gt;The beginning&lt;/h2&gt;
&lt;p&gt;Where to begin? nginx would be a good start I suppose. It’s far easier
and makes much for sense for you to actually read about nginx from it’s
own website - &lt;a class="reference external" href="https://nginx.org/en/"&gt;https://nginx.org/en/&lt;/a&gt; - but just to give a simple
explanation too; `nginx is king of static content &lt;span class="caps"&gt;HTTP&lt;/span&gt; servers.`&lt;/p&gt;
&lt;p&gt;Anyone that has dealt with Apache on medium to high traffic websites
will know that Apache is bit of a `wheezy, old geezer` when it comes
to content serving using it’s mpm-worker (threaded). Very often high
traffic will cause server load to go through the roof but for serving
dynamic content, there really is no better &lt;span class="caps"&gt;HTTP&lt;/span&gt; server than Apache, so
this leaves us in a bit of a predicament; a high powered website with
dynamic content and lots of static files like &lt;span class="caps"&gt;JS&lt;/span&gt;, &lt;span class="caps"&gt;CSS&lt;/span&gt; and imagery, what
do we do?!&lt;/p&gt;
&lt;p&gt;In this example `dynamic content` means content that is drawn from the
&lt;span class="caps"&gt;SQL&lt;/span&gt; &lt;span class="caps"&gt;DB&lt;/span&gt; and used to generate pages using &lt;span class="caps"&gt;PHP&lt;/span&gt;; pages of products, category
trees, etc, a typical ecommerce platform.&lt;/p&gt;
&lt;p&gt;I opted to use nginx to reverse proxy to Apache and serve up just the
static content through nginx itself long ago and, looking down through
the `Related Posts` section of this page you will find at least half a
dozen articles about it, including my original article on how to get
nginx to actually reverse proxy and use &lt;span class="caps"&gt;WP&lt;/span&gt;-Super-Cache to actually
generate cached &lt;span class="caps"&gt;HTML&lt;/span&gt; content that nginx could serve. This article takes
that further.&lt;/p&gt;
&lt;p&gt;If you’ve not read the aforementioned article I would strongly suggest
you do before continuing with this one - &lt;a class="reference external" href="/2010/01/11/debian-apache-2-nginx-wordpress-mu/"&gt;Debian, Apache 2, Nginx, WordPress &lt;span class="caps"&gt;MU&lt;/span&gt; &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; &lt;span class="caps"&gt;WP&lt;/span&gt;-Super-Cache&lt;/a&gt;.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="everything-has-changed"&gt;
&lt;h2&gt;Everything has changed?&lt;/h2&gt;
&lt;p&gt;So now that you’ve read that it’s time to explain what’s different and,
quite simply, everything is. Everything? Everything.&lt;/p&gt;
&lt;p&gt;Gone are the location checks and file checks, all replaced with several
lines that tell nginx that it needs to cache the page content.&lt;/p&gt;
&lt;p&gt;Before I get stuck in on the changes it’s worth pointing out that this
is only possible with version of nginx &amp;gt;= 0.7.65 and within the 0.8.*
branch. According to the nginx website there was a bug in the proxy
caching engine that meant nginx would ignore comma separate cache
controls. So upgrade before attempting this.&lt;/p&gt;
&lt;p&gt;Back to the changes, lets take a look at a small change I made to the
actual nginx main configuration file, on Debian/Ubuntu this is in&lt;/p&gt;
&lt;blockquote&gt;
/etc/nginx/nginx.conf&lt;/blockquote&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;proxy_cache_path&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/syslog.tv/cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;levels=1:2&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;keys_zone=one:8m&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;max_size=1000m&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;inactive=600m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="k"&gt;proxy_temp_path&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/tmp&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;These 2 lines need to be within the main nginx configuration before any
of your server {} definitions, otherwise nginx’s config test will fail
and nginx won’t start.&lt;/p&gt;
&lt;p&gt;The biggest chain was in this site’s server definition, it now looks
like this&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;174.143.241.61&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/syslog.tv.access.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;#the path to your actual site, used for serving static files&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;on&lt;/span&gt;&lt;span class="s"&gt;e&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_key&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;syslog.tv&lt;/span&gt;&lt;span class="nv"&gt;$request_uri&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;200&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;302&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;60m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_cache_valid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;404&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;1m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://apache.syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;
&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The server definition should be relatively easy to understand, we have
the general listen, server_name, access_log and root which are used
everywhere, the only difference now is that I am serving root from
/var/www/syslog.tv/cache which is where nginx is configured to store
it’s cache.&lt;/p&gt;
&lt;p&gt;We set several proxy specific options, proxy_redirect and three
proxy_set_header instances, these are really quite self explanatory;
do not redirect proxy requests, ever and the three headers are passed
over to Apache so it is able to properly log access and see the original
&lt;span class="caps"&gt;IP&lt;/span&gt; rather than seeing nginx’s &lt;span class="caps"&gt;IP&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;The new and important part is from proxy_cache down to proxy_pass,
proxy_pass exists in my original config file but here it is now used in
conjunction with proxy_cache, which sets the zone (zone definition are
in the two lines added to nginx.conf), set the key, sets some timers on
valid responses, in this case 200, 302 and 404 and then passed back to
Apache with proxy_pass.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="so-what-does-it-do"&gt;
&lt;h2&gt;So what does it do?&lt;/h2&gt;
&lt;p&gt;I’m going to assume that you’re with me so far if you’re reading this,
I’ve not lost you or anything, I hope.&lt;/p&gt;
&lt;p&gt;So what is the point of this? What does it do?&lt;/p&gt;
&lt;p&gt;It’s really quite simple; this tells nginx to cache all proxy responses
when they meet the response type requirements for the times defined,
that’s it.&lt;/p&gt;
&lt;p&gt;When nginx loads it will automatically look for a cached version
residing in our root directory before even thinking about reverse
proxying back to Apache, if it finds a cached variant that is still
valid it will serve it, if not it will proxy back to Apache which
generates our page content, which nginx serves and then caches. This
means that the load on Apache is greatly reduced and I mean &lt;strong&gt;greatly&lt;/strong&gt; reduced.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="controlling-the-cache"&gt;
&lt;h2&gt;Controlling the cache&lt;/h2&gt;
&lt;p&gt;The best thing about this setup is how you actually control what gets
cached. Headers. It’s as simple as that.
These are basic &lt;span class="caps"&gt;HTTP&lt;/span&gt; Cache-Control headers:&lt;/p&gt;
&lt;blockquote&gt;
Cache-Control: private, max-age=0&lt;/blockquote&gt;
&lt;p&gt;The one above sets Cache-Control to private with a max-age of 0 and the
one below sets to public with a max age of one hour.&lt;/p&gt;
&lt;blockquote&gt;
Cache-Control: public, max-age=3600&lt;/blockquote&gt;
&lt;p&gt;nginx will respect these headers and handle the caching accordingly, you
can set these headers through &lt;span class="caps"&gt;PHP&lt;/span&gt; and have pages not get cached, you can
even use .htaccess to set the headers on specific directories, files or
file extensions or you could even just set them in your site’s server
definition. Amazing stuff.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-numbers"&gt;
&lt;h2&gt;The numbers&lt;/h2&gt;
&lt;pre class="literal-block"&gt;
Benchmarking this setup actually scared me, I was completely amazed
out how well nginx performed.
Benchmarking syslog.tv (be patient)
...
Finished 10000 requests

Server Software: nginx/0.7.65
Server Hostname: syslog.tv
Server Port: 80
...
Concurrency Level: 200
Time taken for tests: 93.371 seconds
Complete requests: 10000
Failed requests: 0
Write errors: 0
Total transferred: 74634408 bytes
HTML transferred: 72015948 bytes
Requests per second: 107.10 [#/sec] (mean)
Time per request: 1867.419 [ms] (mean)
Time per request: 9.337 [ms] (mean, across all concurrent requests)
Transfer rate: 780.60 [Kbytes/sec] received

Connection Times (ms)
min mean[+/-sd] median max
Connect: 10 611 245.9 600 3640
Processing: 70 1238 142.0 1250 5100
Waiting: 70 611 100.5 600 4100
Total: 80 1849 266.2 1860 6240

Percentage of the requests served within a certain time (ms)
50% 1860
66% 1860
75% 1860
80% 1880
90% 1880
95% 1900
98% 1920
99% 2260
100% 6240 (longest request)
&lt;/pre&gt;
&lt;p&gt;That is very good, the server this website runs on is very underpowered,
&lt;span class="caps"&gt;256MB&lt;/span&gt; of &lt;span class="caps"&gt;RAM&lt;/span&gt;, single virtual core just in case anyone thinks I cheated
and used a 32 core machine.&lt;/p&gt;
&lt;p&gt;What is also worth mentioning is the load average&lt;/p&gt;
&lt;blockquote&gt;
load average: 0.08, 0.06, 0.03&lt;/blockquote&gt;
&lt;p&gt;I’m hoping your eyes are as wide as mine were when I saw this average,
200 concurrent connections on nginx and the load average doesn’t go
above 0.08 the whole time. It served 10,000 requests with 0 failures,
200 at a time in 93.371 seconds…&lt;/p&gt;
&lt;p&gt;I tried the same with proxy_caching disable and also directly against
Apache, both times with a KeepAlive On and KeepAliveTimeOut 5 Apache
fell over, load went through the roof and I had to hard reset the server
both times. Apache couldn’t even handle 50 concurrent requests, let
alone 200.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-conclusion"&gt;
&lt;h2&gt;The conclusion&lt;/h2&gt;
&lt;p&gt;The conclusion is simple for me; I love nginx and will continue to use
it as much as I can to increase performance, this does not mean I have
any dislike for Apache at all, in fact I know very well that to do
things well in this field you need to have multiple systems in place to
handle multiple things, especially with high traffic sites.&lt;/p&gt;
&lt;p&gt;For me the future is simple, cache as much content as I possibly can and
use nginx to serve it.&lt;/p&gt;
&lt;p&gt;The next steps for me will be using Varnish for caching, nginx for load
balancing and also trying caching content to Memcached. As always
finding will be reported here.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="cache"></category><category term="debian"></category><category term="howto"></category><category term="nginx"></category><category term="php"></category><category term="ubuntu"></category><category term="wordpress"></category></entry><entry><title>Using nginx, Varnish and Apache</title><link href="https://kura.gg/2010/02/06/using-nginx-varnish-and-apache/" rel="alternate"></link><published>2010-02-06T10:36:00+00:00</published><updated>2010-02-06T10:36:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-02-06:/2010/02/06/using-nginx-varnish-and-apache/</id><summary type="html">
&lt;div class="section" id="the-problem"&gt;
&lt;h2&gt;The problem&lt;/h2&gt;
&lt;p&gt;So lets get to the problem first. I have several lightly to medium
loaded sites running on some virtual servers, they servers themselves
are highly configured to run beautifully on our host environments, very,
very &lt;span class="caps"&gt;RAM&lt;/span&gt; intensive but low disk I/O and low &lt;span class="caps"&gt;CPU&lt;/span&gt; usage.&lt;/p&gt;
&lt;p&gt;As mentioned, the sites are relatively low loaded, they’ll generally
hang around at between 3,000-5,000 unique hits a day and are run through
Apache using &lt;span class="caps"&gt;PHP&lt;/span&gt;, various &lt;span class="caps"&gt;PHP&lt;/span&gt; modules and MySQL, a simple generic &lt;span class="caps"&gt;LAMP&lt;/span&gt;
environment, yet customised to suit it’s surroundings and host.&lt;/p&gt;
&lt;p&gt;The sites themselves run fine on that setup, no issues at all on normal
days, but on set days of the week these sites can double in unique hits
or even more than double, with KeepAlive enabled and a KeepAliveTimeout
set low Apache has problems handling this kind of load (I should point
out …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;div class="section" id="the-problem"&gt;
&lt;h2&gt;The problem&lt;/h2&gt;
&lt;p&gt;So lets get to the problem first. I have several lightly to medium
loaded sites running on some virtual servers, they servers themselves
are highly configured to run beautifully on our host environments, very,
very &lt;span class="caps"&gt;RAM&lt;/span&gt; intensive but low disk I/O and low &lt;span class="caps"&gt;CPU&lt;/span&gt; usage.&lt;/p&gt;
&lt;p&gt;As mentioned, the sites are relatively low loaded, they’ll generally
hang around at between 3,000-5,000 unique hits a day and are run through
Apache using &lt;span class="caps"&gt;PHP&lt;/span&gt;, various &lt;span class="caps"&gt;PHP&lt;/span&gt; modules and MySQL, a simple generic &lt;span class="caps"&gt;LAMP&lt;/span&gt;
environment, yet customised to suit it’s surroundings and host.&lt;/p&gt;
&lt;p&gt;The sites themselves run fine on that setup, no issues at all on normal
days, but on set days of the week these sites can double in unique hits
or even more than double, with KeepAlive enabled and a KeepAliveTimeout
set low Apache has problems handling this kind of load (I should point
out that Apache only starts to struggle if there are a lot of concurrent
requests or if there’s a lot of &lt;span class="caps"&gt;SSL&lt;/span&gt; activity).&lt;/p&gt;
&lt;p&gt;We’re serving a lot of static content with each request, at least half a
dozen &lt;span class="caps"&gt;CSS&lt;/span&gt; files and half a dozen &lt;span class="caps"&gt;JS&lt;/span&gt; files, literally dozens of images
and this will increase depending on the pages you’re viewing and to top
it all off, an entire subset of pages that use &lt;span class="caps"&gt;SSL&lt;/span&gt; with obviously all
assets being run through &lt;span class="caps"&gt;SSL&lt;/span&gt; too.&lt;/p&gt;
&lt;p&gt;So now we have a problem, even with double the average load on a single
server with all those assets we’re greatly increasing the strain on
Apache, Apache can handle it but the server isn’t very happy so I have
to make a decision, do I load balance Apache or do I set up a way of
serving static content through an &lt;span class="caps"&gt;HTTPD&lt;/span&gt; that is designed for it?&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-first-solution"&gt;
&lt;h2&gt;The first solution&lt;/h2&gt;
&lt;p&gt;The choice was simple, we serve static content through nginx, much like
I do with this blog but even more restrictive since this whole blog is cached.&lt;/p&gt;
&lt;p&gt;This is relatively easy and is covered in other blog post that should be
linked in the “related posts” section below, I successfully configured
nginx to reverse proxy connections back to when the content was non
static, i.e. &lt;span class="caps"&gt;PHP&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;This in itself yielded a much higher rate of requests/second because
nginx was doing a lot of the grunt work, not content with this though I
wanted to actually cache the dynamic pages that were hit the most. This
was the homepage, various offer pages and some other site-specific pages.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-second-solution"&gt;
&lt;h2&gt;The second solution&lt;/h2&gt;
&lt;p&gt;The next step of this, as mentioned above is to get some caching in
place, I’ve had experience caching proxy requests using nginx, as
mentioned above this blog uses the same configuration but is very less
restrictive, it literally caches everything except my admin pages. This
is not at all viable on these websites due to dynamic user content etc.&lt;/p&gt;
&lt;p&gt;So the next step was to introduce conditional nginx caching.&lt;/p&gt;
&lt;p&gt;I was rather unsure of exactly how to achieve this but the nginx forums
yielded amazingly useful information (&lt;a class="reference external" href="https://forum.nginx.org/"&gt;https://forum.nginx.org/&lt;/a&gt;) which
helped me create a very simple caching mechanism; a user hits the
website, all content is served by nginx which reverse proxies dynamic
content to Apache, the page content is cached when a user does not have
a login session cookie and any other requests to this page will serve
the cached version which dies after 1 hour, when a user does have a
login session cookie nginx does not serve the cached content but
continues to reverse proxy to Apache. Simple.&lt;/p&gt;
&lt;p&gt;This in itself is still untested on the testing environment because I
only completed it at 2am &lt;span class="caps"&gt;GMT&lt;/span&gt; and was rather tired at the time. I have
high hopes for it though, but it doesn’t stop there…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-final-phase"&gt;
&lt;h2&gt;The final phase&lt;/h2&gt;
&lt;p&gt;The final phase is still on my planning board and is probably overkill
for what we need, but it doesn’t hurt to test things and the techie in
me is desperate to waste more of my free time on squeezing as much
performance out of our applications as I can. And, to be perfectly
honest, we may need something like this in the future for some much
higher traffic sites or to port older, high traffic sites on to.&lt;/p&gt;
&lt;p&gt;So what’s the plan? &lt;strong&gt;Varnish&lt;/strong&gt;. Not the kind you use on wood or on your
nails but a very powerful &lt;span class="caps"&gt;HTTP&lt;/span&gt; caching engine -
&lt;a class="reference external" href="https://varnish-cache.org/wiki/Introduction"&gt;https://varnish-cache.org/wiki/Introduction&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Varnish is currently used in conjunction with nginx on some very highly
used sites; WordPress.com, Gravatar and I’m sure many more.&lt;/p&gt;
&lt;p&gt;The idea is simple, a visitor will come to the site, nginx will do one
of two things which are outlined above but I will go through them again;
all static content will be served with nginx but directly from the
varnish cache, if a visitor has no login session cookie then nginx will
serve the page cache from Varnish, if a user does have a login session
cookie Varnish will proxy the request back to Apache. It’s a sort of
double reverse proxy setup and I can’t wait to see it in action.&lt;/p&gt;
&lt;p&gt;I will report back here once I have some more time to even get this
setup but I doubt it’ll happen for a week or more, sadly.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="cache"></category><category term="nginx"></category><category term="varnish"></category></entry><entry><title>HOWTO: Debian - Apache 2 SSL on multiple virtual hosts</title><link href="https://kura.gg/2010/01/15/howto-debian-apache2-ssl-multiple-vhosts/" rel="alternate"></link><published>2010-01-15T06:24:00+00:00</published><updated>2010-01-15T06:24:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-01-15:/2010/01/15/howto-debian-apache2-ssl-multiple-vhosts/</id><summary type="html">&lt;p&gt;Figured I’d write this one up quickly as it proved to annoy the hell out
of me at 4:30am this morning getting it working on a live server.&lt;/p&gt;
&lt;p&gt;Apache 2 can serve &lt;span class="caps"&gt;SSL&lt;/span&gt; content to multiple vhosts on your setup,
provided they use different &lt;span class="caps"&gt;IP&lt;/span&gt; addresses, this post will give you a
quick run down on how to do it.&lt;/p&gt;
&lt;p&gt;First up we need to actually add the new &lt;span class="caps"&gt;IP&lt;/span&gt; to the machine in /etc/network/interfaces.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
auto eth0
iface eth0 inet static
    address 10.1.1.7
    netmask 255.255.255.0
    gateway 10.1.1.1

auto eth0:1
iface eth0:1 inet static
    address 10.1.1.8
    netmask 255.255.255.0
&lt;/pre&gt;
&lt;p&gt;Replace my IPs with your own.&lt;/p&gt;
&lt;p&gt;Restart networking.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/networking&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next task is Apache 2 to configure it to listen on both IPs.&lt;/p&gt;
&lt;blockquote&gt;
/etc/apache2/ports.conf&lt;/blockquote&gt;
&lt;p&gt;My …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Figured I’d write this one up quickly as it proved to annoy the hell out
of me at 4:30am this morning getting it working on a live server.&lt;/p&gt;
&lt;p&gt;Apache 2 can serve &lt;span class="caps"&gt;SSL&lt;/span&gt; content to multiple vhosts on your setup,
provided they use different &lt;span class="caps"&gt;IP&lt;/span&gt; addresses, this post will give you a
quick run down on how to do it.&lt;/p&gt;
&lt;p&gt;First up we need to actually add the new &lt;span class="caps"&gt;IP&lt;/span&gt; to the machine in /etc/network/interfaces.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
auto eth0
iface eth0 inet static
    address 10.1.1.7
    netmask 255.255.255.0
    gateway 10.1.1.1

auto eth0:1
iface eth0:1 inet static
    address 10.1.1.8
    netmask 255.255.255.0
&lt;/pre&gt;
&lt;p&gt;Replace my IPs with your own.&lt;/p&gt;
&lt;p&gt;Restart networking.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/networking&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next task is Apache 2 to configure it to listen on both IPs.&lt;/p&gt;
&lt;blockquote&gt;
/etc/apache2/ports.conf&lt;/blockquote&gt;
&lt;p&gt;My changes&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;IfModule&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;mod_ssl.c&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;Listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10.1.1.7&lt;/span&gt;:443
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;Listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10.1.1.8&lt;/span&gt;:443
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;NameVirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10.1.1.7&lt;/span&gt;:443
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;NameVirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;10.1.1.8&lt;/span&gt;:443
&lt;span class="nt"&gt;&amp;lt;/IfModule&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That basically tells Apache to listen to port 443 on both those &lt;span class="caps"&gt;IP&lt;/span&gt;
addresses and sets up 2 NameVirtualHosts, 1 for each &lt;span class="caps"&gt;IP&lt;/span&gt;:&lt;span class="caps"&gt;PORT&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;The next step is to set up the VirtualHosts, I am going to use a sample
that has almost no directives, excluding all of the actual &lt;span class="caps"&gt;SSL&lt;/span&gt;
directives to make things easier to read.&lt;/p&gt;
&lt;p&gt;Host 1&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;VirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;10.1.1.7:443&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ServerName&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;web1.example.com
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;DocumentRoot&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/path/to/html1&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/VirtualHost&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Host 2&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;VirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;10.1.1.8:443&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ServerName&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;web2.example.com
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;DocumentRoot&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/path/to/html2&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/VirtualHost&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That is a very basic config but I hope it helps you understand how each
VirtualHost actually works when multiple IPs are used.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apache2ctl&lt;span class="w"&gt; &lt;/span&gt;configtest
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/apache2&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="debian"></category><category term="eth0"></category><category term="howto"></category><category term="mod_ssl"></category><category term="networking"></category><category term="ssl"></category><category term="vhost"></category></entry><entry><title>HOWTO: Debian server security</title><link href="https://kura.gg/2010/01/14/howto-debian-server-security/" rel="alternate"></link><published>2010-01-14T19:57:00+00:00</published><updated>2010-01-14T19:57:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-01-14:/2010/01/14/howto-debian-server-security/</id><summary type="html">
&lt;p&gt;Server security is something I’ve always tried to keep myself up-to-date
on. I have at least a dozen &lt;span class="caps"&gt;RSS&lt;/span&gt; feeds that I read daily to learn about
the latest flaws, holes releases etc. That being said I am by no means
an “expert”, I’ve learned what I’ve needed to learn over time. I like to
think that over the years I’ve gained enough knowledge to almost
completely secure servers with all the programs installed that I
generally use.&lt;/p&gt;
&lt;p&gt;The aim of this article is to introduce you to some of the programs I
use for security and some config changes that can be made to other
programs to make them more secure. It is aimed at web servers but other
changes work anywhere, like the &lt;span class="caps"&gt;SSH&lt;/span&gt; changes.&lt;/p&gt;
&lt;div class="section" id="ssh"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SSH&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;We’ll start with a very simple change that makes a very big difference,
a change to the …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Server security is something I’ve always tried to keep myself up-to-date
on. I have at least a dozen &lt;span class="caps"&gt;RSS&lt;/span&gt; feeds that I read daily to learn about
the latest flaws, holes releases etc. That being said I am by no means
an “expert”, I’ve learned what I’ve needed to learn over time. I like to
think that over the years I’ve gained enough knowledge to almost
completely secure servers with all the programs installed that I
generally use.&lt;/p&gt;
&lt;p&gt;The aim of this article is to introduce you to some of the programs I
use for security and some config changes that can be made to other
programs to make them more secure. It is aimed at web servers but other
changes work anywhere, like the &lt;span class="caps"&gt;SSH&lt;/span&gt; changes.&lt;/p&gt;
&lt;div class="section" id="ssh"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SSH&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;We’ll start with a very simple change that makes a very big difference,
a change to the security of &lt;span class="caps"&gt;SSH&lt;/span&gt;. The file is located in the location
below on a Debian system.&lt;/p&gt;
&lt;blockquote&gt;
/etc/ssh/sshd_config&lt;/blockquote&gt;
&lt;p&gt;Replace this.&lt;/p&gt;
&lt;blockquote&gt;
PermitRootLogin yes&lt;/blockquote&gt;
&lt;p&gt;With this.&lt;/p&gt;
&lt;blockquote&gt;
PermitRootLogin no&lt;/blockquote&gt;
&lt;p&gt;This one change will massively reduce risk on your servers, no root &lt;span class="caps"&gt;SSH&lt;/span&gt;
access means no chance of brute forced accounts, well, not direct
attacks. Please be advised though, this change applies to you too, you
will have to log in to the server as another user and use &lt;strong&gt;su&lt;/strong&gt; or
&lt;strong&gt;sudo su&lt;/strong&gt;. You can always read my article on sudo/sudoers to learn
more about sudo.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="denyhosts"&gt;
&lt;h2&gt;DenyHosts&lt;/h2&gt;
&lt;p&gt;This is one of my favourite programs, if not my favourite program and is
of course available from the Debian repository.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;denyhosts
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once installed it will configure itself and should start on it’s own
too. DenyHosts will monitor your &lt;span class="caps"&gt;SSH&lt;/span&gt; logs and ban people that it sees
attacking you. One thing that should be mentioned is DenyHosts will only
work if &lt;span class="caps"&gt;SSH&lt;/span&gt; is compiled with &lt;span class="caps"&gt;TLS&lt;/span&gt; wrappers enabled. If you installed &lt;span class="caps"&gt;SSH&lt;/span&gt;
using apt-get this won’t be an issue.&lt;/p&gt;
&lt;p&gt;The way it works is really simple and partly explained above, DenyHosts
can be configured so you can set your own failed attempt thresholds, the
banned hosts are put in your denied hosts file, on a Debian system this is:&lt;/p&gt;
&lt;blockquote&gt;
/etc/hosts.deny&lt;/blockquote&gt;
&lt;p&gt;If you’re worried about banning yourself then put your &lt;span class="caps"&gt;IP&lt;/span&gt; address in
this file.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;/etc/hosts.allow&lt;/p&gt;
&lt;p&gt;&lt;span class="caps"&gt;ALL&lt;/span&gt;: &lt;span class="caps"&gt;YOUR&lt;/span&gt;.&lt;span class="caps"&gt;IP&lt;/span&gt;.&lt;span class="caps"&gt;HERE&lt;/span&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Some changes I always make are shown below, don’t use these without
reading the config file to see what they actually do.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
BLOCK_SERVICE = ALL
DENY_THRESHOLD_INVALID = 5
DENY_THRESHOLD_VALID = 10
DENY_THRESHOLD_ROOT = 1
DENY_THRESHOLD_RESTRICTED = 1
HOSTNAME_LOOKUP=YES
ADMIN_EMAIL = myemail@mydomain.tld
SMTP_HOST = localhost
SMTP_PORT = 25
SMTP_HOST = localhost
SMTP_PORT = 25
SMTP_FROM = DenyHosts &amp;lt;denyhosts@SERVERNAME&amp;gt;
SMTP_SUBJECT = DenyHosts Report from $[HOSTNAME]
&lt;/pre&gt;
&lt;p&gt;Once configured simply restart the DenyHosts daemon.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/denyhosts&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="logwatch"&gt;
&lt;h2&gt;Logwatch&lt;/h2&gt;
&lt;p&gt;Next up is another fantastic little program. It’s simple, it’s
lightweight and… it’s in the Debian repository.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;logwatch
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This program does as it’s name suggests, it watches your log files, it
then emails them to you every day and runs from &lt;strong&gt;/etc/cron.daily&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;There really is no configuration required for logwatch, I personally
just edit the cron job to force a mailto.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;/usr/sbin/logwatch&lt;span class="w"&gt; &lt;/span&gt;--mailto&lt;span class="w"&gt; &lt;/span&gt;myemail@mydomain.tld
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Logwatch will send you a nice, tidy email every day giving you stats etc.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
--------------------- httpd Begin ------------------------
Requests with error response codes

400 Bad Request
/w00tw00t.at.ISC.SANS.DFind:): 1 Time(s)
/w00tw00t.at.ISC.SANS.test0:): 1 Time(s)

404 Not Found
//phpMyAdmin//scripts/setup.php: 1 Time(s)
//phpmyadmin//scripts/setup.php: 1 Time(s)
&lt;/pre&gt;
&lt;p&gt;As you can see, a few people have tried to find holes in my Apache and
also things that aren’t even present on my server.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
Snip.

--------------------- SSHD Begin ------------------------

Users logging in through sshd:

hidden:
***.***.***.*** (my.hostname.com): 4 times

Refused incoming connections:
190.144.99.98 (190.144.99.98): 2 Time(s)
61.168.227.12 (61.168.227.12): 2 Time(s)
host.united-rx.com (209.59.172.198): 2 Time(s)

---------------------- SSHD End -------------------------

Snip.

--------------------- Sudo (secure-log) Begin------------------------

myuser =&amp;gt; root
------------
/bin/su - 1 Times.
---------------------- Sudo (secure-log) End-------------------------
&lt;/pre&gt;
&lt;p&gt;With that said it’s now time to move on to the actual “web server” side
of things, the following changes are all personal preference but do help
increase security.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="apache-2"&gt;
&lt;h2&gt;Apache 2&lt;/h2&gt;
&lt;p&gt;These changes are made to the following conf file on a Debian server.&lt;/p&gt;
&lt;blockquote&gt;
/etc/apache2/apache2.conf&lt;/blockquote&gt;
&lt;p&gt;Only show minimal information in headers.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;ServerTokens&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;Prod
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Don’t include server version in server-generated pages.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;ServerSignature&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;Off&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Disable the icons alias that FancyIndexed directory listings use.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c"&gt;#Alias /icons/ "/var/www/icons/"&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The following change will need to be done to your vhosts too, it
disallows users from browsing your directory structures when no index
file is present.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;Options&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-Indexes
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Restart apache and you’re good.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/apache2&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="php"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;PHP&lt;/span&gt;&lt;/h2&gt;
&lt;p&gt;The following changes help to hide and secure &lt;span class="caps"&gt;PHP&lt;/span&gt;. You need to make them
in the following file.&lt;/p&gt;
&lt;blockquote&gt;
/etc/php5/apache2/php.ini&lt;/blockquote&gt;
&lt;p&gt;Turn off &lt;span class="caps"&gt;PHP&lt;/span&gt; exposure.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;expose_php&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Off&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Preventing session fixation. For more information on this please see
&lt;a class="reference external" href="https://www.acros.si/papers/session_fixation.pdf"&gt;this paper&lt;/a&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="na"&gt;session.use_only_cookies&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;1&lt;/span&gt;
&lt;span class="na"&gt;session.cookie_httponly&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;1&lt;/span&gt;
&lt;span class="na"&gt;session.use_trans_sid&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;0&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once changed simply restart Apache.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/apache2&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="round-up"&gt;
&lt;h2&gt;Round up&lt;/h2&gt;
&lt;p&gt;There are many more ways to secure a server but I hope these changes
help you secure yours.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="debian"></category><category term="denyhosts"></category><category term="howto"></category><category term="logwatch"></category><category term="php"></category><category term="security"></category></entry><entry><title>HOWTO: Debian - Sudo(ers) explained</title><link href="https://kura.gg/2010/01/13/howto-debian-sudoers-explained/" rel="alternate"></link><published>2010-01-13T03:56:00+00:00</published><updated>2010-01-13T03:56:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-01-13:/2010/01/13/howto-debian-sudoers-explained/</id><summary type="html">
&lt;p&gt;Ah sudo, one of my favourites, funnily enough I’ve noticed a lot of
Linux users use sudo (mainly because Ubuntu installs and configures your
first user by default,) but very few seem to know that much about it.
This can include not even knowing how to add a user to sudoers.&lt;/p&gt;
&lt;p&gt;This article will give you some useful information on what sudo actually
is, how to configure it and how to restrict it.&lt;/p&gt;
&lt;div class="section" id="what-is-sudo"&gt;
&lt;h2&gt;What is sudo?&lt;/h2&gt;
&lt;p&gt;So, quickly running &lt;strong&gt;man sudo&lt;/strong&gt; gives us some information what sudo
actually is and does.&lt;/p&gt;
&lt;blockquote&gt;
sudo allows a permitted user to execute a command as the superuser
or another user, as specified in the sudoers file. The real and
effective uid and gid are set to match those of the target user as
specified in the passwd file and the group vector is initialized
based on the group file (unless the -P option …&lt;/blockquote&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;Ah sudo, one of my favourites, funnily enough I’ve noticed a lot of
Linux users use sudo (mainly because Ubuntu installs and configures your
first user by default,) but very few seem to know that much about it.
This can include not even knowing how to add a user to sudoers.&lt;/p&gt;
&lt;p&gt;This article will give you some useful information on what sudo actually
is, how to configure it and how to restrict it.&lt;/p&gt;
&lt;div class="section" id="what-is-sudo"&gt;
&lt;h2&gt;What is sudo?&lt;/h2&gt;
&lt;p&gt;So, quickly running &lt;strong&gt;man sudo&lt;/strong&gt; gives us some information what sudo
actually is and does.&lt;/p&gt;
&lt;blockquote&gt;
sudo allows a permitted user to execute a command as the superuser
or another user, as specified in the sudoers file. The real and
effective uid and gid are set to match those of the target user as
specified in the passwd file and the group vector is initialized
based on the group file (unless the -P option was specified). If the
invoking user is root or if the target user is the same as the
invoking user, no password is required. Otherwise, sudo requires
that users authenticate themselves with a password by default (&lt;span class="caps"&gt;NOTE&lt;/span&gt;:
in the default configuration this is the user’s password, not the
root password). Once a user has been authenticated, a timestamp is
updated and the user may then use sudo without a password for a
short period of time (15 minutes unless overridden in sudoers).&lt;/blockquote&gt;
&lt;/div&gt;
&lt;div class="section" id="why-use-sudo"&gt;
&lt;h2&gt;Why use sudo?&lt;/h2&gt;
&lt;p&gt;So now that we know what sudo is, why use it? Well, one of the main (and
probably biggest reasons) for using sudo is giving users and groups
access to commands that as a normal user they wouldn’t normally be able
to use.&lt;/p&gt;
&lt;p&gt;If configured correctly you can have all commands run through sudo
logged, which you can then do wonderous things with like have emailed to
you as I do, using Logwatch.&lt;/p&gt;
&lt;p&gt;sudo uses the users password, this means no revealing root passwords to
random users in order to allow them to run a few extra commands that
they need to use. “But I can just change access permissions on programs
if I want them accessible” I hear you cry, of course you can, but there
are some things you simply don’t want to expose and yes, you can argue
that you just add a user to a group that has permissions but sudo is
just a better way of controlling access.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="installing-sudo"&gt;
&lt;h2&gt;Installing sudo&lt;/h2&gt;
&lt;p&gt;So first things first, lets install sudo.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;sudo
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Chances are you’ve probably already got sudo installed but depending on
how you installed Debian (or whichever flavour you’re using) you may not
have chosen to install it.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="so-how-do-i-use-sudo"&gt;
&lt;h2&gt;So how do I use sudo?&lt;/h2&gt;
&lt;p&gt;Well, this is what &lt;strong&gt;man sudo&lt;/strong&gt; is for, but basically it’s simple:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;cat&lt;span class="w"&gt; &lt;/span&gt;/etc/issue
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Yes, this command would work without the need for sudo, but I wanted a
simple example usage.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-users-to-sudo"&gt;
&lt;h2&gt;Adding users to sudo&lt;/h2&gt;
&lt;p&gt;There are a couple of ways of doing this, you can either edit
&lt;strong&gt;/etc/sudoers&lt;/strong&gt; with your favourite editor or use &lt;strong&gt;visudo&lt;/strong&gt;. visudo
will use which ever editor you have set using export. I’ve seen some
distributions that do not allow direct access to /etc/sudoers and force
you to use visudo, I’ve also read and seen that visudo does some
checking before saving. I personally know enough and feel comfortable
enough with the sudoers file to edit it directly, but that’s just my choice.&lt;/p&gt;
&lt;p&gt;So, open your sudoers list using your chosen method, you should see
something similar to this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;root&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;ALL&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;ALL&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;ALL
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So, what does this mean? Well, it’s actually surprisingly simple. The
first part &lt;strong&gt;“root”&lt;/strong&gt; is the name of the user, the second &lt;strong&gt;“&lt;span class="caps"&gt;ALL&lt;/span&gt;”&lt;/strong&gt; is
the host that this definition belongs to, chances are you don’t need to
change this, the third &lt;strong&gt;“&lt;span class="caps"&gt;ALL&lt;/span&gt;”&lt;/strong&gt; is the user(s) to allow the user to run
commands as and the final &lt;strong&gt;“&lt;span class="caps"&gt;ALL&lt;/span&gt;”&lt;/strong&gt; is a list of commands that the user
can run.&lt;/p&gt;
&lt;p&gt;So, this might be a bit daunting from that explanation, so lets take a
look at a user I’ll create for myself&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;kura&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;ALL&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;root&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/usr/bin/apt-get,&lt;span class="w"&gt; &lt;/span&gt;/usr/bin/vi
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So lets break that down; the user &lt;strong&gt;kura&lt;/strong&gt; can run the commands
&lt;strong&gt;/usr/bin/apt-get&lt;/strong&gt; and &lt;strong&gt;/usr/bin/vi&lt;/strong&gt; as the user &lt;strong&gt;root&lt;/strong&gt; on all hosts.&lt;/p&gt;
&lt;p&gt;Hopefully that makes it simple to understand. For the user that the
commands are run as you can user any user or daemon on the server, for
example root could be another user, in the following example I will use
a different user called admin.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;kura&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;ALL&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;admin&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/usr/bin/apt-get,&lt;span class="w"&gt; &lt;/span&gt;/usr/bin/vi
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="adding-groups-to-sudoers"&gt;
&lt;h2&gt;Adding groups to sudoers&lt;/h2&gt;
&lt;p&gt;The approach for this is exactly the same as for users except you use %
to define a group.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;%sudoers&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;ALL&lt;/span&gt;&lt;span class="o"&gt;=(&lt;/span&gt;root&lt;span class="o"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/usr/bin/apt-get,&lt;span class="w"&gt; &lt;/span&gt;/usr/bin/vi
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And now to wrap this article up…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="how-i-personally-use-sudoers"&gt;
&lt;h2&gt;How I personally use sudoers&lt;/h2&gt;
&lt;p&gt;I use sudoers on all of my servers and my approach to locking them down
is simple; I have a user that has access to &lt;span class="caps"&gt;ALL&lt;/span&gt; users and &lt;span class="caps"&gt;ALL&lt;/span&gt; commands,
I then have a group called sudoers that users can be added to that have
access to some commands that they may need from time to time, giving
them the ability to do things like tailing system logs. I also have
Logwatch installed which will email me with my daily log report which
includes a list of all users that ran commands via sudo and tells me
which commands they ran. This way I can keep an eye on them.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="howto"></category><category term="sudo"></category><category term="sudoers"></category></entry><entry><title>HOWTO: Debian, Apache 2 &amp; mod_ssl with self signed cert. or officially signed cert.</title><link href="https://kura.gg/2010/01/12/howto-debian-apache-2-amp-mod_ssl/" rel="alternate"></link><published>2010-01-12T22:57:00+00:00</published><updated>2010-01-12T22:57:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-01-12:/2010/01/12/howto-debian-apache-2-amp-mod_ssl/</id><summary type="html">
&lt;p&gt;This is gonna be quite a simple tutorial that should be the same
(excluding pathing and apt) across other Linux distros.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;First off we’ll get Apache and mod_ssl install&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;apache2
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt; should be enabled by default, if not run the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;a2enmod&lt;span class="w"&gt; &lt;/span&gt;ssl
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="ssl-certificate"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt; certificate&lt;/h2&gt;
&lt;p&gt;There are several ways of doing this, the first you need to figure out
is if you want a self signed certificate or one signed by a provider
like GeoTrust, this type is not free. In this article I’ll cover both,
starting with self signed.&lt;/p&gt;
&lt;div class="section" id="self-signed"&gt;
&lt;h3&gt;Self signed&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudp&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/ssl
sudo&lt;span class="w"&gt; &lt;/span&gt;/usr/sbin/make-ssl-cert&lt;span class="w"&gt; &lt;/span&gt;/usr/share/ssl-cert/ssleay.cnf&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/ssl/apache.pem
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="provider-signed"&gt;
&lt;h3&gt;Provider signed&lt;/h3&gt;
&lt;p&gt;Please note, this type of certificate has to be paid for, prices at time
of writing range from £15/year to £2,000/year.&lt;/p&gt;
&lt;p&gt;There are actually some more options …&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;This is gonna be quite a simple tutorial that should be the same
(excluding pathing and apt) across other Linux distros.&lt;/p&gt;
&lt;div class="section" id="installation"&gt;
&lt;h2&gt;Installation&lt;/h2&gt;
&lt;p&gt;First off we’ll get Apache and mod_ssl install&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;apache2
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt; should be enabled by default, if not run the following&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;a2enmod&lt;span class="w"&gt; &lt;/span&gt;ssl
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="ssl-certificate"&gt;
&lt;h2&gt;&lt;span class="caps"&gt;SSL&lt;/span&gt; certificate&lt;/h2&gt;
&lt;p&gt;There are several ways of doing this, the first you need to figure out
is if you want a self signed certificate or one signed by a provider
like GeoTrust, this type is not free. In this article I’ll cover both,
starting with self signed.&lt;/p&gt;
&lt;div class="section" id="self-signed"&gt;
&lt;h3&gt;Self signed&lt;/h3&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudp&lt;span class="w"&gt; &lt;/span&gt;mkdir&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/ssl
sudo&lt;span class="w"&gt; &lt;/span&gt;/usr/sbin/make-ssl-cert&lt;span class="w"&gt; &lt;/span&gt;/usr/share/ssl-cert/ssleay.cnf&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/ssl/apache.pem
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="provider-signed"&gt;
&lt;h3&gt;Provider signed&lt;/h3&gt;
&lt;p&gt;Please note, this type of certificate has to be paid for, prices at time
of writing range from £15/year to £2,000/year.&lt;/p&gt;
&lt;p&gt;There are actually some more options when it comes to generating a key
for this &lt;span class="caps"&gt;CRT&lt;/span&gt;, the first way creates a key that does not require a
passphrase, the second way requires a passphrase and, unless you make a
special change to your Apache config along with a small bash script
(will go through later) will ask you for the passphrase for each key
every time you restart Apache.&lt;/p&gt;
&lt;div class="section" id="without-a-passphrase"&gt;
&lt;h4&gt;Without a passphrase&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;genrsa&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;DOMAINNAME.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="with-a-passphrase"&gt;
&lt;h4&gt;With a passphrase&lt;/h4&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;genrsa&lt;span class="w"&gt; &lt;/span&gt;-des3&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;DOMAINNAME.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;4096&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Replace &lt;span class="caps"&gt;DOMAINNAME&lt;/span&gt; with your domain name, I find this makes it much
easier if all of my certs and keys are named accordingly, but that’s
just me. I also generally use at least a 4096bit modulus, feel free to
change this to whatever you wish, some signers will only take a key of a
specific size.&lt;/p&gt;
&lt;p&gt;Next up is actually generating the &lt;span class="caps"&gt;CSR&lt;/span&gt; from the key.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;req&lt;span class="w"&gt; &lt;/span&gt;-new&lt;span class="w"&gt; &lt;/span&gt;-key&lt;span class="w"&gt; &lt;/span&gt;DOMAINNAME.key&lt;span class="w"&gt; &lt;/span&gt;&amp;gt;&lt;span class="w"&gt; &lt;/span&gt;DOMAINNAME.csr
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As a note, it’s very badly wordly but &lt;span class="caps"&gt;COMMON&lt;/span&gt; &lt;span class="caps"&gt;NAME&lt;/span&gt; is the actual fully
qualified domain name that you want to use &lt;span class="caps"&gt;SSL&lt;/span&gt; on, if your domain name
is example.com and you want this to work on www.example.com but did not
buy a wildcard certificate then put www.example.com as your Common Name.&lt;/p&gt;
&lt;p&gt;Once generated, send this off to your signer and they will send you a
&lt;span class="caps"&gt;CRT&lt;/span&gt; in return.&lt;/p&gt;
&lt;p&gt;Once you have your &lt;span class="caps"&gt;CRT&lt;/span&gt; it’s time to put them on the server, move your
key file to Debian’s &lt;span class="caps"&gt;SSL&lt;/span&gt; directory.&lt;/p&gt;
&lt;p&gt;Put your &lt;span class="caps"&gt;CRT&lt;/span&gt; on the server and move it to Debian’s &lt;span class="caps"&gt;SSL&lt;/span&gt; directory too.&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class="section" id="apache-configuration"&gt;
&lt;h2&gt;Apache configuration&lt;/h2&gt;
&lt;p&gt;First thing we need to do is check your Apache ports.conf file to make
sure &lt;span class="caps"&gt;SSL&lt;/span&gt; is enabled.&lt;/p&gt;
&lt;p&gt;It should have the following at the bottom.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;IfModule&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;mod_ssl.c&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c"&gt;# SSL name based virtual hosts are not yet supported, therefore no&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="c"&gt;# NameVirtualHost statement here&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;Listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;443&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/IfModule&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now that’s sorted we’ll move on to your actual virtualhost.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;nano&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/sites-available/DOMAINNAME.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We’ll use a config template I’ve always used, feel free to edit it at need.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;VirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;*&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ServerAdmin&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;webmaster@DOMAINNAME
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ServerName&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;DOMAINNAME
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;DocumentRoot&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/var/www/DOMAINNAME&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;Directory&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Options&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;FollowSymLinks
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;AllowOverride&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;None&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;Directory&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/DOMAINNAME&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Options&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-Indexes&lt;span class="w"&gt; &lt;/span&gt;FollowSymLinks&lt;span class="w"&gt; &lt;/span&gt;MultiViews
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;AllowOverride&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;All&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Order&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;allow,deny
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;allow&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;from&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;all&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/VirtualHost&amp;gt;&lt;/span&gt;

&lt;span class="nt"&gt;&amp;lt;VirtualHost&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;*:443&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ServerAdmin&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;webmaster@DOMAINNAME
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;ServerName&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;DOMAINNAME
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;DocumentRoot&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/var/www/DOMAINNAME&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;Directory&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Options&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;FollowSymLinks
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;AllowOverride&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;None&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;Directory&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/www/DOMAINNAME&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Options&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;-Indexes&lt;span class="w"&gt; &lt;/span&gt;FollowSymLinks&lt;span class="w"&gt; &lt;/span&gt;MultiViews
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;AllowOverride&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;All&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;Order&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;allow,deny
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="nb"&gt;allow&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;from&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;all&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nt"&gt;&amp;lt;/Directory&amp;gt;&lt;/span&gt;

&lt;span class="w"&gt;     &lt;/span&gt;&lt;span class="nb"&gt;SSLEngine&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;On&lt;/span&gt;
&lt;span class="w"&gt;     &lt;/span&gt;&lt;span class="nb"&gt;SSLCertificateFile&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/etc/apache2/ssl/apache.pem&lt;/span&gt;
&lt;span class="nt"&gt;&amp;lt;/VirtualHost&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you used the self signed approach then the above
&lt;strong&gt;SSLCertificateFile&lt;/strong&gt; will be correct, if not replace it with what is
shown below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;SSLCertificateFile&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/etc/ssl/certs/DOMAINANE.crt&lt;/span&gt;
&lt;span class="nb"&gt;SSLCertificateKeyFile&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/etc/ssl/private/DOMAINNAME.key&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you received a bundle file as well as your domains &lt;span class="caps"&gt;CRT&lt;/span&gt; then copy it
to /etc/ssl/certs/ on your server and add the following line after
&lt;strong&gt;SSLCertificateKeyFile&lt;/strong&gt;.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;SSLCertificateChainFile&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sx"&gt;/etc/ssl/certs/DOMAINNAME.bundle.crt&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Save and exit, with that done we need to enable the site.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;a2ensite&lt;span class="w"&gt; &lt;/span&gt;DOMAINNAME.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you used a self signed certificate or passphrase-free key, this
should be all you need to do, feel free to test your config and restart
Apache and test your site.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apache2ctrl&lt;span class="w"&gt; &lt;/span&gt;configtest
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/apache2&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you used a key with a passphrase you will either have to type your
passphrase in each time you restart Apache or, use this wonderful Apache
supported “hack” below…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="the-nasty-ssl-passphrase-hack"&gt;
&lt;h2&gt;The nasty &lt;span class="caps"&gt;SSL&lt;/span&gt; passphrase hack…&lt;/h2&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;nano&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/apache2.conf
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Place the following at the end of the file&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="nb"&gt;SSLPassPhraseDialog&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;exec:/etc/apache2/ssl.sh
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we need to create this bash file, so…&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;nano&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/ssl.sh
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Place the following in it&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="ch"&gt;#!/bin/bash&lt;/span&gt;
&lt;span class="k"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;[&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$1&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s1"&gt;'DOMAINNAME:443'&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="o"&gt;]&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="k"&gt;then&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="nb"&gt;echo&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s2"&gt;"PASSPHRASE"&lt;/span&gt;
&lt;span class="k"&gt;fi&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This is actually supported by Apache, when it’s restarted it will call
this script for every &lt;span class="caps"&gt;SSL&lt;/span&gt; virtualhost you have enabled, passing the
hostname and the port through to the script as $1, so you can add
multiple sites to this file.&lt;/p&gt;
&lt;p&gt;Now save and make it only usable by root.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;chmod&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;0700&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/ssl.sh
sudo&lt;span class="w"&gt; &lt;/span&gt;chown&lt;span class="w"&gt; &lt;/span&gt;root:root&lt;span class="w"&gt; &lt;/span&gt;/etc/apache2/ssl.sh
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we can follow the config test and restart call from above.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apache2ctl&lt;span class="w"&gt; &lt;/span&gt;configtest
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/apache2&lt;span class="w"&gt; &lt;/span&gt;restart
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;And that is it, we should be done!&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="debian"></category><category term="mod_ssl"></category><category term="ssl"></category></entry><entry><title>Apache 2, Nginx &amp; WordPress MU - Follow up</title><link href="https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/" rel="alternate"></link><published>2010-01-12T00:37:00+00:00</published><updated>2010-01-12T00:37:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-01-12:/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/</id><summary type="html">&lt;p&gt;This is a quick follow up to a previous post about getting this blog
&lt;a class="reference external" href="/2010/01/11/debian-apache-2-nginx-wordpress-mu/"&gt;running on nginx with a reverse proxy to Apache 2&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It seems the issue stems from 3 mods I had installed and enabled&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;mod-spamhaus&lt;/li&gt;
&lt;li&gt;mod-evasive and&lt;/li&gt;
&lt;li&gt;mod-security&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The 3, when running together are a fantastic way to strengthen any web
server from attack, be it &lt;span class="caps"&gt;DOS&lt;/span&gt;, injection, &lt;span class="caps"&gt;XLS&lt;/span&gt; etc. I’ve sworn by all 3
of them for years now and I thought I had them cracked for
security:performance ratio, when it comes to reverse proxying requests
from nginx to Apache 2 where WordPress is concerned, apparently I was
very wrong.&lt;/p&gt;
&lt;p&gt;The issue wasn’t so bad when the cache was full, but seeing as my cache
is only alive for an hour that leaves an open point for the cache to be
recreated when a user views the page. This in itself isn’t …&lt;/p&gt;</summary><content type="html">&lt;p&gt;This is a quick follow up to a previous post about getting this blog
&lt;a class="reference external" href="/2010/01/11/debian-apache-2-nginx-wordpress-mu/"&gt;running on nginx with a reverse proxy to Apache 2&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;It seems the issue stems from 3 mods I had installed and enabled&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;mod-spamhaus&lt;/li&gt;
&lt;li&gt;mod-evasive and&lt;/li&gt;
&lt;li&gt;mod-security&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The 3, when running together are a fantastic way to strengthen any web
server from attack, be it &lt;span class="caps"&gt;DOS&lt;/span&gt;, injection, &lt;span class="caps"&gt;XLS&lt;/span&gt; etc. I’ve sworn by all 3
of them for years now and I thought I had them cracked for
security:performance ratio, when it comes to reverse proxying requests
from nginx to Apache 2 where WordPress is concerned, apparently I was
very wrong.&lt;/p&gt;
&lt;p&gt;The issue wasn’t so bad when the cache was full, but seeing as my cache
is only alive for an hour that leaves an open point for the cache to be
recreated when a user views the page. This in itself isn’t a bad thing
or even the root cause, the actual cause appears to be a huge amount of
requests hitting Apache, these in turn trigger all 3 mods, all for the
same reason; lots and lots of requests in short amounts of time from the
same &lt;span class="caps"&gt;IP&lt;/span&gt; address.&lt;/p&gt;
&lt;p&gt;Somehow this was causing Apache to spawn many child processes which it
then tried to kill when the requests were completed or killed, this put
my server load to 15.02 at one point in time, causing the server to go
in to a frenzy as Apache tried to spawn even more children to handle the
requests, getting itself caught in a vicious looping cycle.&lt;/p&gt;
&lt;p&gt;As it stands now I have lowered the tolerance of both mod-evasive and
mod-security which has massively improved performance to the point where
now I can clean and recreate the cache of all blogs running from this
&lt;span class="caps"&gt;WPMU&lt;/span&gt; installation at the same time, while browsing and never notice it.&lt;/p&gt;
&lt;p&gt;Currently mod-spamhaus has been disabled until such time as I can figure
out it’s configuration variables and get it running nicely without it
killing my server when the site in question is a WordPress site.&lt;/p&gt;
&lt;p&gt;As a consequence my other non &lt;span class="caps"&gt;WPMU&lt;/span&gt; blogs that are running purely on
Apache with no nginx reverse proxy have also sped up dramatically which
is always a good thing. I guess for now I’ll have to write a quick
Python script that temporarily bans people using iptables until I can
get all 3 mods working in harmony.&lt;/p&gt;
&lt;p&gt;Will post in the future when I have more info.&lt;/p&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="cache"></category><category term="debian"></category><category term="nginx"></category><category term="wordpress"></category></entry><entry><title>HOWTO: DKIM with Postfix on Debian</title><link href="https://kura.gg/2010/01/11/dkim-on-debian-with-postfix/" rel="alternate"></link><published>2010-01-11T20:53:00+00:00</published><updated>2010-01-11T20:53:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-01-11:/2010/01/11/dkim-on-debian-with-postfix/</id><summary type="html">&lt;p&gt;&lt;em&gt;There is a much newer article on this subject `here`_ and covers
DomainKeys and &lt;span class="caps"&gt;DKIM&lt;/span&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Mail and mail servers have always been my forté if I’m to be honest, my
home mail server has been spam free for years now, nothing really gets
past due to my love of all things installable and configurable.&lt;/p&gt;
&lt;p&gt;Several months ago I started a new job and after a few weeks I was
tasked with getting &lt;span class="caps"&gt;DKIM&lt;/span&gt; signing to work on our mail platform, &lt;span class="caps"&gt;DKIM&lt;/span&gt; was
semi-new to me, I’d never bothered with anything but &lt;span class="caps"&gt;SPF&lt;/span&gt; before so I
figured I’d give it a shot.&lt;/p&gt;
&lt;p&gt;At work our servers are Debian based but are the evil that is Ubuntu,
strangely though I was able to find an Ubuntu specific article that
wasn’t absolute rubbish, which surprised me no end. I was able to get
dkim-milter working with Postfix and …&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;em&gt;There is a much newer article on this subject `here`_ and covers
DomainKeys and &lt;span class="caps"&gt;DKIM&lt;/span&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Mail and mail servers have always been my forté if I’m to be honest, my
home mail server has been spam free for years now, nothing really gets
past due to my love of all things installable and configurable.&lt;/p&gt;
&lt;p&gt;Several months ago I started a new job and after a few weeks I was
tasked with getting &lt;span class="caps"&gt;DKIM&lt;/span&gt; signing to work on our mail platform, &lt;span class="caps"&gt;DKIM&lt;/span&gt; was
semi-new to me, I’d never bothered with anything but &lt;span class="caps"&gt;SPF&lt;/span&gt; before so I
figured I’d give it a shot.&lt;/p&gt;
&lt;p&gt;At work our servers are Debian based but are the evil that is Ubuntu,
strangely though I was able to find an Ubuntu specific article that
wasn’t absolute rubbish, which surprised me no end. I was able to get
dkim-milter working with Postfix and signing emails first time round.
Google was failing to match against our &lt;span class="caps"&gt;DNS&lt;/span&gt; records but after some
repeat changes I was able to get it working.&lt;/p&gt;
&lt;p&gt;Debian was a completely different kettle of fish.&lt;/p&gt;
&lt;p&gt;I’ll have to go through a bit of the background to my problem before the
actual installation tutorial. I had everything installed and running but
dkim-filter was refusing to start correctly, Postfix couldn’t connect to
it and no emails could be signed. After a lot of banging my head against
the desk I decided to try dkimproxy, I had the same issues with this
too. Then I spotted opendkim which used the same config as dkim-filter
but this time actually worked. I’m not sure what exactly is wrong with
the dkim-filter package, I’ve noticed a few people writing posts about
it but opendkim saved me so I’ll stick with it.&lt;/p&gt;
&lt;p&gt;First off I’m going to assume you have Postfix installed and running, if
you don’t there are plenty of articles on Google for how to get it running.&lt;/p&gt;
&lt;p&gt;First step is to install opendkim.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;apt-get&lt;span class="w"&gt; &lt;/span&gt;install&lt;span class="w"&gt; &lt;/span&gt;opendkim
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Leave the install process to complete, we’ll configure it later, first
we’ll make the public and private keys required for signing.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;openssl&lt;span class="w"&gt; &lt;/span&gt;genrsa&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="m"&gt;1024&lt;/span&gt;
openssl&lt;span class="w"&gt; &lt;/span&gt;rsa&lt;span class="w"&gt; &lt;/span&gt;-in&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;-out&lt;span class="w"&gt; &lt;/span&gt;public.key&lt;span class="w"&gt; &lt;/span&gt;-pubout&lt;span class="w"&gt; &lt;/span&gt;-outform&lt;span class="w"&gt; &lt;/span&gt;PEM
sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/mail/
sudo&lt;span class="w"&gt; &lt;/span&gt;cp&lt;span class="w"&gt; &lt;/span&gt;private.key&lt;span class="w"&gt; &lt;/span&gt;/etc/mail/dkim.key
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So that’s the key sorted, now we’ll configure opendkim.&lt;/p&gt;
&lt;p&gt;First open &lt;strong&gt;/etc/opendkim.conf&lt;/strong&gt; and put the following in, replacing
the _DOMAIN_ with your domain name.&lt;/p&gt;
&lt;pre class="literal-block"&gt;
# Log to syslog
Syslog yes
# Required to use local socket with MTAs that access the socket as a non-
# privileged user (e.g. Postfix)
UMask 002

# Sign for example.com with key in /etc/mail/dkim.key using
# selector '2007' (e.g. 2007._domainkey.example.com)
Domain _DOMAIN_
KeyFile /etc/dkim/private.key
Selector mail

# Commonly-used options; the commented-out versions show the defaults.
#Canonicalization simple
#Mode sv
#SubDomains no
#ADSPDiscard no
&lt;/pre&gt;
&lt;p&gt;Set a custom selector if you want.&lt;/p&gt;
&lt;p&gt;Next we open up &lt;strong&gt;/etc/default/opendkim&lt;/strong&gt; and change it to the following:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# Command-line options specified here will override the contents of&lt;/span&gt;
&lt;span class="c1"&gt;# /etc/opendkim.conf. See opendkim(8) for a complete list of options.&lt;/span&gt;
&lt;span class="c1"&gt;#DAEMON_OPTS=""&lt;/span&gt;
&lt;span class="c1"&gt;#&lt;/span&gt;

&lt;span class="c1"&gt;# Uncomment to specify an alternate socket&lt;/span&gt;

&lt;span class="c1"&gt;# Note that setting this will override any Socket value in opendkim.conf&lt;/span&gt;

&lt;span class="c1"&gt;#SOCKET="local:/var/run/opendkim/opendkim.sock" # default&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="inet:54321" # listen on all interfaces on port 54321&lt;/span&gt;
&lt;span class="nv"&gt;SOCKET&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;"inet:12345@localhost"&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="c1"&gt;# listen on loopback on port 12345&lt;/span&gt;
&lt;span class="c1"&gt;#SOCKET="inet:12345@192.0.2.1" # listen on 192.0.2.1 on port 12345&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;That’s opendkim all configured, start the daemon with&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;sudo&lt;span class="w"&gt; &lt;/span&gt;/etc/init.d/opendkim&lt;span class="w"&gt; &lt;/span&gt;start
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we need to modify Postfix to tell it to use opendkim to sign
emails. Lets open up &lt;strong&gt;/etc/postfix/main.cf&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Place the following as the end of that file&lt;/p&gt;
&lt;pre class="literal-block"&gt;
milter_default_action = accept
milter_protocol = 6
smtpd_milters = inet:localhost:12345
non_smtpd_milters = inet:localhost:12345
&lt;/pre&gt;
&lt;p&gt;That’s Postfix configured, we’ll reload it once the &lt;span class="caps"&gt;DNS&lt;/span&gt; is configured.&lt;/p&gt;
&lt;p&gt;How you configured your &lt;span class="caps"&gt;DNS&lt;/span&gt; is up to you, you will need to add the
following 2 new records&lt;/p&gt;
&lt;pre class="literal-block"&gt;
_domainkey.DOMAIN.TLD. IN TXT "t=y; o=-;" SELECTOR._domainkey.DOMAIN.TLD. IN TXT "k=rsa; t=y; p=YOUR_PUBLIC_KEY_HERE"
&lt;/pre&gt;
&lt;p&gt;Replace the instances of &lt;strong&gt;&lt;span class="caps"&gt;DOMAIN&lt;/span&gt;.&lt;span class="caps"&gt;TLD&lt;/span&gt;&lt;/strong&gt; with your actual mail domain
name in both records, &lt;strong&gt;&lt;span class="caps"&gt;SELECTOR&lt;/span&gt;&lt;/strong&gt; was configured in to opendkim
earlier, in my example I used &lt;strong&gt;mail&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;Your key will be called public.key, we created both public and private
keys earlier. You only need to add the actual key from between the &lt;span class="caps"&gt;BEGIN&lt;/span&gt;
and &lt;span class="caps"&gt;END&lt;/span&gt; lines, e.g. my test one below&lt;/p&gt;
&lt;pre class="literal-block"&gt;
-----BEGIN PUBLIC KEY-----
MIGfMWGwregWREGREwgERGREGergerDGdEPzFCAdYnf1Z9nRtfTqwP/mcdGg
NmbY11tCtwwFMu8/qEQwaK/Nc61q0D/z7NYwlsPFi08lnVSHGrewherh5630n
F6S0z961h6li/pOHiJy/l2ehnenhehO3d/NmATY90WlpEDmnlVAMTYgALBFJplp
1ruZ66Bgrewhg43y634567gewrgB
-----END PUBLIC KEY-----
&lt;/pre&gt;
&lt;p&gt;Becomes&lt;/p&gt;
&lt;pre class="literal-block"&gt;
MIGfMWGwregWREGREwgERGREGerg [...snip...]
plp1ruZ66Bgrewhg43y634567gewrgB
&lt;/pre&gt;
&lt;p&gt;Now we simply reload the Postfix config with &lt;strong&gt;/etc/init.d/postfix reload&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Now you can send test mails once you’re sure &lt;span class="caps"&gt;DNS&lt;/span&gt; changes have
propagated. You will see any errors in &lt;strong&gt;/var/log/mail.log&lt;/strong&gt;.&lt;/p&gt;
</content><category term="tutorials"></category><category term="debian"></category><category term="dkim"></category><category term="howto"></category><category term="mail"></category><category term="postfix"></category></entry><entry><title>Debian, Apache 2, Nginx, WordPress MU &amp; WP-Super-Cache</title><link href="https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/" rel="alternate"></link><published>2010-01-11T19:58:00+00:00</published><updated>2010-01-11T19:58:00+00:00</updated><author><name>kura</name></author><id>tag:kura.gg,2010-01-11:/2010/01/11/debian-apache-2-nginx-wordpress-mu/</id><summary type="html">
&lt;p&gt;&lt;em&gt;This is a rather old article, for more up-to-date information please see;&lt;/em&gt;&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/"&gt;/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/"&gt;/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I’ve started collecting a few blogs on my servers now and figured from
this one on I would consolidate it in to one workable, usable location.
Removing my need to update multiple plugins, themes and WordPress
itself, over and over.&lt;/p&gt;
&lt;p&gt;This time round I thought I’d do it properly, and properly in my book is
as complicated and “awesome” as it can possibly be, without growing legs
and running off to stomp a city.&lt;/p&gt;
&lt;div class="section" id="love"&gt;
&lt;h2&gt;Love&lt;/h2&gt;
&lt;p&gt;I’ve fallen in-love with nginx (&lt;a class="reference external" href="https://nginx.org/"&gt;https://nginx.org/&lt;/a&gt;) over the last 6
months or so, I’d been an avid user of LighTTPD for a very long time
before but started to look in to nginx mid year as a replacement. I
learned that at my new job they used nginx for …&lt;/p&gt;&lt;/div&gt;</summary><content type="html">
&lt;p&gt;&lt;em&gt;This is a rather old article, for more up-to-date information please see;&lt;/em&gt;&lt;/p&gt;
&lt;ol class="arabic simple"&gt;
&lt;li&gt;&lt;a class="reference external" href="/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/"&gt;/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a class="reference external" href="/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/"&gt;/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;I’ve started collecting a few blogs on my servers now and figured from
this one on I would consolidate it in to one workable, usable location.
Removing my need to update multiple plugins, themes and WordPress
itself, over and over.&lt;/p&gt;
&lt;p&gt;This time round I thought I’d do it properly, and properly in my book is
as complicated and “awesome” as it can possibly be, without growing legs
and running off to stomp a city.&lt;/p&gt;
&lt;div class="section" id="love"&gt;
&lt;h2&gt;Love&lt;/h2&gt;
&lt;p&gt;I’ve fallen in-love with nginx (&lt;a class="reference external" href="https://nginx.org/"&gt;https://nginx.org/&lt;/a&gt;) over the last 6
months or so, I’d been an avid user of LighTTPD for a very long time
before but started to look in to nginx mid year as a replacement. I
learned that at my new job they used nginx for image server and, after
reading a few articles online decided nginx greatly outweighed “Lighty”.&lt;/p&gt;
&lt;p&gt;First stop was getting Wordpress &lt;span class="caps"&gt;MU&lt;/span&gt; installed, this itself proved rather
interesting, I’ve no idea why however. After several failed attempts
(the first showing me pages without images or css, the second
redirecting to nowhere and so on,) I finally got it working. On logging
in I realised how horrid it was, forcing you to set-up weird sub domain
structures that the blogs are &lt;em&gt;supposed&lt;/em&gt; to work under. This is all well
and good but I don’t have blogs running on sub domains, I have blogs
running on their own domains. Ignoring this “feature” you can actually
force set each blog to have it’s own url, but this has to be during
editing after initial creation.&lt;/p&gt;
&lt;p&gt;The rest was the usual WordPress ease, wget the plugins and themes I
wanted, unzip them as usual and stick them in the right locations,
removing unwanted readme.txt files just to keep the whole place clean.
On a side note; what happened to the “&lt;span class="caps"&gt;README&lt;/span&gt;” files of the past? Why are
they all starting to appear named as “readme.txt” now? I guess the
Windows crowd couldn’t figure out how to open them in Notepad…&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="hurdles"&gt;
&lt;h2&gt;Hurdles&lt;/h2&gt;
&lt;p&gt;My first stumble was when I couldn’t use my beloved sitemaps plugin I’ve
used so many times, the problem with it is it stores the files directly
in the doc root, which is fine on a single instance, but with multiple
blogs they just overwrite each other. Luckily I found a nice little
WordPress &lt;span class="caps"&gt;MU&lt;/span&gt; specific one that slotted in nicely, it appears to be
generated each and every time the file is hit, so I wrote a quick script
that uses wget to grab each blogs sitemap every 6 hours, saves them to
the content directory and uses .htaccess to point to the right one.&lt;/p&gt;
&lt;p&gt;With that dragon vanquished it was time to get &lt;span class="caps"&gt;WP&lt;/span&gt;-Super-Cache installed,
this proved painless as usual and was running under Apache 2 in no time
at all, I’ve yet to work out why every time I install it under Apache,
Apache seems go insane, eventually slowing everything down to a crawl…
But that leads me on to the next part.&lt;/p&gt;
&lt;p&gt;Nginx reverse proxy to Apache.&lt;/p&gt;
&lt;p&gt;This wasn’t difficult at all, I’ve reverse proxied connections to Apache
many times from nginx now, being a Debian user made it quite nice a
simple, I have Apache 2 running bound to 1 &lt;span class="caps"&gt;IP&lt;/span&gt; and nginx bound to
another, I simply created a new vhost for nginx and filled it with the
lovely data needed as shown below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;server&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;listen&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="n"&gt;174.143.241.61&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;&lt;span class="mi"&gt;80&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;server_name&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;access_log&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/var/log/nginx/syslog.tv.access.log&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_pass&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;https://apache.syslog.tv&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_redirect&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="no"&gt;off&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;Host&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$host&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Real-IP&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$remote_addr&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_set_header&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;X-Forwarded-For&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$proxy_add_x_forwarded_for&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;client_max_body_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;10m&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;client_body_buffer_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;128k&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_connect_timeout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;90&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_send_timeout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;90&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_read_timeout&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;90&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_buffer_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;4k&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_buffers&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;4&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;32k&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_busy_buffers_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;64k&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;proxy_temp_file_write_size&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="mi"&gt;64k&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;location&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;^.+.(jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|mid|midi|wav|bmp|rtf|js)&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;root&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/path/to/wordpress&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(-f&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$request_filename&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(-d&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$request_filename&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_file&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$request_uri&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$request_method&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;=&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;POST)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$query_string&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$http_cookie&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="sr"&gt;*&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.comment_author_|wordpress|wp-postpass_.)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;.&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(&lt;/span&gt;&lt;span class="nv"&gt;$supercache_uri&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;~&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="sr"&gt;^(.+)$)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;set&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_file&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;/wp-content/cache/supercache/&lt;/span&gt;&lt;span class="nv"&gt;$http_host/$1index.html&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="kn"&gt;if&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;(-f&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$document_root$supercache_file&lt;/span&gt;&lt;span class="s"&gt;)&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="p"&gt;{&lt;/span&gt;
&lt;span class="w"&gt;        &lt;/span&gt;&lt;span class="kn"&gt;rewrite&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;^(.*)&lt;/span&gt;$&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="nv"&gt;$supercache_file&lt;/span&gt;&lt;span class="w"&gt; &lt;/span&gt;&lt;span class="s"&gt;break&lt;/span&gt;&lt;span class="p"&gt;;&lt;/span&gt;
&lt;span class="w"&gt;    &lt;/span&gt;&lt;span class="p"&gt;}&lt;/span&gt;

&lt;span class="p"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see, this is rather simple, I patched it together from some
articles already out there on Google, made a couple of changes where
required. The main thing here is that we turn “proxy_redirect” off, and
you may also notice I am pointing at apache.syslog.tv, this domain
doesn’t exist, I just created an instance of it pointing to Apache’s
local &lt;span class="caps"&gt;IP&lt;/span&gt; in /etc/hosts.&lt;/p&gt;
&lt;/div&gt;
&lt;div class="section" id="more-hurdles"&gt;
&lt;h2&gt;More hurdles&lt;/h2&gt;
&lt;p&gt;I ran in to some initial problems with this though, sadly. Problems I
was unable to really find a solution to for some time. The first problem
was speed, or lack of it in fact. Apache was quite literally dying on
me, a restart of Apache temporarily solved this problem, in the process
I also restarted nginx, this was probably a bad idea. I’d been tinkering
with the nginx config, setting gzip vars and other things, this caused
serious problems and made nginx throw 301 redirects for every single
http request, Apache also threw 301 redirects just to complete the cycle
of infinite loop. Needless to say I maxed out memory in no time.&lt;/p&gt;
&lt;p&gt;I reverted my changes and then found that the caching seemed to be
playing up now, eventually I noticed that this was actually due to my
.htaccess having the supercache data at the bottom of the file, instead
of the top. Fixed.&lt;/p&gt;
&lt;p&gt;Again came the speed problems, I noticed that when I used Ctrl+F5
instead of just F5 or opened the site in Firefox instead of Chrome I was
getting the same slow speed problems. While trying to watch my logs go
speeding by I found some very interesting messages. The first was from
mod_spamhaus which claimed my &lt;span class="caps"&gt;IP&lt;/span&gt; address was blacklisted, I ran to
their website and did a lookup, thankfully it seems to only be a local
blacklist, against my better judgement I disable mod_spamhaus for the
time being. The other issue was coming from mod_evasive, a few quick
config changes for it to handle lots of proxied requests from nginx when
the cache was old or not there.&lt;/p&gt;
&lt;p&gt;And that solved it, solved excluding mod_spamhaus. Now I need to either
find a solution or weigh the pros and cons of mod_spamhaus.&lt;/p&gt;
&lt;/div&gt;
</content><category term="tutorials"></category><category term="apache"></category><category term="cache"></category><category term="debian"></category><category term="nginx"></category><category term="wordpress"></category></entry></feed>