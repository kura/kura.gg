<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="Speeding up pypip.in and reducing load on PyPI" property=og:title><meta content=https://kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/ property=og:url><meta content="As you might expect, pypip.in employes a fair amount of caching in the backend to control load on the imaging API and servers. For a long time, this cache was entirely managed by Varnish and was doing a fantastic job. Varnish has a hit:miss ratio of 10:1, for every 10 hits we get 1 miss. This is a fairly decent ratio when you consider where these images are displayed, how often they are viewed and that Varnish only caches the images for an hour. The impact on PyPI You will firstly need to understand how pypip.in used to work to understand the changes that were made and why they were made. Let’s set up the request first - a request for a shield is made and it is not present in the Varnish cache. Request received in API layer | v API layer queries PyPI | v PyPI …" property=og:description><meta content=https://kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="Speeding up pypip.in and reducing load on PyPI" property=twitter:title><meta content=https://kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/ property=twitter:url><meta content="As you might expect, pypip.in employes a fair amount of caching in the backend to control load on the imaging API and servers. For a long time, this cache was entirely managed by Varnish and was doing a fantastic job. Varnish has a hit:miss ratio of 10:1, for every 10 hits we get 1 miss. This is a fairly decent ratio when you consider where these images are displayed, how often they are viewed and that Varnish only caches the images for an hour. The impact on PyPI You will firstly need to understand how pypip.in used to work to understand the changes that were made and why they were made. Let’s set up the request first - a request for a shield is made and it is not present in the Varnish cache. Request received in API layer | v API layer queries PyPI | v PyPI …" property=twitter:description><meta content=https://kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="3 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>Speeding up pypip.in and reducing load on PyPI</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons></i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>  </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content=python,pypipins,pypip.in,shields itemprop=keywords><meta content=coding itemprop=keywords><div class=eevee-share><ul class="social-share mdl-navigation"><li class="social-share__link social-share__link--twitter"><a onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Share 'Speeding up pypip.in and reducing load on PyPI' on Twitter" href=https://twitter.com/intent/tweet?text=Speeding%20up%20pypip.in%20and%20reducing%20load%20on%20PyPI&url=https%3A//kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--facebook"><a onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Share 'Speeding up pypip.in and reducing load on PyPI' on Facebook" href=https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--email"><a title="Share 'Speeding up pypip.in and reducing load on PyPI' via email" href=mailto:?subject=Speeding%20up%20pypip.in%20and%20reducing%20load%20on%20PyPI&body=I%20thought%20you%20might%20like%20'Speeding%20up%20pypip.in%20and%20reducing%20load%20on%20PyPI'%20--%20https%3A//kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/> <i aria-hidden=true class=material-icons>  </i> </a></ul></div><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2014-08-07T08:42:00+01:00 itemprop=datePublished> 07 Aug 2014 </time> — 3 min read</div><h1 itemprop=name><a title="Permalink to 'Speeding up pypip.in and reducing load on PyPI'" href=https://kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/ itemprop=url rel=bookmark> Speeding up pypip.in and reducing load on PyPI </a></h1><section class=eevee-toc><h2 id=toc>Contents</h2><nav class=eevee-toc-ribbon><div class=toc><p class=topic-title>Contents<ul class=simple><li><a class="reference internal" href=#the-impact-on-pypi id=toc-entry-1>The impact on PyPI</a><li><a class="reference internal" href=#reducing-load-on-the-imaging-layer id=toc-entry-2>Reducing load on the imaging layer</a></ul></div></nav></section><section class=article-content itemprop=articleBody><p>As you might expect, <a class="reference external" href=https://pypip.in>pypip.in</a> employes a fair amount of caching in the backend to control load on the imaging <span class=caps>API</span> and servers.<p>For a long time, this cache was entirely managed by Varnish and was doing a fantastic job. Varnish has a hit:miss ratio of 10:1, for every 10 hits we get 1 miss. This is a fairly decent ratio when you consider where these images are displayed, how often they are viewed and that Varnish only caches the images for an hour.<div class=section id=the-impact-on-pypi><h2>The impact on PyPI</h2><p>You will firstly need to understand how pypip.in used to work to understand the changes that were made and why they were made.<p>Let’s set up the request first - a request for a shield is made and it is not present in the Varnish cache.<pre class=literal-block>
Request received in API layer
              |
              v
    API layer queries PyPI
              |
              v
   PyPI response translated
              |
              v
Image request for imaging layer
</pre><p>This was true for every request made that did not exist in Varnish’s cache.<p>Generally, if one shield was displayed for a project a second or more usually was displayed too. This meant when loading the <span class=caps>README</span> document on GitHub for a project would involve pypip.in making more than one request to PyPI for information and then translating that data.<p>I decided that caching the initial response for the first request from PyPI to Redis would be a good idea. This cache is only meant to be short term and is in place to make multiple images requested at the same time generate faster.<pre class=literal-block>
       Request received in API layer
                     |
                     v
API layer queries Redis and falls back to PyPI
                     |
                     v
          PyPI response translated
                     |
                     v
       Image request for imaging layer
</pre></div><div class=section id=reducing-load-on-the-imaging-layer><h2>Reducing load on the imaging layer</h2><p>I realised that out of all of the shields pypip.in serves, all but two of them are generic and can be re-used.<p><cite>Downloads</cite> and <cite>version</cite> information are almost entirely unique but, <cite>Python versions</cite>, <cite>Python implementations</cite>, <cite>development status</cite>, <cite>wheel</cite>, <cite>egg</cite>, <cite>format</cite> and <cite>license</cite> are all generic and will be identical for multiple projects.<p>It would make perfect sense to cache these images and re-use them as required. While caching them in Varnish would not be possible due to the <span class=caps>URI</span> structure, caching the images on disk based on their data, colour and mime type would be perfectly acceptable.<p>The disks used to power pypip.in are of <span class=caps>SSD</span> quality (<a class="reference external" href=https://www.digitalocean.com/?refcode=d76795840b23>thanks DigitalOcean</a>,) so storing the images on the disks themselves would be perfectly reasonable and, due to their nature can be stored for a good length of time. I opted for 24 hours.<p>Now the diagram looks like this:<pre class=literal-block>
       Request received in API layer
                     |
                     v
API layer queries Redis and falls back to PyPI
                     |
                     v
          PyPI response translated
                     |
                     v
   Look for image in generic disk cache or
         request from imaging layer
</pre><p>Due to the nature of the shields and their content, a request has to be made to Redis or PyPI before a look up can be made to the generic disk cache (we need to know the text data and shield colour from PyPI data,) it is still a very good performance improvement on the whole.</div></section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'So you want to run your own copy of pypip.in?'" href=https://kura.gg/2014/07/26/so-you-want-to-run-your-own-copy-of-pypip.in/ itemprop=url rel=bookmark> So you want to run your own copy of pypip.in? </a><li><a title="Permalink to 'New pypip.in shields and styling'" href=https://kura.gg/2014/07/25/new-pypip.in-shields-and-styling/ itemprop=url rel=bookmark> New pypip.in shields and styling </a><li><a title="Permalink to 'Shields for PyPI packages'" href=https://kura.gg/2013/12/24/shields-for-pypi-packages/ itemprop=url rel=bookmark> Shields for PyPI packages </a><li><a title="Permalink to 'Blackhole 2.0: or, How I Learned to Love Asyncio'" href=https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/ itemprop=url rel=bookmark> Blackhole 2.0: or, How I Learned to Love Asyncio </a><li><a title="Permalink to 'batfish(1) - writing a Digital Ocean V2 API wrapper'" href=https://kura.gg/2014/09/15/batfish-writing-a-digital-ocean-v2-api-wrapper/ itemprop=url rel=bookmark> batfish(1) - writing a Digital Ocean V2 <span class=caps>API</span> wrapper </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa></i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>🦣</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'Speeding up pypip.in and reducing load on PyPI' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/speeding-up-pypip.in-and-reducing-load-on-pypi.rst id=view-source> <i class=material-icons></i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2014/08/09/yarg/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> Newer </a><div class=eevee-spacer></div><a class=eevee-nav__button href=https://kura.gg/2014/07/26/so-you-want-to-run-your-own-copy-of-pypip.in/ itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> </a></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa></i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>🦣</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>