<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="haproxy OCSP stapling" property=og:title><meta content=https://kura.gg/2014/07/02/haproxy-ocsp-stapling/ property=og:url><meta content="With haproxy 1.5 finally being released we are lucky enough to get a basic interface around OCSP stapling. Sadly this interface really is quite basic and it’s not the simplest thing to figure out without some trial and error. According to the official documentation, you should be able to pipe your OCSP response to haproxy via it’s stats socket. Sadly I could not get this to work properly at all, so I decided to swap the piping for a file and reload solution. You’ll need to get a copy of your certification authorities root certificate to proceed with this. Looking for your OCSP URI If you don’t know the URI you need to do an OCSP lookup against, you can find it in your certificate data. openssl x509 -in /path/to/your/certificate -text Inside the output, look for the following section. Authority Information Access …" property=og:description><meta content=https://kura.gg/2014/07/02/haproxy-ocsp-stapling/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="haproxy OCSP stapling" property=twitter:title><meta content=https://kura.gg/2014/07/02/haproxy-ocsp-stapling/ property=twitter:url><meta content="With haproxy 1.5 finally being released we are lucky enough to get a basic interface around OCSP stapling. Sadly this interface really is quite basic and it’s not the simplest thing to figure out without some trial and error. According to the official documentation, you should be able to pipe your OCSP response to haproxy via it’s stats socket. Sadly I could not get this to work properly at all, so I decided to swap the piping for a file and reload solution. You’ll need to get a copy of your certification authorities root certificate to proceed with this. Looking for your OCSP URI If you don’t know the URI you need to do an OCSP lookup against, you can find it in your certificate data. openssl x509 -in /path/to/your/certificate -text Inside the output, look for the following section. Authority Information Access …" property=twitter:description><meta content=https://kura.gg/2014/07/02/haproxy-ocsp-stapling/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="2 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>haproxy OCSP stapling</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons></i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>  </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content="haproxy,ssl,ocsp,ocsp stapling" itemprop=keywords><meta content=tutorials itemprop=keywords><div class=eevee-share><ul class="social-share mdl-navigation"><li class="social-share__link social-share__link--twitter"><a onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Share 'haproxy OCSP stapling' on Twitter" href=https://twitter.com/intent/tweet?text=haproxy%20OCSP%20stapling&url=https%3A//kura.gg/2014/07/02/haproxy-ocsp-stapling/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--facebook"><a onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Share 'haproxy OCSP stapling' on Facebook" href=https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2014/07/02/haproxy-ocsp-stapling/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--email"><a title="Share 'haproxy OCSP stapling' via email" href=mailto:?subject=haproxy%20OCSP%20stapling&body=I%20thought%20you%20might%20like%20'haproxy%20OCSP%20stapling'%20--%20https%3A//kura.gg/2014/07/02/haproxy-ocsp-stapling/> <i aria-hidden=true class=material-icons>  </i> </a></ul></div><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2014-07-02T23:45:00+01:00 itemprop=datePublished> 02 Jul 2014 </time> — 2 min read</div><h1 itemprop=name><a title="Permalink to 'haproxy OCSP stapling'" href=https://kura.gg/2014/07/02/haproxy-ocsp-stapling/ itemprop=url rel=bookmark> haproxy <span class=caps>OCSP</span> stapling </a></h1><section class=eevee-toc><h2 id=toc>Contents</h2><nav class=eevee-toc-ribbon><div class=toc><p class=topic-title>Contents<ul class=simple><li><a class="reference internal" href=#looking-for-your-ocsp-uri id=toc-entry-1>Looking for your <span class=caps>OCSP</span> <span class=caps>URI</span></a><li><a class="reference internal" href=#testing-ocsp-response id=toc-entry-2>Testing <span class=caps>OCSP</span> response</a><ul><li><a class="reference internal" href=#disable-nonces id=toc-entry-3>Disable nonces</a><li><a class="reference internal" href=#send-a-host-header id=toc-entry-4>Send a “Host” header</a></ul><li><a class="reference internal" href=#proving-ocsp-data-to-haproxy id=toc-entry-5>Proving <span class=caps>OCSP</span> data to haproxy</a><li><a class="reference internal" href=#testing-ocsp-from-haproxy id=toc-entry-6>Testing <span class=caps>OCSP</span> from haproxy</a><li><a class="reference internal" href=#updating-ocsp id=toc-entry-7>Updating <span class=caps>OCSP</span></a></ul></div></nav></section><section class=article-content itemprop=articleBody><p>With haproxy 1.5 finally being released we are lucky enough to get a basic interface around <span class=caps>OCSP</span> stapling.<p>Sadly this interface really is quite basic and it’s not the simplest thing to figure out without some trial and error.<p>According to the official documentation, you should be able to pipe your <span class=caps>OCSP</span> response to haproxy via it’s stats socket. Sadly I could not get this to work properly at all, so I decided to swap the piping for a file and reload solution.<p>You’ll need to get a copy of your certification authorities root certificate to proceed with this.<div class=section id=looking-for-your-ocsp-uri><h2>Looking for your <span class=caps>OCSP</span> <span class=caps>URI</span></h2><p>If you don’t know the <span class=caps>URI</span> you need to do an <span class=caps>OCSP</span> lookup against, you can find it in your certificate data.<div class=highlight><pre><span></span>openssl<span class=w> </span>x509<span class=w> </span>-in<span class=w> </span>/path/to/your/certificate<span class=w> </span>-text
</pre></div><p>Inside the output, look for the following section.<pre class=literal-block>
Authority Information Access:
    CA Issuers - URI:https://secure.globalsign.com/cacert/gsdomainvalsha2g2r1.crt
    OCSP - URI:https://ocsp2.globalsign.com/gsdomainvalsha2g2
</pre></div><div class=section id=testing-ocsp-response><h2>Testing <span class=caps>OCSP</span> response</h2><div class=highlight><pre><span></span>openssl<span class=w> </span>ocsp<span class=w> </span>-noverify<span class=w> </span>-issuer<span class=w> </span>/path/to/your/ca/root/certificate<span class=w> </span><span class=se>\</span>
<span class=w>             </span>-cert<span class=w> </span>/path/to/your/certificate<span class=w> </span>-url<span class=w> </span><span class=s2>"OCSP_URI"</span>
</pre></div><p>You should see a response like the one below.<pre class=literal-block>
/path/to/your/certificate: good
This Update: Jul  2 23:01:54 2014 GMT
</pre><p>If you get any errors from this, you may need to try these additional arguments;<div class=section id=disable-nonces><h3>Disable nonces</h3><pre class=literal-block>
-no_nonce
</pre><p>This will disable nonces, some servers are not able to handle nonces so you may need to disable them.</div><div class=section id=send-a-host-header><h3>Send a “Host” header</h3><p>If you get an <span class=caps>HTTP</span> status like a 403 or 404 then you may need to specify a host header.<pre class=literal-block>
-header Host OCSP_URI_DOMAIN
</pre><p>For my certificate the <span class=caps>OCSP</span> <span class=caps>URI</span> is <em>https://ocsp2.globalsign.com/gsdomainvalsha2g2</em> so the Host header would be like below.<pre class=literal-block>
-header Host ocsp2.globalsign.com
</pre></div></div><div class=section id=proving-ocsp-data-to-haproxy><h2>Proving <span class=caps>OCSP</span> data to haproxy</h2><p>If the above testing was all <span class=caps>OK</span>, we can now actually use the data.<div class=highlight><pre><span></span>openssl<span class=w> </span>ocsp<span class=w> </span>-noverify<span class=w> </span>-issuer<span class=w> </span>/path/to/your/ca/root/certificate<span class=w> </span><span class=se>\</span>
<span class=w>             </span>-cert<span class=w> </span>/path/to/your/certificate<span class=w> </span><span class=se>\</span>
<span class=w>             </span>-url<span class=w> </span><span class=s2>"OCSP_URI"</span><span class=w> </span>-respout<span class=w> </span>/path/to/your/certificate.ocsp
</pre></div><p>One thing to note is, if your certificate file is <em>/etc/ssl/certs/kura.gg.crt</em> then you must set -respout to <em>/etc/ssl/certs/kura.gg.crt.ocsp</em><p>You can now simply reload haproxy and check your <span class=caps>OCSP</span> staping is working.</div><div class=section id=testing-ocsp-from-haproxy><h2>Testing <span class=caps>OCSP</span> from haproxy</h2><div class=highlight><pre><span></span>openssl<span class=w> </span>s_client<span class=w> </span>-connect<span class=w> </span>domain.tld:443<span class=w> </span>-tls1<span class=w> </span>-tlsextdebug<span class=w> </span>-status
</pre></div><p>Near the top of the response you’ll see your <span class=caps>OCSP</span> information.<pre class=literal-block>
OCSP response:
======================================
OCSP Response Data:
    OCSP Response Status: successful (0x0)
    Response Type: Basic OCSP Response
    Version: 1 (0x0)
    Responder Id: DFDE6C7C4B6C4098FA6992156D2B082875FD6443
    Produced At: Jul  2 22:58:27 2014 GMT
    Responses:
    Certificate ID:
        Hash Algorithm: sha1
        Issuer Name Hash: D1F1B576F9EEC0C10F7AFC7C3124A9C3625D7C61
        Issuer Key Hash: EA4E7CD4802DE5158186268C826DC098A4CF970F
        Serial Number: 1121C92209F7127584AAFEB2B08ECDD30A9D
    Cert Status: good
    This Update: Jul  2 22:58:27 2014 GMT
</pre></div><div class=section id=updating-ocsp><h2>Updating <span class=caps>OCSP</span></h2><p>The simplest way of doing this is by using cron.daily or something similar to update your certificate.ocsp file.</div></section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'HPKP: HTTP Public Key Pinning with HAProxy'" href=https://kura.gg/2015/01/27/hpkp-http-public-key-pinning-with-haproxy/ itemprop=url rel=bookmark> <span class=caps>HPKP</span>: <span class=caps>HTTP</span> Public Key Pinning with HAProxy </a><li><a title="Permalink to 'haproxy1.5-dev22kura1'" href=https://kura.gg/2014/03/06/haproxy1.5-dev22kura1/ itemprop=url rel=bookmark> haproxy1.5-dev22kura1 </a><li><a title="Permalink to 'haproxy1.5-dev22'" href=https://kura.gg/2014/02/22/haproxy1.5-dev22/ itemprop=url rel=bookmark> haproxy1.5-dev22 </a><li><a title="Permalink to 'haproxy stateful SSL session resumption'" href=https://kura.gg/2014/02/22/haproxy-stateful-ssl-session-resumption/ itemprop=url rel=bookmark> haproxy stateful <span class=caps>SSL</span> session resumption </a><li><a title="Permalink to 'haproxy, nginx and SPDY with SSL termination (Debian 7)'" href=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/ itemprop=url rel=bookmark> haproxy, nginx and <span class=caps>SPDY</span> with <span class=caps>SSL</span> termination (Debian 7) </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa></i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>🦣</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'haproxy OCSP stapling' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/haproxy-ocsp-stapling.rst id=view-source> <i class=material-icons></i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2014/07/09/nginx-1.7.3-released-with-pagespeed-psol-1.8.31.4-and-naxsi-0.53-2/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> Newer </a><div class=eevee-spacer></div><a class=eevee-nav__button href=https://kura.gg/2014/06/09/hauntr/ itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> </a></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa></i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>🦣</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>