<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache" property=og:title><meta content=https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/ property=og:url><meta content="This is a rather old article, for more up-to-date information please see; /2010/02/07/nginx-proxy_cache-and-explained-benchmarked/ /2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ I‚Äôve started collecting a few blogs on my servers now and figured from this one on I would consolidate it in to one workable, usable location. Removing my need to update multiple plugins, themes and WordPress itself, over and over. This time round I thought I‚Äôd do it properly, and properly in my book is as complicated and ‚Äúawesome‚Äù as it can possibly be, without growing legs and running off to stomp a city. Love I‚Äôve fallen in-love with nginx (https://nginx.org/) over the last 6 months or so, I‚Äôd been an avid user of LighTTPD for a very long time before but started to look in to nginx mid year as a replacement. I learned that at my new job they used nginx for ‚Ä¶" property=og:description><meta content=https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache" property=twitter:title><meta content=https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/ property=twitter:url><meta content="This is a rather old article, for more up-to-date information please see; /2010/02/07/nginx-proxy_cache-and-explained-benchmarked/ /2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ I‚Äôve started collecting a few blogs on my servers now and figured from this one on I would consolidate it in to one workable, usable location. Removing my need to update multiple plugins, themes and WordPress itself, over and over. This time round I thought I‚Äôd do it properly, and properly in my book is as complicated and ‚Äúawesome‚Äù as it can possibly be, without growing legs and running off to stomp a city. Love I‚Äôve fallen in-love with nginx (https://nginx.org/) over the last 6 months or so, I‚Äôd been an avid user of LighTTPD for a very long time before but started to look in to nginx mid year as a replacement. I learned that at my new job they used nginx for ‚Ä¶" property=twitter:description><meta content=https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="5 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><script type=application/ld+json>
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Debian, Apache 2, Nginx, WordPress MU &amp; WP-Super-Cache",
    "url": "https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/",
    "description": "This is a rather old article, for more up-to-date information please see; /2010/02/07/nginx-proxy_cache-and-explained-benchmarked/ /2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ I‚Äôve started collecting a few blogs on my servers now and figured from this one on I would consolidate it in to one workable, usable location. Removing my need to update multiple plugins, themes and WordPress itself, over and over. This time round I thought I‚Äôd do it properly, and properly in my book is as complicated and ‚Äúawesome‚Äù as it can possibly be, without growing legs and running off to stomp a city. Love I‚Äôve fallen in-love with nginx (https://nginx.org/) over the last 6 months or so, I‚Äôd been an avid user of LighTTPD for a very long time before but started to look in to nginx mid year as a replacement. I learned that at my new job they used nginx for ‚Ä¶",
    "author": {
        "@type": "Person",
        "name": "Kura",
        "url": "https://kura.gg/authors/kura/"
    },
    "publisher": {
        "@type": "Organization",
        "name": "kura.gg",
        "url": "https://kura.gg",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kura.gg/favicon.png"
        }
    },
    "mainEntityOfPage": "https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/",
    "image": "https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/index.png",
    "datePublished": "2010-01-11T19:58:00+00:00"
}
</script><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons>Óóí</i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>Ó°Ø</i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>Ó°±</i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>Ó°±</i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>Ó°±</i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>Ó°Ø</i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>ÓÇ∑</i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>ÓÄØ</i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>ÓÉ•</i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>ÓÉ•</i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons> Ó¢ä </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>Ó°Ø</i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>Ó°±</i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>Ó°±</i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>Ó°±</i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>Ó°Ø</i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>ÓÇ∑</i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>ÓÄØ</i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>ÓÉ•</i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>ÓÉ•</i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content=apache,cache,debian,nginx,wordpress itemprop=keywords><meta content=tutorials itemprop=keywords><div class=eevee-share><ul class="social-share mdl-navigation"><li class="social-share__link social-share__link--twitter"><a onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Share 'Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache' on Twitter" href=https://twitter.com/intent/tweet?text=Debian%2C%20Apache%202%2C%20Nginx%2C%20WordPress%20MU%20%26%20WP-Super-Cache&url=https%3A//kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/> <i aria-hidden=true class=fa>ÔÇô</i> </a><li class="social-share__link social-share__link--facebook"><a onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Share 'Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache' on Facebook" href=https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/> <i aria-hidden=true class=fa>ÔÇö</i> </a><li class="social-share__link social-share__link--email"><a title="Share 'Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache' via email" href=mailto:?subject=Debian%2C%20Apache%202%2C%20Nginx%2C%20WordPress%20MU%20%26%20WP-Super-Cache&body=I%20thought%20you%20might%20like%20'Debian%2C%20Apache%202%2C%20Nginx%2C%20WordPress%20MU%20%26%20WP-Super-Cache'%20--%20https%3A//kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/> <i aria-hidden=true class=material-icons> ÓÉ° </i> </a></ul></div><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2010-01-11T19:58:00+00:00 itemprop=datePublished> 11 Jan 2010 </time>¬†‚Äî 5 min read</div><h1 itemprop=name><a title="Permalink to 'Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache'" href=https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/ itemprop=url rel=bookmark> Debian, Apache 2, Nginx, WordPress <span class=caps>MU</span> <span class=amp>&</span> <span class=caps>WP</span>-Super-Cache </a></h1><section class=eevee-toc><h2 id=toc>Contents</h2><nav class=eevee-toc-ribbon><div class=toc><p class=topic-title><a class="reference internal" href=#top>Contents</a><ul class=simple><li><a class="reference internal" href=#love id=toc-entry-1>Love</a><li><a class="reference internal" href=#hurdles id=toc-entry-2>Hurdles</a><li><a class="reference internal" href=#more-hurdles id=toc-entry-3>More¬†hurdles</a></ul></div></nav></section><section class=article-content itemprop=articleBody><p><em>This is a rather old article, for more up-to-date information please¬†see;</em><ol class="arabic simple"><li><a class="reference external" href=/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/>/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/</a><li><a class="reference external" href=/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/>/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/</a></ol><p>I‚Äôve started collecting a few blogs on my servers now and figured from this one on I would consolidate it in to one workable, usable location. Removing my need to update multiple plugins, themes and WordPress itself, over and¬†over.<p>This time round I thought I‚Äôd do it properly, and properly in my book is as complicated and ‚Äúawesome‚Äù as it can possibly be, without growing legs and running off to stomp a¬†city.<div class=section id=love><h2>Love</h2><p>I‚Äôve fallen in-love with nginx (<a class="reference external" href=https://nginx.org/>https://nginx.org/</a>) over the last 6 months or so, I‚Äôd been an avid user of LighTTPD for a very long time before but started to look in to nginx mid year as a replacement. I learned that at my new job they used nginx for image server and, after reading a few articles online decided nginx greatly outweighed¬†‚ÄúLighty‚Äù.<p>First stop was getting Wordpress <span class=caps>MU</span> installed, this itself proved rather interesting, I‚Äôve no idea why however. After several failed attempts (the first showing me pages without images or css, the second redirecting to nowhere and so on,) I finally got it working. On logging in I realised how horrid it was, forcing you to set-up weird sub domain structures that the blogs are <em>supposed</em> to work under. This is all well and good but I don‚Äôt have blogs running on sub domains, I have blogs running on their own domains. Ignoring this ‚Äúfeature‚Äù you can actually force set each blog to have it‚Äôs own url, but this has to be during editing after initial¬†creation.<p>The rest was the usual WordPress ease, wget the plugins and themes I wanted, unzip them as usual and stick them in the right locations, removing unwanted readme.txt files just to keep the whole place clean. On a side note; what happened to the ‚Äú<span class=caps>README</span>‚Äù files of the past? Why are they all starting to appear named as ‚Äúreadme.txt‚Äù now? I guess the Windows crowd couldn‚Äôt figure out how to open them in¬†Notepad‚Ä¶</div><div class=section id=hurdles><h2>Hurdles</h2><p>My first stumble was when I couldn‚Äôt use my beloved sitemaps plugin I‚Äôve used so many times, the problem with it is it stores the files directly in the doc root, which is fine on a single instance, but with multiple blogs they just overwrite each other. Luckily I found a nice little WordPress <span class=caps>MU</span> specific one that slotted in nicely, it appears to be generated each and every time the file is hit, so I wrote a quick script that uses wget to grab each blogs sitemap every 6 hours, saves them to the content directory and uses .htaccess to point to the right¬†one.<p>With that dragon vanquished it was time to get <span class=caps>WP</span>-Super-Cache installed, this proved painless as usual and was running under Apache 2 in no time at all, I‚Äôve yet to work out why every time I install it under Apache, Apache seems go insane, eventually slowing everything down to a crawl‚Ä¶ But that leads me on to the next¬†part.<p>Nginx reverse proxy to¬†Apache.<p>This wasn‚Äôt difficult at all, I‚Äôve reverse proxied connections to Apache many times from nginx now, being a Debian user made it quite nice a simple, I have Apache 2 running bound to 1 <span class=caps>IP</span> and nginx bound to another, I simply created a new vhost for nginx and filled it with the lovely data needed as shown¬†below.<div class=highlight><pre><span></span><span class=k>server</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>listen</span><span class=w> </span><span class=n>174.143.241.61</span><span class=p>:</span><span class=mi>80</span><span class=p>;</span>
<span class=w>    </span><span class=kn>server_name</span><span class=w> </span><span class=s>syslog.tv</span><span class=p>;</span>
<span class=w>    </span><span class=kn>access_log</span><span class=w> </span><span class=s>/var/log/nginx/syslog.tv.access.log</span><span class=p>;</span>

<span class=w>    </span><span class=kn>location</span><span class=w> </span><span class=s>/</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>proxy_pass</span><span class=w> </span><span class=s>https://apache.syslog.tv</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>Host</span><span class=w> </span><span class=nv>$host</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Real-IP</span><span class=w> </span><span class=nv>$remote_addr</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Forwarded-For</span><span class=w> </span><span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
<span class=w>        </span><span class=kn>client_max_body_size</span><span class=w> </span><span class=mi>10m</span><span class=p>;</span>
<span class=w>        </span><span class=kn>client_body_buffer_size</span><span class=w> </span><span class=mi>128k</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_connect_timeout</span><span class=w> </span><span class=mi>90</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_send_timeout</span><span class=w> </span><span class=mi>90</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_read_timeout</span><span class=w> </span><span class=mi>90</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_buffer_size</span><span class=w> </span><span class=mi>4k</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_buffers</span><span class=w> </span><span class=mi>4</span><span class=w> </span><span class=mi>32k</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_busy_buffers_size</span><span class=w> </span><span class=mi>64k</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_temp_file_write_size</span><span class=w> </span><span class=mi>64k</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>location</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>^.+.(jpg|jpeg|gif|png|ico|css|zip|tgz|gz|rar|bz2|doc|xls|exe|pdf|ppt|txt|tar|mid|midi|wav|bmp|rtf|js)</span>$<span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>root</span><span class=w> </span><span class=s>/path/to/wordpress</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>if</span><span class=w> </span><span class=s>(-f</span><span class=w> </span><span class=nv>$request_filename</span><span class=s>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>break</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>if</span><span class=w> </span><span class=s>(-d</span><span class=w> </span><span class=nv>$request_filename</span><span class=s>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>break</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>set</span><span class=w> </span><span class=nv>$supercache_file</span><span class=w> </span><span class=s>.</span><span class=p>;</span>
<span class=w>    </span><span class=kn>set</span><span class=w> </span><span class=nv>$supercache_uri</span><span class=w> </span><span class=nv>$request_uri</span><span class=p>;</span>

<span class=w>    </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$request_method</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>POST)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$supercache_uri</span><span class=w> </span><span class=s>.</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$query_string</span><span class=s>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$supercache_uri</span><span class=w> </span><span class=s>.</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>.comment_author_|wordpress|wp-postpass_.)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$supercache_uri</span><span class=w> </span><span class=s>.</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$supercache_uri</span><span class=w> </span><span class=p>~</span><span class=w> </span><span class=sr>^(.+)$)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$supercache_file</span><span class=w> </span><span class=s>/wp-content/cache/supercache/</span><span class=nv>$http_host/$1index.html</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>if</span><span class=w> </span><span class=s>(-f</span><span class=w> </span><span class=nv>$document_root$supercache_file</span><span class=s>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>rewrite</span><span class=w> </span><span class=s>^(.*)</span>$<span class=w> </span><span class=nv>$supercache_file</span><span class=w> </span><span class=s>break</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=p>}</span>
</pre></div><p>As you can see, this is rather simple, I patched it together from some articles already out there on Google, made a couple of changes where required. The main thing here is that we turn ‚Äúproxy_redirect‚Äù off, and you may also notice I am pointing at apache.syslog.tv, this domain doesn‚Äôt exist, I just created an instance of it pointing to Apache‚Äôs local <span class=caps>IP</span> in¬†/etc/hosts.</div><div class=section id=more-hurdles><h2>More¬†hurdles</h2><p>I ran in to some initial problems with this though, sadly. Problems I was unable to really find a solution to for some time. The first problem was speed, or lack of it in fact. Apache was quite literally dying on me, a restart of Apache temporarily solved this problem, in the process I also restarted nginx, this was probably a bad idea. I‚Äôd been tinkering with the nginx config, setting gzip vars and other things, this caused serious problems and made nginx throw 301 redirects for every single http request, Apache also threw 301 redirects just to complete the cycle of infinite loop. Needless to say I maxed out memory in no¬†time.<p>I reverted my changes and then found that the caching seemed to be playing up now, eventually I noticed that this was actually due to my .htaccess having the supercache data at the bottom of the file, instead of the top.¬†Fixed.<p>Again came the speed problems, I noticed that when I used Ctrl+F5 instead of just F5 or opened the site in Firefox instead of Chrome I was getting the same slow speed problems. While trying to watch my logs go speeding by I found some very interesting messages. The first was from mod_spamhaus which claimed my <span class=caps>IP</span> address was blacklisted, I ran to their website and did a lookup, thankfully it seems to only be a local blacklist, against my better judgement I disable mod_spamhaus for the time being. The other issue was coming from mod_evasive, a few quick config changes for it to handle lots of proxied requests from nginx when the cache was old or not¬†there.<p>And that solved it, solved excluding mod_spamhaus. Now I need to either find a solution or weigh the pros and cons of¬†mod_spamhaus.</div></section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'More nginx proxy_cache optimizations and nginx load¬†balancing'" href=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ itemprop=url rel=bookmark> More nginx proxy_cache optimizations and nginx load¬†balancing </a><li><a title="Permalink to 'nginx, proxy_cache and reverse proxying explained &¬†benchmarked'" href=https://kura.gg/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/ itemprop=url rel=bookmark> nginx, proxy_cache and reverse proxying explained <span class=amp>&</span>¬†benchmarked </a><li><a title="Permalink to 'Apache 2, Nginx & WordPress MU - Follow¬†up'" href=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/ itemprop=url rel=bookmark> Apache 2, Nginx <span class=amp>&</span> WordPress <span class=caps>MU</span> - Follow¬†up </a><li><a title="Permalink to 'New syslog.tv nginx wordpress site configuration¬†explained'" href=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/ itemprop=url rel=bookmark> New syslog.tv nginx wordpress site configuration¬†explained </a><li><a title="Permalink to 'WordPress + nginx + Varnish + Apache¬†2'" href=https://kura.gg/2010/09/26/nginx-varnish-apache2/ itemprop=url rel=bookmark> WordPress + nginx + Varnish + Apache¬†2 </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>ÔÇõ</i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>ü¶£</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/debian-apache-2-nginx-wordpress-mu.rst id=view-source> <i class=material-icons>Ó°Ø</i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2010/01/11/dkim-on-debian-with-postfix/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons>ÓóÑ</i></button> Newer </a><div class=eevee-spacer></div></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>ÓÇ∑</i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>ÓÄØ</i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>ÓÉ•</i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>ÓÉ•</i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa>ÔÇõ</i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>ü¶£</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>Ó°Ø</i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>Ó°±</i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>Ó°±</i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>Ó°±</i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>Ó°Ø</i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>