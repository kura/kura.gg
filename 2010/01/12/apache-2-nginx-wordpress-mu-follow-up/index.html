<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="Apache 2, Nginx & WordPress MU - Follow up" property=og:title><meta content=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/ property=og:url><meta content="This is a quick follow up to a previous post about getting this blog running on nginx with a reverse proxy to Apache 2. It seems the issue stems from 3 mods I had installed and enabled mod-spamhaus mod-evasive and mod-security The 3, when running together are a fantastic way to strengthen any web server from attack, be it DOS, injection, XLS etc. I’ve sworn by all 3 of them for years now and I thought I had them cracked for security:performance ratio, when it comes to reverse proxying requests from nginx to Apache 2 where WordPress is concerned, apparently I was very wrong. The issue wasn’t so bad when the cache was full, but seeing as my cache is only alive for an hour that leaves an open point for the cache to be recreated when a user views the page. This in itself isn’t …" property=og:description><meta content=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="Apache 2, Nginx & WordPress MU - Follow up" property=twitter:title><meta content=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/ property=twitter:url><meta content="This is a quick follow up to a previous post about getting this blog running on nginx with a reverse proxy to Apache 2. It seems the issue stems from 3 mods I had installed and enabled mod-spamhaus mod-evasive and mod-security The 3, when running together are a fantastic way to strengthen any web server from attack, be it DOS, injection, XLS etc. I’ve sworn by all 3 of them for years now and I thought I had them cracked for security:performance ratio, when it comes to reverse proxying requests from nginx to Apache 2 where WordPress is concerned, apparently I was very wrong. The issue wasn’t so bad when the cache was full, but seeing as my cache is only alive for an hour that leaves an open point for the cache to be recreated when a user views the page. This in itself isn’t …" property=twitter:description><meta content=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="2 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><script type=application/ld+json>
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Apache 2, Nginx &amp; WordPress MU - Follow up",
    "url": "https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/",
    "description": "This is a quick follow up to a previous post about getting this blog running on nginx with a reverse proxy to Apache 2. It seems the issue stems from 3 mods I had installed and enabled mod-spamhaus mod-evasive and mod-security The 3, when running together are a fantastic way to strengthen any web server from attack, be it DOS, injection, XLS etc. I’ve sworn by all 3 of them for years now and I thought I had them cracked for security:performance ratio, when it comes to reverse proxying requests from nginx to Apache 2 where WordPress is concerned, apparently I was very wrong. The issue wasn’t so bad when the cache was full, but seeing as my cache is only alive for an hour that leaves an open point for the cache to be recreated when a user views the page. This in itself isn’t …",
    "author": {
        "@type": "Person",
        "name": "Kura",
        "url": "https://kura.gg/authors/kura/"
    },
    "publisher": {
        "@type": "Organization",
        "name": "kura.gg",
        "url": "https://kura.gg/authors/kura/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kura.gg/favicon.png"
        }
    },
    "mainEntityOfPage": "https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/",
    "image": "https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/index.png",
    "datePublished": "2010-01-12T00:37:00+00:00"
}
</script><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>Apache 2, Nginx & WordPress MU - Follow up</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons></i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>  </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content=apache,cache,debian,nginx,wordpress itemprop=keywords><meta content=tutorials itemprop=keywords><div class=eevee-share><ul class="social-share mdl-navigation"><li class="social-share__link social-share__link--twitter"><a onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Share 'Apache 2, Nginx & WordPress MU - Follow up' on Twitter" href=https://twitter.com/intent/tweet?text=Apache%202%2C%20Nginx%20%26%20WordPress%20MU%20-%20Follow%20up&url=https%3A//kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--facebook"><a onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Share 'Apache 2, Nginx & WordPress MU - Follow up' on Facebook" href=https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--email"><a title="Share 'Apache 2, Nginx & WordPress MU - Follow up' via email" href=mailto:?subject=Apache%202%2C%20Nginx%20%26%20WordPress%20MU%20-%20Follow%20up&body=I%20thought%20you%20might%20like%20'Apache%202%2C%20Nginx%20%26%20WordPress%20MU%20-%20Follow%20up'%20--%20https%3A//kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/> <i aria-hidden=true class=material-icons>  </i> </a></ul></div><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2010-01-12T00:37:00+00:00 itemprop=datePublished> 12 Jan 2010 </time> — 2 min read</div><h1 itemprop=name><a title="Permalink to 'Apache 2, Nginx & WordPress MU - Follow up'" href=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/ itemprop=url rel=bookmark> Apache 2, Nginx <span class=amp>&</span> WordPress <span class=caps>MU</span> - Follow up </a></h1><section class=article-content itemprop=articleBody><p>This is a quick follow up to a previous post about getting this blog <a class="reference external" href=/2010/01/11/debian-apache-2-nginx-wordpress-mu/>running on nginx with a reverse proxy to Apache 2</a>.<p>It seems the issue stems from 3 mods I had installed and enabled<ol class="arabic simple"><li>mod-spamhaus<li>mod-evasive and<li>mod-security</ol><p>The 3, when running together are a fantastic way to strengthen any web server from attack, be it <span class=caps>DOS</span>, injection, <span class=caps>XLS</span> etc. I’ve sworn by all 3 of them for years now and I thought I had them cracked for security:performance ratio, when it comes to reverse proxying requests from nginx to Apache 2 where WordPress is concerned, apparently I was very wrong.<p>The issue wasn’t so bad when the cache was full, but seeing as my cache is only alive for an hour that leaves an open point for the cache to be recreated when a user views the page. This in itself isn’t a bad thing or even the root cause, the actual cause appears to be a huge amount of requests hitting Apache, these in turn trigger all 3 mods, all for the same reason; lots and lots of requests in short amounts of time from the same <span class=caps>IP</span> address.<p>Somehow this was causing Apache to spawn many child processes which it then tried to kill when the requests were completed or killed, this put my server load to 15.02 at one point in time, causing the server to go in to a frenzy as Apache tried to spawn even more children to handle the requests, getting itself caught in a vicious looping cycle.<p>As it stands now I have lowered the tolerance of both mod-evasive and mod-security which has massively improved performance to the point where now I can clean and recreate the cache of all blogs running from this <span class=caps>WPMU</span> installation at the same time, while browsing and never notice it.<p>Currently mod-spamhaus has been disabled until such time as I can figure out it’s configuration variables and get it running nicely without it killing my server when the site in question is a WordPress site.<p>As a consequence my other non <span class=caps>WPMU</span> blogs that are running purely on Apache with no nginx reverse proxy have also sped up dramatically which is always a good thing. I guess for now I’ll have to write a quick Python script that temporarily bans people using iptables until I can get all 3 mods working in harmony.<p>Will post in the future when I have more info.</section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'More nginx proxy_cache optimizations and nginx load balancing'" href=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ itemprop=url rel=bookmark> More nginx proxy_cache optimizations and nginx load balancing </a><li><a title="Permalink to 'nginx, proxy_cache and reverse proxying explained & benchmarked'" href=https://kura.gg/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/ itemprop=url rel=bookmark> nginx, proxy_cache and reverse proxying explained <span class=amp>&</span> benchmarked </a><li><a title="Permalink to 'Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache'" href=https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/ itemprop=url rel=bookmark> Debian, Apache 2, Nginx, WordPress <span class=caps>MU</span> <span class=amp>&</span> <span class=caps>WP</span>-Super-Cache </a><li><a title="Permalink to 'New syslog.tv nginx wordpress site configuration explained'" href=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/ itemprop=url rel=bookmark> New syslog.tv nginx wordpress site configuration explained </a><li><a title="Permalink to 'WordPress + nginx + Varnish + Apache 2'" href=https://kura.gg/2010/09/26/nginx-varnish-apache2/ itemprop=url rel=bookmark> WordPress + nginx + Varnish + Apache 2 </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa></i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>🦣</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'Apache 2, Nginx & WordPress MU - Follow up' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/apache-2-nginx-wordpress-mu-follow-up.rst id=view-source> <i class=material-icons></i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2010/01/12/howto-debian-apache-2-amp-mod_ssl/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> Newer </a><div class=eevee-spacer></div><a class=eevee-nav__button href=https://kura.gg/2010/01/11/dkim-on-debian-with-postfix/ itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> </a></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa></i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>🦣</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>