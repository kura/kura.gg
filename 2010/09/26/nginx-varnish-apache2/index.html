<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="WordPress + nginx + Varnish + ApacheÂ 2" property=og:title><meta content=https://kura.gg/2010/09/26/nginx-varnish-apache2/ property=og:url><meta content="Lately Iâ€™ve been doing a lot of work with Varnish, this includes testing it within a load balanced environment, putting it behind nginx, putting it in front of Solr, the list goes on. This blog post will hopefully give you an insight in to a simple way of combining nginx, Varnish and Apache to create a powerful Wordpress environment that can really take a hammering. Iâ€™m going to assume you already have Apache and nginx working together, if not I suggest you read my other articles on these subjects to learn how to combine them. Installing Varnish sudo apt-get install varnish Configuring Apache I suggest binding Apache to port 81, this is easy to change, open the following file in your favourite editor. /etc/apache2/ports.conf Change the Listen and NameVirtualHost lines to: Listen 81 NameVirtualHost *:81 This will mean you need to go and change all â€¦" property=og:description><meta content=https://kura.gg/2010/09/26/nginx-varnish-apache2/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="WordPress + nginx + Varnish + ApacheÂ 2" property=twitter:title><meta content=https://kura.gg/2010/09/26/nginx-varnish-apache2/ property=twitter:url><meta content="Lately Iâ€™ve been doing a lot of work with Varnish, this includes testing it within a load balanced environment, putting it behind nginx, putting it in front of Solr, the list goes on. This blog post will hopefully give you an insight in to a simple way of combining nginx, Varnish and Apache to create a powerful Wordpress environment that can really take a hammering. Iâ€™m going to assume you already have Apache and nginx working together, if not I suggest you read my other articles on these subjects to learn how to combine them. Installing Varnish sudo apt-get install varnish Configuring Apache I suggest binding Apache to port 81, this is easy to change, open the following file in your favourite editor. /etc/apache2/ports.conf Change the Listen and NameVirtualHost lines to: Listen 81 NameVirtualHost *:81 This will mean you need to go and change all â€¦" property=twitter:description><meta content=https://kura.gg/2010/09/26/nginx-varnish-apache2/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="6 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><script type=application/ld+json>
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "WordPress + nginx + Varnish + ApacheÂ 2",
    "url": "https://kura.gg/2010/09/26/nginx-varnish-apache2/",
    "description": "Lately Iâ€™ve been doing a lot of work with Varnish, this includes testing it within a load balanced environment, putting it behind nginx, putting it in front of Solr, the list goes on. This blog post will hopefully give you an insight in to a simple way of combining nginx, Varnish and Apache to create a powerful Wordpress environment that can really take a hammering. Iâ€™m going to assume you already have Apache and nginx working together, if not I suggest you read my other articles on these subjects to learn how to combine them. Installing Varnish sudo apt-get install varnish Configuring Apache I suggest binding Apache to port 81, this is easy to change, open the following file in your favourite editor. /etc/apache2/ports.conf Change the Listen and NameVirtualHost lines to: Listen 81 NameVirtualHost *:81 This will mean you need to go and change all â€¦",
    "author": {
        "@type": "Person",
        "name": "Kura",
        "url": "https://kura.gg/authors/kura/"
    },
    "publisher": {
        "@type": "Organization",
        "name": "kura.gg",
        "url": "https://kura.gg",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kura.gg/favicon.png"
        }
    },
    "mainEntityOfPage": "https://kura.gg/2010/09/26/nginx-varnish-apache2/",
    "image": "https://kura.gg/2010/09/26/nginx-varnish-apache2/index.png",
    "datePublished": "2010-09-26T19:41:00+01:00"
}
</script><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>WordPress + nginx + Varnish + ApacheÂ 2</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons>î—’</i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>î¡¯</i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>î¡±</i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>î¡±</i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>î¡±</i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>î¡¯</i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>î‚·</i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>î€¯</i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>îƒ¥</i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>îƒ¥</i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons> î¢Š </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>î¡¯</i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>î¡±</i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>î¡±</i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>î¡±</i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>î¡¯</i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>î‚·</i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>î€¯</i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>îƒ¥</i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>îƒ¥</i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content=apache,nginx,varnish,wordpress itemprop=keywords><meta content=tutorials itemprop=keywords><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2010-09-26T19:41:00+01:00 itemprop=datePublished> 26 Sep 2010 </time>Â â€” 6 min read</div><h1 itemprop=name><a title="Permalink to 'WordPress + nginx + Varnish + ApacheÂ 2'" href=https://kura.gg/2010/09/26/nginx-varnish-apache2/ itemprop=url rel=bookmark> WordPress + nginx + Varnish + ApacheÂ 2 </a></h1><section class=eevee-toc><h2 id=toc>Contents</h2><nav class=eevee-toc-ribbon><div class=toc><p class=topic-title><a class="reference internal" href=#top>Contents</a><ul class=simple><li><a class="reference internal" href=#installing-varnish id=toc-entry-1>InstallingÂ Varnish</a><li><a class="reference internal" href=#configuring-apache id=toc-entry-2>ConfiguringÂ Apache</a><li><a class="reference internal" href=#configuring-varnish id=toc-entry-3>ConfiguringÂ Varnish</a><li><a class="reference internal" href=#configuring-nginx id=toc-entry-4>ConfiguringÂ nginx</a><li><a class="reference internal" href=#finishing-up id=toc-entry-5>FinishingÂ up</a><li><a class="reference internal" href=#testing id=toc-entry-6>Testing</a></ul></div></nav></section><section class=article-content itemprop=articleBody><p>Lately Iâ€™ve been doing a lot of work with Varnish, this includes testing it within a load balanced environment, putting it behind nginx, putting it in front of Solr, the list goesÂ on.<p>This blog post will hopefully give you an insight in to a simple way of combining nginx, Varnish and Apache to create a powerful Wordpress environment that can really take aÂ hammering.<p>Iâ€™m going to assume you already have Apache and nginx working together, if not I suggest you read my other articles on these subjects to learn how to combineÂ them.<div class=section id=installing-varnish><h2>InstallingÂ Varnish</h2><div class=highlight><pre><span></span>sudo<span class=w> </span>apt-get<span class=w> </span>install<span class=w> </span>varnish
</pre></div></div><div class=section id=configuring-apache><h2>ConfiguringÂ Apache</h2><p>I suggest binding Apache to port 81, this is easy to change, open the following file in your favouriteÂ editor.<blockquote>/etc/apache2/ports.conf</blockquote><p>Change the Listen and NameVirtualHost linesÂ to:<div class=highlight><pre><span></span><span class=nb>Listen</span><span class=w> </span><span class=m>81</span>
<span class=nb>NameVirtualHost</span><span class=w> </span>*:81
</pre></div><p>This will mean you need to go and change all of your virtualhost definitions to work on portÂ 81.<p>ExampleÂ below.<div class=highlight><pre><span></span><span class=nt>&LTVirtualHost</span><span class=w> </span><span class=s>*:81</span><span class=nt>></span>
<span class=w>    </span><span class=nb>ServerAdmin</span><span class=w> </span>webmaster@example.com
<span class=w>    </span><span class=nb>ServerName</span><span class=w> </span>example.com
<span class=w>    </span><span class=nb>DocumentRoot</span><span class=w> </span><span class=sx>/var/www/website</span>

<span class=w>    </span><span class=nb>CustomLog</span><span class=w> </span><span class=sx>/var/log/apache2/access.example.com.log</span><span class=w> </span>combined
<span class=w>    </span><span class=nb>ErrorLog</span><span class=w> </span><span class=sx>/var/log/apache2/error.example.com.log</span>
<span class=nt>&LT/VirtualHost></span>
</pre></div></div><div class=section id=configuring-varnish><h2>ConfiguringÂ Varnish</h2><p>Open the following file in your favouriteÂ editor<blockquote>/etc/varnish/default.vcl</blockquote><p>First we define aÂ backend<pre class=literal-block>
backend default {
    .host = "localhost";
    .port = "81";
}
</pre><p>This defines a host, this should be pretty straight forward, we set the host and port number toÂ use.<p>Next we define a list of allowed hosts, this is going to be used to verify if the requester is allowed to use the <span class=caps>PURGE</span> request type, this is used for purging pages on-the-fly and will be explainedÂ later.<pre class=literal-block>
acl purge {
    "localhost";
}
</pre><p>Next we set up our vcl_recv method, this is called when a request isÂ received.<pre class=literal-block>
sub vcl_recv {
    set req.grace = 6h;

    if (req.request == "PURGE") {
        if(!client.ip ~ purge) {
            error 405 "Not allowed.";
        }

    purge("req.url ~ ^" req.url "$ && req.http.host == "req.http.host);

    }

    if (req.url ~ ".(jpg|png|gif|gz|tgz|bz2|lzma|tbz)(?.*|)$") {
        remove req.http.Accept-Encoding;
    } elsif (req.http.Accept-Encoding ~ "gzip") {
        set req.http.Accept-Encoding = "gzip";
    } elsif (req.http.Accept-Encoding ~ "deflate") {
        set req.http.Accept-Encoding = "deflate";
    } else {
        remove req.http.Accept-Encoding;
    }

    if (req.url ~ "wp-(login|admin)") {
        return (pass);
    }

    if (req.request != "GET" && req.request != "HEAD") {
        return (pass);
    }

    unset req.http.cookie;

    if (req.url ~ ".(jpeg|jpg|png|gif|ico|swf|js|css|txt|gz|zip|rar|bz2|tgz|tbz|html|htm|pdf|pls|torrent)(?.*|)$") {
        unset req.http.Authenticate;
        unset req.http.POSTDATA;
        set req.request = "GET";
        set req.url = regsub(req.url, "?.*$", "");
        return (lookup);
    }

}
</pre><p>I should explain what the above methodÂ does.<ul class=simple><li>We set req.grace to 6 hours, this means that if the cache expires and the backend is unreachable Varnish will continue using the cached copy for 6 hours. The first if statement checks to see if the request type is <span class=caps>PURGE</span>, if it is then it looks to see if the requester is in the access list, if they are then it purges the requested page. More on thisÂ later.<li>The next if/elseif/else statement is for handling encoding, it should be relatively straightÂ forward.<li>Next we look to see if the url is either wp-login or wp-admin, if it is we tell Varnish to pass to the backend and exit the vcl_recvÂ function.<li>We then check to see if the request type is neither <span class=caps>GET</span> nor <span class=caps>HEAD</span>, if not we pass to the backend and exitÂ vcl_recv.<li>Next we unset all cookies, this is required since Varnish will not cache content when cookies areÂ present.<li>The final if statement checks to see if the url has a static content extension, removes all <span class=caps>HTTP</span> Auth and <span class=caps>POST</span> data, sets the request type to <span class=caps>GET</span> and removes all QUERY_STRING content from the <span class=caps>URL</span> if it is staticÂ content.</ul><p>Next is vcl_pipe andÂ vcl_pass.<pre class=literal-block>
sub vcl_pipe {
    set bereq.http.connection = "close";
    if (req.http.X-Forwarded-For) {
        set bereq.http.X-Forwarded-For = req.http.X-Forwarded-For;
    } else {
        set bereq.http.X-Forwarded-For = regsub(client.ip, ":.*", "");
    }
}
sub vcl_pass {
    set bereq.http.connection = "close";
    if (req.http.X-Forwarded-For) {
        set bereq.http.X-Forwarded-For = req.http.X-Forwarded-For;
    } else {
        set bereq.http.X-Forwarded-For = regsub(client.ip, ":.*", "");
    }
}
</pre><p>These methods are identical and simply pass our X-Forwarded-For headers around, this is used within nginx and Apache for logging correct <span class=caps>IP</span> addresses in the accessÂ logs.<pre class=literal-block>
sub vcl_fetch {
    set beresp.ttl = 1h;
    set req.grace = 6h;
    if (req.url ~ "wp-(login|admin)") {
        return (pass);
    }

    unset beresp.http.set-cookie;

    if (req.url ~ ".(jpeg|jpg|png|gif|ico|swf|js|css|txt|gz|zip|rar|bz2|tgz|tbz|html|htm|pdf|pls|torrent)$") {
        set beresp.ttl = 24h;
    }
}
</pre><p>This method is where content is returned from Varnish back toÂ nginx.<ul class=simple><li>First we set the <span class=caps>TTL</span> of the cache to 1Â hour.<li>We again set the grace period as above inÂ vcl_recv,<li>again we check for wp-login or wp-admin and drop out of the method if itâ€™s found, this stops admin pages beingÂ cached.<li>Next we unset the Set-CookieÂ header<li>and finally if we detect the url contains a static content extension we set the <span class=caps>TTL</span> of the cache to 24Â hours.</ul><p>And last but not least is vcl_deliver, this one simply adds some X-Cache header information for debug purposes and can beÂ ignored.<pre class=literal-block>
sub vcl_deliver {
    if (obj.hits > 0) {
        set resp.http.X-Cache = "HIT";
        set resp.http.X-Cache-Hits = obj.hits;
    } else {
        set resp.http.X-Cache = "MISS";
    }
}
</pre><p>Varnish is nowÂ configured.<p>You can find a copy of my default.vcl file here - <a class="reference external" href=/files/syslog-varnish-default-vcl-26-sept-2010>/files/syslog-varnish-default-vcl-26-sept-2010</a></div><div class=section id=configuring-nginx><h2>ConfiguringÂ nginx</h2><div class=highlight><pre><span></span><span class=k>server</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>listen</span><span class=w> </span><span class=mi>80</span><span class=p>;</span>
<span class=w>    </span><span class=kn>server_name</span><span class=w> </span><span class=s>example.com</span><span class=p>;</span>
<span class=w>    </span><span class=kn>access_log</span><span class=w> </span><span class=s>/var/log/nginx/access.example.com.log</span><span class=p>;</span>

<span class=w>    </span><span class=kn>gzip</span><span class=w> </span><span class=no>on</span><span class=p>;</span>
<span class=w>    </span><span class=kn>gzip_disable</span><span class=w> </span><span class=s>msie6</span><span class=p>;</span>
<span class=w>    </span><span class=kn>gzip_static</span><span class=w> </span><span class=no>on</span><span class=p>;</span>
<span class=w>    </span><span class=kn>gzip_comp_level</span><span class=w> </span><span class=mi>9</span><span class=p>;</span>
<span class=w>    </span><span class=kn>gzip_proxied</span><span class=w> </span><span class=s>any</span><span class=p>;</span>
<span class=w>    </span><span class=kn>gzip_types</span><span class=w> </span><span class=s>text/plain</span><span class=w> </span><span class=s>text/css</span><span class=w> </span><span class=s>application/x-javascript</span><span class=w> </span><span class=s>text/xml</span><span class=w> </span><span class=s>application/xml</span><span class=w> </span><span class=s>application/xml+rss</span><span class=w> </span><span class=s>text/javascript</span><span class=p>;</span>

<span class=w>    </span><span class=kn>location</span><span class=w> </span><span class=s>/</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>proxy_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>Host</span><span class=w> </span><span class=nv>$host</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Real-IP</span><span class=w> </span><span class=nv>$remote_addr</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Forwarded-For</span><span class=w> </span><span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_pass_header</span><span class=w> </span><span class=s>Set-Cookie</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_pass</span><span class=w> </span><span class=s>https://localhost:6081</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>
</pre></div><p>This nginx host config should be simple to those of you whoâ€™ve read my other articles, if not then hereâ€™s a quickÂ summary;<ul class=simple><li>listen and server_name are simply the port to listen on and the domainÂ name,<li>gzip enablesÂ gzip,<li>gzip_disable tells nginx not to gzip compress for <span class=caps>IE6</span>,<li>gzip_static is on to enable compression of static content (jpeg, gifÂ etc),<li>gzip_comp_level is the level of compression, 1-9 (higher = moreÂ compressed)<li>gzip_proxied is set to any to gzip proxiedÂ content<li>and finally we set the types of files toÂ gzip.<li>Next we set up ourÂ location,<li>disable proxyÂ redirects<li>set Host, X-Real-Ip and X-Forwarded-ForÂ headers<li>pass back the Set-CookieÂ header<li>and pass the connection over toÂ Varnish.</ul></div><div class=section id=finishing-up><h2>FinishingÂ up</h2><p>Now we simply need to restart theÂ services<blockquote>/etc/init.d/apache2 force-reload && /etc/init.d/varnish restart && /etc/init.d/nginx reload</blockquote></div><div class=section id=testing><h2>Testing</h2><p>Now you can browse your site and it should be going through nginx and Varnish and only hitting Apache if the content is not cached or if youâ€™re using the WordPress admin panel or doing a <span class=caps>POST</span>Â request.<p>You can test this with Live <span class=caps>HTTP</span> Headers extension for Firefox - <a class="reference external" href=https://addons.mozilla.org/en-US/firefox/addon/3829/>https://addons.mozilla.org/en-<span class=caps>US</span>/firefox/addon/3829/</a> (this will only work if you used my vcl_delivery method in your VarnishÂ config).<p>Go to a page on your site, refresh a few times, open up Live <span class=caps>HTTP</span> Headers and refresh again, you should see theÂ following<pre class=literal-block>
HTTP/1.1 200 OK
Server: nginx
... snip ...
Via: 1.1 varnish
X-Cache: HIT
X-Cache-Hits: &LTnumeric value>
</pre></div></section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'New syslog.tv nginx wordpress site configurationÂ explained'" href=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/ itemprop=url rel=bookmark> New syslog.tv nginx wordpress site configurationÂ explained </a><li><a title="Permalink to 'More nginx proxy_cache optimizations and nginx loadÂ balancing'" href=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ itemprop=url rel=bookmark> More nginx proxy_cache optimizations and nginx loadÂ balancing </a><li><a title="Permalink to 'nginx, proxy_cache and reverse proxying explained &Â benchmarked'" href=https://kura.gg/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/ itemprop=url rel=bookmark> nginx, proxy_cache and reverse proxying explained <span class=amp>&</span>Â benchmarked </a><li><a title="Permalink to 'Using nginx, Varnish andÂ Apache'" href=https://kura.gg/2010/02/06/using-nginx-varnish-and-apache/ itemprop=url rel=bookmark> Using nginx, Varnish andÂ Apache </a><li><a title="Permalink to 'Apache 2, Nginx & WordPress MU - FollowÂ up'" href=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/ itemprop=url rel=bookmark> Apache 2, Nginx <span class=amp>&</span> WordPress <span class=caps>MU</span> - FollowÂ up </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>ï‚›</i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>ðŸ¦£</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'WordPress + nginx + Varnish + ApacheÂ 2' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/2010-09-26-nginx-varnish-apache2.rst id=view-source> <i class=material-icons>î¡¯</i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2010/10/20/refresh-linux-partition-table-online/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons>î—„</i></button> Newer </a><div class=eevee-spacer></div><a class=eevee-nav__button href=https://kura.gg/2010/09/26/mounting-a-remote-filesystem-using-sshfs/ itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons>î—ˆ</i></button> </a></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>î‚·</i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>î€¯</i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>îƒ¥</i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>îƒ¥</i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa>ï‚›</i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>ðŸ¦£</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>î¡¯</i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>î¡±</i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>î¡±</i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>î¡±</i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>î¡¯</i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>