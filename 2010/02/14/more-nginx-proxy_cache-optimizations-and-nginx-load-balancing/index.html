<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="More nginx proxy_cache optimizations and nginx load balancing" property=og:title><meta content=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ property=og:url><meta content='This is yet another follow up to post to several previous posts about using nginx as a reverse proxy with caching. It is actually a direct addition to my post from a week or so ago which outlined how to actually using nginx’s proxy caching feature which can be read here — /2010/02/07/nginx-proxy_cache-and-explained-benchmarked/. Even more changes? Yes, even more changes, these are basic changes that are there to improve the caching capabilities and also implement load balancing. Cache changes The first set of changes are in the main nginx configuration file /etc/nginx/nginx.conf These changes basically just change the proxy_cache key proxy_cache_path /var/www/nginx_cache levels=1:2 keys_zone=cache:8m max_size=1000m inactive=600m; proxy_temp_path /tmp/nginx; proxy_cache_key "$scheme://$host$request_uri"; I’ve decided to put the temporary caches file in to an nginx specific directory, just to separate them from other cache files …' property=og:description><meta content=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="More nginx proxy_cache optimizations and nginx load balancing" property=twitter:title><meta content=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ property=twitter:url><meta content='This is yet another follow up to post to several previous posts about using nginx as a reverse proxy with caching. It is actually a direct addition to my post from a week or so ago which outlined how to actually using nginx’s proxy caching feature which can be read here — /2010/02/07/nginx-proxy_cache-and-explained-benchmarked/. Even more changes? Yes, even more changes, these are basic changes that are there to improve the caching capabilities and also implement load balancing. Cache changes The first set of changes are in the main nginx configuration file /etc/nginx/nginx.conf These changes basically just change the proxy_cache key proxy_cache_path /var/www/nginx_cache levels=1:2 keys_zone=cache:8m max_size=1000m inactive=600m; proxy_temp_path /tmp/nginx; proxy_cache_key "$scheme://$host$request_uri"; I’ve decided to put the temporary caches file in to an nginx specific directory, just to separate them from other cache files …' property=twitter:description><meta content=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="4 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><script type=application/ld+json>
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "More nginx proxy_cache optimizations and nginx load balancing",
    "url": "https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/",
    "description": "This is yet another follow up to post to several previous posts about using nginx as a reverse proxy with caching. It is actually a direct addition to my post from a week or so ago which outlined how to actually using nginx’s proxy caching feature which can be read here — /2010/02/07/nginx-proxy_cache-and-explained-benchmarked/. Even more changes? Yes, even more changes, these are basic changes that are there to improve the caching capabilities and also implement load balancing. Cache changes The first set of changes are in the main nginx configuration file /etc/nginx/nginx.conf These changes basically just change the proxy_cache key proxy_cache_path /var/www/nginx_cache levels=1:2 keys_zone=cache:8m max_size=1000m inactive=600m; proxy_temp_path /tmp/nginx; proxy_cache_key &#34;$scheme://$host$request_uri&#34;; I’ve decided to put the temporary caches file in to an nginx specific directory, just to separate them from other cache files …",
    "author": {
        "@type": "Person",
        "name": "Kura",
        "url": "https://kura.gg/authors/kura/"
    },
    "publisher": {
        "@type": "Organization",
        "name": "kura.gg",
        "url": "https://kura.gg",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kura.gg/favicon.png"
        }
    },
    "mainEntityOfPage": "https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/",
    "image": "https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/index.png",
    "datePublished": "2010-02-14T14:27:00+00:00"
}
</script><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>More nginx proxy_cache optimizations and nginx load balancing</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons></i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>  </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content="apache,cache,debian,howto,load balancing,nginx,ubuntu,wordpress" itemprop=keywords><meta content=tutorials itemprop=keywords><div class=eevee-share><ul class="social-share mdl-navigation"><li class="social-share__link social-share__link--twitter"><a onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Share 'More nginx proxy_cache optimizations and nginx load balancing' on Twitter" href=https://twitter.com/intent/tweet?text=More%20nginx%20proxy_cache%20optimizations%20and%20nginx%20load%20balancing&url=https%3A//kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--facebook"><a onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Share 'More nginx proxy_cache optimizations and nginx load balancing' on Facebook" href=https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--email"><a title="Share 'More nginx proxy_cache optimizations and nginx load balancing' via email" href=mailto:?subject=More%20nginx%20proxy_cache%20optimizations%20and%20nginx%20load%20balancing&body=I%20thought%20you%20might%20like%20'More%20nginx%20proxy_cache%20optimizations%20and%20nginx%20load%20balancing'%20--%20https%3A//kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/> <i aria-hidden=true class=material-icons>  </i> </a></ul></div><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2010-02-14T14:27:00+00:00 itemprop=datePublished> 14 Feb 2010 </time> — 4 min read</div><h1 itemprop=name><a title="Permalink to 'More nginx proxy_cache optimizations and nginx load balancing'" href=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ itemprop=url rel=bookmark> More nginx proxy_cache optimizations and nginx load balancing </a></h1><section class=eevee-toc><h2 id=toc>Contents</h2><nav class=eevee-toc-ribbon><div class=toc><p class=topic-title><a class="reference internal" href=#top>Contents</a><ul class=simple><li><a class="reference internal" href=#even-more-changes id=toc-entry-1>Even more changes?</a><ul><li><a class="reference internal" href=#cache-changes id=toc-entry-2>Cache changes</a><li><a class="reference internal" href=#load-balancing-changes id=toc-entry-3>Load balancing changes</a><li><a class="reference internal" href=#server-definition-changes id=toc-entry-4>Server definition changes</a></ul><li><a class="reference internal" href=#why-the-changes id=toc-entry-5>Why the changes?</a><li><a class="reference internal" href=#the-full-config id=toc-entry-6>The full config</a></ul></div></nav></section><section class=article-content itemprop=articleBody><p>This is yet another follow up to post to several previous posts about using nginx as a reverse proxy with caching. It is actually a direct addition to my post from a week or so ago which outlined how to actually using nginx’s proxy caching feature which can be read here — <a class="reference external" href=https://syslog.tv/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/>/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/</a>.<div class=section id=even-more-changes><h2>Even more changes?</h2><p>Yes, even more changes, these are basic changes that are there to improve the caching capabilities and also implement load balancing.<div class=section id=cache-changes><h3>Cache changes</h3><p>The first set of changes are in the main nginx configuration file<blockquote>/etc/nginx/nginx.conf</blockquote><p>These changes basically just change the proxy_cache key<div class=highlight><pre><span></span><span class=k>proxy_cache_path</span><span class=w> </span><span class=s>/var/www/nginx_cache</span><span class=w> </span><span class=s>levels=1:2</span><span class=w> </span><span class=s>keys_zone=cache:8m</span><span class=w> </span><span class=s>max_size=1000m</span><span class=w> </span><span class=s>inactive=600m</span><span class=p>;</span>
<span class=k>proxy_temp_path</span><span class=w> </span><span class=s>/tmp/nginx</span><span class=p>;</span>
<span class=k>proxy_cache_key</span><span class=w> </span><span class=s>"</span><span class=nv>$scheme://$host$request_uri"</span><span class=p>;</span>
</pre></div><p>I’ve decided to put the temporary caches file in to an nginx specific directory, just to separate them from other cache files. I’ve also modified the proxy_cache_key to add the following variables:<ul class=simple><li><strong>$scheme</strong> - This will be the protocol; http or https<li><strong>$host</strong> - Host name, this will be set as syslog.tv for me<li><strong>$request_uri</strong> - The full request uri, this is simple</ul><p>Why add these variables? Quite simple really, it means I can have multiple sites running with proxy caching enabled and have them set a meaningful key so they don’t clash.</div><div class=section id=load-balancing-changes><h3>Load balancing changes</h3><p>The next set of changes will be specific to my site specific configuration file, the first of which is an addition on an upstream definition.<p>/etc/nginx/sites-available/syslog.tv<div class=highlight><pre><span></span><span class=k>upstream</span><span class=w> </span><span class=s>apachesyslogtv</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>server</span><span class=w> </span><span class=s>apache.syslog.tv</span><span class=w> </span><span class=s>weight=1</span><span class=w> </span><span class=s>fail_timeout=60s</span><span class=p>;</span>
<span class=p>}</span>
</pre></div><p>So what does this mean? This is really actually quite simple, we define an upstream set called <strong>apachesyslogtv</strong>, which contains, in this example, a single server definition with a weight of 1 and a fail timeout of 60 seconds. You would actually be able to add multiple server definitions to this with different weights and fail timeouts. This is used for load balancing.<div class=highlight><pre><span></span><span class=k>upstream</span><span class=w> </span><span class=s>apachesyslogtv</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>server</span><span class=w> </span><span class=s>apache1.syslog.tv</span><span class=w> </span><span class=s>weight=1</span><span class=w> </span><span class=s>fail_timeout=60s</span><span class=p>;</span>
<span class=w>    </span><span class=kn>server</span><span class=w> </span><span class=s>apache2.syslog.tv</span><span class=w> </span><span class=s>weight=1</span><span class=w> </span><span class=s>fail_timeout=60s</span><span class=p>;</span>
<span class=p>}</span>
</pre></div></div><div class=section id=server-definition-changes><h3>Server definition changes</h3><p>There are quite a lot of changes that are made to the actual server definition, I will go through these step-by-step to explain what has changed and why it’s changed.<div class=highlight><pre><span></span><span class=k>location</span><span class=w> </span><span class=s>/</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>root</span><span class=w> </span><span class=s>/path/to/site</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>Host</span><span class=w> </span><span class=nv>$host</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Real-IP</span><span class=w> </span><span class=nv>$remote_addr</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Forwarded-For</span><span class=w> </span><span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>

<span class=w>    </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>"comment_author_|wordpress_(?!test_cookie)|wp-postpass_")</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$do_not_cache</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>proxy_cache_key</span><span class=w> </span><span class=s>"</span><span class=nv>$scheme://$host$request_uri</span><span class=w> </span><span class=nv>$do_not_cache"</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_cache</span><span class=w> </span><span class=s>cache</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_cache_valid</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=mi>302</span><span class=w> </span><span class=mi>60m</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_cache_valid</span><span class=w> </span><span class=mi>404</span><span class=w> </span><span class=mi>1m</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_pass</span><span class=w> </span><span class=s>https://apachesyslogtv</span><span class=p>;</span>
<span class=p>}</span>
</pre></div><p>Ok, so that’s the first location, definition. Several things have changed with this.<p>The first change is an addition of a cookie check, in my case I’m running a WordPress site so I check for various WordPress cookies, if they exist I set the variable <strong>$do_not_cache</strong> to 1.<p>Next is a change to the proxy_cache_key to incorporate the $do_not_cache variable, this tells nginx not to cache the current page.<p>And finally is a change to proxy_pass, this now points to the name of my upstream definition, which nginx will then use to decide which server to use.<div class=highlight><pre><span></span><span class=k>location</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>.(jpg|png|gif|jpeg|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)</span>$<span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>proxy_cache_valid</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=mi>120m</span><span class=p>;</span>
<span class=w>    </span><span class=kn>expires</span><span class=w> </span><span class=mi>604800</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_pass</span><span class=w> </span><span class=s>https://apachesyslogtv</span><span class=p>;</span>
<span class=w>    </span><span class=kn>proxy_cache</span><span class=w> </span><span class=s>cache</span><span class=p>;</span>
<span class=p>}</span>
</pre></div><p>The second and final location definition, which will match a file extension in the <span class=caps>URL</span>, if a match is found it will set the cache validity to 2 hours, expire to 7 days, pass back to our upstream definition and cache the result. You may notice that out of all of these static file extensions .js is missing, this is because a lot of my site is generated by Javascript/Ajax and this will not work with caching.</div></div><div class=section id=why-the-changes><h2>Why the changes?</h2><p>With these changes I am able to properly store with a cache key which allows me to cache all of my nginx sites, I’ve added the ability to balance load across multiple servers and I’ve increased the power of the caching to only cache pages if you’re not logged in and to always cache static files for a long time. Meaning that the cache shouldn’t need to be regenerated very often.<p>All in all these changes do not increase the power of the server at all, but with a load balanced environment this would obviously increase the performance dramatically.</div><div class=section id=the-full-config><h2>The full config</h2><div class=highlight><pre><span></span><span class=k>upstream</span><span class=w> </span><span class=s>apachesyslogtv</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>server</span><span class=w> </span><span class=s>apache.syslog.tv</span><span class=w> </span><span class=s>weight=1</span><span class=w> </span><span class=s>fail_timeout=60s</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>server</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kn>listen</span><span class=w> </span><span class=n>174.143.241.61</span><span class=p>:</span><span class=mi>80</span><span class=p>;</span>
<span class=w>    </span><span class=kn>server_name</span><span class=w> </span><span class=s>syslog.tv</span><span class=p>;</span>
<span class=w>    </span><span class=kn>access_log</span><span class=w> </span><span class=s>/var/log/nginx/syslog.tv.access.log</span><span class=p>;</span>
<span class=w>    </span><span class=kn>gzip_vary</span><span class=w> </span><span class=no>on</span><span class=p>;</span>
<span class=w>    </span><span class=kn>gzip_static</span><span class=w> </span><span class=no>on</span><span class=p>;</span>

<span class=w>    </span><span class=kn>location</span><span class=w> </span><span class=s>/</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>root</span><span class=w> </span><span class=s>/path/to/site</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>Host</span><span class=w> </span><span class=nv>$host</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Real-IP</span><span class=w> </span><span class=nv>$remote_addr</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Forwarded-For</span><span class=w> </span><span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span>

<span class=w>        </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>"comment_author_|wordpress_(?!test_cookie)|wp-postpass_")</span><span class=w> </span><span class=p>{</span>
<span class=w>            </span><span class=kn>set</span><span class=w> </span><span class=nv>$do_not_cache</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<span class=w>        </span><span class=p>}</span>

<span class=w>        </span><span class=kn>proxy_cache_key</span><span class=w> </span><span class=s>"</span><span class=nv>$scheme://$host$request_uri</span><span class=w> </span><span class=nv>$do_not_cache"</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_cache</span><span class=w> </span><span class=s>cache</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_cache_valid</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=mi>302</span><span class=w> </span><span class=mi>60m</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_cache_valid</span><span class=w> </span><span class=mi>404</span><span class=w> </span><span class=mi>1m</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_pass</span><span class=w> </span><span class=s>https://apachesyslogtv</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=w>    </span><span class=kn>location</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>.(jpg|png|gif|jpeg|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)</span>$<span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kn>proxy_cache_valid</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=mi>120m</span><span class=p>;</span>
<span class=w>        </span><span class=kn>expires</span><span class=w> </span><span class=mi>604800</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_pass</span><span class=w> </span><span class=s>https://apachesyslogtv</span><span class=p>;</span>
<span class=w>        </span><span class=kn>proxy_cache</span><span class=w> </span><span class=s>cache</span><span class=p>;</span>
<span class=w>    </span><span class=p>}</span>

<span class=p>}</span>
</pre></div></div></section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'nginx, proxy_cache and reverse proxying explained & benchmarked'" href=https://kura.gg/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/ itemprop=url rel=bookmark> nginx, proxy_cache and reverse proxying explained <span class=amp>&</span> benchmarked </a><li><a title="Permalink to 'Apache 2, Nginx & WordPress MU - Follow up'" href=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/ itemprop=url rel=bookmark> Apache 2, Nginx <span class=amp>&</span> WordPress <span class=caps>MU</span> - Follow up </a><li><a title="Permalink to 'Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache'" href=https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/ itemprop=url rel=bookmark> Debian, Apache 2, Nginx, WordPress <span class=caps>MU</span> <span class=amp>&</span> <span class=caps>WP</span>-Super-Cache </a><li><a title="Permalink to 'New syslog.tv nginx wordpress site configuration explained'" href=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/ itemprop=url rel=bookmark> New syslog.tv nginx wordpress site configuration explained </a><li><a title="Permalink to 'WordPress + nginx + Varnish + Apache 2'" href=https://kura.gg/2010/09/26/nginx-varnish-apache2/ itemprop=url rel=bookmark> WordPress + nginx + Varnish + Apache 2 </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa></i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>🦣</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'More nginx proxy_cache optimizations and nginx load balancing' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing.rst id=view-source> <i class=material-icons></i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2010/02/16/howto-guest-virtual-machine-disk-extend-online-with-debian-ubuntu-lvm2-and-vmware-esx/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> Newer </a><div class=eevee-spacer></div><a class=eevee-nav__button href=https://kura.gg/2010/02/13/code_swarm-apache-python-and-postgresql-commit-visualization/ itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> </a></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa></i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>🦣</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>