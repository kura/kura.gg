<!DOCTYPE html><!--

                                      |
                                     /|
                                   ,' |
                                  .   |
                                    | |
                                 ' '| |
                                / / | |
       _,.-\"\"--._              / /  | |
     ,'          `.           j '   ' '
   ,'              `.         ||   / ,                         ___..--,
  /                  \\        ' `.'`.-.,-\".  .       _..---\"\"'' __, ,'
 /                    \\        \\` .\"`      `\"'\\   ,'\"_..--''\"\"\"'.'.'
.                      .      .'-'             \\,' ,'         ,','
|                      |      ,`               ' .`         .' /
|                      |     /          ,\"`.  ' `-. _____.-' .'
'                      |..---.|,\".      | | .  .-'\"\"   __.,-'
 .                   ,'       ||,|      |.' |    |\"\"`'\"
  `-._   `._.._____  |        || |      `._,'    |
      `.   .       `\".     ,'\"| \"  `'           ,+.
        \\  '         |    '   |   .....        .'  `.
         .'          '     7  \".              ,'     \\
                   ,'      |    `..        _,'      F
                  .        |,      `'----''         |
                  |      ,\"j  /                   | '
                  `     |  | .                 | `,'
                   .    |  `.|                 |/
                    `-..'   ,'                .'
                            | \\             ,''
                            |  `,'.      _,' /
                            |    | ^.  .'   /
                             `-'.' j` V    /
                                   |      /
                                   |     /
                                   |   ,'
                                    `\"\"

//--><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=1.0"><link rel=alternate href=https://kura.gg hreflang=en><link rel=dns-prefetch href=https://kura.gg><link href=https://kura.gg/feeds/rss.xml type=application/rss+xml rel=alternate title=kura.gg><link href=https://kura.gg/feeds/atom.xml type=application/atom+xml rel=alternate title=kura.gg><meta property=og:site_name content=kura.gg><meta property=og:type content=article><meta property=og:title content="New syslog.tv nginx wordpress site configuration explained"><meta content=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/ property=og:url><meta property=og:description content='Configuration changes I made some modifications to my nginx configuration this weekend to improve performance and clear up some bugs. upstream backend { server 127.0.0.1:81 fail_timeout=120s; } server { listen 80; server_name syslog.tv; access_log /var/log/nginx/access.syslog.tv.log; gzip on; gzip_disable msie6; gzip_static on; gzip_comp_level 9; gzip_proxied any; gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript; location / { root /var/www/syslog.tv; set $wordpress_logged_in ""; set $comment_author_email ""; set $comment_author ""; if ($http_cookie ~* "wordpress_logged_in_[^=]*=([^%]+)%7C") { set $wordpress_logged_in wordpress_logged_in_$1; } if ($http_cookie ~* "comment_author_email_[^=]*=([^;]+)(;|$)") { set $comment_author_email comment_author_email_$1; } if ($http_cookie ~* "comment_author_[^=]*=([^;]+)(;|$)") { set $comment_author comment_author_$1; } set $my_cache_key "$scheme://$host$uri$is_args$args$wordpress_logged_in$comment …'><meta property=og:image content=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/index.png><meta property=og:image:width content=1920><meta property=og:image:height content=1080><meta property=twitter:title content="New syslog.tv nginx wordpress site configuration explained"><meta content=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/ property=twitter:url><meta property=twitter:description content='Configuration changes I made some modifications to my nginx configuration this weekend to improve performance and clear up some bugs. upstream backend { server 127.0.0.1:81 fail_timeout=120s; } server { listen 80; server_name syslog.tv; access_log /var/log/nginx/access.syslog.tv.log; gzip on; gzip_disable msie6; gzip_static on; gzip_comp_level 9; gzip_proxied any; gzip_types text/plain text/css application/x-javascript text/xml application/xml application/xml+rss text/javascript; location / { root /var/www/syslog.tv; set $wordpress_logged_in ""; set $comment_author_email ""; set $comment_author ""; if ($http_cookie ~* "wordpress_logged_in_[^=]*=([^%]+)%7C") { set $wordpress_logged_in wordpress_logged_in_$1; } if ($http_cookie ~* "comment_author_email_[^=]*=([^;]+)(;|$)") { set $comment_author_email comment_author_email_$1; } if ($http_cookie ~* "comment_author_[^=]*=([^;]+)(;|$)") { set $comment_author comment_author_$1; } set $my_cache_key "$scheme://$host$uri$is_args$args$wordpress_logged_in$comment …'><meta property=twitter:image content=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/index.png><meta property=twitter:card content=summary_large_image><meta property=twitter:label1 content="Written by"><meta property=twitter:data1 content=Kura><meta property=twitter:label2 content="Estimated reading time"><meta property=twitter:data2 content="4 min read"><meta property=twitter:image:width content=1920><meta property=twitter:image:height content=1080><link rel=icon href=/favicon.png type=image/png sizes="16x16 32x32 48x48 64x64 128x128 256x256"><link rel=icon href=/favicon.ico type=image/vnd.microsoft.icon sizes="16x16 32x32 48x48 64x64 128x128 256x256"><title>New syslog.tv nginx wordpress site configuration explained</title></head> <body> <div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"> <header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader> <div class=mdl-layout__header-row> <div aria-expanded=false role=button tabindex=0 class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only"> <i class=material-icons>&#xE5D2;</i> </div> <span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top> <a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a> </h2> </span> <div class=mdl-layout-spacer role=presentation></div> <nav class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </nav> </div> </header> <div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true> <span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent"> kura.gg </h2> </span> <div class="mdl-navigation mdl-color--white"> <nav class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i class=material-icons aria-hidden=true> &#xE88A; </i> Home </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </nav> </div> </div> <div class="eevee-ribbon mdl-color--primary-dark" role=presentation> </div> <main class="eevee-main mdl-layout__content"> <div class="eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col" aria-label="Main content"> <article itemscope itemtype=http://schema.org/BlogPosting> <meta itemprop=accessibilityControl content=fullKeyboardControl> <meta itemprop=accessibilityControl content=fullMouseControl> <meta itemprop=accessibilityControl content=bookmarks> <meta itemprop=accessibilityControl content=captions> <meta itemprop=accessibilityControl content=alternativeText> <meta itemprop=accessibilityControl content=index> <meta itemprop=accessibilityControl content=readingOrder> <meta itemprop=accessibilityControl content=structuralNavigation> <meta itemprop=accessibilityControl content=tableOfContents> <meta itemprop=accessibilityHazard content=noFlashingHazard> <meta itemprop=accessibilityHazard content=noMotionSimulationHazard> <meta itemprop=accessibilityHazard content=noSoundHazard> <meta itemprop=accessibilityAPI content=ARIA> <div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation /> <a href=https://kura.gg/authors/kura/ class=hidden itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a> </div> <meta itemprop=keywords content=apache,cache,nginx,proxy,proxy_cache,wordpress> <meta itemprop=keywords content=tutorials> <div class=eevee-share> <ul class="social-share mdl-navigation"> <li class="social-share__link social-share__link--twitter"> <a href="https://twitter.com/intent/tweet?text=New%20syslog.tv%20nginx%20wordpress%20site%20configuration%20explained&url=https%3A//kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/" title="Share 'New syslog.tv nginx wordpress site configuration explained' on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;"> <i class=fa aria-hidden=true>&#xF099;</i> </a> </li> <li class="social-share__link social-share__link--facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/" title="Share 'New syslog.tv nginx wordpress site configuration explained' on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;"> <i class=fa aria-hidden=true>&#xF09A;</i> </a> </li> <li class="social-share__link social-share__link--email"> <a href="mailto:?subject=New%20syslog.tv%20nginx%20wordpress%20site%20configuration%20explained&body=I%20thought%20you%20might%20like%20'New%20syslog.tv%20nginx%20wordpress%20site%20configuration%20explained'%20--%20https%3A//kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/" title="Share 'New syslog.tv nginx wordpress site configuration explained' via email"> <i class=material-icons aria-hidden=true> &#xE0E1; </i> </a> </li> </ul> </div> <div class=eevee-article> <div class="eevee-meta mdl-color-text--grey-500"> <time datetime=2010-04-18T12:51:00+01:00 itemprop=datePublished> 18 Apr 2010 </time>&nbsp;-- 4 min read </div> <h1 itemprop=name> <a href=https://kura.gg/2010/04/18/new-syslog-tv-nginx-wordpress-site-configuration/ rel=bookmark title="Permalink to 'New syslog.tv nginx wordpress site configuration explained'" itemprop=url> New syslog.tv nginx wordpress site configuration&nbsp;explained </a> </h1> <section class=eevee-toc> <h2 id=toc> Contents </h2> <nav class=eevee-toc-ribbon> <div class=toc id> <p class=topic-title>Contents</p> <ul class=simple> <li><a class="reference internal" href=#configuration-changes id=toc-entry-1>Configuration changes</a></li> <li><a class="reference internal" href=#explanation id=toc-entry-2>Explanation</a><ul> <li><a class="reference internal" href=#upstream id=toc-entry-3>upstream</a></li> <li><a class="reference internal" href=#gzip id=toc-entry-4>gzip</a></li> <li><a class="reference internal" href=#location id=toc-entry-5>location</a></li> <li><a class="reference internal" href=#my-cache-key id=toc-entry-6>$my_cache_key</a></li> <li><a class="reference internal" href=#proxy-time id=toc-entry-7>Proxy time!</a></li> <li><a class="reference internal" href=#static-location-block id=toc-entry-8>Static location block</a></li> </ul> </li> <li><a class="reference internal" href=#in-layman-s-terms id=toc-entry-9>In layman’s terms</a></li> </ul> </div> </nav> </section> <section itemprop=articleBody class=article-content> <div class=section id=configuration-changes> <h2>Configuration changes</h2> <p>I made some modifications to my nginx configuration this weekend to improve performance and clear up some bugs.</p> <div class=highlight><pre><span></span><span class=k>upstream</span><span class=w> </span><span class=s>backend</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kn>server</span><span class=w> </span><span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>81</span><span class=w> </span><span class=s>fail_timeout=120s</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>server</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kn>listen</span><span class=w> </span><span class=mi>80</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kn>server_name</span><span class=w> </span><span class=s>syslog.tv</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=kn>access_log</span><span class=w> </span><span class=s>/var/log/nginx/access.syslog.tv.log</span><span class=p>;</span><span class=w></span>

<span class=w>    </span><span class=kn>gzip</span><span class=w> </span><span class=no>on</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kn>gzip_disable</span><span class=w> </span><span class=s>msie6</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kn>gzip_static</span><span class=w> </span><span class=no>on</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kn>gzip_comp_level</span><span class=w> </span><span class=mi>9</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kn>gzip_proxied</span><span class=w> </span><span class=s>any</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=kn>gzip_types</span><span class=w> </span><span class=s>text/plain</span><span class=w> </span><span class=s>text/css</span><span class=w> </span><span class=s>application/x-javascript</span><span class=w> </span><span class=s>text/xml</span><span class=w></span>
<span class=w>    </span><span class=s>application/xml</span><span class=w> </span><span class=s>application/xml+rss</span><span class=w> </span><span class=s>text/javascript</span><span class=p>;</span><span class=w></span>

<span class=w>   </span><span class=kn>location</span><span class=w> </span><span class=s>/</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kn>root</span><span class=w> </span><span class=s>/var/www/syslog.tv</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$wordpress_logged_in</span><span class=w> </span><span class=s>""</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$comment_author_email</span><span class=w> </span><span class=s>""</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$comment_author</span><span class=w> </span><span class=s>""</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>"wordpress_logged_in_[^=]*=([^%]+)%7C")</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>             </span><span class=kn>set</span><span class=w> </span><span class=nv>$wordpress_logged_in</span><span class=w> </span><span class=s>wordpress_logged_in_</span><span class=nv>$1</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>"comment_author_email_[^=]*=([^</span><span class=p>;</span><span class=kn>]+)(</span><span class=p>;</span><span class=kn>|$)")</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=kn>set</span><span class=w> </span><span class=nv>$comment_author_email</span><span class=w> </span><span class=s>comment_author_email_</span><span class=nv>$1</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=kn>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>"comment_author_[^=]*=([^</span><span class=p>;</span><span class=kn>]+)(</span><span class=p>;</span><span class=kn>|$)")</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>            </span><span class=kn>set</span><span class=w> </span><span class=nv>$comment_author</span><span class=w> </span><span class=s>comment_author_</span><span class=nv>$1</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=p>}</span><span class=w></span>

<span class=w>        </span><span class=kn>set</span><span class=w> </span><span class=nv>$my_cache_key</span><span class=w> </span><span class=s>"</span><span class=nv>$scheme://$host$uri$is_args$args$wordpress_logged_in$comment_author_email$comment_author"</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=kn>client_max_body_size</span><span class=w> </span><span class=mi>8m</span><span class=p>;</span><span class=w></span>

<span class=w>        </span><span class=kn>proxy_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>Host</span><span class=w> </span><span class=nv>$host</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Real-IP</span><span class=w> </span><span class=nv>$remote_addr</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_set_header</span><span class=w> </span><span class=s>X-Forwarded-For</span><span class=w> </span><span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_pass_header</span><span class=w> </span><span class=s>Set-Cookie</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_cache</span><span class=w> </span><span class=s>cache</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_cache_key</span><span class=w> </span><span class=nv>$my_cache_key</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_cache_valid</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=mi>302</span><span class=w> </span><span class=mi>60m</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_cache_valid</span><span class=w> </span><span class=mi>404</span><span class=w> </span><span class=mi>1m</span><span class=p>;</span><span class=w></span>
<span class=w>        </span><span class=kn>proxy_pass</span><span class=w> </span><span class=s>https://backend</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>

<span class=w>    </span><span class=kn>location</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>.(jpg|png|gif|jpeg|js|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)</span>$<span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>        </span><span class=kn>root</span><span class=w> </span><span class=s>/var/www/syslog.tv</span><span class=p>;</span><span class=w></span>
<span class=w>    </span><span class=p>}</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</pre></div> <p>Sadly Wordpress messes up the config when displayed like that so you can view the proper version <a class="reference external" href=/satic/files/syslog-nginx-config-18-apr-2010>here</a>.</p> </div> <div class=section id=explanation> <h2>Explanation</h2> <p>It’d be a good idea to actually explain what the configuration is doing and why it’s configured that way, I’ll do this “chunk-by-chunk”.</p> <div class=section id=upstream> <h3>upstream</h3> <div class=highlight><pre><span></span><span class=k>upstream</span><span class=w> </span><span class=s>backend</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kn>server</span><span class=w> </span><span class=n>127.0.0.1</span><span class=p>:</span><span class=mi>81</span><span class=w> </span><span class=s>fail_timeout=120s</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</pre></div> <p>This one is relatively simple, it basically configures an upstream proxy to 127.0.0.1 on port 81, fail_timeout controls how long nginx will try talking to that server before giving up.</p> <p>I’ll assume you understand the basic listen, server_name and access_log parameters in the first section of the server definition.</p> </div> <div class=section id=gzip> <h3>gzip</h3> <div class=highlight><pre><span></span><span class=k>gzip</span><span class=w> </span><span class=no>on</span><span class=p>;</span><span class=w></span>
<span class=k>gzip_disable</span><span class=w> </span><span class=s>msie6</span><span class=p>;</span><span class=w></span>
<span class=k>gzip_static</span><span class=w> </span><span class=no>on</span><span class=p>;</span><span class=w></span>
<span class=k>gzip_comp_level</span><span class=w> </span><span class=mi>9</span><span class=p>;</span><span class=w></span>
<span class=k>gzip_proxied</span><span class=w> </span><span class=s>any</span><span class=p>;</span><span class=w></span>
<span class=k>gzip_types</span><span class=w> </span><span class=s>text/plain</span><span class=w> </span><span class=s>text/css</span><span class=w> </span><span class=s>application/x-javascript</span><span class=w> </span><span class=s>text/xml</span><span class=w></span>
<span class=s>application/xml</span><span class=w> </span><span class=s>application/xml+rss</span><span class=w> </span><span class=s>text/javascript</span><span class=p>;</span><span class=w></span>
</pre></div> <p>Again, this one is rather simple. We enabled <span class=caps>GZIP</span>, disable it for anyone still using <span class=caps>IE6</span>, we explicitly enable <span class=caps>GZIP</span> compression of static files, set the compression level to 9 which is the highest level but also uses the most resource, tell <span class=caps>GZIP</span> to compress any proxied data and then set the mimetypes which <span class=caps>GZIP</span> is allowed to compress.</p> </div> <div class=section id=location> <h3>location</h3> <div class=highlight><pre><span></span><span class=k>root</span><span class=w> </span><span class=s>/var/www/syslog.tv</span><span class=p>;</span><span class=w></span>

<span class=k>set</span><span class=w> </span><span class=nv>$wordpress_logged_in</span><span class=w> </span><span class=s>""</span><span class=p>;</span><span class=w></span>
<span class=k>set</span><span class=w> </span><span class=nv>$comment_author_email</span><span class=w> </span><span class=s>""</span><span class=p>;</span><span class=w></span>
<span class=k>set</span><span class=w> </span><span class=nv>$comment_author</span><span class=w> </span><span class=s>""</span><span class=p>;</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>"wordpress_logged_in_[^=]*=([^%]+)%7C")</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kn>set</span><span class=w> </span><span class=nv>$wordpress_logged_in</span><span class=w> </span><span class=s>wordpress_logged_in_</span><span class=nv>$1</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>"comment_author_email_[^=]*=([^</span><span class=p>;</span><span class=k>]+)(</span><span class=p>;</span><span class=k>|$)")</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kn>set</span><span class=w> </span><span class=nv>$comment_author_email</span><span class=w> </span><span class=s>comment_author_email_</span><span class=nv>$1</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>

<span class=k>if</span><span class=w> </span><span class=s>(</span><span class=nv>$http_cookie</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>"comment_author_[^=]*=([^</span><span class=p>;</span><span class=k>]+)(</span><span class=p>;</span><span class=k>|$)")</span><span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kn>set</span><span class=w> </span><span class=nv>$comment_author</span><span class=w> </span><span class=s>comment_author_</span><span class=nv>$1</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</pre></div> <p>This is a rather large chunk but is very simple once you understand it. I’m setting up my document root, then setting some basic variables for “” so that I can overwrite them further down. This is actually by the following set of three if statements. I check for three different <span class=caps>HTTP</span> cookies and then set the relevant variable to the correct value if it exists, this is later used in the cache key to make sure each user has their own private cache if they have certain cookies.</p> </div> <div class=section id=my-cache-key> <h3>$my_cache_key</h3> <div class=highlight><pre><span></span><span class=k>set</span><span class=w> </span><span class=nv>$my_cache_key</span><span class=w> </span><span class=s>"</span><span class=nv>$scheme://$host$uri$is_args$args$wordpress_logged_in$comment_author_email$comment_author"</span><span class=p>;</span><span class=w></span>
</pre></div> <p>This sets up a variable called $my_cache_key which contains the current scheme (<span class=caps>HTTP</span> or <span class=caps>HTTPS</span>), host (syslog.tv), uri, various arguments and then finally sets the variables from the previous block from the cookie checks.</p> </div> <div class=section id=proxy-time> <h3>Proxy time!</h3> <div class=highlight><pre><span></span><span class=k>client_max_body_size</span><span class=w> </span><span class=mi>8m</span><span class=p>;</span><span class=w></span>

<span class=k>proxy_redirect</span><span class=w> </span><span class=no>off</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_set_header</span><span class=w> </span><span class=s>Host</span><span class=w> </span><span class=nv>$host</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_set_header</span><span class=w> </span><span class=s>X-Real-IP</span><span class=w> </span><span class=nv>$remote_addr</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_set_header</span><span class=w> </span><span class=s>X-Forwarded-For</span><span class=w> </span><span class=nv>$proxy_add_x_forwarded_for</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_pass_header</span><span class=w> </span><span class=s>Set-Cookie</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_cache</span><span class=w> </span><span class=s>cache</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_cache_key</span><span class=w> </span><span class=nv>$my_cache_key</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_cache_valid</span><span class=w> </span><span class=mi>200</span><span class=w> </span><span class=mi>302</span><span class=w> </span><span class=mi>60m</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_cache_valid</span><span class=w> </span><span class=mi>404</span><span class=w> </span><span class=mi>1m</span><span class=p>;</span><span class=w></span>
<span class=k>proxy_pass</span><span class=w> </span><span class=s>https://backend</span><span class=p>;</span><span class=w></span>
</pre></div> <p>Here I am setting the maximum size of the client body content to <span class=caps>8MB</span>, disabling proxy redirects, passing through some basic headers to the backend which allows my backend system to see which host the user is trying to access, their real <span class=caps>IP</span> address rather than the <span class=caps>IP</span> of the nginx server and x-Forwarded-For also contains the users <span class=caps>IP</span> address, it’s basically standard when proxying.</p> <p>Next I pass Set-Cookie headers back to the backend, tell it to use a cache definition called “cache” which I set up in a <a href=/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ class="reference external">previous blog post</a>. I set the proxy_cache_key to use the variable defined earlier contains all of the users cookie information in it’s key to make it a private cache.</p> <p>I then pass through some basic validation rules that set <span class=caps>HTTP</span> 200 and 302 responses to cache for 60 minutes and 404 responses to cache for 1 minute, then I simply pass back to the backend system.</p> </div> <div class=section id=static-location-block> <h3>Static location block</h3> <div class=highlight><pre><span></span><span class=k>location</span><span class=w> </span><span class=p>~</span><span class=sr>*</span><span class=w> </span><span class=s>.(jpg|png|gif|jpeg|js|css|mp3|wav|swf|mov|doc|pdf|xls|ppt|docx|pptx|xlsx)</span>$<span class=w> </span><span class=p>{</span><span class=w></span>
<span class=w>    </span><span class=kn>root</span><span class=w> </span><span class=s>/var/www/syslog.tv</span><span class=p>;</span><span class=w></span>
<span class=p>}</span><span class=w></span>
</pre></div> <p>This one could look a little scary but is actually really simple. I do a location check again some defined extensions, if it matches then it will simply serve these up from nginx rather than reverse proxy.</p> </div> </div> <div class=section id=in-layman-s-terms> <h2>In layman’s terms</h2> <p>Although possibly daunting it really is quite simple, I am configuring nginx to reverse proxy back to Apache on port 81, setting up some <span class=caps>GZIP</span> compression rules to decrease the size of static files, checking to see if a user has a WordPress cookie and giving them a private cache if they do, serving dynamic (<span class=caps>PHP</span>) content via the reverse proxy to Apache if no cache exists, serving cached content from nginx and also serving static content from nginx.</p> <p>This basically means that Apache is used very sparingly and nginx is doing what it does best, serving static/cached content.</p> </div> </section> </div> <div class=eevee-related> <section> <h2>Related articles</h2> <ul> <li> <a href=https://kura.gg/2010/02/14/more-nginx-proxy_cache-optimizations-and-nginx-load-balancing/ rel=bookmark title="Permalink to 'More nginx proxy_cache optimizations and nginx load balancing'" itemprop=url> More nginx proxy_cache optimizations and nginx load&nbsp;balancing </a> </li> <li> <a href=https://kura.gg/2010/02/07/nginx-proxy_cache-and-explained-benchmarked/ rel=bookmark title="Permalink to 'nginx, proxy_cache and reverse proxying explained & benchmarked'" itemprop=url> nginx, proxy_cache and reverse proxying explained <span class=amp>&amp;</span>&nbsp;benchmarked </a> </li> <li> <a href=https://kura.gg/2010/01/12/apache-2-nginx-wordpress-mu-follow-up/ rel=bookmark title="Permalink to 'Apache 2, Nginx & WordPress MU - Follow up'" itemprop=url> Apache 2, Nginx <span class=amp>&amp;</span> WordPress <span class=caps>MU</span> - Follow&nbsp;up </a> </li> <li> <a href=https://kura.gg/2010/01/11/debian-apache-2-nginx-wordpress-mu/ rel=bookmark title="Permalink to 'Debian, Apache 2, Nginx, WordPress MU & WP-Super-Cache'" itemprop=url> Debian, Apache 2, Nginx, WordPress <span class=caps>MU</span> <span class=amp>&amp;</span> <span class=caps>WP</span>-Super-Cache </a> </li> <li> <a href=https://kura.gg/2010/09/26/nginx-varnish-apache2/ rel=bookmark title="Permalink to 'WordPress + nginx + Varnish + Apache 2'" itemprop=url> WordPress + nginx + Varnish + Apache&nbsp;2 </a> </li> </ul> </section> </div> <div class=eevee-ac> <header class=eevee-ac__header> <div class=eevee-ac-author__text> <h2>Kura</h2> <p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.</p> <p> <a href=https://kura.gg/authors/kura/ itemprop=url title="Read more articles by Kura"> Read more articles by Kura </a> </p> <nav> <ul class=eevee-ac-author__social> <li class=eevee-ac-author-social__link> <a class="mdl-color-text--accent mdl-navigation__link" href=https://github.com/kura itemprop=url rel=bookmark title="kura on GitHub"> <i class=fa aria-hidden=true>&#xF09B;</i> </a> </li> </ul> </nav> </div> <img src=/images/avatar-glitch.png class=eevee-ac-author__avatar alt=Kura> </header> </div> </article> <a href=https://github.com/kura/kura.gg/blob/main/content/new-syslog-tv-nginx-wordpress-site-configuration.rst id=view-source title="View 'New syslog.tv nginx wordpress site configuration explained' on GitHub" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white"> <i class=material-icons>&#xE86F;</i> View Source </a> </div> </div> </main> <div class="eevee-pagination__container eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"> <nav class="eevee-pagination mdl-cell mdl-cell--12-col" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label=Pagination> <a href=https://kura.gg/2010/07/02/using-dpkg-selections-to-backup-and-install-packages/ class=eevee-nav__button itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C4;</i> </button> Newer </a> <div class=eevee-spacer></div> <a href=https://kura.gg/2010/04/13/convert-pem-key-to-a-single-pkcs12-file/ class=eevee-nav__button itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C8;</i> </button> </a> </nav> </div> </div> <footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement> <div class=mdl-mega-footer--top-section> <div class=mdl-mega-footer--drop-down-section> <ul class=mdl-mega-footer--link-list> <li> <a href=#top itemprop=url title="Back to the top of the page"> Back to the top of the page </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Footer navigation"> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Menu</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> </li> <li> <a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> </li> <li> <a href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Social</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i class=fa aria-hidden=true>&#xF09B;</i> Github </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Links</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> </li> <li> <a href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> </li> <li> <a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> </li> <li> <a href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--bottom-section> <div class=mdl-logo> <a href=https://kura.gg rel=bookmark itemprop=url title=kura.gg> kura.gg </a> </div> <ul class="eevee-footer mdl-mega-footer--link-list"> <li>Powered by love &amp; rainbow sparkles.</li> <li>Source code and content released under the <a href=/license/ title="MIT license">MIT license</a>.</li> </ul> </div> </footer> </div> <link rel=stylesheet href=https://kura.gg/theme/css/eevee.min.css?1c9d8344> <script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script> </body> </html>