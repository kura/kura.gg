<!DOCTYPE html><!--

                                      |
                                     /|
                                   ,' |
                                  .   |
                                    | |
                                 ' '| |
                                / / | |
       _,.-\"\"--._              / /  | |
     ,'          `.           j '   ' '
   ,'              `.         ||   / ,                         ___..--,
  /                  \\        ' `.'`.-.,-\".  .       _..---\"\"'' __, ,'
 /                    \\        \\` .\"`      `\"'\\   ,'\"_..--''\"\"\"'.'.'
.                      .      .'-'             \\,' ,'         ,','
|                      |      ,`               ' .`         .' /
|                      |     /          ,\"`.  ' `-. _____.-' .'
'                      |..---.|,\".      | | .  .-'\"\"   __.,-'
 .                   ,'       ||,|      |.' |    |\"\"`'\"
  `-._   `._.._____  |        || |      `._,'    |
      `.   .       `\".     ,'\"| \"  `'           ,+.
        \\  '         |    '   |   .....        .'  `.
         .'          '     7  \".              ,'     \\
                   ,'      |    `..        _,'      F
                  .        |,      `'----''         |
                  |      ,\"j  /                   | '
                  `     |  | .                 | `,'
                   .    |  `.|                 |/
                    `-..'   ,'                .'
                            | \\             ,''
                            |  `,'.      _,' /
                            |    | ^.  .'   /
                             `-'.' j` V    /
                                   |      /
                                   |     /
                                   |   ,'
                                    `\"\"

//--><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=1.0"><link rel=alternate href=https://kura.gg hreflang=en><link rel=dns-prefetch href=https://kura.gg><link rel=dns-prefetch href=//disqus.com><link rel=dns-prefetch href=//a.disquscdn.com><link rel=dns-prefetch href=//syslogtv.disqus.com><link rel=dns-prefetch href=//glitter-services.disqus.com><link href=https://kura.gg/feeds/rss.xml type=application/rss+xml rel=alternate title=kura.gg><link href=https://kura.gg/feeds/atom.xml type=application/atom+xml rel=alternate title=kura.gg><meta property=og:site_name content=kura.gg><meta property=og:type content=article><meta property=og:title content="Configuring upstreams dynamically with DNS in OpenResty"><meta content=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ property=og:url><meta property=og:description content='This article is a continuation of retrying dynamically configured upstreams that gives an example of how you can configure OpenResty to update your upstream backend servers dynamically with DNS. Breaking down init_worker_by_lua_block init_worker_by_lua_block can be used to make an nginx worker do some fun stuff. In this instance we’re going to use it in conjunction with ngx.timer.every and the resty.dns.resolver. Here is the full example of my init_worker_by_lua_block. init_worker_by_lua_block { _backend_servers = {} local function update_dns() -- Set up the resolver local resolver = require "resty.dns.resolver" local r, err = resolver:new{ nameservers = {"1.1.1.1", {"1.0.0.1", 53} }, -- Cloudflare retrans = 5, -- 5 retransmissions on receive timeout timeout = 1000, -- 1 sec } if not r then ngx.log(ngx.ERR, "failed to instantiate resolver: ", err) return end -- Pull DNS …'><meta property=og:image content=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/index.png><meta property=og:image:width content=1920><meta property=og:image:height content=1080><meta property=twitter:site content=@kuramanga><meta property=twitter:title content="Configuring upstreams dynamically with DNS in OpenResty"><meta content=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ property=twitter:url><meta property=twitter:description content='This article is a continuation of retrying dynamically configured upstreams that gives an example of how you can configure OpenResty to update your upstream backend servers dynamically with DNS. Breaking down init_worker_by_lua_block init_worker_by_lua_block can be used to make an nginx worker do some fun stuff. In this instance we’re going to use it in conjunction with ngx.timer.every and the resty.dns.resolver. Here is the full example of my init_worker_by_lua_block. init_worker_by_lua_block { _backend_servers = {} local function update_dns() -- Set up the resolver local resolver = require "resty.dns.resolver" local r, err = resolver:new{ nameservers = {"1.1.1.1", {"1.0.0.1", 53} }, -- Cloudflare retrans = 5, -- 5 retransmissions on receive timeout timeout = 1000, -- 1 sec } if not r then ngx.log(ngx.ERR, "failed to instantiate resolver: ", err) return end -- Pull DNS …'><meta property=twitter:image content=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/index.png><meta property=twitter:card content=summary_large_image><meta property=twitter:image:width content=1920><meta property=twitter:image:height content=1080><link rel=icon href=/favicon.png type=image/png sizes="16x16 32x32 48x48 64x64 128x128 256x256"><link rel=icon href=/favicon.ico type=image/vnd.microsoft.icon sizes="16x16 32x32 48x48 64x64 128x128 256x256"><title>Configuring upstreams dynamically with DNS in OpenResty</title></head> <body> <div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"> <header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader> <div class=mdl-layout__header-row> <div aria-expanded=false role=button tabindex=0 class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only"> <i class=material-icons>&#xE5D2;</i> </div> <span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top> <a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a> </h2> </span> <div class=mdl-layout-spacer role=presentation></div> <nav class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee/ itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/software/ itemprop=url rel=bookmark title=Software> <i class=material-icons aria-hidden=true>&#xE86F;</i> Software </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </nav> </div> </header> <div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true> <span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent"> kura.gg </h2> </span> <div class="mdl-navigation mdl-color--white"> <nav class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i class=material-icons aria-hidden=true> &#xE88A; </i> Home </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee/ itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/software/ itemprop=url rel=bookmark title=Software> <i class=material-icons aria-hidden=true>&#xE86F;</i> Software </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </nav> </div> </div> <div class="eevee-ribbon mdl-color--primary-dark" role=presentation> </div> <main class="eevee-main mdl-layout__content"> <div class="eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col" aria-label="Main content"> <article itemscope itemtype=http://schema.org/BlogPosting> <meta itemprop=accessibilityControl content=fullKeyboardControl> <meta itemprop=accessibilityControl content=fullMouseControl> <meta itemprop=accessibilityControl content=bookmarks> <meta itemprop=accessibilityControl content=captions> <meta itemprop=accessibilityControl content=alternativeText> <meta itemprop=accessibilityControl content=index> <meta itemprop=accessibilityControl content=readingOrder> <meta itemprop=accessibilityControl content=structuralNavigation> <meta itemprop=accessibilityControl content=tableOfContents> <meta itemprop=accessibilityHazard content=noFlashingHazard> <meta itemprop=accessibilityHazard content=noMotionSimulationHazard> <meta itemprop=accessibilityHazard content=noSoundHazard> <meta itemprop=accessibilityAPI content=ARIA> <div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation /> <a href=https://kura.gg/authors/kura/ class=hidden itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a> </div> <meta itemprop=keywords content=nginx,openresty,lua> <meta itemprop=keywords content=misc> <div class=eevee-share> <ul class="social-share mdl-navigation"> <li class="social-share__link social-share__link--twitter"> <a href="https://twitter.com/intent/tweet?text=Configuring%20upstreams%20dynamically%20with%20DNS%20in%20OpenResty&url=https%3A//kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/&related=kuramanga" title="Share 'Configuring upstreams dynamically with DNS in OpenResty' on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;"> <i class=fa aria-hidden=true>&#xF099;</i> </a> </li> <li class="social-share__link social-share__link--facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/" title="Share 'Configuring upstreams dynamically with DNS in OpenResty' on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;"> <i class=fa aria-hidden=true>&#xF09A;</i> </a> </li> <li class="social-share__link social-share__link--email"> <a href="mailto:?subject=Configuring%20upstreams%20dynamically%20with%20DNS%20in%20OpenResty&body=I%20thought%20you%20might%20like%20'Configuring%20upstreams%20dynamically%20with%20DNS%20in%20OpenResty'%20--%20https%3A//kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/" title="Share 'Configuring upstreams dynamically with DNS in OpenResty' via email"> <i class=material-icons aria-hidden=true> &#xE0E1; </i> </a> </li> <li class="social-share__link social-share__link--comment"> <a href=#article-comments title="Discuss 'Configuring upstreams dynamically with DNS in OpenResty'"> <i class=material-icons aria-hidden=true> &#xE0B9; </i> </a> </li> </ul> </div> <div class=eevee-article> <div class="eevee-meta mdl-color-text--grey-500"> <time datetime=2020-08-30T17:30:00+01:00 itemprop=datePublished> 30 Aug 2020 </time>&nbsp;-- 10 min read </div> <h1 itemprop=name> <a href=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ rel=bookmark title="Permalink to 'Configuring upstreams dynamically with DNS in OpenResty'" itemprop=url> Configuring upstreams dynamically with <span class=caps>DNS</span> in&nbsp;OpenResty </a> </h1> <section> <p> This article is part of the <span class=bold>OpenResty upstreams</span> series. </p> <ol class=series-parts> <li> <a href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ title="Retrying dynamically configured upstreams with OpenResty" itemprop=url> Retrying dynamically configured upstreams with OpenResty </a> </li> <li class=series-active> <a href=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ title="Configuring upstreams dynamically with DNS in OpenResty" itemprop=url> Configuring upstreams dynamically with DNS in OpenResty </a> </li> </ol> </section> <section class=eevee-toc> <h2 id=toc> Contents </h2> <nav class=eevee-toc-ribbon> <div class=toc id> <p class=topic-title>Contents</p> <ul class=simple> <li><a class="reference internal" href=#breaking-down-init-worker-by-lua-block id=id2>Breaking down <cite>init_worker_by_lua_block</cite></a><ul> <li><a class="reference internal" href=#configuring-the-dns-resolver id=id3>Configuring the <span class=caps>DNS</span> resolver</a></li> <li><a class="reference internal" href=#querying-the-dns-resolver id=id4>Querying the <span class=caps>DNS</span> resolver</a></li> <li><a class="reference internal" href=#using-the-returned-dns-records-to-configure-the-backend id=id5>Using the returned <span class=caps>DNS</span> records to configure the backend</a></li> <li><a class="reference internal" href=#set-up-a-timer-to-update-the-backend-servers-periodically id=id6>Set up a timer to update the backend servers periodically</a></li> </ul> </li> <li><a class="reference internal" href=#breaking-down-balancer-by-lua-block id=id7>Breaking down <cite>balancer_by_lua_block</cite></a><ul> <li><a class="reference internal" href=#setting-up-balancer-by-lua id=id8>Setting up balancer_by_lua</a></li> <li><a class="reference internal" href=#handling-an-initial-request id=id9>Handling an initial request</a></li> <li><a class="reference internal" href=#handling-a-retry-request id=id10>Handling a retry request</a></li> <li><a class="reference internal" href=#passing-the-request-back-to-nginx id=id11>Passing the request back to nginx</a></li> </ul> </li> <li><a class="reference internal" href=#putting-it-all-together id=id12>Putting it all together</a></li> <li><a class="reference internal" href=#full-example-on-github id=id13>Full example on GitHub</a></li> </ul> </div> </nav> </section> <section itemprop=articleBody class=article-content> <p>This article is a continuation of <a href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ class="reference external">retrying dynamically configured upstreams</a> that gives an example of how you can configure OpenResty to update your upstream backend servers dynamically with <span class=caps>DNS</span>.</p> <div class=section id=breaking-down-init-worker-by-lua-block> <h2>Breaking down <cite>init_worker_by_lua_block</cite></h2> <p><cite>init_worker_by_lua_block</cite> can be used to make an nginx worker do some fun stuff. In this instance we’re going to use it in conjunction with <cite>ngx.timer.every</cite> and the <cite>resty.dns.resolver</cite>.</p> <p>Here is the full example of my <cite>init_worker_by_lua_block</cite>.</p> <pre class="code lua literal-block">
<span class=n>init_worker_by_lua_block</span> <span class=p>{</span>
    <span class=n>_backend_servers</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=kd>local</span> <span class=kr>function</span> <span class=nf>update_dns</span><span class=p>()</span>
        <span class=c1>-- Set up the resolver</span>
        <span class=kd>local</span> <span class=n>resolver</span> <span class=o>=</span> <span class=nb>require</span> <span class=s2>"resty.dns.resolver"</span>
        <span class=kd>local</span> <span class=n>r</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>resolver</span><span class=p>:</span><span class=n>new</span><span class=p>{</span>
            <span class=n>nameservers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>"1.1.1.1"</span><span class=p>,</span> <span class=p>{</span><span class=s2>"1.0.0.1"</span><span class=p>,</span> <span class=mi>53</span><span class=p>}</span> <span class=p>},</span>  <span class=c1>-- Cloudflare</span>
            <span class=n>retrans</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>  <span class=c1>-- 5 retransmissions on receive timeout</span>
            <span class=n>timeout</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>,</span>  <span class=c1>-- 1 sec</span>
        <span class=p>}</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>r</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"failed to instantiate resolver: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
            <span class=kr>return</span>
        <span class=kr>end</span>

        <span class=c1>-- Pull DNS records</span>
        <span class=c1>-- Use a hardcoded domain to make this example easier</span>
        <span class=kd>local</span> <span class=n>answers</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=n>tries</span> <span class=o>=</span> <span class=n>r</span><span class=p>:</span><span class=n>query</span><span class=p>(</span><span class=s2>"kura.gg"</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=p>{})</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>answers</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"failed to query resolved: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
            <span class=kr>return</span>
        <span class=kr>end</span>
        <span class=kr>if</span> <span class=n>answers</span><span class=p>.</span><span class=n>errcode</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"server returned error code: "</span><span class=p>,</span> <span class=n>answers</span><span class=p>.</span><span class=n>errcode</span><span class=p>,</span>
                    <span class=s2>": "</span><span class=p>,</span> <span class=n>answers</span><span class=p>.</span><span class=n>errstr</span><span class=p>)</span>
            <span class=c1>-- Have a return here so that the old servers remain even if</span>
            <span class=c1>-- this lookup fails.</span>
            <span class=kr>return</span>
        <span class=kr>end</span>

        <span class=c1>-- Dump records in a global variable</span>
        <span class=c1>-- Note I am only pulling out addresses not CNAMEs</span>
        <span class=n>_new_backend_servers</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ans</span> <span class=kr>in</span> <span class=nb>ipairs</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span> <span class=kr>do</span>
            <span class=nb>table.insert</span><span class=p>(</span><span class=n>_new_backend_servers</span><span class=p>,</span> <span class=n>ans</span><span class=p>.</span><span class=n>address</span><span class=p>)</span>
        <span class=kr>end</span>
        <span class=n>_backend_servers</span> <span class=o>=</span> <span class=n>_new_backend_servers</span>
    <span class=kr>end</span>

    <span class=c1>-- Run an at timer to force update_dns to trigger on worker init</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>timer</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>update_dns</span><span class=p>)</span>
    <span class=c1>-- Set a timer to run every 10 seconds</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>timer</span><span class=p>.</span><span class=n>every</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>update_dns</span><span class=p>)</span>
<span class=p>}</span>
</pre> <div class=section id=configuring-the-dns-resolver> <h3>Configuring the <span class=caps>DNS</span> resolver</h3> <p>Let’s break this block down in to easier to understand blocks.</p> <pre class="code lua literal-block">
<span class=n>_backend_servers</span> <span class=o>=</span> <span class=p>{}</span>
</pre> <p>Here we define an empty backend servers table that’ll be modified by modified by <span class=caps>DNS</span> resolver and is used by the balancer module for direction clients.</p> <pre class="code lua literal-block">
<span class=kd>local</span> <span class=kr>function</span> <span class=nf>update_dns</span><span class=p>()</span>
    <span class=c1>-- Set up the resolver</span>
    <span class=kd>local</span> <span class=n>resolver</span> <span class=o>=</span> <span class=nb>require</span> <span class=s2>"resty.dns.resolver"</span>
    <span class=kd>local</span> <span class=n>r</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>resolver</span><span class=p>:</span><span class=n>new</span><span class=p>{</span>
        <span class=n>nameservers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>"1.1.1.1"</span><span class=p>,</span> <span class=p>{</span><span class=s2>"1.0.0.1"</span><span class=p>,</span> <span class=mi>53</span><span class=p>}</span> <span class=p>},</span>  <span class=c1>-- Cloudflare</span>
        <span class=n>retrans</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>  <span class=c1>-- 5 retransmissions on receive timeout</span>
        <span class=n>timeout</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>,</span>  <span class=c1>-- 1 sec</span>
    <span class=p>}</span>
</pre> <p>Here we’re defining the <cite>update_dns</cite> function and within that setting up a <span class=caps>DNS</span> resolver using the <cite>resty.dns.resolver</cite> module. I’m using Cloudflare’s <span class=caps>DNS</span> servers in this example with 5 retransmissions and a timeout of 1 second.</p> <pre class="code lua literal-block">
<span class=kr>if</span> <span class=ow>not</span> <span class=n>r</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"failed to instantiate resolver: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
    <span class=kr>return</span>
<span class=kr>end</span>
</pre> <p>If instantiating the resolver fails, the function will return, leaving the backend server table unmodified. If this happens randomly during operation then the old server table will remain in use. If it fails during start up, the backend server table will be empty and cause <cite><span class=caps>HTTP</span> 500</cite> errors to be thrown (this is set up later.)</p> </div> <div class=section id=querying-the-dns-resolver> <h3>Querying the <span class=caps>DNS</span> resolver</h3> <pre class="code lua literal-block">
<span class=c1>-- Pull DNS records</span>
<span class=c1>-- Use a hardcoded domain to make this example easier</span>
<span class=kd>local</span> <span class=n>answers</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=n>tries</span> <span class=o>=</span> <span class=n>r</span><span class=p>:</span><span class=n>query</span><span class=p>(</span><span class=s2>"kura.gg"</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=p>{})</span>
<span class=kr>if</span> <span class=ow>not</span> <span class=n>answers</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"failed to query resolved: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
    <span class=kr>return</span>
<span class=kr>end</span>
</pre> <p>Here we query the <span class=caps>DNS</span> server for records, I’m using my own domain <cite>kura.gg</cite> in this example.</p> <pre class="code lua literal-block">
<span class=kr>if</span> <span class=n>answers</span><span class=p>.</span><span class=n>errcode</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"server returned error code: "</span><span class=p>,</span> <span class=n>answers</span><span class=p>.</span><span class=n>errcode</span><span class=p>,</span>
            <span class=s2>": "</span><span class=p>,</span> <span class=n>answers</span><span class=p>.</span><span class=n>errstr</span><span class=p>)</span>
    <span class=c1>-- Have a return here so that the old servers remain even if</span>
    <span class=c1>-- this lookup fails.</span>
    <span class=kr>return</span>
<span class=kr>end</span>
</pre> <p>If querying the records fails or if no records are found the function will return and leave the backend server table unmodified, allowing clients to attempt to use the old servers if they’re still alive.</p> </div> <div class=section id=using-the-returned-dns-records-to-configure-the-backend> <h3>Using the returned <span class=caps>DNS</span> records to configure the backend</h3> <pre class="code lua literal-block">
    <span class=c1>-- Dump records in a global variable</span>
    <span class=c1>-- Note I am only pulling out addresses not CNAMEs</span>
    <span class=n>_new_backend_servers</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ans</span> <span class=kr>in</span> <span class=nb>ipairs</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span> <span class=kr>do</span>
        <span class=nb>table.insert</span><span class=p>(</span><span class=n>_new_backend_servers</span><span class=p>,</span> <span class=n>ans</span><span class=p>.</span><span class=n>address</span><span class=p>)</span>
    <span class=kr>end</span>
    <span class=n>_backend_servers</span> <span class=o>=</span> <span class=n>_new_backend_servers</span>
<span class=kr>end</span>
</pre> <p>Finally we reach this block if no errors have occured. This will create a new table of backend servers from the <span class=caps>DNS</span> records queried and replace the old table with the new one.</p> <p>It’s worth noting that this code will only store records that have an <cite>A</cite> or <cite><span class=caps>AAAA</span></cite> record, not <cite><span class=caps>CNAMES</span></cite> etc. Although it’s easy enough to modify it to change this behaviour.</p> </div> <div class=section id=set-up-a-timer-to-update-the-backend-servers-periodically> <h3>Set up a timer to update the backend servers periodically</h3> <pre class="code lua literal-block">
<span class=c1>-- Run an at timer to force update_dns to trigger on worker init</span>
<span class=n>ngx</span><span class=p>.</span><span class=n>timer</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>update_dns</span><span class=p>)</span>
<span class=c1>-- Set a timer to run every 10 seconds</span>
<span class=n>ngx</span><span class=p>.</span><span class=n>timer</span><span class=p>.</span><span class=n>every</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>update_dns</span><span class=p>)</span>
</pre> <p>Here we’re setting up 2 timers. The first is an <cite>ngx.timer.at</cite> timer that tiggers when a worker is started to attempt to set up the backend server table on worker init.</p> <p>The second is an <cite>ngx.timer.every</cite> timer that runs in the worker every 10 seconds.</p> <p>Each worker will do this and have it’s own copy of the backend servers table.</p> </div> </div> <div class=section id=breaking-down-balancer-by-lua-block> <h2>Breaking down <cite>balancer_by_lua_block</cite></h2> <p>Just like in the <a href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ class="reference external">retrying dynamically configured upstreams</a> article we’ll use OpenResty’s <cite>balancer_by_lua_block</cite> to allow the balancer to use these records.</p> <pre class="code lua literal-block">
<span class=n>balancer_by_lua_block</span> <span class=p>{</span>
    <span class=kd>local</span> <span class=n>balancer</span> <span class=o>=</span> <span class=nb>require</span><span class=p>(</span><span class=s2>"ngx.balancer"</span><span class=p>)</span>

    <span class=kr>if</span> <span class=o>#</span><span class=n>_backend_servers</span> <span class=o>==</span> <span class=mi>0</span> <span class=kr>then</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"no backend servers available"</span><span class=p>)</span>
        <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>

    <span class=c1>-- This block will only trigger if ngx.ctx.retry is not true.</span>
    <span class=c1>-- We set this to true during the initial request so future</span>
    <span class=c1>-- requests within this context will not go down this path.</span>
    <span class=kr>if</span> <span class=ow>not</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=kr>then</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=o>=</span> <span class=kc>true</span>
        <span class=c1>-- Pick a random backend to start with</span>
        <span class=n>server</span> <span class=o>=</span> <span class=n>_backend_servers</span><span class=p>[</span><span class=nb>math.random</span><span class=p>(</span><span class=o>#</span><span class=n>_backend_servers</span><span class=p>)]</span>

        <span class=c1>-- Kinda messy but, create a context table we dump tried</span>
        <span class=c1>-- backends to.</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>server</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span>

        <span class=c1>-- set up more tries using the length of the server list minus 1.</span>
        <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_more_tries</span><span class=p>(</span><span class=o>#</span><span class=n>_backend_servers</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_more_tries failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
        <span class=kr>end</span>

    <span class=kr>else</span>
        <span class=c1>-- This block will trigger on a retry</span>
        <span class=c1>-- Here we'll run through the backends and pick one we haven't</span>
        <span class=c1>-- tried yet.</span>
        <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ip</span> <span class=kr>in</span> <span class=nb>ipairs</span><span class=p>(</span><span class=n>_backend_servers</span><span class=p>)</span> <span class=kr>do</span>
            <span class=n>in_ctx</span> <span class=o>=</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>~=</span> <span class=kc>nil</span>
            <span class=kr>if</span> <span class=n>in_ctx</span> <span class=o>==</span> <span class=kc>false</span> <span class=kr>then</span>
                <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span>
                <span class=n>server</span> <span class=o>=</span> <span class=n>ip</span>
                <span class=kr>break</span>
            <span class=kr>end</span>
        <span class=kr>end</span>
    <span class=kr>end</span>

    <span class=c1>-- Hardcoded port again to make example easier</span>
    <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_current_peer</span><span class=p>(</span><span class=n>server</span><span class=p>,</span> <span class=mi>443</span><span class=p>)</span>
    <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_current_peer failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
        <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
    <span class=kr>end</span>
<span class=p>}</span>
</pre> <p>As with the <cite>init_worker_by_lua_block</cite> I’ll break the <cite>balancer_by_lua_block</cite> block down in more manageable chunks.</p> <div class=section id=setting-up-balancer-by-lua> <h3>Setting up balancer_by_lua</h3> <pre class="code lua literal-block">
<span class=kd>local</span> <span class=n>balancer</span> <span class=o>=</span> <span class=nb>require</span><span class=p>(</span><span class=s2>"ngx.balancer"</span><span class=p>)</span>

<span class=kr>if</span> <span class=o>#</span><span class=n>_backend_servers</span> <span class=o>==</span> <span class=mi>0</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"no backend servers available"</span><span class=p>)</span>
    <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
<span class=kr>end</span>
</pre> <p>First thing we do is include the <cite>ngx.balancer</cite> module, then we check to see if the backend servers table has any records. If not all we can do is write an error message to log and send the client an <cite><span class=caps>HTTP</span> 500</cite> because we have no backends available.</p> </div> <div class=section id=handling-an-initial-request> <h3>Handling an initial request</h3> <pre class="code lua literal-block">
<span class=c1>-- This block will only trigger if ngx.ctx.retry is not true or is</span>
<span class=c1>-- unset.</span>
<span class=c1>-- We set this to true during the initial request so future</span>
<span class=c1>-- requests within this context will not go down this path.</span>
<span class=kr>if</span> <span class=ow>not</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=o>=</span> <span class=kc>true</span>
    <span class=c1>-- Pick a random backend to start with</span>
    <span class=n>server</span> <span class=o>=</span> <span class=n>_backend_servers</span><span class=p>[</span><span class=nb>math.random</span><span class=p>(</span><span class=o>#</span><span class=n>_backend_servers</span><span class=p>)]</span>

    <span class=c1>-- Kinda messy but, create a context table we dump tried</span>
    <span class=c1>-- backends to.</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>server</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span>

    <span class=c1>-- set up more tries using the length of the server list minus 1.</span>
    <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_more_tries</span><span class=p>(</span><span class=o>#</span><span class=n>_backend_servers</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
    <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_more_tries failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
    <span class=kr>end</span>
</pre> <p>Here we set up what happens when <cite>ngx.ctx.retry</cite> is undefined or false, which will happen on first request for a client.</p> <p>Within this block we pick a random backend, set up a table of addresses already tried so if a retry is necessary it won’t use the same host.</p> <p>Then we set the number of retries to attempt as the length of the server table minus one.</p> </div> <div class=section id=handling-a-retry-request> <h3>Handling a retry request</h3> <pre class="code lua literal-block">
<span class=kr>else</span>
    <span class=c1>-- This block will trigger on a retry</span>
    <span class=c1>-- Here we'll run through the backends and pick one we haven't</span>
    <span class=c1>-- tried yet.</span>
    <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ip</span> <span class=kr>in</span> <span class=nb>ipairs</span><span class=p>(</span><span class=n>_backend_servers</span><span class=p>)</span> <span class=kr>do</span>
        <span class=n>in_ctx</span> <span class=o>=</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>~=</span> <span class=kc>nil</span>
        <span class=kr>if</span> <span class=n>in_ctx</span> <span class=o>==</span> <span class=kc>false</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span>
            <span class=n>server</span> <span class=o>=</span> <span class=n>ip</span>
            <span class=kr>break</span>
        <span class=kr>end</span>
    <span class=kr>end</span>
<span class=kr>end</span>
</pre> <p>This block is what will be called if the request is a retry. In it we simply iterate through the backend server table looking for a backend we haven’t tried yet. Once we find one we add it to the list of servers tried and break the loop to send the client to that server.</p> </div> <div class=section id=passing-the-request-back-to-nginx> <h3>Passing the request back to nginx</h3> <pre class="code lua literal-block">
<span class=c1>-- Hardcoded port again to make example easier</span>
<span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_current_peer</span><span class=p>(</span><span class=n>server</span><span class=p>,</span> <span class=mi>443</span><span class=p>)</span>
<span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_current_peer failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
    <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
<span class=kr>end</span>
</pre> <p>This final block is where nginx is told which backend to send the client to.</p> </div> </div> <div class=section id=putting-it-all-together> <h2>Putting it all together</h2> <p>Below is the full example written as a single <cite>nginx.conf</cite>. Sadly syntax highlighters have issues with nginx and Lua in a single file.</p> <pre class="code nginx literal-block">
<span class=c1># set 2 worker processes to show the timer spawning on each one
</span><span class=k>worker_processes</span> <span class=mi>2</span><span class=p>;</span>

<span class=k>events</span> <span class=p>{</span>
    <span class=kn>worker_connections</span> <span class=mi>1024</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>http</span> <span class=p>{</span>

    <span class=c1># Do this for each worker so each worker has it's own copy of the DNS
</span>    <span class=c1># records.
</span>    <span class=kn>init_worker_by_lua_block</span> <span class=p>{</span>
        <span class=kn>_backend_servers</span> <span class=p>=</span> <span class=p>{}</span>

        <span class=kn>local</span> <span class=s>function</span> <span class=s>update_dns()</span>
            <span class=s>--</span> <span class=s>Set</span> <span class=s>up</span> <span class=s>the</span> <span class=s>resolver</span>
            <span class=s>local</span> <span class=s>resolver</span> <span class=p>=</span> <span class=s>require</span> <span class=s>"resty.dns.resolver"</span>
            <span class=s>local</span> <span class=s>r,</span> <span class=s>err</span> <span class=p>=</span> <span class=s>resolver:new</span><span class=p>{</span>
                <span class=kn>nameservers</span> <span class=p>=</span> <span class=p>{</span><span class=kn>"1.1.1.1",</span> <span class=p>{</span><span class=kn>"1.0.0.1",</span> <span class=mi>53</span><span class=err>}</span> <span class=err>}</span><span class=s>,</span>  <span class=s>--</span> <span class=s>Cloudflare</span>
                <span class=s>retrans</span> <span class=p>=</span> <span class=mi>5</span><span class=s>,</span>  <span class=s>--</span> <span class=mi>5</span> <span class=s>retransmissions</span> <span class=no>on</span> <span class=s>receive</span> <span class=s>timeout</span>
                <span class=s>timeout</span> <span class=p>=</span> <span class=mi>1000</span><span class=s>,</span>  <span class=s>--</span> <span class=mi>1</span> <span class=s>sec</span>
            <span class=err>}</span>
            <span class=s>if</span> <span class=s>not</span> <span class=s>r</span> <span class=s>then</span>
                <span class=s>ngx.log(ngx.ERR,</span> <span class=s>"failed</span> <span class=s>to</span> <span class=s>instantiate</span> <span class=s>resolver:</span> <span class=s>",</span> <span class=s>err)</span>
                <span class=s>return</span>
            <span class=s>end</span>

            <span class=s>--</span> <span class=s>Pull</span> <span class=s>DNS</span> <span class=s>records</span>
            <span class=s>--</span> <span class=s>Use</span> <span class=s>a</span> <span class=s>hardcoded</span> <span class=s>domain</span> <span class=s>to</span> <span class=s>make</span> <span class=s>this</span> <span class=s>example</span> <span class=s>easier</span>
            <span class=s>local</span> <span class=s>answers,</span> <span class=s>err,</span> <span class=s>tries</span> <span class=p>=</span> <span class=s>r:query("kura.gg",</span> <span class=s>nil,</span> <span class=p>{}</span><span class=kn>)</span>
            <span class=s>if</span> <span class=s>not</span> <span class=s>answers</span> <span class=s>then</span>
                <span class=s>ngx.log(ngx.ERR,</span> <span class=s>"failed</span> <span class=s>to</span> <span class=s>query</span> <span class=s>resolved:</span> <span class=s>",</span> <span class=s>err)</span>
                <span class=s>return</span>
            <span class=s>end</span>
            <span class=s>if</span> <span class=s>answers.errcode</span> <span class=s>then</span>
                <span class=s>ngx.log(ngx.ERR,</span> <span class=s>"server</span> <span class=s>returned</span> <span class=s>error</span> <span class=s>code:</span> <span class=s>",</span> <span class=s>answers.errcode,</span>
                        <span class=s>":</span> <span class=s>",</span> <span class=s>answers.errstr)</span>
                <span class=s>--</span> <span class=s>Have</span> <span class=s>a</span> <span class=s>return</span> <span class=s>here</span> <span class=s>so</span> <span class=s>that</span> <span class=s>the</span> <span class=s>old</span> <span class=s>servers</span> <span class=s>remain</span> <span class=s>even</span> <span class=s>if</span>
                <span class=s>--</span> <span class=s>this</span> <span class=s>lookup</span> <span class=s>fails.</span>
                <span class=s>return</span>
            <span class=s>end</span>

            <span class=s>--</span> <span class=s>Dump</span> <span class=s>records</span> <span class=s>in</span> <span class=s>a</span> <span class=s>global</span> <span class=s>variable</span>
            <span class=s>--</span> <span class=s>Note</span> <span class=s>I</span> <span class=s>am</span> <span class=no>on</span><span class=s>ly</span> <span class=s>pulling</span> <span class=s>out</span> <span class=s>addresses</span> <span class=s>not</span> <span class=s>CNAMEs</span>
            <span class=s>_new_backend_servers</span> <span class=p>=</span> <span class=p>{}</span>
            <span class=kn>for</span> <span class=s>i,</span> <span class=s>ans</span> <span class=s>in</span> <span class=s>ipairs(answers)</span> <span class=s>do</span>
                <span class=s>table.insert(_new_backend_servers,</span> <span class=s>ans.address)</span>
            <span class=s>end</span>
            <span class=s>_backend_servers</span> <span class=p>=</span> <span class=s>_new_backend_servers</span>
        <span class=s>end</span>

        <span class=s>--</span> <span class=s>Run</span> <span class=s>an</span> <span class=s>at</span> <span class=s>timer</span> <span class=s>to</span> <span class=s>force</span> <span class=s>update_dns</span> <span class=s>to</span> <span class=s>trigger</span> <span class=no>on</span> <span class=s>worker</span> <span class=s>init</span>
        <span class=s>ngx.timer.at(0,</span> <span class=s>update_dns)</span>
        <span class=s>--</span> <span class=s>Set</span> <span class=s>a</span> <span class=s>timer</span> <span class=s>to</span> <span class=s>run</span> <span class=s>every</span> <span class=mi>10</span> <span class=s>seconds</span>
        <span class=s>ngx.timer.every(10,</span> <span class=s>update_dns)</span>
    <span class=err>}</span>

    <span class=s>upstream</span> <span class=s>backend</span> <span class=p>{</span>
        <span class=kn>server</span> <span class=mi>127</span><span class=s>.0.0.1</span><span class=p>;</span>

        <span class=kn>balancer_by_lua_block</span> <span class=p>{</span>
            <span class=kn>local</span> <span class=s>balancer</span> <span class=p>=</span> <span class=s>require("ngx.balancer")</span>

            <span class=s>if</span> <span class=c1>#_backend_servers == 0 then
</span>                <span class=s>ngx.log(ngx.ERR,</span> <span class=s>"no</span> <span class=s>backend</span> <span class=s>servers</span> <span class=s>available")</span>
                <span class=s>return</span> <span class=s>ngx.exit(500)</span>
            <span class=s>end</span>

            <span class=s>--</span> <span class=s>This</span> <span class=s>block</span> <span class=s>will</span> <span class=no>on</span><span class=s>ly</span> <span class=s>trigger</span> <span class=s>if</span> <span class=s>ngx.ctx.retry</span> <span class=s>is</span> <span class=s>not</span> <span class=s>true</span> <span class=s>or</span> <span class=s>is</span>
            <span class=s>--</span> <span class=s>unset.</span>
            <span class=s>--</span> <span class=s>We</span> <span class=s>set</span> <span class=s>this</span> <span class=s>to</span> <span class=s>true</span> <span class=s>during</span> <span class=s>the</span> <span class=s>initial</span> <span class=s>request</span> <span class=s>so</span> <span class=s>future</span>
            <span class=s>--</span> <span class=s>requests</span> <span class=s>within</span> <span class=s>this</span> <span class=s>context</span> <span class=s>will</span> <span class=s>not</span> <span class=s>go</span> <span class=s>down</span> <span class=s>this</span> <span class=s>path.</span>
            <span class=s>if</span> <span class=s>not</span> <span class=s>ngx.ctx.retry</span> <span class=s>then</span>
                <span class=s>ngx.ctx.retry</span> <span class=p>=</span> <span class=s>true</span>
                <span class=s>--</span> <span class=s>Pick</span> <span class=s>a</span> <span class=s>random</span> <span class=s>backend</span> <span class=s>to</span> <span class=s>start</span> <span class=s>with</span>
                <span class=s>server</span> <span class=p>=</span> <span class=s>_backend_servers[math.random(</span><span class=c1>#_backend_servers)]
</span>
                <span class=s>--</span> <span class=s>Kinda</span> <span class=s>messy</span> <span class=s>but,</span> <span class=s>create</span> <span class=s>a</span> <span class=s>context</span> <span class=s>table</span> <span class=s>we</span> <span class=s>dump</span> <span class=s>tried</span>
                <span class=s>--</span> <span class=s>backends</span> <span class=s>to.</span>
                <span class=s>ngx.ctx.tried</span> <span class=p>=</span> <span class=p>{}</span>
                <span class=kn>ngx.ctx.tried[server]</span> <span class=p>=</span> <span class=s>true</span>

                <span class=s>--</span> <span class=s>set</span> <span class=s>up</span> <span class=s>more</span> <span class=s>tries</span> <span class=s>using</span> <span class=s>the</span> <span class=s>length</span> <span class=s>of</span> <span class=s>the</span> <span class=s>server</span> <span class=s>list</span> <span class=s>minus</span> <span class=mi>1</span><span class=s>.</span>
                <span class=s>ok,</span> <span class=s>err</span> <span class=p>=</span> <span class=s>balancer.set_more_tries(</span><span class=c1>#_backend_servers - 1)
</span>                <span class=s>if</span> <span class=s>not</span> <span class=s>ok</span> <span class=s>then</span>
                    <span class=s>ngx.log(ngx.ERR,</span> <span class=s>"set_more_tries</span> <span class=s>failed:</span> <span class=s>",</span> <span class=s>err)</span>
                <span class=s>end</span>

            <span class=s>else</span>
                <span class=s>--</span> <span class=s>This</span> <span class=s>block</span> <span class=s>will</span> <span class=s>trigger</span> <span class=no>on</span> <span class=s>a</span> <span class=s>retry</span>
                <span class=s>--</span> <span class=s>Here</span> <span class=s>we'll</span> <span class=s>run</span> <span class=s>through</span> <span class=s>the</span> <span class=s>backends</span> <span class=s>and</span> <span class=s>pick</span> <span class=no>on</span><span class=s>e</span> <span class=s>we</span> <span class=s>haven't</span>
                <span class=s>--</span> <span class=s>tried</span> <span class=s>yet.</span>
                <span class=s>for</span> <span class=s>i,</span> <span class=s>ip</span> <span class=s>in</span> <span class=s>ipairs(_backend_servers)</span> <span class=s>do</span>
                    <span class=s>in_ctx</span> <span class=p>=</span> <span class=s>ngx.ctx.tried[ip]</span> <span class=p>~</span><span class=sr>=</span> <span class=s>nil</span>
                    <span class=s>if</span> <span class=s>in_ctx</span> <span class=p>==</span> <span class=s>false</span> <span class=s>then</span>
                        <span class=s>ngx.ctx.tried[ip]</span> <span class=p>=</span> <span class=s>true</span>
                        <span class=s>server</span> <span class=p>=</span> <span class=s>ip</span>
                        <span class=s>break</span>
                    <span class=s>end</span>
                <span class=s>end</span>
            <span class=s>end</span>

            <span class=s>--</span> <span class=s>Hardcoded</span> <span class=s>port</span> <span class=s>again</span> <span class=s>to</span> <span class=s>make</span> <span class=s>example</span> <span class=s>easier</span>
            <span class=s>ok,</span> <span class=s>err</span> <span class=p>=</span> <span class=s>balancer.set_current_peer(server,</span> <span class=mi>443</span><span class=s>)</span>
            <span class=s>if</span> <span class=s>not</span> <span class=s>ok</span> <span class=s>then</span>
                <span class=s>ngx.log(ngx.ERR,</span> <span class=s>"set_current_peer</span> <span class=s>failed:</span> <span class=s>",</span> <span class=s>err)</span>
                <span class=s>return</span> <span class=s>ngx.exit(500)</span>
            <span class=s>end</span>
        <span class=err>}</span>
    <span class=err>}</span>

    <span class=s>server</span> <span class=p>{</span>
        <span class=kn>listen</span> <span class=mi>80</span><span class=p>;</span>
        <span class=kn>server_name</span> <span class=s>localhost</span><span class=p>;</span>

        <span class=kn>location</span> <span class=s>/</span> <span class=p>{</span>
            <span class=kn>proxy_pass</span> <span class=s>https://backend</span><span class=p>;</span>
        <span class=p>}</span>
    <span class=p>}</span>

<span class=p>}</span>
</pre> </div> <div class=section id=full-example-on-github> <h2>Full example on GitHub</h2> <p>The full example nginx config is <a class="reference external" href=https://github.com/kura/openresty-upstream-dns-example/blob/master/nginx.conf>available on GitHub</a> so you can quickly spin it up yourself and try it out.</p> </div> </section> </div> <div class=eevee-related> <section> <h2>Related articles</h2> <ul> <li> <a href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ rel=bookmark title="Permalink to 'Retrying dynamically configured upstreams with OpenResty'" itemprop=url> Retrying dynamically configured upstreams with&nbsp;OpenResty </a> </li> <li> <a href=https://kura.gg/2014/02/06/nnginx-1.5.10-with-spdy3.1/ rel=bookmark title="Permalink to 'nginx 1.5.10 with SPDY 3.1'" itemprop=url> nginx 1.5.10 with <span class=caps>SPDY</span>&nbsp;3.1 </a> </li> <li> <a href=https://kura.gg/2014/02/02/nginx-1.5.9-and-ngx_pagespeed-1.7.30.3-beta/ rel=bookmark title="Permalink to 'nginx 1.5.9 and ngx_pagespeed 1.7.30.3-beta'" itemprop=url> nginx 1.5.9 and ngx_pagespeed&nbsp;1.7.30.3-beta </a> </li> <li> <a href=https://kura.gg/2014/01/08/haproxy1.5-dev21-nginx-1.5.8-spdy-pagespeed-1.7.30.2/ rel=bookmark title="Permalink to 'haproxy1.5-dev21, nginx 1.5.8, SPDY & pagespeed 1.7.30.2'" itemprop=url> haproxy1.5-dev21, nginx 1.5.8, <span class=caps>SPDY</span> <span class=amp>&amp;</span> pagespeed&nbsp;1.7.30.2 </a> </li> <li> <a href=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/ rel=bookmark title="Permalink to 'haproxy, nginx and SPDY with SSL termination (Debian 7)'" itemprop=url> haproxy, nginx and <span class=caps>SPDY</span> with <span class=caps>SSL</span> termination (Debian&nbsp;7) </a> </li> </ul> </section> </div> <div class=eevee-ac> <header class=eevee-ac__header> <div class=eevee-ac-author__text> <h2>Kura</h2> <p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex pro gamer. Cunt. They/Them.</p> <p> <a href=https://kura.gg/authors/kura/ itemprop=url title="Read more articles by Kura"> Read more articles by Kura </a> </p> <nav> <ul class=eevee-ac-author__social> <li class=eevee-ac-author-social__link> <a class="mdl-color-text--accent mdl-navigation__link" href=https://github.com/kura itemprop=url rel=bookmark title="kura on GitHub"> <i class=fa aria-hidden=true>&#xF09B;</i> </a> </li> </ul> </nav> </div> <img src=/images/avatar.png class=eevee-ac-author__avatar alt=Kura> </header> </div> <div class=eevee-comment id=article-comments> <section itemscope itemtype=http://schema.org/UserComments> <h2>Join the discussion</h2> <div id=disqus_thread></div> <noscript> Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a> </noscript> </section> </div> </article> <a href=https://github.com/kura/kura.gg/blob/main/content/configuring-upstreams-dynamically-with-dns-in-openresty.rst id=view-source title="View 'Configuring upstreams dynamically with DNS in OpenResty' on GitHub" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white"> <i class=material-icons>&#xE86F;</i> View Source </a> </div> </div> </main> <div class="eevee-pagination__container eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"> <nav class="eevee-pagination mdl-cell mdl-cell--12-col" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label=Pagination> <a href=https://kura.gg/2021/10/14/google-workspace-gmail-mx-dnssec-signed/ class=eevee-nav__button itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C4;</i> </button> Newer </a> <div class=eevee-spacer></div> <a href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ class=eevee-nav__button itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C8;</i> </button> </a> </nav> </div> </div> <footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement> <div class=mdl-mega-footer--top-section> <div class=mdl-mega-footer--drop-down-section> <ul class=mdl-mega-footer--link-list> <li> <a href=#top itemprop=url title="Back to the top of the page"> Back to the top of the page </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Footer navigation"> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Menu</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/eevee/ itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> </li> <li> <a href=/software/ itemprop=url rel=bookmark title=Software> <i class=material-icons aria-hidden=true>&#xE86F;</i> Software </a> </li> <li> <a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> </li> <li> <a href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Social</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i class=fa aria-hidden=true>&#xF09B;</i> Github </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Links</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://kura.gg/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> </li> <li> <a href=https://kura.gg/yarg itemprop=url rel=bookmark title=Yarg> <i class=material-icons aria-hidden=true>&#xE86F;</i> Yarg </a> </li> <li> <a href=https://kura.gg/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=https://kura.gg/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> </li> <li> <a href=https://kura.gg/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--bottom-section> <div class=mdl-logo> <a href=https://kura.gg rel=bookmark itemprop=url title=kura.gg> kura.gg </a> </div> <ul class="eevee-footer mdl-mega-footer--link-list"> <li>Powered by love &amp; rainbow sparkles.</li> <li>Source code and content released under the <a href=/license/ title="MIT license">MIT license</a>.</li> </ul> </div> </footer> </div> <link rel=stylesheet href=https://kura.gg/theme/css/eevee.min.css?13b98993> <script async src=https://kura.gg/theme/js/eevee.min.js?9eda6833></script> </body> </html>