<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="Configuring upstreams dynamically with DNS in OpenResty" property=og:title><meta content=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ property=og:url><meta content='This article is a continuation of retrying dynamically configured upstreams that gives an example of how you can configure OpenResty to update your upstream backend servers dynamically with DNS. Breaking down init_worker_by_lua_block init_worker_by_lua_block can be used to make an nginx worker do some fun stuff. In this instance we’re going to use it in conjunction with ngx.timer.every and the resty.dns.resolver. Here is the full example of my init_worker_by_lua_block. init_worker_by_lua_block { _backend_servers = {} local function update_dns() -- Set up the resolver local resolver = require "resty.dns.resolver" local r, err = resolver:new{ nameservers = {"1.1.1.1", {"1.0.0.1", 53} }, -- Cloudflare retrans = 5, -- 5 retransmissions on receive timeout timeout = 1000, -- 1 sec } if not r then ngx.log(ngx.ERR, "failed to instantiate resolver: ", err) return end -- Pull DNS records -- Use a hardcoded domain to make this example easier local answers, err, tries = r:query("kura.gg …' property=og:description><meta content=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="Configuring upstreams dynamically with DNS in OpenResty" property=twitter:title><meta content=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ property=twitter:url><meta content='This article is a continuation of retrying dynamically configured upstreams that gives an example of how you can configure OpenResty to update your upstream backend servers dynamically with DNS. Breaking down init_worker_by_lua_block init_worker_by_lua_block can be used to make an nginx worker do some fun stuff. In this instance we’re going to use it in conjunction with ngx.timer.every and the resty.dns.resolver. Here is the full example of my init_worker_by_lua_block. init_worker_by_lua_block { _backend_servers = {} local function update_dns() -- Set up the resolver local resolver = require "resty.dns.resolver" local r, err = resolver:new{ nameservers = {"1.1.1.1", {"1.0.0.1", 53} }, -- Cloudflare retrans = 5, -- 5 retransmissions on receive timeout timeout = 1000, -- 1 sec } if not r then ngx.log(ngx.ERR, "failed to instantiate resolver: ", err) return end -- Pull DNS records -- Use a hardcoded domain to make this example easier local answers, err, tries = r:query("kura.gg …' property=twitter:description><meta content=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="10 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><script type=application/ld+json>
{
    "@context": "https://schema.org",
    "@type": "BlogPosting",
    "headline": "Configuring upstreams dynamically with DNS in OpenResty",
    "url": "https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/",
    "description": "This article is a continuation of retrying dynamically configured upstreams that gives an example of how you can configure OpenResty to update your upstream backend servers dynamically with DNS. Breaking down init_worker_by_lua_block init_worker_by_lua_block can be used to make an nginx worker do some fun stuff. In this instance we’re going to use it in conjunction with ngx.timer.every and the resty.dns.resolver. Here is the full example of my init_worker_by_lua_block. init_worker_by_lua_block { _backend_servers = {} local function update_dns() -- Set up the resolver local resolver = require &#34;resty.dns.resolver&#34; local r, err = resolver:new{ nameservers = {&#34;1.1.1.1&#34;, {&#34;1.0.0.1&#34;, 53} }, -- Cloudflare retrans = 5, -- 5 retransmissions on receive timeout timeout = 1000, -- 1 sec } if not r then ngx.log(ngx.ERR, &#34;failed to instantiate resolver: &#34;, err) return end -- Pull DNS records -- Use a hardcoded domain to make this example easier local answers, err, tries = r:query(&#34;kura.gg …",
    "author": {
        "@type": "Person",
        "name": "Kura",
        "url": "https://kura.gg/authors/kura/"
    },
    "publisher": {
        "@type": "Organization",
        "name": "kura.gg",
        "url": "https://kura.gg/authors/kura/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://kura.gg/favicon.png"
        }
    },
    "mainEntityOfPage": "https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/",
    "image": "https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/index.png",
    "datePublished": "2020-08-30T17:30:00+01:00"
}
</script><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>Configuring upstreams dynamically with DNS in OpenResty</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons></i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>  </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content=nginx,openresty,lua itemprop=keywords><meta content=misc itemprop=keywords><div class=eevee-share><ul class="social-share mdl-navigation"><li class="social-share__link social-share__link--twitter"><a onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Share 'Configuring upstreams dynamically with DNS in OpenResty' on Twitter" href=https://twitter.com/intent/tweet?text=Configuring%20upstreams%20dynamically%20with%20DNS%20in%20OpenResty&url=https%3A//kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--facebook"><a onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Share 'Configuring upstreams dynamically with DNS in OpenResty' on Facebook" href=https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/> <i aria-hidden=true class=fa></i> </a><li class="social-share__link social-share__link--email"><a title="Share 'Configuring upstreams dynamically with DNS in OpenResty' via email" href=mailto:?subject=Configuring%20upstreams%20dynamically%20with%20DNS%20in%20OpenResty&body=I%20thought%20you%20might%20like%20'Configuring%20upstreams%20dynamically%20with%20DNS%20in%20OpenResty'%20--%20https%3A//kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/> <i aria-hidden=true class=material-icons>  </i> </a></ul></div><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2020-08-30T17:30:00+01:00 itemprop=datePublished> 30 Aug 2020 </time> — 10 min read</div><h1 itemprop=name><a title="Permalink to 'Configuring upstreams dynamically with DNS in OpenResty'" href=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ itemprop=url rel=bookmark> Configuring upstreams dynamically with <span class=caps>DNS</span> in OpenResty </a></h1><section><p>This article is part of the <span class=bold>OpenResty upstreams</span> series.<ol class=series-parts><li><a title="Retrying dynamically configured upstreams with OpenResty" href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ itemprop=url> Retrying dynamically configured upstreams with OpenResty </a><li class=series-active><a title="Configuring upstreams dynamically with DNS in OpenResty" href=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ itemprop=url> Configuring upstreams dynamically with DNS in OpenResty </a></ol></section><section class=eevee-toc><h2 id=toc>Contents</h2><nav class=eevee-toc-ribbon><div class=toc><p class=topic-title><a class="reference internal" href=#top>Contents</a><ul class=simple><li><a class="reference internal" href=#breaking-down-init-worker-by-lua-block id=toc-entry-1>Breaking down <cite>init_worker_by_lua_block</cite></a><ul><li><a class="reference internal" href=#configuring-the-dns-resolver id=toc-entry-2>Configuring the <span class=caps>DNS</span> resolver</a><li><a class="reference internal" href=#querying-the-dns-resolver id=toc-entry-3>Querying the <span class=caps>DNS</span> resolver</a><li><a class="reference internal" href=#using-the-returned-dns-records-to-configure-the-backend id=toc-entry-4>Using the returned <span class=caps>DNS</span> records to configure the backend</a><li><a class="reference internal" href=#set-up-a-timer-to-update-the-backend-servers-periodically id=toc-entry-5>Set up a timer to update the backend servers periodically</a></ul><li><a class="reference internal" href=#breaking-down-balancer-by-lua-block id=toc-entry-6>Breaking down <cite>balancer_by_lua_block</cite></a><ul><li><a class="reference internal" href=#setting-up-balancer-by-lua id=toc-entry-7>Setting up balancer_by_lua</a><li><a class="reference internal" href=#handling-an-initial-request id=toc-entry-8>Handling an initial request</a><li><a class="reference internal" href=#handling-a-retry-request id=toc-entry-9>Handling a retry request</a><li><a class="reference internal" href=#passing-the-request-back-to-nginx id=toc-entry-10>Passing the request back to nginx</a></ul><li><a class="reference internal" href=#putting-it-all-together id=toc-entry-11>Putting it all together</a><li><a class="reference internal" href=#full-example-on-github id=toc-entry-12>Full example on GitHub</a></ul></div></nav></section><section class=article-content itemprop=articleBody><p>This article is a continuation of <a class="reference external" href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/>retrying dynamically configured upstreams</a> that gives an example of how you can configure OpenResty to update your upstream backend servers dynamically with <span class=caps>DNS</span>.<div class=section id=breaking-down-init-worker-by-lua-block><h2>Breaking down <cite>init_worker_by_lua_block</cite></h2><p><cite>init_worker_by_lua_block</cite> can be used to make an nginx worker do some fun stuff. In this instance we’re going to use it in conjunction with <cite>ngx.timer.every</cite> and the <cite>resty.dns.resolver</cite>.<p>Here is the full example of my <cite>init_worker_by_lua_block</cite>.<pre class="code lua literal-block">
<span class=n>init_worker_by_lua_block</span> <span class=p>{</span>
    <span class=n>_backend_servers</span> <span class=o>=</span> <span class=p>{}</span>

    <span class=kd>local</span> <span class=kr>function</span> <span class=nf>update_dns</span><span class=p>()</span>
        <span class=c1>-- Set up the resolver</span>
        <span class=kd>local</span> <span class=n>resolver</span> <span class=o>=</span> <span class=nb>require</span> <span class=s2>"resty.dns.resolver"</span>
        <span class=kd>local</span> <span class=n>r</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>resolver</span><span class=p>:</span><span class=n>new</span><span class=p>{</span>
            <span class=n>nameservers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>"1.1.1.1"</span><span class=p>,</span> <span class=p>{</span><span class=s2>"1.0.0.1"</span><span class=p>,</span> <span class=mi>53</span><span class=p>}</span> <span class=p>},</span>  <span class=c1>-- Cloudflare</span>
            <span class=n>retrans</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>  <span class=c1>-- 5 retransmissions on receive timeout</span>
            <span class=n>timeout</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>,</span>  <span class=c1>-- 1 sec</span>
        <span class=p>}</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>r</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"failed to instantiate resolver: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
            <span class=kr>return</span>
        <span class=kr>end</span>

        <span class=c1>-- Pull DNS records</span>
        <span class=c1>-- Use a hardcoded domain to make this example easier</span>
        <span class=kd>local</span> <span class=n>answers</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=n>tries</span> <span class=o>=</span> <span class=n>r</span><span class=p>:</span><span class=n>query</span><span class=p>(</span><span class=s2>"kura.gg"</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=p>{})</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>answers</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"failed to query resolved: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
            <span class=kr>return</span>
        <span class=kr>end</span>
        <span class=kr>if</span> <span class=n>answers</span><span class=p>.</span><span class=n>errcode</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"server returned error code: "</span><span class=p>,</span> <span class=n>answers</span><span class=p>.</span><span class=n>errcode</span><span class=p>,</span>
                    <span class=s2>": "</span><span class=p>,</span> <span class=n>answers</span><span class=p>.</span><span class=n>errstr</span><span class=p>)</span>
            <span class=c1>-- Have a return here so that the old servers remain even if</span>
            <span class=c1>-- this lookup fails.</span>
            <span class=kr>return</span>
        <span class=kr>end</span>

        <span class=c1>-- Dump records in a global variable</span>
        <span class=c1>-- Note I am only pulling out addresses not CNAMEs</span>
        <span class=n>_new_backend_servers</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ans</span> <span class=kr>in</span> <span class=nb>ipairs</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span> <span class=kr>do</span>
            <span class=nb>table.insert</span><span class=p>(</span><span class=n>_new_backend_servers</span><span class=p>,</span> <span class=n>ans</span><span class=p>.</span><span class=n>address</span><span class=p>)</span>
        <span class=kr>end</span>
        <span class=n>_backend_servers</span> <span class=o>=</span> <span class=n>_new_backend_servers</span>
    <span class=kr>end</span>

    <span class=c1>-- Run an at timer to force update_dns to trigger on worker init</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>timer</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>update_dns</span><span class=p>)</span>
    <span class=c1>-- Set a timer to run every 10 seconds</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>timer</span><span class=p>.</span><span class=n>every</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>update_dns</span><span class=p>)</span>
<span class=p>}</span>
</pre><div class=section id=configuring-the-dns-resolver><h3>Configuring the <span class=caps>DNS</span> resolver</h3><p>Let’s break this block down in to easier to understand blocks.<pre class="code lua literal-block">
<span class=n>_backend_servers</span> <span class=o>=</span> <span class=p>{}</span>
</pre><p>Here we define an empty backend servers table that’ll be modified by modified by <span class=caps>DNS</span> resolver and is used by the balancer module for direction clients.<pre class="code lua literal-block">
<span class=kd>local</span> <span class=kr>function</span> <span class=nf>update_dns</span><span class=p>()</span>
    <span class=c1>-- Set up the resolver</span>
    <span class=kd>local</span> <span class=n>resolver</span> <span class=o>=</span> <span class=nb>require</span> <span class=s2>"resty.dns.resolver"</span>
    <span class=kd>local</span> <span class=n>r</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>resolver</span><span class=p>:</span><span class=n>new</span><span class=p>{</span>
        <span class=n>nameservers</span> <span class=o>=</span> <span class=p>{</span><span class=s2>"1.1.1.1"</span><span class=p>,</span> <span class=p>{</span><span class=s2>"1.0.0.1"</span><span class=p>,</span> <span class=mi>53</span><span class=p>}</span> <span class=p>},</span>  <span class=c1>-- Cloudflare</span>
        <span class=n>retrans</span> <span class=o>=</span> <span class=mi>5</span><span class=p>,</span>  <span class=c1>-- 5 retransmissions on receive timeout</span>
        <span class=n>timeout</span> <span class=o>=</span> <span class=mi>1000</span><span class=p>,</span>  <span class=c1>-- 1 sec</span>
    <span class=p>}</span>
</pre><p>Here we’re defining the <cite>update_dns</cite> function and within that setting up a <span class=caps>DNS</span> resolver using the <cite>resty.dns.resolver</cite> module. I’m using Cloudflare’s <span class=caps>DNS</span> servers in this example with 5 retransmissions and a timeout of 1 second.<pre class="code lua literal-block">
<span class=kr>if</span> <span class=ow>not</span> <span class=n>r</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"failed to instantiate resolver: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
    <span class=kr>return</span>
<span class=kr>end</span>
</pre><p>If instantiating the resolver fails, the function will return, leaving the backend server table unmodified. If this happens randomly during operation then the old server table will remain in use. If it fails during start up, the backend server table will be empty and cause <cite><span class=caps>HTTP</span> 500</cite> errors to be thrown (this is set up later.)</div><div class=section id=querying-the-dns-resolver><h3>Querying the <span class=caps>DNS</span> resolver</h3><pre class="code lua literal-block">
<span class=c1>-- Pull DNS records</span>
<span class=c1>-- Use a hardcoded domain to make this example easier</span>
<span class=kd>local</span> <span class=n>answers</span><span class=p>,</span> <span class=n>err</span><span class=p>,</span> <span class=n>tries</span> <span class=o>=</span> <span class=n>r</span><span class=p>:</span><span class=n>query</span><span class=p>(</span><span class=s2>"kura.gg"</span><span class=p>,</span> <span class=kc>nil</span><span class=p>,</span> <span class=p>{})</span>
<span class=kr>if</span> <span class=ow>not</span> <span class=n>answers</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"failed to query resolved: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
    <span class=kr>return</span>
<span class=kr>end</span>
</pre><p>Here we query the <span class=caps>DNS</span> server for records, I’m using my own domain <cite>kura.gg</cite> in this example.<pre class="code lua literal-block">
<span class=kr>if</span> <span class=n>answers</span><span class=p>.</span><span class=n>errcode</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"server returned error code: "</span><span class=p>,</span> <span class=n>answers</span><span class=p>.</span><span class=n>errcode</span><span class=p>,</span>
            <span class=s2>": "</span><span class=p>,</span> <span class=n>answers</span><span class=p>.</span><span class=n>errstr</span><span class=p>)</span>
    <span class=c1>-- Have a return here so that the old servers remain even if</span>
    <span class=c1>-- this lookup fails.</span>
    <span class=kr>return</span>
<span class=kr>end</span>
</pre><p>If querying the records fails or if no records are found the function will return and leave the backend server table unmodified, allowing clients to attempt to use the old servers if they’re still alive.</div><div class=section id=using-the-returned-dns-records-to-configure-the-backend><h3>Using the returned <span class=caps>DNS</span> records to configure the backend</h3><pre class="code lua literal-block">
    <span class=c1>-- Dump records in a global variable</span>
    <span class=c1>-- Note I am only pulling out addresses not CNAMEs</span>
    <span class=n>_new_backend_servers</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ans</span> <span class=kr>in</span> <span class=nb>ipairs</span><span class=p>(</span><span class=n>answers</span><span class=p>)</span> <span class=kr>do</span>
        <span class=nb>table.insert</span><span class=p>(</span><span class=n>_new_backend_servers</span><span class=p>,</span> <span class=n>ans</span><span class=p>.</span><span class=n>address</span><span class=p>)</span>
    <span class=kr>end</span>
    <span class=n>_backend_servers</span> <span class=o>=</span> <span class=n>_new_backend_servers</span>
<span class=kr>end</span>
</pre><p>Finally we reach this block if no errors have occured. This will create a new table of backend servers from the <span class=caps>DNS</span> records queried and replace the old table with the new one.<p>It’s worth noting that this code will only store records that have an <cite>A</cite> or <cite><span class=caps>AAAA</span></cite> record, not <cite><span class=caps>CNAMES</span></cite> etc. Although it’s easy enough to modify it to change this behaviour.</div><div class=section id=set-up-a-timer-to-update-the-backend-servers-periodically><h3>Set up a timer to update the backend servers periodically</h3><pre class="code lua literal-block">
<span class=c1>-- Run an at timer to force update_dns to trigger on worker init</span>
<span class=n>ngx</span><span class=p>.</span><span class=n>timer</span><span class=p>.</span><span class=n>at</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span> <span class=n>update_dns</span><span class=p>)</span>
<span class=c1>-- Set a timer to run every 10 seconds</span>
<span class=n>ngx</span><span class=p>.</span><span class=n>timer</span><span class=p>.</span><span class=n>every</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span> <span class=n>update_dns</span><span class=p>)</span>
</pre><p>Here we’re setting up 2 timers. The first is an <cite>ngx.timer.at</cite> timer that tiggers when a worker is started to attempt to set up the backend server table on worker init.<p>The second is an <cite>ngx.timer.every</cite> timer that runs in the worker every 10 seconds.<p>Each worker will do this and have it’s own copy of the backend servers table.</div></div><div class=section id=breaking-down-balancer-by-lua-block><h2>Breaking down <cite>balancer_by_lua_block</cite></h2><p>Just like in the <a class="reference external" href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/>retrying dynamically configured upstreams</a> article we’ll use OpenResty’s <cite>balancer_by_lua_block</cite> to allow the balancer to use these records.<pre class="code lua literal-block">
<span class=n>balancer_by_lua_block</span> <span class=p>{</span>
    <span class=kd>local</span> <span class=n>balancer</span> <span class=o>=</span> <span class=nb>require</span><span class=p>(</span><span class=s2>"ngx.balancer"</span><span class=p>)</span>

    <span class=kr>if</span> <span class=o>#</span><span class=n>_backend_servers</span> <span class=o>==</span> <span class=mi>0</span> <span class=kr>then</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"no backend servers available"</span><span class=p>)</span>
        <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>

    <span class=c1>-- This block will only trigger if ngx.ctx.retry is not true.</span>
    <span class=c1>-- We set this to true during the initial request so future</span>
    <span class=c1>-- requests within this context will not go down this path.</span>
    <span class=kr>if</span> <span class=ow>not</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=kr>then</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=o>=</span> <span class=kc>true</span>
        <span class=c1>-- Pick a random backend to start with</span>
        <span class=n>server</span> <span class=o>=</span> <span class=n>_backend_servers</span><span class=p>[</span><span class=nb>math.random</span><span class=p>(</span><span class=o>#</span><span class=n>_backend_servers</span><span class=p>)]</span>

        <span class=c1>-- Kinda messy but, create a context table we dump tried</span>
        <span class=c1>-- backends to.</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span> <span class=o>=</span> <span class=p>{}</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>server</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span>

        <span class=c1>-- set up more tries using the length of the server list minus 1.</span>
        <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_more_tries</span><span class=p>(</span><span class=o>#</span><span class=n>_backend_servers</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_more_tries failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
        <span class=kr>end</span>

    <span class=kr>else</span>
        <span class=c1>-- This block will trigger on a retry</span>
        <span class=c1>-- Here we'll run through the backends and pick one we haven't</span>
        <span class=c1>-- tried yet.</span>
        <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ip</span> <span class=kr>in</span> <span class=nb>ipairs</span><span class=p>(</span><span class=n>_backend_servers</span><span class=p>)</span> <span class=kr>do</span>
            <span class=n>in_ctx</span> <span class=o>=</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>~=</span> <span class=kc>nil</span>
            <span class=kr>if</span> <span class=n>in_ctx</span> <span class=o>==</span> <span class=kc>false</span> <span class=kr>then</span>
                <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span>
                <span class=n>server</span> <span class=o>=</span> <span class=n>ip</span>
                <span class=kr>break</span>
            <span class=kr>end</span>
        <span class=kr>end</span>
    <span class=kr>end</span>

    <span class=c1>-- Hardcoded port again to make example easier</span>
    <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_current_peer</span><span class=p>(</span><span class=n>server</span><span class=p>,</span> <span class=mi>443</span><span class=p>)</span>
    <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_current_peer failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
        <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
    <span class=kr>end</span>
<span class=p>}</span>
</pre><p>As with the <cite>init_worker_by_lua_block</cite> I’ll break the <cite>balancer_by_lua_block</cite> block down in more manageable chunks.<div class=section id=setting-up-balancer-by-lua><h3>Setting up balancer_by_lua</h3><pre class="code lua literal-block">
<span class=kd>local</span> <span class=n>balancer</span> <span class=o>=</span> <span class=nb>require</span><span class=p>(</span><span class=s2>"ngx.balancer"</span><span class=p>)</span>

<span class=kr>if</span> <span class=o>#</span><span class=n>_backend_servers</span> <span class=o>==</span> <span class=mi>0</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"no backend servers available"</span><span class=p>)</span>
    <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
<span class=kr>end</span>
</pre><p>First thing we do is include the <cite>ngx.balancer</cite> module, then we check to see if the backend servers table has any records. If not all we can do is write an error message to log and send the client an <cite><span class=caps>HTTP</span> 500</cite> because we have no backends available.</div><div class=section id=handling-an-initial-request><h3>Handling an initial request</h3><pre class="code lua literal-block">
<span class=c1>-- This block will only trigger if ngx.ctx.retry is not true or is</span>
<span class=c1>-- unset.</span>
<span class=c1>-- We set this to true during the initial request so future</span>
<span class=c1>-- requests within this context will not go down this path.</span>
<span class=kr>if</span> <span class=ow>not</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=o>=</span> <span class=kc>true</span>
    <span class=c1>-- Pick a random backend to start with</span>
    <span class=n>server</span> <span class=o>=</span> <span class=n>_backend_servers</span><span class=p>[</span><span class=nb>math.random</span><span class=p>(</span><span class=o>#</span><span class=n>_backend_servers</span><span class=p>)]</span>

    <span class=c1>-- Kinda messy but, create a context table we dump tried</span>
    <span class=c1>-- backends to.</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span> <span class=o>=</span> <span class=p>{}</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>server</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span>

    <span class=c1>-- set up more tries using the length of the server list minus 1.</span>
    <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_more_tries</span><span class=p>(</span><span class=o>#</span><span class=n>_backend_servers</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
    <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
        <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_more_tries failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
    <span class=kr>end</span>
</pre><p>Here we set up what happens when <cite>ngx.ctx.retry</cite> is undefined or false, which will happen on first request for a client.<p>Within this block we pick a random backend, set up a table of addresses already tried so if a retry is necessary it won’t use the same host.<p>Then we set the number of retries to attempt as the length of the server table minus one.</div><div class=section id=handling-a-retry-request><h3>Handling a retry request</h3><pre class="code lua literal-block">
<span class=kr>else</span>
    <span class=c1>-- This block will trigger on a retry</span>
    <span class=c1>-- Here we'll run through the backends and pick one we haven't</span>
    <span class=c1>-- tried yet.</span>
    <span class=kr>for</span> <span class=n>i</span><span class=p>,</span> <span class=n>ip</span> <span class=kr>in</span> <span class=nb>ipairs</span><span class=p>(</span><span class=n>_backend_servers</span><span class=p>)</span> <span class=kr>do</span>
        <span class=n>in_ctx</span> <span class=o>=</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>~=</span> <span class=kc>nil</span>
        <span class=kr>if</span> <span class=n>in_ctx</span> <span class=o>==</span> <span class=kc>false</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>tried</span><span class=p>[</span><span class=n>ip</span><span class=p>]</span> <span class=o>=</span> <span class=kc>true</span>
            <span class=n>server</span> <span class=o>=</span> <span class=n>ip</span>
            <span class=kr>break</span>
        <span class=kr>end</span>
    <span class=kr>end</span>
<span class=kr>end</span>
</pre><p>This block is what will be called if the request is a retry. In it we simply iterate through the backend server table looking for a backend we haven’t tried yet. Once we find one we add it to the list of servers tried and break the loop to send the client to that server.</div><div class=section id=passing-the-request-back-to-nginx><h3>Passing the request back to nginx</h3><pre class="code lua literal-block">
<span class=c1>-- Hardcoded port again to make example easier</span>
<span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_current_peer</span><span class=p>(</span><span class=n>server</span><span class=p>,</span> <span class=mi>443</span><span class=p>)</span>
<span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
    <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_current_peer failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
    <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
<span class=kr>end</span>
</pre><p>This final block is where nginx is told which backend to send the client to.</div></div><div class=section id=putting-it-all-together><h2>Putting it all together</h2><p>Below is the full example written as a single <cite>nginx.conf</cite>. Sadly syntax highlighters have issues with nginx and Lua in a single file.<pre class="code nginx literal-block">
<span class=c1># set 2 worker processes to show the timer spawning on each one
</span><span class=k>worker_processes</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w>

</span><span class=k>events</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=kn>worker_connections</span><span class=w> </span><span class=mi>1024</span><span class=p>;</span><span class=w>
</span><span class=p>}</span><span class=w>

</span><span class=k>http</span><span class=w> </span><span class=p>{</span><span class=w>

    </span><span class=c1># Do this for each worker so each worker has it's own copy of the DNS
</span><span class=w>    </span><span class=c1># records.
</span><span class=w>    </span><span class=kn>init_worker_by_lua_block</span><span class=w> </span><span class=p>{</span><span class=w>
        </span><span class=kn>_backend_servers</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>{}</span><span class=w>

        </span><span class=kn>local</span><span class=w> </span><span class=s>function</span><span class=w> </span><span class=s>update_dns()</span><span class=w>
            </span><span class=s>--</span><span class=w> </span><span class=s>Set</span><span class=w> </span><span class=s>up</span><span class=w> </span><span class=s>the</span><span class=w> </span><span class=s>resolver</span><span class=w>
            </span><span class=s>local</span><span class=w> </span><span class=s>resolver</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>require</span><span class=w> </span><span class=s>"resty.dns.resolver"</span><span class=w>
            </span><span class=s>local</span><span class=w> </span><span class=s>r,</span><span class=w> </span><span class=s>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>resolver:new</span><span class=p>{</span><span class=w>
                </span><span class=kn>nameservers</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>{</span><span class=kn>"1.1.1.1",</span><span class=w> </span><span class=p>{</span><span class=kn>"1.0.0.1",</span><span class=w> </span><span class=mi>53</span><span class=err>}</span><span class=w> </span><span class=err>}</span><span class=s>,</span><span class=w>  </span><span class=s>--</span><span class=w> </span><span class=s>Cloudflare</span><span class=w>
                </span><span class=s>retrans</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>5</span><span class=s>,</span><span class=w>  </span><span class=s>--</span><span class=w> </span><span class=mi>5</span><span class=w> </span><span class=s>retransmissions</span><span class=w> </span><span class=no>on</span><span class=w> </span><span class=s>receive</span><span class=w> </span><span class=s>timeout</span><span class=w>
                </span><span class=s>timeout</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>1000</span><span class=s>,</span><span class=w>  </span><span class=s>--</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=s>sec</span><span class=w>
            </span><span class=err>}</span><span class=w>
            </span><span class=s>if</span><span class=w> </span><span class=s>not</span><span class=w> </span><span class=s>r</span><span class=w> </span><span class=s>then</span><span class=w>
                </span><span class=s>ngx.log(ngx.ERR,</span><span class=w> </span><span class=s>"failed</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>instantiate</span><span class=w> </span><span class=s>resolver:</span><span class=w> </span><span class=s>",</span><span class=w> </span><span class=s>err)</span><span class=w>
                </span><span class=s>return</span><span class=w>
            </span><span class=s>end</span><span class=w>

            </span><span class=s>--</span><span class=w> </span><span class=s>Pull</span><span class=w> </span><span class=s>DNS</span><span class=w> </span><span class=s>records</span><span class=w>
            </span><span class=s>--</span><span class=w> </span><span class=s>Use</span><span class=w> </span><span class=s>a</span><span class=w> </span><span class=s>hardcoded</span><span class=w> </span><span class=s>domain</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>make</span><span class=w> </span><span class=s>this</span><span class=w> </span><span class=s>example</span><span class=w> </span><span class=s>easier</span><span class=w>
            </span><span class=s>local</span><span class=w> </span><span class=s>answers,</span><span class=w> </span><span class=s>err,</span><span class=w> </span><span class=s>tries</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>r:query("kura.gg",</span><span class=w> </span><span class=s>nil,</span><span class=w> </span><span class=p>{}</span><span class=kn>)</span><span class=w>
            </span><span class=s>if</span><span class=w> </span><span class=s>not</span><span class=w> </span><span class=s>answers</span><span class=w> </span><span class=s>then</span><span class=w>
                </span><span class=s>ngx.log(ngx.ERR,</span><span class=w> </span><span class=s>"failed</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>query</span><span class=w> </span><span class=s>resolved:</span><span class=w> </span><span class=s>",</span><span class=w> </span><span class=s>err)</span><span class=w>
                </span><span class=s>return</span><span class=w>
            </span><span class=s>end</span><span class=w>
            </span><span class=s>if</span><span class=w> </span><span class=s>answers.errcode</span><span class=w> </span><span class=s>then</span><span class=w>
                </span><span class=s>ngx.log(ngx.ERR,</span><span class=w> </span><span class=s>"server</span><span class=w> </span><span class=s>returned</span><span class=w> </span><span class=s>error</span><span class=w> </span><span class=s>code:</span><span class=w> </span><span class=s>",</span><span class=w> </span><span class=s>answers.errcode,</span><span class=w>
                        </span><span class=s>":</span><span class=w> </span><span class=s>",</span><span class=w> </span><span class=s>answers.errstr)</span><span class=w>
                </span><span class=s>--</span><span class=w> </span><span class=s>Have</span><span class=w> </span><span class=s>a</span><span class=w> </span><span class=s>return</span><span class=w> </span><span class=s>here</span><span class=w> </span><span class=s>so</span><span class=w> </span><span class=s>that</span><span class=w> </span><span class=s>the</span><span class=w> </span><span class=s>old</span><span class=w> </span><span class=s>servers</span><span class=w> </span><span class=s>remain</span><span class=w> </span><span class=s>even</span><span class=w> </span><span class=s>if</span><span class=w>
                </span><span class=s>--</span><span class=w> </span><span class=s>this</span><span class=w> </span><span class=s>lookup</span><span class=w> </span><span class=s>fails.</span><span class=w>
                </span><span class=s>return</span><span class=w>
            </span><span class=s>end</span><span class=w>

            </span><span class=s>--</span><span class=w> </span><span class=s>Dump</span><span class=w> </span><span class=s>records</span><span class=w> </span><span class=s>in</span><span class=w> </span><span class=s>a</span><span class=w> </span><span class=s>global</span><span class=w> </span><span class=s>variable</span><span class=w>
            </span><span class=s>--</span><span class=w> </span><span class=s>Note</span><span class=w> </span><span class=s>I</span><span class=w> </span><span class=s>am</span><span class=w> </span><span class=no>on</span><span class=s>ly</span><span class=w> </span><span class=s>pulling</span><span class=w> </span><span class=s>out</span><span class=w> </span><span class=s>addresses</span><span class=w> </span><span class=s>not</span><span class=w> </span><span class=s>CNAMEs</span><span class=w>
            </span><span class=s>_new_backend_servers</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>{}</span><span class=w>
            </span><span class=kn>for</span><span class=w> </span><span class=s>i,</span><span class=w> </span><span class=s>ans</span><span class=w> </span><span class=s>in</span><span class=w> </span><span class=s>ipairs(answers)</span><span class=w> </span><span class=s>do</span><span class=w>
                </span><span class=s>table.insert(_new_backend_servers,</span><span class=w> </span><span class=s>ans.address)</span><span class=w>
            </span><span class=s>end</span><span class=w>
            </span><span class=s>_backend_servers</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>_new_backend_servers</span><span class=w>
        </span><span class=s>end</span><span class=w>

        </span><span class=s>--</span><span class=w> </span><span class=s>Run</span><span class=w> </span><span class=s>an</span><span class=w> </span><span class=s>at</span><span class=w> </span><span class=s>timer</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>force</span><span class=w> </span><span class=s>update_dns</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>trigger</span><span class=w> </span><span class=no>on</span><span class=w> </span><span class=s>worker</span><span class=w> </span><span class=s>init</span><span class=w>
        </span><span class=s>ngx.timer.at(0,</span><span class=w> </span><span class=s>update_dns)</span><span class=w>
        </span><span class=s>--</span><span class=w> </span><span class=s>Set</span><span class=w> </span><span class=s>a</span><span class=w> </span><span class=s>timer</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>run</span><span class=w> </span><span class=s>every</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=s>seconds</span><span class=w>
        </span><span class=s>ngx.timer.every(10,</span><span class=w> </span><span class=s>update_dns)</span><span class=w>
    </span><span class=err>}</span><span class=w>

    </span><span class=s>upstream</span><span class=w> </span><span class=s>backend</span><span class=w> </span><span class=p>{</span><span class=w>
        </span><span class=kn>server</span><span class=w> </span><span class=mi>127</span><span class=s>.0.0.1</span><span class=p>;</span><span class=w>

        </span><span class=kn>balancer_by_lua_block</span><span class=w> </span><span class=p>{</span><span class=w>
            </span><span class=kn>local</span><span class=w> </span><span class=s>balancer</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>require("ngx.balancer")</span><span class=w>

            </span><span class=s>if</span><span class=w> </span><span class=c1>#_backend_servers == 0 then
</span><span class=w>                </span><span class=s>ngx.log(ngx.ERR,</span><span class=w> </span><span class=s>"no</span><span class=w> </span><span class=s>backend</span><span class=w> </span><span class=s>servers</span><span class=w> </span><span class=s>available")</span><span class=w>
                </span><span class=s>return</span><span class=w> </span><span class=s>ngx.exit(500)</span><span class=w>
            </span><span class=s>end</span><span class=w>

            </span><span class=s>--</span><span class=w> </span><span class=s>This</span><span class=w> </span><span class=s>block</span><span class=w> </span><span class=s>will</span><span class=w> </span><span class=no>on</span><span class=s>ly</span><span class=w> </span><span class=s>trigger</span><span class=w> </span><span class=s>if</span><span class=w> </span><span class=s>ngx.ctx.retry</span><span class=w> </span><span class=s>is</span><span class=w> </span><span class=s>not</span><span class=w> </span><span class=s>true</span><span class=w> </span><span class=s>or</span><span class=w> </span><span class=s>is</span><span class=w>
            </span><span class=s>--</span><span class=w> </span><span class=s>unset.</span><span class=w>
            </span><span class=s>--</span><span class=w> </span><span class=s>We</span><span class=w> </span><span class=s>set</span><span class=w> </span><span class=s>this</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>true</span><span class=w> </span><span class=s>during</span><span class=w> </span><span class=s>the</span><span class=w> </span><span class=s>initial</span><span class=w> </span><span class=s>request</span><span class=w> </span><span class=s>so</span><span class=w> </span><span class=s>future</span><span class=w>
            </span><span class=s>--</span><span class=w> </span><span class=s>requests</span><span class=w> </span><span class=s>within</span><span class=w> </span><span class=s>this</span><span class=w> </span><span class=s>context</span><span class=w> </span><span class=s>will</span><span class=w> </span><span class=s>not</span><span class=w> </span><span class=s>go</span><span class=w> </span><span class=s>down</span><span class=w> </span><span class=s>this</span><span class=w> </span><span class=s>path.</span><span class=w>
            </span><span class=s>if</span><span class=w> </span><span class=s>not</span><span class=w> </span><span class=s>ngx.ctx.retry</span><span class=w> </span><span class=s>then</span><span class=w>
                </span><span class=s>ngx.ctx.retry</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>true</span><span class=w>
                </span><span class=s>--</span><span class=w> </span><span class=s>Pick</span><span class=w> </span><span class=s>a</span><span class=w> </span><span class=s>random</span><span class=w> </span><span class=s>backend</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>start</span><span class=w> </span><span class=s>with</span><span class=w>
                </span><span class=s>server</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>_backend_servers[math.random(</span><span class=c1>#_backend_servers)]
</span><span class=w>
                </span><span class=s>--</span><span class=w> </span><span class=s>Kinda</span><span class=w> </span><span class=s>messy</span><span class=w> </span><span class=s>but,</span><span class=w> </span><span class=s>create</span><span class=w> </span><span class=s>a</span><span class=w> </span><span class=s>context</span><span class=w> </span><span class=s>table</span><span class=w> </span><span class=s>we</span><span class=w> </span><span class=s>dump</span><span class=w> </span><span class=s>tried</span><span class=w>
                </span><span class=s>--</span><span class=w> </span><span class=s>backends</span><span class=w> </span><span class=s>to.</span><span class=w>
                </span><span class=s>ngx.ctx.tried</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=p>{}</span><span class=w>
                </span><span class=kn>ngx.ctx.tried[server]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>true</span><span class=w>

                </span><span class=s>--</span><span class=w> </span><span class=s>set</span><span class=w> </span><span class=s>up</span><span class=w> </span><span class=s>more</span><span class=w> </span><span class=s>tries</span><span class=w> </span><span class=s>using</span><span class=w> </span><span class=s>the</span><span class=w> </span><span class=s>length</span><span class=w> </span><span class=s>of</span><span class=w> </span><span class=s>the</span><span class=w> </span><span class=s>server</span><span class=w> </span><span class=s>list</span><span class=w> </span><span class=s>minus</span><span class=w> </span><span class=mi>1</span><span class=s>.</span><span class=w>
                </span><span class=s>ok,</span><span class=w> </span><span class=s>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>balancer.set_more_tries(</span><span class=c1>#_backend_servers - 1)
</span><span class=w>                </span><span class=s>if</span><span class=w> </span><span class=s>not</span><span class=w> </span><span class=s>ok</span><span class=w> </span><span class=s>then</span><span class=w>
                    </span><span class=s>ngx.log(ngx.ERR,</span><span class=w> </span><span class=s>"set_more_tries</span><span class=w> </span><span class=s>failed:</span><span class=w> </span><span class=s>",</span><span class=w> </span><span class=s>err)</span><span class=w>
                </span><span class=s>end</span><span class=w>

            </span><span class=s>else</span><span class=w>
                </span><span class=s>--</span><span class=w> </span><span class=s>This</span><span class=w> </span><span class=s>block</span><span class=w> </span><span class=s>will</span><span class=w> </span><span class=s>trigger</span><span class=w> </span><span class=no>on</span><span class=w> </span><span class=s>a</span><span class=w> </span><span class=s>retry</span><span class=w>
                </span><span class=s>--</span><span class=w> </span><span class=s>Here</span><span class=w> </span><span class=s>we'll</span><span class=w> </span><span class=s>run</span><span class=w> </span><span class=s>through</span><span class=w> </span><span class=s>the</span><span class=w> </span><span class=s>backends</span><span class=w> </span><span class=s>and</span><span class=w> </span><span class=s>pick</span><span class=w> </span><span class=no>on</span><span class=s>e</span><span class=w> </span><span class=s>we</span><span class=w> </span><span class=s>haven't</span><span class=w>
                </span><span class=s>--</span><span class=w> </span><span class=s>tried</span><span class=w> </span><span class=s>yet.</span><span class=w>
                </span><span class=s>for</span><span class=w> </span><span class=s>i,</span><span class=w> </span><span class=s>ip</span><span class=w> </span><span class=s>in</span><span class=w> </span><span class=s>ipairs(_backend_servers)</span><span class=w> </span><span class=s>do</span><span class=w>
                    </span><span class=s>in_ctx</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>ngx.ctx.tried[ip]</span><span class=w> </span><span class=p>~</span><span class=sr>=</span><span class=w> </span><span class=s>nil</span><span class=w>
                    </span><span class=s>if</span><span class=w> </span><span class=s>in_ctx</span><span class=w> </span><span class=p>==</span><span class=w> </span><span class=s>false</span><span class=w> </span><span class=s>then</span><span class=w>
                        </span><span class=s>ngx.ctx.tried[ip]</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>true</span><span class=w>
                        </span><span class=s>server</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>ip</span><span class=w>
                        </span><span class=s>break</span><span class=w>
                    </span><span class=s>end</span><span class=w>
                </span><span class=s>end</span><span class=w>
            </span><span class=s>end</span><span class=w>

            </span><span class=s>--</span><span class=w> </span><span class=s>Hardcoded</span><span class=w> </span><span class=s>port</span><span class=w> </span><span class=s>again</span><span class=w> </span><span class=s>to</span><span class=w> </span><span class=s>make</span><span class=w> </span><span class=s>example</span><span class=w> </span><span class=s>easier</span><span class=w>
            </span><span class=s>ok,</span><span class=w> </span><span class=s>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=s>balancer.set_current_peer(server,</span><span class=w> </span><span class=mi>443</span><span class=s>)</span><span class=w>
            </span><span class=s>if</span><span class=w> </span><span class=s>not</span><span class=w> </span><span class=s>ok</span><span class=w> </span><span class=s>then</span><span class=w>
                </span><span class=s>ngx.log(ngx.ERR,</span><span class=w> </span><span class=s>"set_current_peer</span><span class=w> </span><span class=s>failed:</span><span class=w> </span><span class=s>",</span><span class=w> </span><span class=s>err)</span><span class=w>
                </span><span class=s>return</span><span class=w> </span><span class=s>ngx.exit(500)</span><span class=w>
            </span><span class=s>end</span><span class=w>
        </span><span class=err>}</span><span class=w>
    </span><span class=err>}</span><span class=w>

    </span><span class=s>server</span><span class=w> </span><span class=p>{</span><span class=w>
        </span><span class=kn>listen</span><span class=w> </span><span class=mi>80</span><span class=p>;</span><span class=w>
        </span><span class=kn>server_name</span><span class=w> </span><span class=s>localhost</span><span class=p>;</span><span class=w>

        </span><span class=kn>location</span><span class=w> </span><span class=s>/</span><span class=w> </span><span class=p>{</span><span class=w>
            </span><span class=kn>proxy_pass</span><span class=w> </span><span class=s>https://backend</span><span class=p>;</span><span class=w>
        </span><span class=p>}</span><span class=w>
    </span><span class=p>}</span><span class=w>

</span><span class=p>}</span>
</pre></div><div class=section id=full-example-on-github><h2>Full example on GitHub</h2><p>The full example nginx config is <a class="reference external" href=https://github.com/kura/openresty-upstream-dns-example/blob/master/nginx.conf>available on GitHub</a> so you can quickly spin it up yourself and try it out.</div></section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'Retrying dynamically configured upstreams with OpenResty'" href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ itemprop=url rel=bookmark> Retrying dynamically configured upstreams with OpenResty </a><li><a title="Permalink to 'nginx 1.5.10 with SPDY 3.1'" href=https://kura.gg/2014/02/06/nnginx-1.5.10-with-spdy3.1/ itemprop=url rel=bookmark> nginx 1.5.10 with <span class=caps>SPDY</span> 3.1 </a><li><a title="Permalink to 'nginx 1.5.9 and ngx_pagespeed 1.7.30.3-beta'" href=https://kura.gg/2014/02/02/nginx-1.5.9-and-ngx_pagespeed-1.7.30.3-beta/ itemprop=url rel=bookmark> nginx 1.5.9 and ngx_pagespeed 1.7.30.3-beta </a><li><a title="Permalink to 'haproxy1.5-dev21, nginx 1.5.8, SPDY & pagespeed 1.7.30.2'" href=https://kura.gg/2014/01/08/haproxy1.5-dev21-nginx-1.5.8-spdy-pagespeed-1.7.30.2/ itemprop=url rel=bookmark> haproxy1.5-dev21, nginx 1.5.8, <span class=caps>SPDY</span> <span class=amp>&</span> pagespeed 1.7.30.2 </a><li><a title="Permalink to 'haproxy, nginx and SPDY with SSL termination (Debian 7)'" href=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/ itemprop=url rel=bookmark> haproxy, nginx and <span class=caps>SPDY</span> with <span class=caps>SSL</span> termination (Debian 7) </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa></i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>🦣</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'Configuring upstreams dynamically with DNS in OpenResty' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/configuring-upstreams-dynamically-with-dns-in-openresty.rst id=view-source> <i class=material-icons></i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2021/10/14/google-workspace-gmail-mx-dnssec-signed/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> Newer </a><div class=eevee-spacer></div><a class=eevee-nav__button href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons></i></button> </a></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons></i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons></i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons></i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons></i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa></i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>🦣</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons></i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons></i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons></i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons></i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons></i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>