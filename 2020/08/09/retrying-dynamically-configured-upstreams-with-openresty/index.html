<!DOCTYPE html><!--

                                      |
                                     /|
                                   ,' |
                                  .   |
                                    | |
                                 ' '| |
                                / / | |
       _,.-\"\"--._              / /  | |
     ,'          `.           j '   ' '
   ,'              `.         ||   / ,                         ___..--,
  /                  \\        ' `.'`.-.,-\".  .       _..---\"\"'' __, ,'
 /                    \\        \\` .\"`      `\"'\\   ,'\"_..--''\"\"\"'.'.'
.                      .      .'-'             \\,' ,'         ,','
|                      |      ,`               ' .`         .' /
|                      |     /          ,\"`.  ' `-. _____.-' .'
'                      |..---.|,\".      | | .  .-'\"\"   __.,-'
 .                   ,'       ||,|      |.' |    |\"\"`'\"
  `-._   `._.._____  |        || |      `._,'    |
      `.   .       `\".     ,'\"| \"  `'           ,+.
        \\  '         |    '   |   .....        .'  `.
         .'          '     7  \".              ,'     \\
                   ,'      |    `..        _,'      F
                  .        |,      `'----''         |
                  |      ,\"j  /                   | '
                  `     |  | .                 | `,'
                   .    |  `.|                 |/
                    `-..'   ,'                .'
                            | \\             ,''
                            |  `,'.      _,' /
                            |    | ^.  .'   /
                             `-'.' j` V    /
                                   |      /
                                   |     /
                                   |   ,'
                                    `\"\"

//--><html lang=en> <head><meta charset=utf-8><meta name=viewport content="width=device-width, initial-scale=1.0, minimum-scale=1.0"><link rel=alternate href=https://kura.gg hreflang=en><link rel=dns-prefetch href=https://kura.gg><link href=https://kura.gg/feeds/rss.xml type=application/rss+xml rel=alternate title=kura.gg><link href=https://kura.gg/feeds/atom.xml type=application/atom+xml rel=alternate title=kura.gg><meta property=og:site_name content=kura.gg><meta property=og:type content=article><meta property=og:title content="Retrying dynamically configured upstreams with OpenResty"><meta content=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ property=og:url><meta property=og:description content='Preamble OpenResty is a modified version of nginx with LuaJIT compiled in and many nginx options that can be controlled or modified via Lua. It is very commonly used in content delivery networks for it’s configurability. As such, we use OpenResty and one of the features we use is the ability to dynamically modify upstream backends. To achieve this we use some logic within OpenResty to update upstreams based on DNS records. This means we can pull upstreams in and out of service via DNS records and have OpenResty update it’s upstream proxy passing configuration without needing to push configs out to hundreds of servers and reload daemons. The logic behind how we update the upstream backends is beyond the scope of this post, so let’s just say we have a table of upstream servers. local upstream_servers = { "10.0.0.1:443", "10.0.0.2 …'><meta property=og:image content=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/index.png><meta property=og:image:width content=1920><meta property=og:image:height content=1080><meta property=twitter:title content="Retrying dynamically configured upstreams with OpenResty"><meta content=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ property=twitter:url><meta property=twitter:description content='Preamble OpenResty is a modified version of nginx with LuaJIT compiled in and many nginx options that can be controlled or modified via Lua. It is very commonly used in content delivery networks for it’s configurability. As such, we use OpenResty and one of the features we use is the ability to dynamically modify upstream backends. To achieve this we use some logic within OpenResty to update upstreams based on DNS records. This means we can pull upstreams in and out of service via DNS records and have OpenResty update it’s upstream proxy passing configuration without needing to push configs out to hundreds of servers and reload daemons. The logic behind how we update the upstream backends is beyond the scope of this post, so let’s just say we have a table of upstream servers. local upstream_servers = { "10.0.0.1:443", "10.0.0.2 …'><meta property=twitter:image content=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/index.png><meta property=twitter:card content=summary_large_image><meta property=twitter:label1 content="Written by"><meta property=twitter:data1 content=Kura><meta property=twitter:label2 content="Estimated reading time"><meta property=twitter:data2 content="3 min read"><meta property=twitter:image:width content=1920><meta property=twitter:image:height content=1080><link rel=icon href=/favicon.png type=image/png sizes="16x16 32x32 48x48 64x64 128x128 256x256"><link rel=icon href=/favicon.ico type=image/vnd.microsoft.icon sizes="16x16 32x32 48x48 64x64 128x128 256x256"><title>Retrying dynamically configured upstreams with OpenResty</title></head> <body> <div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"> <header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader> <div class=mdl-layout__header-row> <div aria-expanded=false role=button tabindex=0 class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only"> <i class=material-icons>&#xE5D2;</i> </div> <span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top> <a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a> </h2> </span> <div class=mdl-layout-spacer role=presentation></div> <nav class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </nav> </div> </header> <div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true> <span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent"> kura.gg </h2> </span> <div class="mdl-navigation mdl-color--white"> <nav class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Header navigation"> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i class=material-icons aria-hidden=true> &#xE88A; </i> Home </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> <a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> <a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </nav> </div> </div> <div class="eevee-ribbon mdl-color--primary-dark" role=presentation> </div> <main class="eevee-main mdl-layout__content"> <div class="eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col" aria-label="Main content"> <article itemscope itemtype=http://schema.org/BlogPosting> <meta itemprop=accessibilityControl content=fullKeyboardControl> <meta itemprop=accessibilityControl content=fullMouseControl> <meta itemprop=accessibilityControl content=bookmarks> <meta itemprop=accessibilityControl content=captions> <meta itemprop=accessibilityControl content=alternativeText> <meta itemprop=accessibilityControl content=index> <meta itemprop=accessibilityControl content=readingOrder> <meta itemprop=accessibilityControl content=structuralNavigation> <meta itemprop=accessibilityControl content=tableOfContents> <meta itemprop=accessibilityHazard content=noFlashingHazard> <meta itemprop=accessibilityHazard content=noMotionSimulationHazard> <meta itemprop=accessibilityHazard content=noSoundHazard> <meta itemprop=accessibilityAPI content=ARIA> <div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation /> <a href=https://kura.gg/authors/kura/ class=hidden itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a> </div> <meta itemprop=keywords content=nginx,openresty,lua> <meta itemprop=keywords content=misc> <div class=eevee-share> <ul class="social-share mdl-navigation"> <li class="social-share__link social-share__link--twitter"> <a href="https://twitter.com/intent/tweet?text=Retrying%20dynamically%20configured%20upstreams%20with%20OpenResty&url=https%3A//kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/" title="Share 'Retrying dynamically configured upstreams with OpenResty' on Twitter" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;"> <i class=fa aria-hidden=true>&#xF099;</i> </a> </li> <li class="social-share__link social-share__link--facebook"> <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/" title="Share 'Retrying dynamically configured upstreams with OpenResty' on Facebook" onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;"> <i class=fa aria-hidden=true>&#xF09A;</i> </a> </li> <li class="social-share__link social-share__link--email"> <a href="mailto:?subject=Retrying%20dynamically%20configured%20upstreams%20with%20OpenResty&body=I%20thought%20you%20might%20like%20'Retrying%20dynamically%20configured%20upstreams%20with%20OpenResty'%20--%20https%3A//kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/" title="Share 'Retrying dynamically configured upstreams with OpenResty' via email"> <i class=material-icons aria-hidden=true> &#xE0E1; </i> </a> </li> </ul> </div> <div class=eevee-article> <div class="eevee-meta mdl-color-text--grey-500"> <time datetime=2020-08-09T17:00:00+01:00 itemprop=datePublished> 09 Aug 2020 </time>&nbsp;-- 3 min read </div> <h1 itemprop=name> <a href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ rel=bookmark title="Permalink to 'Retrying dynamically configured upstreams with OpenResty'" itemprop=url> Retrying dynamically configured upstreams with&nbsp;OpenResty </a> </h1> <section> <p> This article is part of the <span class=bold>OpenResty upstreams</span> series. </p> <ol class=series-parts> <li class=series-active> <a href=https://kura.gg/2020/08/09/retrying-dynamically-configured-upstreams-with-openresty/ title="Retrying dynamically configured upstreams with OpenResty" itemprop=url> Retrying dynamically configured upstreams with OpenResty </a> </li> <li> <a href=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ title="Configuring upstreams dynamically with DNS in OpenResty" itemprop=url> Configuring upstreams dynamically with DNS in OpenResty </a> </li> </ol> </section> <section class=eevee-toc> <h2 id=toc> Contents </h2> <nav class=eevee-toc-ribbon> <div class=toc id> <p class=topic-title>Contents</p> <ul class=simple> <li><a class="reference internal" href=#preamble id=toc-entry-1>Preamble</a></li> <li><a class="reference internal" href=#introduction-to-balancer-by-lua id=toc-entry-2>Introduction to <cite>balancer_by_lua</cite></a></li> <li><a class="reference internal" href=#fixing-retries id=toc-entry-3>Fixing retries</a></li> </ul> </div> </nav> </section> <section itemprop=articleBody class=article-content> <div class=section id=preamble> <h2>Preamble</h2> <p>OpenResty is a modified version of nginx with LuaJIT compiled in and many nginx options that can be controlled or modified via Lua. It is very commonly used in content delivery networks for it’s configurability.</p> <p>As such, we use OpenResty and one of the features we use is the ability to dynamically modify upstream backends. To achieve this we use some logic within OpenResty to update upstreams based on <span class=caps>DNS</span> records. This means we can pull upstreams in and out of service via <span class=caps>DNS</span> records and have OpenResty update it’s upstream proxy passing configuration without needing to push configs out to hundreds of servers and reload daemons.</p> <p>The logic behind how we update the upstream backends is beyond the scope of this post, so let’s just say we have a table of upstream servers.</p> <pre class="code lua literal-block">
<span class=kd>local</span> <span class=n>upstream_servers</span> <span class=o>=</span> <span class=p>{</span>
    <span class=s2>"10.0.0.1:443"</span><span class=p>,</span>
    <span class=s2>"10.0.0.2:443"</span><span class=p>,</span>
    <span class=s2>"10.0.0.3:443"</span><span class=p>,</span>
    <span class=s2>"10.0.0.4:443"</span><span class=p>,</span>
<span class=p>}</span>
</pre> </div> <div class=section id=introduction-to-balancer-by-lua> <h2>Introduction to <cite>balancer_by_lua</cite></h2> <p>In nginx you’d normally specify multiple backends in an upstream block.</p> <pre class="code nginx literal-block">
<span class=k>upstream</span><span class=w> </span><span class=s>backend</span><span class=w> </span><span class=p>{</span><span class=w>
    </span><span class=kn>server</span><span class=w> </span><span class=n>10.0.0.1</span><span class=p>:</span><span class=mi>443</span><span class=w> </span><span class=s>max_fails=3</span><span class=w> </span><span class=s>fail_timeout=3</span><span class=p>;</span><span class=w>
    </span><span class=kn>server</span><span class=w> </span><span class=n>10.0.0.2</span><span class=p>:</span><span class=mi>443</span><span class=w> </span><span class=s>max_fails=3</span><span class=w> </span><span class=s>fail_timeout=3</span><span class=p>;</span><span class=w>
    </span><span class=kn>server</span><span class=w> </span><span class=n>10.0.0.3</span><span class=p>:</span><span class=mi>443</span><span class=w> </span><span class=s>max_fails=3</span><span class=w> </span><span class=s>fail_timeout=3</span><span class=p>;</span><span class=w>
    </span><span class=kn>server</span><span class=w> </span><span class=n>10.0.0.4</span><span class=p>:</span><span class=mi>443</span><span class=w> </span><span class=s>max_fails=3</span><span class=w> </span><span class=s>fail_timeout=3</span><span class=p>;</span><span class=w>
</span><span class=p>}</span>
</pre> <p>Doing this in OpenResty with a dynamic set of backends is slightly different and requires using <cite>balancer_by_lua_block</cite> or <cite>balancer_by_lua_file</cite>.</p> <pre class="code lua literal-block">
<span class=n>upstream</span> <span class=n>backend</span> <span class=p>{</span>
    <span class=n>server</span> <span class=mf>127.0.0.1</span> <span class=n>fail_timeout</span><span class=o>=</span><span class=mi>3</span><span class=p>;</span>
    <span class=n>balancer_by_lua_block</span> <span class=p>{</span>
        <span class=kd>local</span> <span class=n>balancer</span> <span class=o>=</span> <span class=nb>require</span><span class=p>(</span><span class=s2>"ngx.balancer"</span><span class=p>)</span>
        <span class=c1>-- ...</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre> <p>Using this as a base we can get <cite>balancer_by_lua</cite> to pick a backend from our table.</p> <pre class="code lua literal-block">
<span class=n>init_by_lua_block</span> <span class=p>{</span>
    <span class=kd>local</span> <span class=n>upstream_servers</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>"10.0.0.1:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.2:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.3:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.4:443"</span><span class=p>,</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=n>upstream</span> <span class=n>backend</span> <span class=p>{</span>
    <span class=n>server</span> <span class=mf>127.0.0.1</span> <span class=n>fail_timeout</span><span class=o>=</span><span class=mi>3</span><span class=p>;</span>
    <span class=n>balancer_by_lua_block</span> <span class=p>{</span>
        <span class=kd>local</span> <span class=n>balancer</span> <span class=o>=</span> <span class=nb>require</span><span class=p>(</span><span class=s2>"ngx.balancer"</span><span class=p>)</span>

        <span class=c1>-- Pick a random backend</span>
        <span class=kd>local</span> <span class=n>server</span> <span class=o>=</span> <span class=n>upstream_servers</span><span class=p>[</span><span class=nb>math.random</span><span class=p>(</span><span class=o>#</span><span class=n>upstream_servers</span><span class=p>)]</span>

        <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_current_peer</span><span class=p>(</span><span class=n>server</span><span class=p>)</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_current_peer failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
            <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
        <span class=kr>end</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre> <p>With this block each request will pick a random server from the table and use it for reverse proxying.</p> <p>This approach is great for multiple reasons; you can dynamically update the server of backends available, you can add logic to how a backend is chosen, and more.</p> <p>The downside to this approach is in using it you are disabling nginx’s builtin retry logic.</p> </div> <div class=section id=fixing-retries> <h2>Fixing retries</h2> <p>The <cite>ngx.balancer</cite> module of OpenResty has a method for setting up retries and it’s called <cite>set_more_tries</cite>. So let’s implement it.</p> <pre class="code lua literal-block">
<span class=c1>-- DO NOT COPY AND PASTE THIS WITHOUT READING FURTHER. IT HAS A DELIBERATE</span>
<span class=c1>-- BUG TO SHOW HOW JUST USING set_more_tries WON'T WORK.</span>

<span class=n>init_by_lua_block</span> <span class=p>{</span>
    <span class=kd>local</span> <span class=n>upstream_servers</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>"10.0.0.1:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.2:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.3:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.4:443"</span><span class=p>,</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=n>upstream</span> <span class=n>backend</span> <span class=p>{</span>
    <span class=n>server</span> <span class=mf>127.0.0.1</span> <span class=n>fail_timeout</span><span class=o>=</span><span class=mi>3</span><span class=p>;</span>
    <span class=n>balancer_by_lua_block</span> <span class=p>{</span>
        <span class=kd>local</span> <span class=n>balancer</span> <span class=o>=</span> <span class=nb>require</span><span class=p>(</span><span class=s2>"ngx.balancer"</span><span class=p>)</span>

        <span class=c1>-- Pick a random backend</span>
        <span class=kd>local</span> <span class=n>server</span> <span class=o>=</span> <span class=n>upstream_servers</span><span class=p>[</span><span class=nb>math.random</span><span class=p>(</span><span class=o>#</span><span class=n>upstream_servers</span><span class=p>)]</span>

        <span class=c1>-- set up more tries using the length of the server list minus 1.</span>
        <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_more_tries</span><span class=p>(</span><span class=o>#</span><span class=n>upstream_servers</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_more_tries failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
        <span class=kr>end</span>

        <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_current_peer</span><span class=p>(</span><span class=n>server</span><span class=p>)</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_current_peer failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
            <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
        <span class=kr>end</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre> <p>This approach will allow retries to happen, but it also introduces a bug. Each time <cite>balancer_by_lua_block</cite> is called it sets <cite>set_more_tries</cite>, including for retries. Which means a client will retry endlessly.</p> <p>We can fix that using the request context.</p> <pre class="code lua literal-block">
<span class=n>init_by_lua_block</span> <span class=p>{</span>
    <span class=kd>local</span> <span class=n>upstream_servers</span> <span class=o>=</span> <span class=p>{</span>
        <span class=s2>"10.0.0.1:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.2:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.3:443"</span><span class=p>,</span>
        <span class=s2>"10.0.0.4:443"</span><span class=p>,</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=n>upstream</span> <span class=n>backend</span> <span class=p>{</span>
    <span class=n>server</span> <span class=mf>127.0.0.1</span> <span class=n>fail_timeout</span><span class=o>=</span><span class=mi>3</span><span class=p>;</span>
    <span class=n>balancer_by_lua_block</span> <span class=p>{</span>
        <span class=kd>local</span> <span class=n>balancer</span> <span class=o>=</span> <span class=nb>require</span><span class=p>(</span><span class=s2>"ngx.balancer"</span><span class=p>)</span>

        <span class=c1>-- Pick a random backend</span>
        <span class=kd>local</span> <span class=n>server</span> <span class=o>=</span> <span class=n>upstream_servers</span><span class=p>[</span><span class=nb>math.random</span><span class=p>(</span><span class=o>#</span><span class=n>upstream_servers</span><span class=p>)]</span>

        <span class=c1>-- This block will only trigger if ngx.ctx.retry is not true.</span>
        <span class=c1>-- We set this to true during the initial request so future</span>
        <span class=c1>-- requests within this context will not go down this path.</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>ctx</span><span class=p>.</span><span class=n>retry</span> <span class=o>=</span> <span class=kc>true</span>
            <span class=c1>-- set up more tries using the length of the server list minus 1.</span>
            <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_more_tries</span><span class=p>(</span><span class=o>#</span><span class=n>upstream_servers</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span>
            <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
                <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_more_tries failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
            <span class=kr>end</span>
        <span class=kr>end</span>

        <span class=n>ok</span><span class=p>,</span> <span class=n>err</span> <span class=o>=</span> <span class=n>balancer</span><span class=p>.</span><span class=n>set_current_peer</span><span class=p>(</span><span class=n>server</span><span class=p>)</span>
        <span class=kr>if</span> <span class=ow>not</span> <span class=n>ok</span> <span class=kr>then</span>
            <span class=n>ngx</span><span class=p>.</span><span class=n>log</span><span class=p>(</span><span class=n>ngx</span><span class=p>.</span><span class=n>ERR</span><span class=p>,</span> <span class=s2>"set_current_peer failed: "</span><span class=p>,</span> <span class=n>err</span><span class=p>)</span>
            <span class=kr>return</span> <span class=n>ngx</span><span class=p>.</span><span class=n>exit</span><span class=p>(</span><span class=mi>500</span><span class=p>)</span>
        <span class=kr>end</span>
    <span class=p>}</span>
<span class=p>}</span>
</pre> <p>Obviously this approach isn’t perfect. It picks a random backend server to use for the initial request and for retries, which means a client could get unlucky and hit the same bad backend multiple times. This is just an example of what you can do with OpenResty and Lua.</p> </div> </section> </div> <div class=eevee-related> <section> <h2>Related articles</h2> <ul> <li> <a href=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ rel=bookmark title="Permalink to 'Configuring upstreams dynamically with DNS in OpenResty'" itemprop=url> Configuring upstreams dynamically with <span class=caps>DNS</span> in&nbsp;OpenResty </a> </li> <li> <a href=https://kura.gg/2014/02/06/nnginx-1.5.10-with-spdy3.1/ rel=bookmark title="Permalink to 'nginx 1.5.10 with SPDY 3.1'" itemprop=url> nginx 1.5.10 with <span class=caps>SPDY</span>&nbsp;3.1 </a> </li> <li> <a href=https://kura.gg/2014/02/02/nginx-1.5.9-and-ngx_pagespeed-1.7.30.3-beta/ rel=bookmark title="Permalink to 'nginx 1.5.9 and ngx_pagespeed 1.7.30.3-beta'" itemprop=url> nginx 1.5.9 and ngx_pagespeed&nbsp;1.7.30.3-beta </a> </li> <li> <a href=https://kura.gg/2014/01/08/haproxy1.5-dev21-nginx-1.5.8-spdy-pagespeed-1.7.30.2/ rel=bookmark title="Permalink to 'haproxy1.5-dev21, nginx 1.5.8, SPDY & pagespeed 1.7.30.2'" itemprop=url> haproxy1.5-dev21, nginx 1.5.8, <span class=caps>SPDY</span> <span class=amp>&amp;</span> pagespeed&nbsp;1.7.30.2 </a> </li> <li> <a href=https://kura.gg/2013/07/15/haproxy-nginx-and-spdy-with-ssl-termination-debian-7/ rel=bookmark title="Permalink to 'haproxy, nginx and SPDY with SSL termination (Debian 7)'" itemprop=url> haproxy, nginx and <span class=caps>SPDY</span> with <span class=caps>SSL</span> termination (Debian&nbsp;7) </a> </li> </ul> </section> </div> <div class=eevee-ac> <header class=eevee-ac__header> <div class=eevee-ac-author__text> <h2>Kura</h2> <p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.</p> <p> <a href=https://kura.gg/authors/kura/ itemprop=url title="Read more articles by Kura"> Read more articles by Kura </a> </p> <nav> <ul class=eevee-ac-author__social> <li class=eevee-ac-author-social__link> <a class="mdl-color-text--accent mdl-navigation__link" href=https://github.com/kura itemprop=url rel=bookmark title="kura on GitHub"> <i class=fa aria-hidden=true>&#xF09B;</i> </a> </li> </ul> </nav> </div> <img src=/images/avatar-glitch.png class=eevee-ac-author__avatar alt=Kura> </header> </div> </article> <a href=https://github.com/kura/kura.gg/blob/main/content/retrying-dynamically-configured-upstreams-with-openresty.rst id=view-source title="View 'Retrying dynamically configured upstreams with OpenResty' on GitHub" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white"> <i class=material-icons>&#xE86F;</i> View Source </a> </div> </div> </main> <div class="eevee-pagination__container eevee-container mdl-grid"> <div role=presentation class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone"> </div> <div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"> <nav class="eevee-pagination mdl-cell mdl-cell--12-col" itemscope itemtype=http://schema.org/SiteNavigationElement aria-label=Pagination> <a href=https://kura.gg/2020/08/30/configuring-upstreams-dynamically-with-dns-in-openresty/ class=eevee-nav__button itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C4;</i> </button> Newer </a> <div class=eevee-spacer></div> <a href=https://kura.gg/2016/06/25/eevee-adding-more-structure-to-posts/ class=eevee-nav__button itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation> <i class=material-icons>&#xE5C8;</i> </button> </a> </nav> </div> </div> <footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement> <div class=mdl-mega-footer--top-section> <div class=mdl-mega-footer--drop-down-section> <ul class=mdl-mega-footer--link-list> <li> <a href=#top itemprop=url title="Back to the top of the page"> Back to the top of the page </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement aria-label="Footer navigation"> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Menu</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/contact/ itemprop=url rel=bookmark title=Contact> <i class=material-icons aria-hidden=true>&#xE0B7;</i> Contact </a> </li> <li> <a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>&#xE02F;</i> Archives </a> </li> <li> <a href=https://kura.gg/feeds/rss.xml title=RSS itemprop=url> <i class=material-icons>&#xE0E5;</i> RSS </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Social</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i class=fa aria-hidden=true>&#xF09B;</i> Github </a> </li> </ul> </div> <div class=mdl-mega-footer--drop-down-section> <h1 class=mdl-mega-footer--heading>Links</h1> <ul class=mdl-mega-footer--link-list> <li> <a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i class=material-icons aria-hidden=true>&#xE86F;</i> Blackhole </a> </li> <li> <a href=/eevee itemprop=url rel=bookmark title=Eevee> <i class=material-icons aria-hidden=true>&#xE871;</i> Eevee </a> </li> <li> <a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i class=material-icons aria-hidden=true>&#xE871;</i> Hauntr </a> </li> <li> <a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i class=material-icons aria-hidden=true>&#xE871;</i> Ghastly </a> </li> <li> <a href=/pelican-plugins itemprop=url rel=bookmark title="Pelican Plugins"> <i class=material-icons aria-hidden=true>&#xE86F;</i> Pelican Plugins </a> </li> </ul> </div> </div> <div class=mdl-mega-footer--bottom-section> <div class=mdl-logo> <a href=https://kura.gg rel=bookmark itemprop=url title=kura.gg> kura.gg </a> </div> <ul class="eevee-footer mdl-mega-footer--link-list"> <li>Powered by love &amp; rainbow sparkles.</li> <li>Source code and content released under the <a href=/license/ title="MIT license">MIT license</a>.</li> </ul> </div> </footer> </div> <link rel=stylesheet href=https://kura.gg/theme/css/eevee.min.css?1c9d8344> <script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script> </body> </html>