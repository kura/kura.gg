<!DOCTYPE html>
<!--

                                      |
                                     /|
                                   ,' |
                                  .   |
                                    | |
                                 ' '| |
                                / / | |
       _,.-\"\"--._              / /  | |
     ,'          `.           j '   ' '
   ,'              `.         ||   / ,                         ___..--,
  /                  \\        ' `.'`.-.,-\".  .       _..---\"\"'' __, ,'
 /                    \\        \\` .\"`      `\"'\\   ,'\"_..--''\"\"\"'.'.'
.                      .      .'-'             \\,' ,'         ,','
|                      |      ,`               ' .`         .' /
|                      |     /          ,\"`.  ' `-. _____.-' .'
'                      |..---.|,\".      | | .  .-'\"\"   __.,-'
 .                   ,'       ||,|      |.' |    |\"\"`'\"
  `-._   `._.._____  |        || |      `._,'    |
      `.   .       `\".     ,'\"| \"  `'           ,+.
        \\  '         |    '   |   .....        .'  `.
         .'          '     7  \".              ,'     \\
                   ,'      |    `..        _,'      F
                  .        |,      `'----''         |
                  |      ,\"j  /                   | '
                  `     |  | .                 | `,'
                   .    |  `.|                 |/
                    `-..'   ,'                .'
                            | \\             ,''
                            |  `,'.      _,' /
                            |    | ^.  .'   /
                             `-'.' j` V    /
                                   |      /
                                   |     /
                                   |   ,'
                                    `\"\"

//-->
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, minimum-scale=1.0" />
  <link rel="alternate" href="../../../.." hreflang="en" />
<link rel="dns-prefetch" href="../../../.." />
  <link rel="stylesheet" href="../../../../theme/webassets-external/63377f06b1648775b11ff8e169b4a710_material.yellow-amber.min.css" />
  <link rel="stylesheet" href="../../../../theme/webassets-external/c335929e0083dac14c3a8f107c05dde3_font-awesome.css" />
  <link rel="stylesheet" href="../../../../theme/webassets-external/14c05c94e27da637bc780ad514251b18_material-icons.css" />
  <link rel="stylesheet" href="../../../../theme/webassets-external/a28e8d0a2ff230dae7c257a9f828e3b1_pygments.css" />
  <link rel="stylesheet" href="../../../../theme/webassets-external/0eddd53a34a33f68e0c593881131a436_eevee.css" />
  <link rel="stylesheet" href="../../../../theme/webassets-external/2f21b66ec2ab0b874a1f30d00028e286_custom.css" />
  <script async src="../../../../theme/webassets-external/a7fbc4b6cecaeb63ed7b7d6e2f75e649_material.js"></script>
  <link href="../../../../feeds/rss.xml" type="application/rss+xml"
        rel="alternate" title="kura.gg" />
  <link href="../../../../feeds/atom.xml" type="application/atom+xml"
        rel="alternate" title="kura.gg" />
  <meta property="og:site_name" content="kura.gg" />
  <meta property="og:type" content="article" />
    <meta property="og:title"
          content="Blackhole 2.0: or, How I Learned to Love Asyncio" />
    <meta property="og:url"
          content="../../../../2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/" />
    <meta property="og:description"
          content="A brief history of a tiny part of the Internet. Blackhole 1 — Blackhole as it was originally known — was written on Python 2.7, briefly supporting Python 2.6 for a time and also supporting early version of Python 3, PyPy 2 and PyPy 3. Built on top of Tornado, it was asynchronous in a fashion and — quite simply — worked. The original prototype that became Blackhole was SimpleMTA — a prototype that was created quickly, to serve a very simple testing purpose that I had for it. As I needed SimpleMTA to do more, I wrote Blackhole to accomplish that task. I’d been using Tornado a bit and wanted to experiment with it more. Building on top of Tornado created some oddities in how the program was designed and that always irked me. Between the time of the last 1.8.X and the 2.0 release, I experimented with …" />
    <meta property="og:image"
          content="../../../../2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/index.png" />
  <meta property="og:image:width" content="1920" />
  <meta property="og:image:height" content="1080" />
    <meta property="twitter:title"
          content="Blackhole 2.0: or, How I Learned to Love Asyncio" />
    <meta property="twitter:url"
          content="../../../../2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/" />
    <meta property="twitter:description"
          content="A brief history of a tiny part of the Internet. Blackhole 1 — Blackhole as it was originally known — was written on Python 2.7, briefly supporting Python 2.6 for a time and also supporting early version of Python 3, PyPy 2 and PyPy 3. Built on top of Tornado, it was asynchronous in a fashion and — quite simply — worked. The original prototype that became Blackhole was SimpleMTA — a prototype that was created quickly, to serve a very simple testing purpose that I had for it. As I needed SimpleMTA to do more, I wrote Blackhole to accomplish that task. I’d been using Tornado a bit and wanted to experiment with it more. Building on top of Tornado created some oddities in how the program was designed and that always irked me. Between the time of the last 1.8.X and the 2.0 release, I experimented with …" />
    <meta property="twitter:image"
          content="../../../../2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/index.png" />
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:label1" content="Written by" />
    <meta property="twitter:data1" content="Kura" />
      <meta property="twitter:label2" content="Estimated reading time" />
      <meta property="twitter:data2" content="7 min read" />
  <meta property="twitter:image:width" content="1920" />
  <meta property="twitter:image:height" content="1080" />
  <link rel="icon" href="/favicon.png" type="image/png"
        sizes="16x16 32x32 48x48 64x64 128x128 256x256" />
  <link rel="icon" href="/favicon.ico" type="image/vnd.microsoft.icon"
        sizes="16x16 32x32 48x48 64x64 128x128 256x256" />
  <title>Blackhole 2.0: or, How I Learned to Love Asyncio</title>
</head>
<body>
  <div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50">
    <header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800"
            itemscope itemtype="http://schema.org/WPHeader">
      <div class="mdl-layout__header-row">
        <div aria-expanded="false" role="button" tabindex="0"
             class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only">
          <i class="material-icons">&#xE5D2;</i>
        </div>
        <span class="eevee-logo mdl-color-text--accent mdl-layout-title">
          <h2 id="top">
            <a href="../../../.." rel="bookmark" title="kura.gg">
              kura.gg
            </a>
          </h2>
        </span>
        <div class="mdl-layout-spacer" role="presentation"></div>
        <nav class="eevee-nav mdl-navigation mdl-layout--large-screen-only"
             itemscope itemtype="http://schema.org/SiteNavigationElement"
             aria-label="Header navigation">
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/blackhole" itemprop="url" rel="bookmark" title="Blackhole">
    <i class="material-icons" aria-hidden="true">&#xE86F;</i> Blackhole
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/eevee" itemprop="url" rel="bookmark" title="Eevee">
    <i class="material-icons" aria-hidden="true">&#xE871;</i> Eevee
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/hauntr" itemprop="url" rel="bookmark" title="Hauntr">
    <i class="material-icons" aria-hidden="true">&#xE871;</i> Hauntr
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/ghastly" itemprop="url" rel="bookmark" title="Ghastly">
    <i class="material-icons" aria-hidden="true">&#xE871;</i> Ghastly
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/pelican-plugins" itemprop="url" rel="bookmark" title="Pelican Plugins">
    <i class="material-icons" aria-hidden="true">&#xE86F;</i> Pelican Plugins
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/contact/" itemprop="url" rel="bookmark" title="Contact">
    <i class="material-icons" aria-hidden="true">&#xE0B7;</i> Contact
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="../../../../archives/"
     itemprop="url" rel="bookmark" title="Archives">
    <i class="material-icons">&#xE02F;</i>
    Archives
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="../../../../feeds/rss.xml"
     title="RSS" itemprop="url">
    <i class="material-icons">&#xE0E5;</i>
    RSS
  </a>
        </nav>
      </div>
    </header>
    <div class="eevee-mobile-header mdl-layout__drawer mdl-color--white"
         aria-hidden="true">
      <span class="mdl-layout-title">
        <h2 class="eevee-mobile-logo mdl-color-text--accent">
          kura.gg
        </h2>
      </span>
      <div class="mdl-navigation mdl-color--white">
        <nav class="eevee-nav mdl-navigation" itemscope
             itemtype="http://schema.org/SiteNavigationElement"
             aria-label="Header navigation">
          <a class="mdl-color-text--accent mdl-navigation__link"
             href="../../../.." itemprop="url" rel="bookmark">
            <i class="material-icons" aria-hidden="true">
              &#xE88A;
            </i> Home
          </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/blackhole" itemprop="url" rel="bookmark" title="Blackhole">
    <i class="material-icons" aria-hidden="true">&#xE86F;</i> Blackhole
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/eevee" itemprop="url" rel="bookmark" title="Eevee">
    <i class="material-icons" aria-hidden="true">&#xE871;</i> Eevee
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/hauntr" itemprop="url" rel="bookmark" title="Hauntr">
    <i class="material-icons" aria-hidden="true">&#xE871;</i> Hauntr
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/ghastly" itemprop="url" rel="bookmark" title="Ghastly">
    <i class="material-icons" aria-hidden="true">&#xE871;</i> Ghastly
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/pelican-plugins" itemprop="url" rel="bookmark" title="Pelican Plugins">
    <i class="material-icons" aria-hidden="true">&#xE86F;</i> Pelican Plugins
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="/contact/" itemprop="url" rel="bookmark" title="Contact">
    <i class="material-icons" aria-hidden="true">&#xE0B7;</i> Contact
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="../../../../archives/"
     itemprop="url" rel="bookmark" title="Archives">
    <i class="material-icons">&#xE02F;</i>
    Archives
  </a>
  <a class="mdl-color-text--accent mdl-navigation__link"
     href="../../../../feeds/rss.xml"
     title="RSS" itemprop="url">
    <i class="material-icons">&#xE0E5;</i>
    RSS
  </a>
        </nav>
      </div>
    </div>
    <div class="eevee-ribbon mdl-color--primary-dark" role="presentation">
    </div>
    <main class="eevee-main mdl-layout__content">
      <div class="eevee-container mdl-grid">
        <div role="presentation"
             class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone">
        </div>
        <div class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"
             aria-label="Main content">
  <article itemscope itemtype="http://schema.org/BlogPosting">
<meta itemprop="accessibilityControl" content="fullKeyboardControl" />
<meta itemprop="accessibilityControl" content="fullMouseControl" />
<meta itemprop="accessibilityControl" content="bookmarks" />
<meta itemprop="accessibilityControl" content="captions" />
<meta itemprop="accessibilityControl" content="alternativeText" />
<meta itemprop="accessibilityControl" content="index" />
<meta itemprop="accessibilityControl" content="readingOrder" />
<meta itemprop="accessibilityControl" content="structuralNavigation" />
<meta itemprop="accessibilityControl" content="tableOfContents" />
<meta itemprop="accessibilityHazard" content="noFlashingHazard" />
<meta itemprop="accessibilityHazard" content="noMotionSimulationHazard" />
<meta itemprop="accessibilityHazard" content="noSoundHazard" />
<meta itemprop="accessibilityAPI" content="ARIA" />
  <div itemprop="author" itemscope
       itemtype="https://schema.org/Person" role="presentation" />
    <a href="../../../../authors/kura/" class="hidden"
       itemprop="url" role="presentation">
      <span class="hidden" itemprop="name" role="presentation">
        kura
      </span>
    </a>
  </div>
    <meta itemprop="keywords"
          content="python,python3.5,3.5,asyncio,email,smtp,mta" />
    <meta itemprop="keywords" content="coding" />
  <div class="eevee-share">
    <ul class="social-share mdl-navigation">
      <li class="social-share__link social-share__link--twitter">
        <a href="https://twitter.com/intent/tweet?text=Blackhole%202.0%3A%20or%2C%20How%20I%20Learned%20to%20Love%20Asyncio&amp;url=../../../../2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/"
           title="Share 'Blackhole 2.0: or, How I Learned to Love Asyncio' on Twitter"
           onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;">
          <i class="fa" aria-hidden="true">&#xF099;</i>
        </a>
      </li>
      <li class="social-share__link social-share__link--facebook">
        <a href="https://www.facebook.com/sharer/sharer.php?u=../../../../2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/"
           title="Share 'Blackhole 2.0: or, How I Learned to Love Asyncio' on Facebook"
           onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;">
          <i class="fa" aria-hidden="true">&#xF09A;</i>
        </a>
      </li>
      <li class="social-share__link social-share__link--email">
        <a href="mailto:?subject=Blackhole%202.0%3A%20or%2C%20How%20I%20Learned%20to%20Love%20Asyncio&amp;body=I%20thought%20you%20might%20like%20'Blackhole%202.0%3A%20or%2C%20How%20I%20Learned%20to%20Love%20Asyncio'%20--%20../../../../2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/"
           title="Share 'Blackhole 2.0: or, How I Learned to Love Asyncio' via email">
          <i class="material-icons" aria-hidden="true">
            &#xE0E1;
          </i>
        </a>
      </li>
    </ul>
  </div>
    <div class="eevee-article">
      <div class="eevee-meta mdl-color-text--grey-500">
        <time datetime="2016-05-21T00:20:00+01:00"
              itemprop="datePublished">
          21 May 2016
        </time>&nbsp;-- 7 min read      </div>
      <h1 itemprop="name">
        <a href="../../../../2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/" rel="bookmark"
           title="Permalink to 'Blackhole 2.0: or, How I Learned to Love Asyncio'" itemprop="url">
          Blackhole 2.0: or, How I Learned to Love&nbsp;Asyncio
        </a>
      </h1>
  <section class="eevee-toc">
    <h2 id="toc">
        Contents
    </h2>
    <nav class="eevee-toc-ribbon">
      <div class="toc" id="">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#enter-asyncio" id="toc-entry-1">Enter asyncio</a></li>
<li><a class="reference internal" href="#all-i-see-are-bytes" id="toc-entry-2">All I see are bytes</a></li>
<li><a class="reference internal" href="#getting-to-grips-with-asyncio" id="toc-entry-3">Getting to grips with asyncio</a></li>
<li><a class="reference internal" href="#show-me-the-code" id="toc-entry-4">Show me the code</a></li>
<li><a class="reference internal" href="#lambda-woes-aka-use-functools-partial" id="toc-entry-5">lambda woes aka. use functools.partial</a></li>
<li><a class="reference internal" href="#so-is-asyncio-any-good" id="toc-entry-6">So is asyncio any good?</a></li>
</ul>
</div>
    </nav>
  </section>
      <section itemprop="articleBody" class="article-content">
        
<p>A brief history of a tiny part of the Internet.</p>
<p><a class="reference external" href="https://blackhole.io/1">Blackhole 1 — Blackhole as it was originally
known</a> — was written on <a class="reference external" href="https://docs.python.org/2/whatsnew/2.7.html">Python 2.7</a>, briefly supporting <a class="reference external" href="https://docs.python.org/2.6/whatsnew/2.6.html">Python 2.6</a> for a time and also
supporting early version of <a class="reference external" href="https://docs.python.org/3.2/whatsnew/3.2.html">Python 3</a>, <a class="reference external" href="https://www.pypy.org/features.html">PyPy 2</a> and <a class="reference external" href="https://www.pypy.org/features.html">PyPy 3</a>. Built on top of <a class="reference external" href="https://www.tornadoweb.org/en/stable/">Tornado</a>, it was asynchronous in a fashion and
— quite simply — worked.</p>
<p>The original prototype that became Blackhole was <a class="reference external" href="/simplemta">SimpleMTA</a> — a
prototype that was created quickly, to serve a very simple testing purpose that
I had for it.</p>
<p>As I needed SimpleMTA to do more, I wrote Blackhole to accomplish that task.
I’d been using Tornado a bit and wanted to experiment with it more. Building
on top of Tornado created some oddities in how the program was designed and
that always irked me.</p>
<p>Between the time of the last 1.8.X and the 2.0 release, I experimented with
rewriting the program on top of various libraries. The most obvious of these
was <a class="reference external" href="https://twistedmatrix.com/trac/">Twisted</a>. I’ve always been a fan of
Twisted but I don’t like <tt class="docutils literal">theFormattingOfItsFunctionNames</tt> and — like too
much of a good thing — callbacks can be bad for you.</p>
<p>Another experiment was built on top of the old <a class="reference external" href="https://docs.python.org/2/library/asyncore.html">asyncore</a> and <a class="reference external" href="https://docs.python.org/2/library/asynchat.html">asynchat</a> standard library modules. A
branch of Blackhole 1.8 is indeed built and in working order built on top of
these very modules. Although never merged and released in the wild.</p>
<div class="section" id="enter-asyncio">
<h2>Enter asyncio</h2>
<p>Originating as <a class="reference external" href="https://github.com/python/asyncio">Tulip</a> and merged in to
the Python standard library in <a class="reference external" href="https://docs.python.org/3.4/whatsnew/3.4.html">Python 3.4</a>, asyncio looked like a great
module to achieve what I wanted to achieve and to force me to actually use
Python 3.</p>
<p>With <a class="reference external" href="https://docs.python.org/3.5/whatsnew/3.5.html">Python 3.5</a> came the
<a class="reference external" href="https://docs.python.org/3.5/reference/compound_stmts.html#async-def">async def</a>
declaration, the <a class="reference external" href="https://docs.python.org/3.5/reference/expressions.html#await">await</a> expression and
the <a class="reference external" href="https://docs.python.org/3.5/reference/compound_stmts.html#async-for">async for</a> statement.</p>
<p>Since Blackhole is a tool written by me, for me and exposed as a service, it
made complete sense for me to jump-in-at-the-deep-end as it were and rewrite
the entirety of the software specifically for Python 3.5.</p>
<p>Doing so meant I bypassed the need to use the <tt class="docutils literal">@coroutine</tt> decorator and the
<tt class="docutils literal">yield from</tt> expression, instead using their 3.5 equivalents in <tt class="docutils literal">async def</tt>
and <tt class="docutils literal">await</tt> respectively.</p>
</div>
<div class="section" id="all-i-see-are-bytes">
<h2>All I see are bytes</h2>
<p>The trickest part for me was forcing myself to remember that the data passed
to and from the socket in Python 3 are bytes.</p>
<p>That took a little while of constantly smashing my head in to my desk to
realise and remember. If something didn’t work during development, it was
always because I forgot to use <tt class="docutils literal">.encode()</tt> or <tt class="docutils literal">.decode()</tt>.</p>
</div>
<div class="section" id="getting-to-grips-with-asyncio">
<h2>Getting to grips with asyncio</h2>
<p>I can honestly say that, with a little reading and checking out how some
libraries like <a class="reference external" href="https://github.com/KeepSafe/aiohttp">aiohttp</a> work, I got to
grips with the actual <tt class="docutils literal">asyncio</tt> module pretty quickly.</p>
<p>I found using the <tt class="docutils literal">async def</tt> and <tt class="docutils literal">await</tt> syntax made it even easier for me
to read and write the code, because I instantly knew how a function I’d written
previously should work, simply by looking at it’s declaration. Something I
have sometimes forgotten when passing callbacks all over the place.</p>
</div>
<div class="section" id="show-me-the-code">
<h2>Show me the code</h2>
<p>So, let’s take a specific task and look at the code that handles it, written
on top of asyncio in Python 3.5.</p>
<p>First up I’ll show the method that waits for data to be received on the socket.</p>
<div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Wait for data from the client.</span>
<span class="sd">    :returns: A line of received data.</span>
<span class="sd">    :rtype: :any:`str`</span>
<span class="sd">    .. note::</span>
<span class="sd">       Also handles client timeouts if they wait too long before sending</span>
<span class="sd">       data. -- https://blackhole.io/configuration-options.html#timeout</span>
<span class="sd">    """</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_closed</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                                          <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">()</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">line</span>
</pre></div>
<p>This function waits for data to be received from a client and returns it once
it’s been received.</p>
<div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>
<p>The declaration of this function is different to how you’d write it for Python
3.4 or lower.</p>
<p>The equivalent of this declaration for Python 3.4 is as follows:</p>
<div class="highlight"><pre><span></span><span class="nd">@coroutine</span>
<span class="k">def</span> <span class="nf">wait</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</pre></div>
<p>Both ways declare that the function is an asynchronous coroutine.</p>
<div class="highlight"><pre><span></span><span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">connection_close</span><span class="p">:</span>
</pre></div>
<p>This line does exactly what you’d expect, it runs the while loop until
<tt class="docutils literal">self.connection_closed</tt> does not equal <tt class="docutils literal">False</tt> or until the loop is exited
for another reason.</p>
<p>This simply allows the connection handler to have connection state and stop
waiting for data if the connection is terminated elsewhere. Because the
entire program is asynchronous, the connection state may get modified elsewhere
while this method is still waiting for new data.</p>
<p>The <tt class="docutils literal">try except</tt> block actually works with the while statement.</p>
<div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">timeout</span><span class="p">,</span>
                                  <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
</pre></div>
<p>It’s easier to explain the arguments of the <tt class="docutils literal">wait_for</tt> method before anything else.</p>
<p><tt class="docutils literal">self._reader.readline()</tt> reads a line of data from a socket stream,
<tt class="docutils literal">self.config.timeout</tt> is the maximum time in seconds to wait for data, for
the sake of this example, let’s call it <tt class="docutils literal">10</tt> and finally <tt class="docutils literal">loop=self.loop</tt>
sets the event loop that the code executes on.</p>
<p><tt class="docutils literal">asyncio.wait_for</tt> creates an asynchronous task that waits for the
<tt class="docutils literal">self._reader.readline()</tt> future to complete or raises an
<tt class="docutils literal">asyncio.TimeoutError</tt> if the future does not complete within the time limit.</p>
<p>As a example.</p>
<div class="highlight"><pre><span></span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait_for</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_reader</span><span class="o">.</span><span class="n">readline</span><span class="p">(),</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
<p>Would wait for data for 10 seconds before raising a timeout error.</p>
<div class="highlight"><pre><span></span><span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">TimeoutError</span><span class="p">:</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span><span class="p">()</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>
<p>How the exception is handled shows how the <tt class="docutils literal">while</tt> statement is used. When a
timeout exception is raised, part of the code that handles that in the
<tt class="docutils literal">self.timeout()</tt> method changes the <tt class="docutils literal">connection_closed</tt> value.</p>
<p>And finally the data received is returned.</p>
<div class="highlight"><pre><span></span><span class="k">return</span> <span class="n">line</span>
</pre></div>
<p>Without going in to too much detail, below is the piece of code for handling
a timeout and terminating a connection, setting <tt class="docutils literal">connection_closed</tt> to exit
all possibly running <tt class="docutils literal">while</tt> loops.</p>
<div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""</span>
<span class="sd">    Timeout a client connection.</span>
<span class="sd">    Sends the 421 timeout message to the client and closes the connection.</span>
<span class="sd">    https://blackhole.io/configuration-options.html#timeout</span>
<span class="sd">    """</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="mi">421</span><span class="p">,</span> <span class="s1">'Timeout'</span><span class="p">)</span>
    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Close the connection from the client."""</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_writer</span><span class="o">.</span><span class="n">drain</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_connection_closed</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<div class="section" id="lambda-woes-aka-use-functools-partial">
<h2>lambda woes aka. use functools.partial</h2>
<p>Later in the development of the new version of blackhole I added a feature
called <tt class="docutils literal">flags</tt>. These flags allow multiple listeners to be configured with
different runtime parameters. i.e. bounce all emails received on port 587
while accepting all emails received on port 25.</p>
<p>These flags allow flexibility to control how email is handled on any specified port.</p>
<p>It was during development of this feature that I discovered using a lambda
rather than a partial object from functools didn’t work quite how I was
expecting it to.</p>
<p>The original piece of code iterated over each socket object and created an
asyncio server object for that socket as below.</p>
<div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Create an asyncio 'server' for each socket."""</span>
    <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">socks</span><span class="p">:</span>
        <span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_server</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">Smtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">),</span>
                                               <span class="o">**</span><span class="n">sock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
</pre></div>
<p>I wanted to change this code to pass in a set of flags that also belonged to
that specific socket, as below.</p>
<div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Create an asyncio 'server' for each socket."""</span>
    <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">socks</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">sock</span><span class="p">[</span><span class="s1">'flags'</span><span class="p">]</span>
        <span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_server</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">Smtp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">,</span>
                                                            <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">),</span>
                                               <span class="o">**</span><span class="n">sock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
</pre></div>
<p>Can you spot the problem?</p>
<p>When using a lambda in that context, creating an anonymous function to pass to
the <tt class="docutils literal">create_server</tt> method, I discovered the flag arguments were incorrect.
In fact, none of the sockets had their correct flags set, they were being
jumbled up instead of being used as expected.</p>
<p>I’m not sure why that’s the case and I never actually looked it up to find out
why either. I knew the way to fix it was to use <tt class="docutils literal">functools.partial</tt> and it’s
also a nice, cleaner way to do it so I did.</p>
<div class="highlight"><pre><span></span><span class="k">async</span> <span class="k">def</span> <span class="nf">_start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">"""Create an asyncio 'server' for each socket."""</span>
    <span class="k">for</span> <span class="n">sock</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">socks</span><span class="p">:</span>
        <span class="n">flags</span> <span class="o">=</span> <span class="n">sock</span><span class="p">[</span><span class="s1">'flags'</span><span class="p">]</span>
        <span class="n">factory</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">Smtp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">clients</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="n">flags</span><span class="p">)</span>
        <span class="n">server</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_server</span><span class="p">(</span><span class="n">factory</span><span class="p">,</span> <span class="o">**</span><span class="n">sock</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="so-is-asyncio-any-good">
<h2>So is asyncio any good?</h2>
<p>I’m going to roundup this article with this possibly loaded and difficult question.</p>
<p>Well, is it?</p>
<p>In my eyes, yes. I have to admit that this is the first time in a very long
time — possibly ever — that I have fallen so head-over-heels in-love with a
library or module.</p>
<p>I went from someone that didn’t use Python 3 and grudgingly added Python 3
support to libraries I’ve written, to someone that only uses Python 3.5 now.</p>
<p>I haven’t use asyncio with Python 3.4 and I probably never will, I like the
3.5-only syntax changes far too much to go backwards and start using the
<tt class="docutils literal">@coroutine</tt> decorator and <tt class="docutils literal">yield from</tt> statement.</p>
<p>My only gripe is that currently <span class="caps">STARTTLS</span> is not supported. Hopefully that will
arrive in the not-so-distant future and I understand why it’s currently not supported.</p>
</div>

      </section>
    </div>
  <div class="eevee-related">
    <section>
      <h2>Related articles</h2>
      <ul>
          <li>
            <a href="../../../../2013/07/17/djugl-june-2013-talk-on-blackhole-and-blackhole-io/"
               rel="bookmark"
               title="Permalink to 'DJUGL June 2013 talk on blackhole and blackhole.io'"
               itemprop="url">
              <span class="caps">DJUGL</span> June 2013 talk on blackhole and&nbsp;blackhole.io
            </a>
          </li>
          <li>
            <a href="../../../../2021/10/14/google-workspace-gmail-mx-dnssec-signed/"
               rel="bookmark"
               title="Permalink to 'Google Workspace Gmail MX records signed with DNSSEC'"
               itemprop="url">
              Google Workspace Gmail <span class="caps">MX</span> records signed with <span class="caps">DNSSEC</span>
            </a>
          </li>
          <li>
            <a href="../../../../2014/09/15/batfish-writing-a-digital-ocean-v2-api-wrapper/"
               rel="bookmark"
               title="Permalink to 'batfish(1) - writing a Digital Ocean V2 API wrapper'"
               itemprop="url">
              batfish(1) - writing a Digital Ocean V2 <span class="caps">API</span>&nbsp;wrapper
            </a>
          </li>
          <li>
            <a href="../../../../2014/08/09/yarg/"
               rel="bookmark"
               title="Permalink to 'yarg(1) — A semi hard Cornish cheese, also queries PyPI'"
               itemprop="url">
              yarg(1) &#8212; A semi hard Cornish cheese, also queries&nbsp;PyPI
            </a>
          </li>
          <li>
            <a href="../../../../2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/"
               rel="bookmark"
               title="Permalink to 'Speeding up pypip.in and reducing load on PyPI'"
               itemprop="url">
              Speeding up pypip.in and reducing load on&nbsp;PyPI
            </a>
          </li>
      </ul>
    </section>
  </div>
  <div class="eevee-ac">
    <header class="eevee-ac__header">
      <div class="eevee-ac-author__text">
        <h2>Kura</h2>
          <p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.</p>
          <p>
            <a href="../../../../authors/kura/"
               itemprop="url"
               title="Read more articles by Kura">
              Read more articles by Kura
            </a>
          </p>
        <nav>
          <ul class="eevee-ac-author__social">
              <li class="eevee-ac-author-social__link">
                <a class="mdl-color-text--accent mdl-navigation__link"
                   href="https://github.com/kura" itemprop="url" rel="bookmark"
                   title="kura on GitHub">
                  <i class="fa" aria-hidden="true">&#xF09B;</i>
                </a>
              </li>
          </ul>
        </nav>
      </div>
      <img src="/images/avatar.png" class="eevee-ac-author__avatar"
           alt="Kura" />
    </header>
  </div>
  </article>
  <a href="https://github.com/kura/kura.gg/blob/main/content/blackhole-2.0-or-how-i-learned-to-love-asyncio.rst"
     id="view-source" title="View 'Blackhole 2.0: or, How I Learned to Love Asyncio' on GitHub"
     class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white">
    <i class="material-icons">&#xE86F;</i> View Source
  </a>
        </div>
      </div>
    </main>
      <div class="eevee-pagination__container eevee-container mdl-grid">
        <div role="presentation"
             class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone">
        </div>
        <div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col">
<nav class="eevee-pagination mdl-cell mdl-cell--12-col" itemscope
     itemtype="http://schema.org/SiteNavigationElement"
     aria-label="Pagination">
    <a href="../../../../2016/06/12/eevee-a-material-design-theme-for-pelican/"
       class="eevee-nav__button" itemprop="url" rel="bookmark"
       title="Newer">
      <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900"
              role="presentation">
        <i class="material-icons">&#xE5C4;</i>
      </button>
      Newer
    </a>
  <div class="eevee-spacer"></div>
    <a href="../../../../2015/12/30/farewell-ian/"
       class="eevee-nav__button" itemprop="url" rel="bookmark"
       title="Older">
      Older
      <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900"
              role="presentation">
        <i class="material-icons">&#xE5C8;</i>
      </button>
    </a>
</nav>        </div>
      </div>
    <footer class="mdl-mega-footer" itemscope
            itemtype="http://schema.org/SiteNavigationElement">
      <div class="mdl-mega-footer--top-section">
        <div class="mdl-mega-footer--drop-down-section">
          <ul class="mdl-mega-footer--link-list">
            <li>
              <a href="#top" itemprop="url"
                 title="Back to the top of the page">
                Back to the top of the page
              </a>
            </li>
          </ul>
        </div>
      </div>
<div class="mdl-mega-footer--middle-section" itemscope
     itemtype="http://schema.org/SiteNavigationElement"
     aria-label="Footer navigation">
  <div class="mdl-mega-footer--drop-down-section">
    <h1 class="mdl-mega-footer--heading">Menu</h1>
    <ul class="mdl-mega-footer--link-list">
        <li>
          <a href="/contact/" itemprop="url" rel="bookmark"
             title="Contact">
            <i class="material-icons" aria-hidden="true">&#xE0B7;</i> Contact
          </a>
        </li>
        <li>
          <a href="../../../../archives/"
             itemprop="url" rel="bookmark" title="Archives">
            <i class="material-icons">&#xE02F;</i>
            Archives
          </a>
        </li>
        <li>
          <a href="../../../../feeds/rss.xml"
             title="RSS"
             itemprop="url">
            <i class="material-icons">&#xE0E5;</i>
              RSS
          </a>
        </li>
    </ul>
  </div>
  <div class="mdl-mega-footer--drop-down-section">
    <h1 class="mdl-mega-footer--heading">Social</h1>
    <ul class="mdl-mega-footer--link-list">
        <li>
          <a href="https://github.com/kura" itemprop="url" rel="bookmark"
             title="GitHub">
            <i class="fa" aria-hidden="true">&#xF09B;</i> Github
          </a>
        </li>
    </ul>
  </div>
  <div class="mdl-mega-footer--drop-down-section">
    <h1 class="mdl-mega-footer--heading">Links</h1>
    <ul class="mdl-mega-footer--link-list">
        <li>
          <a href="/blackhole" itemprop="url" rel="bookmark"
             title="Blackhole">
            <i class="material-icons" aria-hidden="true">&#xE86F;</i> Blackhole
          </a>
        </li>
        <li>
          <a href="/eevee" itemprop="url" rel="bookmark"
             title="Eevee">
            <i class="material-icons" aria-hidden="true">&#xE871;</i> Eevee
          </a>
        </li>
        <li>
          <a href="/hauntr" itemprop="url" rel="bookmark"
             title="Hauntr">
            <i class="material-icons" aria-hidden="true">&#xE871;</i> Hauntr
          </a>
        </li>
        <li>
          <a href="/ghastly" itemprop="url" rel="bookmark"
             title="Ghastly">
            <i class="material-icons" aria-hidden="true">&#xE871;</i> Ghastly
          </a>
        </li>
        <li>
          <a href="/pelican-plugins" itemprop="url" rel="bookmark"
             title="Pelican Plugins">
            <i class="material-icons" aria-hidden="true">&#xE86F;</i> Pelican Plugins
          </a>
        </li>
      </ul>
  </div>
</div>      <div class="mdl-mega-footer--bottom-section">
        <div class="mdl-logo">
          <a href="../../../.." rel="bookmark" itemprop="url"
             title="kura.gg">
            kura.gg
          </a>
        </div>
          <ul class="eevee-footer mdl-mega-footer--link-list">
              <li>Powered by love &amp; rainbow sparkles.</li>
              <li>Source code and content released under the <a href="/license/" title="MIT license">MIT license</a>.</li>
          </ul>
      </div>
    </footer>
  </div>
</body>
</html>