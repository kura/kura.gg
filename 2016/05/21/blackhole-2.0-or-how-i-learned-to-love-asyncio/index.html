<!doctype html><html lang=en><meta charset=utf-8><meta content=width=device-width,initial-scale=1.0,minimum-scale=1.0 name=viewport><link href=https://kura.gg hreflang=en rel=alternate><link href=https://kura.gg rel=dns-prefetch><link href=https://kura.gg/theme/css/eevee.min.css?1c9d8344 rel=stylesheet><script async src=https://kura.gg/theme/js/eevee.min.js?1841d254></script><link href=https://kura.gg/feeds/rss.xml rel=alternate title=kura.gg type=application/rss+xml><link href=https://kura.gg/feeds/atom.xml rel=alternate title=kura.gg type=application/atom+xml><meta content=kura.gg property=og:site_name><meta content=article property=og:type><meta content="Blackhole 2.0: or, How I Learned to LoveÂ Asyncio" property=og:title><meta content=https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/ property=og:url><meta content="A brief history of a tiny part of the Internet. Blackhole 1 â€” Blackhole as it was originally known â€” was written on Python 2.7, briefly supporting Python 2.6 for a time and also supporting early version of Python 3, PyPy 2 and PyPy 3. Built on top of Tornado, it was asynchronous in a fashion and â€” quite simply â€” worked. The original prototype that became Blackhole was SimpleMTA â€” a prototype that was created quickly, to serve a very simple testing purpose that I had for it. As I needed SimpleMTA to do more, I wrote Blackhole to accomplish that task. Iâ€™d been using Tornado a bit and wanted to experiment with it more. Building on top of Tornado created some oddities in how the program was designed and that always irked me. Between the time of the last 1.8.X and the 2.0 release, I experimented with â€¦" property=og:description><meta content=https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/index.png property=og:image><meta content=1920 property=og:image:width><meta content=1080 property=og:image:height><meta content="Blackhole 2.0: or, How I Learned to LoveÂ Asyncio" property=twitter:title><meta content=https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/ property=twitter:url><meta content="A brief history of a tiny part of the Internet. Blackhole 1 â€” Blackhole as it was originally known â€” was written on Python 2.7, briefly supporting Python 2.6 for a time and also supporting early version of Python 3, PyPy 2 and PyPy 3. Built on top of Tornado, it was asynchronous in a fashion and â€” quite simply â€” worked. The original prototype that became Blackhole was SimpleMTA â€” a prototype that was created quickly, to serve a very simple testing purpose that I had for it. As I needed SimpleMTA to do more, I wrote Blackhole to accomplish that task. Iâ€™d been using Tornado a bit and wanted to experiment with it more. Building on top of Tornado created some oddities in how the program was designed and that always irked me. Between the time of the last 1.8.X and the 2.0 release, I experimented with â€¦" property=twitter:description><meta content=https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/index.png property=twitter:image><meta content=summary_large_image property=twitter:card><meta content="Written by" property=twitter:label1><meta content=Kura property=twitter:data1><meta content="Estimated reading time" property=twitter:label2><meta content="7 min read" property=twitter:data2><meta content=1920 property=twitter:image:width><meta content=1080 property=twitter:image:height><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.png rel=icon type=image/png><link sizes="16x16 32x32 48x48 64x64 128x128 256x256" href=/favicon.ico rel=icon type=image/vnd.microsoft.icon><title>Blackhole 2.0: or, How I Learned to LoveÂ Asyncio</title><body><div class="eevee-layout mdl-layout mdl-js-layout mdl-color--grey-50"><header class="eevee-header mdl-color--grey-50 mdl-color-text--grey-800" itemscope itemtype=http://schema.org/WPHeader><div class=mdl-layout__header-row><div class="mdl-layout__drawer-button mdl-color-text--accent eevee-mobile-button mdl-layout--small-screen-only" aria-expanded=false role=button tabindex=0><i class=material-icons>î—’</i></div><span class="eevee-logo mdl-color-text--accent mdl-layout-title"> <h2 id=top><a href=https://kura.gg rel=bookmark title=kura.gg> kura.gg </a></h2> </span><div class=mdl-layout-spacer role=presentation></div><nav aria-label="Header navigation" class="eevee-nav mdl-navigation mdl-layout--large-screen-only" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>î¡¯</i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>î¡±</i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>î¡±</i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>î¡±</i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>î¡¯</i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>î‚·</i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>î€¯</i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>îƒ¥</i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>îƒ¥</i> Atom </a></nav></div></header><div class="eevee-mobile-header mdl-layout__drawer mdl-color--white" aria-hidden=true><span class=mdl-layout-title> <h2 class="eevee-mobile-logo mdl-color-text--accent">kura.gg</h2> </span><div class="mdl-navigation mdl-color--white"><nav aria-label="Header navigation" class="eevee-nav mdl-navigation" itemscope itemtype=http://schema.org/SiteNavigationElement><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons> î¢Š </i> Home </a><a class="mdl-color-text--accent mdl-navigation__link" href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>î¡¯</i> Blackhole </a><a class="mdl-color-text--accent mdl-navigation__link" href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>î¡±</i> Eevee </a><a class="mdl-color-text--accent mdl-navigation__link" href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>î¡±</i> Hauntr </a><a class="mdl-color-text--accent mdl-navigation__link" href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>î¡±</i> Ghastly </a><a class="mdl-color-text--accent mdl-navigation__link" title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>î¡¯</i> Pelican Plugins </a><a class="mdl-color-text--accent mdl-navigation__link" href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>î‚·</i> Contact </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>î€¯</i> Archives </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>îƒ¥</i> RSS </a><a class="mdl-color-text--accent mdl-navigation__link" href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>îƒ¥</i> Atom </a></nav></div></div><div class="eevee-ribbon mdl-color--primary-dark" role=presentation></div><main class="eevee-main mdl-layout__content"><div class="eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div aria-label="Main content" class="eevee-content mdl-color--white mdl-shadow--2dp mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><article itemscope itemtype=http://schema.org/BlogPosting><meta content=fullKeyboardControl itemprop=accessibilityControl><meta content=fullMouseControl itemprop=accessibilityControl><meta content=bookmarks itemprop=accessibilityControl><meta content=captions itemprop=accessibilityControl><meta content=alternativeText itemprop=accessibilityControl><meta content=index itemprop=accessibilityControl><meta content=readingOrder itemprop=accessibilityControl><meta content=structuralNavigation itemprop=accessibilityControl><meta content=tableOfContents itemprop=accessibilityControl><meta content=noFlashingHazard itemprop=accessibilityHazard><meta content=noMotionSimulationHazard itemprop=accessibilityHazard><meta content=noSoundHazard itemprop=accessibilityHazard><meta content=ARIA itemprop=accessibilityAPI><div itemprop=author itemscope itemtype=https://schema.org/Person role=presentation><a class=hidden href=https://kura.gg/authors/kura/ itemprop=url role=presentation> <span class=hidden itemprop=name role=presentation> kura </span> </a></div><meta content=python,python3.5,3.5,asyncio,email,smtp,mta itemprop=keywords><meta content=coding itemprop=keywords><div class=eevee-share><ul class="social-share mdl-navigation"><li class="social-share__link social-share__link--twitter"><a onclick="window.open(this.href, 'twitter-share', 'width=550,height=235'); return false;" title="Share 'Blackhole 2.0: or, How I Learned to Love Asyncio' on Twitter" href=https://twitter.com/intent/tweet?text=Blackhole%202.0%3A%20or%2C%20How%20I%20Learned%20to%20Love%20Asyncio&url=https%3A//kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/> <i aria-hidden=true class=fa>ï‚™</i> </a><li class="social-share__link social-share__link--facebook"><a onclick="window.open(this.href, 'facebook-share', 'width=580,height=296'); return false;" title="Share 'Blackhole 2.0: or, How I Learned to Love Asyncio' on Facebook" href=https://www.facebook.com/sharer/sharer.php?u=https%3A//kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/> <i aria-hidden=true class=fa>ï‚š</i> </a><li class="social-share__link social-share__link--email"><a title="Share 'Blackhole 2.0: or, How I Learned to Love Asyncio' via email" href=mailto:?subject=Blackhole%202.0%3A%20or%2C%20How%20I%20Learned%20to%20Love%20Asyncio&body=I%20thought%20you%20might%20like%20'Blackhole%202.0%3A%20or%2C%20How%20I%20Learned%20to%20Love%20Asyncio'%20--%20https%3A//kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/> <i aria-hidden=true class=material-icons> îƒ¡ </i> </a></ul></div><div class=eevee-article><div class="eevee-meta mdl-color-text--grey-500"><time datetime=2016-05-21T00:20:00+01:00 itemprop=datePublished> 21 May 2016 </time>Â â€” 7 min read</div><h1 itemprop=name><a title="Permalink to 'Blackhole 2.0: or, How I Learned to LoveÂ Asyncio'" href=https://kura.gg/2016/05/21/blackhole-2.0-or-how-i-learned-to-love-asyncio/ itemprop=url rel=bookmark> Blackhole 2.0: or, How I Learned to LoveÂ Asyncio </a></h1><section class=eevee-toc><h2 id=toc>Contents</h2><nav class=eevee-toc-ribbon><div class=toc><p class=topic-title>Contents<ul class=simple><li><a class="reference internal" href=#enter-asyncio id=toc-entry-1>EnterÂ asyncio</a><li><a class="reference internal" href=#all-i-see-are-bytes id=toc-entry-2>All I see areÂ bytes</a><li><a class="reference internal" href=#getting-to-grips-with-asyncio id=toc-entry-3>Getting to grips withÂ asyncio</a><li><a class="reference internal" href=#show-me-the-code id=toc-entry-4>Show me theÂ code</a><li><a class="reference internal" href=#lambda-woes-aka-use-functools-partial id=toc-entry-5>lambda woes aka. useÂ functools.partial</a><li><a class="reference internal" href=#so-is-asyncio-any-good id=toc-entry-6>So is asyncio anyÂ good?</a></ul></div></nav></section><section class=article-content itemprop=articleBody><p>A brief history of a tiny part of theÂ Internet.<p><a class="reference external" href=https://blackhole.io/1>Blackhole 1 â€” Blackhole as it was originally known</a> â€” was written on <a class="reference external" href=https://docs.python.org/2/whatsnew/2.7.html>Python 2.7</a>, briefly supporting <a class="reference external" href=https://docs.python.org/2.6/whatsnew/2.6.html>Python 2.6</a> for a time and also supporting early version of <a class="reference external" href=https://docs.python.org/3.2/whatsnew/3.2.html>Python 3</a>, <a class="reference external" href=https://www.pypy.org/features.html>PyPy 2</a> and <a class="reference external" href=https://www.pypy.org/features.html>PyPy 3</a>. Built on top of <a class="reference external" href=https://www.tornadoweb.org/en/stable/>Tornado</a>, it was asynchronous in a fashion and â€” quite simply â€”Â worked.<p>The original prototype that became Blackhole was <a class="reference external" href=/simplemta>SimpleMTA</a> â€” a prototype that was created quickly, to serve a very simple testing purpose that I had forÂ it.<p>As I needed SimpleMTA to do more, I wrote Blackhole to accomplish that task. Iâ€™d been using Tornado a bit and wanted to experiment with it more. Building on top of Tornado created some oddities in how the program was designed and that always irkedÂ me.<p>Between the time of the last 1.8.X and the 2.0 release, I experimented with rewriting the program on top of various libraries. The most obvious of these was <a class="reference external" href=https://twistedmatrix.com/trac/>Twisted</a>. Iâ€™ve always been a fan of Twisted but I donâ€™t like <tt class="docutils literal">theFormattingOfItsFunctionNames</tt> and â€” like too much of a good thing â€” callbacks can be bad forÂ you.<p>Another experiment was built on top of the old <a class="reference external" href=https://docs.python.org/2/library/asyncore.html>asyncore</a> and <a class="reference external" href=https://docs.python.org/2/library/asynchat.html>asynchat</a> standard library modules. A branch of Blackhole 1.8 is indeed built and in working order built on top of these very modules. Although never merged and released in theÂ wild.<div class=section id=enter-asyncio><h2>EnterÂ asyncio</h2><p>Originating as <a class="reference external" href=https://github.com/python/asyncio>Tulip</a> and merged in to the Python standard library in <a class="reference external" href=https://docs.python.org/3.4/whatsnew/3.4.html>Python 3.4</a>, asyncio looked like a great module to achieve what I wanted to achieve and to force me to actually use PythonÂ 3.<p>With <a class="reference external" href=https://docs.python.org/3.5/whatsnew/3.5.html>Python 3.5</a> came the <a class="reference external" href=https://docs.python.org/3.5/reference/compound_stmts.html#async-def>async def</a> declaration, the <a class="reference external" href=https://docs.python.org/3.5/reference/expressions.html#await>await</a> expression and the <a class="reference external" href=https://docs.python.org/3.5/reference/compound_stmts.html#async-for>async for</a>Â statement.<p>Since Blackhole is a tool written by me, for me and exposed as a service, it made complete sense for me to jump-in-at-the-deep-end as it were and rewrite the entirety of the software specifically for PythonÂ 3.5.<p>Doing so meant I bypassed the need to use the <tt class="docutils literal">@coroutine</tt> decorator and the <tt class="docutils literal">yield from</tt> expression, instead using their 3.5 equivalents in <tt class="docutils literal">async def</tt> and <tt class="docutils literal">await</tt> respectively.</div><div class=section id=all-i-see-are-bytes><h2>All I see areÂ bytes</h2><p>The trickest part for me was forcing myself to remember that the data passed to and from the socket in Python 3 areÂ bytes.<p>That took a little while of constantly smashing my head in to my desk to realise and remember. If something didnâ€™t work during development, it was always because I forgot to use <tt class="docutils literal">.encode()</tt> or <tt class="docutils literal">.decode()</tt>.</div><div class=section id=getting-to-grips-with-asyncio><h2>Getting to grips withÂ asyncio</h2><p>I can honestly say that, with a little reading and checking out how some libraries like <a class="reference external" href=https://github.com/KeepSafe/aiohttp>aiohttp</a> work, I got to grips with the actual <tt class="docutils literal">asyncio</tt> module prettyÂ quickly.<p>I found using the <tt class="docutils literal">async def</tt> and <tt class="docutils literal">await</tt> syntax made it even easier for me to read and write the code, because I instantly knew how a function Iâ€™d written previously should work, simply by looking at itâ€™s declaration. Something I have sometimes forgotten when passing callbacks all over theÂ place.</div><div class=section id=show-me-the-code><h2>Show me theÂ code</h2><p>So, letâ€™s take a specific task and look at the code that handles it, written on top of asyncio in PythonÂ 3.5.<p>First up Iâ€™ll show the method that waits for data to be received on theÂ socket.<div class=highlight><pre><span></span><span class=k>async</span> <span class=k>def</span> <span class=nf>wait</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Wait for data from the client.</span>
<span class=sd>    :returns: A line of received data.</span>
<span class=sd>    :rtype: :any:`str`</span>
<span class=sd>    .. note::</span>
<span class=sd>       Also handles client timeouts if they wait too long before sending</span>
<span class=sd>       data. -- https://blackhole.io/configuration-options.html#timeout</span>
<span class=sd>    """</span>
    <span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_closed</span><span class=p>:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=n>line</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_reader</span><span class=o>.</span><span class=n>readline</span><span class=p>(),</span>
                                          <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>timeout</span><span class=p>,</span>
                                          <span class=n>loop</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>loop</span><span class=p>)</span>
        <span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>
            <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>()</span>
            <span class=k>return</span> <span class=kc>None</span>
        <span class=k>return</span> <span class=n>line</span>
</pre></div><p>This function waits for data to be received from a client and returns it once itâ€™s beenÂ received.<div class=highlight><pre><span></span><span class=k>async</span> <span class=k>def</span> <span class=nf>wait</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</pre></div><p>The declaration of this function is different to how youâ€™d write it for Python 3.4 orÂ lower.<p>The equivalent of this declaration for Python 3.4 is asÂ follows:<div class=highlight><pre><span></span><span class=nd>@coroutine</span>
<span class=k>def</span> <span class=nf>wait</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</pre></div><p>Both ways declare that the function is an asynchronousÂ coroutine.<div class=highlight><pre><span></span><span class=k>while</span> <span class=ow>not</span> <span class=bp>self</span><span class=o>.</span><span class=n>connection_close</span><span class=p>:</span>
</pre></div><p>This line does exactly what youâ€™d expect, it runs the while loop until <tt class="docutils literal">self.connection_closed</tt> does not equal <tt class="docutils literal">False</tt> or until the loop is exited for anotherÂ reason.<p>This simply allows the connection handler to have connection state and stop waiting for data if the connection is terminated elsewhere. Because the entire program is asynchronous, the connection state may get modified elsewhere while this method is still waiting for newÂ data.<p>The <tt class="docutils literal">try except</tt> block actually works with the whileÂ statement.<div class=highlight><pre><span></span><span class=k>try</span><span class=p>:</span>
    <span class=n>line</span> <span class=o>=</span> <span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_reader</span><span class=o>.</span><span class=n>readline</span><span class=p>(),</span>
                                  <span class=bp>self</span><span class=o>.</span><span class=n>config</span><span class=o>.</span><span class=n>timeout</span><span class=p>,</span>
                                  <span class=n>loop</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>loop</span><span class=p>)</span>
</pre></div><p>Itâ€™s easier to explain the arguments of the <tt class="docutils literal">wait_for</tt> method before anythingÂ else.<p><tt class="docutils literal">self._reader.readline()</tt> reads a line of data from a socket stream, <tt class="docutils literal">self.config.timeout</tt> is the maximum time in seconds to wait for data, for the sake of this example, letâ€™s call it <tt class="docutils literal">10</tt> and finally <tt class="docutils literal">loop=self.loop</tt> sets the event loop that the code executesÂ on.<p><tt class="docutils literal">asyncio.wait_for</tt> creates an asynchronous task that waits for the <tt class="docutils literal">self._reader.readline()</tt> future to complete or raises an <tt class="docutils literal">asyncio.TimeoutError</tt> if the future does not complete within the timeÂ limit.<p>As aÂ example.<div class=highlight><pre><span></span><span class=k>await</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>wait_for</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_reader</span><span class=o>.</span><span class=n>readline</span><span class=p>(),</span> <span class=mi>10</span><span class=p>)</span>
</pre></div><p>Would wait for data for 10 seconds before raising a timeoutÂ error.<div class=highlight><pre><span></span><span class=k>except</span> <span class=n>asyncio</span><span class=o>.</span><span class=n>TimeoutError</span><span class=p>:</span>
    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>timeout</span><span class=p>()</span>
    <span class=k>return</span> <span class=kc>None</span>
</pre></div><p>How the exception is handled shows how the <tt class="docutils literal">while</tt> statement is used. When a timeout exception is raised, part of the code that handles that in the <tt class="docutils literal">self.timeout()</tt> method changes the <tt class="docutils literal">connection_closed</tt> value.<p>And finally the data received isÂ returned.<div class=highlight><pre><span></span><span class=k>return</span> <span class=n>line</span>
</pre></div><p>Without going in to too much detail, below is the piece of code for handling a timeout and terminating a connection, setting <tt class="docutils literal">connection_closed</tt> to exit all possibly running <tt class="docutils literal">while</tt> loops.<div class=highlight><pre><span></span><span class=k>async</span> <span class=k>def</span> <span class=nf>timeout</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""</span>
<span class=sd>    Timeout a client connection.</span>
<span class=sd>    Sends the 421 timeout message to the client and closes the connection.</span>
<span class=sd>    https://blackhole.io/configuration-options.html#timeout</span>
<span class=sd>    """</span>
    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>push</span><span class=p>(</span><span class=mi>421</span><span class=p>,</span> <span class=s1>'Timeout'</span><span class=p>)</span>
    <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>

<span class=k>async</span> <span class=k>def</span> <span class=nf>close</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""Close the connection from the client."""</span>
    <span class=k>if</span> <span class=bp>self</span><span class=o>.</span><span class=n>_writer</span><span class=p>:</span>
        <span class=k>try</span><span class=p>:</span>
            <span class=bp>self</span><span class=o>.</span><span class=n>clients</span><span class=o>.</span><span class=n>remove</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_writer</span><span class=p>)</span>
        <span class=k>except</span> <span class=ne>ValueError</span><span class=p>:</span>
            <span class=k>pass</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>_writer</span><span class=o>.</span><span class=n>close</span><span class=p>()</span>
        <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>_writer</span><span class=o>.</span><span class=n>drain</span><span class=p>()</span>
    <span class=bp>self</span><span class=o>.</span><span class=n>_connection_closed</span> <span class=o>=</span> <span class=kc>True</span>
</pre></div></div><div class=section id=lambda-woes-aka-use-functools-partial><h2>lambda woes aka. useÂ functools.partial</h2><p>Later in the development of the new version of blackhole I added a feature called <tt class="docutils literal">flags</tt>. These flags allow multiple listeners to be configured with different runtime parameters. i.e. bounce all emails received on port 587 while accepting all emails received on portÂ 25.<p>These flags allow flexibility to control how email is handled on any specifiedÂ port.<p>It was during development of this feature that I discovered using a lambda rather than a partial object from functools didnâ€™t work quite how I was expecting itÂ to.<p>The original piece of code iterated over each socket object and created an asyncio server object for that socket asÂ below.<div class=highlight><pre><span></span><span class=k>async</span> <span class=k>def</span> <span class=nf>_start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""Create an asyncio 'server' for each socket."""</span>
    <span class=k>for</span> <span class=n>sock</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>socks</span><span class=p>:</span>
        <span class=n>server</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>loop</span><span class=o>.</span><span class=n>create_server</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>Smtp</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>clients</span><span class=p>),</span>
                                               <span class=o>**</span><span class=n>sock</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>servers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>server</span><span class=p>)</span>
</pre></div><p>I wanted to change this code to pass in a set of flags that also belonged to that specific socket, asÂ below.<div class=highlight><pre><span></span><span class=k>async</span> <span class=k>def</span> <span class=nf>_start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""Create an asyncio 'server' for each socket."""</span>
    <span class=k>for</span> <span class=n>sock</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>socks</span><span class=p>:</span>
        <span class=n>flags</span> <span class=o>=</span> <span class=n>sock</span><span class=p>[</span><span class=s1>'flags'</span><span class=p>]</span>
        <span class=n>server</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>loop</span><span class=o>.</span><span class=n>create_server</span><span class=p>(</span><span class=k>lambda</span><span class=p>:</span> <span class=n>Smtp</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>clients</span><span class=p>,</span>
                                                            <span class=n>flags</span><span class=o>=</span><span class=n>flags</span><span class=p>),</span>
                                               <span class=o>**</span><span class=n>sock</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>servers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>server</span><span class=p>)</span>
</pre></div><p>Can you spot theÂ problem?<p>When using a lambda in that context, creating an anonymous function to pass to the <tt class="docutils literal">create_server</tt> method, I discovered the flag arguments were incorrect. In fact, none of the sockets had their correct flags set, they were being jumbled up instead of being used asÂ expected.<p>Iâ€™m not sure why thatâ€™s the case and I never actually looked it up to find out why either. I knew the way to fix it was to use <tt class="docutils literal">functools.partial</tt> and itâ€™s also a nice, cleaner way to do it so IÂ did.<div class=highlight><pre><span></span><span class=k>async</span> <span class=k>def</span> <span class=nf>_start</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
<span class=w>    </span><span class=sd>"""Create an asyncio 'server' for each socket."""</span>
    <span class=k>for</span> <span class=n>sock</span> <span class=ow>in</span> <span class=bp>self</span><span class=o>.</span><span class=n>socks</span><span class=p>:</span>
        <span class=n>flags</span> <span class=o>=</span> <span class=n>sock</span><span class=p>[</span><span class=s1>'flags'</span><span class=p>]</span>
        <span class=n>factory</span> <span class=o>=</span> <span class=n>functools</span><span class=o>.</span><span class=n>partial</span><span class=p>(</span><span class=n>Smtp</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>clients</span><span class=p>,</span> <span class=n>flags</span><span class=o>=</span><span class=n>flags</span><span class=p>)</span>
        <span class=n>server</span> <span class=o>=</span> <span class=k>await</span> <span class=bp>self</span><span class=o>.</span><span class=n>loop</span><span class=o>.</span><span class=n>create_server</span><span class=p>(</span><span class=n>factory</span><span class=p>,</span> <span class=o>**</span><span class=n>sock</span><span class=p>)</span>
        <span class=bp>self</span><span class=o>.</span><span class=n>servers</span><span class=o>.</span><span class=n>append</span><span class=p>(</span><span class=n>server</span><span class=p>)</span>
</pre></div></div><div class=section id=so-is-asyncio-any-good><h2>So is asyncio anyÂ good?</h2><p>Iâ€™m going to roundup this article with this possibly loaded and difficultÂ question.<p>Well, isÂ it?<p>In my eyes, yes. I have to admit that this is the first time in a very long time â€” possibly ever â€” that I have fallen so head-over-heels in-love with a library orÂ module.<p>I went from someone that didnâ€™t use Python 3 and grudgingly added Python 3 support to libraries Iâ€™ve written, to someone that only uses Python 3.5Â now.<p>I havenâ€™t use asyncio with Python 3.4 and I probably never will, I like the 3.5-only syntax changes far too much to go backwards and start using the <tt class="docutils literal">@coroutine</tt> decorator and <tt class="docutils literal">yield from</tt> statement.<p>My only gripe is that currently <span class=caps>STARTTLS</span> is not supported. Hopefully that will arrive in the not-so-distant future and I understand why itâ€™s currently notÂ supported.</div></section></div><div class=eevee-related><section><h2>Related articles</h2><ul><li><a title="Permalink to 'DJUGL June 2013 talk on blackhole andÂ blackhole.io'" href=https://kura.gg/2013/07/17/djugl-june-2013-talk-on-blackhole-and-blackhole-io/ itemprop=url rel=bookmark> <span class=caps>DJUGL</span> June 2013 talk on blackhole andÂ blackhole.io </a><li><a title="Permalink to 'Google Workspace Gmail MX records signed with DNSSEC'" href=https://kura.gg/2021/10/14/google-workspace-gmail-mx-dnssec-signed/ itemprop=url rel=bookmark> Google Workspace Gmail <span class=caps>MX</span> records signed with <span class=caps>DNSSEC</span> </a><li><a title="Permalink to 'batfish(1) - writing a Digital Ocean V2 APIÂ wrapper'" href=https://kura.gg/2014/09/15/batfish-writing-a-digital-ocean-v2-api-wrapper/ itemprop=url rel=bookmark> batfish(1) - writing a Digital Ocean V2 <span class=caps>API</span>Â wrapper </a><li><a title="Permalink to 'yarg(1) â€” A semi hard Cornish cheese, also queriesÂ PyPI'" href=https://kura.gg/2014/08/09/yarg/ itemprop=url rel=bookmark> yarg(1) â€” A semi hard Cornish cheese, also queriesÂ PyPI </a><li><a title="Permalink to 'Speeding up pypip.in and reducing load onÂ PyPI'" href=https://kura.gg/2014/08/07/speeding-up-pypip.in-and-reducing-load-on-pypi/ itemprop=url rel=bookmark> Speeding up pypip.in and reducing load onÂ PyPI </a></ul></section></div><div class=eevee-ac><header class=eevee-ac__header><div class=eevee-ac-author__text><h2>Kura</h2><p>Anarchist. Pessimist. Bipolar. Hacker. Hyperpolyglot. Musician. Ex-(semi-)pro gamer. They/Them.<p><a title="Read more articles by Kura" href=https://kura.gg/authors/kura/ itemprop=url> Read more articles by Kura </a><nav><ul class=eevee-ac-author__social><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on GitHub" href=https://github.com/kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>ï‚›</i> </a><li class=eevee-ac-author-social__link><a class="mdl-color-text--accent mdl-navigation__link" title="kura on @kura@noc.social" href=https://noc.social/@kura itemprop=url rel=bookmark> <i aria-hidden=true class=fa>ðŸ¦£</i> </a></ul></nav></div><img alt=Kura class=eevee-ac-author__avatar src=/images/avatar.png></header></div></article><a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--raised mdl-color--accent mdl-color-text--white" title="View 'Blackhole 2.0: or, How I Learned to LoveÂ Asyncio' on GitHub" href=https://github.com/kura/kura.gg/blob/main/content/blackhole-2.0-or-how-i-learned-to-love-asyncio.rst id=view-source> <i class=material-icons>î¡¯</i> View Source </a></div></div></main><div class="eevee-pagination__container eevee-container mdl-grid"><div class="mdl-cell mdl-cell--2-col mdl-cell--hide-tablet mdl-cell--hide-phone" role=presentation></div><div class="mdl-color-text--grey-800 mdl-cell mdl-cell--8-col"><nav class="eevee-pagination mdl-cell mdl-cell--12-col" aria-label=Pagination itemscope itemtype=http://schema.org/SiteNavigationElement><a class=eevee-nav__button href=https://kura.gg/2016/06/12/eevee-a-material-design-theme-for-pelican/ itemprop=url rel=bookmark title=Newer> <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons>î—„</i></button> Newer </a><div class=eevee-spacer></div><a class=eevee-nav__button href=https://kura.gg/2015/12/30/farewell-ian/ itemprop=url rel=bookmark title=Older> Older <button class="mdl-button mdl-button--icon mdl-color--white mdl-color-text--grey-900" role=presentation><i class=material-icons>î—ˆ</i></button> </a></nav></div></div><footer class=mdl-mega-footer itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--top-section><div class=mdl-mega-footer--drop-down-section><ul class=mdl-mega-footer--link-list><li><a title="Back to the top of the page" href=#top itemprop=url> Back to the top of the page </a></ul></div></div><div aria-label="Footer navigation" class=mdl-mega-footer--middle-section itemscope itemtype=http://schema.org/SiteNavigationElement><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Menu</h1><ul class=mdl-mega-footer--link-list><li><a href=/contact/ itemprop=url rel=bookmark title=Contact> <i aria-hidden=true class=material-icons>î‚·</i> Contact </a><li><a href=https://kura.gg/archives/ itemprop=url rel=bookmark title=Archives> <i class=material-icons>î€¯</i> Archives </a><li><a href=https://kura.gg/feeds/rss.xml itemprop=url title=RSS> <i class=material-icons>îƒ¥</i> RSS </a><li><a href=https://kura.gg/feeds/atom.xml itemprop=url title=Atom> <i class=material-icons>îƒ¥</i> Atom </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Social</h1><ul class=mdl-mega-footer--link-list><li><a href=https://github.com/kura itemprop=url rel=bookmark title=GitHub> <i aria-hidden=true class=fa>ï‚›</i> Github </a><li><a href=https://noc.social/@kura itemprop=url rel=me title=@kura@noc.social> <i aria-hidden=true class=fa>ðŸ¦£</i> @kura@noc.social </a></ul></div><div class=mdl-mega-footer--drop-down-section><h1 class=mdl-mega-footer--heading>Links</h1><ul class=mdl-mega-footer--link-list><li><a href=/blackhole itemprop=url rel=bookmark title=Blackhole> <i aria-hidden=true class=material-icons>î¡¯</i> Blackhole </a><li><a href=/eevee itemprop=url rel=bookmark title=Eevee> <i aria-hidden=true class=material-icons>î¡±</i> Eevee </a><li><a href=/hauntr itemprop=url rel=bookmark title=Hauntr> <i aria-hidden=true class=material-icons>î¡±</i> Hauntr </a><li><a href=/ghastly itemprop=url rel=bookmark title=Ghastly> <i aria-hidden=true class=material-icons>î¡±</i> Ghastly </a><li><a title="Pelican Plugins" href=/pelican-plugins itemprop=url rel=bookmark> <i aria-hidden=true class=material-icons>î¡¯</i> Pelican Plugins </a></ul></div></div><div class=mdl-mega-footer--bottom-section><div class=mdl-logo><a href=https://kura.gg itemprop=url rel=bookmark title=kura.gg> kura.gg </a></div><ul class="eevee-footer mdl-mega-footer--link-list"><li>Powered by love & rainbow sparkles.<li>Source code and content released under the <a title="MIT license" href=/license/>MIT license</a>.</ul></div></footer></div>